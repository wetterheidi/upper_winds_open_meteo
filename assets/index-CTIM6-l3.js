var li=Object.defineProperty;var ci=(t,e,n)=>e in t?li(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var Cn=(t,e,n)=>ci(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const i={isInitialized:!1,ismapInitialized:!1,isCachingCancelled:!1,hasTileErrorSwitched:!1,map:null,baseMaps:{},coordsControl:null,lastMouseLatLng:null,isManualPanning:!1,isInteractionLocked:!1,labelZoomListener:null,currentMarker:null,lastLat:null,lastLng:null,lastAltitude:null,weatherData:null,cloudThresholds:[],lastModelRun:null,landingWindDir:null,autoupdateInterval:null,jumpVisualizationLayerGroup:null,landingPatternLayerGroup:null,jumpRunTrackLayerGroup:null,lastTrackData:null,isPlacingHarp:!1,harpMarker:null,cutAwayMarker:null,cutAwayLat:null,cutAwayLng:null,cutAwayCircle:null,isJumperSeparationManual:!1,watchId:null,liveMarker:null,livePositionControl:null,accuracyCircle:null,jumpMasterLine:null,aircraftMarker:null,aircraftTrackLayer:null,adsbTrackPoints:[],isArmed:!1,isAutoRecording:!1,isManualRecording:!1,recordedTrackPoints:[],recordedTrackLayer:null,autoRecordingStartTime:null,altitudeCorrectionOffset:0,prevTime:null,prevLat:null,prevLng:null,lastLatitude:null,lastLongitude:null,lastDeviceAltitude:null,lastAltitudeAccuracy:null,lastAccuracy:null,lastSpeed:"N/A",lastSmoothedSpeedMs:0,lastDirection:"N/A",lastTerrainAltitude:"N/A",lastEffectiveWindUnit:"kt",gpxLayer:null,gpxPoints:[],isLoadingGpx:!1,isTrackLoaded:!1,favoritesLayerGroup:null,poiLayerGroup:null,ensembleModelsData:null,selectedEnsembleModels:[],currentEnsembleScenario:"all_models",ensembleLayerGroup:null,ensembleScenarioCircles:{},heatmapLayer:null};class st extends Error{}class ui extends st{constructor(e){super(`Invalid DateTime: ${e.toMessage()}`)}}class di extends st{constructor(e){super(`Invalid Interval: ${e.toMessage()}`)}}class mi extends st{constructor(e){super(`Invalid Duration: ${e.toMessage()}`)}}class ht extends st{}class kr extends st{constructor(e){super(`Invalid unit ${e}`)}}class le extends st{}class Ue extends st{constructor(){super("Zone is an abstract class")}}const P="numeric",Ce="short",pe="long",cn={year:P,month:P,day:P},Tr={year:P,month:Ce,day:P},hi={year:P,month:Ce,day:P,weekday:Ce},Ar={year:P,month:pe,day:P},Cr={year:P,month:pe,day:P,weekday:pe},Ir={hour:P,minute:P},Nr={hour:P,minute:P,second:P},Dr={hour:P,minute:P,second:P,timeZoneName:Ce},Pr={hour:P,minute:P,second:P,timeZoneName:pe},Fr={hour:P,minute:P,hourCycle:"h23"},xr={hour:P,minute:P,second:P,hourCycle:"h23"},$r={hour:P,minute:P,second:P,hourCycle:"h23",timeZoneName:Ce},Or={hour:P,minute:P,second:P,hourCycle:"h23",timeZoneName:pe},Rr={year:P,month:P,day:P,hour:P,minute:P},Ur={year:P,month:P,day:P,hour:P,minute:P,second:P},Wr={year:P,month:Ce,day:P,hour:P,minute:P},Hr={year:P,month:Ce,day:P,hour:P,minute:P,second:P},fi={year:P,month:Ce,day:P,weekday:Ce,hour:P,minute:P},Br={year:P,month:pe,day:P,hour:P,minute:P,timeZoneName:Ce},zr={year:P,month:pe,day:P,hour:P,minute:P,second:P,timeZoneName:Ce},Gr={year:P,month:pe,day:P,weekday:pe,hour:P,minute:P,timeZoneName:pe},Zr={year:P,month:pe,day:P,weekday:pe,hour:P,minute:P,second:P,timeZoneName:pe};class Wt{get type(){throw new Ue}get name(){throw new Ue}get ianaName(){return this.name}get isUniversal(){throw new Ue}offsetName(e,n){throw new Ue}formatOffset(e,n){throw new Ue}offset(e){throw new Ue}equals(e){throw new Ue}get isValid(){throw new Ue}}let In=null;class yn extends Wt{static get instance(){return In===null&&(In=new yn),In}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(e,{format:n,locale:a}){return no(e,n,a)}formatOffset(e,n){return Pt(this.offset(e),n)}offset(e){return-new Date(e).getTimezoneOffset()}equals(e){return e.type==="system"}get isValid(){return!0}}const qn=new Map;function gi(t){let e=qn.get(t);return e===void 0&&(e=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"}),qn.set(t,e)),e}const pi={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};function yi(t,e){const n=t.format(e).replace(/\u200E/g,""),a=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(n),[,r,o,s,l,c,u,d]=a;return[s,r,o,l,c,u,d]}function wi(t,e){const n=t.formatToParts(e),a=[];for(let r=0;r<n.length;r++){const{type:o,value:s}=n[r],l=pi[o];o==="era"?a[l]=s:H(l)||(a[l]=parseInt(s,10))}return a}const Nn=new Map;class $e extends Wt{static create(e){let n=Nn.get(e);return n===void 0&&Nn.set(e,n=new $e(e)),n}static resetCache(){Nn.clear(),qn.clear()}static isValidSpecifier(e){return this.isValidZone(e)}static isValidZone(e){if(!e)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:e}).format(),!0}catch{return!1}}constructor(e){super(),this.zoneName=e,this.valid=$e.isValidZone(e)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(e,{format:n,locale:a}){return no(e,n,a,this.name)}formatOffset(e,n){return Pt(this.offset(e),n)}offset(e){if(!this.valid)return NaN;const n=new Date(e);if(isNaN(n))return NaN;const a=gi(this.name);let[r,o,s,l,c,u,d]=a.formatToParts?wi(a,n):yi(a,n);l==="BC"&&(r=-Math.abs(r)+1);const p=vn({year:r,month:o,day:s,hour:c===24?0:c,minute:u,second:d,millisecond:0});let h=+n;const v=h%1e3;return h-=v>=0?v:1e3+v,(p-h)/(60*1e3)}equals(e){return e.type==="iana"&&e.name===this.name}get isValid(){return this.valid}}let $a={};function vi(t,e={}){const n=JSON.stringify([t,e]);let a=$a[n];return a||(a=new Intl.ListFormat(t,e),$a[n]=a),a}const Kn=new Map;function Yn(t,e={}){const n=JSON.stringify([t,e]);let a=Kn.get(n);return a===void 0&&(a=new Intl.DateTimeFormat(t,e),Kn.set(n,a)),a}const Xn=new Map;function Li(t,e={}){const n=JSON.stringify([t,e]);let a=Xn.get(n);return a===void 0&&(a=new Intl.NumberFormat(t,e),Xn.set(n,a)),a}const Qn=new Map;function Mi(t,e={}){const{base:n,...a}=e,r=JSON.stringify([t,a]);let o=Qn.get(r);return o===void 0&&(o=new Intl.RelativeTimeFormat(t,e),Qn.set(r,o)),o}let Tt=null;function bi(){return Tt||(Tt=new Intl.DateTimeFormat().resolvedOptions().locale,Tt)}const ea=new Map;function Vr(t){let e=ea.get(t);return e===void 0&&(e=new Intl.DateTimeFormat(t).resolvedOptions(),ea.set(t,e)),e}const ta=new Map;function Si(t){let e=ta.get(t);if(!e){const n=new Intl.Locale(t);e="getWeekInfo"in n?n.getWeekInfo():n.weekInfo,"minimalDays"in e||(e={...jr,...e}),ta.set(t,e)}return e}function Ei(t){const e=t.indexOf("-x-");e!==-1&&(t=t.substring(0,e));const n=t.indexOf("-u-");if(n===-1)return[t];{let a,r;try{a=Yn(t).resolvedOptions(),r=t}catch{const c=t.substring(0,n);a=Yn(c).resolvedOptions(),r=c}const{numberingSystem:o,calendar:s}=a;return[r,o,s]}}function _i(t,e,n){return(n||e)&&(t.includes("-u-")||(t+="-u"),n&&(t+=`-ca-${n}`),e&&(t+=`-nu-${e}`)),t}function ki(t){const e=[];for(let n=1;n<=12;n++){const a=F.utc(2009,n,1);e.push(t(a))}return e}function Ti(t){const e=[];for(let n=1;n<=7;n++){const a=F.utc(2016,11,13+n);e.push(t(a))}return e}function Jt(t,e,n,a){const r=t.listingMode();return r==="error"?null:r==="en"?n(e):a(e)}function Ai(t){return t.numberingSystem&&t.numberingSystem!=="latn"?!1:t.numberingSystem==="latn"||!t.locale||t.locale.startsWith("en")||Vr(t.locale).numberingSystem==="latn"}class Ci{constructor(e,n,a){this.padTo=a.padTo||0,this.floor=a.floor||!1;const{padTo:r,floor:o,...s}=a;if(!n||Object.keys(s).length>0){const l={useGrouping:!1,...a};a.padTo>0&&(l.minimumIntegerDigits=a.padTo),this.inf=Li(e,l)}}format(e){if(this.inf){const n=this.floor?Math.floor(e):e;return this.inf.format(n)}else{const n=this.floor?Math.floor(e):ya(e,3);return Q(n,this.padTo)}}}class Ii{constructor(e,n,a){this.opts=a,this.originalZone=void 0;let r;if(this.opts.timeZone)this.dt=e;else if(e.zone.type==="fixed"){const s=-1*(e.offset/60),l=s>=0?`Etc/GMT+${s}`:`Etc/GMT${s}`;e.offset!==0&&$e.create(l).valid?(r=l,this.dt=e):(r="UTC",this.dt=e.offset===0?e:e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone)}else e.zone.type==="system"?this.dt=e:e.zone.type==="iana"?(this.dt=e,r=e.zone.name):(r="UTC",this.dt=e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone);const o={...this.opts};o.timeZone=o.timeZone||r,this.dtf=Yn(n,o)}format(){return this.originalZone?this.formatToParts().map(({value:e})=>e).join(""):this.dtf.format(this.dt.toJSDate())}formatToParts(){const e=this.dtf.formatToParts(this.dt.toJSDate());return this.originalZone?e.map(n=>{if(n.type==="timeZoneName"){const a=this.originalZone.offsetName(this.dt.ts,{locale:this.dt.locale,format:this.opts.timeZoneName});return{...n,value:a}}else return n}):e}resolvedOptions(){return this.dtf.resolvedOptions()}}class Ni{constructor(e,n,a){this.opts={style:"long",...a},!n&&eo()&&(this.rtf=Mi(e,a))}format(e,n){return this.rtf?this.rtf.format(e,n):Qi(n,e,this.opts.numeric,this.opts.style!=="long")}formatToParts(e,n){return this.rtf?this.rtf.formatToParts(e,n):[]}}const jr={firstDay:1,minimalDays:4,weekend:[6,7]};class j{static fromOpts(e){return j.create(e.locale,e.numberingSystem,e.outputCalendar,e.weekSettings,e.defaultToEN)}static create(e,n,a,r,o=!1){const s=e||Y.defaultLocale,l=s||(o?"en-US":bi()),c=n||Y.defaultNumberingSystem,u=a||Y.defaultOutputCalendar,d=aa(r)||Y.defaultWeekSettings;return new j(l,c,u,d,s)}static resetCache(){Tt=null,Kn.clear(),Xn.clear(),Qn.clear(),ea.clear(),ta.clear()}static fromObject({locale:e,numberingSystem:n,outputCalendar:a,weekSettings:r}={}){return j.create(e,n,a,r)}constructor(e,n,a,r,o){const[s,l,c]=Ei(e);this.locale=s,this.numberingSystem=n||l||null,this.outputCalendar=a||c||null,this.weekSettings=r,this.intl=_i(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=o,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=Ai(this)),this.fastNumbersCached}listingMode(){const e=this.isEnglish(),n=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return e&&n?"en":"intl"}clone(e){return!e||Object.getOwnPropertyNames(e).length===0?this:j.create(e.locale||this.specifiedLocale,e.numberingSystem||this.numberingSystem,e.outputCalendar||this.outputCalendar,aa(e.weekSettings)||this.weekSettings,e.defaultToEN||!1)}redefaultToEN(e={}){return this.clone({...e,defaultToEN:!0})}redefaultToSystem(e={}){return this.clone({...e,defaultToEN:!1})}months(e,n=!1){return Jt(this,e,oo,()=>{const a=n?{month:e,day:"numeric"}:{month:e},r=n?"format":"standalone";return this.monthsCache[r][e]||(this.monthsCache[r][e]=ki(o=>this.extract(o,a,"month"))),this.monthsCache[r][e]})}weekdays(e,n=!1){return Jt(this,e,lo,()=>{const a=n?{weekday:e,year:"numeric",month:"long",day:"numeric"}:{weekday:e},r=n?"format":"standalone";return this.weekdaysCache[r][e]||(this.weekdaysCache[r][e]=Ti(o=>this.extract(o,a,"weekday"))),this.weekdaysCache[r][e]})}meridiems(){return Jt(this,void 0,()=>co,()=>{if(!this.meridiemCache){const e={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[F.utc(2016,11,13,9),F.utc(2016,11,13,19)].map(n=>this.extract(n,e,"dayperiod"))}return this.meridiemCache})}eras(e){return Jt(this,e,uo,()=>{const n={era:e};return this.eraCache[e]||(this.eraCache[e]=[F.utc(-40,1,1),F.utc(2017,1,1)].map(a=>this.extract(a,n,"era"))),this.eraCache[e]})}extract(e,n,a){const r=this.dtFormatter(e,n),o=r.formatToParts(),s=o.find(l=>l.type.toLowerCase()===a);return s?s.value:null}numberFormatter(e={}){return new Ci(this.intl,e.forceSimple||this.fastNumbers,e)}dtFormatter(e,n={}){return new Ii(e,this.intl,n)}relFormatter(e={}){return new Ni(this.intl,this.isEnglish(),e)}listFormatter(e={}){return vi(this.intl,e)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||Vr(this.intl).locale.startsWith("en-us")}getWeekSettings(){return this.weekSettings?this.weekSettings:to()?Si(this.locale):jr}getStartOfWeek(){return this.getWeekSettings().firstDay}getMinDaysInFirstWeek(){return this.getWeekSettings().minimalDays}getWeekendDays(){return this.getWeekSettings().weekend}equals(e){return this.locale===e.locale&&this.numberingSystem===e.numberingSystem&&this.outputCalendar===e.outputCalendar}toString(){return`Locale(${this.locale}, ${this.numberingSystem}, ${this.outputCalendar})`}}let Dn=null;class de extends Wt{static get utcInstance(){return Dn===null&&(Dn=new de(0)),Dn}static instance(e){return e===0?de.utcInstance:new de(e)}static parseSpecifier(e){if(e){const n=e.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(n)return new de(Ln(n[1],n[2]))}return null}constructor(e){super(),this.fixed=e}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${Pt(this.fixed,"narrow")}`}get ianaName(){return this.fixed===0?"Etc/UTC":`Etc/GMT${Pt(-this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(e,n){return Pt(this.fixed,n)}get isUniversal(){return!0}offset(){return this.fixed}equals(e){return e.type==="fixed"&&e.fixed===this.fixed}get isValid(){return!0}}class Di extends Wt{constructor(e){super(),this.zoneName=e}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function Ze(t,e){if(H(t)||t===null)return e;if(t instanceof Wt)return t;if(Ri(t)){const n=t.toLowerCase();return n==="default"?e:n==="local"||n==="system"?yn.instance:n==="utc"||n==="gmt"?de.utcInstance:de.parseSpecifier(n)||$e.create(t)}else return Ke(t)?de.instance(t):typeof t=="object"&&"offset"in t&&typeof t.offset=="function"?t:new Di(t)}const ha={arab:"[٠-٩]",arabext:"[۰-۹]",bali:"[᭐-᭙]",beng:"[০-৯]",deva:"[०-९]",fullwide:"[０-９]",gujr:"[૦-૯]",hanidec:"[〇|一|二|三|四|五|六|七|八|九]",khmr:"[០-៩]",knda:"[೦-೯]",laoo:"[໐-໙]",limb:"[᥆-᥏]",mlym:"[൦-൯]",mong:"[᠐-᠙]",mymr:"[၀-၉]",orya:"[୦-୯]",tamldec:"[௦-௯]",telu:"[౦-౯]",thai:"[๐-๙]",tibt:"[༠-༩]",latn:"\\d"},Oa={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},Pi=ha.hanidec.replace(/[\[|\]]/g,"").split("");function Fi(t){let e=parseInt(t,10);if(isNaN(e)){e="";for(let n=0;n<t.length;n++){const a=t.charCodeAt(n);if(t[n].search(ha.hanidec)!==-1)e+=Pi.indexOf(t[n]);else for(const r in Oa){const[o,s]=Oa[r];a>=o&&a<=s&&(e+=a-o)}}return parseInt(e,10)}else return e}const na=new Map;function xi(){na.clear()}function Se({numberingSystem:t},e=""){const n=t||"latn";let a=na.get(n);a===void 0&&(a=new Map,na.set(n,a));let r=a.get(e);return r===void 0&&(r=new RegExp(`${ha[n]}${e}`),a.set(e,r)),r}let Ra=()=>Date.now(),Ua="system",Wa=null,Ha=null,Ba=null,za=60,Ga,Za=null,Y=class{static get now(){return Ra}static set now(e){Ra=e}static set defaultZone(e){Ua=e}static get defaultZone(){return Ze(Ua,yn.instance)}static get defaultLocale(){return Wa}static set defaultLocale(e){Wa=e}static get defaultNumberingSystem(){return Ha}static set defaultNumberingSystem(e){Ha=e}static get defaultOutputCalendar(){return Ba}static set defaultOutputCalendar(e){Ba=e}static get defaultWeekSettings(){return Za}static set defaultWeekSettings(e){Za=aa(e)}static get twoDigitCutoffYear(){return za}static set twoDigitCutoffYear(e){za=e%100}static get throwOnInvalid(){return Ga}static set throwOnInvalid(e){Ga=e}static resetCaches(){j.resetCache(),$e.resetCache(),F.resetCache(),xi()}};class Ae{constructor(e,n){this.reason=e,this.explanation=n}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}const Jr=[0,31,59,90,120,151,181,212,243,273,304,334],qr=[0,31,60,91,121,152,182,213,244,274,305,335];function Le(t,e){return new Ae("unit out of range",`you specified ${e} (of type ${typeof e}) as a ${t}, which is invalid`)}function fa(t,e,n){const a=new Date(Date.UTC(t,e-1,n));t<100&&t>=0&&a.setUTCFullYear(a.getUTCFullYear()-1900);const r=a.getUTCDay();return r===0?7:r}function Kr(t,e,n){return n+(Ht(t)?qr:Jr)[e-1]}function Yr(t,e){const n=Ht(t)?qr:Jr,a=n.findIndex(o=>o<e),r=e-n[a];return{month:a+1,day:r}}function ga(t,e){return(t-e+7)%7+1}function un(t,e=4,n=1){const{year:a,month:r,day:o}=t,s=Kr(a,r,o),l=ga(fa(a,r,o),n);let c=Math.floor((s-l+14-e)/7),u;return c<1?(u=a-1,c=Ot(u,e,n)):c>Ot(a,e,n)?(u=a+1,c=1):u=a,{weekYear:u,weekNumber:c,weekday:l,...Mn(t)}}function Va(t,e=4,n=1){const{weekYear:a,weekNumber:r,weekday:o}=t,s=ga(fa(a,1,e),n),l=gt(a);let c=r*7+o-s-7+e,u;c<1?(u=a-1,c+=gt(u)):c>l?(u=a+1,c-=gt(a)):u=a;const{month:d,day:m}=Yr(u,c);return{year:u,month:d,day:m,...Mn(t)}}function Pn(t){const{year:e,month:n,day:a}=t,r=Kr(e,n,a);return{year:e,ordinal:r,...Mn(t)}}function ja(t){const{year:e,ordinal:n}=t,{month:a,day:r}=Yr(e,n);return{year:e,month:a,day:r,...Mn(t)}}function Ja(t,e){if(!H(t.localWeekday)||!H(t.localWeekNumber)||!H(t.localWeekYear)){if(!H(t.weekday)||!H(t.weekNumber)||!H(t.weekYear))throw new ht("Cannot mix locale-based week fields with ISO-based week fields");return H(t.localWeekday)||(t.weekday=t.localWeekday),H(t.localWeekNumber)||(t.weekNumber=t.localWeekNumber),H(t.localWeekYear)||(t.weekYear=t.localWeekYear),delete t.localWeekday,delete t.localWeekNumber,delete t.localWeekYear,{minDaysInFirstWeek:e.getMinDaysInFirstWeek(),startOfWeek:e.getStartOfWeek()}}else return{minDaysInFirstWeek:4,startOfWeek:1}}function $i(t,e=4,n=1){const a=wn(t.weekYear),r=Me(t.weekNumber,1,Ot(t.weekYear,e,n)),o=Me(t.weekday,1,7);return a?r?o?!1:Le("weekday",t.weekday):Le("week",t.weekNumber):Le("weekYear",t.weekYear)}function Oi(t){const e=wn(t.year),n=Me(t.ordinal,1,gt(t.year));return e?n?!1:Le("ordinal",t.ordinal):Le("year",t.year)}function Xr(t){const e=wn(t.year),n=Me(t.month,1,12),a=Me(t.day,1,dn(t.year,t.month));return e?n?a?!1:Le("day",t.day):Le("month",t.month):Le("year",t.year)}function Qr(t){const{hour:e,minute:n,second:a,millisecond:r}=t,o=Me(e,0,23)||e===24&&n===0&&a===0&&r===0,s=Me(n,0,59),l=Me(a,0,59),c=Me(r,0,999);return o?s?l?c?!1:Le("millisecond",r):Le("second",a):Le("minute",n):Le("hour",e)}function H(t){return typeof t>"u"}function Ke(t){return typeof t=="number"}function wn(t){return typeof t=="number"&&t%1===0}function Ri(t){return typeof t=="string"}function Ui(t){return Object.prototype.toString.call(t)==="[object Date]"}function eo(){try{return typeof Intl<"u"&&!!Intl.RelativeTimeFormat}catch{return!1}}function to(){try{return typeof Intl<"u"&&!!Intl.Locale&&("weekInfo"in Intl.Locale.prototype||"getWeekInfo"in Intl.Locale.prototype)}catch{return!1}}function Wi(t){return Array.isArray(t)?t:[t]}function qa(t,e,n){if(t.length!==0)return t.reduce((a,r)=>{const o=[e(r),r];return a&&n(a[0],o[0])===a[0]?a:o},null)[1]}function Hi(t,e){return e.reduce((n,a)=>(n[a]=t[a],n),{})}function yt(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function aa(t){if(t==null)return null;if(typeof t!="object")throw new le("Week settings must be an object");if(!Me(t.firstDay,1,7)||!Me(t.minimalDays,1,7)||!Array.isArray(t.weekend)||t.weekend.some(e=>!Me(e,1,7)))throw new le("Invalid week settings");return{firstDay:t.firstDay,minimalDays:t.minimalDays,weekend:Array.from(t.weekend)}}function Me(t,e,n){return wn(t)&&t>=e&&t<=n}function Bi(t,e){return t-e*Math.floor(t/e)}function Q(t,e=2){const n=t<0;let a;return n?a="-"+(""+-t).padStart(e,"0"):a=(""+t).padStart(e,"0"),a}function Be(t){if(!(H(t)||t===null||t===""))return parseInt(t,10)}function Qe(t){if(!(H(t)||t===null||t===""))return parseFloat(t)}function pa(t){if(!(H(t)||t===null||t==="")){const e=parseFloat("0."+t)*1e3;return Math.floor(e)}}function ya(t,e,n=!1){const a=10**e;return(n?Math.trunc:Math.round)(t*a)/a}function Ht(t){return t%4===0&&(t%100!==0||t%400===0)}function gt(t){return Ht(t)?366:365}function dn(t,e){const n=Bi(e-1,12)+1,a=t+(e-n)/12;return n===2?Ht(a)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][n-1]}function vn(t){let e=Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,t.second,t.millisecond);return t.year<100&&t.year>=0&&(e=new Date(e),e.setUTCFullYear(t.year,t.month-1,t.day)),+e}function Ka(t,e,n){return-ga(fa(t,1,e),n)+e-1}function Ot(t,e=4,n=1){const a=Ka(t,e,n),r=Ka(t+1,e,n);return(gt(t)-a+r)/7}function ra(t){return t>99?t:t>Y.twoDigitCutoffYear?1900+t:2e3+t}function no(t,e,n,a=null){const r=new Date(t),o={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};a&&(o.timeZone=a);const s={timeZoneName:e,...o},l=new Intl.DateTimeFormat(n,s).formatToParts(r).find(c=>c.type.toLowerCase()==="timezonename");return l?l.value:null}function Ln(t,e){let n=parseInt(t,10);Number.isNaN(n)&&(n=0);const a=parseInt(e,10)||0,r=n<0||Object.is(n,-0)?-a:a;return n*60+r}function ao(t){const e=Number(t);if(typeof t=="boolean"||t===""||Number.isNaN(e))throw new le(`Invalid unit value ${t}`);return e}function mn(t,e){const n={};for(const a in t)if(yt(t,a)){const r=t[a];if(r==null)continue;n[e(a)]=ao(r)}return n}function Pt(t,e){const n=Math.trunc(Math.abs(t/60)),a=Math.trunc(Math.abs(t%60)),r=t>=0?"+":"-";switch(e){case"short":return`${r}${Q(n,2)}:${Q(a,2)}`;case"narrow":return`${r}${n}${a>0?`:${a}`:""}`;case"techie":return`${r}${Q(n,2)}${Q(a,2)}`;default:throw new RangeError(`Value format ${e} is out of range for property format`)}}function Mn(t){return Hi(t,["hour","minute","second","millisecond"])}const zi=["January","February","March","April","May","June","July","August","September","October","November","December"],ro=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Gi=["J","F","M","A","M","J","J","A","S","O","N","D"];function oo(t){switch(t){case"narrow":return[...Gi];case"short":return[...ro];case"long":return[...zi];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const io=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],so=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Zi=["M","T","W","T","F","S","S"];function lo(t){switch(t){case"narrow":return[...Zi];case"short":return[...so];case"long":return[...io];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const co=["AM","PM"],Vi=["Before Christ","Anno Domini"],ji=["BC","AD"],Ji=["B","A"];function uo(t){switch(t){case"narrow":return[...Ji];case"short":return[...ji];case"long":return[...Vi];default:return null}}function qi(t){return co[t.hour<12?0:1]}function Ki(t,e){return lo(e)[t.weekday-1]}function Yi(t,e){return oo(e)[t.month-1]}function Xi(t,e){return uo(e)[t.year<0?0:1]}function Qi(t,e,n="always",a=!1){const r={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},o=["hours","minutes","seconds"].indexOf(t)===-1;if(n==="auto"&&o){const m=t==="days";switch(e){case 1:return m?"tomorrow":`next ${r[t][0]}`;case-1:return m?"yesterday":`last ${r[t][0]}`;case 0:return m?"today":`this ${r[t][0]}`}}const s=Object.is(e,-0)||e<0,l=Math.abs(e),c=l===1,u=r[t],d=a?c?u[1]:u[2]||u[1]:c?r[t][0]:t;return s?`${l} ${d} ago`:`in ${l} ${d}`}function Ya(t,e){let n="";for(const a of t)a.literal?n+=a.val:n+=e(a.val);return n}const es={D:cn,DD:Tr,DDD:Ar,DDDD:Cr,t:Ir,tt:Nr,ttt:Dr,tttt:Pr,T:Fr,TT:xr,TTT:$r,TTTT:Or,f:Rr,ff:Wr,fff:Br,ffff:Gr,F:Ur,FF:Hr,FFF:zr,FFFF:Zr};class ce{static create(e,n={}){return new ce(e,n)}static parseFormat(e){let n=null,a="",r=!1;const o=[];for(let s=0;s<e.length;s++){const l=e.charAt(s);l==="'"?(a.length>0&&o.push({literal:r||/^\s+$/.test(a),val:a}),n=null,a="",r=!r):r||l===n?a+=l:(a.length>0&&o.push({literal:/^\s+$/.test(a),val:a}),a=l,n=l)}return a.length>0&&o.push({literal:r||/^\s+$/.test(a),val:a}),o}static macroTokenToFormatOpts(e){return es[e]}constructor(e,n){this.opts=n,this.loc=e,this.systemLoc=null}formatWithSystemDefault(e,n){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(e,{...this.opts,...n}).format()}dtFormatter(e,n={}){return this.loc.dtFormatter(e,{...this.opts,...n})}formatDateTime(e,n){return this.dtFormatter(e,n).format()}formatDateTimeParts(e,n){return this.dtFormatter(e,n).formatToParts()}formatInterval(e,n){return this.dtFormatter(e.start,n).dtf.formatRange(e.start.toJSDate(),e.end.toJSDate())}resolvedOptions(e,n){return this.dtFormatter(e,n).resolvedOptions()}num(e,n=0){if(this.opts.forceSimple)return Q(e,n);const a={...this.opts};return n>0&&(a.padTo=n),this.loc.numberFormatter(a).format(e)}formatDateTimeFromString(e,n){const a=this.loc.listingMode()==="en",r=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",o=(h,v)=>this.loc.extract(e,h,v),s=h=>e.isOffsetFixed&&e.offset===0&&h.allowZ?"Z":e.isValid?e.zone.formatOffset(e.ts,h.format):"",l=()=>a?qi(e):o({hour:"numeric",hourCycle:"h12"},"dayperiod"),c=(h,v)=>a?Yi(e,h):o(v?{month:h}:{month:h,day:"numeric"},"month"),u=(h,v)=>a?Ki(e,h):o(v?{weekday:h}:{weekday:h,month:"long",day:"numeric"},"weekday"),d=h=>{const v=ce.macroTokenToFormatOpts(h);return v?this.formatWithSystemDefault(e,v):h},m=h=>a?Xi(e,h):o({era:h},"era"),p=h=>{switch(h){case"S":return this.num(e.millisecond);case"u":case"SSS":return this.num(e.millisecond,3);case"s":return this.num(e.second);case"ss":return this.num(e.second,2);case"uu":return this.num(Math.floor(e.millisecond/10),2);case"uuu":return this.num(Math.floor(e.millisecond/100));case"m":return this.num(e.minute);case"mm":return this.num(e.minute,2);case"h":return this.num(e.hour%12===0?12:e.hour%12);case"hh":return this.num(e.hour%12===0?12:e.hour%12,2);case"H":return this.num(e.hour);case"HH":return this.num(e.hour,2);case"Z":return s({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return s({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return s({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return e.zone.offsetName(e.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return e.zone.offsetName(e.ts,{format:"long",locale:this.loc.locale});case"z":return e.zoneName;case"a":return l();case"d":return r?o({day:"numeric"},"day"):this.num(e.day);case"dd":return r?o({day:"2-digit"},"day"):this.num(e.day,2);case"c":return this.num(e.weekday);case"ccc":return u("short",!0);case"cccc":return u("long",!0);case"ccccc":return u("narrow",!0);case"E":return this.num(e.weekday);case"EEE":return u("short",!1);case"EEEE":return u("long",!1);case"EEEEE":return u("narrow",!1);case"L":return r?o({month:"numeric",day:"numeric"},"month"):this.num(e.month);case"LL":return r?o({month:"2-digit",day:"numeric"},"month"):this.num(e.month,2);case"LLL":return c("short",!0);case"LLLL":return c("long",!0);case"LLLLL":return c("narrow",!0);case"M":return r?o({month:"numeric"},"month"):this.num(e.month);case"MM":return r?o({month:"2-digit"},"month"):this.num(e.month,2);case"MMM":return c("short",!1);case"MMMM":return c("long",!1);case"MMMMM":return c("narrow",!1);case"y":return r?o({year:"numeric"},"year"):this.num(e.year);case"yy":return r?o({year:"2-digit"},"year"):this.num(e.year.toString().slice(-2),2);case"yyyy":return r?o({year:"numeric"},"year"):this.num(e.year,4);case"yyyyyy":return r?o({year:"numeric"},"year"):this.num(e.year,6);case"G":return m("short");case"GG":return m("long");case"GGGGG":return m("narrow");case"kk":return this.num(e.weekYear.toString().slice(-2),2);case"kkkk":return this.num(e.weekYear,4);case"W":return this.num(e.weekNumber);case"WW":return this.num(e.weekNumber,2);case"n":return this.num(e.localWeekNumber);case"nn":return this.num(e.localWeekNumber,2);case"ii":return this.num(e.localWeekYear.toString().slice(-2),2);case"iiii":return this.num(e.localWeekYear,4);case"o":return this.num(e.ordinal);case"ooo":return this.num(e.ordinal,3);case"q":return this.num(e.quarter);case"qq":return this.num(e.quarter,2);case"X":return this.num(Math.floor(e.ts/1e3));case"x":return this.num(e.ts);default:return d(h)}};return Ya(ce.parseFormat(n),p)}formatDurationFromString(e,n){const a=c=>{switch(c[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"w":return"week";case"M":return"month";case"y":return"year";default:return null}},r=c=>u=>{const d=a(u);return d?this.num(c.get(d),u.length):u},o=ce.parseFormat(n),s=o.reduce((c,{literal:u,val:d})=>u?c:c.concat(d),[]),l=e.shiftTo(...s.map(a).filter(c=>c));return Ya(o,r(l))}}const mo=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function Lt(...t){const e=t.reduce((n,a)=>n+a.source,"");return RegExp(`^${e}$`)}function Mt(...t){return e=>t.reduce(([n,a,r],o)=>{const[s,l,c]=o(e,r);return[{...n,...s},l||a,c]},[{},null,1]).slice(0,2)}function bt(t,...e){if(t==null)return[null,null];for(const[n,a]of e){const r=n.exec(t);if(r)return a(r)}return[null,null]}function ho(...t){return(e,n)=>{const a={};let r;for(r=0;r<t.length;r++)a[t[r]]=Be(e[n+r]);return[a,null,n+r]}}const fo=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,ts=`(?:${fo.source}?(?:\\[(${mo.source})\\])?)?`,wa=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,go=RegExp(`${wa.source}${ts}`),va=RegExp(`(?:T${go.source})?`),ns=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,as=/(\d{4})-?W(\d\d)(?:-?(\d))?/,rs=/(\d{4})-?(\d{3})/,os=ho("weekYear","weekNumber","weekDay"),is=ho("year","ordinal"),ss=/(\d{4})-(\d\d)-(\d\d)/,po=RegExp(`${wa.source} ?(?:${fo.source}|(${mo.source}))?`),ls=RegExp(`(?: ${po.source})?`);function pt(t,e,n){const a=t[e];return H(a)?n:Be(a)}function cs(t,e){return[{year:pt(t,e),month:pt(t,e+1,1),day:pt(t,e+2,1)},null,e+3]}function St(t,e){return[{hours:pt(t,e,0),minutes:pt(t,e+1,0),seconds:pt(t,e+2,0),milliseconds:pa(t[e+3])},null,e+4]}function Bt(t,e){const n=!t[e]&&!t[e+1],a=Ln(t[e+1],t[e+2]),r=n?null:de.instance(a);return[{},r,e+3]}function zt(t,e){const n=t[e]?$e.create(t[e]):null;return[{},n,e+1]}const us=RegExp(`^T?${wa.source}$`),ds=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function ms(t){const[e,n,a,r,o,s,l,c,u]=t,d=e[0]==="-",m=c&&c[0]==="-",p=(h,v=!1)=>h!==void 0&&(v||h&&d)?-h:h;return[{years:p(Qe(n)),months:p(Qe(a)),weeks:p(Qe(r)),days:p(Qe(o)),hours:p(Qe(s)),minutes:p(Qe(l)),seconds:p(Qe(c),c==="-0"),milliseconds:p(pa(u),m)}]}const hs={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function La(t,e,n,a,r,o,s){const l={year:e.length===2?ra(Be(e)):Be(e),month:ro.indexOf(n)+1,day:Be(a),hour:Be(r),minute:Be(o)};return s&&(l.second=Be(s)),t&&(l.weekday=t.length>3?io.indexOf(t)+1:so.indexOf(t)+1),l}const fs=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function gs(t){const[,e,n,a,r,o,s,l,c,u,d,m]=t,p=La(e,r,a,n,o,s,l);let h;return c?h=hs[c]:u?h=0:h=Ln(d,m),[p,new de(h)]}function ps(t){return t.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const ys=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,ws=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,vs=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function Xa(t){const[,e,n,a,r,o,s,l]=t;return[La(e,r,a,n,o,s,l),de.utcInstance]}function Ls(t){const[,e,n,a,r,o,s,l]=t;return[La(e,l,n,a,r,o,s),de.utcInstance]}const Ms=Lt(ns,va),bs=Lt(as,va),Ss=Lt(rs,va),Es=Lt(go),yo=Mt(cs,St,Bt,zt),_s=Mt(os,St,Bt,zt),ks=Mt(is,St,Bt,zt),Ts=Mt(St,Bt,zt);function As(t){return bt(t,[Ms,yo],[bs,_s],[Ss,ks],[Es,Ts])}function Cs(t){return bt(ps(t),[fs,gs])}function Is(t){return bt(t,[ys,Xa],[ws,Xa],[vs,Ls])}function Ns(t){return bt(t,[ds,ms])}const Ds=Mt(St);function Ps(t){return bt(t,[us,Ds])}const Fs=Lt(ss,ls),xs=Lt(po),$s=Mt(St,Bt,zt);function Os(t){return bt(t,[Fs,yo],[xs,$s])}const Qa="Invalid Duration",wo={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1e3},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1e3},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},Rs={years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1e3},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1e3},...wo},we=146097/400,lt=146097/4800,Us={years:{quarters:4,months:12,weeks:we/7,days:we,hours:we*24,minutes:we*24*60,seconds:we*24*60*60,milliseconds:we*24*60*60*1e3},quarters:{months:3,weeks:we/28,days:we/4,hours:we*24/4,minutes:we*24*60/4,seconds:we*24*60*60/4,milliseconds:we*24*60*60*1e3/4},months:{weeks:lt/7,days:lt,hours:lt*24,minutes:lt*24*60,seconds:lt*24*60*60,milliseconds:lt*24*60*60*1e3},...wo},rt=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],Ws=rt.slice(0).reverse();function We(t,e,n=!1){const a={values:n?e.values:{...t.values,...e.values||{}},loc:t.loc.clone(e.loc),conversionAccuracy:e.conversionAccuracy||t.conversionAccuracy,matrix:e.matrix||t.matrix};return new G(a)}function vo(t,e){let n=e.milliseconds??0;for(const a of Ws.slice(1))e[a]&&(n+=e[a]*t[a].milliseconds);return n}function er(t,e){const n=vo(t,e)<0?-1:1;rt.reduceRight((a,r)=>{if(H(e[r]))return a;if(a){const o=e[a]*n,s=t[r][a],l=Math.floor(o/s);e[r]+=l*n,e[a]-=l*s*n}return r},null),rt.reduce((a,r)=>{if(H(e[r]))return a;if(a){const o=e[a]%1;e[a]-=o,e[r]+=o*t[a][r]}return r},null)}function Hs(t){const e={};for(const[n,a]of Object.entries(t))a!==0&&(e[n]=a);return e}class G{constructor(e){const n=e.conversionAccuracy==="longterm"||!1;let a=n?Us:Rs;e.matrix&&(a=e.matrix),this.values=e.values,this.loc=e.loc||j.create(),this.conversionAccuracy=n?"longterm":"casual",this.invalid=e.invalid||null,this.matrix=a,this.isLuxonDuration=!0}static fromMillis(e,n){return G.fromObject({milliseconds:e},n)}static fromObject(e,n={}){if(e==null||typeof e!="object")throw new le(`Duration.fromObject: argument expected to be an object, got ${e===null?"null":typeof e}`);return new G({values:mn(e,G.normalizeUnit),loc:j.fromObject(n),conversionAccuracy:n.conversionAccuracy,matrix:n.matrix})}static fromDurationLike(e){if(Ke(e))return G.fromMillis(e);if(G.isDuration(e))return e;if(typeof e=="object")return G.fromObject(e);throw new le(`Unknown duration argument ${e} of type ${typeof e}`)}static fromISO(e,n){const[a]=Ns(e);return a?G.fromObject(a,n):G.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static fromISOTime(e,n){const[a]=Ps(e);return a?G.fromObject(a,n):G.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static invalid(e,n=null){if(!e)throw new le("need to specify a reason the Duration is invalid");const a=e instanceof Ae?e:new Ae(e,n);if(Y.throwOnInvalid)throw new mi(a);return new G({invalid:a})}static normalizeUnit(e){const n={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[e&&e.toLowerCase()];if(!n)throw new kr(e);return n}static isDuration(e){return e&&e.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(e,n={}){const a={...n,floor:n.round!==!1&&n.floor!==!1};return this.isValid?ce.create(this.loc,a).formatDurationFromString(this,e):Qa}toHuman(e={}){if(!this.isValid)return Qa;const n=rt.map(a=>{const r=this.values[a];return H(r)?null:this.loc.numberFormatter({style:"unit",unitDisplay:"long",...e,unit:a.slice(0,-1)}).format(r)}).filter(a=>a);return this.loc.listFormatter({type:"conjunction",style:e.listStyle||"narrow",...e}).format(n)}toObject(){return this.isValid?{...this.values}:{}}toISO(){if(!this.isValid)return null;let e="P";return this.years!==0&&(e+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(e+=this.months+this.quarters*3+"M"),this.weeks!==0&&(e+=this.weeks+"W"),this.days!==0&&(e+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(e+="T"),this.hours!==0&&(e+=this.hours+"H"),this.minutes!==0&&(e+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(e+=ya(this.seconds+this.milliseconds/1e3,3)+"S"),e==="P"&&(e+="T0S"),e}toISOTime(e={}){if(!this.isValid)return null;const n=this.toMillis();return n<0||n>=864e5?null:(e={suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended",...e,includeOffset:!1},F.fromMillis(n,{zone:"UTC"}).toISOTime(e))}toJSON(){return this.toISO()}toString(){return this.toISO()}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Duration { values: ${JSON.stringify(this.values)} }`:`Duration { Invalid, reason: ${this.invalidReason} }`}toMillis(){return this.isValid?vo(this.matrix,this.values):NaN}valueOf(){return this.toMillis()}plus(e){if(!this.isValid)return this;const n=G.fromDurationLike(e),a={};for(const r of rt)(yt(n.values,r)||yt(this.values,r))&&(a[r]=n.get(r)+this.get(r));return We(this,{values:a},!0)}minus(e){if(!this.isValid)return this;const n=G.fromDurationLike(e);return this.plus(n.negate())}mapUnits(e){if(!this.isValid)return this;const n={};for(const a of Object.keys(this.values))n[a]=ao(e(this.values[a],a));return We(this,{values:n},!0)}get(e){return this[G.normalizeUnit(e)]}set(e){if(!this.isValid)return this;const n={...this.values,...mn(e,G.normalizeUnit)};return We(this,{values:n})}reconfigure({locale:e,numberingSystem:n,conversionAccuracy:a,matrix:r}={}){const s={loc:this.loc.clone({locale:e,numberingSystem:n}),matrix:r,conversionAccuracy:a};return We(this,s)}as(e){return this.isValid?this.shiftTo(e).get(e):NaN}normalize(){if(!this.isValid)return this;const e=this.toObject();return er(this.matrix,e),We(this,{values:e},!0)}rescale(){if(!this.isValid)return this;const e=Hs(this.normalize().shiftToAll().toObject());return We(this,{values:e},!0)}shiftTo(...e){if(!this.isValid)return this;if(e.length===0)return this;e=e.map(s=>G.normalizeUnit(s));const n={},a={},r=this.toObject();let o;for(const s of rt)if(e.indexOf(s)>=0){o=s;let l=0;for(const u in a)l+=this.matrix[u][s]*a[u],a[u]=0;Ke(r[s])&&(l+=r[s]);const c=Math.trunc(l);n[s]=c,a[s]=(l*1e3-c*1e3)/1e3}else Ke(r[s])&&(a[s]=r[s]);for(const s in a)a[s]!==0&&(n[o]+=s===o?a[s]:a[s]/this.matrix[o][s]);return er(this.matrix,n),We(this,{values:n},!0)}shiftToAll(){return this.isValid?this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds"):this}negate(){if(!this.isValid)return this;const e={};for(const n of Object.keys(this.values))e[n]=this.values[n]===0?0:-this.values[n];return We(this,{values:e},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(e){if(!this.isValid||!e.isValid||!this.loc.equals(e.loc))return!1;function n(a,r){return a===void 0||a===0?r===void 0||r===0:a===r}for(const a of rt)if(!n(this.values[a],e.values[a]))return!1;return!0}}const ct="Invalid Interval";function Bs(t,e){return!t||!t.isValid?K.invalid("missing or invalid start"):!e||!e.isValid?K.invalid("missing or invalid end"):e<t?K.invalid("end before start",`The end of an interval must be after its start, but you had start=${t.toISO()} and end=${e.toISO()}`):null}class K{constructor(e){this.s=e.start,this.e=e.end,this.invalid=e.invalid||null,this.isLuxonInterval=!0}static invalid(e,n=null){if(!e)throw new le("need to specify a reason the Interval is invalid");const a=e instanceof Ae?e:new Ae(e,n);if(Y.throwOnInvalid)throw new di(a);return new K({invalid:a})}static fromDateTimes(e,n){const a=kt(e),r=kt(n),o=Bs(a,r);return o??new K({start:a,end:r})}static after(e,n){const a=G.fromDurationLike(n),r=kt(e);return K.fromDateTimes(r,r.plus(a))}static before(e,n){const a=G.fromDurationLike(n),r=kt(e);return K.fromDateTimes(r.minus(a),r)}static fromISO(e,n){const[a,r]=(e||"").split("/",2);if(a&&r){let o,s;try{o=F.fromISO(a,n),s=o.isValid}catch{s=!1}let l,c;try{l=F.fromISO(r,n),c=l.isValid}catch{c=!1}if(s&&c)return K.fromDateTimes(o,l);if(s){const u=G.fromISO(r,n);if(u.isValid)return K.after(o,u)}else if(c){const u=G.fromISO(a,n);if(u.isValid)return K.before(l,u)}}return K.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static isInterval(e){return e&&e.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get lastDateTime(){return this.isValid&&this.e?this.e.minus(1):null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(e="milliseconds"){return this.isValid?this.toDuration(e).get(e):NaN}count(e="milliseconds",n){if(!this.isValid)return NaN;const a=this.start.startOf(e,n);let r;return n!=null&&n.useLocaleWeeks?r=this.end.reconfigure({locale:a.locale}):r=this.end,r=r.startOf(e,n),Math.floor(r.diff(a,e).get(e))+(r.valueOf()!==this.end.valueOf())}hasSame(e){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,e):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(e){return this.isValid?this.s>e:!1}isBefore(e){return this.isValid?this.e<=e:!1}contains(e){return this.isValid?this.s<=e&&this.e>e:!1}set({start:e,end:n}={}){return this.isValid?K.fromDateTimes(e||this.s,n||this.e):this}splitAt(...e){if(!this.isValid)return[];const n=e.map(kt).filter(s=>this.contains(s)).sort((s,l)=>s.toMillis()-l.toMillis()),a=[];let{s:r}=this,o=0;for(;r<this.e;){const s=n[o]||this.e,l=+s>+this.e?this.e:s;a.push(K.fromDateTimes(r,l)),r=l,o+=1}return a}splitBy(e){const n=G.fromDurationLike(e);if(!this.isValid||!n.isValid||n.as("milliseconds")===0)return[];let{s:a}=this,r=1,o;const s=[];for(;a<this.e;){const l=this.start.plus(n.mapUnits(c=>c*r));o=+l>+this.e?this.e:l,s.push(K.fromDateTimes(a,o)),a=o,r+=1}return s}divideEqually(e){return this.isValid?this.splitBy(this.length()/e).slice(0,e):[]}overlaps(e){return this.e>e.s&&this.s<e.e}abutsStart(e){return this.isValid?+this.e==+e.s:!1}abutsEnd(e){return this.isValid?+e.e==+this.s:!1}engulfs(e){return this.isValid?this.s<=e.s&&this.e>=e.e:!1}equals(e){return!this.isValid||!e.isValid?!1:this.s.equals(e.s)&&this.e.equals(e.e)}intersection(e){if(!this.isValid)return this;const n=this.s>e.s?this.s:e.s,a=this.e<e.e?this.e:e.e;return n>=a?null:K.fromDateTimes(n,a)}union(e){if(!this.isValid)return this;const n=this.s<e.s?this.s:e.s,a=this.e>e.e?this.e:e.e;return K.fromDateTimes(n,a)}static merge(e){const[n,a]=e.sort((r,o)=>r.s-o.s).reduce(([r,o],s)=>o?o.overlaps(s)||o.abutsStart(s)?[r,o.union(s)]:[r.concat([o]),s]:[r,s],[[],null]);return a&&n.push(a),n}static xor(e){let n=null,a=0;const r=[],o=e.map(c=>[{time:c.s,type:"s"},{time:c.e,type:"e"}]),s=Array.prototype.concat(...o),l=s.sort((c,u)=>c.time-u.time);for(const c of l)a+=c.type==="s"?1:-1,a===1?n=c.time:(n&&+n!=+c.time&&r.push(K.fromDateTimes(n,c.time)),n=null);return K.merge(r)}difference(...e){return K.xor([this].concat(e)).map(n=>this.intersection(n)).filter(n=>n&&!n.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()} – ${this.e.toISO()})`:ct}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Interval { start: ${this.s.toISO()}, end: ${this.e.toISO()} }`:`Interval { Invalid, reason: ${this.invalidReason} }`}toLocaleString(e=cn,n={}){return this.isValid?ce.create(this.s.loc.clone(n),e).formatInterval(this):ct}toISO(e){return this.isValid?`${this.s.toISO(e)}/${this.e.toISO(e)}`:ct}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:ct}toISOTime(e){return this.isValid?`${this.s.toISOTime(e)}/${this.e.toISOTime(e)}`:ct}toFormat(e,{separator:n=" – "}={}){return this.isValid?`${this.s.toFormat(e)}${n}${this.e.toFormat(e)}`:ct}toDuration(e,n){return this.isValid?this.e.diff(this.s,e,n):G.invalid(this.invalidReason)}mapEndpoints(e){return K.fromDateTimes(e(this.s),e(this.e))}}class qt{static hasDST(e=Y.defaultZone){const n=F.now().setZone(e).set({month:12});return!e.isUniversal&&n.offset!==n.set({month:6}).offset}static isValidIANAZone(e){return $e.isValidZone(e)}static normalizeZone(e){return Ze(e,Y.defaultZone)}static getStartOfWeek({locale:e=null,locObj:n=null}={}){return(n||j.create(e)).getStartOfWeek()}static getMinimumDaysInFirstWeek({locale:e=null,locObj:n=null}={}){return(n||j.create(e)).getMinDaysInFirstWeek()}static getWeekendWeekdays({locale:e=null,locObj:n=null}={}){return(n||j.create(e)).getWeekendDays().slice()}static months(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null,outputCalendar:o="gregory"}={}){return(r||j.create(n,a,o)).months(e)}static monthsFormat(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null,outputCalendar:o="gregory"}={}){return(r||j.create(n,a,o)).months(e,!0)}static weekdays(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null}={}){return(r||j.create(n,a,null)).weekdays(e)}static weekdaysFormat(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null}={}){return(r||j.create(n,a,null)).weekdays(e,!0)}static meridiems({locale:e=null}={}){return j.create(e).meridiems()}static eras(e="short",{locale:n=null}={}){return j.create(n,null,"gregory").eras(e)}static features(){return{relative:eo(),localeWeek:to()}}}function tr(t,e){const n=r=>r.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),a=n(e)-n(t);return Math.floor(G.fromMillis(a).as("days"))}function zs(t,e,n){const a=[["years",(c,u)=>u.year-c.year],["quarters",(c,u)=>u.quarter-c.quarter+(u.year-c.year)*4],["months",(c,u)=>u.month-c.month+(u.year-c.year)*12],["weeks",(c,u)=>{const d=tr(c,u);return(d-d%7)/7}],["days",tr]],r={},o=t;let s,l;for(const[c,u]of a)n.indexOf(c)>=0&&(s=c,r[c]=u(t,e),l=o.plus(r),l>e?(r[c]--,t=o.plus(r),t>e&&(l=t,r[c]--,t=o.plus(r))):t=l);return[t,r,l,s]}function Gs(t,e,n,a){let[r,o,s,l]=zs(t,e,n);const c=e-r,u=n.filter(m=>["hours","minutes","seconds","milliseconds"].indexOf(m)>=0);u.length===0&&(s<e&&(s=r.plus({[l]:1})),s!==r&&(o[l]=(o[l]||0)+c/(s-r)));const d=G.fromObject(o,a);return u.length>0?G.fromMillis(c,a).shiftTo(...u).plus(d):d}const Zs="missing Intl.DateTimeFormat.formatToParts support";function V(t,e=n=>n){return{regex:t,deser:([n])=>e(Fi(n))}}const Vs=" ",Lo=`[ ${Vs}]`,Mo=new RegExp(Lo,"g");function js(t){return t.replace(/\./g,"\\.?").replace(Mo,Lo)}function nr(t){return t.replace(/\./g,"").replace(Mo," ").toLowerCase()}function Ee(t,e){return t===null?null:{regex:RegExp(t.map(js).join("|")),deser:([n])=>t.findIndex(a=>nr(n)===nr(a))+e}}function ar(t,e){return{regex:t,deser:([,n,a])=>Ln(n,a),groups:e}}function Kt(t){return{regex:t,deser:([e])=>e}}function Js(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function qs(t,e){const n=Se(e),a=Se(e,"{2}"),r=Se(e,"{3}"),o=Se(e,"{4}"),s=Se(e,"{6}"),l=Se(e,"{1,2}"),c=Se(e,"{1,3}"),u=Se(e,"{1,6}"),d=Se(e,"{1,9}"),m=Se(e,"{2,4}"),p=Se(e,"{4,6}"),h=w=>({regex:RegExp(Js(w.val)),deser:([M])=>M,literal:!0}),b=(w=>{if(t.literal)return h(w);switch(w.val){case"G":return Ee(e.eras("short"),0);case"GG":return Ee(e.eras("long"),0);case"y":return V(u);case"yy":return V(m,ra);case"yyyy":return V(o);case"yyyyy":return V(p);case"yyyyyy":return V(s);case"M":return V(l);case"MM":return V(a);case"MMM":return Ee(e.months("short",!0),1);case"MMMM":return Ee(e.months("long",!0),1);case"L":return V(l);case"LL":return V(a);case"LLL":return Ee(e.months("short",!1),1);case"LLLL":return Ee(e.months("long",!1),1);case"d":return V(l);case"dd":return V(a);case"o":return V(c);case"ooo":return V(r);case"HH":return V(a);case"H":return V(l);case"hh":return V(a);case"h":return V(l);case"mm":return V(a);case"m":return V(l);case"q":return V(l);case"qq":return V(a);case"s":return V(l);case"ss":return V(a);case"S":return V(c);case"SSS":return V(r);case"u":return Kt(d);case"uu":return Kt(l);case"uuu":return V(n);case"a":return Ee(e.meridiems(),0);case"kkkk":return V(o);case"kk":return V(m,ra);case"W":return V(l);case"WW":return V(a);case"E":case"c":return V(n);case"EEE":return Ee(e.weekdays("short",!1),1);case"EEEE":return Ee(e.weekdays("long",!1),1);case"ccc":return Ee(e.weekdays("short",!0),1);case"cccc":return Ee(e.weekdays("long",!0),1);case"Z":case"ZZ":return ar(new RegExp(`([+-]${l.source})(?::(${a.source}))?`),2);case"ZZZ":return ar(new RegExp(`([+-]${l.source})(${a.source})?`),2);case"z":return Kt(/[a-z_+-/]{1,256}?/i);case" ":return Kt(/[^\S\n\r]/);default:return h(w)}})(t)||{invalidReason:Zs};return b.token=t,b}const Ks={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour12:{numeric:"h","2-digit":"hh"},hour24:{numeric:"H","2-digit":"HH"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"},timeZoneName:{long:"ZZZZZ",short:"ZZZ"}};function Ys(t,e,n){const{type:a,value:r}=t;if(a==="literal"){const c=/^\s+$/.test(r);return{literal:!c,val:c?" ":r}}const o=e[a];let s=a;a==="hour"&&(e.hour12!=null?s=e.hour12?"hour12":"hour24":e.hourCycle!=null?e.hourCycle==="h11"||e.hourCycle==="h12"?s="hour12":s="hour24":s=n.hour12?"hour12":"hour24");let l=Ks[s];if(typeof l=="object"&&(l=l[o]),l)return{literal:!1,val:l}}function Xs(t){return[`^${t.map(n=>n.regex).reduce((n,a)=>`${n}(${a.source})`,"")}$`,t]}function Qs(t,e,n){const a=t.match(e);if(a){const r={};let o=1;for(const s in n)if(yt(n,s)){const l=n[s],c=l.groups?l.groups+1:1;!l.literal&&l.token&&(r[l.token.val[0]]=l.deser(a.slice(o,o+c))),o+=c}return[a,r]}else return[a,{}]}function el(t){const e=o=>{switch(o){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let n=null,a;return H(t.z)||(n=$e.create(t.z)),H(t.Z)||(n||(n=new de(t.Z)),a=t.Z),H(t.q)||(t.M=(t.q-1)*3+1),H(t.h)||(t.h<12&&t.a===1?t.h+=12:t.h===12&&t.a===0&&(t.h=0)),t.G===0&&t.y&&(t.y=-t.y),H(t.u)||(t.S=pa(t.u)),[Object.keys(t).reduce((o,s)=>{const l=e(s);return l&&(o[l]=t[s]),o},{}),n,a]}let Fn=null;function tl(){return Fn||(Fn=F.fromMillis(1555555555555)),Fn}function nl(t,e){if(t.literal)return t;const n=ce.macroTokenToFormatOpts(t.val),a=_o(n,e);return a==null||a.includes(void 0)?t:a}function bo(t,e){return Array.prototype.concat(...t.map(n=>nl(n,e)))}class So{constructor(e,n){if(this.locale=e,this.format=n,this.tokens=bo(ce.parseFormat(n),e),this.units=this.tokens.map(a=>qs(a,e)),this.disqualifyingUnit=this.units.find(a=>a.invalidReason),!this.disqualifyingUnit){const[a,r]=Xs(this.units);this.regex=RegExp(a,"i"),this.handlers=r}}explainFromTokens(e){if(this.isValid){const[n,a]=Qs(e,this.regex,this.handlers),[r,o,s]=a?el(a):[null,null,void 0];if(yt(a,"a")&&yt(a,"H"))throw new ht("Can't include meridiem when specifying 24-hour format");return{input:e,tokens:this.tokens,regex:this.regex,rawMatches:n,matches:a,result:r,zone:o,specificOffset:s}}else return{input:e,tokens:this.tokens,invalidReason:this.invalidReason}}get isValid(){return!this.disqualifyingUnit}get invalidReason(){return this.disqualifyingUnit?this.disqualifyingUnit.invalidReason:null}}function Eo(t,e,n){return new So(t,n).explainFromTokens(e)}function al(t,e,n){const{result:a,zone:r,specificOffset:o,invalidReason:s}=Eo(t,e,n);return[a,r,o,s]}function _o(t,e){if(!t)return null;const a=ce.create(e,t).dtFormatter(tl()),r=a.formatToParts(),o=a.resolvedOptions();return r.map(s=>Ys(s,t,o))}const xn="Invalid DateTime",rr=864e13;function At(t){return new Ae("unsupported zone",`the zone "${t.name}" is not supported`)}function $n(t){return t.weekData===null&&(t.weekData=un(t.c)),t.weekData}function On(t){return t.localWeekData===null&&(t.localWeekData=un(t.c,t.loc.getMinDaysInFirstWeek(),t.loc.getStartOfWeek())),t.localWeekData}function et(t,e){const n={ts:t.ts,zone:t.zone,c:t.c,o:t.o,loc:t.loc,invalid:t.invalid};return new F({...n,...e,old:n})}function ko(t,e,n){let a=t-e*60*1e3;const r=n.offset(a);if(e===r)return[a,e];a-=(r-e)*60*1e3;const o=n.offset(a);return r===o?[a,r]:[t-Math.min(r,o)*60*1e3,Math.max(r,o)]}function Yt(t,e){t+=e*60*1e3;const n=new Date(t);return{year:n.getUTCFullYear(),month:n.getUTCMonth()+1,day:n.getUTCDate(),hour:n.getUTCHours(),minute:n.getUTCMinutes(),second:n.getUTCSeconds(),millisecond:n.getUTCMilliseconds()}}function an(t,e,n){return ko(vn(t),e,n)}function or(t,e){const n=t.o,a=t.c.year+Math.trunc(e.years),r=t.c.month+Math.trunc(e.months)+Math.trunc(e.quarters)*3,o={...t.c,year:a,month:r,day:Math.min(t.c.day,dn(a,r))+Math.trunc(e.days)+Math.trunc(e.weeks)*7},s=G.fromObject({years:e.years-Math.trunc(e.years),quarters:e.quarters-Math.trunc(e.quarters),months:e.months-Math.trunc(e.months),weeks:e.weeks-Math.trunc(e.weeks),days:e.days-Math.trunc(e.days),hours:e.hours,minutes:e.minutes,seconds:e.seconds,milliseconds:e.milliseconds}).as("milliseconds"),l=vn(o);let[c,u]=ko(l,n,t.zone);return s!==0&&(c+=s,u=t.zone.offset(c)),{ts:c,o:u}}function ut(t,e,n,a,r,o){const{setZone:s,zone:l}=n;if(t&&Object.keys(t).length!==0||e){const c=e||l,u=F.fromObject(t,{...n,zone:c,specificOffset:o});return s?u:u.setZone(l)}else return F.invalid(new Ae("unparsable",`the input "${r}" can't be parsed as ${a}`))}function Xt(t,e,n=!0){return t.isValid?ce.create(j.create("en-US"),{allowZ:n,forceSimple:!0}).formatDateTimeFromString(t,e):null}function Rn(t,e){const n=t.c.year>9999||t.c.year<0;let a="";return n&&t.c.year>=0&&(a+="+"),a+=Q(t.c.year,n?6:4),e?(a+="-",a+=Q(t.c.month),a+="-",a+=Q(t.c.day)):(a+=Q(t.c.month),a+=Q(t.c.day)),a}function ir(t,e,n,a,r,o){let s=Q(t.c.hour);return e?(s+=":",s+=Q(t.c.minute),(t.c.millisecond!==0||t.c.second!==0||!n)&&(s+=":")):s+=Q(t.c.minute),(t.c.millisecond!==0||t.c.second!==0||!n)&&(s+=Q(t.c.second),(t.c.millisecond!==0||!a)&&(s+=".",s+=Q(t.c.millisecond,3))),r&&(t.isOffsetFixed&&t.offset===0&&!o?s+="Z":t.o<0?(s+="-",s+=Q(Math.trunc(-t.o/60)),s+=":",s+=Q(Math.trunc(-t.o%60))):(s+="+",s+=Q(Math.trunc(t.o/60)),s+=":",s+=Q(Math.trunc(t.o%60)))),o&&(s+="["+t.zone.ianaName+"]"),s}const To={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},rl={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},ol={ordinal:1,hour:0,minute:0,second:0,millisecond:0},Ao=["year","month","day","hour","minute","second","millisecond"],il=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],sl=["year","ordinal","hour","minute","second","millisecond"];function ll(t){const e={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[t.toLowerCase()];if(!e)throw new kr(t);return e}function sr(t){switch(t.toLowerCase()){case"localweekday":case"localweekdays":return"localWeekday";case"localweeknumber":case"localweeknumbers":return"localWeekNumber";case"localweekyear":case"localweekyears":return"localWeekYear";default:return ll(t)}}function cl(t){if(Ct===void 0&&(Ct=Y.now()),t.type!=="iana")return t.offset(Ct);const e=t.name;let n=oa.get(e);return n===void 0&&(n=t.offset(Ct),oa.set(e,n)),n}function lr(t,e){const n=Ze(e.zone,Y.defaultZone);if(!n.isValid)return F.invalid(At(n));const a=j.fromObject(e);let r,o;if(H(t.year))r=Y.now();else{for(const c of Ao)H(t[c])&&(t[c]=To[c]);const s=Xr(t)||Qr(t);if(s)return F.invalid(s);const l=cl(n);[r,o]=an(t,l,n)}return new F({ts:r,zone:n,loc:a,o})}function cr(t,e,n){const a=H(n.round)?!0:n.round,r=(s,l)=>(s=ya(s,a||n.calendary?0:2,!0),e.loc.clone(n).relFormatter(n).format(s,l)),o=s=>n.calendary?e.hasSame(t,s)?0:e.startOf(s).diff(t.startOf(s),s).get(s):e.diff(t,s).get(s);if(n.unit)return r(o(n.unit),n.unit);for(const s of n.units){const l=o(s);if(Math.abs(l)>=1)return r(l,s)}return r(t>e?-0:0,n.units[n.units.length-1])}function ur(t){let e={},n;return t.length>0&&typeof t[t.length-1]=="object"?(e=t[t.length-1],n=Array.from(t).slice(0,t.length-1)):n=Array.from(t),[e,n]}let Ct;const oa=new Map;class F{constructor(e){const n=e.zone||Y.defaultZone;let a=e.invalid||(Number.isNaN(e.ts)?new Ae("invalid input"):null)||(n.isValid?null:At(n));this.ts=H(e.ts)?Y.now():e.ts;let r=null,o=null;if(!a)if(e.old&&e.old.ts===this.ts&&e.old.zone.equals(n))[r,o]=[e.old.c,e.old.o];else{const l=Ke(e.o)&&!e.old?e.o:n.offset(this.ts);r=Yt(this.ts,l),a=Number.isNaN(r.year)?new Ae("invalid input"):null,r=a?null:r,o=a?null:l}this._zone=n,this.loc=e.loc||j.create(),this.invalid=a,this.weekData=null,this.localWeekData=null,this.c=r,this.o=o,this.isLuxonDateTime=!0}static now(){return new F({})}static local(){const[e,n]=ur(arguments),[a,r,o,s,l,c,u]=n;return lr({year:a,month:r,day:o,hour:s,minute:l,second:c,millisecond:u},e)}static utc(){const[e,n]=ur(arguments),[a,r,o,s,l,c,u]=n;return e.zone=de.utcInstance,lr({year:a,month:r,day:o,hour:s,minute:l,second:c,millisecond:u},e)}static fromJSDate(e,n={}){const a=Ui(e)?e.valueOf():NaN;if(Number.isNaN(a))return F.invalid("invalid input");const r=Ze(n.zone,Y.defaultZone);return r.isValid?new F({ts:a,zone:r,loc:j.fromObject(n)}):F.invalid(At(r))}static fromMillis(e,n={}){if(Ke(e))return e<-rr||e>rr?F.invalid("Timestamp out of range"):new F({ts:e,zone:Ze(n.zone,Y.defaultZone),loc:j.fromObject(n)});throw new le(`fromMillis requires a numerical input, but received a ${typeof e} with value ${e}`)}static fromSeconds(e,n={}){if(Ke(e))return new F({ts:e*1e3,zone:Ze(n.zone,Y.defaultZone),loc:j.fromObject(n)});throw new le("fromSeconds requires a numerical input")}static fromObject(e,n={}){e=e||{};const a=Ze(n.zone,Y.defaultZone);if(!a.isValid)return F.invalid(At(a));const r=j.fromObject(n),o=mn(e,sr),{minDaysInFirstWeek:s,startOfWeek:l}=Ja(o,r),c=Y.now(),u=H(n.specificOffset)?a.offset(c):n.specificOffset,d=!H(o.ordinal),m=!H(o.year),p=!H(o.month)||!H(o.day),h=m||p,v=o.weekYear||o.weekNumber;if((h||d)&&v)throw new ht("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(p&&d)throw new ht("Can't mix ordinal dates with month/day");const b=v||o.weekday&&!h;let w,M,y=Yt(c,u);b?(w=il,M=rl,y=un(y,s,l)):d?(w=sl,M=ol,y=Pn(y)):(w=Ao,M=To);let _=!1;for(const D of w){const x=o[D];H(x)?_?o[D]=M[D]:o[D]=y[D]:_=!0}const S=b?$i(o,s,l):d?Oi(o):Xr(o),E=S||Qr(o);if(E)return F.invalid(E);const k=b?Va(o,s,l):d?ja(o):o,[A,T]=an(k,u,a),N=new F({ts:A,zone:a,o:T,loc:r});return o.weekday&&h&&e.weekday!==N.weekday?F.invalid("mismatched weekday",`you can't specify both a weekday of ${o.weekday} and a date of ${N.toISO()}`):N.isValid?N:F.invalid(N.invalid)}static fromISO(e,n={}){const[a,r]=As(e);return ut(a,r,n,"ISO 8601",e)}static fromRFC2822(e,n={}){const[a,r]=Cs(e);return ut(a,r,n,"RFC 2822",e)}static fromHTTP(e,n={}){const[a,r]=Is(e);return ut(a,r,n,"HTTP",n)}static fromFormat(e,n,a={}){if(H(e)||H(n))throw new le("fromFormat requires an input string and a format");const{locale:r=null,numberingSystem:o=null}=a,s=j.fromOpts({locale:r,numberingSystem:o,defaultToEN:!0}),[l,c,u,d]=al(s,e,n);return d?F.invalid(d):ut(l,c,a,`format ${n}`,e,u)}static fromString(e,n,a={}){return F.fromFormat(e,n,a)}static fromSQL(e,n={}){const[a,r]=Os(e);return ut(a,r,n,"SQL",e)}static invalid(e,n=null){if(!e)throw new le("need to specify a reason the DateTime is invalid");const a=e instanceof Ae?e:new Ae(e,n);if(Y.throwOnInvalid)throw new ui(a);return new F({invalid:a})}static isDateTime(e){return e&&e.isLuxonDateTime||!1}static parseFormatForOpts(e,n={}){const a=_o(e,j.fromObject(n));return a?a.map(r=>r?r.val:null).join(""):null}static expandFormat(e,n={}){return bo(ce.parseFormat(e),j.fromObject(n)).map(r=>r.val).join("")}static resetCache(){Ct=void 0,oa.clear()}get(e){return this[e]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?$n(this).weekYear:NaN}get weekNumber(){return this.isValid?$n(this).weekNumber:NaN}get weekday(){return this.isValid?$n(this).weekday:NaN}get isWeekend(){return this.isValid&&this.loc.getWeekendDays().includes(this.weekday)}get localWeekday(){return this.isValid?On(this).weekday:NaN}get localWeekNumber(){return this.isValid?On(this).weekNumber:NaN}get localWeekYear(){return this.isValid?On(this).weekYear:NaN}get ordinal(){return this.isValid?Pn(this.c).ordinal:NaN}get monthShort(){return this.isValid?qt.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?qt.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?qt.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?qt.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset}getPossibleOffsets(){if(!this.isValid||this.isOffsetFixed)return[this];const e=864e5,n=6e4,a=vn(this.c),r=this.zone.offset(a-e),o=this.zone.offset(a+e),s=this.zone.offset(a-r*n),l=this.zone.offset(a-o*n);if(s===l)return[this];const c=a-s*n,u=a-l*n,d=Yt(c,s),m=Yt(u,l);return d.hour===m.hour&&d.minute===m.minute&&d.second===m.second&&d.millisecond===m.millisecond?[et(this,{ts:c}),et(this,{ts:u})]:[this]}get isInLeapYear(){return Ht(this.year)}get daysInMonth(){return dn(this.year,this.month)}get daysInYear(){return this.isValid?gt(this.year):NaN}get weeksInWeekYear(){return this.isValid?Ot(this.weekYear):NaN}get weeksInLocalWeekYear(){return this.isValid?Ot(this.localWeekYear,this.loc.getMinDaysInFirstWeek(),this.loc.getStartOfWeek()):NaN}resolvedLocaleOptions(e={}){const{locale:n,numberingSystem:a,calendar:r}=ce.create(this.loc.clone(e),e).resolvedOptions(this);return{locale:n,numberingSystem:a,outputCalendar:r}}toUTC(e=0,n={}){return this.setZone(de.instance(e),n)}toLocal(){return this.setZone(Y.defaultZone)}setZone(e,{keepLocalTime:n=!1,keepCalendarTime:a=!1}={}){if(e=Ze(e,Y.defaultZone),e.equals(this.zone))return this;if(e.isValid){let r=this.ts;if(n||a){const o=e.offset(this.ts),s=this.toObject();[r]=an(s,o,e)}return et(this,{ts:r,zone:e})}else return F.invalid(At(e))}reconfigure({locale:e,numberingSystem:n,outputCalendar:a}={}){const r=this.loc.clone({locale:e,numberingSystem:n,outputCalendar:a});return et(this,{loc:r})}setLocale(e){return this.reconfigure({locale:e})}set(e){if(!this.isValid)return this;const n=mn(e,sr),{minDaysInFirstWeek:a,startOfWeek:r}=Ja(n,this.loc),o=!H(n.weekYear)||!H(n.weekNumber)||!H(n.weekday),s=!H(n.ordinal),l=!H(n.year),c=!H(n.month)||!H(n.day),u=l||c,d=n.weekYear||n.weekNumber;if((u||s)&&d)throw new ht("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(c&&s)throw new ht("Can't mix ordinal dates with month/day");let m;o?m=Va({...un(this.c,a,r),...n},a,r):H(n.ordinal)?(m={...this.toObject(),...n},H(n.day)&&(m.day=Math.min(dn(m.year,m.month),m.day))):m=ja({...Pn(this.c),...n});const[p,h]=an(m,this.o,this.zone);return et(this,{ts:p,o:h})}plus(e){if(!this.isValid)return this;const n=G.fromDurationLike(e);return et(this,or(this,n))}minus(e){if(!this.isValid)return this;const n=G.fromDurationLike(e).negate();return et(this,or(this,n))}startOf(e,{useLocaleWeeks:n=!1}={}){if(!this.isValid)return this;const a={},r=G.normalizeUnit(e);switch(r){case"years":a.month=1;case"quarters":case"months":a.day=1;case"weeks":case"days":a.hour=0;case"hours":a.minute=0;case"minutes":a.second=0;case"seconds":a.millisecond=0;break}if(r==="weeks")if(n){const o=this.loc.getStartOfWeek(),{weekday:s}=this;s<o&&(a.weekNumber=this.weekNumber-1),a.weekday=o}else a.weekday=1;if(r==="quarters"){const o=Math.ceil(this.month/3);a.month=(o-1)*3+1}return this.set(a)}endOf(e,n){return this.isValid?this.plus({[e]:1}).startOf(e,n).minus(1):this}toFormat(e,n={}){return this.isValid?ce.create(this.loc.redefaultToEN(n)).formatDateTimeFromString(this,e):xn}toLocaleString(e=cn,n={}){return this.isValid?ce.create(this.loc.clone(n),e).formatDateTime(this):xn}toLocaleParts(e={}){return this.isValid?ce.create(this.loc.clone(e),e).formatDateTimeParts(this):[]}toISO({format:e="extended",suppressSeconds:n=!1,suppressMilliseconds:a=!1,includeOffset:r=!0,extendedZone:o=!1}={}){if(!this.isValid)return null;const s=e==="extended";let l=Rn(this,s);return l+="T",l+=ir(this,s,n,a,r,o),l}toISODate({format:e="extended"}={}){return this.isValid?Rn(this,e==="extended"):null}toISOWeekDate(){return Xt(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:e=!1,suppressSeconds:n=!1,includeOffset:a=!0,includePrefix:r=!1,extendedZone:o=!1,format:s="extended"}={}){return this.isValid?(r?"T":"")+ir(this,s==="extended",n,e,a,o):null}toRFC2822(){return Xt(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return Xt(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?Rn(this,!0):null}toSQLTime({includeOffset:e=!0,includeZone:n=!1,includeOffsetSpace:a=!0}={}){let r="HH:mm:ss.SSS";return(n||e)&&(a&&(r+=" "),n?r+="z":e&&(r+="ZZ")),Xt(this,r,!0)}toSQL(e={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(e)}`:null}toString(){return this.isValid?this.toISO():xn}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`DateTime { ts: ${this.toISO()}, zone: ${this.zone.name}, locale: ${this.locale} }`:`DateTime { Invalid, reason: ${this.invalidReason} }`}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(e={}){if(!this.isValid)return{};const n={...this.c};return e.includeConfig&&(n.outputCalendar=this.outputCalendar,n.numberingSystem=this.loc.numberingSystem,n.locale=this.loc.locale),n}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(e,n="milliseconds",a={}){if(!this.isValid||!e.isValid)return G.invalid("created by diffing an invalid DateTime");const r={locale:this.locale,numberingSystem:this.numberingSystem,...a},o=Wi(n).map(G.normalizeUnit),s=e.valueOf()>this.valueOf(),l=s?this:e,c=s?e:this,u=Gs(l,c,o,r);return s?u.negate():u}diffNow(e="milliseconds",n={}){return this.diff(F.now(),e,n)}until(e){return this.isValid?K.fromDateTimes(this,e):this}hasSame(e,n,a){if(!this.isValid)return!1;const r=e.valueOf(),o=this.setZone(e.zone,{keepLocalTime:!0});return o.startOf(n,a)<=r&&r<=o.endOf(n,a)}equals(e){return this.isValid&&e.isValid&&this.valueOf()===e.valueOf()&&this.zone.equals(e.zone)&&this.loc.equals(e.loc)}toRelative(e={}){if(!this.isValid)return null;const n=e.base||F.fromObject({},{zone:this.zone}),a=e.padding?this<n?-e.padding:e.padding:0;let r=["years","months","days","hours","minutes","seconds"],o=e.unit;return Array.isArray(e.unit)&&(r=e.unit,o=void 0),cr(n,this.plus(a),{...e,numeric:"always",units:r,unit:o})}toRelativeCalendar(e={}){return this.isValid?cr(e.base||F.fromObject({},{zone:this.zone}),this,{...e,numeric:"auto",units:["years","months","days"],calendary:!0}):null}static min(...e){if(!e.every(F.isDateTime))throw new le("min requires all arguments be DateTimes");return qa(e,n=>n.valueOf(),Math.min)}static max(...e){if(!e.every(F.isDateTime))throw new le("max requires all arguments be DateTimes");return qa(e,n=>n.valueOf(),Math.max)}static fromFormatExplain(e,n,a={}){const{locale:r=null,numberingSystem:o=null}=a,s=j.fromOpts({locale:r,numberingSystem:o,defaultToEN:!0});return Eo(s,e,n)}static fromStringExplain(e,n,a={}){return F.fromFormatExplain(e,n,a)}static buildFormatParser(e,n={}){const{locale:a=null,numberingSystem:r=null}=n,o=j.fromOpts({locale:a,numberingSystem:r,defaultToEN:!0});return new So(o,e)}static fromFormatParser(e,n,a={}){if(H(e)||H(n))throw new le("fromFormatParser requires an input string and a format parser");const{locale:r=null,numberingSystem:o=null}=a,s=j.fromOpts({locale:r,numberingSystem:o,defaultToEN:!0});if(!s.equals(n.locale))throw new le(`fromFormatParser called with a locale of ${s}, but the format parser was created for ${n.locale}`);const{result:l,zone:c,specificOffset:u,invalidReason:d}=n.explainFromTokens(e);return d?F.invalid(d):ut(l,c,a,`format ${n.format}`,e,u)}static get DATE_SHORT(){return cn}static get DATE_MED(){return Tr}static get DATE_MED_WITH_WEEKDAY(){return hi}static get DATE_FULL(){return Ar}static get DATE_HUGE(){return Cr}static get TIME_SIMPLE(){return Ir}static get TIME_WITH_SECONDS(){return Nr}static get TIME_WITH_SHORT_OFFSET(){return Dr}static get TIME_WITH_LONG_OFFSET(){return Pr}static get TIME_24_SIMPLE(){return Fr}static get TIME_24_WITH_SECONDS(){return xr}static get TIME_24_WITH_SHORT_OFFSET(){return $r}static get TIME_24_WITH_LONG_OFFSET(){return Or}static get DATETIME_SHORT(){return Rr}static get DATETIME_SHORT_WITH_SECONDS(){return Ur}static get DATETIME_MED(){return Wr}static get DATETIME_MED_WITH_SECONDS(){return Hr}static get DATETIME_MED_WITH_WEEKDAY(){return fi}static get DATETIME_FULL(){return Br}static get DATETIME_FULL_WITH_SECONDS(){return zr}static get DATETIME_HUGE(){return Gr}static get DATETIME_HUGE_WITH_SECONDS(){return Zr}}function kt(t){if(F.isDateTime(t))return t;if(t&&t.valueOf&&Ke(t.valueOf()))return F.fromJSDate(t);if(t&&typeof t=="object")return F.fromObject(t);throw new le(`Unknown datetime argument: ${t}, of type ${typeof t}`)}const ft=65,me=73,ve=79;function Co(t,e){if(e=typeof e=="number"?e:5,!Array.isArray(t))throw new TypeError("forward did not receive an array");if(typeof t[0]=="string"||typeof t[1]=="string")throw new TypeError("forward received an array of strings, but it only accepts an array of numbers.");const[n,a]=t;if(n<-180||n>180)throw new TypeError("forward received an invalid longitude of "+n);if(a<-90||a>90)throw new TypeError("forward received an invalid latitude of "+a);if(a<-80||a>84)throw new TypeError(`forward received a latitude of ${a}, but this library does not support conversions of points in polar regions below 80°S and above 84°N`);return function(r,o){const s="00000"+r.easting,l="00000"+r.northing;return r.zoneNumber+r.zoneLetter+function(c,u,d){const m=No(d),p=Math.floor(c/1e5),h=Math.floor(u/1e5)%20;return function(v,b,w){const M=w-1,y="AJSAJS".charCodeAt(M),_="AFAFAF".charCodeAt(M);let S=y+v-1,E=_+b,k=!1;return S>90&&(S=S-90+ft-1,k=!0),(S===me||y<me&&S>me||(S>me||y<me)&&k)&&S++,(S===ve||y<ve&&S>ve||(S>ve||y<ve)&&k)&&(S++,S===me&&S++),S>90&&(S=S-90+ft-1),E>86?(E=E-86+ft-1,k=!0):k=!1,(E===me||_<me&&E>me||(E>me||_<me)&&k)&&E++,(E===ve||_<ve&&E>ve||(E>ve||_<ve)&&k)&&(E++,E===me&&E++),E>86&&(E=E-86+ft-1),String.fromCharCode(S)+String.fromCharCode(E)}(p,h,m)}(r.easting,r.northing,r.zoneNumber)+s.substr(s.length-5,o)+l.substr(l.length-5,o)}(function(r){const o=r.lat,s=r.lon,l=6378137,c=Un(o),u=Un(s);let d;d=Math.floor((s+180)/6)+1,s===180&&(d=60),o>=56&&o<64&&s>=3&&s<12&&(d=32),o>=72&&o<84&&(s>=0&&s<9?d=31:s>=9&&s<21?d=33:s>=21&&s<33?d=35:s>=33&&s<42&&(d=37));const m=Un(6*(d-1)-180+3),p=l/Math.sqrt(1-.00669438*Math.sin(c)*Math.sin(c)),h=Math.tan(c)*Math.tan(c),v=.006739496752268451*Math.cos(c)*Math.cos(c),b=Math.cos(c)*(u-m),w=l*(.9983242984503243*c-.002514607064228144*Math.sin(2*c)+2639046602129982e-21*Math.sin(4*c)-3418046101696858e-24*Math.sin(6*c)),M=.9996*p*(b+(1-h+v)*b*b*b/6+(5-18*h+h*h+72*v-.39089081163157013)*b*b*b*b*b/120)+5e5;let y=.9996*(w+p*Math.tan(c)*(b*b/2+(5-h+9*v+4*v*v)*b*b*b*b/24+(61-58*h+h*h+600*v-2.2240339282485886)*b*b*b*b*b*b/720));return o<0&&(y+=1e7),{northing:Math.trunc(y),easting:Math.trunc(M),zoneNumber:d,zoneLetter:Io(o)}}({lat:a,lon:n}),e)}function ul(t){const e=ba(Do(t.toUpperCase()));return typeof e.lat=="number"&&typeof e.lon=="number"?[e.lon,e.lat,e.lon,e.lat]:[e.left,e.bottom,e.right,e.top]}function Ma(t){if(t==="")throw new TypeError("toPoint received a blank string");const e=ba(Do(t.toUpperCase()));return typeof e.lat=="number"&&typeof e.lon=="number"?[e.lon,e.lat]:[(e.left+e.right)/2,(e.top+e.bottom)/2]}function Un(t){return t*(Math.PI/180)}function dr(t){return t/Math.PI*180}function ba(t){const e=t.northing,n=t.easting,{zoneLetter:a,zoneNumber:r}=t;if(r<0||r>60)return null;const o=6378137,s=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),l=n-5e5;let c=e;a<"N"&&(c-=1e7);const u=6*(r-1)-180+3,d=c/.9996/6367449145945056e-9,m=d+(3*s/2-27*s*s*s/32)*Math.sin(2*d)+(21*s*s/16-55*s*s*s*s/32)*Math.sin(4*d)+151*s*s*s/96*Math.sin(6*d),p=o/Math.sqrt(1-.00669438*Math.sin(m)*Math.sin(m)),h=Math.tan(m)*Math.tan(m),v=.006739496752268451*Math.cos(m)*Math.cos(m),b=.99330562*o/Math.pow(1-.00669438*Math.sin(m)*Math.sin(m),1.5),w=l/(.9996*p);let M=m-p*Math.tan(m)/b*(w*w/2-(5+3*h+10*v-4*v*v-.06065547077041606)*w*w*w*w/24+(61+90*h+298*v+45*h*h-1.6983531815716497-3*v*v)*w*w*w*w*w*w/720);M=dr(M);let y,_=(w-(1+2*h+v)*w*w*w/6+(5-2*v+28*h-3*v*v+.05391597401814761+24*h*h)*w*w*w*w*w/120)/Math.cos(m);if(_=u+dr(_),typeof t.accuracy=="number"){const S=ba({northing:t.northing+t.accuracy,easting:t.easting+t.accuracy,zoneLetter:t.zoneLetter,zoneNumber:t.zoneNumber});y={top:S.lat,right:S.lon,bottom:M,left:_}}else y={lat:M,lon:_};return y}function Io(t){return t<=84&&t>=72?"X":t<72&&t>=-80?"CDEFGHJKLMNPQRSTUVWX"[Math.floor((t- -80)/8)]:t>84||t<-80?"Z":void 0}function No(t){let e=t%6;return e===0&&(e=6),e}function Do(t){if(t&&t.length===0)throw new TypeError("MGRSPoint coverting from nothing");t=t.replace(/ /g,"");const{length:e}=t;let n,a=null,r="",o=0;for(;!/[A-Z]/.test(n=t.charAt(o));){if(o>=2)throw new Error("MGRSPoint bad conversion from: "+t);r+=n,o++}const s=parseInt(r,10);if(o===0||o+3>e)throw new Error("MGRSPoint bad conversion from "+t);const l=t.charAt(o++);if(l<="A"||l==="B"||l==="Y"||l>="Z"||l==="I"||l==="O")throw new Error(`MGRSPoint zone letter ${l} not handled: ${t}`);a=t.substring(o,o+=2);const c=No(s),u=function(y,_){let S="AJSAJS".charCodeAt(_-1),E=1e5,k=!1;for(;S!==y.charCodeAt(0);){if(S++,S===me&&S++,S===ve&&S++,S>90){if(k)throw new Error("Bad character: "+y);S=ft,k=!0}E+=1e5}return E}(a.charAt(0),c);let d=function(y,_){if(y>"V")throw new TypeError("MGRSPoint given invalid Northing "+y);let S="AFAFAF".charCodeAt(_-1),E=0,k=!1;for(;S!==y.charCodeAt(0);){if(S++,S===me&&S++,S===ve&&S++,S>86){if(k)throw new Error("Bad character: "+y);S=ft,k=!0}E+=1e5}return E}(a.charAt(1),c);for(;d<dl(l);)d+=2e6;const m=e-o;if(m%2!=0)throw new Error(`MGRSPoint has to have an even number
of digits after the zone letter and two 100km letters - front
half for easting meters, second half for
northing meters `+t);const p=m/2;let h,v,b,w=0,M=0;return p>0&&(h=1e5/Math.pow(10,p),v=t.substring(o,o+p),w=parseFloat(v)*h,b=t.substring(o+p),M=parseFloat(b)*h),{easting:w+u,northing:M+d,zoneLetter:l,zoneNumber:s,accuracy:h}}function dl(t){let e;switch(t){case"C":e=11e5;break;case"D":e=2e6;break;case"E":e=28e5;break;case"F":e=37e5;break;case"G":e=46e5;break;case"H":e=55e5;break;case"J":e=64e5;break;case"K":e=73e5;break;case"L":e=82e5;break;case"M":e=91e5;break;case"N":e=0;break;case"P":e=8e5;break;case"Q":e=17e5;break;case"R":e=26e5;break;case"S":e=35e5;break;case"T":e=44e5;break;case"U":e=53e5;break;case"V":e=62e5;break;case"W":e=7e6;break;case"X":e=79e5;break;default:e=-1}if(e>=0)return e;throw new TypeError("Invalid zone letter: "+t)}const ml=Object.freeze(Object.defineProperty({__proto__:null,forward:Co,getLetterDesignator:Io,inverse:ul,toPoint:Ma},Symbol.toStringTag,{value:"Module"})),hl="/upper_winds_open_meteo/icon-48.png",fl="/upper_winds_open_meteo/schere_purple.png",gl="/upper_winds_open_meteo/airplane_orange.png",pl="/upper_winds_open_meteo/livePlane.png",mr={135:5,130:5,125:5,120:5,115:5,110:5,105:5,100:6,95:7,90:7,85:7,80:8,75:8,70:9,65:10,60:10,55:11,50:12,45:14,40:15,35:17,30:20,25:24,20:30,15:40,10:60,5:119},yl={TERMINAL_VELOCITY_VERTICAL_MPS:50,GRAVITY_ACCELERATION:9.81,HORIZONTAL_DRAG_TAU_SECONDS:5},xe=200,Wn={OPEN:4.1,PARTIALLY:12.8,COLLAPSED:39.2},wl=150,dt={MIN_TRACK_LENGTH_M:100,MAX_TRACK_LENGTH_M:1e4,MIN_APPROACH_LENGTH_M:100,MAX_APPROACH_LENGTH_M:2e4,APPROACH_TIME_SECONDS:120},Po={LIST:["icon_seamless","icon_global","icon_eu","icon_d2","ecmwf_ifs025","ecmwf_aifs025_single","gfs_seamless","gfs_global","gfs_hrrr","arome_france","gem_hrdps_continental","gem_regional"],API_MAP:{icon_seamless:"dwd_icon",icon_global:"dwd_icon",icon_eu:"dwd_icon_eu",icon_d2:"dwd_icon_d2",ecmwf_ifs025:"ecmwf_ifs025",ecmwf_aifs025_single:"ecmwf_aifs025_single",gfs_seamless:"ncep_gfs013",gfs_global:"ncep_gfs025",gfs_hrrr:"ncep_hrrr_conus",arome_france:"meteofrance_arome_france0025",gem_hrdps_continental:"cmc_gem_hrdps",gem_regional:"cmc_gem_rdps"}},Rt={FORECAST:"https://api.open-meteo.com/v1/forecast",HISTORICAL:"https://historical-forecast-api.open-meteo.com/v1/forecast"},re={METERS_TO_FEET:3.28084,FEET_TO_METERS:.3048,KNOTS_TO_MPS:.514444,KNOTS_TO_KMH:1.852,CELSIUS_TO_KELVIN:273.15},hr={MOLAR_MASS_AIR:.0289644,UNIVERSAL_GAS_CONSTANT:8.31446261815324},mt={LAPSE_RATE:.0065,SEA_LEVEL_TEMP_KELVIN:288.15,GRAVITY:9.80665,GAS_CONSTANT_AIR:287.05},Qt={A_LIQUID:17.27,B_LIQUID:237.7,A_ICE:21.87,B_ICE:265.5},vl=6371e3,fr={KNOT_THRESHOLDS:[1,4,7,11,17,22,28,34,41,48,56,64],BEAUFORT_THRESHOLDS:[0,1,3,6,10,16,21,27,33,40,47,55,63]},Ll=[1e3,950,925,900,850,800,700,600,500,400,300,250,200],Te={DEFAULT_MAP_CENTER:[47.9808,11.234],DEFAULT_MAP_ZOOM:11,GEOLOCATION_TIMEOUT_MS:2e4,GEOLOCATION_ACCURACY_THRESHOLD_M:500,MIN_ZOOM:11,MAX_ZOOM:15,LANDING_PATTERN_MIN_ZOOM:14},en={MIN_TIME_DIFF_FOR_SPEED_CALC_S:.5,SPEED_SMOOTHING_LOW:.5,SPEED_SMOOTHING_HIGH:.2,SPEED_SMOOTHING_TRESHOLD:25},bn={TILE_MAX_AGE_DAYS:7,FETCH_TIMEOUT_MS:15e3,SIZE_LIMIT_MB_WARNING:500},Ve={SCENARIO_COLORS:{MIN_WIND:"rgba(0, 0, 255, 0.7)",MEAN_WIND:"rgba(0, 255, 0, 0.7)",MAX_WIND:"rgba(255, 0, 0, 0.7)"},HEATMAP_MIN_RADIUS_PX:5,HEATMAP_MAX_RADIUS_PX:50,HEATMAP_SCALING_BASE:1.42,HEATMAP_REFERENCE_ZOOM:13},Sn={DEFAULT_MARKER:hl,CUTAWAY_MARKER:fl,AIRPLANE_MARKER:gl,LIVEPLANE_MARKER:pl},Ml="DZMasterTest",bl="DataTest";let gr=!1;const Ie=()=>{const t=document.getElementById("interpStep");return t?t.value:"200"};function Sl(t){gr=t,console.log(`App context set to: ${gr?"Mobile":"Web"}`)}const g={FEATURE_PASSWORD_PLANNER:Ml,FEATURE_PASSWORD_DATA:bl,defaultSettings:{model:"icon_global",refLevel:"AGL",heightUnit:"m",temperatureUnit:"C",windUnit:"kt",timeZone:"Z",coordFormat:"Decimal",downloadFormat:"HEIDIS",showTable:!1,canopySpeed:20,descentRate:3.5,showLandingPattern:!1,landingDirection:"LL",customLandingDirectionLL:"",customLandingDirectionRR:"",legHeightDownwind:300,legHeightBase:200,legHeightFinal:100,interpStep:"200",lowerLimit:0,upperLimit:3e3,baseMaps:"Esri Street",calculateJump:!0,openingAltitude:1200,exitAltitude:3e3,showJumpRunTrack:!1,showExitArea:!1,showCanopyArea:!1,showCutAwayFinder:!1,jumpRunTrackOffset:0,jumpRunTrackForwardOffset:0,aircraftSpeedKt:90,jumperSeparation:5,numberOfJumpers:5,cutAwayAltitude:1e3,cutAwayState:"Partially",terrainWarningLayer:null,terrainAnalysisCache:null,terrainClearance:100,trackPosition:!1,showJumpMasterLine:!1,jumpMasterLineTarget:"DIP",harpLat:null,harpLng:null,cacheRadiusKm:10,cacheZoomLevels:[11,12,13,14],autoupdate:!1,selectedEnsembleModels:[],currentEnsembleScenario:"all_models",isInteractionLocked:!1},state:{userSettings:null,unlockedFeatures:{planner:!1,plannerHash:null,data:!1,dataHash:null}},initialize(){const t=this.FEATURE_PASSWORD_PLANNER.split("").reduce((s,l)=>l.charCodeAt(0)+((s<<5)-s),0),e=this.FEATURE_PASSWORD_DATA.split("").reduce((s,l)=>l.charCodeAt(0)+((s<<5)-s),0);let n={planner:!1,plannerHash:null,data:!1,dataHash:null};try{const s=localStorage.getItem("unlockedFeatures");s&&(n={...n,...JSON.parse(s)})}catch(s){this.handleError(s,"Failed to load unlocked features.")}const a=n.planner&&n.plannerHash===t,r=n.data&&n.dataHash===e;this.state.unlockedFeatures={planner:a,plannerHash:a?t:null,data:r,dataHash:r?e:null},this.saveUnlockedFeatures();let o={};try{const s=localStorage.getItem("upperWindsSettings");s&&(o=JSON.parse(s))}catch(s){this.handleError(s,"Failed to load settings.")}this.state.userSettings={...this.defaultSettings,...o},this.state.userSettings.isInteractionLocked=!1,this.state.userSettings.harpLat=null,this.state.userSettings.harpLng=null,this.state.userSettings.jumpRunTrackOffset=0,this.state.userSettings.jumpRunTrackForwardOffset=0,this.state.userSettings.showCutAwayFinder=!1},save(){const t={...this.state.userSettings};delete t.customJumpRunDirection;try{localStorage.setItem("upperWindsSettings",JSON.stringify(t))}catch(e){console.error("Failed to save settings to localStorage:",e)}},isFeatureUnlocked(t){return!0},showPasswordModal(t,e,n){const a=document.getElementById("passwordModal"),r=document.getElementById("passwordInput"),o=document.getElementById("passwordError"),s=document.getElementById("passwordSubmit"),l=document.getElementById("passwordCancel"),c=document.getElementById("modalHeader"),u=document.getElementById("modalMessage");if(!a||!r||!s||!l||!c||!u)return;const d=t==="planner"?this.FEATURE_PASSWORD_PLANNER:this.FEATURE_PASSWORD_DATA,m=t.charAt(0).toUpperCase()+t.slice(1);c.textContent=`${m} Access`,u.textContent=`Please enter the password to enable the ${m.toLowerCase()} functionality:`,r.value="",o.style.display="none",a.style.display="flex";const p=()=>{r.value===d?(a.style.display="none",this.saveUnlockStatus(t,!0),document.dispatchEvent(new CustomEvent("ui:lockStateChanged")),e()):(o.textContent="Incorrect password",o.style.display="block")};s.onclick=p,r.onkeypress=h=>{h.key==="Enter"&&p()},l.onclick=()=>{a.style.display="none",n()}},saveUnlockStatus(t,e){if(t==="planner"){const n=this.FEATURE_PASSWORD_PLANNER.split("").reduce((a,r)=>r.charCodeAt(0)+((a<<5)-a),0);this.state.unlockedFeatures.planner=e,this.state.unlockedFeatures.plannerHash=e?n:null}else if(t==="data"){const n=this.FEATURE_PASSWORD_DATA.split("").reduce((a,r)=>r.charCodeAt(0)+((a<<5)-a),0);this.state.unlockedFeatures.data=e,this.state.unlockedFeatures.dataHash=e?n:null}this.saveUnlockedFeatures()},saveUnlockedFeatures(t=this.state.unlockedFeatures){try{const e=JSON.stringify(t);localStorage.setItem("unlockedFeatures",e)}catch(e){this.handleError(e,"Failed to save unlocked features to localStorage.")}},getValue(t,e,n){if(n===void 0&&typeof e!="string"&&(n=e,e=null),this.state.userSettings&&typeof this.state.userSettings[t]<"u")return this.state.userSettings[t];const a=document.querySelector(`input[name="${t}"]:checked`);if(a)return a.value;const r=document.getElementById(t);if(r&&r.tagName==="SELECT")return r.value;const o=document.getElementById(t);return o&&o.type==="checkbox"?o.checked:n},handleError(t,e="An error occurred."){console.error("Settings Error:",t)}};let Hn=console.error,Bn=console.log;const U=class U{static setErrorHandler(e){Hn=e}static setMessageHandler(e){Bn=e}static handleError(e,n=!0){n&&console.error(e),typeof Hn=="function"&&Hn(e)}static handleMessage(e){typeof Bn=="function"?Bn(e):console.log(e)}static convertHeight(e,n){const a=parseFloat(e);return isNaN(a)?"N/A":n==="ft"?parseFloat((e*re.METERS_TO_FEET).toFixed(0)):e}static convertFeetToMeters(e){return e==null||isNaN(e)?0:e/3.28084}static convertTemperature(e,n){const a=parseFloat(e);return isNaN(a)?"N/A":n==="°F"?a*9/5+32:a}static convertWind(e,n,a="km/h"){if(e==null||isNaN(e))return"N/A";let r;switch(a){case"km/h":r=e;break;case"m/s":r=e*3.6;break;case"kt":r=e*re.KNOTS_TO_KMH;break;case"mph":r=e*1.60934;break;case"bft":r=U.beaufortToKnots(e)*re.KNOTS_TO_KMH;break;default:r=e;break}switch(n){case"km/h":return r;case"m/s":return r/3.6;case"kt":return r/re.KNOTS_TO_KMH;case"mph":return r/1.60934;case"bft":return U.knotsToBeaufort(r/re.KNOTS_TO_KMH);default:return r/re.KNOTS_TO_KMH}}static knotsToBeaufort(e){const n=fr.KNOT_THRESHOLDS.findIndex(a=>e<a);return n===-1?12:n}static beaufortToKnots(e){return fr.BEAUFORT_THRESHOLDS[e]||63}static normalizeAngle(e){return(e%360+360)%360}static calculateDewpoint(e,n){const a=Qt.A_LIQUID,r=Qt.B_LIQUID,o=Qt.A_ICE,s=Qt.B_ICE;let l,c;return e>=0?(l=a*e/(r+e)+Math.log(n/100),c=r*l/(a-l)):(l=o*e/(s+e)+Math.log(n/100),c=s*l/(o-l)),isNaN(c)?null:c}static calculateQFE(e,n,a,r=15){if(!e||n==="N/A"||a==="N/A"||isNaN(e)||isNaN(n)||isNaN(a))return"N/A";const o=mt.GRAVITY,s=hr.MOLAR_MASS_AIR,l=hr.UNIVERSAL_GAS_CONSTANT,c=r+re.CELSIUS_TO_KELVIN,u=mt.LAPSE_RATE,d=e*100,m=n-a,p=o*s/(l*u),h=d*Math.pow(1-u*m/c,p),v=Math.round(h/100);return isNaN(v)?"N/A":v}static linearInterpolate(e,n,a){if(!(e!=null&&e.length)||!(n!=null&&n.length)||e.length!==n.length)return"invalid input for linearInterpolate";let r=!1;e[1]>e[0]&&(n=[...n].reverse(),e=[...e].reverse(),r=!0);const o=e.length-1;try{if(a>e[0]||a<e[o]){let s,l;return a>e[0]?(s=(n[1]-n[0])/(e[1]-e[0]),l=n[1]-s*e[1]):(s=(n[o]-n[o-1])/(e[o]-e[o-1]),l=n[o]-s*e[o]),s*a+l}else{let s;for(s=1;s<=o&&!(a>=e[s]);s++);const l=(n[s]-n[s-1])/(e[s]-e[s-1]),c=n[s]-l*e[s];return l*a+c}}catch{return"interpolation error"}finally{r&&(n.reverse(),e.reverse())}}static linearInterpolateAngle(e,n,a){if(!(e!=null&&e.length)||!(n!=null&&n.length)||e.length!==n.length)return NaN;let r=!1;e[0]<e[e.length-1]&&(e=[...e].reverse(),n=[...n].reverse(),r=!0);const o=e.length;let s=0;for(;s<o&&e[s]>a;)s++;s===0?s=1:s===o&&(s=o-1);const l=e[s-1],c=e[s];let u=n[s-1],m=n[s]-u;if(m>180&&(m-=360),m<-180&&(m+=360),c-l===0)return u;const p=(a-l)/(c-l);let h=u+p*m;return h=(h+360)%360,r&&(e.reverse(),n.reverse()),h}static linearInterpolateAngle(e,n,a){if(!(e!=null&&e.length)||!(n!=null&&n.length)||e.length!==n.length||e.length<2)return NaN;const r=e.length,o=e[0]<e[r-1];let s=1;if(o)for(;s<r&&a>e[s];)s++;else for(;s<r&&a<e[s];)s++;o?(a>=e[r-1]&&(s=r-1),a<e[0]&&(s=1)):(a<=e[r-1]&&(s=r-1),a>e[0]&&(s=1));const l=e[s-1],c=e[s],u=n[s-1],d=n[s];if(c===l)return u;let m=d-u;m>180?m-=360:m<-180&&(m+=360);const p=(a-l)/(c-l);return(u+p*m+360)%360}static gaussianInterpolation(e,n,a,r,o){if(a===o)return e;if(r===o)return n;let s=1/Math.abs(a-o),l=1/Math.abs(r-o);return(s*e+l*n)/(s+l)}static interpolateWindAtAltitude(e,n,a,r,o){if(n.length!=a.length||n.length!=r.length||n.length!=o.length)return{u:"Invalid input",v:"Invalid input"};const s=n.map(m=>Math.log(m)),l=U.linearInterpolate(a,s,e);if(typeof l=="string"&&l.includes("error"))return{u:"Interpolation error",v:"Interpolation error"};const c=Math.exp(l),u=U.linearInterpolate(s,r,Math.log(c)),d=U.linearInterpolate(s,o,Math.log(c));return typeof u=="string"&&u.includes("error")||typeof d=="string"&&d.includes("error")?{u:"Interpolation error",v:"Interpolation error"}:{u,v:d}}static interpolatePressure(e,n,a){if(!n||!a||n.length!==a.length||n.length<2||e<a[0]||e>a[a.length-1])return"N/A";for(let r=0;r<a.length-1;r++)if(e>=a[r]&&e<=a[r+1]){const o=a[r],s=a[r+1],l=n[r],c=n[r+1];return l+(c-l)*(e-o)/(s-o)}return"N/A"}static windSpeed(e,n){return Math.sqrt(e*e+n*n)}static windDirection(e,n){return(Math.atan2(-e,-n)*180/Math.PI+360)%360}static calculateMeanWind(e,n,a,r,o){try{if(!e||!n||!a||e.length<2||r>=o)throw new Error("Invalid input data or limits for calculateMeanWind");const s=new Array(4);let l=[o],c=[Number(U.linearInterpolate(e,n,o))],u=[Number(U.linearInterpolate(e,a,o))];const d=Number(U.linearInterpolate(e,n,r)),m=Number(U.linearInterpolate(e,a,r));for(let y=0;y<e.length;y++)e[y]<o&&e[y]>r&&(l.push(e[y]),c.push(n[y]),u.push(a[y]));l.push(r),c.push(d),u.push(m);const p=l.map((y,_)=>_);p.sort((y,_)=>l[_]-l[y]),l=p.map(y=>l[y]),c=p.map(y=>c[y]),u=p.map(y=>u[y]);let h=0,v=0;for(let y=0;y<l.length-1;y++)h+=.5*(c[y]+c[y+1])*(l[y]-l[y+1]),v+=.5*(u[y]+u[y+1])*(l[y]-l[y+1]);const b=l[0]-l[l.length-1];if(b===0)return s[2]=d,s[3]=m,s[1]=U.windSpeed(d,m),s[0]=U.windDirection(d,m),s;const w=h/b,M=v/b;return s[2]=w,s[3]=M,s[1]=U.windSpeed(w,M),s[0]=U.windDirection(w,M),s}catch(s){return console.error("Error in calculateMeanWind:",s,{heights:e,xComponents:n,yComponents:a,lowerLimit:r,upperLimit:o}),U.handleError("Failed to calculate mean wind: "+s.message),null}}static translateWmoCodeToTaf(e){const n={0:"NSW",1:"NSW",2:"NSW",3:"NSW",45:"FG",48:"FZFG",51:"-DZ",53:"DZ",55:"+DZ",56:"-FZDZ",57:"FZDZ",61:"-RA",63:"RA",65:"+RA",66:"-FZRA",67:"FZRA",71:"-SN",73:"SN",75:"+SN",77:"SG",80:"-SHRA",81:"SHRA",82:"+SHRA",83:"-SHRASN",85:"-SHSN",86:"SHSN",95:"TS",96:"TSGR",99:"+TSGR"},a=parseInt(e,10);return isNaN(a)?"N/A":n[a]||"N/A"}static getCloudLayersForMetar(e,n){if(!e||e.length===0)return"N/A";const a=[];let r=null;const o=l=>l<=5?null:l<=25?"FEW":l<=50?"SCT":l<=87?"BKN":"OVC",s={FEW:1,SCT:2,BKN:3,OVC:4};for(const l of e){const c=o(l.cc);if(!c||a.length>=3)continue;(!r||s[c]>s[r])&&(a.push({baseHeight:l.displayHeight,coverCode:c}),r=c)}return a.length===0?"SKC":a.map(l=>{const c=l.baseHeight;let u;return n==="ft"?(u=Math.round(c/100)*100,`${l.coverCode} ${u}ft`):(u=Math.round(c/50)*50,`${l.coverCode} ${u}m`)}).join(", ")}static formatVisibility(e){const n=parseFloat(e);return isNaN(n)?"N/A":n>=1e4?">10000":n>=5e3?(Math.round(n/1e3)*1e3).toString():(Math.round(n/100)*100).toString()}static formatWindDirection(e){const n=parseFloat(e);if(isNaN(n))return"N/A";let a=Math.round(n/10)*10;return(a===0||a>=360)&&(a=360),a.toString().padStart(3,"0")}static calculateTAS(e,n){if(isNaN(e)||isNaN(n)||e<0||n<0)return console.warn("Invalid inputs for calculateTAS:",{ias:e,heightFt:n}),"N/A";const a=mt.LAPSE_RATE,r=mt.SEA_LEVEL_TEMP_KELVIN,o=mt.GRAVITY,s=mt.GAS_CONSTANT_AIR,l=re.FEET_TO_METERS,c=n*l,u=r-a*c,d=u/r,m=1-a*c/r,p=o/(a*s)-1,h=Math.pow(m,p),v=e/Math.sqrt(h);return console.log("calculateTAS debug:",{ias:e,heightFt:n,heightM:c,tempAtAltitude:u,tempRatio:d,base:m,exponent:p,densityRatio:h,tas:v,tasRounded:Number(v.toFixed(2))}),Number(v.toFixed(2))}static calculateTASFromGroundSpeed(e,n,a,r,o){if(isNaN(e)||isNaN(n)||isNaN(a)||isNaN(r))return"N/A";const s=U.convertWind(e,"kt","m/s"),l=U.convertWind(n,"kt","m/s"),c=U.calculateWindAngle(r,a),{crosswind:u,headwind:d}=U.calculateWindComponents(l,c),m=s+d,p=U.calculateTAS(m,o);return Number(p.toFixed(1))}static calculateFlightParameters(e,n,a,r){const o=U.calculateWindAngle(e,n),{crosswind:s,headwind:l}=U.calculateWindComponents(a,o),c=U.calculateWCA(s,r),u=r>Math.abs(s)?Math.sqrt(Math.pow(r,2)-Math.pow(s,2))-l:-l;return{crosswind:Number(s.toFixed(2)),headwind:Number(l.toFixed(2)),wca:Number(c.toFixed(2)),groundSpeed:Number(u.toFixed(2))}}static calculateWindAngle(e,n){let a=U.normalizeAngle(n-e);return a>180&&(a-=360),a}static calculateWindComponents(e,n){const a=n*(Math.PI/180),r=e*Math.sin(a),o=e*Math.cos(a);return{crosswind:r,headwind:o}}static calculateWCA(e,n){const r=Math.abs(Math.asin(e/n))*(180/Math.PI);return isNaN(r)?0:r}static calculateCourseFromHeading(e,n,a,r){const o=U.calculateWindAngle(e,n),{crosswind:s,headwind:l}=U.calculateWindComponents(a,o),c=r*Math.sin(e*Math.PI/180),u=r*Math.cos(e*Math.PI/180),d=(n+180)%360,m=a*Math.sin(d*Math.PI/180),p=a*Math.cos(d*Math.PI/180),h=c+m,v=u+p,b=Math.atan2(h,v)*(180/Math.PI),w=U.normalizeAngle(b),M=Math.sqrt(h*h+v*v),y=U.calculateWCA(s,r)*(s<0?-1:1);return{trueCourse:Number(w.toFixed(2)),groundSpeed:Number(M.toFixed(2)),wca:Number(y.toFixed(2)),crosswind:Number(s.toFixed(2)),headwind:Number(l.toFixed(2))}}static validateLegHeights(e,n,a){const r=parseInt(e.value)||100,o=parseInt(n.value)||200,s=parseInt(a.value)||300;return o<=r?(U.handleError("Base leg must start higher than final leg."),!1):s<=o?(U.handleError("Downwind leg must start higher than base leg."),!1):!0}static convertCoords(e,n,a="Decimal"){if(e===null||n===null||e===void 0||n===void 0)return{lat:"N/A",lng:"N/A"};switch(a){case"DDM":return{lat:U.decimalToDecimalMinutes(e,!0),lng:U.decimalToDecimalMinutes(n,!1)};case"DMS":return{lat:U.decimalToDms(e,!0),lng:U.decimalToDms(n,!1)};case"MGRS":const r=U.decimalToMgrs(e,n);return{lat:r,lng:r};case"Decimal":default:return{lat:e.toFixed(6),lng:n.toFixed(6)}}}static decimalToDecimalMinutes(e,n){if(isNaN(e)||e===null||e===void 0)throw new Error("Invalid coordinate for DDM conversion");const a=Math.abs(e),r=Math.floor(a),o=(a-r)*60,s=n?e>=0?"N":"S":e>=0?"E":"W";return{deg:r,min:o,dir:s}}static decimalToDms(e,n){if(isNaN(e)||e===null||e===void 0)throw console.warn("Invalid decimal value for DMS conversion:",e),new Error("Invalid coordinate for DMS conversion");const a=Math.abs(e),r=Math.floor(a),o=Math.floor((a-r)*60),s=(a-r)*3600-o*60,l=n?e>=0?"N":"S":e>=0?"E":"W";if(isNaN(r)||isNaN(o)||isNaN(s))throw console.warn("DMS calculation resulted in invalid values:",{deg:r,min:o,sec:s}),new Error("Failed to convert to DMS");return{deg:r,min:o,sec:s,dir:l}}static dmsToDecimal(e,n,a,r){if(isNaN(e)||isNaN(n)||isNaN(a)||!r)throw console.warn("Invalid DMS inputs:",{deg:e,min:n,sec:a,dir:r}),new Error("Invalid DMS values");let o=e+n/60+a/3600;if((r==="S"||r==="W")&&(o=-o),isNaN(o))throw console.warn("DMS to decimal conversion failed:",{deg:e,min:n,sec:a,dir:r}),new Error("Failed to convert DMS to decimal");return o}static decimalToMgrs(e,n){try{return Co([n,e])}catch(a){return console.error("Error converting to MGRS:",a),"Invalid MGRS"}}static mgrsToDecimal(e){try{const[n,a]=Ma(e);return{lat:a,lng:n}}catch(n){return console.error("Error converting MGRS to decimal:",n),null}}static calculateNewCenter(e,n,a,r){const o=vl,s=e*Math.PI/180,l=n*Math.PI/180,c=r*Math.PI/180,u=a/o,d=Math.asin(Math.sin(s)*Math.cos(u)+Math.cos(s)*Math.sin(u)*Math.cos(c)),m=l+Math.atan2(Math.sin(c)*Math.sin(u)*Math.cos(s),Math.cos(u)-Math.sin(s)*Math.sin(d)),p=d*180/Math.PI,v=(m*180/Math.PI+540)%360-180;return[p,v]}static calculateBearing(e,n,a,r){const o=m=>m*Math.PI/180,s=m=>m*180/Math.PI,l=o(r-n),c=Math.sin(l)*Math.cos(o(a)),u=Math.cos(o(e))*Math.sin(o(a))-Math.sin(o(e))*Math.cos(o(a))*Math.cos(l);let d=s(Math.atan2(c,u));return d=(d+360)%360,d}static async getLocationData(e,n){const a=`${e.toFixed(4)},${n.toFixed(4)}`;if(U.locationCache.has(a))return U.locationCache.get(a);try{const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${n}&timezone=auto`);if(!r.ok)throw r.status===429&&console.warn("API rate limit hit while fetching location data."),new Error(`Open-Meteo fetch failed: ${r.status}`);const o=await r.json(),s={timezone:o.timezone||"GMT",timezone_abbreviation:o.timezone_abbreviation||"GMT",elevation:o.elevation!==void 0?o.elevation:"N/A"};return U.locationCache.set(a,s),s}catch(r){return console.error("Error fetching location data:",r.message),{timezone:"UTC",elevation:"N/A"}}}static isValidLatLng(e,n){return typeof e=="number"&&typeof n=="number"&&!isNaN(e)&&!isNaN(n)&&e>=-90&&e<=90&&n>=-180&&n<=180&&!(e===0&&n===0)}static async getAltitude(e,n){const{elevation:a}=await U.getLocationData(e,n);return a!=="N/A"?a:"N/A"}static async getMultipleAltitudes(e){if(!e||e.length===0)return[];const n=e.map(r=>r.lat.toFixed(4)).join(","),a=e.map(r=>r.lng.toFixed(4)).join(",");try{const r=await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${n}&longitude=${a}`);if(!r.ok)throw new Error(`Elevation API Error: ${r.status}`);return(await r.json()).elevation||[]}catch(r){return console.error("Error fetching multiple altitudes:",r),e.map(()=>"N/A")}}static formatTime(e){return F.fromISO(e,{zone:"UTC"}).toFormat("yyyy-MM-dd HHmm")+"Z"}static async formatLocalTime(e,n,a){const{timezone:r,timezone_abbreviation:o}=await U.getLocationData(n,a);return F.fromISO(e,{zone:"UTC"}).setZone(r).toFormat("yyyy-MM-dd HHmm")+` ${o}`}static getLastFullHourUTC(){const e=new Date,n=e.getUTCFullYear(),a=e.getUTCMonth(),r=e.getUTCDate(),o=e.getUTCHours(),s=new Date(Date.UTC(n,a,r,o,0,0));return console.log("Last full hour UTC:",s.toISOString()),s}static async getDisplayTime(e,n,a,r="Z"){return r.toLowerCase()==="loc"&&n&&a?await U.formatLocalTime(e,n,a):U.formatTime(e)}static roundToTens(e){const n=Math.round(e/10)*10;return(n===0||n===360)&&(e>=355||e<=4)?360:n}static debounce(e,n){let a;return function(...r){clearTimeout(a),a=setTimeout(()=>e.apply(this,r),n)}}static interpolateColor(e,n=0,a=3e3){const r=Math.min(Math.max((e-n)/(a-n),0),1);return e<0||isNaN(e)?"#808080":r<=.5?`rgb(255, ${Math.round(255*(r*2))}, 0)`:`rgb(${Math.round(255*(1-(r-.5)*2))}, 255, 0)`}static generateWindBarb(e,n,a=null){const r=Math.round(n),o=40,s=40,l=o/2,c=s/2,u=20,m=(typeof a=="number"&&!isNaN(a)?a>=0:!0)?-1:1;let p=Math.floor(r/50),h=r%50,v=Math.floor(h/10),b=Math.floor(h%10/5);r<5?(v=0,b=0):r<10&&b>0&&(b=1);let w=`<svg width="${o}" height="${s}" viewBox="0 0 ${o} ${s}">`;const M=e+180;w+=`<g transform="translate(${l}, ${c}) rotate(${M})">`,w+=`<line x1="0" y1="${u/2}" x2="0" y2="${-u/2}" stroke="black" stroke-width="1"/>`;let y=u/2;const _=4;for(let S=0;S<p;S++)w+=`<polygon points="0,${y-5} 0,${y+5} ${10*m},${y}" fill="black"/>`,y-=_+5;for(let S=0;S<v;S++)w+=`<line x1="0" y1="${y}" x2="${10*m}" y2="${y}" stroke="black" stroke-width="1"/>`,y-=_;return b>0&&(w+=`<line x1="0" y1="${y}" x2="${5*m}" y2="${y}" stroke="black" stroke-width="1"/>`),r<5&&(w+='<circle cx="0" cy="0" r="3" fill="none" stroke="black" stroke-width="1"/>'),w+="</g></svg>",w}static calculateDynamicRadius(e=Ve.HEATMAP_SCALING_BASE,n=Ve.HEATMAP_REFERENCE_ZOOM){const a=i.map.getZoom(),r=Ve.HEATMAP_SCALING_BASE,o=Math.pow(r,a-n),s=e*o,l=Ve.HEATMAP_MIN_RADIUS_PX,c=Ve.HEATMAP_MAX_RADIUS_PX,u=Math.max(l,Math.min(c,s));return console.log("[calculateDynamicRadius] Calculated dynamic radius:",{currentZoom:a,baseRadius:e,scaleFactor:o,dynamicRadius:s,adjustedRadius:u}),u}static getTooltipContent(e,n,a,r){if(!i.map)return console.warn("Map not initialized for getTooltipContent"),"Map not initialized";const o=g.getValue("coordFormat","Decimal"),s=g.getValue("windUnit","kt"),l=g.getValue("heightUnit","m"),c=U.convertCoords(e.lat,e.lng,o);let u=o==="MGRS"?`MGRS: ${c.lat}`:`Lat: ${c.lat}<br>Lng: ${c.lng}`;const d=e.ele;let m=d!==null&&r!==null?d-r:null;if(m!==null){const v=l||"m";m=U.convertHeight(m,v),m=Math.round(m),u+=`<br>Altitude: ${m} ${v} AGL`}else u+="<br>Altitude: N/A";let p="N/A",h="N/A";if(n>0&&e.time&&a[n-1].time&&e.ele!==null&&a[n-1].ele!==null){const v=(e.time.toMillis()-a[n-1].time.toMillis())/1e3;if(v>0){const w=i.map.distance([a[n-1].lat,a[n-1].lng],[e.lat,e.lng])/v;p=U.convertWind(w,s,"m/s"),p=s==="bft"?Math.round(p):p.toFixed(1),h=((e.ele-a[n-1].ele)/v).toFixed(1)}}return u+=`<br>Speed: ${p} ${s}`,u+=`<br>Descent Rate: ${h} m/s`,u}static getConvexHull(e){e.sort((o,s)=>o[0]-s[0]||o[1]-s[1]);const n=(o,s,l)=>(s[0]-o[0])*(l[1]-o[1])-(s[1]-o[1])*(l[0]-o[0]),a=[];for(const o of e){for(;a.length>=2&&n(a[a.length-2],a[a.length-1],o)<=0;)a.pop();a.push(o)}const r=[];for(let o=e.length-1;o>=0;o--){const s=e[o];for(;r.length>=2&&n(r[r.length-2],r[r.length-1],s)<=0;)r.pop();r.push(s)}return a.slice(0,-1).concat(r.slice(0,-1))}};Cn(U,"locationCache",new Map),Cn(U,"debouncedGetElevationAndQFE",U.debounce(async(e,n,a)=>{`${e.toFixed(5)}${n.toFixed(5)}`;try{const r=await U.getAltitude(e,n);a&&a({elevation:r})}catch(r){console.warn("Failed to fetch elevation in debouncedGetElevationAndQFE:",r),a&&a({elevation:"N/A"})}},500));let f=U;const El="modulepreload",_l=function(t){return"/upper_winds_open_meteo/"+t},pr={},kl=function(e,n,a){let r=Promise.resolve();if(n&&n.length>0){let s=function(u){return Promise.all(u.map(d=>Promise.resolve(d).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),c=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));r=s(n.map(u=>{if(u=_l(u),u in pr)return;pr[u]=!0;const d=u.endsWith(".css"),m=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${m}`))return;const p=document.createElement("link");if(p.rel=d?"stylesheet":El,d||(p.as="script"),p.crossOrigin="",p.href=u,c&&p.setAttribute("nonce",c),document.head.appendChild(p),d)return new Promise((h,v)=>{p.addEventListener("load",h),p.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${u}`)))})}))}function o(s){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=s,window.dispatchEvent(l),!l.defaultPrevented)throw s}return r.then(s=>{for(const l of s||[])l.status==="rejected"&&o(l.reason);return e().catch(o)})};function Fo(t){var a,r;if(!t||!t.time||t.time.length===0)return[];const e=[],n=[1e3,950,925,900,850,800,700,600,500,400,300,250,200];for(let o=0;o<t.time.length;o++){const s=t.temperature_2m[o];let l={low:[],mid:[],high:[]};for(const u of n){const d=(a=t[`temperature_${u}hPa`])==null?void 0:a[o],m=(r=t[`geopotential_height_${u}hPa`])==null?void 0:r[o];d===null||m===null||d===void 0||m===void 0||(s<=0?m<=2e3?l.low.push(u):d>-30?l.mid.push(u):l.high.push(u):d>0?l.low.push(u):d>-30?l.mid.push(u):l.high.push(u))}const c=(u,d,m)=>u.length===0?95:Math.max(...u.map(h=>{var v;return((v=t[`cloud_cover_${h}hPa`])==null?void 0:v[o])||0}))>50?d:m;e.push({low:c(l.low,90,75),mid:c(l.mid,85,70),high:65})}return console.log("[WeatherManager] Cloud layer thresholds analyzed for all timesteps."),e}async function nt(t,e,n=null){console.log("[weatherManager] Starting full weather fetch for location:",{lat:t,lng:e});const a=await Al(t,e);return document.dispatchEvent(new CustomEvent("models:available",{detail:{availableModels:a}})),await Tl(t,e,n)}function be(t,e,n,a,r){if(!t||!t.time||e>=t.time.length)return console.warn("No weather data provided or index out of bounds for interpolation"),[];const o=i.cloudThresholds[e];if(!o&&(console.warn("No pre-analyzed cloud thresholds for this index. Performing on-the-fly analysis."),i.cloudThresholds=Fo(t),!i.cloudThresholds[e]))return console.error("Cloud threshold analysis failed. Cannot interpolate weather data."),[];const s=Ll,l=s.filter(C=>{var W,z,$;const I=(W=t[`geopotential_height_${C}hPa`])==null?void 0:W[e],O=(z=t[`wind_speed_${C}hPa`])==null?void 0:z[e],R=($=t[`wind_direction_${C}hPa`])==null?void 0:$[e];return[I,O,R].every(Z=>Z!=null)}),c=s.filter(C=>{var R,W;const I=(R=t[`geopotential_height_${C}hPa`])==null?void 0:R[e],O=(W=t[`cloud_cover_${C}hPa`])==null?void 0:W[e];return I!=null&&O!=null}),u=c.map(C=>t[`geopotential_height_${C}hPa`][e]),d=c.map(C=>t[`cloud_cover_${C}hPa`][e]);if(l.length<2)return console.warn("Insufficient valid pressure level data for interpolation:",l),[];let m=l.map(C=>t[`geopotential_height_${C}hPa`][e]),p=l.map(C=>t[`temperature_${C}hPa`][e]),h=l.map(C=>t[`relative_humidity_${C}hPa`][e]);l.map(C=>{var I;return(I=t[`cloud_cover_${C}hPa`])==null?void 0:I[e]});let v=l.map(C=>t[`wind_speed_${C}hPa`][e]),b=l.map(C=>t[`wind_direction_${C}hPa`][e]);const w=t.surface_pressure[e];if(w==null)return console.warn("Surface pressure missing"),[];let M=v.map((C,I)=>-C*Math.sin(b[I]*Math.PI/180)),y=v.map((C,I)=>-C*Math.cos(b[I]*Math.PI/180));const _=Math.max(...l),S=t[`geopotential_height_${_}hPa`][e];if(w>_&&Number.isFinite(S)){const C=Math.floor((S-a)/n),I=-t.wind_speed_10m[e]*Math.sin(t.wind_direction_10m[e]*Math.PI/180),O=-t.wind_speed_10m[e]*Math.cos(t.wind_direction_10m[e]*Math.PI/180),R=M[l.indexOf(_)],W=y[l.indexOf(_)];for(let z=C-1;z>=1;z--){const $=a+z*n;if($>=S)continue;const Z=($-a)/(S-a),B=Math.log(w),J=Math.log(_),X=B+Z*(J-B),ue=Math.exp(X),q=Math.log($-a+1),oe=Math.log(1),ee=Math.log(S-a),ie=f.linearInterpolate([oe,ee],[I,R],q),ye=f.linearInterpolate([oe,ee],[O,W],q),De=f.windSpeed(ie,ye),Re=f.windDirection(ie,ye);m.unshift($),l.unshift(ue),p.unshift(f.linearInterpolate([a,S],[t.temperature_2m[e],t[`temperature_${_}hPa`][e]],$)),h.unshift(f.linearInterpolate([a,S],[t.relative_humidity_2m[e],t[`relative_humidity_${_}hPa`][e]],$)),v.unshift(De),b.unshift(Re),M.unshift(ie),y.unshift(ye)}m.unshift(a),l.unshift(w),p.unshift(t.temperature_2m[e]),h.unshift(t.relative_humidity_2m[e]),v.unshift(t.wind_speed_10m[e]),b.unshift(t.wind_direction_10m[e]),M.unshift(I),y.unshift(O)}const E=l.indexOf(Math.min(...l)),k=m[E],A=k-a;if(A<=0||isNaN(A))return console.warn("Invalid max height at lowest pressure level:",{maxHeightASL:k,baseHeight:a,minPressure:l[E]}),[];const T=r==="ft"?A*3.28084:A,N=Math.floor(T/n),D=Array.from({length:N+1},(C,I)=>I*n),x=[];return D.forEach(C=>{var z;const I=r==="ft"?C/3.28084:C,O=a+I;let R,W=0;if(u.length>0){let $=0,Z=1/0;u.forEach((B,J)=>{const X=Math.abs(O-B);X<Z&&(Z=X,$=J)}),W=d[$]}if(I===0){const $=Math.max(...l),Z=((z=t[`cloud_cover_${$}hPa`])==null?void 0:z[e])??"N/A";R={height:O,pressure:w,temp:t.temperature_2m[e],rh:t.relative_humidity_2m[e],cc:Z,spd:t.wind_speed_10m[e],dir:t.wind_direction_10m[e],dew:f.calculateDewpoint(t.temperature_2m[e],t.relative_humidity_2m[e])}}else{const $=f.interpolatePressure(O,l,m),Z=f.interpolateWindAtAltitude(O,l,m,M,y),B=f.windSpeed(Z.u,Z.v),J=f.windDirection(Z.u,Z.v),X=f.linearInterpolate(m,p,O),ue=f.linearInterpolate(m,h,O),q=f.calculateDewpoint(X,ue);R={height:O,pressure:Number.isFinite($)?Number($.toFixed(1)):"N/A",temp:Number.isFinite(X)?Number(X.toFixed(1)):"N/A",rh:Number.isFinite(ue)?Number(ue.toFixed(0)):"N/A",cc:Number.isFinite(W)?Number(W.toFixed(0)):"N/A",spd:Number.isFinite(B)?Number(B.toFixed(1)):"N/A",dir:Number.isFinite(J)?Number(J.toFixed(0)):"N/A",dew:Number.isFinite(q)?Number(q.toFixed(1)):"N/A"}}if(Number.isFinite(R.temp)&&Number.isFinite(R.rh)){const $=R.temp,Z=R.rh;let B;t.temperature_2m[e]<=0?I<=2e3?B=o.low:$>-30?B=o.mid:B=o.high:$>0?B=o.low:$>-30?B=o.mid:B=o.high,Z<B&&(R.cc=0)}R.displayHeight=C,x.push(R)}),console.log(`[DEBUG] interpolateWeatherData finished. baseHeight: ${a}, Returning ${x.length} data points. First point:`,x[0]),x}async function Tl(t,e,n=null){var a,r;document.dispatchEvent(new CustomEvent("loading:start",{detail:{message:"Fetching Weather..."}}));try{const o=((a=document.getElementById("modelSelect"))==null?void 0:a.value)||g.defaultSettings.model;if(!o)throw new Error("No weather model selected.");const l=Po.API_MAP[o]||o;let c=!1,u,d;const m=F.utc().startOf("day");let p=null;if(n){let y=F.fromISO(n,{zone:"utc"});y.isValid&&(p=y.startOf("day"),p<m&&(c=!0))}else{const y=(r=document.getElementById("historicalDatePicker"))==null?void 0:r.value;if(y){let _=F.fromISO(y,{zone:"utc"}).startOf("day");_<m&&(c=!0,p=_)}}let h=Rt.FORECAST;if(c&&p)h=Rt.HISTORICAL,u=d=p.toFormat("yyyy-MM-dd"),i.lastModelRun="N/A (Historical Data)";else{let y;try{const E=`https://api.open-meteo.com/data/${l}/static/meta.json`,A=await(await fetch(E)).json();y=new Date(A.last_run_initialisation_time*1e3),i.lastModelRun=y.toISOString().replace("T"," ").substring(0,16)+"Z"}catch{y=F.utc().toJSDate(),i.lastModelRun="N/A"}let _=F.fromJSDate(y).setZone("utc").plus({hours:6});_>F.utc()&&(_=F.utc()),u=_.toFormat("yyyy-MM-dd");const S=o.includes("_d2")?2:7;d=_.plus({days:S}).toFormat("yyyy-MM-dd")}const b=`${h}?latitude=${t}&longitude=${e}&hourly=surface_pressure,temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m,wind_gusts_10m,visibility,weather_code,cloud_cover_low,cloud_cover_mid,cloud_cover_high,temperature_1000hPa,relative_humidity_1000hPa,wind_speed_1000hPa,wind_direction_1000hPa,geopotential_height_1000hPa,cloud_cover_1000hPa,temperature_950hPa,relative_humidity_950hPa,wind_speed_950hPa,wind_direction_950hPa,geopotential_height_950hPa,cloud_cover_950hPa,temperature_925hPa,relative_humidity_925hPa,wind_speed_925hPa,wind_direction_925hPa,geopotential_height_925hPa,cloud_cover_925hPa,temperature_900hPa,relative_humidity_900hPa,wind_speed_900hPa,wind_direction_900hPa,geopotential_height_900hPa,cloud_cover_900hPa,temperature_850hPa,relative_humidity_850hPa,wind_speed_850hPa,wind_direction_850hPa,geopotential_height_850hPa,cloud_cover_850hPa,temperature_800hPa,relative_humidity_800hPa,wind_speed_800hPa,wind_direction_800hPa,geopotential_height_800hPa,cloud_cover_800hPa,temperature_700hPa,relative_humidity_700hPa,wind_speed_700hPa,wind_direction_700hPa,geopotential_height_700hPa,cloud_cover_700hPa,temperature_600hPa,relative_humidity_600hPa,wind_speed_600hPa,wind_direction_600hPa,geopotential_height_600hPa,cloud_cover_600hPa,temperature_500hPa,relative_humidity_500hPa,wind_speed_500hPa,wind_direction_500hPa,geopotential_height_500hPa,cloud_cover_500hPa,temperature_400hPa,relative_humidity_400hPa,wind_speed_400hPa,wind_direction_400hPa,geopotential_height_400hPa,cloud_cover_400hPa,temperature_300hPa,relative_humidity_300hPa,wind_speed_300hPa,wind_direction_300hPa,geopotential_height_300hPa,cloud_cover_300hPa,temperature_250hPa,relative_humidity_250hPa,wind_speed_250hPa,wind_direction_250hPa,geopotential_height_250hPa,cloud_cover_250hPa,temperature_200hPa,relative_humidity_200hPa,wind_speed_200hPa,wind_direction_200hPa,geopotential_height_200hPa,cloud_cover_200hPa&models=${o}&start_date=${u}&end_date=${d}`,w=await fetch(b);if(!w.ok)throw w.status===429?new Error("API-Limit reached. Please wait a moment and retry again."):new Error(`HTTP error! Status: ${w.status}`);const M=await w.json();if(!M.hourly||!M.hourly.time||!M.hourly.time.length)throw new Error("No hourly data in API response.");return M.hourly}catch(o){return console.error("[fetchWeather] Error:",o),f.handleError(`Failed to fetch weather: ${o.message}`),null}finally{document.dispatchEvent(new CustomEvent("loading:stop"))}}async function Al(t,e){const n=Po.LIST;let a=[];for(const r of n)try{const o=await fetch(`${Rt.FORECAST}?latitude=${t}&longitude=${e}&hourly=temperature_2m&models=${r}`);if(o.ok){const s=await o.json();s.hourly&&s.hourly.temperature_2m&&s.hourly.temperature_2m.some(l=>l!==null)&&a.push(r)}else o.status===429?console.warn(`API-Limit beim Prüfen von Modell '${r}' erreicht.`):console.warn(`Modell '${r}' ist nicht verfügbar (Server-Antwort: ${o.status})`)}catch(o){console.error(`Netzwerkfehler beim Abruf von Modell '${r}':`,o)}return a}f.debounce(async(t,e)=>{try{const n=await f.getElevationAndQFE(t,e,i.apiKey);if(n){const a=document.getElementById("elevation"),r=document.getElementById("qfe");a&&(a.value=n.elevation.toFixed(1)),r&&(r.value=n.qfe.toFixed(2)),i.currentElevation=n.elevation,g.state.userSettings.qfe=n.qfe}}catch(n){console.error("Error fetching elevation and QFE:",n)}},500);function xo(t){const e=g.state.userSettings.exitAltitude*re.METERS_TO_FEET,n=f.calculateTAS(t,e);if(n==="N/A"||!Number.isFinite(n)||n<=0)return console.warn("TAS calculation failed or invalid, using default separation"),g.defaultSettings.jumperSeparation;const a=Object.keys(mr).map(Number).sort((s,l)=>l-s);let r=a[0];for(const s of a)if(n<=s)r=s;else break;return mr[r]||7}function Sa(t,e=null){var O,R;const n=e?e.lat:i.lastLat,a=e?e.lng:i.lastLng;if(!i.weatherData||!n||!a||i.lastAltitude==="N/A"||!t||!t.length)return null;const r=parseInt((O=document.getElementById("openingAltitude"))==null?void 0:O.value)||1e3,o=Math.round(i.lastAltitude),s=t.map(W=>W.height),l=t.map(W=>-f.convertWind(W.spd,"m/s","km/h")*Math.sin(W.dir*Math.PI/180)),c=t.map(W=>-f.convertWind(W.spd,"m/s","km/h")*Math.cos(W.dir*Math.PI/180)),u=f.calculateMeanWind(s,l,c,o,o+r);if(!u)return null;let d=Math.round(u[0]);const m=parseFloat(g.state.userSettings.customJumpRunDirection);Number.isFinite(m)&&m>=0&&m<=360&&(d=m);const p=parseInt((R=document.getElementById("exitAltitude"))==null?void 0:R.value)||3e3,h=o+p,v=g.state.userSettings.aircraftSpeedKt||90,b=f.calculateTAS(v,h/.3048);let w=v*re.KNOTS_TO_MPS;if(b!=="N/A"&&Number.isFinite(b)){const W=f.linearInterpolate(s.map(oe=>oe-o),t.map(oe=>oe.dir),p),z=f.linearInterpolate(s.map(oe=>oe-o),t.map(oe=>f.convertWind(oe.spd,"m/s","km/h")),p),$=b*re.KNOTS_TO_MPS,Z=(W+180)*Math.PI/180,B=z*Math.sin(Z),J=z*Math.cos(Z),X=d*Math.PI/180,ue=$*Math.sin(X),q=$*Math.cos(X);w=Math.sqrt(Math.pow(ue+B,2)+Math.pow(q+J,2))}const M=Math.max(dt.MIN_TRACK_LENGTH_M,Math.min(dt.MAX_TRACK_LENGTH_M,Math.round((g.state.userSettings.numberOfJumpers||10)*(g.state.userSettings.jumperSeparation||5)*w))),y=Math.max(dt.MIN_APPROACH_LENGTH_M,Math.min(dt.MAX_APPROACH_LENGTH_M,Math.round(w*dt.APPROACH_TIME_SECONDS))),_=g.state.userSettings.jumpRunTrackOffset||0,S=g.state.userSettings.jumpRunTrackForwardOffset||0,E=[n,a],k=f.calculateNewCenter(E[0],E[1],M,d),A=Math.sqrt(_**2+S**2),T=Math.atan2(_,S)*180/Math.PI,N=(d+T+360)%360,D=f.calculateNewCenter(E[0],E[1],A,N),x=f.calculateNewCenter(k[0],k[1],A,N),C=f.calculateNewCenter(D[0],D[1],y,(d+180)%360),I=[D,C];return{direction:d,trackLength:M,meanWindDirection:u[0],meanWindSpeed:u[1],latlngs:[D,x],approachLatLngs:I,approachLength:y,approachTime:dt.APPROACH_TIME_SECONDS}}function $o(t){var R,W,z,$,Z;if(console.log("Debug calculateExitCircle: Start",{showExitArea:g.state.userSettings.showExitArea,calculateJump:g.state.userSettings.calculateJump,weatherData:!!i.weatherData,lastLat:i.lastLat,lastLng:i.lastLng,lastAltitude:i.lastAltitude,interpolatedData:!!t&&t.length>0}),!g.state.userSettings.showExitArea||!g.state.userSettings.calculateJump||!i.weatherData||!i.lastLat||!i.lastLng)return console.log("Debug calculateExitCircle: Frühe Rückgabe wegen Einstellungen"),null;if(!t||t.length===0)return console.log("Debug calculateExitCircle: Frühe Rückgabe wegen interpolatedData"),null;const e=parseInt((R=document.getElementById("exitAltitude"))==null?void 0:R.value)||3e3,n=parseInt((W=document.getElementById("openingAltitude"))==null?void 0:W.value)||1200,a=parseInt((z=document.getElementById("legHeightDownwind"))==null?void 0:z.value)||300,r=parseFloat(($=document.getElementById("descentRate"))==null?void 0:$.value)||3.5,o=parseFloat((Z=document.getElementById("canopySpeed"))==null?void 0:Z.value)||20,s=o*re.KNOTS_TO_MPS,l=g.state.userSettings.safetyHeight||0;console.log("Debug calculateExitCircle: Eingabewerte",{exitAltitude:e,openingAltitude:n,legHeightDownwind:a,descentRate:r,canopySpeedKt:o,safetyHeight:l});const c=l/r*s,u=t.map(B=>B.height),d=t.map(B=>-f.convertWind(B.spd,"m/s","km/h")*Math.sin(B.dir*Math.PI/180)),m=t.map(B=>-f.convertWind(B.spd,"m/s","km/h")*Math.cos(B.dir*Math.PI/180)),p=Math.round(i.lastAltitude),h=(n-xe-a)/r,v=h*s,b=(n-xe)/r,w=b*s;console.log("Debug calculateExitCircle: Berechnungen",{flyTime:h,horizontalCanopyDistance:v,flyTimeFull:b,horizontalCanopyDistanceFull:w,reductionDistance:c});const M=f.calculateMeanWind(u,d,m,p+l+a,p+n-xe),y=f.calculateMeanWind(u,d,m,p+l,p+n-xe);console.log("Debug calculateExitCircle: meanWind",M),console.log("Debug calculateExitCircle: meanWindFull",y),console.log("Debug calculateExitCircle: Vor calculateLandingPatternCoords");const _=En(i.lastLat,i.lastLng,t);console.log("Debug calculateExitCircle: Nach calculateLandingPatternCoords",_);let[S,E]=_.downwindStart;Number.isFinite(S)||(console.log("Debug calculateExitCircle: Fallback zu lastLat/lastLng"),S=i.lastLat,E=i.lastLng);const k=f.calculateNewCenter(S,E,M[1]*h,M[0]),A=f.calculateNewCenter(i.lastLat,i.lastLng,y[1]*b,y[0]);console.log("Debug calculateExitCircle: newCenterBlue",k),console.log("Debug calculateExitCircle: newCenterRed",A),console.log("Debug calculateExitCircle: Vor calculateFreeFall");const T=Sa(t),N=T?T.direction:0,D=Il(i.weatherData,e,n,t,i.lastLat,i.lastLng,p,N);if(console.log("Debug calculateExitCircle: Nach calculateFreeFall",D),!D)return console.log("Debug calculateExitCircle: Rückgabe null wegen freeFall"),null;const x=(D.directionDeg+180)%360,C=f.calculateNewCenter(A[0],A[1],D.distance,x),I=f.calculateNewCenter(k[0],k[1],D.distance,x);console.log(`[calculateExitCircle] freeFallResult: distance=${D.distance.toFixed(2)} m, directionDeg=${D.directionDeg.toFixed(1)}°`),console.log(`[calculateExitCircle] meanWind: dir=${M[0].toFixed(1)}°, speed=${M[1].toFixed(2)} m/s`),console.log(`[calculateExitCircle] greenCenterFull: lat=${C[0]}, lng=${C[1]}`),console.log(`[calculateExitCircle] greenCenter: lat=${I[0]}, lng=${I[1]}`),console.log("[calculateExitCircle] expected downwindStart: lat=52.51657818951595, lng=13.413705547188442");const O={greenLatFull:C[0],greenLngFull:C[1],greenLat:I[0],greenLng:I[1],greenRadius:Math.max(0,w-c),darkGreenRadius:Math.max(0,v-c),freeFallDirection:D.directionDeg,freeFallDistance:D.distance,freeFallTime:D.time};return console.log("Debug calculateExitCircle: Ergebnis",O),O}function Oo(t){var I,O,R,W,z;if(!g.state.userSettings.showCanopyArea||!g.state.userSettings.calculateJump||!i.weatherData||!i.lastLat||!i.lastLng||!t||t.length===0)return null;parseInt((I=document.getElementById("exitAltitude"))==null?void 0:I.value);const e=parseInt((O=document.getElementById("openingAltitude"))==null?void 0:O.value)||1200,n=parseInt((R=document.getElementById("legHeightDownwind"))==null?void 0:R.value)||300,a=parseFloat((W=document.getElementById("descentRate"))==null?void 0:W.value)||3.5,r=(parseFloat((z=document.getElementById("canopySpeed"))==null?void 0:z.value)||20)*re.KNOTS_TO_MPS,o=g.state.userSettings.safetyHeight||0,s=o/a*r,l=t.map($=>$.height),c=t.map($=>-f.convertWind($.spd,"m/s","km/h")*Math.sin($.dir*Math.PI/180)),u=t.map($=>-f.convertWind($.spd,"m/s","km/h")*Math.cos($.dir*Math.PI/180)),d=Math.round(i.lastAltitude),m=(e-xe-n)/a,p=m*r,h=(e-xe)/a,v=h*r,b=f.calculateMeanWind(l,c,u,d+n,d+o+e-xe),w=f.calculateMeanWind(l,c,u,d+o,d+e-xe),M=En(i.lastLat,i.lastLng,t);let[y,_]=M.downwindStart;Number.isFinite(y)||(y=i.lastLat,_=i.lastLng);const S=d+e-xe,E=d+n,k=[],A=[],T=[],N=[];let D=S-E<=1e3?200:500;for(let $=S;$>=E+200;$-=D){const Z=($-E)/a,B=Z*r;if(B>0){const J=f.calculateMeanWind(l,c,u,E,$);k.push(Math.max(0,B-s)),A.push(J[1]*Z),T.push(J[0]),N.push($-d)}}console.log("[calculateCanopyCircles] Debug meanWind:",b),console.log("[calculateCanopyCircles] Debug flyTime:",m),console.log("[calculateCanopyCircles] Debug meanWindFull:",w),console.log("[calculateCanopyCircles] Debug flyTimeFull:",h);const x=f.calculateNewCenter(i.lastLat,i.lastLng,w[1]*h,w[0]);console.log("[calculateCanopyCircles] Tatsächlicher Mittelpunkt roter Kreis:",{lat:x[0].toFixed(3),lng:x[1].toFixed(3)});const C=f.calculateNewCenter(y,_,b[1]*m,b[0]);return console.log("[calculateCanopyCircles] Tatsächlicher Mittelpunkt blauer Kreis:",{lat:C[0].toFixed(3),lng:C[1].toFixed(3)}),{blueLat:y,blueLng:_,redLat:i.lastLat,redLng:i.lastLng,radius:Math.max(0,p-s),radiusFull:Math.max(0,v-s),additionalBlueRadii:k,additionalBlueDisplacements:A,additionalBlueDirections:T,additionalBlueUpperLimits:N,displacement:b[1]*m,direction:b[0],displacementFull:w[1]*h,directionFull:w[0],meanWindForFullCanopyDir:w[0],meanWindForFullCanopySpeedMps:w[1]}}function En(t,e,n){var Fa,xa;if(!n||n.length===0||i.lastAltitude==="N/A")return null;const a=parseInt(document.getElementById("canopySpeed").value)||20,r=parseFloat(document.getElementById("descentRate").value)||3.5,o=parseInt(document.getElementById("legHeightFinal").value)||100,s=parseInt(document.getElementById("legHeightBase").value)||200,l=parseInt(document.getElementById("legHeightDownwind").value)||300,c=Math.round(i.lastAltitude),u=n.map(Pe=>Pe.height),d=n.map(Pe=>-f.convertWind(Pe.spd,"kt","km/h")*Math.sin(Pe.dir*Math.PI/180)),m=n.map(Pe=>-f.convertWind(Pe.spd,"kt","km/h")*Math.cos(Pe.dir*Math.PI/180)),p=((Fa=document.querySelector('input[name="landingDirection"]:checked'))==null?void 0:Fa.value)||"LL",h=document.getElementById(p==="LL"?"customLandingDirectionLL":"customLandingDirectionRR"),v=h?parseInt(h.value,10):NaN;let b=Number.isFinite(v)?v:Number.isFinite(i.landingWindDir)?i.landingWindDir:(xa=n[0])==null?void 0:xa.dir;if(!Number.isFinite(b))return null;const w=(Pe,ai,ri,oi,ii)=>{const si=oi*.5144444444444445*ii;return f.calculateNewCenter(Pe,ai,si,ri)},M=f.calculateMeanWind(u,d,m,c===0?1:c,c+o),y=M[0],_=M[1],S=b,E=f.calculateWindAngle(S,y),{crosswind:k,headwind:A}=f.calculateWindComponents(_,E),T=f.calculateWCA(k,a)*(k>=0?1:-1),{groundSpeed:N}=f.calculateFlightParameters(S,y,_,a),D=o/r,x=N*(1.852/3.6)*D,C=w(t,e,(S+180)%360,N,D),I=f.calculateMeanWind(u,d,m,c+o,c+s),O=I[0],R=I[1],W=(b+(p==="LL"?90:-90)+360)%360,{trueCourse:z,groundSpeed:$}=f.calculateCourseFromHeading(W,O,R,a),Z=f.calculateWindAngle(z,O),{crosswind:B,headwind:J}=f.calculateWindComponents(R,Z),X=f.calculateWCA(B,a)*(B>=0?1:-1);let ue=(z+180)%360;$<0&&(ue=(ue+180)%360);const q=(s-o)/r,oe=$*(1.852/3.6)*q,ee=w(C[0],C[1],ue,$,q),ie=f.calculateMeanWind(u,d,m,c+s,c+l),ye=ie[0],De=ie[1],Re=(b+180)%360,Vt=f.calculateWindAngle(Re,ye),{crosswind:jt,headwind:kn}=f.calculateWindComponents(De,Vt),Xe=f.calculateWCA(jt,a)*(jt>=0?1:-1),{groundSpeed:Tn}=f.calculateFlightParameters(Re,ye,De,a),Pa=(l-s)/r,ni=Tn*(1.852/3.6)*Pa,An=w(ee[0],ee[1],(Re+180)%360,Tn,Pa);return console.log(`[Pattern] Landing Pattern Updated:
        Final Leg: Wind: ${y.toFixed(1)}° @ ${_.toFixed(1)}kt, Course: ${S.toFixed(1)}°, WCA: ${T.toFixed(1)}°, GS: ${N.toFixed(1)}kt, HW: ${A.toFixed(1)}kt, Length: ${x.toFixed(1)}m
        Base Leg: Wind: ${O.toFixed(1)}° @ ${R.toFixed(1)}kt, Course: ${z.toFixed(1)}°, WCA: ${X.toFixed(1)}°, GS: ${$.toFixed(1)}kt, HW: ${J.toFixed(1)}kt, Length: ${oe.toFixed(1)}m
        Downwind Leg: Wind: ${ye.toFixed(1)}° @ ${De.toFixed(1)}kt, Course: ${Re.toFixed(1)}°, WCA: ${Xe.toFixed(1)}°, GS: ${Tn.toFixed(1)}kt, HW: ${kn.toFixed(1)}kt, Length: ${ni.toFixed(1)}m`),console.log("[Pattern] Coordinates DIP: ",t,e,"Altitude DIP:",c),console.log("[Pattern] Coordinates final end: ",C[0],C[1],"Leg Height:",c+o),console.log("[Pattern] Coordinates base end: ",ee[0],ee[1],"Leg Height:",c+s),console.log("[Pattern] Coordinates downwind end: ",An[0],An[1],"Leg Height:",c+l),{downwindStart:An,baseStart:ee,finalStart:C,landingPoint:[t,e]}}function Ea(t){if(!i.map||i.cutAwayLat===null||i.cutAwayLng===null||!i.weatherData||i.lastAltitude==="N/A"||!t||t.length===0)return null;const e=Math.round(i.lastAltitude),n=g.state.userSettings.cutAwayAltitude,a=e,r=e+n,o=t.map(S=>S.height),s=t.map(S=>-f.convertWind(S.spd,"m/s","km/h")*Math.sin(S.dir*Math.PI/180)),l=t.map(S=>-f.convertWind(S.spd,"m/s","km/h")*Math.cos(S.dir*Math.PI/180)),c=f.calculateMeanWind(o,s,l,a,r);if(!c)return null;const[u,d]=c,m={Open:Wn.OPEN,Partially:Wn.PARTIALLY,Collapsed:Wn.COLLAPSED},p=m[g.state.userSettings.cutAwayState]||m.Partially,h=n/p,v=d*h,b=(u+180)%360,[w,M]=f.calculateNewCenter(i.cutAwayLat,i.cutAwayLng,v,b),_=`<b>Cut-Away (${g.state.userSettings.cutAwayState.replace(/([A-Z])/g," $1").trim()})</b><br>Cut-Away Altitude: ${n} m<br>Displacement: ${u.toFixed(0)}°, ${v.toFixed(0)} m<br>Descent Time/Speed: ${h.toFixed(0)} s at ${p.toFixed(1)} m/s<br>`;return{center:[w,M],radius:wl,tooltipContent:_}}async function Cl(){var E,k,A,T;const t=parseInt((E=document.getElementById("timeSlider"))==null?void 0:E.value)||0,e=g.getValue("interpStep","select",200),n=g.getValue("heightUnit","m"),a=be(i.weatherData,t,e,Math.round(i.lastAltitude),n);parseInt((k=document.getElementById("legHeightDownwind"))==null?void 0:k.value);const r=parseFloat((A=document.getElementById("descentRate"))==null?void 0:A.value)||3.5,o=(parseFloat((T=document.getElementById("canopySpeed"))==null?void 0:T.value)||20)*re.KNOTS_TO_MPS,s=i.lastAltitude,l=Oo(a);if(!l||l.additionalBlueRadii.length===0)throw new Error("Could not calculate the smallest canopy circle for analysis.");const c=l.additionalBlueRadii.length-1,u=l.additionalBlueRadii[c],d=l.blueLat,m=l.blueLng,p=l.additionalBlueDisplacements[c],h=l.additionalBlueDirections[c],v=f.calculateNewCenter(d,m,p,h),b=l.additionalBlueUpperLimits[c],w=L.latLng(d,m);console.log(`--- TERRAIN ANALYSIS STARTED ---
    - Analyzing Circle Center: ${v[0].toFixed(4)}, ${v[1].toFixed(4)}
    - Circle Radius: ${u.toFixed(0)}m
    - Skydiver Entry Altitude: ${b.toFixed(0)}m AGL (${(s+b).toFixed(0)}m MSL)
    -----------------------------`);const M=`${v[0].toFixed(4)}_${v[1].toFixed(4)}_${u.toFixed(0)}`;let y=[];if(i.terrainAnalysisCache&&i.terrainAnalysisCache.key===M)console.log("Using cached terrain elevation data."),f.handleMessage("Using cached terrain data for instant analysis."),y=i.terrainAnalysisCache.data;else{const D=[],x=L.latLng(v);for(let I=-u;I<=u;I+=75)for(let O=-u;O<=u;O+=75)if(I*I+O*O<=u*u){const R=x.lat+I/111320,W=x.lng+O/(111320*Math.cos(x.lat*Math.PI/180));D.push(L.latLng(R,W))}if(D.length===0)return[];const C=100;for(let I=0;I<D.length;I+=C){const O=D.slice(I,I+C);f.handleMessage(`Analyzing terrain... (${I+O.length}/${D.length})`);const R=await f.getMultipleAltitudes(O);for(let W=0;W<O.length;W++){const z=O[W],$=R[W];y.push({...z,groundEle:$!=="N/A"?$:null})}}i.terrainAnalysisCache={key:M,data:y},console.log("Terrain elevation data has been cached.")}const _=[],S=g.getValue("terrainClearance",100);for(const N of y){const D=N.groundEle;if(D===null)continue;const I=i.map.distance(w,N)/o*r,O=s+b-I,R=O-D;console.log(`[Point Analysis] Lat: ${N.lat.toFixed(4)}, Lng: ${N.lng.toFixed(4)}
            - Ground MSL: ${D.toFixed(0)}m
            - Skydiver MSL (estimated): ${O.toFixed(0)}m
            - CLEARANCE: ${R.toFixed(0)}m`),R<S&&_.push(N)}return console.log(`--- TERRAIN ANALYSIS FINISHED ---
    - Points Analyzed: ${y.length}
    - Dangerous Points Found: ${_.length}
    --------------------------------`),_}function Il(t,e,n,a,r,o,s,l){if(!t||!a||a.length===0)return f.handleError("calculateFreeFall: Wetterdaten fehlen."),null;if(!f.isValidLatLng(r,o)||!Number.isFinite(s))return f.handleError("calculateFreeFall: Ungültige Startkoordinaten oder Geländehöhe."),null;if(e<=n)return f.handleError("calculateFreeFall: Exit-Höhe muss über der Öffnungshöhe liegen."),null;console.log("--- calculateFreeFall: Berechnung gestartet ---");const{TERMINAL_VELOCITY_VERTICAL_MPS:c,GRAVITY_ACCELERATION:u,HORIZONTAL_DRAG_TAU_SECONDS:d}=yl,m=g.state.userSettings.aircraftSpeedKt,p=e/re.FEET_TO_METERS,h=f.calculateTAS(m,p);let v=m*re.KNOTS_TO_MPS;if(Number.isFinite(h)){const q=a.map(Xe=>Xe.height-s),oe=f.linearInterpolate(q,a.map(Xe=>Xe.dir),e),ee=f.linearInterpolate(q,a.map(Xe=>f.convertWind(Xe.spd,"m/s","km/h")),e),ie=h*re.KNOTS_TO_MPS,ye=(oe+180)*Math.PI/180,De=ee*Math.sin(ye),Re=ee*Math.cos(ye),Vt=l*Math.PI/180,jt=ie*Math.sin(Vt),kn=ie*Math.cos(Vt);v=Math.sqrt((jt+De)**2+(kn+Re)**2)}console.log(`[Freifall-Input] JRT-Richtung: ${l}°, TAS: ${h} kt, Berechnete Ground Speed: ${v.toFixed(1)} m/s`);const b=e-n,w=c/u,M=.5*u*w**2,_=(b>M?b-M:0)/c,S=w+_,E=v*d,k=l,A=a.map(q=>-f.convertWind(q.spd,"m/s","km/h")*Math.sin(q.dir*Math.PI/180)),T=a.map(q=>-f.convertWind(q.spd,"m/s","km/h")*Math.cos(q.dir*Math.PI/180)),N=f.calculateMeanWind(a.map(q=>q.height),A,T,s+n,s+e);if(!N)return f.handleError("calculateFreeFall: Konnte mittleren Wind nicht berechnen."),null;const[D,x]=N;console.log(`[Freifall-Input] Mittelwind: ${D.toFixed(0)}° @ ${(x*3.6/1.852).toFixed(1)} kt`);const C=(D+180)%360,I=x*S;console.log(`[Freifall-Ergebnis] Wurf: ${k.toFixed(0)}°, Distanz: ${E.toFixed(0)} m`),console.log(`[Freifall-Ergebnis] Abdrift: ${C.toFixed(0)}°, Distanz: ${I.toFixed(0)} m`);const O=E*Math.cos(k*Math.PI/180),R=E*Math.sin(k*Math.PI/180),W=I*Math.cos(C*Math.PI/180),z=I*Math.sin(C*Math.PI/180),$=O+W,Z=R+z,B=Math.sqrt($**2+Z**2),J=(Math.atan2(Z,$)*180/Math.PI+360)%360,X=f.calculateNewCenter(r,o,B,J),ue=[{latLng:{lat:r,lng:o},height:s+e,time:0},{latLng:{lat:X[0],lng:X[1]},height:s+n,time:S}];return console.log(`[Freifall-Ergebnis] Zeit: ${S.toFixed(1)} s, Distanz: ${B.toFixed(0)} m, Richtung: ${J.toFixed(1)}°`),console.log("--- calculateFreeFall: Berechnung beendet ---"),{time:S,distance:B,directionDeg:J,path:ue}}async function _a(){if(!i.lastLat||!i.lastLng)return f.handleMessage("Please select a location first."),!1;if(!g.state.userSettings.selectedEnsembleModels||g.state.userSettings.selectedEnsembleModels.length===0)return i.ensembleModelsData=null,Gt(),!0;const t=document.getElementById("loading");t&&(t.style.display="block");try{const e=i.lastLat,n=i.lastLng,a=g.state.userSettings.selectedEnsembleModels,r=a.join(","),o=["surface_pressure","temperature_2m","relative_humidity_2m","wind_speed_10m","wind_direction_10m","geopotential_height_1000hPa","temperature_1000hPa","relative_humidity_1000hPa","wind_speed_1000hPa","wind_direction_1000hPa","cloud_cover_1000hPa","geopotential_height_950hPa","temperature_950hPa","relative_humidity_950hPa","wind_speed_950hPa","wind_direction_950hPa","cloud_cover_950hPa","geopotential_height_925hPa","temperature_925hPa","relative_humidity_925hPa","wind_speed_925hPa","wind_direction_925hPa","cloud_cover_925hPa","geopotential_height_900hPa","temperature_900hPa","relative_humidity_900hPa","wind_speed_900hPa","wind_direction_900hPa","cloud_cover_900hPa","geopotential_height_850hPa","temperature_850hPa","relative_humidity_850hPa","wind_speed_850hPa","wind_direction_850hPa","cloud_cover_850hPa","geopotential_height_800hPa","temperature_800hPa","relative_humidity_800hPa","wind_speed_800hPa","wind_direction_800hPa","cloud_cover_800hPa","geopotential_height_700hPa","temperature_700hPa","relative_humidity_700hPa","wind_speed_700hPa","wind_direction_700hPa","cloud_cover_700hPa","geopotential_height_600hPa","temperature_600hPa","relative_humidity_600hPa","wind_speed_600hPa","wind_direction_600hPa","cloud_cover_600hPa","geopotential_height_500hPa","temperature_500hPa","relative_humidity_500hPa","wind_speed_500hPa","wind_direction_500hPa","cloud_cover_500hPa","geopotential_height_400hPa","temperature_400hPa","relative_humidity_400hPa","wind_speed_400hPa","wind_direction_400hPa","cloud_cover_400hPa","geopotential_height_300hPa","temperature_300hPa","relative_humidity_300hPa","wind_speed_300hPa","wind_direction_300hPa","cloud_cover_300hPa","geopotential_height_250hPa","temperature_250hPa","relative_humidity_250hPa","wind_speed_250hPa","wind_direction_250hPa","cloud_cover_250hPa","geopotential_height_200hPa","temperature_200hPa","relative_humidity_200hPa","wind_speed_200hPa","wind_direction_200hPa","cloud_cover_200hPa"],s=o.join(","),l=document.getElementById("historicalDatePicker"),c=l?l.value:null,u=c?F.fromISO(c,{zone:"utc"}):null,d=F.utc().startOf("day"),m=u&&u<d;let p,h,v=Rt.FORECAST;if(m)v=Rt.HISTORICAL,p=u.toFormat("yyyy-MM-dd"),h=p;else{const _=F.utc();p=_.toFormat("yyyy-MM-dd"),h=_.plus({days:7}).toFormat("yyyy-MM-dd")}const b=`${v}?latitude=${e}&longitude=${n}&hourly=${s}&models=${r}&start_date=${p}&end_date=${h}`,w=await fetch(b);if(!w.ok)throw w.status===429?new Error("API-Limit for ensemble data reached. Please wait a moment and retry again."):new Error(`API request failed: ${w.status}`);const M=await w.json();i.ensembleModelsData={};const y=M.hourly.time;return a.forEach(_=>{const S={time:[...y]};let E=!1;o.forEach(k=>{const A=`${k}_${_}`;M.hourly[A]?(S[k]=M.hourly[A],E=!0):S[k]=null}),E&&(i.ensembleModelsData[_]=S)}),!0}catch(e){return console.error("Failed to fetch ensemble weather data:",e),f.handleError(e.message),!1}finally{t&&(t.style.display="none")}}function ot(t,e){if(Gt(),!i.ensembleModelsData||Object.keys(i.ensembleModelsData).length===0)return;const n=g.state.userSettings.currentEnsembleScenario;switch(console.log(`Processing ensemble scenario: ${n} for slider index: ${t}`),n){case"heatmap":Dl(t);break;case"all_models":for(const a in i.ensembleModelsData){const r=i.ensembleModelsData[a],o=ia(a,t,{hourly:r});o&&yr(o,Pl(a),a)}break;case"min_wind":case"mean_wind":case"max_wind":{const a=Nl(n);if(a){const r=ia(n,t,a);r&&yr(r,Fl(n),n.replace("_"," "))}break}}}function Gt(){i.ensembleLayerGroup&&i.map.removeLayer(i.ensembleLayerGroup),i.ensembleScenarioCircles={},i.ensembleLayerGroup=L.layerGroup().addTo(i.map)}function Nl(t,e){var d;if(!i.ensembleModelsData||Object.keys(i.ensembleModelsData).length===0)return console.warn("No ensemble data available for profile calculation."),null;if(Object.keys(i.ensembleModelsData).length===0)return null;console.log(`Calculating full time-series ensemble profile for: ${t}`);const a={},r=Object.keys(i.ensembleModelsData)[0],o=(d=i.ensembleModelsData[r])==null?void 0:d.time;if(!o||o.length===0)return console.error("Time data missing or empty in the first ensemble model for profile calculation."),null;a.time=[...o];const s=a.time.length,l=["surface_pressure","temperature_2m","relative_humidity_2m","geopotential_height_1000hPa","temperature_1000hPa","relative_humidity_1000hPa","geopotential_height_950hPa","temperature_950hPa","relative_humidity_950hPa","geopotential_height_925hPa","temperature_925hPa","relative_humidity_925hPa","geopotential_height_900hPa","temperature_900hPa","relative_humidity_900hPa","geopotential_height_850hPa","temperature_850hPa","relative_humidity_850hPa","geopotential_height_800hPa","temperature_800hPa","relative_humidity_800hPa","geopotential_height_700hPa","temperature_700hPa","relative_humidity_700hPa","geopotential_height_600hPa","temperature_600hPa","relative_humidity_600hPa","geopotential_height_500hPa","temperature_500hPa","relative_humidity_500hPa","geopotential_height_400hPa","temperature_400hPa","relative_humidity_400hPa","geopotential_height_300hPa","temperature_300hPa","relative_humidity_300hPa","geopotential_height_250hPa","temperature_250hPa","relative_humidity_250hPa","geopotential_height_200hPa","temperature_200hPa","relative_humidity_200hPa"],c=[["wind_speed_10m","wind_direction_10m"]];[1e3,950,925,900,850,800,700,600,500,400,300,250,200].forEach(m=>{c.push([`wind_speed_${m}hPa`,`wind_direction_${m}hPa`])}),l.forEach(m=>{a[m]=new Array(s).fill(null)}),c.forEach(m=>{a[m[0]]=new Array(s).fill(null),a[m[1]]=new Array(s).fill(null)});for(let m=0;m<s;m++)l.forEach(p=>{const h=[];for(const v in i.ensembleModelsData){const b=i.ensembleModelsData[v];if(b&&b[p]){const w=b[p][m];w!=null&&!isNaN(w)&&h.push(w)}}h.length>0&&(t==="min_wind"?a[p][m]=Math.min(...h):t==="max_wind"?a[p][m]=Math.max(...h):a[p][m]=h.reduce((v,b)=>v+b,0)/h.length)}),c.forEach(p=>{const h=p[0],v=p[1];let b=[],w=[],M=[],y=[];for(const _ in i.ensembleModelsData){const S=i.ensembleModelsData[_];if(S&&S[h]&&S[v]){const E=S[h][m],k=S[v][m];E!=null&&!isNaN(E)&&k!==null&&k!==void 0&&!isNaN(k)&&(M.push(E),y.push(k),b.push(-E*Math.sin(k*Math.PI/180)),w.push(-E*Math.cos(k*Math.PI/180)))}}if(M.length>0)if(t==="min_wind"){const _=Math.min(...M),S=M.indexOf(_);a[h][m]=_,a[v][m]=y[S]}else if(t==="max_wind"){const _=Math.max(...M),S=M.indexOf(_);a[h][m]=_,a[v][m]=y[S]}else{const _=b.reduce((E,k)=>E+k,0)/b.length,S=w.reduce((E,k)=>E+k,0)/w.length;a[h][m]=f.windSpeed(_,S),a[v][m]=f.windDirection(_,S)}});return{hourly:a}}function ia(t,e,n=null){var u,d;if(console.log(`Calculating exit circle for ensemble profile/model: ${t} at index ${e}`),e==null)return console.error("sliderIndex is undefined in calculateExitCircleForEnsemble. Aborting."),null;let a;if(n)a=n;else if(i.ensembleModelsData&&i.ensembleModelsData[t])a={hourly:i.ensembleModelsData[t]};else return console.warn(`No data for profile/model ${t} in calculateExitCircleForEnsemble found.`),null;if(!a.hourly||!i.lastLat||!i.lastLng||i.lastAltitude==="N/A")return console.warn(`Incomplete data for calculateExitCircleForEnsemble: ${t}`),null;const r=Ie(),o=g.getValue("heightUnit","m"),s=i.weatherData;i.weatherData=a.hourly;let l=null,c={meanWindDir:"N/A",meanWindSpeedMps:"N/A"};try{const m=g.state.userSettings.calculateJump,p=g.state.userSettings.showExitArea;g.state.userSettings.calculateJump=!0,g.state.userSettings.showExitArea=!0;const h=be(i.weatherData,e,r,Math.round(i.lastAltitude),o);if(h&&h.length>0){l=$o(h);const v=h.map(A=>A.height),b=h.map(A=>-f.convertWind(A.spd,"m/s","km/h")*Math.sin(A.dir*Math.PI/180)),w=h.map(A=>-f.convertWind(A.spd,"m/s","km/h")*Math.cos(A.dir*Math.PI/180)),M=parseInt((u=document.getElementById("openingAltitude"))==null?void 0:u.value)||1200,y=parseInt((d=document.getElementById("legHeightDownwind"))==null?void 0:d.value)||0,_=Math.round(i.lastAltitude),S=_+M-200,E=_+y,k=f.calculateMeanWind(v,b,w,E,S);k&&Number.isFinite(k[0])&&Number.isFinite(k[1])&&(c={meanWindDir:k[0],meanWindSpeedMps:k[1]})}g.state.userSettings.calculateJump=m,g.state.userSettings.showExitArea=p}catch(m){console.error(`Error in calculateExitCircle for profile ${t}:`,m),l=null}finally{i.weatherData=s}return l?{centerLat:l.greenLat,centerLng:l.greenLng,radius:l.darkGreenRadius,meanWindDir:c.meanWindDir,meanWindSpeedMps:c.meanWindSpeedMps}:(console.warn(`calculateExitCircle returned null for profile ${t}`),null)}function Dl(t,e){if(Gt(),!i.ensembleModelsData||Object.keys(i.ensembleModelsData).length===0)return;const n=[];for(const w in i.ensembleModelsData)if(Object.hasOwnProperty.call(i.ensembleModelsData,w)){const M=i.ensembleModelsData[w],y=ia(w,t,{hourly:M});y&&n.push({centerLat:y.centerLat,centerLng:y.centerLng,radius:y.radius})}if(n.length===0){console.warn("Could not calculate any circles for the heatmap.");return}const a=n.length,r=Math.ceil(a/2);let o=90,s=-90,l=180,c=-180;n.forEach(w=>{const M=w.radius/111320,y=w.radius/(111320*Math.cos(w.centerLat*Math.PI/180));o=Math.min(o,w.centerLat-M),s=Math.max(s,w.centerLat+M),l=Math.min(l,w.centerLng-y),c=Math.max(c,w.centerLng+y)});const u=25,d=u/111320,m=[],p=[],h=[];for(let w=o;w<=s;w+=d){const M=u/(111320*Math.cos(w*Math.PI/180));for(let y=l;y<=c;y+=M){let _=0;const S=L.latLng(w,y);for(const E of n)i.map.distance(S,L.latLng(E.centerLat,E.centerLng))<=E.radius&&_++;_>=1&&m.push([w,y]),_>=r&&p.push([w,y]),_===a&&h.push([w,y])}}const v=w=>{w.sort((S,E)=>S[0]-E[0]||S[1]-E[1]);const M=(S,E,k)=>(E[0]-S[0])*(k[1]-S[1])-(E[1]-S[1])*(k[0]-S[0]),y=[];for(const S of w){for(;y.length>=2&&M(y[y.length-2],y[y.length-1],S)<=0;)y.pop();y.push(S)}const _=[];for(let S=w.length-1;S>=0;S--){const E=w[S];for(;_.length>=2&&M(_[_.length-2],_[_.length-1],E)<=0;)_.pop();_.push(E)}return y.slice(0,-1).concat(_.slice(0,-1))};i.heatmapContourLayers=[];const b=(w,M)=>{if(w.length>2){const y=v(w),_=L.polygon(y,M).addTo(i.ensembleLayerGroup);i.heatmapContourLayers.push(_)}};b(m,{color:"red",weight:2,fillOpacity:.1,interactive:!1}),b(p,{color:"yellow",weight:2,fillOpacity:.15,interactive:!1}),b(h,{color:"green",weight:3,fillOpacity:.2,interactive:!1})}function yr(t,e,n){var b,w;if(!i.map||!t||!i.ensembleLayerGroup)return;const a=[t.centerLat,t.centerLng],r=L.circle(a,{radius:t.radius,color:e,fillColor:e,fillOpacity:.15,weight:2,dashArray:"5, 10",pmIgnore:!0}).addTo(i.ensembleLayerGroup),o=g.getValue("windUnit","kt");let s="N/A";if(t.meanWindSpeedMps!=="N/A"&&Number.isFinite(t.meanWindSpeedMps)){const M=f.convertWind(t.meanWindSpeedMps,o,"m/s");M!=="N/A"&&Number.isFinite(M)&&(s=o==="bft"?Math.round(M):M.toFixed(1))}const l=parseInt((b=document.getElementById("openingAltitude"))==null?void 0:b.value)||g.state.userSettings.openingAltitude||1200,c=parseInt((w=document.getElementById("legHeightDownwind"))==null?void 0:w.value)||g.state.userSettings.legHeightDownwind||0,u=l-200,d=g.getValue("heightUnit","m"),m=Math.round(f.convertHeight(c,d)),p=Math.round(f.convertHeight(u,d)),h=t.meanWindDir!=="N/A"&&Number.isFinite(t.meanWindDir)?f.roundToTens(t.meanWindDir):"N/A",v=`<strong>${n}</strong><br>Mean Wind ${m}-${p} ${d} AGL:<br>${h}° ${s} ${o}`;r.bindTooltip(v,{permanent:!1,direction:"top",className:"wind-tooltip",opacity:.9}),i.ensembleScenarioCircles[n]=r,console.log(`Drew ensemble circle for ${n} at [${a.join(", ")}], radius ${t.radius}`)}function Pl(t){let e=0;for(let a=0;a<t.length;a++)e=t.charCodeAt(a)+((e<<5)-e),e=e&e;return`hsl(${e%360}, 70%, 60%)`}function Fl(t){return t==="min_wind"?Ve.SCENARIO_COLORS.MIN_WIND:t==="mean_wind"?Ve.SCENARIO_COLORS.MEAN_WIND:t==="max_wind"?Ve.SCENARIO_COLORS.MAX_WIND:"rgba(128, 128, 128, 0.7)"}function Ro(){var t;return parseInt((t=document.getElementById("timeSlider"))==null?void 0:t.value)||0}function xl({title:t,message:e,onConfirm:n,onCancel:a}){const r=document.getElementById("locationDisclosureModal"),o=document.getElementById("disclosureHeader"),s=document.getElementById("disclosureMessage"),l=document.getElementById("disclosureConfirm"),c=document.getElementById("disclosureCancel");if(!r||!o||!s||!l||!c){console.error("Disclosure modal elements not found!"),n();return}o.textContent=t,s.innerHTML=e,r.style.display="flex";const u=l.cloneNode(!0);l.parentNode.replaceChild(u,l);const d=c.cloneNode(!0);c.parentNode.replaceChild(d,c),u.onclick=()=>{r.style.display="none",n()},d.onclick=()=>{r.style.display="none",a()}}const ge={dbName:"SkydivingTileCache",storeName:"tiles",db:null,async init(){return new Promise((t,e)=>{const n=indexedDB.open(this.dbName,1);n.onupgradeneeded=a=>{a.target.result.createObjectStore(this.storeName,{keyPath:"url"})},n.onsuccess=a=>{this.db=a.target.result,t()},n.onerror=a=>{console.error("IndexedDB initialization failed:",a),e(a)}})},async storeTile(t,e){return this.db||await this.init(),new Promise((n,a)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put({url:t,blob:e,timestamp:Date.now()});s.onsuccess=()=>{console.log(`Stored tile: ${t}`),n(!0)},s.onerror=l=>{console.warn(`Failed to store tile: ${t}`,l),f.handleError("Failed to store some tiles. Try clearing cache."),a(l)}})},async getTile(t){return this.db||await this.init(),new Promise((e,n)=>{const r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName),o=r.get(t);o.onsuccess=s=>{const l=s.target.result;if(l)e(l.blob);else{const c=[t.replace("https://tile.opentopomap.org","https://a.tile.opentopomap.org"),t.replace("https://tile.opentopomap.org","https://b.tile.opentopomap.org"),t.replace("https://tile.opentopomap.org","https://c.tile.opentopomap.org"),t.replace("https://tile.openstreetmap.org","https://a.tile.openstreetmap.org"),t.replace("https://tile.openstreetmap.org","https://b.tile.openstreetmap.org"),t.replace("https://tile.openstreetmap.org","https://c.tile.openstreetmap.org"),t.replace("https://basemaps.cartocdn.com","https://a.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://b.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://c.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://d.basemaps.cartocdn.com")];let u=null;for(const d of c){if(d===t)continue;const m=r.get(d);m.onsuccess=p=>{const h=p.target.result;h&&(u=h.blob,e(u))},m.onerror=()=>{}}setTimeout(()=>{u||e(null)},100)}},o.onerror=s=>{console.warn(`Failed to retrieve tile: ${t}`,s),n(s)}})},async clearCache(){return this.db||await this.init(),new Promise((t,e)=>{const r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();r.onsuccess=()=>{console.log("Tile cache cleared"),t()},r.onerror=o=>{console.error("Failed to clear cache:",o),e(o)}})},async clearOldTiles(t=bn.MAX_AGE_DAYS){this.db||await this.init();const e=t*24*60*60*1e3;return new Promise((n,a)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).openCursor();let l=0,c=0;s.onsuccess=u=>{const d=u.target.result;if(d)Date.now()-d.value.timestamp>e&&(c+=d.value.blob.size||0,d.delete(),l++),d.continue();else{const m=c/1048576;console.log(`Cleared ${l} old tiles, freed ${m.toFixed(2)} MB`),n({deletedCount:l,deletedSizeMB:m})}},s.onerror=u=>{console.error("Failed to clear old tiles:",u),a(u)}})},async getCacheSize(){return this.db||await this.init(),new Promise((t,e)=>{const r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).openCursor();let o=0,s=0;r.onsuccess=l=>{var u;const c=l.target.result;if(c)try{const d=((u=c.value.blob)==null?void 0:u.size)||0;typeof d!="number"||isNaN(d)?console.warn(`Invalid blob size for tile: ${c.value.url}, size: ${d}`):(o+=d,s++),c.continue()}catch(d){console.warn(`Error processing tile during size calculation: ${c.value.url}`,d),c.continue()}else{const d=o/1048576;console.log(`Cache size calculation completed: ${d.toFixed(2)} MB, ${s} tiles`),t(d)}},r.onerror=l=>{console.error("Failed to calculate cache size:",l),e(l)}})},async migrateTiles(){return this.db||await this.init(),new Promise((t,e)=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),r=a.openCursor();let o=0;r.onsuccess=s=>{const l=s.target.result;if(l){const{url:c,blob:u,timestamp:d}=l.value,m=c.replace(/^(https?:\/\/[a-c]\.tile\.openstreetmap\.org)/,"https://tile.openstreetmap.org").replace(/^(https?:\/\/[a-d]\.basemaps\.cartocdn\.com)/,"https://basemaps.cartocdn.com").replace(/^(https?:\/\/[a-c]\.tile\.opentopomap\.org)/,"https://tile.opentopomap.org");c!==m&&(l.delete(),a.put({url:m,blob:u,timestamp:d}),o++),l.continue()}else console.log(`Migrated ${o} tiles to normalized URLs`),t()},r.onerror=s=>{console.error("Failed to migrate tiles:",s),e(s)}})}};L.TileLayer.Cached=L.TileLayer.extend({createTile(t,e){const n=document.createElement("img");L.DomEvent.on(n,"load",()=>{console.log("Tile loaded:",this.getTileUrl(t)),e(null,n)}),L.DomEvent.on(n,"error",()=>{console.warn("Tile error:",this.getTileUrl(t)),e(new Error("Failed to load tile"),n)});const a=this.getTileUrl(t);n.setAttribute("role","presentation");const r=a.replace(/^(https?:\/\/[a-c]\.tile\.openstreetmap\.org)/,"https://tile.openstreetmap.org").replace(/^(https?:\/\/[a-d]\.basemaps\.cartocdn\.com)/,"https://basemaps.cartocdn.com").replace(/^(https?:\/\/[a-c]\.tile\.opentopomap\.org)/,"https://tile.opentopomap.org");return!navigator.onLine&&(t.z<11||t.z>14)?(console.log(`Skipping tile request outside cached zoom levels (11–14): ${a}`),f.handleError("Offline: Zoom restricted to levels 11–14 for cached tiles."),e(new Error("Zoom level not cached"),n),n):(navigator.onLine?(n.src=a,fetch(a,{signal:AbortSignal.timeout(bn.FETCH_TIMEOUT_MS)}).then(o=>{if(!o.ok)throw new Error(`HTTP ${o.status}`);return o.blob()}).then(o=>{ge.storeTile(r,o).catch(s=>console.warn("Failed to cache tile during rendering:",r,s))}).catch(o=>{console.warn("Fetch error for tile during rendering:",a,o),ge.getTile(r).then(s=>{s?(n.src=URL.createObjectURL(s),console.log(`Tile loaded from cache (fallback): ${r}`)):e(o,n)}).catch(s=>{console.warn("Cache fallback error:",r,s),e(s,n)})})):ge.getTile(r).then(o=>{o?(n.src=URL.createObjectURL(o),console.log(`Tile loaded from cache: ${r}`)):(console.warn(`Tile not in cache: ${r}`),f.handleError("This area is not cached. Please cache more tiles while online."),e(new Error("Tile not in cache"),n))}).catch(o=>{console.warn("Cache error for offline tile:",r,o),f.handleError("This area is not cached. Please cache more tiles while online."),e(o,n)}),n)}});L.tileLayer.cached=function(t,e){return new L.TileLayer.Cached(t,e)};async function Uo({map:t,lastLat:e,lastLng:n,baseMaps:a,onProgress:r,onComplete:o,onCancel:s,radiusKm:l=null,silent:c=!1}){if(!t){o&&!c&&o("Map not initialized, cannot cache tiles.");return}if(!e||!n){o&&!c&&o("Please select a location to cache map tiles.");return}const u=l!==null?l:g.state.userSettings.cacheRadiusKm||g.defaultSettings.cacheRadiusKm,d=g.state.userSettings.cacheZoomLevels||g.defaultSettings.cacheZoomLevels,m=$l(e,n,u,d,t),p=[],h=g.state.userSettings.baseMaps,v=a[h];if(v)if(v instanceof L.LayerGroup)v.eachLayer(S=>{const E=S.options.url||S._url;E&&p.push({name:`${h} (${S.options.attribution||"sub-layer"})`,url:E,subdomains:S.options.subdomains,normalizedUrl:E.replace(/{s}\./,"")})});else{const S=v.options.url||v._url;S&&p.push({name:h,url:S,subdomains:v.options.subdomains,normalizedUrl:S.replace(/{s}\./,"")})}const b=m.length*p.length;if(b===0){o&&!c&&o("No tiles to cache for this basemap.");return}let w=0,M=0;const y=[];i.isCachingCancelled=!1,r&&!c&&r(0,b,()=>{i.isCachingCancelled=!0,s&&s()});try{for(const S of p){if(console.log("Processing layer:",S.name),i.isCachingCancelled){console.log("Caching cancelled by user");break}const E=m.map(async(k,A)=>{if(i.isCachingCancelled){console.log("Caching cancelled during tile processing");return}const T=S.url.replace("{z}",k.zoom).replace("{x}",k.x).replace("{y}",k.y).replace("{s}",S.subdomains?S.subdomains[Math.floor(Math.random()*S.subdomains.length)]:""),N=S.normalizedUrl.replace("{z}",k.zoom).replace("{x}",k.x).replace("{y}",k.y);if(console.log(`Processing tile ${A+1}/${m.length} for layer ${S.name}:`,{url:T,normalizedUrl:N}),await ge.getTile(N).catch(C=>(console.error(`Error retrieving tile from cache: ${N}`,C),null)))w++,console.log(`Tile ${A+1} already in cache`);else{const C=await Ol(T);C.success?await ge.storeTile(N,C.blob).catch(O=>(console.error(`Error storing tile: ${N}`,O),!1))?(w++,console.log(`Tile ${A+1} cached successfully`)):(M++,y.push(T),console.log(`Tile ${A+1} failed to store`)):(M++,y.push(T),console.log(`Tile ${A+1} failed to fetch:`,C.error.message))}const x=w+M;((A+1)%10===0||A===m.length-1)&&r&&!c&&r(x,b,()=>{i.isCachingCancelled=!0})});console.log(`Processing batch of ${m.length} tiles for layer ${S.name}`);for(let k=0;k<E.length;k+=20){if(i.isCachingCancelled){console.log("Caching cancelled during batch processing");break}const A=E.slice(k,k+20);await Promise.all(A).catch(T=>{console.error("Error processing batch of tiles:",T)}),console.log(`Completed batch ${k/20+1} for layer ${S.name}`)}}}catch(S){console.error("Unexpected error in cacheTilesForDIP:",S),f.handleError("Failed to cache map tiles: "+S.message)}finally{if(console.log("Hiding progress bar"),o){let S="";i.isCachingCancelled?S=`Caching cancelled: ${w} tiles cached, ${M} failed.`:M>0?S=`Cached ${w} tiles around DIP (${M} failed).`:S=`Cached ${w} tiles around DIP successfully.`,o(S)}}y.length>0&&console.warn(`Failed to cache ${y.length} tiles:`,y),console.log(`DIP caching complete: ${w} tiles cached, ${M} failed`);let _="";i.isCachingCancelled?_=`Caching cancelled: ${w} tiles cached, ${M} failed.`:M>0?_=`Cached ${w} tiles around DIP (${M} failed).`:_=`Cached ${w} tiles around DIP successfully.`,o&&o(_);try{const S=await ge.getCacheSize();console.log(`Cache size after DIP caching: ${S.toFixed(2)} MB`),S>bn.SIZE_LIMIT_MB_WARNING&&f.handleError(`Cache size large (${S.toFixed(2)} MB). Consider clearing cache to free up space.`)}catch(S){console.error("Failed to check cache size after DIP caching:",S),f.handleError("Unable to check cache size. Consider clearing cache to free up space.")}}async function ka({map:t,baseMaps:e,onProgress:n,onComplete:a,onCancel:r}){if(!t||!navigator.onLine){console.log("Skipping visible tile caching: offline or map not initialized");return}const o=t.getBounds(),s=t.getZoom(),l=g.state.userSettings.cacheZoomLevels||g.defaultSettings.cacheZoomLevels;if(!l.includes(s)){console.log(`Skipping caching: zoom ${s} not in cacheZoomLevels`,l);return}const c=256,u=t.project(o.getSouthWest(),s),d=t.project(o.getNorthEast(),s),m=Math.floor(u.x/c),p=Math.floor(d.x/c),h=Math.floor(d.y/c),v=Math.floor(u.y/c),b=[];for(let k=m;k<=p;k++)for(let A=h;A<=v;A++){const T=2**s;k>=0&&k<T&&A>=0&&A<T&&b.push({zoom:s,x:k,y:A})}console.log(`Caching ${b.length} visible tiles at zoom ${s} for ${g.state.userSettings.baseMaps}`);const w=[],M=g.state.userSettings.baseMaps,y=e[M];if(y)if(y instanceof L.LayerGroup)y.eachLayer(k=>{const A=k.options.url||k._url;A&&w.push({name:`${M} (${k.options.attribution||"sub-layer"})`,url:A,subdomains:k.options.subdomains,normalizedUrl:A.replace(/{s}\./,"")})});else{const k=y.options.url||y._url;k&&w.push({name:M,url:k,subdomains:y.options.subdomains,normalizedUrl:k.replace(/{s}\./,"")})}else{console.warn(`Base map ${M} not found, skipping caching`),a&&a("Selected base map not available for caching.");return}let _=0,S=0;const E=b.length*w.length;i.isCachingCancelled=!1,n&&n(0,E,()=>{i.isCachingCancelled=!0,r&&r()});for(const k of w){if(i.isCachingCancelled)break;const A=b.map(async(T,N)=>{n&&n(_+S,E,()=>{i.isCachingCancelled=!0,r&&r()})});await Promise.all(A)}a&&a("Visible tiles cached.")}function $l(t,e,n,a,r){if(!r)return console.warn("Map not initialized, cannot calculate tiles"),[];const o=new Set,s=40075016686e-3,l=n*1e3;return a.forEach(c=>{const u=r.project([t,e],c),d=256,m=u.x/d,p=u.y/d,h=t*Math.PI/180,v=s*Math.cos(h)/(d*Math.pow(2,c)),b=Math.ceil(l/(v*d))+1,w=Math.pow(2,c);for(let M=Math.floor(m-b);M<=Math.ceil(m+b);M++)for(let y=Math.floor(p-b);y<=Math.ceil(p+b);y++)M>=0&&M<w&&y>=0&&y<w&&o.add(`${c}/${M}/${y}`)}),Array.from(o).map(c=>{const[u,d,m]=c.split("/").map(Number);return{zoom:u,x:d,y:m}})}async function Ol(t,e=3){let n=null;for(let a=1;a<=e;a++){try{const r=new AbortController,o=setTimeout(()=>r.abort(),bn.FETCH_TIMEOUT_MS),s=await fetch(t,{signal:r.signal});if(clearTimeout(o),s.ok)return{success:!0,blob:await s.blob()};console.warn(`Attempt ${a} failed for ${t}: HTTP ${s.status}`),n=new Error(`HTTP ${s.status}`)}catch(r){console.warn(`Attempt ${a} error for ${t}: ${r.message}`),n=r,r.name==="AbortError"&&console.warn(`Fetch timeout after 15s for ${t}`)}a<e&&await new Promise(r=>setTimeout(r,1e3))}return{success:!1,error:n}}function it(){const t="ontouchstart"in window||navigator.maxTouchPoints>0,e=window.Capacitor&&window.Capacitor.isNativePlatform();return t||e}function Rl(){it()&&document.body.classList.add("touch-device")}function ae(){var t;return parseInt((t=document.getElementById("timeSlider"))==null?void 0:t.value)||0}function Ul(t){const e=document.getElementById("modelSelect");if(!e)return;const n=e.value;e.innerHTML="",t.forEach(a=>{const r=document.createElement("option");r.value=a,r.textContent=a.replace(/_/g," ").toUpperCase(),e.appendChild(r)}),t.includes(g.state.userSettings.model)?e.value=g.state.userSettings.model:t.includes(n)?e.value=n:t.length>0&&(e.value=t[0])}function Wl(t){let e=g.state.userSettings.selectedEnsembleModels||[],n=e.filter(a=>t.includes(a));e.length!==n.length&&(g.state.userSettings.selectedEnsembleModels=n,g.save())}function Ta(t,e="default"){let n=document.getElementById("snackbar");n||(n=document.createElement("div"),n.id="snackbar",document.body.appendChild(n)),n.textContent=t,n.className="show",e==="success"?n.classList.add("success"):e==="error"?n.classList.add("error"):e==="warning"&&n.classList.add("warning"),window.snackbarTimeout&&clearTimeout(window.snackbarTimeout),window.snackbarTimeout=setTimeout(()=>{n.className=n.className.replace("show","")},3e3)}function je(t){console.log("displayMessage called with:",t),Ta(t,"success")}function hn(t){console.log("displayError called with:",t),Ta(t,"error")}function Ye(t){console.log("displayWarning called with:",t),Ta(t,"warning")}function Ut(t,e,n){let a=document.getElementById("progress-snackbar");if(!a){a=document.createElement("div"),a.id="progress-snackbar";const o=document.createElement("div");o.className="progress-snackbar-content";const s=document.createElement("div");s.className="progress-snackbar-text";const l=document.createElement("div");l.className="progress-bar-container";const c=document.createElement("div");c.className="progress-bar",l.appendChild(c),o.appendChild(s),o.appendChild(l);const u=document.createElement("button");u.className="cancel-button",u.textContent="Cancel",u.onclick=()=>{n&&n(),Oe()},a.appendChild(o),a.appendChild(u),document.body.appendChild(a)}const r=e>0?Math.round(t/e*100):0;a.querySelector(".progress-snackbar-text").textContent=`Caching (${t}/${e})... ${r}%`,a.querySelector(".progress-bar").style.width=`${r}%`,a.classList.contains("show")||a.classList.add("show")}function Oe(){const t=document.getElementById("progress-snackbar");t&&t.classList.remove("show")}function sa(){console.log("updateOfflineIndicator called, navigator.onLine:",navigator.onLine);let t=document.getElementById("offline-indicator");t||(t=document.createElement("div"),t.id="offline-indicator",t.textContent="Offline Mode",document.body.appendChild(t),console.log("Offline indicator created and appended")),navigator.onLine?t.classList.remove("show"):t.classList.add("show")}function wt(t,e="Loading..."){const n=document.getElementById("loading");if(!n)return;const a=n.querySelector("p");t?(a&&(a.textContent=e),n.style.display="flex"):n.style.display="none"}let Je=JSON.parse(localStorage.getItem("searchCache"))||{},zn=!1;async function Hl(t){if(!t.trim())return[];const e=Bo(t);if(e)return[{display_name:`Coordinate: ${e.lat.toFixed(5)}, ${e.lng.toFixed(5)}`,lat:e.lat,lon:e.lng,type:"coordinate"}];if(Je[t])return Je[t];try{const n=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(t)}&count=10&language=de&format=json`,a=await fetch(n);if(!a.ok)throw new Error(`Geocoding API Error: ${a.statusText}`);const r=await a.json();if(!r.results)return[];const o=r.results.map(s=>({display_name:[s.name,s.admin1,s.country].filter(Boolean).join(", "),lat:s.latitude,lon:s.longitude}));return Je[t]=o,localStorage.setItem("searchCache",JSON.stringify(Je)),o}catch(n){return console.error("Search failed:",n),f.handleError("Could not find location. Please check network."),[]}}async function Bl(t,e,n,a){if(console.log("findParachutingPOIs: Searching for POIs in bbox:",{minLat:t,minLon:e,maxLat:n,maxLon:a}),isNaN(t)||isNaN(e)||isNaN(n)||isNaN(a)||t<-90||n>90||e<-180||a>180||t>n||e>a)return console.error("findParachutingPOIs: Invalid bounding box coordinates"),f.handleError("Invalid map bounds for POI search."),[];const r=`parachutingPOIs_${t}_${e}_${n}_${a}`;if(Je[r])return console.log("findParachutingPOIs: Returning cached results for bbox:",r),Je[r];try{const o=`
            [out:json][timeout:50][bbox:${t},${e},${n},${a}];
            (
                nwr["sport"="parachuting"];
                nwr[~"^(name|description|alt_name|official_name)$"~"Skydiv|Fallschirm|Dropzone|Sprungplatz|Tandemspr", i];
                nwr["aeroway"~"aerodrome|airfield"]["service"~"skydiving|parachuting", i];
            );
            out center;
        `,s=`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(o)}`;console.log("findParachutingPOIs: Sending Overpass query:",o);const l=await fetch(s);if(!l.ok)throw new Error(`Overpass API Error: ${l.statusText}`);const c=await l.json();console.log("findParachutingPOIs: Raw Overpass response:",c);const u=c.elements.map(p=>{var b,w;const h=p.tags||{};return{display_name:[h.name,h["addr:street"]||h.street,h["addr:city"]||h.city,h["addr:state"]||h.state,h["addr:country"]||h.country,h.sport?`(${h.sport})`:null,h.aeroway==="aerodrome"?"(Airfield)":null].filter(Boolean).join(", ")||"Unnamed Parachuting Location",lat:p.lat||((b=p.center)==null?void 0:b.lat),lon:p.lon||((w=p.center)==null?void 0:w.lon),type:h.sport||h.aeroway||h.leisure||"parachuting"}}),d=[],m=new Set;for(const p of u){const h=`${p.lat.toFixed(5)}_${p.lon.toFixed(5)}`;m.has(h)||(m.add(h),d.push(p))}return console.log("findParachutingPOIs: Caching results for bbox:",r),Je[r]=d,localStorage.setItem("searchCache",JSON.stringify(Je)),d.length===0?(console.log("findParachutingPOIs: No parachuting POIs found in bbox"),f.handleMessage("No parachuting locations found in this area.")):(console.log("findParachutingPOIs: Found POIs:",d),f.handleMessage(`Found ${d.length} parachuting location(s) in this area.`)),d}catch(o){return console.error("findParachutingPOIs: Search failed:",o),f.handleError("Could not find parachuting locations. Please check network."),[]}}function zl(t,e){let n=Ne(),a="Home DZ";n.forEach(o=>o.isHomeDZ=!1);const r=n.find(o=>Math.abs(o.lat-t)<1e-4&&Math.abs(o.lng-e)<1e-4);r?(r.isHomeDZ=!0,a=r.label):n.unshift({lat:t,lng:e,label:"Home DZ",isFavorite:!0,isHomeDZ:!0,timestamp:Date.now()}),Et(n),f.handleMessage(`"${a}" is now your Home DZ.`),Zt()}function Gl(){let t=Ne();t.forEach(e=>e.isHomeDZ=!1),Et(t),f.handleMessage("Home DZ removed."),Zt()}function Zl(){return Ne().find(t=>t.isHomeDZ)}function Wo(t,e,n,a=!1){if(console.log("addCoordToHistory: Adding:",{lat:t,lng:e,label:n,isFavorite:a}),isNaN(t)||isNaN(e)){console.error("addCoordToHistory: Invalid coordinates");return}let r=Ne();const o=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5));r=r.filter(u=>Math.abs(u.lat-o)>.001||Math.abs(u.lng-s)>.001),r.unshift({lat:o,lng:s,label:n,isFavorite:a,timestamp:Date.now()});const l=r.filter(u=>u.isFavorite),c=r.filter(u=>!u.isFavorite).slice(0,5);Et([...l,...c])}function Ho(t,e,n,a=!1){if(console.log("addOrUpdateFavorite: Processing:",{lat:t,lng:e,name:n}),isNaN(t)||isNaN(e)){console.error("addOrUpdateFavorite: Invalid coordinates");return}if(zn){console.log("addOrUpdateFavorite: Blocked due to ongoing operation");return}zn=!0;try{let r=Ne();const o=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5)),l=r.find(c=>Math.abs(c.lat-o)<.001&&Math.abs(c.lng-s)<.001);if(l)console.log("addOrUpdateFavorite: Updating existing entry:",l),l.isFavorite=!0,l.label=n;else{const c={lat:o,lng:s,label:n,isFavorite:!0,timestamp:Date.now()};console.log("addOrUpdateFavorite: Adding new entry:",c),r.unshift(c)}Et(r),a||f.handleMessage(`"${n}" saved as favorite.`),Zt()}catch(r){console.error("addOrUpdateFavorite: Error:",r)}finally{zn=!1,console.log("addOrUpdateFavorite: Completed")}}function Vl(t,e,n,a){let r=Ne();const o=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5)),l=r.find(c=>Math.abs(c.lat-o)<1e-4&&Math.abs(c.lng-s)<1e-4);l&&(l.isFavorite=a),Et(r),Zt(),f.handleMessage(`"${n}" removed from favorites.`)}function jl(t,e){if(console.log("removeLocationFromHistory: Removing:",{lat:t,lng:e}),isNaN(t)||isNaN(e)){console.error("removeLocationFromHistory: Invalid coordinates");return}const a=Ne().filter(r=>{const o=parseFloat(r.lat),s=parseFloat(r.lng||r.lon);return Math.abs(o-t)>.001||Math.abs(s-e)>.001});Et(a),f.handleMessage("Location deleted."),Zt()}function Ne(){console.log("getCoordHistory: Retrieving history");try{const t=JSON.parse(localStorage.getItem("coordHistory"))||[];return console.log("getCoordHistory: History retrieved:",t),t}catch(t){return console.error("getCoordHistory: Error retrieving history:",t),[]}}function Et(t){console.log("saveCoordHistory: Saving history:",t);try{localStorage.setItem("coordHistory",JSON.stringify(t)),console.log("saveCoordHistory: History saved")}catch(e){console.error("saveCoordHistory: Error saving history:",e)}}function Bo(t){console.log("parseQueryAsCoordinates: Parsing query:",t);const e=t.trim(),a=e.replace(/[,;\t]+/g," ").trim().match(/^(-?\d{1,3}(?:\.\d+)?)\s+(-?\d{1,3}(?:\.\d+)?)$/);if(a){console.log("parseQueryAsCoordinates: Regex match:",a);const s=parseFloat(a[1]),l=parseFloat(a[2]);if(console.log("parseQueryAsCoordinates: Decimal degrees detected:",{lat:s,lng:l}),!isNaN(s)&&!isNaN(l)&&s>=-90&&s<=90&&l>=-180&&l<=180)return{lat:s,lng:l};console.warn("parseQueryAsCoordinates: Invalid coordinate ranges:",{lat:s,lng:l})}const r=e.replace(/\s/g,"").toUpperCase(),o=/^[0-9]{1,2}[C-HJ-NP-X][A-HJ-NP-Z]{2}(\d{2}|\d{4}|\d{6}|\d{8}|\d{10})$/;if(typeof ml>"u")return console.warn("parseQueryAsCoordinates: MGRS library not loaded"),null;if(o.test(r))try{const[s,l]=Ma(r);if(console.log("parseQueryAsCoordinates: MGRS detected:",{lat:l,lng:s}),!isNaN(l)&&!isNaN(s))return{lat:l,lng:s};console.warn("parseQueryAsCoordinates: Invalid MGRS coordinates:",{lat:l,lng:s})}catch(s){return console.warn("parseQueryAsCoordinates: MGRS parsing failed:",s.message),null}return console.log("parseQueryAsCoordinates: No coordinates detected"),null}function Zt(){console.log("_dispatchFavoritesUpdate: Dispatching event");const e=Ne().filter(a=>a.isFavorite),n=new CustomEvent("favorites:updated",{detail:{favorites:e},bubbles:!0,cancelable:!0});document.dispatchEvent(n),console.log("_dispatchFavoritesUpdate: Event dispatched")}let tn=0;async function Jl(){return console.log("MapManager: Starte Karteninitialisierung..."),await ql(),console.log("MapManager: Karteninitialisierung abgeschlossen."),i.map}async function ql(){if(i.ismapInitialized||i.map){console.warn("Map already initialized or init in progress.");return}i.ismapInitialized=!0,console.log("initMap started...");const t=Te.DEFAULT_MAP_CENTER,e=Te.DEFAULT_MAP_ZOOM;hc(t,e),i.jumpVisualizationLayerGroup=L.layerGroup().addTo(i.map),i.landingPatternLayerGroup=L.layerGroup().addTo(i.map),i.jumpRunTrackLayerGroup=L.layerGroup().addTo(i.map),i.favoritesLayerGroup=L.layerGroup().addTo(i.map),console.log("Favorite marker layer added!"),i.poiLayerGroup=L.layerGroup().addTo(i.map),console.log("POI marker layer added!"),wc(),fc(),vc(),gc(t),Mc(),Promise.all([pc(),_c(t,e)]).then(()=>{console.log("Initial tile caching and geolocation promise resolved.")}).catch(n=>{console.error("Error during parallel initialization of cache/geolocation:",n)}),sa(),console.log("initMap finished.")}function rn(t){if(Ql(),i.labelZoomListener&&i.map&&(i.map.off("zoomend",i.labelZoomListener),i.labelZoomListener=null),!t||!i.jumpVisualizationLayerGroup)return;const e=[];t.exitCircles&&t.exitCircles.forEach(a=>{const r=L.circle(a.center,{radius:a.radius,color:a.color,fillColor:a.fillColor,fillOpacity:a.fillOpacity,weight:a.weight||2,pmIgnore:!0}).addTo(i.jumpVisualizationLayerGroup);a.tooltip&&r.bindTooltip(a.tooltip,{direction:"top",offset:[0,0],className:"wind-tooltip"})}),t.canopyCircles&&t.canopyCircles.forEach(a=>{L.circle(a.center,{...a,pmIgnore:!0}).addTo(i.jumpVisualizationLayerGroup)});function n(a,r){const o=L.latLng(a[0],a[1]),l=r/6378137*(180/Math.PI),c=L.latLng(a[0]+l,a[1]),u=i.map.latLngToLayerPoint(o),d=i.map.latLngToLayerPoint(c);return[25,u.y-d.y+10]}if(t.canopyLabels){const a=i.map.getZoom();t.canopyLabels.forEach(r=>{const o=a<=11,s=L.marker(r.center,{icon:L.divIcon({className:`isoline-label ${o?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${o?"8px":"10px"}">${r.text}</span>`,iconSize:o?[50,12]:[60,14],iconAnchor:n(r.center,r.radius),pmIgnore:!0}),zIndexOffset:2100}).addTo(i.jumpVisualizationLayerGroup);e.push({marker:s,center:r.center,radius:r.radius,text:r.text,pmIgnore:!0})})}e.length>0&&(i.labelZoomListener=function(){const r=i.map.getZoom()<=11;e.forEach(o=>{o.marker.setIcon(L.divIcon({className:`isoline-label ${r?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${r?"8px":"10px"}">${o.text}</span>`,iconSize:r?[50,12]:[60,14],iconAnchor:n(o.center,o.radius)}))})},i.map.on("zoomend",i.labelZoomListener))}function It(t){ec(),t&&(t.legs.forEach(e=>{L.polyline(e.path,{color:"red",weight:3,opacity:.8,dashArray:"5, 10",pmIgnore:!0}).addTo(i.landingPatternLayerGroup)}),t.arrows.forEach(e=>{const n=ic(e.position[0],e.position[1],e.bearing,e.color);L.marker(e.position,{icon:n,pmIgnore:!0}).addTo(i.landingPatternLayerGroup).bindTooltip(e.tooltipText,{offset:[10,0],direction:"right",className:"wind-tooltip",pmIgnore:!0})}))}function Ft(t){var o,s,l,c;if(tc(),!i.jumpRunTrackLayerGroup){console.error("drawJumpRunTrack called before jumpRunTrackLayerGroup was initialized.");return}if(!t)return;if(!((s=(o=t.path)==null?void 0:o.latlngs)!=null&&s.length)||!((l=t.airplane)!=null&&l.position)){console.warn("Invalid trackData structure:",t);return}const e=L.polyline(t.path.latlngs,t.path.options).bindTooltip(t.path.tooltipText).addTo(i.jumpRunTrackLayerGroup);let n=null;(c=t.approachPath)!=null&&c.latlngs&&(n=L.polyline(t.approachPath.latlngs,t.approachPath.options).bindTooltip(t.approachPath.tooltipText).addTo(i.jumpRunTrackLayerGroup));const a=L.icon({iconUrl:Sn.AIRPLANE_MARKER,iconSize:[32,32],iconAnchor:[16,16],shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[13,32]}),r=L.marker(t.airplane.position,{icon:a,rotationAngle:t.airplane.bearing,rotationOrigin:"center center",draggable:!g.state.userSettings.isInteractionLocked,zIndexOffset:2e3,pmIgnore:!0}).bindTooltip("Drag to move Jump Run Track").addTo(i.jumpRunTrackLayerGroup);r.on("mousedown",()=>{g.state.userSettings.isInteractionLocked&&Ye("Interaction is locked. Please unlock to move points."),i.map.dragging.disable()}),r.on("mouseup",()=>i.map.dragging.enable()),r.on("drag",u=>{var b;const d=u.target.getLatLng(),m=t.airplane.originalPosition;if(!m||!Number.isFinite(m.lat)||!Number.isFinite(m.lng)){console.warn("Invalid originalPosition:",m);return}const p=d.lat-m.lat,h=d.lng-m.lng;if(!Number.isFinite(p)||!Number.isFinite(h)){console.warn("Invalid delta values:",{deltaLat:p,deltaLng:h});return}const v=t.path.originalLatLngs.map(w=>[Number.isFinite(w[0])?w[0]+p:w[0],Number.isFinite(w[1])?w[1]+h:w[1]]);if(e.setLatLngs(v),n&&((b=t.approachPath)!=null&&b.originalLatLngs)){const w=t.approachPath.originalLatLngs.map(M=>[Number.isFinite(M[0])?M[0]+p:M[0],Number.isFinite(M[1])?M[1]+h:M[1]]);n.setLatLngs(w)}}),r.on("dragstart",u=>{g.state.userSettings.isInteractionLocked&&(u.target.dragging.disable(),Ye("Interaction is locked. Please unlock to move points."))}),r.on("dragend",u=>{const d=u.target.getLatLng();if(!Number.isFinite(d.lat)||!Number.isFinite(d.lng)){console.warn("Invalid new position in dragend:",d);return}const m=new CustomEvent("track:dragend",{detail:{newPosition:d,originalTrackData:t},bubbles:!0});i.map.getContainer().dispatchEvent(m)})}function la(t){i.cutAwayCircle&&(i.map.removeLayer(i.cutAwayCircle),i.cutAwayCircle=null),t&&(i.cutAwayCircle=L.circle(t.center,{radius:t.radius,color:"purple",fillColor:"purple",fillOpacity:.2,weight:2,pmIgnore:!0}).addTo(i.map),i.cutAwayCircle.bindTooltip(t.tooltipContent,{permanent:!1,direction:"center",className:"cutaway-tooltip"}))}function Kl(t,e){const n=[[t.lat,t.lng],[e.lat,e.lng]];i.jumpMasterLine?i.jumpMasterLine.setLatLngs(n):i.jumpMasterLine=L.polyline(n,{color:"blue",weight:3,dashArray:"5, 5"}).addTo(i.map)}function Yl(t){if(yc(),i.terrainWarningLayer.clearLayers(),!t||t.length<3)return;const e=f.getConvexHull(t.map(a=>[a.lat,a.lng])),n=g.getValue("terrainClearance",100);L.polygon(e,{color:"red",fillColor:"#f03",fillOpacity:.5,weight:2,pmIgnore:!0}).bindTooltip(`WARNING: Ground clearance in this area may be less than ${n}m!`,{sticky:!0,className:"cutaway-tooltip"}).addTo(i.terrainWarningLayer)}function Xl(t){if(!i.map||t.length<2)return;const e={color:"#007bff",weight:3,opacity:.7,pmIgnore:!0};i.aircraftTrackLayer?i.aircraftTrackLayer.setLatLngs(t):i.aircraftTrackLayer=L.polyline(t,e).addTo(i.map)}function Ql(){i.map&&i.jumpVisualizationLayerGroup&&i.map.removeLayer(i.jumpVisualizationLayerGroup),i.jumpVisualizationLayerGroup=L.layerGroup().addTo(i.map)}function ec(){i.landingPatternLayerGroup&&i.landingPatternLayerGroup.clearLayers()}function tc(){i.map&&i.jumpRunTrackLayerGroup&&i.map.removeLayer(i.jumpRunTrackLayerGroup),i.jumpRunTrackLayerGroup=L.layerGroup().addTo(i.map)}function nc(){i.cutAwayMarker&&(i.map.removeLayer(i.cutAwayMarker),i.cutAwayMarker=null),la(null)}function ac(){i.jumpMasterLine&&(i.map.removeLayer(i.jumpMasterLine),i.jumpMasterLine=null)}function rc(){if(!i.map){console.warn("Map not initialized, cannot clear HARP marker"),f.handleMessage("Map not initialized, cannot clear HARP marker.");return}i.harpMarker&&(i.map.removeLayer(i.harpMarker),i.harpMarker=null,console.log("Removed HARP marker")),g.state.userSettings.harpLat=null,g.state.userSettings.harpLng=null,g.save();const t=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');if(t&&(t.disabled=!0,console.log("Disabled HARP radio button")),g.state.userSettings.jumpMasterLineTarget==="HARP"&&g.state.userSettings.showJumpMasterLine){i.jumpMasterLine&&(i.map.removeLayer(i.jumpMasterLine),i.jumpMasterLine=null,console.log("Removed Jump Master Line: HARP marker cleared")),g.state.userSettings.jumpMasterLineTarget="DIP";const e=document.querySelector('input[name="jumpMasterLineTarget"][value="DIP"]');e&&(e.checked=!0,console.log("Switched Jump Master Line to DIP")),g.save(),i.liveMarker&&i.currentMarker&&i.lastLat!==null&&i.lastLng!==null&&debouncedPositionUpdate({coords:{latitude:i.lastLatitude,longitude:i.lastLongitude,accuracy:i.lastAccuracy,altitude:i.lastDeviceAltitude,altitudeAccuracy:i.lastAltitudeAccuracy}})}f.handleMessage("HARP marker cleared")}function oc(){i.terrainWarningLayer&&(i.terrainWarningLayer.clearLayers(),console.log("Terrain warning layer cleared."))}function wr(){i.aircraftTrackLayer&&(i.map.removeLayer(i.aircraftTrackLayer),i.aircraftTrackLayer=null)}function ic(t,e,n,a){const r=(n+360)%360,o=`
        <svg width="40" height="20" viewBox="0 0 40 20" xmlns="http://www.w3.org/2000/svg">
            <line x1="0" y1="10" x2="30" y2="10" stroke="${a}" stroke-width="4" />
            <polygon points="30,5 40,10 30,15" fill="${a}" />
        </svg>
    `;return L.divIcon({html:`<div style="transform-origin: center; transform: rotate(${r}deg);">${o}</div>`,className:"wind-arrow-icon",iconSize:[40,20],iconAnchor:[20,10]})}function sc(t,e){const n=L.icon({iconUrl:Sn.CUTAWAY_MARKER,iconSize:[25,25],iconAnchor:[12,12],popupAnchor:[0,-12],pmIgnore:!0});return L.marker([t,e],{icon:n,draggable:!g.state.userSettings.isInteractionLocked,pmIgnore:!0})}function lc(t){t.on("mousedown",()=>{g.state.userSettings.isInteractionLocked&&Ye("Interaction is locked. Please unlock to move points.")}),t.on("dragend",e=>{const n=t.getLatLng();i.cutAwayLat=n.lat,i.cutAwayLng=n.lng,zo(t,i.cutAwayLat,i.cutAwayLng);const a=new CustomEvent("cutaway:marker_placed",{bubbles:!0});i.map.getContainer().dispatchEvent(a)})}function zo(t,e,n,a=!1){const r=g.getValue("coordFormat","radio","Decimal");f.convertCoords(e,n,r);let o="<b>Cut-Away Start</b><br>";const s=c=>`${c.deg}° ${c.min.toFixed(3)}' ${c.dir}`,l=c=>`${c.deg}°${c.min}'${c.sec.toFixed(0)}" ${c.dir}`;r==="MGRS"?o+=`MGRS: ${f.decimalToMgrs(e,n)}`:r==="DMS"?o+=`Lat: ${l(f.decimalToDms(e,!0))}<br>Lng: ${l(f.decimalToDms(n,!1))}`:r==="DDM"?o+=`Lat: ${s(f.decimalToDecimalMinutes(e,!0))}<br>Lng: ${s(f.decimalToDecimalMinutes(n,!1))}`:o+=`Lat: ${e.toFixed(5)}<br>Lng: ${n.toFixed(5)}`,Aa(t,o,a)}async function _n(t,e){if(console.log("MapManager: Befehl erhalten, Marker zu erstellen/bewegen bei",t,e),typeof t!="number"||typeof e!="number"||t<-90||t>90||e<-180||e>180){console.error("MapManager: Ungültige Koordinaten:",{lat:t,lng:e});return}const n=await f.getAltitude(t,e);if(i.currentMarker)console.log("MapManager: Marker existiert, bewege ihn jetzt mit setLatLng."),i.currentMarker.setLatLng([t,e]);else{console.log("MapManager: Kein Marker vorhanden, erstelle einen neuen.");const r=cc(t,e);uc(r),i.currentMarker=r,i.currentMarker.addTo(i.map)}const a=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${n} m`;Aa(i.currentMarker,a),i.lastLat=t,i.lastLng=e,i.lastAltitude=n,i.map.invalidateSize()}function cc(t,e){const n=L.icon({iconUrl:Sn.DEFAULT_MARKER,iconSize:[32,32],iconAnchor:[16,20],popupAnchor:[0,-32],pmIgnore:!0});return L.marker([t,e],{icon:n,draggable:!g.state.userSettings.isInteractionLocked,pmIgnore:!0})}function uc(t){t.on("mousedown",()=>{g.state.userSettings.isInteractionLocked&&Ye("Interaction is locked. Please unlock to move points.")}),t.on("dragend",e=>{const n=t.getLatLng(),a=new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lng,source:"marker_drag"},bubbles:!0});i.map.getContainer().dispatchEvent(a)})}function Aa(t,e,n=!1){var r;if(!t)return;const a=((r=t.getPopup())==null?void 0:r.isOpen())||n;t.unbindPopup().bindPopup(e),a&&t.openPopup()}function Go(t){if(!i.map||!i.favoritesLayerGroup){console.warn("Cannot update favorite markers: map or layer group not ready.");return}if(i.favoritesLayerGroup.clearLayers(),!t||t.length===0)return;const e=L.divIcon({html:"★",className:"favorite-marker-icon",iconSize:[24,24],iconAnchor:[12,12]});t.forEach(n=>{const a=L.marker([n.lat,n.lng],{icon:e,pmIgnore:!0}).bindTooltip(n.label,{permanent:!1,direction:"top"}).on("click",()=>{document.dispatchEvent(new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lng,source:"favorite_marker"},bubbles:!0}))});i.favoritesLayerGroup.addLayer(a)})}function ca(t){if(g.state.userSettings.isInteractionLocked){Ye("Interaction is locked. Please unlock to move points."),i.isPlacingHarp=!1,i.map.off("click",ca);return}if(!i.isPlacingHarp)return;const{lat:e,lng:n}=t.latlng;i.harpMarker?i.harpMarker.setLatLng([e,n]):i.harpMarker=Zo(e,n).addTo(i.map),g.state.userSettings.harpLat=e,g.state.userSettings.harpLng=n,g.state.userSettings.jumpRunTrackOffset=0,g.state.userSettings.jumpRunTrackForwardOffset=0,console.log("HARP placed. JRT offsets reset to 0."),g.save(),i.isPlacingHarp=!1,i.map.off("click",ca);const a=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');a&&(a.disabled=!1),document.dispatchEvent(new CustomEvent("ui:recalculateJump")),document.dispatchEvent(new CustomEvent("harp:updated"))}function Zo(t,e){return L.marker([t,e],{icon:L.divIcon({className:"harp-marker",html:'<div style="width: 14px; height: 14px; background-color: green; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 6px rgba(0,0,0,0.6);"></div>',iconSize:[20,20],iconAnchor:[10,10]}),pane:"markerPane",pmIgnore:!0})}function dc(t){if(!i.map||!i.poiLayerGroup){console.warn("Cannot update POI markers: map or layer group not ready.");return}if(i.poiLayerGroup.clearLayers(),!t||t.length===0)return;const e=L.divIcon({html:"🪂",className:"poi-marker-icon",iconSize:[24,24],iconAnchor:[12,12]});t.forEach(n=>{const a=L.marker([n.lat,n.lon],{icon:e,pmIgnore:!0}).bindTooltip(n.display_name,{permanent:!1,direction:"top"}).on("click",()=>{document.dispatchEvent(new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lon,source:"poi_marker"},bubbles:!0}))});i.poiLayerGroup.addLayer(a)})}function mc(t,e,n){const a=L.icon({iconUrl:Sn.LIVEPLANE_MARKER,iconSize:[32,32],iconAnchor:[16,16]}),r=L.marker([t,e],{icon:a,rotationAngle:n,rotationOrigin:"center center",zIndexOffset:1500,pmIgnore:!0}).addTo(i.map);return i.aircraftMarker=r,r}function hc(t,e){i.lastLat=i.lastLat||t[0],i.lastLng=i.lastLng||t[1],i.map=L.map("map",{center:t,zoom:e,zoomControl:!1,doubleClickZoom:!1,maxZoom:19,minZoom:navigator.onLine?6:11}),console.log("Map instance created.")}function fc(){if(!i.map){console.error("Karte nicht initialisiert, bevor Controls hinzugefügt werden können.");return}L.control.layers(i.baseMaps,null,{position:"topright"}).addTo(i.map),i.map.on("baselayerchange",function(t){g&&g.state&&g.state.userSettings&&(g.state.userSettings.baseMaps=t.name,g.save()),i.hasTileErrorSwitched=!1,i.lastLat&&i.lastLng&&typeof cacheTilesForDIP=="function"&&cacheTilesForDIP({map:i.map,lastLat:i.lastLat,lastLng:i.lastLng,baseMaps:i.baseMaps})}),L.control.zoom({position:"topright"}).addTo(i.map),L.control.scale({position:"bottomleft",metric:!0,imperial:!1,maxWidth:100}).addTo(i.map),i.map.pm.addControls({position:"topright",drawMarker:!0,drawCircleMarker:!1,drawPolyline:!0,drawPolygon:!1,drawRectangle:!1,drawCircle:!0,cutPolygon:!1,editMode:!0,dragMode:!0,removalMode:!0,rotateMode:!1}),i.map.pm.setLang("en"),it()&&(i.map.pm.setGlobalOptions({hintlineStyle:{opacity:0,color:"green"}}),console.log("Geoman global options set for mobile to hide helper lines.")),console.log("Standard map controls including Geoman have been added.")}async function gc(t,e){console.log("MapManager: Initialisiere den Standard-Marker..."),await _n(t[0],t[1]),i.isManualPanning=!1,console.log("Default marker initialized using the new standard method.")}async function pc(){try{if(await ge.init(),await ge.migrateTiles(),await ge.getCacheSize()>500){const e=await ge.clearOldTiles(3);f.handleMessage(`Cleared ${e.deletedCount} old tiles: ${e.deletedSizeMB.toFixed(2)} MB freed.`)}else await ge.clearOldTiles()}catch(t){console.error("Failed to initialize or manage tile cache:",t),f.handleError("Tile caching setup failed.")}console.log("Tile cache logic initialized.")}function yc(){i.terrainWarningLayer||(i.terrainWarningLayer=L.layerGroup().addTo(i.map))}function wc(){i.baseMaps={OpenStreetMap:L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}),OpenTopoMap:L.tileLayer.cached("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,attribution:'© <a href="https://www.openstreetmap.org/copyright">OSM</a>, <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)',subdomains:["a","b","c"]}),"Esri Street":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Topo":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Satellite":L.layerGroup([L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19}),L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© EsriEsri, USDA, USGS © OpenStreetMap contributors, and the GIS user community",pane:"shadowPane"})]),"Esri Satellite + OSM":L.layerGroup([L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USDA, USGS",zIndex:1}),L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',opacity:.5,zIndex:2,updateWhenIdle:!0,keepBuffer:2,subdomains:["a","b","c"]})],{attribution:'© Esri, USDA, USGS | © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),"OpenTopoMap + Airspaces":L.layerGroup([L.tileLayer.cached("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)',subdomains:["a","b","c"]}),L.tileLayer.cached("https://nwy-tiles-api.prod.newaydata.com/tiles/{z}/{x}/{y}.png?path=latest/aero/latest",{maxZoom:19,attribution:'© <a href="https://www.openflightmaps.org">openflightmaps.org</a>',opacity:.5,zIndex:2,updateWhenIdle:!0,keepBuffer:2,subdomains:["a","b","c"]})],{attribution:'© Esri, USDA, USGS | © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),"Open Flight Map":L.tileLayer.cached("https://nwy-tiles-api.prod.newaydata.com/tiles/{z}/{x}/{y}.png?path=latest/aero/latest",{maxZoom:19,attribution:'© <a href="https://www.openflightmaps.org">openflightmaps.org</a>'}),"OpenTopoMap + OpenSeaMap":L.layerGroup([L.tileLayer.cached("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)',subdomains:["a","b","c"]}),L.tileLayer.cached("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:'Map data: © <a href="http://www.openseamap.org">OpenSeaMap</a> contributors',opacity:.8,zIndex:2})],{attribution:'© Esri, USDA, USGS | © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),OpenSeaMap:L.tileLayer.cached("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:'Map data: © <a href="http://www.openseamap.org">OpenSeaMap</a> contributors'})},i.map&&i.map.attributionControl&&i.map.attributionControl.addAttribution('Weather data by <a href="https://open-meteo.com">Open-Meteo</a>');const e=g.state.userSettings.baseMaps in i.baseMaps?g.state.userSettings.baseMaps:"Esri Street",n=i.baseMaps[e];n&&typeof n.on=="function"?(n.on("tileerror",()=>{if(!navigator.onLine){i.hasTileErrorSwitched||(console.warn(`${e} tiles unavailable offline. Zoom restricted.`),f.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."),i.hasTileErrorSwitched=!0);return}if(!i.hasTileErrorSwitched&&i.map.hasLayer(n)){const a="OpenStreetMap";console.warn(`${e} tiles unavailable, switching to ${a}`),i.map.removeLayer(n),i.baseMaps[a].addTo(i.map),g.state.userSettings.baseMaps=a,g.save(),f.handleMessage(`${e} tiles unavailable. Switched to ${a}.`),i.hasTileErrorSwitched=!0}else i.hasTileErrorSwitched||console.warn(`Tile error in ${e}, attempting to continue.`)}),n.addTo(i.map)):(console.error(`Default base map "${e}" could not be added.`),i.baseMaps.OpenStreetMap.addTo(i.map)),i.map&&i.map.invalidateSize(),window.addEventListener("online",()=>{i.hasTileErrorSwitched=!1,i.map&&(i.map.options.minZoom=6),sa()}),window.addEventListener("offline",()=>{i.map&&(i.map.options.minZoom=9),sa()}),console.log("Base layers and online/offline handlers set up.")}function vc(){i.map.createPane("gpxTrackPane"),i.map.getPane("gpxTrackPane").style.zIndex=650,i.map.getPane("tooltipPane").style.zIndex=700,i.map.getPane("popupPane").style.zIndex=700,console.log("Custom map panes created.")}function Lc(){const t=i.map;if(!t){console.log("No map available");return}console.log("Leaflet-Geoman Version:",L.PM.version);const e=document.querySelector(".leaflet-pm-toolbar");e&&["click","dblclick","mousedown","mouseup","touchstart","touchend","pointerdown","pointerup","contextmenu"].forEach(v=>{e.addEventListener(v,b=>{L.DomEvent.stopPropagation(b),console.log(`Stopped '${b.type}' event on Geoman toolbar.`)})});const n=L.DomUtil.create("div","leaflet-measure-label",t.getContainer()),a=L.layerGroup().addTo(t);let r=null,o=null,s=null,l=!1;function c(h,v){const b=h[v],w=v>0?h[v-1]:null;if(!w)return;const M=v<h.length-1?h[v+1]:null,y=f.calculateBearing(w.lat,w.lng,b.lat,b.lng),_=w.distanceTo(b),S=_<1e3?`${_.toFixed(0)} m`:`${(_/1e3).toFixed(2)} km`;let E=0;for(let D=1;D<=v;D++)E+=h[D-1].distanceTo(h[D]);const k=E<1e3?`${E.toFixed(0)} m`:`${(E/1e3).toFixed(2)} km`,A=M?`${f.calculateBearing(b.lat,b.lng,M.lat,M.lng).toFixed(0)}°`:"---",T=`
            <div class="geoman-permanent-label">
                <div>In: ${y.toFixed(0)}°</div>
                <div>Out: ${A}</div>
                <div>+: ${S}</div>
                <div>∑: ${k}</div>
            </div>
        `;L.marker(b,{icon:L.divIcon({className:"geoman-label-container",html:T,iconAnchor:[-5,-5]}),pmIgnore:!0}).addTo(a)}function u(h){const v=h.getLatLng(),b=h.getRadius(),M=`<div class="geoman-permanent-label">Radius:<br> ${b<1e3?`${b.toFixed(0)} m`:`${(b/1e3).toFixed(2)} km`}</div>`,y=L.marker(v,{icon:L.divIcon({className:"geoman-label-container",html:M,iconAnchor:[0,0]}),pmIgnore:!0});y.addTo(a),h.permanentLabel=y}function d(h){if(!h||!(h instanceof L.Polyline))return;a.clearLayers();const v=h.getLatLngs();Array.isArray(v[0])?v.forEach(b=>{b.forEach((w,M)=>c(b,M))}):v.forEach((b,w)=>c(v,w)),r=JSON.stringify(v),s=h}function m(h){!h||!(h instanceof L.Circle)||(h.permanentLabel&&a.removeLayer(h.permanentLabel),u(h))}function p(){setInterval(()=>{if(s){if(s instanceof L.Polyline)JSON.stringify(s.getLatLngs())!==r&&d(s);else if(s instanceof L.Circle){const h=JSON.stringify({center:s.getLatLng(),radius:s.getRadius()});h!==o&&(m(s),o=h)}}},500)}p(),t.on("pm:drawstart",h=>{l=!1;const v=h.workingLayer;a.clearLayers(),n.style.display="block";let b,w,M,y,_;if(h.shape==="Line")if(it()){n.innerHTML="Tap to set first point.";let E=null,k=null;y=()=>{const A=v.getLatLngs();if(A.length>0){E=A[A.length-1];const T=t.getCenter();k&&t.removeLayer(k),k=L.polyline([E,T],{color:" #3388ff",dashArray:"5, 5",weight:3,interactive:!1}).addTo(t);const N=E.distanceTo(T),D=f.calculateBearing(E.lat,E.lng,T.lat,T.lng),x=N<1e3?`${N.toFixed(0)} m`:`${(N/1e3).toFixed(2)} km`;n.innerHTML=`In: ${D.toFixed(0)}°<br>Out: ---°<br>+: ${x}`;const C=t.getSize(),I=L.point(C.x/2+20,C.y/2-40);L.DomUtil.setPosition(n,I)}else k&&(t.removeLayer(k),k=null),n.innerHTML="Tap to set first point."},w=()=>{k&&(t.removeLayer(k),k=null),setTimeout(()=>{d(v),t.fire("move")},50)},M=()=>{setTimeout(()=>{d(v),t.fire("move")},50)},t.on("move",y),v.on("pm:vertexadded",w),v.on("pm:vertexremoved",M),_=()=>{t.off("move",y),v.off("pm:vertexadded",w),v.off("pm:vertexremoved",M),k&&(t.removeLayer(k),k=null)}}else n.innerHTML="Click to set the first point.",b=E=>{const k=v.getLatLngs();if(k.length>0){const A=k[k.length-1],T=A.distanceTo(E.latlng),N=f.calculateBearing(A.lat,A.lng,E.latlng.lat,E.latlng.lng),D=T<1e3?`${T.toFixed(0)} m`:`${(T/1e3).toFixed(2)} km`;n.innerHTML=`In: ${N.toFixed(0)}°<br>Out: ---°<br>+: ${D}`,L.DomUtil.setPosition(n,E.containerPoint.add([15,-15]))}},w=()=>{setTimeout(()=>d(v),50)},M=()=>{setTimeout(()=>{d(v)},50)},t.on("mousemove",b),v.on("pm:vertexadded",w),v.on("pm:vertexremoved",M),_=()=>{t.off("mousemove",b),v.off("pm:vertexadded",w),v.off("pm:vertexremoved",M)};else if(h.shape==="Circle")if(it()){n.innerHTML="";const E=t.getSize(),k=L.point(E.x/2,E.y/2-40);L.DomUtil.setPosition(n,k);let A=!1;y=()=>{if(A){const T=v.getLatLng();if(T){const N=t.getCenter(),D=T.distanceTo(N);v.setRadius(D);const x=D<1e3?`${D.toFixed(0)} m`:`${(D/1e3).toFixed(2)} km`;n.innerHTML=`Radius: ${x}`;const C=t.getSize(),I=L.point(C.x/2,C.y/2-40);L.DomUtil.setPosition(n,I)}}},w=()=>{if(A)S(),m(v),s=v,o=JSON.stringify({center:v.getLatLng(),radius:v.getRadius()});else{A=!0,n.innerHTML="Move map to adjust radius. Tap again to finish.";const T=t.getSize(),N=L.point(T.x/2,T.y/2-40);L.DomUtil.setPosition(n,N),t.on("move",y)}},v.on("pm:vertexadded",w),_=()=>{t.off("move",y),v.off("pm:vertexadded",w),A=!1,n.style.display="none"}}else n.innerHTML="Click and drag to draw a circle.",b=E=>{const k=v.getLatLng();if(k){const A=k.distanceTo(E.latlng),T=A<1e3?`${A.toFixed(0)} m`:`${(A/1e3).toFixed(2)} km`;n.innerHTML=`Radius: ${T}`,L.DomUtil.setPosition(n,E.containerPoint.add([15,-15]))}},t.on("mousemove",b),_=()=>t.off("mousemove",b);const S=()=>{_&&_(),n.style.display="none"};t.once("pm:create",E=>{l=!0,S(),E.shape==="Line"&&E.layer instanceof L.Polyline?d(E.layer):E.shape==="Circle"&&E.layer instanceof L.Circle&&(m(E.layer),s=E.layer,o=JSON.stringify({center:E.layer.getLatLng(),radius:E.layer.getRadius()})),E.layer.pm&&E.layer.pm.enable()}),t.once("pm:drawend",()=>{l||(console.log("Drawing was cancelled, cleaning up visuals."),S(),a.clearLayers())})}),t.on("pm:edit",h=>{if(h.shape==="Line"&&h.layer instanceof L.Polyline)setTimeout(()=>d(h.layer),300);else if(h.shape==="Circle"&&h.layer instanceof L.Circle){if(it()){n.style.display="block";const v=h.layer.getRadius(),b=v<1e3?`${v.toFixed(0)} m`:`${(v/1e3).toFixed(2)} km`;n.innerHTML=`Radius: ${b}`;const w=t.getSize(),M=L.point(w.x/2,w.y/2-40);L.DomUtil.setPosition(n,M)}setTimeout(()=>{m(h.layer),s=h.layer,o=JSON.stringify({center:h.layer.getLatLng(),radius:h.layer.getRadius()})},300)}}),t.on("pm:editend",()=>{it()&&(n.style.display="none")}),t.on("pm:remove",h=>{a.clearLayers(),o=null,r=null,s=null,n.style.display="none"})}function Mc(){if(!i.map){console.error("Karte nicht initialisiert in _setupCoreMapEventHandlers");return}if(!i.coordsControl){const e={enableUserInput:!1};i.coordsControl=new L.Control.Coordinates(e),i.coordsControl.addTo(i.map)}it()?bc(i.map):Sc(i.map),i.map.on("dblclick",Gn),i.map.on("zoomstart",e=>{if(!navigator.onLine){const n=e.target._zoom||i.map.getZoom();n<11?(e.target._zoom=11,i.map.setZoom(11),f.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles.")):n>14&&(e.target._zoom=14,i.map.setZoom(14),f.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."))}}),i.map.on("zoomend",()=>{const e=i.map.getZoom(),n=new CustomEvent("map:zoomend",{detail:{zoom:e},bubbles:!0,cancelable:!0});if(i.map.getContainer().dispatchEvent(n),i.jumpRunTrackLayer&&g.state.userSettings.showJumpRunTrack){const a=i.jumpRunTrackLayer.getLayers().find(r=>{var o;return((o=r.options.icon)==null?void 0:o.options.className)==="jrt-anchor-marker"});if(a){const r=e<=11?10:e<=12?12:e<=13?14:16;a.setIcon(L.divIcon({className:"jrt-anchor-marker",html:`<div style="background-color: orange; width: ${r}px; height: ${r}px; border-radius: 50%; border: 2px solid white; opacity: 0.8;"></div>`,iconSize:[r,r],iconAnchor:[r/2,r/2],tooltipAnchor:[0,-(r/2+5)]}))}}}),i.map.on("movestart",e=>{e.target===i.map&&(!e.originalEvent||e.originalEvent.target===i.map.getContainer())&&(i.isManualPanning=!0,console.log("Manual map panning detected."))}),i.map.on("contextmenu",e=>{if(g.state.userSettings.isInteractionLocked){Ye("Interaction is locked. Please unlock to place a new DIP.");return}const{lat:n,lng:a}=e.latlng;console.log('MapManager: Rechtsklick/Langes Drücken erkannt. Sende "location:selected"-Event.');const r=new CustomEvent("location:selected",{detail:{lat:n,lng:a,source:"contextmenu"},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(r)});const t=i.map.getContainer();t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-tn;if(a<300&&a>0){e.preventDefault();const o=t.getBoundingClientRect(),s=e.touches[0].clientX-o.left,l=e.touches[0].clientY-o.top,c=i.map.containerPointToLatLng([s,l]);await Gn({latlng:c,containerPoint:L.point(s,l),layerPoint:i.map.latLngToLayerPoint(c)})}tn=n},{passive:!1}),i.map.on("click",e=>{}),i.map.on("mousedown",e=>{}),t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-tn;if(a<300&&a>0){e.preventDefault();const o=t.getBoundingClientRect(),s=e.touches[0].clientX-o.left,l=e.touches[0].clientY-o.top,c=i.map.containerPointToLatLng([s,l]);await Gn({latlng:c,containerPoint:L.point(s,l),layerPoint:i.map.latLngToLayerPoint(c)})}tn=n},{passive:!1}),Lc(),console.log("All core map event handlers have been set up.")}function bc(t){const e=()=>{const n=t.getCenter(),a=g.getValue("coordFormat","Decimal"),r=f.convertCoords(n.lat,n.lng,a);let o;const s=c=>`${c.deg}° ${c.min.toFixed(3)}' ${c.dir}`,l=c=>`${c.deg}°${c.min}'${c.sec.toFixed(0)}" ${c.dir}`;a==="MGRS"?o=`MGRS: ${r.lat}`:a==="DMS"?o=`${l(r.lat)}, ${l(r.lng)}`:a==="DDM"?o=`${s(r.lat)}, ${s(r.lng)}`:o=`${n.lat.toFixed(5)}, ${n.lng.toFixed(5)}`,i.coordsControl.update(`${o}<br>Elevation: ...<br>QFE: ...`)};t.on("move",e),setTimeout(()=>t.fire("move"),200),console.log("Crosshair coordinate handler initialized.")}function Sc(t){t.on("mousemove",Tc),t.on("mouseout",function(){i.coordsControl&&i.coordsControl.getContainer()&&(i.coordsControl.getContainer().innerHTML="Move mouse over map")}),console.log("Mouse coordinate handler initialized.")}async function Ec(t,e){const{latitude:n,longitude:a}=t.coords;console.log("MapManager: Geolocation erfolgreich. Sende Event."),i.lastLat=n,i.lastLng=a,i.lastAltitude=await f.getAltitude(n,a),i.map.setView([n,a],e);const r=new CustomEvent("location:selected",{detail:{lat:n,lng:a,source:"geolocation"},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(r)}async function vr(t,e,n){console.warn(`Geolocation error: ${t.message}`);const a=Zl();let r,o,s,l;a?(r=a.lat,o=a.lng,s="home_dz_fallback",l=`Using your saved Home DZ: ${a.label}`):(r=e[0],o=e[1],s="geolocation_fallback",l="Unable to retrieve your location. Using default location."),f.handleMessage(l),await _n(r,o),i.map.setView([r,o],n),fn(!0),i.isManualPanning=!1;const c=new CustomEvent("location:selected",{detail:{lat:r,lng:o,source:s},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(c),console.log(`Dispatched 'location:selected' event from ${s}.`)}async function _c(t,e){navigator.geolocation?navigator.geolocation.getCurrentPosition(n=>Ec(n,e),n=>vr(n,t,e),{enableHighAccuracy:!0,timeout:Te.GEOLOCATION_TIMEOUT_MS,maximumAge:0}):(console.warn("Geolocation not supported."),await vr({message:"Geolocation not supported by this browser."},t,e))}function kc(t){if(!i.map||!i.map.pm)return;const e=document.querySelector(".leaflet-pm-toolbar");t?(e&&(e.style.display="none"),i.map.pm.globalDrawModeEnabled()&&i.map.pm.disableDraw(),i.map.pm.globalEditModeEnabled()&&i.map.pm.disableGlobalEditMode(),i.map.pm.globalRemovalModeEnabled()&&i.map.pm.disableGlobalRemovalMode()):e&&(e.style.display="block")}function Tc(t){const{lat:e,lng:n}=t.latlng;i.lastMouseLatLng={lat:e,lng:n};const a=g.getValue("coordFormat","radio","Decimal");let r;const o=l=>`${l.deg}° ${l.min.toFixed(3)}' ${l.dir}`,s=l=>`${l.deg}°${l.min}'${l.sec.toFixed(0)}" ${l.dir}`;a==="MGRS"?r=`MGRS: ${f.decimalToMgrs(e,n)||"N/A"}`:a==="DMS"?r=`Lat: ${s(f.decimalToDms(e,!0))}, Lng: ${s(f.decimalToDms(n,!1))}`:a==="DDM"?r=`Lat: ${o(f.decimalToDecimalMinutes(e,!0))}, Lng: ${o(f.decimalToDecimalMinutes(n,!1))}`:r=`Lat: ${e.toFixed(5)}, Lng: ${n.toFixed(5)}`,i.coordsControl&&i.coordsControl.update(`${r}<br>Elevation: Fetching...<br>QFE: Fetching...`),f.debouncedGetElevationAndQFE(e,n,({elevation:l})=>{var c,u;if(i.lastMouseLatLng&&i.coordsControl&&Math.abs(i.lastMouseLatLng.lat-e)<.05&&Math.abs(i.lastMouseLatLng.lng-n)<.05){const d=g.getValue("heightUnit","radio","m");let m=l==="N/A"?"N/A":Math.round(f.convertHeight(l,d)),p="N/A";if(l!=="N/A"&&i.weatherData&&i.weatherData.surface_pressure){const h=parseInt((c=document.getElementById("timeSlider"))==null?void 0:c.value)||0,v=i.weatherData.surface_pressure[h],b=((u=i.weatherData.temperature_2m)==null?void 0:u[h])||15,w=i.lastAltitude!=="N/A"?i.lastAltitude:0,M=f.calculateQFE(v,l,w,b);p=M!=="N/A"?`${M} hPa`:"N/A"}i.coordsControl.update(`${r}<br>Elevation: ${m} ${m==="N/A"?"":d}<br>QFE: ${p}`)}})}function Gn(t){if(g.state.userSettings.isInteractionLocked){Ye("Interaction is locked. Please unlock to move points.");return}if(!g.state.userSettings.showCutAwayFinder)return;const{lat:e,lng:n}=t.latlng;i.cutAwayMarker?i.cutAwayMarker.setLatLng([e,n]):(i.cutAwayMarker=sc(e,n).addTo(i.map),lc(i.cutAwayMarker)),i.cutAwayLat=e,i.cutAwayLng=n,zo(i.cutAwayMarker,e,n);const a=new CustomEvent("cutaway:marker_placed",{bubbles:!0});i.map.getContainer().dispatchEvent(a)}function fn(t=!1){i.isManualPanning&&!t||i.map&&i.currentMarker&&i.map.panTo(i.currentMarker.getLatLng())}let Zn=null;function Ac(t,e){const n=document.getElementById("windspinne-chart");if(!n)return;const a=n.getContext("2d"),r=t.map(M=>M.height),o=t.map(M=>M.dir),s=t.map(M=>f.convertWind(M.spd,"m/s","km/h")),l=Math.max(...r),c=Math.min(l,e+i.lastAltitude),u=e,d=M=>M<=5?"blue":M<=10?"green":M<=15?"orange":M<=20?"red":"purple",m=[];for(let M=i.lastAltitude;M<=c;M+=50){const y=M-i.lastAltitude;y>=0&&m.push({r:y,t:f.linearInterpolateAngle(r,o,M),speed:f.linearInterpolate(r,s,M)*1.94384})}const p=[],h=u<=4e3?200:500;for(let M=i.lastAltitude;M<=c;M+=h){const y=M-i.lastAltitude;y>=0&&p.push({r:y,t:f.linearInterpolateAngle(r,o,M),speed:f.linearInterpolate(r,s,M)*1.94384})}const v=M=>M.map(y=>({x:y.r*Math.cos((90-y.t)*Math.PI/180),y:y.r*Math.sin((90-y.t)*Math.PI/180),original:y}));Zn&&Zn.destroy(),Zn=new Chart(a,{type:"scatter",data:{datasets:[{data:v(m),showLine:!0,pointRadius:0,segment:{borderColor:M=>d((M.p0.raw.original.speed+M.p1.raw.original.speed)/2),borderWidth:2.5}},{data:v(p),showLine:!1,pointRadius:3,pointBackgroundColor:M=>d(M.raw.original.speed)}]},options:{maintainAspectRatio:!1,layout:{padding:{bottom:25,left:25,right:25}},scales:{x:{display:!1,min:-u,max:u},y:{display:!1,min:-u,max:u}},plugins:{title:{display:!0,text:"Wind chart for current location",font:{size:16},padding:{top:5,bottom:35}},legend:{display:!1},tooltip:{filter:M=>M.datasetIndex===1,callbacks:{label:M=>`${M.raw.original.r}m: ${Math.round(M.raw.original.t)}° / ${Math.round(M.raw.original.speed)} kt`}}}},plugins:[{id:"polarGrid",beforeDraw:M=>{const{ctx:y,scales:{x:_,y:S}}=M;if(!M.chartArea)return;const E=_.getPixelForValue(0),k=S.getPixelForValue(0);y.save(),y.font="10px Roboto";const A=u<=4e3?200:500,T=1e3;y.strokeStyle="#eee",y.lineWidth=.5;for(let x=A;x<=u;x+=A)if(x%T!==0){const C=Math.abs(_.getPixelForValue(x)-E),I=Math.abs(S.getPixelForValue(x)-k);y.beginPath(),y.ellipse(E,k,C,I,0,0,2*Math.PI),y.stroke()}y.strokeStyle="#ccc",y.lineWidth=1.5;for(let x=T;x<=u;x+=T){const C=Math.abs(_.getPixelForValue(x)-E),I=Math.abs(S.getPixelForValue(x)-k);y.beginPath(),y.ellipse(E,k,C,I,0,0,2*Math.PI),y.stroke(),y.fillStyle="#666",y.fillText(`${x}m`,E+5,k-I-5)}const N=(M.chartArea.right-M.chartArea.left)/2,D=(M.chartArea.bottom-M.chartArea.top)/2;y.strokeStyle="#ccc",y.lineWidth=1;for(let x=0;x<360;x+=30){const C=(x-90)*(Math.PI/180);y.beginPath(),y.moveTo(E,k),y.lineTo(E+N*Math.cos(C),k+D*Math.sin(C)),y.stroke(),y.save(),y.translate(E+(N+15)*Math.cos(C),k+(D+15)*Math.sin(C)),y.rotate(C+Math.PI/2),y.textAlign="center",y.fillText(`${x}°`,0,0),y.restore()}y.restore()}}]});const b=document.getElementById("windspinne-legend");b.innerHTML="",[{speed:"0-5 kt",color:"blue"},{speed:"6-10 kt",color:"green"},{speed:"11-15 kt",color:"orange"},{speed:"16-20 kt",color:"red"},{speed:"> 20 kt",color:"purple"}].forEach(M=>{const y=document.createElement("div");y.className="legend-item",y.innerHTML=`<div class="legend-color-box" style="background-color: ${M.color};"></div><span>${M.speed}</span>`,b.appendChild(y)})}async function ze(t,e,n,a=null){var T,N,D,x,C;console.log(`updateWeatherDisplay called for index: ${t} -> into ${e}`);const r=document.getElementById(e),o=document.getElementById(n);if(!r||!o){console.error("Target container(s) for weather display not found!",{tableContainerId:e,timeContainerId:n});return}if(!i.weatherData||!i.weatherData.time||t<0||t>=i.weatherData.time.length){console.error("No weather data available or index out of bounds:",t),r.innerHTML='<p style="padding: 20px; text-align: center;">No weather data available</p>',o.innerHTML="Selected Time: ";const I=document.getElementById("timeSlider");I&&(I.value=0);return}const s=(T=i.weatherData.visibility)==null?void 0:T[t],l=(N=i.weatherData.weather_code)==null?void 0:N[t],c=f.translateWmoCodeToTaf(l);console.log(`--- Bodenwetter für Index ${t} ---`),console.log(`Sichtweite (Visibility): ${s??"N/A"} m`),console.log(`Wetter-Code (WMO 4677): ${l??"N/A"} (${c})`),console.log("---------------------------------"),i.landingWindDir=i.weatherData.wind_direction_10m[t]||null,console.log("landingWindDir updated to:",i.landingWindDir);const u=document.getElementById("customLandingDirectionLL"),d=document.getElementById("customLandingDirectionRR");u&&d&&i.landingWindDir!==null&&(u.value=Math.round(i.landingWindDir),d.value=Math.round(i.landingWindDir));const m=((D=document.getElementById("refLevel"))==null?void 0:D.value)||"AGL",p=g.getValue("heightUnit","radio","m"),h=g.getValue("windUnit","radio","kt"),v=g.getValue("temperatureUnit","radio","C"),b=g.getValue("timeZone","radio","Z"),w=await f.getDisplayTime(i.weatherData.time[t],i.lastLat,i.lastLng,b),M=Ie(),y=be(i.weatherData,t,M,Math.round(i.lastAltitude),p),_=m==="AMSL"&&i.lastAltitude!=="N/A"?Math.round(i.lastAltitude):0,S=parseInt((x=document.getElementById("upperLimit"))==null?void 0:x.value)||3e3,k=y.filter(I=>I.displayHeight<=S).map(I=>{const O=parseFloat(I.spd);let R="";if(h==="bft"){const ee=f.convertWind(O,"kt","km/h"),ie=f.knotsToBeaufort(ee);ie<=1?R="wind-low":ie<=3?R="wind-moderate":ie<=4?R="wind-high":R="wind-very-high"}else{const ee=f.convertWind(O,"kt","km/h");ee<=3?R="wind-low":ee<=10?R="wind-moderate":ee<=16?R="wind-high":R="wind-very-high"}const W=I.cc;let z="";W!=="N/A"&&Number.isFinite(W)&&(W<=10?z="cloud-cover-clear":W<=25?z="cloud-cover-few":W<=50?z="cloud-cover-scattered":W<=87?z="cloud-cover-broken":z="cloud-cover-overcast");const $=m==="AMSL"?I.displayHeight+(p==="ft"?Math.round(_*3.28084):_):I.displayHeight,Z=f.convertTemperature(I.temp,v==="C"?"°C":"°F"),B=Z==="N/A"?"N/A":Z.toFixed(0),J=f.convertWind(O,h,"km/h");let X;const ue=m==="AMSL"?p==="ft"?Math.round(_*3.28084):_:0;if(Math.round($)===ue&&i.weatherData.wind_gusts_10m[t]!==void 0&&Number.isFinite(i.weatherData.wind_gusts_10m[t])){const ee=i.weatherData.wind_gusts_10m[t],ie=f.convertWind(ee,h,"km/h"),ye=h==="bft"?Math.round(J):J.toFixed(0),De=h==="bft"?Math.round(ie):ie.toFixed(0);X=`${ye} G ${De}`}else X=J==="N/A"?"N/A":h==="bft"?Math.round(J):J.toFixed(0);const q=Math.round(f.convertWind(O,"kt","km/h")/5)*5,oe=I.dir==="N/A"||isNaN(q)?"N/A":f.generateWindBarb(I.dir,q);return`<tr class="${R} ${z}">
                    <td>${Math.round($)}</td>
                    <td>${f.roundToTens(I.dir)}</td>
                    <td>${X}</td>
                    <td>${oe}</td>
                    <td>${B}</td>
                    <td>${Math.round(I.rh)}</td>
                    <td>${I.cc}</td> <!-- NEUE SPALTE für Wolkenbedeckung -->
                </tr>`}).join(""),A=`
        <table id="weatherTable">
            <thead>
                <tr>
                    <th>Height (${p} ${m})</th>
                    <th>Dir (deg)</th>
                    <th>Spd (${h})</th>
                    <th>Wind</th>
                    <th>T (${v==="C"?"°C":"°F"})</th>
                    <th>RH (%)</th>
                    <th>CC (%)</th> <!-- NEUE SPALTE für Wolkenbedeckung -->
                </tr>
            </thead>
            <tbody>
                ${k}
            </tbody>
        </table>`;if(r.innerHTML=A,o.innerHTML=`Selected Time: ${w}`,y.length>0){const I=parseInt((C=document.getElementById("upperLimit"))==null?void 0:C.value)||3e3;Ac(y,I)}}async function Ge(){var v;if(!i.currentMarker||i.lastLat===null)return;const t=i.lastLat,e=i.lastLng,n=i.lastAltitude,a=g.getValue("heightUnit","radio","m");let r="N/A",o="";n!=="N/A"&&(a==="ft"?(r=Math.round(f.convertHeight(n,"ft")),o="ft"):(r=n,o="m"));const s=g.getValue("coordFormat","radio","Decimal"),l=Ro(),c=(v=i.weatherData.weather_code)==null?void 0:v[l],u=f.translateWmoCodeToTaf(c),d=f.convertCoords(t,e,s),m=b=>`${b.deg}°${b.min}'${b.sec.toFixed(0)}" ${b.dir}`,p=b=>`${b.deg}° ${b.min.toFixed(3)}' ${b.dir}`;let h;if(s==="MGRS"?h=`MGRS: ${d.lat}<br>Alt: ${r} ${o}`:s==="DMS"?h=`Lat: ${m(f.decimalToDms(t,!0))}<br>Lng: ${m(f.decimalToDms(e,!1))}<br>Alt: ${r} ${o}`:s==="DDM"?h=`Lat: ${p(f.decimalToDecimalMinutes(t,!0))}<br>Lng: ${p(f.decimalToDecimalMinutes(e,!1))}<br>Alt: ${r} ${o}`:h=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${r} ${o}`,i.weatherData&&i.weatherData.surface_pressure){const b=i.weatherData.surface_pressure[l];b?h+=` QFE: ${b.toFixed(0)} hPa`:h+=" QFE: N/A",u&&u!=="N/A"&&u!=="SKC"&&(h+=`<br>Weather: ${u}`)}else h+=" QFE: N/A";Aa(i.currentMarker,h)}function Cc(){const t=document.getElementById("modelInfoPopup"),e=document.getElementById("modelSelect");if(!t||!e)return;const n=e.value,a=i.lastModelRun||"N/A",r=`Model: ${n.replace(/_/g," ").toUpperCase()}\\nRun: ${a}`;t.innerHTML=r.replace(/\\n/g,"<br>")}async function Vo(){const t=document.getElementById("timeSlider"),e=document.getElementById("slider-labels");if(!t||!e||!i.weatherData||!i.weatherData.time){e&&(e.innerHTML="");return}e.innerHTML="";const n=i.weatherData.time,a=parseInt(t.max,10);if(a<=0)return;const r=g.getValue("timeZone","radio","Z");let o="utc";r==="loc"&&i.lastLat&&(o=(await f.getLocationData(i.lastLat,i.lastLng)).timezone||"utc");let s=null;for(let l=0;l<n.length;l++){const c=n[l],u=F.fromISO(c,{zone:"utc"}).setZone(o),d=u.day;if(d!==s){let m=l,p=Math.abs(u.hour);for(let h=1;h<4&&l+h<n.length;h++){const v=F.fromISO(n[l+h],{zone:"utc"}).setZone(o);if(v.day===d)Math.abs(v.hour)<p&&(p=Math.abs(v.hour),m=l+h);else break}if(d!==s){const h=document.createElement("div");h.className="slider-label",h.textContent=u.toFormat("MMM dd");const v=m/a*100;m===0?(h.style.left="0",h.style.transform="translateX(0)"):v>98?(h.style.left="100%",h.style.transform="translateX(-100%)"):(h.style.left=`${v}%`,h.style.transform="translateX(0)"),e.appendChild(h),s=d}}}}function _e(){if(!i.currentMarker||typeof i.currentMarker.getLatLng!="function")return;const t=i.currentMarker.getLatLng();if(!t)return;if(!g.state.userSettings.showLandingPattern||!i.weatherData||i.map.getZoom()<Te.LANDING_PATTERN_MIN_ZOOM){It(null);return}const e=parseInt(document.getElementById("timeSlider").value)||0,n=Ie(),a=g.getValue("heightUnit","m"),r=g.getValue("windUnit","kt"),o=Math.round(i.lastAltitude),s=be(i.weatherData,e,n,o,a);if(!s||s.length===0){It(null);return}const l=En(t.lat,t.lng,s);if(!l){It(null);return}const{downwindStart:c,baseStart:u,finalStart:d,landingPoint:m}=l,p=s.map(T=>T.height),h=s.map(T=>-f.convertWind(T.spd,"kt","km/h")*Math.sin(T.dir*Math.PI/180)),v=s.map(T=>-f.convertWind(T.spd,"kt","km/h")*Math.cos(T.dir*Math.PI/180)),b=parseInt(document.getElementById("legHeightFinal").value)||100,w=parseInt(document.getElementById("legHeightBase").value)||200,M=parseInt(document.getElementById("legHeightDownwind").value)||300,y=f.calculateMeanWind(p,h,v,o,o+b),_=f.calculateMeanWind(p,h,v,o+b,o+w),S=f.calculateMeanWind(p,h,v,o+w,o+M),E=T=>T<=3?"lightblue":T<=10?"lightgreen":T<=16?"#f5f34f":"#ffcccc",k=T=>{const N=f.convertWind(T,r,"kt");return r==="bft"?Math.round(N):N.toFixed(1)},A={legs:[{path:[m,d]},{path:[d,u]},{path:[u,c]}],arrows:[{position:[(m[0]+d[0])/2,(m[1]+d[1])/2],bearing:(y[0]-90+180)%360,color:E(y[1]),tooltipText:`${Math.round(y[0])}° ${k(y[1])} ${r}`},{position:[(d[0]+u[0])/2,(d[1]+u[1])/2],bearing:(_[0]-90+180)%360,color:E(_[1]),tooltipText:`${Math.round(_[0])}° ${k(_[1])} ${r}`},{position:[(u[0]+c[0])/2,(u[1]+c[1])/2],bearing:(S[0]-90+180)%360,color:E(S[1]),tooltipText:`${Math.round(S[0])}° ${k(S[1])} ${r}`}]};It(A)}function he(){var c,u,d,m,p,h,v,b;if(console.log("updateJumpRunTrackDisplay called"),!i.map){console.warn("Map not initialized, cannot update jump run track display");return}if(!(g.state.userSettings.showJumpRunTrack&&i.weatherData&&i.lastLat&&i.lastLng&&g.state.userSettings.calculateJump)){console.log("Conditions not met to show JRT, clearing display."),Ft(null),i.lastTrackData=null;const w=document.getElementById("jumpRunTrackDirection");w&&!g.state.userSettings.customJumpRunDirection&&(w.value="");return}const e=Ro(),n=Ie(),a=g.getValue("heightUnit","radio","m"),r=be(i.weatherData,e,n,Math.round(i.lastAltitude),a),o=i.harpMarker?i.harpMarker.getLatLng():null,s=Sa(r,o),l=document.getElementById("jumpRunTrackDirection");if(s&&((c=s.latlngs)==null?void 0:c.length)===2&&s.latlngs.every(w=>Number.isFinite(w[0])&&Number.isFinite(w[1]))){console.log("Drawing jump run track with data:",s),l&&!g.state.userSettings.customJumpRunDirection&&(l.value=s.direction);const w={path:{latlngs:s.latlngs,options:{color:"orange",weight:5,opacity:.8},tooltipText:`Jump Run: ${s.direction}°, ${s.trackLength} m`,originalLatLngs:((d=(u=i.lastTrackData)==null?void 0:u.latlngs)==null?void 0:d.length)===2?i.lastTrackData.latlngs:s.latlngs},approachPath:((m=s.approachLatLngs)==null?void 0:m.length)===2&&s.approachLatLngs.every(M=>Number.isFinite(M[0])&&Number.isFinite(M[1]))?{latlngs:s.approachLatLngs,options:{color:"orange",weight:5,opacity:.8,dashArray:"5, 10"},tooltipText:`Approach: ${s.direction}°, ${s.approachLength} m`,originalLatLngs:((h=(p=i.lastTrackData)==null?void 0:p.approachLatLngs)==null?void 0:h.length)===2?i.lastTrackData.approachLatLngs:s.approachLatLngs}:null,trackLength:s.trackLength,airplane:{position:L.latLng(s.latlngs[1][0],s.latlngs[1][1]),bearing:s.direction,originalPosition:(b=(v=i.lastTrackData)==null?void 0:v.latlngs)!=null&&b[1]&&Number.isFinite(i.lastTrackData.latlngs[1][0])?L.latLng(i.lastTrackData.latlngs[1][0],i.lastTrackData.latlngs[1][1]):L.latLng(s.latlngs[1][0],s.latlngs[1][1])}};Ft(w),i.lastTrackData={latlngs:s.latlngs,approachLatLngs:s.approachLatLngs,direction:s.direction,trackLength:s.trackLength,approachLength:s.approachLength},console.log("Updated AppState.lastTrackData:",i.lastTrackData)}else console.warn("No valid track data to display:",s),Ft(null),i.lastTrackData=null,l&&!g.state.userSettings.customJumpRunDirection&&(l.value="")}let ke=null;function Ca(){const t=document.getElementById("locationSearchInput"),e=document.getElementById("locationResults"),n=document.getElementById("clearSearchInput"),a=document.getElementById("saveFavoriteBtn"),r=document.getElementById("favoriteModal"),o=document.getElementById("favoriteNameInput"),s=document.getElementById("submitFavoriteName"),l=document.getElementById("cancelFavoriteName");if(!t||!e||!a||!r){console.error("Einige UI-Elemente für die Ortssuche wurden nicht gefunden.");return}const c=f.debounce(Dc,300);t.addEventListener("input",()=>{c(t.value),n.style.display=t.value.trim()?"block":"none"}),n.addEventListener("click",()=>{t.value="",n.style.display="none",qe(),t.focus()}),a.addEventListener("click",()=>{if(i.lastLat===null||i.lastLng===null){f.handleError("Please select a location on the map first.");return}ke={lat:i.lastLat,lng:i.lastLng,defaultName:`DIP at ${i.lastLat.toFixed(4)}, ${i.lastLng.toFixed(4)}`},o.value=ke.defaultName,r.style.display="flex"}),s.addEventListener("click",()=>{if(ke){const u=o.value.trim()||ke.defaultName;Ho(ke.lat,ke.lng,u),qe()}r.style.display="none",ke=null}),l.addEventListener("click",()=>{r.style.display="none",ke=null}),qe(),document.addEventListener("favorites:updated",()=>{console.log("[Coordinates] Received favorites:updated event. Rerendering list."),qe()})}function qe(t=[]){const e=document.getElementById("locationResults");if(!e)return;e.innerHTML="";const n=Ne(),a=n.filter(s=>s.isFavorite),r=n.filter(s=>!s.isFavorite),o=(s,l)=>{if(l.length===0)return;const c=document.createElement("div");c.className="search-section";const u=document.createElement("h5");u.textContent=s,c.appendChild(u);const d=document.createElement("ul");l.forEach(m=>{const p=Ic(m);p&&d.appendChild(p)}),c.appendChild(d),e.appendChild(c)};o("Results",t),o("Favorites",a),o("Recent Searches",r)}function Ic(t){const e=parseFloat(t.lat),n=parseFloat(t.lng||t.lon);if(isNaN(e)||isNaN(n))return null;const a=document.createElement("li");a.className="search-item";const r=document.createElement("div");r.className="search-item-text",r.innerHTML=`<span class="name">${t.display_name||t.label}</span>`,r.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("location:selected",{detail:{lat:e,lng:n,source:"search"},bubbles:!0})),Wo(e,n,t.display_name||t.label,t.isFavorite),document.querySelector('.tab-button[data-panel="map"]').click()}),a.appendChild(r);const o=document.createElement("div");if(o.className="search-item-actions",t.isFavorite){const c=document.createElement("button");c.innerHTML="🏠",c.title="Set as Home DZ",c.className=`home-toggle ${t.isHomeDZ?"is-home":""}`,c.addEventListener("click",u=>{u.stopPropagation(),t.isHomeDZ?Gl():zl(e,n),qe()}),o.appendChild(c)}const s=document.createElement("button");s.className=`favorite-toggle ${t.isFavorite?"is-favorite":""}`,s.innerHTML="★",s.title="Toggle favorite",s.addEventListener("click",c=>{c.stopPropagation(),Nc(e,n,t.display_name||t.label)}),o.appendChild(s);const l=document.createElement("button");return l.className="delete-btn",l.textContent="×",l.title="Delete this entry",l.addEventListener("click",c=>{c.stopPropagation(),confirm(`Delete "${t.display_name||t.label}"?`)&&(jl(e,n),qe())}),o.appendChild(l),a.appendChild(o),a}function Nc(t,e,n,a){const r=Ne().find(s=>Math.abs(s.lat-t)<1e-4&&Math.abs(s.lng-e)<1e-4);if(r&&r.isFavorite)Vl(t,e,n,!1);else{ke={lat:t,lng:e,defaultName:n};const s=document.getElementById("favoriteModal"),l=document.getElementById("favoriteNameInput");l.value=n;const c=()=>{const d=l.value.trim()||ke.defaultName;Ho(ke.lat,e,d),s.style.display="none"},u=()=>{s.style.display="none"};document.getElementById("submitFavoriteName").onclick=c,document.getElementById("cancelFavoriteName").onclick=u,s.style.display="block"}}async function Dc(t){if(!t.trim()){qe();return}const e=await Hl(t);qe(e)}const Pc=Object.freeze(Object.defineProperty({__proto__:null,initializeLocationSearch:Ca},Symbol.toStringTag,{value:"Module"})),Fc=null,xc=null,$c=null;let Vn=null,jn=null,Oc=!1;function Rc(){return jn||(jn=new Promise(t=>{document.readyState==="complete"&&window.Capacitor?t():(document.addEventListener("deviceready",()=>{console.log("Device is ready"),t()},{once:!0}),setTimeout(()=>{window.Capacitor&&(console.log("Fallback: Device seems ready"),t())},2e3))})),jn}async function Uc(){var t;try{if(await Rc(),(t=window.Capacitor)!=null&&t.isNativePlatform()){console.log("Loading native Capacitor modules");const e={Geolocation:Fc,Filesystem:xc,Directory:$c,isNative:!0,isInitialized:!0};return Oc=!0,e}}catch(e){console.error("Error loading Capacitor modules:",e)}return{Geolocation:null,Filesystem:null,Directory:null,isNative:!1,isInitialized:!1}}async function _t(){return Vn||(Vn=Uc().catch(t=>(console.error("Critical: Failed to load Capacitor:",t),{Geolocation:null,Filesystem:null,Directory:null,isNative:!1,isInitialized:!1}))),Vn}async function Wc(t){if(!i.map)return f.handleError("Map not initialized."),null;i.isLoadingGpx=!0;try{const e=await Na(t),a=new DOMParser().parseFromString(e,"text/xml"),r=toGeoJSON.kml(a),o=[];if(L.geoJSON(r,{onEachFeature:function(l,c){const u=l.properties.coordTimes||l.properties.times;l.geometry&&l.geometry.type==="LineString"&&l.geometry.coordinates.forEach((d,m)=>{const[p,h,v]=d;let b=null;if(u&&u[m]){const w=u[m];let M=null;w&&(w.includes(".")?M=w.split(".")[0]+"Z":M=w),b=M?F.fromISO(M,{zone:"utc"}):null}o.push({lat:h,lng:p,ele:v||null,time:b})})}}),o.length<2)throw new Error("KML file contains no valid track with at least two points.");return await Ia(o,t.name)}catch(e){return console.error("[trackManager] Error in loadKmlTrack:",e),f.handleError("Error parsing KML file: "+e.message),null}finally{i.isLoadingGpx=!1}}async function Hc(t){var e,n;if(!i.map)return f.handleError("Map not initialized."),null;i.isLoadingGpx=!0;try{const a=await Na(t),s=new DOMParser().parseFromString(a,"text/xml").getElementsByTagName("trkpt"),l=[];for(let u=0;u<s.length;u++){const d=parseFloat(s[u].getAttribute("lat")),m=parseFloat(s[u].getAttribute("lon"));if(isNaN(d)||isNaN(m))continue;const p=(e=s[u].getElementsByTagName("ele")[0])==null?void 0:e.textContent,h=(n=s[u].getElementsByTagName("time")[0])==null?void 0:n.textContent;let v=null;h&&(h.includes(".")?v=h.split(".")[0]+"Z":v=h),l.push({lat:d,lng:m,ele:p?parseFloat(p):null,time:v?F.fromISO(v,{zone:"utc"}):null})}if(l.length<2)throw new Error("GPX track has insufficient points.");return await Ia(l,t.name)}catch(a){return console.error("[trackManager] Error in loadGpxTrack:",a),f.handleError("Error parsing GPX file: "+a.message),null}finally{i.isLoadingGpx=!1}}async function Bc(t){if(!i.map)return f.handleError("Map not initialized."),null;i.isLoadingGpx=!0;try{const e=await Na(t);return new Promise(async(n,a)=>{const r=[];Papa.parse(e,{skipEmptyLines:!0,step:function(o){const s=o.data;if(s[0]&&s[0].toUpperCase()==="$GNSS"&&s.length>=5){let l=s[1];const c=parseFloat(s[2]),u=parseFloat(s[3]),d=parseFloat(s[4]);if(isNaN(c)||isNaN(u)||isNaN(d))return;let m=null;l&&(l.includes(".")?m=l.split(".")[0]+"Z":m=l);let p=null;try{p=F.fromISO(m,{setZone:!0}).toUTC(),p.isValid||(p=null)}catch{p=null}r.push({lat:c,lng:u,ele:d,time:p})}},complete:async function(){if(r.length<2){a(new Error("CSV track has insufficient points."));return}const o=await Ia(r,t.name);n(o)},error:function(o){a(new Error("Error parsing CSV: "+o.message))}})})}catch(e){return console.error("[trackManager] Error in loadCsvTrackUTC:",e),f.handleError("Error reading or parsing CSV file: "+e.message),null}finally{i.isLoadingGpx=!1}}async function zc(t,e,n){if(console.log("--- GPX EXPORT DEBUG START ---"),!Settings.getValue("showJumpRunTrack",!1)){f.handleError("Activate 'Show Jump Run Track' to export the track.");return}if(!i.weatherData||!i.lastLat||!i.lastLng||i.lastAltitude==="N/A"){f.handleError("Wetterdaten oder DIP-Position nicht verfügbar. GPX-Export nicht möglich.");return}const a=i.lastLat,r=i.lastLng,o=Math.round(i.lastAltitude),s=i.harpMarker?i.harpMarker.getLatLng():null;let l=null;s&&(l=await f.getAltitude(s.lat,s.lng),l=l!=="N/A"?Math.round(l):null);const c=be(i.weatherData,t,e,o,n);if(!c||c.length===0){f.handleError("Keine Wetterdaten für die GPX-Erstellung verfügbar.");return}const u=Sa(c,s);if(!u||!u.latlngs||!u.approachLatLngs){f.handleError("Jump Run Track konnte nicht berechnet werden.");return}const[d,m]=u.approachLatLngs[1],[p,h]=u.latlngs[0],[v,b]=u.latlngs[1],w=Settings.getValue("exitAltitude",3e3),M=o+w;let y=`<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<gpx version="1.1" creator="DZMaster" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
  <metadata>
    <name>Jump Run - ${new Date().toLocaleString()}</name>
    <desc>Generated by DZMaster. Jump Run Direction: ${u.direction}°</desc>
  </metadata>
`;y+=`  <wpt lat="${a}" lon="${r}">
    <name>DIP</name>
    <ele>${o}</ele>
    <sym>Flag, Blue</sym>
  </wpt>
`,s&&l!==null&&(y+=`  <wpt lat="${s.lat}" lon="${s.lng}">
    <name>HARP</name>
    <ele>${l}</ele>
    <sym>Flag, Green</sym>
  </wpt>
`),y+=`  <wpt lat="${d}" lon="${m}">
    <name>x-2, ${u.direction}°</name>
    <ele>${M}</ele>
    <sym>Airplane</sym>
  </wpt>
`,y+=`  <wpt lat="${p}" lon="${h}">
    <name>First Out ${w} m AGL</name>
    <ele>${M}</ele>
    <sym>Airplane</sym>
  </wpt>
`,y+=`  <wpt lat="${v}" lon="${b}">
    <name>Last Out</name>
    <ele>${M}</ele>
    <sym>Airplane</sym>
  </wpt>
`,y+=`  <trk>
    <name>Jump Run and Approach</name>
    <trkseg>
`,y+=`      <trkpt lat="${d}" lon="${m}"><ele>${M}</ele></trkpt>
`,y+=`      <trkpt lat="${p}" lon="${h}"><ele>${M}</ele></trkpt>
`,y+=`      <trkpt lat="${v}" lon="${b}"><ele>${M}</ele></trkpt>
`,y+=`    </trkseg>
  </trk>
</gpx>`;const S=`${f.formatTime(i.weatherData.time[t]).replace(/ /g,"_").replace(/:/g,"")}_JumpRun_Track.gpx`;try{const{Filesystem:E,Directory:k,isNative:A}=await _t();if(A&&E)await E.writeFile({path:`DZMaster/${S}`,data:y,directory:k.Documents,encoding:"utf8",recursive:!0}),f.handleMessage("GPX saved in Documents/DZMaster");else{const T=new Blob([y],{type:"application/gpx+xml;charset=utf-8"}),N=window.URL.createObjectURL(T),D=document.createElement("a");D.href=N,D.download=S,document.body.appendChild(D),D.click(),document.body.removeChild(D),window.URL.revokeObjectURL(N)}}catch(E){console.error("Error saving GPX file:",E),f.handleError("Could not save GPX file.")}}async function Gc(){var _;console.log("--- GPX Landing Pattern Export gestartet ---");const t=parseInt((_=document.getElementById("timeSlider"))==null?void 0:_.value)||0,e=Settings.getValue("interpStep","select",200),n=Settings.getValue("heightUnit","m");if(!Settings.getValue("showLandingPattern",!1)){f.handleError("Activate 'Landing Pattern' before export.");return}if(!i.weatherData||!i.lastLat||!i.lastLng||i.lastAltitude==="N/A"){f.handleError("Wetterdaten oder DIP-Position für GPX-Export nicht verfügbar.");return}console.log("Schritt 1: Vorbedingungen erfüllt. Wetterdaten und Position vorhanden.");const a=weatherManager.interpolateWeatherData(i.weatherData,t,e,Math.round(i.lastAltitude),n);if(!a||a.length===0){f.handleError("Fehler in Schritt 2: Keine interpolierten Wetterdaten für GPX-Erstellung verfügbar.");return}console.log("Schritt 2: Wetterdaten erfolgreich interpoliert.");const r=En(i.lastLat,i.lastLng,a);if(console.log("Schritt 3: Ergebnis von calculateLandingPatternCoords:",r),!r){f.handleError("Fehler in Schritt 3: calculateLandingPatternCoords hat keine Daten zurückgegeben. Export abgebrochen.");return}console.log("Schritt 3: Koordinaten des Landemusters erfolgreich berechnet.");const{downwindStart:o,baseStart:s,finalStart:l,landingPoint:c}=r,u=Math.round(i.lastAltitude),d=Settings.getValue("legHeightDownwind",300),m=Settings.getValue("legHeightBase",200),p=Settings.getValue("legHeightFinal",100),h=u+d,v=u+m,b=u+p;let w=`<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<gpx version="1.1" creator="DZMaster" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
  <metadata>
    <name>Landing Pattern - ${new Date().toLocaleString()}</name>
    <desc>Generated by DZMaster Application.</desc>
  </metadata>
`;w+=`  <wpt lat="${o[0]}" lon="${o[1]}"><name>Downwind ${d} m AGL</name><ele>${h}</ele></wpt>
`,w+=`  <wpt lat="${s[0]}" lon="${s[1]}"><name>Base ${m} m AGL</name><ele>${v}</ele></wpt>
`,w+=`  <wpt lat="${l[0]}" lon="${l[1]}"><name>Final ${p} m AGL</name><ele>${b}</ele></wpt>
`,w+=`  <wpt lat="${c[0]}" lon="${c[1]}"><name>DIP</name><ele>${u}</ele></wpt>
`,w+=`  <trk>
    <name>Landing Pattern</name>
    <trkseg>
      <trkpt lat="${o[0]}" lon="${o[1]}"><ele>${h}</ele></trkpt>
      <trkpt lat="${s[0]}" lon="${s[1]}"><ele>${v}</ele></trkpt>
      <trkpt lat="${l[0]}" lon="${l[1]}"><ele>${b}</ele></trkpt>
      <trkpt lat="${c[0]}" lon="${c[1]}"><ele>${u}</ele></trkpt>
    </trkseg>
  </trk>
</gpx>`,console.log("Schritt 4: GPX-String wurde erfolgreich erstellt."),console.log(w);const y=`${f.formatTime(i.weatherData.time[t]).replace(/ /g,"_").replace(/:/g,"")}_Landing_Pattern.gpx`;try{const{Filesystem:S,Directory:E,isNative:k}=await _t();if(k&&S)await S.writeFile({path:`DZMaster/${y}`,data:w,directory:E.Documents,encoding:"utf8",recursive:!0}),f.handleMessage("Landing Pattern GPX saved in Documents/DZMaster");else{const A=new Blob([w],{type:"application/gpx+xml;charset=utf-8"}),T=window.URL.createObjectURL(A),N=document.createElement("a");N.href=T,N.download=y,document.body.appendChild(N),N.click(),document.body.removeChild(N),window.URL.revokeObjectURL(T)}}catch(S){console.error("Error saving Landing Pattern GPX file:",S),f.handleError("Could not save Landing Pattern GPX file.")}console.log("--- GPX Landing Pattern Export beendet ---")}async function Ia(t,e){try{if(console.log(`[trackManager] renderTrack called for ${e} with ${t.length} points.`),!i.map)return console.warn("[trackManager] Map object in AppState is not available in renderTrack."),f.handleError("Map not initialized. Cannot render track."),null;i.gpxLayer&&i.map.hasLayer(i.gpxLayer)&&i.map.removeLayer(i.gpxLayer),i.gpxLayer=null,i.gpxPoints=t,i.isTrackLoaded=!1;const n={finalPointData:null,timestampToUseForWeather:null,historicalDateString:null,summaryForInfoElement:"",success:!1};if(t.length>0){const r=t[t.length-1];if(i.lastLat=r.lat,i.lastLng=r.lng,i.lastAltitude=await f.getAltitude(i.lastLat,i.lastLng),n.finalPointData={lat:i.lastLat,lng:i.lastLng,altitude:i.lastAltitude},t[0].time&&t[0].time.isValid){const d=t[0].time,m=F.utc().startOf("day"),p=d.startOf("day");p<m&&(n.historicalDateString=p.toFormat("yyyy-MM-dd"));let h=d.startOf("hour");d.minute>=30&&(h=h.plus({hours:1})),n.timestampToUseForWeather=h.toISO()}const o=(t.reduce((d,m,p)=>{if(p===0||!i.map)return 0;const h=t[p-1];return d+i.map.distance([h.lat,h.lng],[m.lat,m.lng])},0)/1e3).toFixed(2),s=t.map(d=>d.ele).filter(d=>d!==null),l=s.length?Math.min(...s).toFixed(0):"N/A",c=s.length?Math.max(...s).toFixed(0):"N/A",u=new CustomEvent("track:loaded",{detail:{lat:i.lastLat,lng:i.lastLng,altitude:i.lastAltitude,timestamp:n.timestampToUseForWeather,historicalDate:n.historicalDateString,summary:`<br><strong>Track:</strong> Distance: ${o} km, Min Elevation: ${l} m, Max Elevation: ${c} m (Source: ${e})`},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(u)}i.gpxLayer=L.layerGroup([],{pane:"gpxTrackPane"});const a=i.lastAltitude!=="N/A"&&!isNaN(i.lastAltitude)?parseFloat(i.lastAltitude):null;for(let r=0;r<t.length-1;r++){const o=t[r],s=t[r+1],l=o.ele,c=s.ele;let u="#808080";if(a!==null&&l!==null&&c!==null){const m=l-a,p=c-a,h=(m+p)/2;u=f.interpolateColor(h)}const d=L.polyline([[o.lat,o.lng],[s.lat,s.lng]],{color:u,weight:4,opacity:.75,pane:"gpxTrackPane"}).bindTooltip("",{sticky:!0});d.on("mousemove",function(m){const p=m.latlng;let h=t[0],v=1/0,b=0;t.forEach((w,M)=>{const y=Math.sqrt(Math.pow(w.lat-p.lat,2)+Math.pow(w.lng-p.lng,2));y<v&&(v=y,h=w,b=M)}),d.setTooltipContent(f.getTooltipContent(h,b,t,a)).openTooltip(p)}),i.gpxLayer.addLayer(d)}if(i.map&&i.gpxLayer.addTo(i.map),i.isTrackLoaded=!0,t.length>0&&i.map){const r=L.latLngBounds(t.map(o=>[o.lat,o.lng]));r.isValid()?i.map.fitBounds(r,{padding:[50,50],maxZoom:i.map.getMaxZoom()||18}):f.handleError("Unable to display track: invalid coordinates.")}return n.success=!0,console.log("[trackManager] renderTrack finished successfully."),n}catch(n){return console.error("[trackManager] Error in renderTrack:",n),f.handleError("Error rendering track: "+n.message),i.gpxPoints=[],i.gpxLayer&&i.map&&i.map.hasLayer(i.gpxLayer)&&i.map.removeLayer(i.gpxLayer),i.gpxLayer=null,i.isTrackLoaded=!1,{success:!1,error:n.message}}}async function Na(t){const{Filesystem:e,isNative:n,Directory:a}=await _t();if(n&&t.path&&e){console.log(`[trackManager] Reading file via Capacitor Filesystem API: ${t.path}`);try{return(await e.readFile({path:t.path,encoding:"utf8"})).data}catch(r){if(console.error("[trackManager] Error reading file with Capacitor:",r),t.webPath)return await(await fetch(t.webPath)).text();throw new Error("Could not read file using native API.")}}else return console.log(`[trackManager] Reading file via Web FileReader: ${t.name}`),new Promise((r,o)=>{const s=new FileReader;s.onload=l=>r(l.target.result),s.onerror=l=>o(new Error("Error reading file.")),s.readAsText(t)})}var Zc=15e3,ua=1e3,da=60*ua,on=60*da,Jn=24*on,Vc="http://www.topografix.com/GPX/gpx_style/0/2",nn=new L.Icon.Default,jc={startIcon:nn,endIcon:nn,wptIcons:{"":nn},wptTypeIcons:{"":nn},pointMatchers:[]},Jc={iconSize:[33,45],iconAnchor:[16,45],clickable:!1},qc={color:"blue"},Kc={parseElements:["track","route","waypoint"],joinTrackSegments:!0};L.GPX=L.FeatureGroup.extend({initialize:function(t,e){e.max_point_interval=e.max_point_interval||Zc,e.markers=this._merge_objs(jc,e.markers||{}),e.marker_options=this._merge_objs(Jc,e.marker_options||{}),e.polyline_options=e.polyline_options||[],e.gpx_options=this._merge_objs(Kc,e.gpx_options||{}),L.Util.setOptions(this,e),L.GPXTrackIcon=L.Icon.extend({options:e.marker_options}),this._gpx=t,this._layers={},this._prepare_markers(e.markers),this._init_info(),t&&this._parse(t,e,this.options.async)},get_duration_string:function(t,e){var n="";t>=Jn&&(n+=Math.floor(t/Jn)+"d ",t=t%Jn),t>=on&&(n+=Math.floor(t/on)+":",t=t%on);var a=Math.floor(t/da);t=t%da,a<10&&(n+="0"),n+=a+"'";var r=Math.floor(t/ua);return t=t%ua,r<10&&(n+="0"),n+=r,!e&&t>0?n+="."+Math.round(Math.floor(t)*1e3)/1e3:n+='"',n},get_duration_string_iso:function(t,e){var n=this.get_duration_string(t,e);return n.replace("'",":").replace('"',"")},_toFixed_helper:function(t,e=0){return typeof t=="number"?t.toFixed(e):"?"},to_miles:function(t){return t/1.60934},to_ft:function(t){return t*3.28084},m_to_km:function(t){return t/1e3},m_to_mi:function(t){return t/1609.34},ms_to_kmh:function(t){return t*3.6},ms_to_mih:function(t){return t/1609.34*3600},get_name:function(){return this._info.name},get_desc:function(){return this._info.desc},get_author:function(){return this._info.author},get_copyright:function(){return this._info.copyright},get_distance:function(){return this._info.length},get_distance_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))},get_start_time:function(){return this._info.duration.start},get_end_time:function(){return this._info.duration.end},get_moving_time:function(){return this._info.duration.moving},get_total_time:function(){return this._info.duration.total},get_moving_pace:function(){return this.get_moving_time()/this.m_to_km(this.get_distance())},get_moving_pace_imp:function(){return this.get_moving_time()/this.get_distance_imp()},get_moving_speed:function(){return this.m_to_km(this.get_distance())/(this.get_moving_time()/(3600*1e3))},get_moving_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_moving_time()/(3600*1e3))},get_total_speed:function(){return this.m_to_km(this.get_distance())/(this.get_total_time()/(3600*1e3))},get_total_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_total_time()/(3600*1e3))},get_elevation_gain:function(){return this._info.elevation.gain},get_elevation_loss:function(){return this._info.elevation.loss},get_elevation_gain_imp:function(){return this.to_ft(this.get_elevation_gain())},get_elevation_loss_imp:function(){return this.to_ft(this.get_elevation_loss())},get_elevation_data:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" m"})})},get_elevation_data_imp:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.to_ft,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" ft"})})},get_elevation_max:function(){return this._info.elevation.max},get_elevation_min:function(){return this._info.elevation.min},get_elevation_max_imp:function(){return this.to_ft(this.get_elevation_max())},get_elevation_min_imp:function(){return this.to_ft(this.get_elevation_min())},get_speed_data:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,t.ms_to_kmh,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,2)+" km/h"})})},get_speed_data_imp:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.ms_to_mih,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,2)+" mi/h"})})},get_speed_max:function(){return this.m_to_km(this._info.speed.max)*3600},get_speed_max_imp:function(){return this.to_miles(this.get_speed_max())},get_average_hr:function(){return this._info.hr.avg},get_average_temp:function(){return this._info.atemp.avg},get_average_cadence:function(){return this._info.cad.avg},get_heartrate_data:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" bpm"})})},get_heartrate_data_imp:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" bpm"})})},get_cadence_data:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" rpm"})})},get_temp_data:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" degrees"})})},get_cadence_data_imp:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" rpm"})})},get_temp_data_imp:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" degrees"})})},reload:function(){this._init_info(),this.clearLayers(),this._parse(this._gpx,this.options,this.options.async)},_merge_objs:function(t,e){var n={};for(var a in t)n[a]=t[a];for(var a in e)n[a]=e[a];return n},_prepare_data_point:function(t,e,n,a){var r=[e&&e(t[0])||t[0],n&&n(t[1])||t[1]];return r.push(a&&a(r[0],r[1])||r[0]+": "+r[1]),r},_prepare_markers:function(t){function e(n){return new L.GPXTrackIcon({iconUrl:n})}return Object.entries(t).forEach(([n,a])=>{n==="wptIcons"||n==="wptTypeIcons"?t[n]=this._prepare_markers(a):n==="pointMatchers"?t[n]=a.map(r=>(typeof r.icon=="string"&&(r.icon=e(r.icon)),r)):typeof a=="string"?t[n]=e(a):typeof a=="object"&&a!==null&&(t[n]=a)}),t},_init_info:function(){this._info={name:null,length:0,elevation:{gain:0,loss:0,max:0,min:1/0,_points:[]},speed:{max:0,_points:[]},hr:{avg:0,_total:0,_points:[]},duration:{start:null,end:null,moving:0,total:0},atemp:{avg:0,_total:0,_points:[]},cad:{avg:0,_total:0,_points:[]}}},_load_xml:function(t,e,n,a){a==null&&(a=this.options.async),n==null&&(n=this.options);var r=this,o=new window.XMLHttpRequest;o.open("GET",t,a);try{o.overrideMimeType("text/xml")}catch{}o.onloadend=function(){o.status==200?e(o.responseXML,n):r.fire("error",{err:"Error fetching resource: "+t})},o.send(null)},_parse:function(t,e,n){var a=this,r=function(s,l){var c=a._parse_gpx_data(s,l);if(!c){a.fire("error",{err:"No parseable layers of type(s) "+JSON.stringify(l.gpx_options.parseElements)});return}a.addLayer(c),a.fire("loaded",{layers:c,element:s})};if(t.substr(0,1)==="<"){var o=new DOMParser;n?setTimeout(function(){r(o.parseFromString(t,"text/xml"),e)}):r(o.parseFromString(t,"text/xml"),e)}else this._load_xml(t,r,e,n)},_parse_gpx_data:function(t,e){var n,a,r=[],o=t.getElementsByTagName("name");o.length>0&&(this._info.name=o[0].textContent);var s=t.getElementsByTagName("desc");s.length>0&&(this._info.desc=s[0].textContent);var l=t.getElementsByTagName("author");l.length>0&&(this._info.author=l[0].textContent);var c=t.getElementsByTagName("copyright");c.length>0&&(this._info.copyright=c[0].textContent);var u=e.gpx_options.parseElements;if(u.indexOf("route")>-1){var d=t.getElementsByTagName("rte");for(n=0;n<d.length;n++){var m=d[n],p=this._extract_styling(m),h=this._get_polyline_options(e.polyline_options,n);r=r.concat(this._parse_segment(d[n],e,p,h,"rtept"))}}if(u.indexOf("track")>-1){var v=t.getElementsByTagName("trk");for(n=0;n<v.length;n++){var b=v[n],p=this._extract_styling(b),h=this._get_polyline_options(e.polyline_options,n);if(e.gpx_options.joinTrackSegments)r=r.concat(this._parse_segment(b,e,p,h,"trkpt"));else{var w=b.getElementsByTagName("trkseg");for(C=0;C<w.length;C++)r=r.concat(this._parse_segment(w[C],e,p,h,"trkpt"))}}}if(this._info.hr.avg=Math.round(this._info.hr._total/this._info.hr._points.length),this._info.cad.avg=Math.round(this._info.cad._total/this._info.cad._points.length),this._info.atemp.avg=Math.round(this._info.atemp._total/this._info.atemp._points.length),u.indexOf("waypoint")>-1)for(a=t.getElementsByTagName("wpt"),n=0;n<a.length;n++){var M=new L.LatLng(a[n].getAttribute("lat"),a[n].getAttribute("lon")),y=a[n].getElementsByTagName("name"),o=y.length>0?y[0].textContent:"",_=a[n].getElementsByTagName("desc"),s=_.length>0?_[0].textContent:"",S=a[n].getElementsByTagName("sym"),E=S.length>0?S[0].textContent:null,k=a[n].getElementsByTagName("type"),A=k.length>0?k[0].textContent:null,T=e.markers.wptIcons,N=e.markers.wptTypeIcons,D=e.markers.pointMatchers||[],x;if(T&&E&&T[E])x=T[E];else if(N&&A&&N[A])x=N[A];else if(D.length>0){for(var C=0;C<D.length;C++)if(D[C].regex.test(o)){x=D[C].icon;break}}else T&&T[""]&&(x=T[""]);if(!x){console.log("No waypoint icon could be matched for symKey=%s,typeKey=%s,name=%s on waypoint %o",E,A,o,a[n]);continue}var I=new L.Marker(M,{clickable:e.marker_options.clickable,title:o,icon:x,type:"waypoint"});I.bindPopup("<b>"+o+"</b>"+(s.length>0?"<br>"+s:"")).openPopup(),this.fire("addpoint",{point:I,point_type:"waypoint",element:a[n]}),r.push(I)}if(r.length>1)return new L.FeatureGroup(r);if(r.length==1)return r[0]},_parse_segment:function(t,e,n,a,r){var o=t.getElementsByTagName(r);if(!o.length)return[];for(var s=[],l=[],c=[],u=null,d=0;d<o.length;d++){var m,p=new L.LatLng(o[d].getAttribute("lat"),o[d].getAttribute("lon"));p.meta={time:null,ele:null,hr:null,cad:null,atemp:null,speed:null},m=o[d].getElementsByTagName("time"),m.length>0?p.meta.time=new Date(Date.parse(m[0].textContent)):p.meta.time=new Date("1970-01-01T00:00:00");var h=u!=null?Math.abs(p.meta.time-u.meta.time):0;m=o[d].getElementsByTagName("ele"),m.length>0?p.meta.ele=parseFloat(m[0].textContent):p.meta.ele=u!=null?u.meta.ele:null;var v=u!=null?p.meta.ele-u.meta.ele:0,b=u!=null?this._dist3d(u,p):0;if(m=o[d].getElementsByTagName("speed"),m.length>0?p.meta.speed=parseFloat(m[0].textContent):p.meta.speed=h>0?1e3*b/h:0,m=o[d].getElementsByTagName("name"),m.length>0){for(var w=m[0].textContent,M=e.markers.pointMatchers||[],y=0;y<M.length;y++)if(M[y].regex.test(w)){l.push({label:w,coords:p,icon:M[y].icon,element:o[d]});break}}this._info.length+=b,m=o[d].getElementsByTagNameNS("*","hr"),m.length>0&&(p.meta.hr=parseInt(m[0].textContent),this._info.hr._points.push([this._info.length,p.meta.hr]),this._info.hr._total+=p.meta.hr),m=o[d].getElementsByTagNameNS("*","cad"),m.length>0&&(p.meta.cad=parseInt(m[0].textContent),this._info.cad._points.push([this._info.length,p.meta.cad]),this._info.cad._total+=p.meta.cad),m=o[d].getElementsByTagNameNS("*","atemp"),m.length>0&&(p.meta.atemp=parseInt(m[0].textContent),this._info.atemp._points.push([this._info.length,p.meta.atemp]),this._info.atemp._total+=p.meta.atemp),p.meta.ele>this._info.elevation.max&&(this._info.elevation.max=p.meta.ele),p.meta.ele<this._info.elevation.min&&(this._info.elevation.min=p.meta.ele),this._info.elevation._points.push([this._info.length,p.meta.ele]),p.meta.speed>this._info.speed.max&&(this._info.speed.max=p.meta.speed),this._info.speed._points.push([this._info.length,p.meta.speed]),u==null&&this._info.duration.start==null&&(this._info.duration.start=p.meta.time),this._info.duration.end=p.meta.time,this._info.duration.total+=h,h<e.max_point_interval&&(this._info.duration.moving+=h),v>0?this._info.elevation.gain+=v:this._info.elevation.loss+=Math.abs(v),u=p,s.push(p)}var _=new L.Polyline(s,this._extract_styling(t,n,a));if(this.fire("addline",{line:_,element:t}),c.push(_),e.markers.startIcon){var S=new L.Marker(s[0],{clickable:e.marker_options.clickable,icon:e.markers.startIcon});this.fire("addpoint",{point:S,point_type:"start",element:o[0],line:t}),c.push(S)}if(e.markers.endIcon){var S=new L.Marker(s[s.length-1],{clickable:e.marker_options.clickable,icon:e.markers.endIcon});this.fire("addpoint",{point:S,point_type:"end",element:o[o.length-1],line:t}),c.push(S)}for(var d=0;d<l.length;d++){var S=new L.Marker(l[d].coords,{clickable:e.marker_options.clickable,title:l[d].label,icon:l[d].icon});this.fire("addpoint",{point:S,point_type:"label",element:l[d].element}),c.push(S)}return c},_get_polyline_options:function(t,e){return Array.isArray(t)?t[e]||{}:t},_extract_styling:function(t,e,n){var a=this._merge_objs(qc,e),r=t.getElementsByTagNameNS(Vc,"line");if(r.length>0){var o=r[0].getElementsByTagName("color");o.length>0&&(a.color="#"+o[0].textContent);var o=r[0].getElementsByTagName("opacity");o.length>0&&(a.opacity=o[0].textContent);var o=r[0].getElementsByTagName("weight");o.length>0&&(a.weight=o[0].textContent);var o=r[0].getElementsByTagName("linecap");o.length>0&&(a.lineCap=o[0].textContent);var o=r[0].getElementsByTagName("linejoin");o.length>0&&(a.lineJoin=o[0].textContent);var o=r[0].getElementsByTagName("dasharray");o.length>0&&(a.dashArray=o[0].textContent);var o=r[0].getElementsByTagName("dashoffset");o.length>0&&(a.dashOffset=o[0].textContent)}return this._merge_objs(a,n)},_dist2d:function(t,e){var n=6371e3,a=this._deg2rad(e.lat-t.lat),r=this._deg2rad(e.lng-t.lng),o=Math.sin(a/2)*Math.sin(a/2)+Math.cos(this._deg2rad(t.lat))*Math.cos(this._deg2rad(e.lat))*Math.sin(r/2)*Math.sin(r/2),s=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)),l=n*s;return l},_dist3d:function(t,e){var n=this._dist2d(t,e),a=Math.abs(e.meta.ele-t.meta.ele);return Math.sqrt(Math.pow(n,2)+Math.pow(a,2))},_deg2rad:function(t){return t*Math.PI/180}});let xt=null;const jo="https://corsproxy.io/?",Jo='ADS-B Data provided by <a href="https://www.adsbexchange.com/" target="_blank">ADSBexchange.com</a>',Da=new Headers;Da.append("Accept","application/json");function gn(t,e={}){document.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:!0}))}async function qo(){if(xt){Ko(),f.handleMessage("ADSB-Tracking gestoppt.");return}if(!i.lastLat||!i.lastLng){f.handleError("Bitte zuerst einen Punkt (DIP) auf der Karte auswählen.");return}f.handleMessage("Suche nach Flugzeugen in der Nähe...");try{const t={lat:i.lastLat,lng:i.lastLng},e=`https://api.adsb.lol/v2/lat/${t.lat}/lon/${t.lng}/dist/15`,n=await fetch(jo+encodeURIComponent(e),{headers:Da});if(!n.ok){const o=await n.json().catch(()=>({msg:"Unbekannter API-Fehler"}));throw new Error(`API Error ${n.status}: ${o.msg}`)}const a=await n.json();if(!a.ac||a.ac.length===0){f.handleMessage("Keine Flugzeuge in der Nähe gefunden.");return}const r=a.ac.filter(o=>o.lat&&o.lon&&o.alt_baro).map(o=>({icao24:o.hex,callsign:o.flight?o.flight.trim():"N/A",altitude:o.alt_baro,lat:o.lat,lon:o.lon,track:o.track,velocity:o.gs,vertical_rate:o.baro_rate}));gn("adsb:showSelection",{aircraftList:r})}catch(t){console.error("Fehler bei der ADSB-Abfrage:",t),f.handleError(`Konnte Flugzeugdaten nicht abrufen: ${t.message}`)}}function Yc(t){f.handleMessage(`Tracking ${t.callsign}...`);const e=document.getElementById("findJumpShipBtn");e&&(e.textContent="Stop ADSB Tracking",e.classList.remove("btn-secondary"),e.classList.add("btn-danger")),i.adsbTrackPoints=[[t.lat,t.lon]],gn("adsb:aircraftSelected",{aircraft:t,attribution:Jo});const n=async()=>{try{const a=`https://api.adsb.lol/v2/hex/${t.icao24}`,r=await fetch(jo+encodeURIComponent(a),{headers:Da});if(r.status===404){Ko(),f.handleMessage(`${t.callsign} ist nicht mehr sichtbar. Tracking gestoppt.`);return}if(!r.ok)throw new Error(`API Error ${r.status}`);const o=await r.json();if(o.ac&&o.ac.length>0){const s=o.ac[0],l={icao24:s.hex,callsign:s.flight?s.flight.trim():"N/A",lat:s.lat,lon:s.lon,track:s.track,altitude:s.alt_baro,velocity:s.gs,vertical_rate:s.baro_rate};l.lat&&l.lon&&(i.adsbTrackPoints.push([l.lat,l.lon]),gn("adsb:aircraftUpdated",{aircraft:l}))}}catch(a){console.error("Fehler beim ADSB-Tracking:",a)}};n(),xt=setInterval(n,1e4)}function Ko(){xt&&(clearInterval(xt),xt=null),i.adsbTrackPoints=[],gn("adsb:trackingStopped",{attribution:Jo});const t=document.getElementById("findJumpShipBtn");t&&(t.textContent="Find Aircraft",t.classList.remove("btn-danger"),t.classList.add("btn-secondary"))}let Lr=!1;function He(t,e,n){console.log(`setupCheckbox called for id: ${t}`);const a=document.getElementById(t);a?(a._changeHandler&&(a.removeEventListener("change",a._changeHandler),console.log(`Removed previous change listener for ${t}`)),a._changeHandler=r=>{console.log(`Change event fired for ${t}, checked: ${a.checked}, event:`,r),r.stopPropagation(),n(a)},a.addEventListener("change",a._changeHandler),a.addEventListener("click",r=>{console.log(`Click event on ${t}, checked: ${a.checked}, target:`,r.target)}),console.log(`Attached change and click listeners to ${t}`)):console.warn(`Checkbox ${t} not found`)}function ma(t,e){document.querySelectorAll(`input[name="${t}"]`).forEach(a=>{a.addEventListener("change",()=>{const r=document.querySelector(`input[name="${t}"]:checked`);if(!r)return;const o=r.value;if(g.state.userSettings[t]=o,g.save(),console.log(`${t} changed to: ${o} and saved to localStorage`),t==="landingDirection"){const s=document.getElementById("customLandingDirectionLL"),l=document.getElementById("customLandingDirectionRR");s&&(s.disabled=o!=="LL"),l&&(l.disabled=o!=="RR"),o==="LL"&&s&&!s.value&&g.state.userSettings.customLandingDirectionLL===""&&(s.value=Math.round(i.landingWindDir||0),g.state.userSettings.customLandingDirectionLL=parseInt(s.value),g.save(),console.log(`Set customLandingDirectionLL to ${s.value}`)),o==="RR"&&l&&!l.value&&g.state.userSettings.customLandingDirectionRR===""&&(l.value=Math.round(i.landingWindDir||0),g.state.userSettings.customLandingDirectionRR=parseInt(l.value),g.save(),console.log(`Set customLandingDirectionRR to ${l.value}`))}document.dispatchEvent(new CustomEvent("ui:radioGroupChanged",{detail:{name:t,value:o}})),e&&e()})})}function te(t,e,n,a){const r=document.getElementById(t);r&&r.addEventListener(e,f.debounce(()=>{const o=r.type==="number"?parseFloat(r.value):r.value;a&&a(o)===!1||(g.state.userSettings[t]=o,g.save(),console.log(`${t} changed to: ${o} and saved to localStorage`),document.dispatchEvent(new CustomEvent("ui:inputChanged",{detail:{name:t,value:o}})))},n))}function Xc(){const t=document.querySelector(".main-layout"),e=document.querySelectorAll(".sidebar-icon"),n=document.querySelectorAll(".panel");let a=null;if(!t){console.error("Layout-Elemente für Sidebar-Logik nicht gefunden.");return}e.forEach(r=>{r.addEventListener("click",()=>{const o=r.dataset.panelId,s=o.replace("panel-","");if((s==="planner"||s==="data")&&!g.isFeatureUnlocked(s)){g.showPasswordModal(s,()=>{r.click()},()=>{});return}const l=t.classList.contains("sidebar-expanded")&&a===o;t.classList.remove("sidebar-expanded","data-panel-visible"),e.forEach(c=>c.classList.remove("active")),l?a=null:(t.classList.add("sidebar-expanded"),r.classList.add("active"),a=o,n.forEach(c=>c.classList.toggle("hidden",c.id!==o)),o==="panel-data"&&t.classList.add("data-panel-visible")),setTimeout(()=>{i.map&&i.map.invalidateSize({animate:!0})},300)})})}function Qc(){document.querySelectorAll(".accordion-header").forEach(e=>{e.addEventListener("click",()=>{e.parentElement.classList.toggle("active")})})}function eu(){const t=document.getElementById("timeSlider");t&&(t.addEventListener("input",()=>{document.dispatchEvent(new CustomEvent("ui:sliderChanged",{detail:{sliderValue:t.value},bubbles:!0,cancelable:!0}))}),t.addEventListener("change",async()=>{document.dispatchEvent(new CustomEvent("ui:sliderChangeFinished",{detail:{sliderValue:t.value},bubbles:!0,cancelable:!0}))}))}function tu(){const t=document.getElementById("modelSelect");t&&(t.addEventListener("change",()=>{const e=t.value;console.log("Model select changed to:",e),g.state.userSettings.model=e,g.save(),document.dispatchEvent(new CustomEvent("ui:modelChanged",{detail:{model:e}}))}),document.addEventListener("models:available",e=>{const{availableModels:n}=e.detail;Ul(n),Su(n),Wl(n)}))}function nu(){Ca(),console.log("Coordinate events setup complete.")}function au(){if(console.log("App: Richte Event-Listener für Karten-Events ein."),!i.map){console.error("Karte nicht initialisiert, Event-Listener können nicht gesetzt werden.");return}const t=()=>{document.dispatchEvent(new CustomEvent("map:moved"))},e=f.debounce(()=>{ka({map:i.map,baseMaps:i.baseMaps,onProgress:Ut,onComplete:n=>{Oe(),n&&f.handleMessage(n)},onCancel:()=>{Oe(),f.handleMessage("Caching cancelled.")}})},1e3);i.map.on("zoomend",t),i.map.on("moveend",t),i.map.on("moveend",e)}function ru(){const t=document.getElementById("modelInfoButton"),e=document.getElementById("modelInfoPopup");!t||!e||(t.addEventListener("click",n=>{n.stopPropagation();const a=e.style.display==="block";e.style.display=a?"none":"block"}),document.addEventListener("click",n=>{e.style.display==="block"&&!t.contains(n.target)&&(e.style.display="none")}))}function ou(){document.querySelectorAll(".info-icon").forEach(e=>{const n=e.nextElementSibling;if(n&&n.classList.contains("info-popup")){const a=e.dataset.info;a&&(n.textContent=a),e.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),document.querySelectorAll(".info-popup").forEach(s=>{s!==n&&(s.style.display="none")});const o=n.style.display==="block";n.style.display=o?"none":"block"})}}),document.addEventListener("click",e=>{e.target.closest(".info-icon")||document.querySelectorAll(".info-popup").forEach(n=>{n.style.display="none"})})}function iu(){console.log("App: Richte Event-Listener für Track-Einstellungen ein.");const t=(a,r)=>{const o=document.getElementById(a);o&&(o.value=g.state.userSettings[r]||0,console.log(`Set ${a} to initial value:`,o.value),o.addEventListener("input",()=>{const s=parseFloat(o.value);isNaN(s)||(g.state.userSettings[r]=s,g.save(),he())}))};t("numberOfJumpers","numberOfJumpers"),t("jumperSeparation","jumperSeparation"),t("jumpRunTrackOffset","jumpRunTrackOffset"),t("jumpRunTrackForwardOffset","jumpRunTrackForwardOffset");const e=document.getElementById("jumpRunTrackDirection");e&&(e.value=g.state.userSettings.customJumpRunDirection||"",e.addEventListener("change",()=>{const a=parseFloat(e.value);g.state.userSettings.jumpRunTrackOffset=0,g.state.userSettings.jumpRunTrackForwardOffset=0;const r=document.getElementById("jumpRunTrackOffset"),o=document.getElementById("jumpRunTrackForwardOffset");r&&(r.value=0),o&&(o.value=0),console.log("Manuelle JRT-Richtungsänderung: Offsets auf 0 zurückgesetzt."),Number.isFinite(a)&&a>=0&&a<=360?(g.state.userSettings.customJumpRunDirection=a,console.log("Set 'customJumpRunDirection' on change to:",a)):(g.state.userSettings.customJumpRunDirection=null,e.value="",console.log("Invalid direction, resetting to calculated.")),g.save(),he(),document.dispatchEvent(new CustomEvent("ui:recalculateJump"))}));const n=document.getElementById("showJumpRunTrack");n&&n.addEventListener("change",a=>{g.state.userSettings.showJumpRunTrack=a.target.checked,g.save(),he()})}function su(){const t=document.querySelectorAll('input[name="cutAwayState"]');if(t.length===0)return;const e=g.state.userSettings.cutAwayState||"Partially",n=document.querySelector(`input[name="cutAwayState"][value="${e}"]`);n&&(n.checked=!0),t.forEach(a=>{a.addEventListener("change",()=>{a.checked&&(console.log(`Cut Away State changed to: ${a.value}`),g.state.userSettings.cutAwayState=a.value,g.save(),document.dispatchEvent(new CustomEvent("ui:recalculateJump")))})})}function lu(){const t=document.getElementById("resetCutAwayMarker");t&&t.addEventListener("click",()=>{if(!i.map){console.warn("Map not initialized, cannot reset cut-away marker");return}i.cutAwayMarker&&(i.map.removeLayer(i.cutAwayMarker),i.cutAwayMarker=null,i.cutAwayLat=null,i.cutAwayLng=null,console.log("Cut-away marker reset"),i.cutAwayCircle&&(i.map.removeLayer(i.cutAwayCircle),i.cutAwayCircle=null,console.log("Cleared cut-away circle")),document.getElementById("info").innerHTML="Right-click map to place cut-away marker")})}function cu(){const t=document.getElementById("deselectAllEnsembleButton");t&&t.addEventListener("click",()=>{document.querySelectorAll('#ensembleModelsSubmenu input[type="checkbox"]').forEach(n=>{n.checked=!1}),g.state.userSettings.selectedEnsembleModels=[],g.save(),i.ensembleModelsData=null,Gt(),f.handleMessage("All ensemble models deselected.")})}function uu(){const t=document.getElementById("analyzeTerrainButton");t&&t.addEventListener("click",async()=>{if(!i.weatherData||!i.lastLat||!i.lastLng){f.handleError("Please select a location and fetch weather data first.");return}wt(!0,"Analyzing terrain, this may take a moment...");try{const e=await Cl();Yl(e),e.length>0?f.handleMessage("Warning: Low clearance areas detected and marked in red."):f.handleMessage("Terrain analysis complete. No low clearance areas found.")}catch(e){console.error("Terrain analysis failed:",e),f.handleError("An error occurred during terrain analysis.")}finally{wt(!1)}})}function du(){const t=document.getElementById("uploadTrackButton"),e=document.getElementById("trackFileInput"),n=document.getElementById("fileNameDisplay"),a=document.getElementById("clearTrack");if(!t||!e||!n||!a){console.error("One or more track upload elements are missing from the DOM.");return}t.addEventListener("click",()=>{e.click()}),e.addEventListener("change",async r=>{const o=document.getElementById("loading");if(r.target.files&&r.target.files.length>0){const s=r.target.files[0];n.textContent=s.name,n.style.fontStyle="normal",o&&(o.style.display="block");const l=s.name.split(".").pop().toLowerCase();try{l==="gpx"?await Hc(s):l==="csv"?await Bc(s):l==="kml"?await Wc(s):f.handleError("Unsupported file type. Please upload a .gpx or .csv file.")}catch(c){console.error("Error during track file processing:",c),f.handleError("Failed to process track file.")}finally{o&&(o.style.display="none")}}}),a.addEventListener("click",r=>{if(r.stopPropagation(),!i.map){f.handleError("Cannot clear track: map not initialized.");return}if(i.gpxLayer)try{i.map.hasLayer(i.gpxLayer)&&i.map.removeLayer(i.gpxLayer),i.gpxLayer=null,i.gpxPoints=[],i.isTrackLoaded=!1,e.value="",n.textContent="No file chosen",n.style.fontStyle="italic"}catch(o){f.handleError("Failed to clear track: "+o.message)}else f.handleMessage("No track to clear.")})}function mu(){ae(),Ie(),g.getValue("heightUnit","m");const t=document.getElementById("exportGpxButton");t&&t.addEventListener("click",async()=>{const n=ae(),a=Ie(),r=g.getValue("heightUnit","m");await zc(n,a,r)});const e=document.getElementById("exportLandingPatternGpxButton");e&&e.addEventListener("click",()=>{console.log("DEBUG: Klick auf 'exportLandingPatternGpxButton' registriert."),Gc()})}function hu(){if(!i.map){console.warn("Map not initialized, skipping setupCheckboxEvents");return}He("showExitAreaCheckbox","showExitArea",a=>{g.state.userSettings.showExitArea=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:jumpFeatureChanged"))}),He("showCanopyAreaCheckbox","showCanopyArea",a=>{g.state.userSettings.showCanopyArea=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:jumpFeatureChanged"))}),He("showJumpRunTrack","showJumpRunTrack",a=>{g.state.userSettings.showJumpRunTrack=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:showJumpRunTrackChanged",{detail:{checked:a.checked}}))}),He("showCutAwayFinder","showCutAwayFinder",a=>{g.state.userSettings.showCutAwayFinder=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:showCutAwayFinderChanged",{detail:{checked:a.checked}}))}),He("showLandingPattern","showLandingPattern",a=>{g.state.userSettings.showLandingPattern=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:landingPatternEnabled"))}),He("trackPositionCheckbox","trackPosition",a=>{g.state.userSettings.trackPosition=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:trackPositionToggled",{detail:{checked:a.checked}}))}),He("showJumpMasterLine","showJumpMasterLine",a=>{var o;if(a.checked&&!g.state.userSettings.trackPosition){a.checked=!1,f.handleError("Please start Live Tracking first.");return}g.state.userSettings.showJumpMasterLine=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:showJumpMasterLineChanged"));const r=(o=a.closest("li"))==null?void 0:o.querySelector("ul.submenu");r&&r.classList.toggle("hidden",!a.checked)}),ma("jumpMasterLineTarget",()=>{const a=g.getValue("jumpMasterLineTarget","radio","DIP");g.state.userSettings.jumpMasterLineTarget=a,g.save(),console.log("jumpMasterLineTarget changed:",a),document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged"))}),He("lockInteractionCheckbox","isInteractionLocked",a=>{const r=a.checked;g.state.userSettings.isInteractionLocked=r,g.save(),kc(r),i.jumpRunTrackLayerGroup&&i.jumpRunTrackLayerGroup.eachLayer(o=>{o instanceof L.Marker&&o.options.icon&&o.options.icon.options.iconUrl.includes("airplane")&&(r?o.dragging.disable():o.dragging.enable())}),i.currentMarker&&(r?i.currentMarker.dragging.disable():i.currentMarker.dragging.enable()),i.harpMarker&&(r?i.harpMarker.dragging&&i.harpMarker.dragging.disable():i.harpMarker.dragging&&i.harpMarker.dragging.enable()),i.cutAwayMarker&&(r?i.cutAwayMarker.dragging.disable():i.cutAwayMarker.dragging.enable()),r?f.handleMessage("Map interactions are now locked."):f.handleMessage("Map interactions are now unlocked.")});const t=document.getElementById("placeHarpButton");t&&t.addEventListener("click",()=>{i.isPlacingHarp=!0,console.log("HARP placement mode activated"),i.map.on("click",ca),f.handleMessage("Click the map to place the HARP marker");const a=document.querySelector(".main-layout");a&&a.classList.remove("sidebar-expanded","data-panel-visible"),document.querySelectorAll(".sidebar-icon.active").forEach(r=>r.classList.remove("active")),setTimeout(()=>{i.map&&i.map.invalidateSize({animate:!0})},300)});const e=document.getElementById("clearHarpButton");e&&e.addEventListener("click",rc);const n=document.querySelector(".hamburger-menu");n&&n.addEventListener("click",a=>{console.log("Menu click:",a.target,"class:",a.target.className,"id:",a.target.id)})}function fu(){ma("landingDirection",()=>{}),ma("jumpMasterLineTarget",()=>{document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged"))}),document.querySelectorAll('input[name="ensembleScenario"]').forEach(a=>{a.addEventListener("change",async()=>{if(a.checked){if(g.state.userSettings.currentEnsembleScenario=a.value,i.currentEnsembleScenario=a.value,g.save(),console.log("Ensemble scenario changed to:",a.value),!g.state.userSettings.selectedEnsembleModels.every(s=>i.ensembleModelsData&&i.ensembleModelsData[s])&&a.value!=="all_models"&&!await _a()){f.handleError("Failed to fetch data for scenario.");return}const o=ae();ot(o)}})});const e=g.state.userSettings.currentEnsembleScenario||"all_models",n=document.querySelector(`input[name="ensembleScenario"][value="${e}"]`);n&&(n.checked=!0,i.currentEnsembleScenario=e),i.map&&!i.ensembleLayerGroup&&(i.ensembleLayerGroup=L.layerGroup().addTo(i.map))}function gu(){["refLevel","heightUnit","temperatureUnit","windUnit","timeZone","coordFormat","downloadFormat"].forEach(e=>{const n=document.getElementById(e);n?n.addEventListener("change",()=>{const a=n.value;g.state.userSettings[e]=a,g.save(),console.log(`Setting '${e}' changed to: ${a} and saved.`),document.dispatchEvent(new CustomEvent("ui:settingChanged",{detail:{name:e,value:a}}))}):console.warn(`Select element with id '${e}' not found.`)})}function pu(){const t=(e,n)=>{const a=document.getElementById(e);a&&a.addEventListener("blur",()=>{let r=parseInt(a.value)||n;const o=document.getElementById("legHeightFinal"),s=document.getElementById("legHeightBase"),l=document.getElementById("legHeightDownwind");if(!(!isNaN(r)&&r>=50&&r<=1e3&&f.validateLegHeights(o,s,l))){let u=n;const d=parseInt(o.value)||100,m=parseInt(s.value)||200,p=parseInt(l.value)||300;e==="legHeightFinal"&&(u=Math.min(m-1,100)),e==="legHeightBase"&&(u=Math.max(d+1,Math.min(p-1,200))),e==="legHeightDownwind"&&(u=Math.max(m+1,300)),a.value=u,r=u,f.handleError(`Adjusted ${e} to ${u} to maintain valid leg order.`)}g.state.userSettings[e]=r,g.save(),document.dispatchEvent(new CustomEvent("ui:inputChanged",{detail:{name:e,value:r}}))})};t("legHeightFinal",100),t("legHeightBase",200),t("legHeightDownwind",300),te("lowerLimit","change",300),te("upperLimit","change",300),te("openingAltitude","change",300,e=>isNaN(e)||e<500||e>15e3?(f.handleError("Opening altitude must be between 500 and 15000 meters."),document.dispatchEvent(new CustomEvent("ui:invalidInput",{detail:{id:"openingAltitude",defaultValue:1200}})),!1):!0),te("exitAltitude","change",300,e=>isNaN(e)||e<500||e>15e3?(f.handleError("Exit altitude must be between 500 and 15000 meters."),document.dispatchEvent(new CustomEvent("ui:invalidInput",{detail:{id:"exitAltitude",defaultValue:3e3}})),!1):!0),te("safetyHeight","change",300),te("canopySpeed","change",300),te("descentRate","change",300),te("interpStep","change",300,null),te("customLandingDirectionLL","input",100),te("customLandingDirectionRR","input",100),te("jumpRunTrackDirection","change",0),te("jumpRunTrackOffset","change",0),te("jumpRunTrackForwardOffset","change",0),te("aircraftSpeedKt","change",300),te("numberOfJumpers","change",300),te("jumperSeparation","change",300),te("cutAwayAltitude","change",300),te("terrainClearance","change",300),te("historicalDatePicker","change",300)}function yu(){const t=document.getElementById("downloadButton");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("ui:downloadClicked"))})}function wu(){const t=document.getElementById("clearHistoricalDate");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("ui:clearDateClicked"))})}function vu(){const t=document.getElementById("app-management-settings");if(!t){console.error("Ziel-Container für App-Management-Buttons nicht gefunden.");return}const e=document.createElement("div");e.id="settings-cache-buttons",e.className="settings-grid";const n=document.createElement("button");n.id="resetButton",n.textContent="Reset Settings",n.title="Resets all settings to their default values and locks all features",n.className="btn btn-danger",n.addEventListener("click",()=>{confirm("Are you sure you want to reset all settings and lock all features?")&&(localStorage.removeItem("unlockedFeatures"),localStorage.removeItem("upperWindsSettings"),window.location.reload())}),e.appendChild(document.createElement("label")),e.appendChild(n);const a=document.createElement("button");a.id="clearCacheButton",a.textContent="Clear Tile Cache",a.title="Clears cached map tiles. Pan/zoom to cache more tiles for offline use.",a.className="btn btn-danger",a.addEventListener("click",async()=>{try{const r=await ge.getCacheSize();await ge.clearCache(),f.handleMessage(`Tile cache cleared successfully (freed ${r.toFixed(2)} MB).`)}catch(r){f.handleError("Failed to clear tile cache: "+r.message)}}),e.appendChild(document.createElement("label")),e.appendChild(a),t.appendChild(e)}function Lu(){const t=document.getElementById("cacheRadiusSelect");t?(t.value=g.state.userSettings.cacheRadiusKm||10,t.addEventListener("change",()=>{if(!g.state||!g.state.userSettings){console.error("Settings not properly initialized");return}let r=parseInt(t.value,10);isNaN(r)||r<1?(r=1,f.handleMessage("Cache radius must be at least 1 km.")):r>50&&(r=50,f.handleMessage("Cache radius cannot exceed 50 km.")),t.value=r,g.state.userSettings.cacheRadiusKm=r,g.save(),console.log("Updated cacheRadiusKm:",g.state.userSettings.cacheRadiusKm)}),console.log("cacheRadiusSelect listener attached, initial value:",t.value)):console.warn("cacheRadiusSelect not found in DOM");const e=document.getElementById("cacheZoomMin"),n=document.getElementById("cacheZoomMax");if(e&&n){const r=()=>{let s=parseInt(e.value,10),l=parseInt(n.value,10);(isNaN(s)||s<6)&&(s=6),(isNaN(l)||l>15)&&(l=15),s>l&&(l=s,n.value=l,f.handleMessage("Max zoom cannot be less than min zoom.")),e.value=s,n.value=l;const c=Array.from({length:l-s+1},(u,d)=>s+d);g.state.userSettings.cacheZoomLevels=c,g.save(),console.log("Updated cacheZoomLevels:",g.state.userSettings.cacheZoomLevels)},o=g.state.userSettings.cacheZoomLevels||[11,12,13,14];e.value=Math.min(...o),n.value=Math.max(...o),e.addEventListener("change",r),n.addEventListener("change",r)}else console.warn("Zoom level input fields not found in DOM");const a=document.getElementById("recacheNowButton");a?(a.addEventListener("click",()=>{Uo({map:i.map,lastLat:i.lastLat,lastLng:i.lastLng,baseMaps:i.baseMaps,onProgress:Ut,onComplete:r=>{Oe(),r&&je(r)},onCancel:()=>{Oe(),je("Caching cancelled.")}})}),console.log("recacheNowButton listener attached")):console.warn("recacheNowButton not found in DOM")}function Mu(){const t=document.getElementById("harpCoordInput"),e=document.getElementById("placeHarpCoordButton"),n=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');if(!t||!e||!n){console.warn("HARP coordinate input elements not found. Skipping setup.");return}e.addEventListener("click",async()=>{const a=t.value.trim();if(!a){f.handleError("Please enter coordinates.");return}const r=Bo(a);if(r){i.harpMarker&&i.map.removeLayer(i.harpMarker),i.harpMarker=Zo(r.lat,r.lng).addTo(i.map),i.map.panTo([r.lat,r.lng]),g.state.userSettings.harpLat=r.lat,g.state.userSettings.harpLng=r.lng,g.state.userSettings.jumpRunTrackOffset=0,g.state.userSettings.jumpRunTrackForwardOffset=0,console.log("HARP placed via coords. JRT offsets reset to 0."),g.save(),f.handleMessage("HARP marker placed successfully."),n.disabled=!1,n.checked=!0,document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged")),document.dispatchEvent(new CustomEvent("ui:recalculateJump")),document.dispatchEvent(new CustomEvent("harp:updated"));const o=document.querySelector(".main-layout");o&&o.classList.remove("sidebar-expanded","data-panel-visible"),document.querySelectorAll(".sidebar-icon.active").forEach(s=>s.classList.remove("active")),setTimeout(()=>{i.map&&i.map.invalidateSize({animate:!0})},300)}else f.handleError("Invalid coordinates. Please enter a valid MGRS or Decimal Degree format.")})}function bu(){const t=document.getElementById("findJumpShipBtn");t&&t.addEventListener("click",()=>{qo()}),document.addEventListener("adsb:showSelection",n=>{const{aircraftList:a}=n.detail,r=document.getElementById("adsbSelectionModal"),o=document.getElementById("aircraftList"),s=document.getElementById("adsbCancel");!r||!o||!s||(o.innerHTML="",a.sort((l,c)=>c.altitude-l.altitude),a.forEach(l=>{const c=document.createElement("li");c.textContent=`${l.callsign} / ${l.altitude} ft`,c.onclick=()=>{r.style.display="none",Yc(l)},o.appendChild(c)}),s.onclick=()=>{r.style.display="none"},r.style.display="flex")}),document.addEventListener("adsb:aircraftSelected",n=>{const{aircraft:a,attribution:r}=n.detail;i.aircraftMarker&&i.map.removeLayer(i.aircraftMarker),wr(),mc(a.lat,a.lon,a.track).bindTooltip("",{permanent:!0,direction:"top",offset:[0,-15],className:"adsb-tooltip"}),i.map&&i.map.attributionControl&&i.map.attributionControl.addAttribution(r),document.dispatchEvent(new CustomEvent("adsb:aircraftUpdated",{detail:{aircraft:a}}))}),document.addEventListener("adsb:aircraftUpdated",n=>{const{aircraft:a}=n.detail;i.aircraftMarker&&a.lat&&a.lon&&(i.aircraftMarker.setLatLng([a.lat,a.lon]),a.track&&i.aircraftMarker.setRotationAngle(a.track),e(a),Xl(i.adsbTrackPoints))}),document.addEventListener("adsb:trackingStopped",n=>{const{attribution:a}=n.detail;i.aircraftMarker&&(i.map.removeLayer(i.aircraftMarker),i.aircraftMarker=null),wr(),i.map&&i.map.attributionControl&&i.map.attributionControl.removeAttribution(a)});function e(n){if(!i.aircraftMarker)return;const a=g.getValue("heightUnit","m"),r=g.getValue("windUnit","kt"),o=n.altitude,s=a==="m"?`${Math.round(o*.3048)} m`:`${o} ft`,l=n.velocity,c=f.convertWind(l,r,"kt"),u=`${r==="bft"?Math.round(c):c.toFixed(0)} ${r}`;let d="Level";if(n.vertical_rate){const p=n.vertical_rate;p>100?d=`+${p} ft/min`:p<-100&&(d=`${p} ft/min`)}const m=`
            <strong>${n.callsign||"N/A"}</strong><br>
            Altitude: ${s}<br>
            Speed: ${u}<br>
            V/S: ${d}
        `;i.aircraftMarker.setTooltipContent(m)}}function Su(t){const e=document.getElementById("ensembleModelsSubmenu");e&&(e.innerHTML="",t.forEach(n=>{const a=document.createElement("li"),r=document.createElement("label");r.className="radio-label";const o=document.createElement("input");o.type="checkbox",o.name="ensembleModel",o.value=n,o.checked=g.state.userSettings.selectedEnsembleModels.includes(n),o.addEventListener("change",async()=>{const s=Array.from(e.querySelectorAll("input:checked")).map(c=>c.value);if(g.state.userSettings.selectedEnsembleModels=s,g.save(),await _a()){const c=ae();ot(c)}}),r.append(o,` ${n.replace(/_/g," ").toUpperCase()}`),a.appendChild(r),e.appendChild(a)}))}function Eu(){const t=document.getElementById("findPoisInViewBtn");if(!t){console.warn("POI search button not found.");return}t.addEventListener("click",async()=>{if(!i.map){f.handleError("Map is not available.");return}const e=i.map.getZoom(),n=10;if(e<n){Ye(`Please zoom in to Level ${n}+ to search for dropzones.`);return}try{wt(!0,"Searching for Dropzones...");const a=i.map.getBounds(),r=a.getSouthWest(),o=a.getNorthEast(),s=await Bl(r.lat,r.lng,o.lat,o.lng);dc(s);const l=await kl(()=>Promise.resolve().then(()=>Pc),void 0);l&&typeof l.renderResultsList=="function"&&l.renderResultsList(s)}catch(a){console.error("Error during POI search:",a),f.handleError("An error occurred during the search.")}finally{wt(!1)}})}function _u(){Lr||(console.log("Initializing all UI event listeners..."),Xc(),Qc(),eu(),tu(),nu(),ru(),ou(),hu(),fu(),gu(),pu(),yu(),wu(),iu(),su(),lu(),cu(),uu(),du(),mu(),vu(),Lu(),Mu(),bu(),Eu(),au(),document.addEventListener("loading:start",t=>wt(!0,t.detail.message)),document.addEventListener("loading:stop",()=>wt(!1)),Lr=!0,console.log("Event listeners initialized successfully (first and only time)."))}function Mr(){if(i.autoupdateInterval){console.log("[AutoupdateManager] Autoupdate is already running.");return}if(!navigator.onLine){f.handleError("Cannot enable autoupdate while offline.");const t=document.getElementById("autoupdateCheckbox");t&&(t.checked=!1),g.state.userSettings.autoupdate=!1,g.save();return}console.log("[AutoupdateManager] Starting autoupdate interval."),document.dispatchEvent(new CustomEvent("autoupdate:tick",{detail:{isInitialTick:!0}})),i.autoupdateInterval=setInterval(()=>{console.log("[AutoupdateManager] Tick..."),document.dispatchEvent(new CustomEvent("autoupdate:tick",{detail:{isInitialTick:!1}}))},60*1e3),f.handleMessage("Autoupdate enabled")}function Yo(){i.autoupdateInterval&&(clearInterval(i.autoupdateInterval),i.autoupdateInterval=null,console.log("[AutoupdateManager] Stopped autoupdate interval."),f.handleMessage("Autoupdate disabled"))}function ku(){var e;const t=document.getElementById("autoupdateCheckbox");if(!t){console.warn("[AutoupdateManager] Autoupdate checkbox not found.");return}t.checked=g.state.userSettings.autoupdate,t.addEventListener("change",()=>{g.state.userSettings.autoupdate=t.checked,g.save();const n=document.getElementById("historicalDatePicker");if(t.checked&&(n!=null&&n.value)){t.checked=!1,g.state.userSettings.autoupdate=!1,g.save(),f.handleError("Autoupdate cannot be enabled with a historical date set.");return}t.checked?Mr():Yo()}),g.state.userSettings.autoupdate&&!((e=document.getElementById("historicalDatePicker"))!=null&&e.value)&&Mr()}let sn=!1,Nt=null;async function Tu(){i.watchId!==null||sn||(sn=!0,Nt||(Nt=(async()=>{console.log("[LiveTrackingManager] Attempting to start position tracking...");const t=localStorage.getItem("hasAcknowledgedLocationDisclosure"),e=async()=>{const{Geolocation:n,isNative:a}=await _t();if(console.log("[LiveTrackingManager] Platform:",a?window.Capacitor.getPlatform():"Web","IsNative:",a),a&&n)try{const r=await Cu();if(console.log("[LiveTrackingManager] Permissions result:",r),!r){console.warn("[LiveTrackingManager] Permissions not granted, stopping tracking.");return}const o=await n.watchPosition({enableHighAccuracy:!0,timeout:1e4,maximumAge:0},(s,l)=>{if(l){console.error("[LiveTrackingManager] Geolocation error:",l),f.handleError(`Geolocation error: ${l.message||"Unknown error"}`),ln();return}s&&(console.log("[LiveTrackingManager] Received position:",s.coords),br(s))});i.watchId=o,console.log("[LiveTrackingManager] Native Geolocation watcher started:",o),document.dispatchEvent(new CustomEvent("tracking:started"))}catch(r){console.error("[LiveTrackingManager] Failed to start native tracking:",r),f.handleError(`Failed to start tracking: ${r.message||"Unknown error"}`),ln()}else{if(console.log("[LiveTrackingManager] Using navigator.geolocation for tracking (Web)."),!navigator.geolocation){f.handleError("Geolocation is not supported by your browser."),document.dispatchEvent(new CustomEvent("tracking:stopped"));return}i.watchId=navigator.geolocation.watchPosition(r=>{console.log("[LiveTrackingManager] Web position:",r.coords),br(r)},r=>{console.error("[LiveTrackingManager] Web Geolocation error:",r),f.handleError(`Geolocation error: ${r.message||"Unknown error"}`),ln()},{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}),console.log("[LiveTrackingManager] Web Geolocation watcher started:",i.watchId),document.dispatchEvent(new CustomEvent("tracking:started"))}};t?e():xl({title:"Notice on Location Use",message:"DZMaster collects location data to enable the functions <strong>'Live Tracking'</strong> and <strong>'Automatic Jump Recording'</strong>. This also happens when the app is running in the background or the screen is off in order to record your complete jump. This data is only stored locally on your device and is not shared.",onConfirm:()=>{localStorage.setItem("hasAcknowledgedLocationDisclosure","true"),e()},onCancel:()=>{const n=document.getElementById("trackPositionCheckbox");n&&(n.checked=!1),Settings.state.userSettings.trackPosition=!1,Settings.save(),f.handleMessage("Location access canceled.")}}),sn=!1,Nt=null})()),await Nt)}async function ln(){if(i.watchId!==null){const{Geolocation:t,isNative:e}=await _t();if(e&&t)try{await t.clearWatch({id:i.watchId}),console.log("[LiveTrackingManager] Stopped native Geolocation watcher:",i.watchId)}catch(n){console.error("[LiveTrackingManager] Error stopping native watcher:",n)}else navigator.geolocation&&(navigator.geolocation.clearWatch(i.watchId),console.log("[LiveTrackingManager] Stopped navigator.geolocation watcher:",i.watchId));i.watchId=null}i.liveMarker&&i.map.removeLayer(i.liveMarker),i.accuracyCircle&&i.map.removeLayer(i.accuracyCircle),i.liveMarker=null,i.accuracyCircle=null,i.prevLat=null,i.prevLng=null,i.altitudeCorrectionOffset=0,i.prevTime=null,i.prevAltitude=null,i.lastSmoothedSpeedMs=0,i.lastSmoothedRateOfClimbMps=0,i.lastDirection="N/A",i.lastDeviceAltitude=null,i.lastAltitudeAccuracy=null,i.lastAccuracy=null,sn=!1,Nt=null,document.dispatchEvent(new CustomEvent("tracking:stopped"))}const br=f.debounce(async t=>{if(console.log("[LiveTrackingManager] Received position data:",t),!i.map){console.warn("[LiveTrackingManager] Map not initialized, skipping position update.");return}const{latitude:e,longitude:n,accuracy:a,altitude:r,altitudeAccuracy:o}=t.coords;if(i.recordedTrackPoints.length===0&&i.altitudeCorrectionOffset===0&&r!==null&&i.lastAltitude!=="N/A"){const w=Math.abs(r-i.lastAltitude);w<150?(i.altitudeCorrectionOffset=r-i.lastAltitude,console.log(`Bodenstart erkannt. Korrektur-Offset berechnet: ${i.altitudeCorrectionOffset.toFixed(2)}m`)):(i.altitudeCorrectionOffset=0,console.warn(`Start in der Luft erkannt (Höhendifferenz: ${w.toFixed(0)}m). Es wird keine Höhenkorrektur angewendet.`),f.handleMessage("Airborne start: Altitudes are uncorrected (Ellipsoid)."))}const s=r!==null&&i.altitudeCorrectionOffset!==0?r-i.altitudeCorrectionOffset:r,c=!i.liveMarker?500:Te.GEOLOCATION_ACCURACY_THRESHOLD_M;if(a>c){console.log(`[LiveTrackingManager] Skipping position update. Accuracy (${a}m) is lower than threshold (${c}m).`);return}const u=Date.now();let d=0,m="N/A",p=0;if(i.prevLat!==null&&i.prevLng!==null&&i.prevTime!==null&&i.prevAltitude!==null){const w=(u-i.prevTime)/1e3;w>en.MIN_TIME_DIFF_FOR_SPEED_CALC_S&&(d=i.map.distance([i.prevLat,i.prevLng],[e,n])/w,m=f.calculateBearing(i.prevLat,i.prevLng,e,n),p=(r-i.prevAltitude)/w)}const h=d<en.SPEED_SMOOTHING_TRESHOLD?en.SPEED_SMOOTHING_LOW:en.SPEED_SMOOTHING_HIGH;i.lastSmoothedSpeedMs=h*d+(1-h)*i.lastSmoothedSpeedMs;const v=.5;i.lastSmoothedRateOfClimbMps=v*p+(1-v)*(i.lastSmoothedRateOfClimbMps||0),i.liveMarker?(i.liveMarker.setLatLng([e,n]),i.liveMarker.setIcon(Sr(m))):i.liveMarker=L.marker([e,n],{icon:Sr(m),zIndexOffset:1e3,pmIgnore:!0}).addTo(i.map),a&&Au(e,n,a),i.prevLat=e,i.prevLng=n,i.prevTime=u,i.prevAltitude=r;const b=new CustomEvent("tracking:positionUpdated",{detail:{latitude:e,longitude:n,deviceAltitude:s,altitudeAccuracy:o,accuracy:a,speedMs:i.lastSmoothedSpeedMs,rateOfClimbMps:i.lastSmoothedRateOfClimbMps,direction:typeof m=="number"?m.toFixed(0):"N/A"},bubbles:!0,cancelable:!0});console.log("[LiveTrackingManager] Dispatching tracking:positionUpdated with data:",b.detail),document.dispatchEvent(b)},300);function Sr(t){const n=`
        <div class="live-marker-wrapper" style="transform: rotate(${typeof t=="number"&&isFinite(t)?t:0}deg);">
            <div class="live-marker-dot"></div>
            <div class="live-marker-arrow"></div>
        </div>
    `;return L.divIcon({className:"live-marker-container",html:n,iconSize:[24,24],iconAnchor:[12,12],pmIgnore:!0})}function Au(t,e,n){i.accuracyCircle&&i.map.removeLayer(i.accuracyCircle),i.accuracyCircle=L.circle([t,e],{radius:n,color:"blue",fillOpacity:.1,weight:1,dashArray:"5, 5",pmIgnore:!0}).addTo(i.map)}async function Cu(){try{const{Geolocation:t,isInitialized:e}=await _t();if(!e)return console.error("Capacitor not fully initialized"),!1;await new Promise(a=>setTimeout(a,100));const n=await t.checkPermissions();if(console.log("Initial geolocation permissions state:",n),n.location==="denied")return f.handleError('GPS permission was denied. Please enable "Always" in the app settings.'),!1;if(n.location!=="granted")try{const a=await t.requestPermissions({permissions:["location","coarseLocation"]});if(console.log("New geolocation permissions state:",a),a.location!=="granted")return f.handleError("GPS permission is required for live tracking."),!1}catch(a){return console.error("[LiveTrackingManager] Permission request error:",a),f.handleError(`Failed to request permissions: ${a.message}`),!1}return!0}catch(t){return console.error("Error in checkAndRequestPermissions:",t),f.handleError("Could not check location permissions."),!1}}const Xo=f.debounce(se,300);L.Control.Coordinates=L.Control.extend({options:{position:"bottomleft"},onAdd:function(t){var e=L.DomUtil.create("div","leaflet-control-coordinates");return e.style.background="rgba(255, 255, 255, 0.8)",e.style.padding="5px",e.style.borderRadius="4px",e.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",e.innerHTML="Move mouse over map",this._container=e,e},update:function(t){this._container.innerHTML=t}});f.setErrorHandler(hn);f.setMessageHandler(je);f.handleMessage=je;const Qo=()=>g.getValue("temperatureUnit","radio","C"),vt=()=>g.getValue("heightUnit","radio","m"),pn=()=>g.getValue("windUnit","radio","kt"),ei=()=>g.getValue("coordFormat","radio","Decimal"),Iu=()=>g.getValue("downloadFormat","radio","csv");function Nu(){Sl(!0),g.initialize(),g.state.isPlannerUnlocked=g.state.unlockedFeatures.planner,console.log("Initial unlock status for planner:",g.state.isPlannerUnlocked),!i.isInitialized&&(i.isInitialized=!0,console.log("Initializing app"))}function Du(){Fe("modelSelect",g.state.userSettings.model),Fe("refLevel",g.state.userSettings.refLevel),Fe("heightUnit",g.state.userSettings.heightUnit),Fe("temperatureUnit",g.state.userSettings.temperatureUnit),Fe("windUnit",g.state.userSettings.windUnit),Fe("timeZone",g.state.userSettings.timeZone),Fe("coordFormat",g.state.userSettings.coordFormat),Fe("downloadFormat",g.state.userSettings.downloadFormat),Uu("landingDirection",g.state.userSettings.landingDirection),ne("canopySpeed",g.state.userSettings.canopySpeed),ne("descentRate",g.state.userSettings.descentRate),ne("legHeightDownwind",g.state.userSettings.legHeightDownwind),ne("legHeightBase",g.state.userSettings.legHeightBase),ne("legHeightFinal",g.state.userSettings.legHeightFinal),ne("customLandingDirectionLL",g.state.userSettings.customLandingDirectionLL),ne("customLandingDirectionRR",g.state.userSettings.customLandingDirectionRR),ne("lowerLimit",g.state.userSettings.lowerLimit),ne("upperLimit",g.state.userSettings.upperLimit),ne("openingAltitude",g.state.userSettings.openingAltitude),ne("exitAltitude",g.state.userSettings.exitAltitude),ne("safetyHeight",g.state.userSettings.safetyHeight),Fe("interpStep",g.state.userSettings.interpStep),ne("aircraftSpeedKt",g.state.userSettings.aircraftSpeedKt),ne("jumpRunTrackOffset",g.state.userSettings.jumpRunTrackOffset),ne("numberOfJumpers",g.state.userSettings.numberOfJumpers),tt("showTableCheckbox",g.state.userSettings.showTable),tt("calculateJumpCheckbox",g.state.userSettings.calculateJump),tt("showLandingPattern",g.state.userSettings.showLandingPattern),tt("showJumpRunTrack",g.state.userSettings.showJumpRunTrack),tt("showCanopyAreaCheckbox",g.state.userSettings.showCanopyArea),tt("showExitAreaCheckbox",g.state.userSettings.showExitArea),tt("showCutAwayFinder",g.state.userSettings.showCutAwayFinder),ne("terrainClearance",g.state.userSettings.terrainClearance),g.state.userSettings.isCustomJumpRunDirection=g.state.userSettings.isCustomJumpRunDirection||!1;const t=document.getElementById("customLandingDirectionLL"),e=document.getElementById("customLandingDirectionRR");t&&g.state.userSettings.customLandingDirectionLL!==""&&!isNaN(g.state.userSettings.customLandingDirectionLL)&&(t.value=g.state.userSettings.customLandingDirectionLL),e&&g.state.userSettings.customLandingDirectionRR!==""&&!isNaN(g.state.userSettings.customLandingDirectionRR)&&(e.value=g.state.userSettings.customLandingDirectionRR);const n=xo(g.state.userSettings.aircraftSpeedKt);ne("jumperSeparation",n),g.state.userSettings.jumperSeparation=n,g.save();const a=document.getElementById("showJumpMasterLine");a&&(a.disabled=!g.state.userSettings.trackPosition,a.style.opacity=a.disabled?"0.5":"1",a.title=a.disabled?"Enable Live Tracking to use Jump Master Line":"");const r=document.getElementById("jumpRunTrackDirection");r&&(r.textContent="-"),ti()}function se(){const t=ae(),e=Ie(),n=vt();let a=g.state.userSettings.openingAltitude,r=g.state.userSettings.exitAltitude;if(n==="ft"&&(a=f.convertFeetToMeters(a),r=f.convertFeetToMeters(r)),!g.state.userSettings.calculateJump){rn(null),la(null);return}if(!i.weatherData||!i.lastLat||!i.lastLng){rn(null);return}const o=be(i.weatherData,t,e,Math.round(i.lastAltitude),n),s={exitCircles:[],canopyCircles:[],canopyLabels:[]};if(g.state.userSettings.showExitArea){const c=$o(o);if(c){s.exitCircles.push({center:[c.greenLatFull,c.greenLngFull],radius:c.greenRadius,color:"green",fillColor:"green",fillOpacity:.2,weight:2});const u=`
                Exit areas calculated with:<br>
                Throw/Drift: ${Number.isFinite(c.freeFallDirection)?Math.round(c.freeFallDirection):"N/A"}° ${Number.isFinite(c.freeFallDistance)?Math.round(c.freeFallDistance):"N/A"} m<br>
                Free Fall Time: ${c.freeFallTime!=null&&!isNaN(c.freeFallTime)?Math.round(c.freeFallTime):"N/A"} sec
            `;s.exitCircles.push({center:[c.greenLat,c.greenLng],radius:c.darkGreenRadius,color:"darkgreen",fillColor:"darkgreen",fillOpacity:.2,weight:2,tooltip:u})}}if(g.state.userSettings.showCanopyArea){const c=Oo(o);if(c){const u=f.calculateNewCenter(c.redLat,c.redLng,c.displacementFull,c.directionFull);s.canopyCircles.push({center:u,radius:c.radiusFull,color:"red",weight:2,opacity:.8,fillOpacity:0}),c.additionalBlueRadii.forEach((d,m)=>{const p=f.calculateNewCenter(c.blueLat,c.blueLng,c.additionalBlueDisplacements[m],c.additionalBlueDirections[m]);s.canopyCircles.push({center:p,radius:d,color:"blue",weight:1,fillColor:"blue",fillOpacity:.1,opacity:1}),s.canopyLabels.push({center:p,radius:d,text:`${Math.round(c.additionalBlueUpperLimits[m])}m`})})}}rn(s);let l=null;if(g.state.userSettings.showCutAwayFinder&&i.cutAwayLat!==null){const c=Ea(o);c&&(l={center:c.center,radius:c.radius,tooltipContent:c.tooltipContent})}la(l)}function at(){var A;console.log("Calculating mean wind with model:",document.getElementById("modelSelect").value,"weatherData:",i.weatherData);const t=((A=document.getElementById("refLevel"))==null?void 0:A.value)||"AGL",e=g.getValue("heightUnit","radio","m"),n=g.getValue("windUnit","radio","kt"),a=document.getElementById("timeSlider").value||0,r=be(i.weatherData,a,Ie(),Math.round(i.lastAltitude),e);let o=parseFloat(document.getElementById("lowerLimit").value)||0,s=parseFloat(document.getElementById("upperLimit").value);const l=Math.round(i.lastAltitude);if(!i.weatherData||i.lastAltitude==="N/A"){f.handleError("Cannot calculate mean wind: missing data or altitude");return}o=e==="ft"?o/3.28084:o,s=e==="ft"?s/3.28084:s;let c=t==="AGL"?o+l:o,u=t==="AGL"?s+l:s;if(isNaN(o)||isNaN(s)||o>=s){f.handleError("Invalid layer limits. Ensure Lower < Upper and both are numbers.");return}if(t==="AMSL"&&u<l){f.handleError(`The entire selected layer (${Math.round(f.convertHeight(c,e))}-${Math.round(f.convertHeight(u,e))} ${e}) is below the terrain altitude of ${Math.round(f.convertHeight(l,e))} ${e}.`),document.getElementById("meanWindResult").innerHTML="Mean wind: N/A (Layer is below ground)";return}if(t==="AMSL"&&c<l){f.handleMessage(`Note: Lower limit adjusted to terrain altitude (${Math.round(f.convertHeight(l,e))} ${e}) as it cannot be below ground level.`);const T=Math.round(f.convertHeight(l,e));ne("lowerLimit",T),g.state.userSettings.lowerLimit=T,g.save(),c=l}if(!r||r.length===0){f.handleError("No valid weather data available to calculate mean wind.");return}const d=r.map(T=>T.height),m=r.map(T=>parseFloat(T.dir)||0),p=r.map(T=>f.convertWind(parseFloat(T.spd)||0,n,"km/h")),h=p.map((T,N)=>-T*Math.sin(m[N]*Math.PI/180)),v=p.map((T,N)=>-T*Math.cos(m[N]*Math.PI/180)),b=f.calculateMeanWind(d,h,v,c,u),[w,M]=b,y=f.roundToTens(w)===0&&w>=0&&w<5?360:f.roundToTens(w),_=Math.round(f.convertHeight(o,e)),S=Math.round(f.convertHeight(s,e));f.convertWind(M,n,"kt");const E=Number.isFinite(M)?n==="bft"?Math.round(M):M.toFixed(1):"N/A",k=`Mean wind (${_}-${S} ${e} ${t}): ${y}° ${E} ${n}`;document.getElementById("meanWindResult").innerHTML=k,console.log("Calculated Mean Wind:",k,"u:",b[2],"v:",b[3])}async function Pu(){if(!i.lastLat||!i.lastLng){console.warn("No location selected, cannot update weather data"),f.handleError("Please select a location to enable autoupdate."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,g.state.userSettings.autoupdate=!1,g.save();return}if(!navigator.onLine){console.warn("Cannot update weather data: offline"),f.handleError("Cannot update weather data while offline."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,g.state.userSettings.autoupdate=!1,g.save();return}const t=document.getElementById("timeSlider");if(!t){console.warn("Time slider not found, cannot update to current hour");return}const n=new Date().getUTCHours();t.value=n,console.log(`Set slider to current hour: ${n}`);try{await nt(i.lastLat,i.lastLng,null,!1),console.log("Weather data fetched for current hour"),await ze(n,"weather-table-container","selectedTime"),i.lastAltitude!=="N/A"&&at(),g.state.userSettings.calculateJump&&g.state.isCalculateJumpUnlocked&&(Xo(),Ea(),g.state.userSettings.showJumpRunTrack&&he()),console.log("Updated all displays for current hour")}catch(a){console.error("Error updating to current hour:",a),f.handleError("Failed to update weather data: "+a.message)}}function Fu(t){var v;if(!i.weatherData||!i.weatherData.time){f.handleError("No weather data available to download.");return}const e=document.getElementById("timeSlider").value||0,n=document.getElementById("modelSelect").value.toUpperCase(),a=f.formatTime(i.weatherData.time[e]).replace(" ","_"),r=`${a}_${n}_${t}.txt`,s={ATAK:{interpStep:1e3,heightUnit:"ft",refLevel:"AGL",windUnit:"kt"},Windwatch:{interpStep:100,heightUnit:"ft",refLevel:"AGL",windUnit:"km/h"},HEIDIS:{interpStep:100,heightUnit:"m",refLevel:"AGL",temperatureUnit:"C",windUnit:"m/s"},Customized:{}}[t]||{},l={interpStep:s.interpStep||Ie(),heightUnit:s.heightUnit||g.getValue("heightUnit","radio","m"),refLevel:s.refLevel||((v=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:v.value)||"AGL",windUnit:s.windUnit||g.getValue("windUnit","radio","kt"),temperatureUnit:s.temperatureUnit||g.getValue("temperatureUnit","radio","C")},c=be(i.weatherData,e,l.interpStep,Math.round(i.lastAltitude),l.heightUnit);if(!c||c.length===0){f.handleError("No interpolated data available to download.");return}let u="",d="";switch(t){case"ATAK":d=`Alt	Dir	Spd
${l.heightUnit}${l.refLevel}	deg	kts
`;break;case"Windwatch":const b=Math.round(f.convertHeight(i.lastAltitude,"ft"));d=`Version 1.0, ID = 9999999999
${a}, Ground Level: ${b} ft
Windsond ${n}
AGL[ft] Wind[°] Speed[km/h]
`;break;case"HEIDIS":case"Customized":default:d=`h(${l.heightUnit}${l.refLevel}) p(hPa) T(${l.temperatureUnit}) Dew(${l.temperatureUnit}) Dir(°) Spd(${l.windUnit}) RH(%)
`;break}u+=d,c.forEach(b=>{const w=Math.round(b.displayHeight),M=Math.round(b.dir),y=f.convertWind(b.spd,l.windUnit,"km/h"),_=Number.isFinite(y)?l.windUnit==="bft"?Math.round(y):y.toFixed(1):"N/A";if(t==="ATAK"||t==="Windwatch")u+=`${w}	${M}	${Math.round(y)}
`;else{const S=b.pressure==="N/A"?"N/A":b.pressure.toFixed(1),E=f.convertTemperature(b.temp,l.temperatureUnit),k=E==="N/A"?"N/A":E.toFixed(1),A=f.convertTemperature(b.dew,l.temperatureUnit),T=A==="N/A"?"N/A":A.toFixed(1),N=b.rh==="N/A"?"N/A":Math.round(b.rh);u+=`${w} ${S} ${k} ${T} ${M} ${_} ${N}
`}});const m=new Blob([u],{type:"text/plain"}),p=window.URL.createObjectURL(m),h=document.createElement("a");h.href=p,h.download=r,document.body.appendChild(h),h.click(),document.body.removeChild(h),window.URL.revokeObjectURL(p)}async function xu(){if(!i.weatherData||!i.weatherData.time){f.handleError("No weather data available to download.");return}const{time:t,wind_direction_10m:e,wind_speed_10m:n,wind_gusts_10m:a,visibility:r,weather_code:o,temperature_2m:s}=i.weatherData,l=pn(),c=Qo(),u=vt(),d=g.getValue("timeZone","radio","Z"),m=document.getElementById("modelSelect").value.toUpperCase(),h=`${f.formatTime(t[0]).replace(" ","_")}_${m}_Surface.txt`;let b=`Date	${`Time (${d})`}	Wind Dir (°)	Wind Spd/Gust (${l})	Visibility (m)	Weather	Clouds	Temp (${c})
`;for(let _=0;_<t.length;_++){const S=await f.getDisplayTime(t[_],i.lastLat,i.lastLng,d),[E,k]=S.split(" "),A=f.convertWind(n[_],l,"km/h"),T=f.convertWind(a[_],l,"km/h"),N=typeof A=="number"?A.toFixed(0):"N/A",D=typeof T=="number"?T.toFixed(0):"N/A",x=`${N} G ${D}`,C=f.convertTemperature(s[_],c),I=typeof C=="number"?C.toFixed(1):"N/A",O=f.formatVisibility(r==null?void 0:r[_]),R=f.translateWmoCodeToTaf(o==null?void 0:o[_]),W=be(i.weatherData,_,100,Math.round(i.lastAltitude),u),z=f.getCloudLayersForMetar(W,u);b+=`${E}	${k}	${e[_]}	${x}	${O}	${R}	${z}	${I}
`}const w=new Blob([b],{type:"text/plain"}),M=window.URL.createObjectURL(w),y=document.createElement("a");y.href=M,y.download=h,document.body.appendChild(y),y.click(),document.body.removeChild(y),window.URL.revokeObjectURL(M)}async function $u(){if(!i.weatherData||!i.lastLat||!i.lastLng){f.handleError("No weather data available for the report.");return}const t=i.lastLat,e=i.lastLng,n=document.getElementById("modelSelect").value.toUpperCase(),a=i.lastModelRun||"N/A",r=F.utc().toFormat("yyyy-MM-dd"),o=pn(),s=Qo(),l=vt(),c=g.getValue("timeZone","radio","Z"),u=g.getValue("upperLimit","number",3e3);let d=`Lat ${t.toFixed(4)}, Lon ${e.toFixed(4)}`;try{d=(await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t}&lon=${e}`)).json()).display_name||d}catch{console.warn("Reverse geocoding failed, using coordinates.")}let m=`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DZMaster Weather Briefing</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 1000px; margin: 20px auto; padding: 20px; }
        h1, h2, h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { padding: 8px 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .header-info { background-color: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .header-info p { margin: 5px 0; }
        .section { margin-top: 40px; }
        @media print {
            body { font-size: 10pt; }
            .container { margin: 0; padding: 0; max-width: 100%; }
            h1, h2, h3 { page-break-after: avoid; }
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>DZMaster - Weather Briefing</h1>
    <div class="header-info">
        <p><strong>Location:</strong> ${d}</p>
        <p><strong>Model:</strong> ${n}</p>
        <p><strong>Model Run:</strong> ${a}</p>
        <p><strong>Forecast Day:</strong> ${r}</p>
    </div>

    <div class="section">
        <h2>Surface Data (Today)</h2>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time (${c})</th>
                    <th>Wind Dir (°)</th>
                    <th>Wind (${o})</th>
                    <th>Visibility (m)</th>
                    <th>Weather</th>
                    <th>Clouds</th>
                    <th>Temp (${s})</th>
                </tr>
            </thead>
            <tbody>`;const{time:p,wind_direction_10m:h,wind_speed_10m:v,wind_gusts_10m:b,visibility:w,weather_code:M,temperature_2m:y}=i.weatherData,_=p.map((E,k)=>F.fromISO(E).toFormat("yyyy-MM-dd")===r?k:-1).filter(E=>E!==-1);for(const E of _){const k=await f.getDisplayTime(p[E],t,e,c),[A,T]=k.split(" "),N=f.convertWind(v[E],o,"km/h"),D=f.convertWind(b[E],o,"km/h"),x=`${typeof N=="number"?N.toFixed(0):"N/A"} G ${typeof D=="number"?D.toFixed(0):"N/A"}`,C=f.convertTemperature(y[E],s),I=be(i.weatherData,E,100,Math.round(i.lastAltitude),l),O=f.getCloudLayersForMetar(I,l),R=f.formatWindDirection(h[E]),W=f.formatVisibility(w==null?void 0:w[E]);m+=`<tr>
            <td>${A}</td>
            <td>${T}</td>
            <td>${R}</td>
            <td>${x}</td>
            <td>${W}</td>
            <td>${f.translateWmoCodeToTaf(M==null?void 0:M[E])}</td>
            <td>${O}</td>
            <td>${typeof C=="number"?C.toFixed(0):"N/A"}</td>
        </tr>`}m+="</tbody></table></div>",m+=`<div class="section">
                <h2>Upper Air Data (Today, hourly, up to ${u}${l} AGL)</h2>`;for(const E of _){const k=await f.getDisplayTime(p[E],t,e,"Z");m+=`<h3>${k}</h3>
                 <table>
                    <thead>
                        <tr>
                            <th>h(${l} AGL)</th>
                            <th>p(hPa)</th>
                            <th>T(${s})</th>
                            <th>Dew(${s})</th>
                            <th>Dir(°)</th>
                            <th>Spd(${o})</th>
                            <th>RH(%)</th>
                            <th>Clouds(%)</th>
                        </tr>
                    </thead>
                    <tbody>`,be(i.weatherData,E,100,Math.round(i.lastAltitude),l).filter(T=>T.displayHeight<=u).forEach(T=>{const N=f.convertTemperature(T.temp,s),D=f.convertTemperature(T.dew,s),x=f.convertWind(T.spd,o,"km/h"),C=f.formatWindDirection(T.dir);m+=`<tr>
                    <td>${T.displayHeight}</td>
                    <td>${typeof T.pressure=="number"?T.pressure.toFixed(1):"N/A"}</td>
                    <td>${typeof N=="number"?N.toFixed(1):"N/A"}</td>
                    <td>${typeof D=="number"?D.toFixed(1):"N/A"}</td>
                    <td>${C}</td>
                    <td>${typeof x=="number"?x.toFixed(1):"N/A"}</td>
                    <td>${typeof T.rh=="number"?Math.round(T.rh):"N/A"}</td>
                    <td>${typeof T.cc=="number"?Math.round(T.cc):"N/A"}</td>
                </tr>`}),m+="</tbody></table>"}m+="</div></div></body></html>";const S=window.open();S.document.open(),S.document.write(m),S.document.close()}function Er(t=!0){g.state.userSettings.customJumpRunDirection=null,g.save(),console.log("Persisted custom JRT direction has been reset.");const e=document.getElementById("jumpRunTrackDirection");e&&(e.value=""),t&&g.state.userSettings.showJumpRunTrack&&i.weatherData&&he()}async function $t(t,e=null){i.weatherData=t,i.cloudThresholds=Fo(t);const n=document.getElementById("timeSlider");if(!n)return;const r=(o=>{const s=o==null?void 0:o.temperature_2m;if(!s||s.length===0)return 0;for(let l=s.length-1;l>=0;l--)if(s[l]!==null&&s[l]!==void 0)return l;return 0})(t);if(n.max=r,n.disabled=n.max<=0,e!==null&&e<=r)n.value=e,console.log(`Slider restored to preserved index: ${e}`);else{const o=new Date().getUTCHours();o<=r?n.value=o:n.value=r,console.log(`Slider set to default (current hour or max): ${n.value}`)}await Vo(),await ze(n.value,"weather-table-container","selectedTime"),await Ge(),i.lastAltitude!=="N/A"&&at(),Cc(),console.log("Model changed. Triggering recalculation of jump parameters."),_e(),g.state.userSettings.calculateJump&&se(),g.state.userSettings.showJumpRunTrack&&he()}function ti(){const t=document.getElementById("info");t&&(t.style.display=g.state.userSettings.showTable?"block":"none");const e=document.getElementById("customLandingDirectionLL"),n=document.getElementById("customLandingDirectionRR"),a=document.getElementById("showJumpRunTrack"),r=document.getElementById("showExitAreaCheckbox");e&&(e.disabled=g.state.userSettings.landingDirection!=="LL"),n&&(n.disabled=g.state.userSettings.landingDirection!=="RR"),a&&(a.disabled=!g.state.userSettings.calculateJump),r&&(r.disabled=!g.state.userSettings.calculateJump)}function _r(){const t=document.querySelector('.sidebar-icon[data-panel-id="panel-planner"]');t&&(g.isFeatureUnlocked("planner")?(t.style.opacity="1",t.title="Planner"):(t.style.opacity="0.5",t.title="Feature locked. Click to enter password."));const e=document.querySelector('.sidebar-icon[data-panel-id="panel-data"]');e&&(g.isFeatureUnlocked("data")?(e.style.opacity="1",e.title="Data"):(e.style.opacity="0.5",e.title="Feature locked. Click to enter password."))}function fe(t=null){const e=g.state.userSettings.showJumpMasterLine;let n=null,a=null;if(i.watchId!==null&&(a=i.liveMarker?i.liveMarker.getLatLng():null,n=t||{latitude:a?a.lat:i.lastLatitude,longitude:a?a.lng:i.lastLongitude,speedMs:i.lastSmoothedSpeedMs,direction:i.lastDirection,deviceAltitude:i.lastDeviceAltitude,altitudeAccuracy:i.lastAltitudeAccuracy,accuracy:i.lastAccuracy},n.showJumpMasterLine=e),e&&a){let r=null,o="";if(g.state.userSettings.jumpMasterLineTarget==="HARP"&&i.harpMarker?(r=i.harpMarker.getLatLng(),o="HARP"):i.currentMarker&&(r=i.currentMarker.getLatLng(),o="DIP"),r){const s=i.map.distance(a,r),l=Math.round(f.calculateBearing(a.lat,a.lng,r.lat,r.lng)),c=n.speedMs>1?n.speedMs:1,u=Math.round(s/c);n.jumpMasterLineData={distance:s,bearing:l,tot:u,target:o},Kl(a,r)}}else ac();Ou(n)}function Ou(t){const e=document.getElementById("jumpmaster-dashboard");if(!e)return;if(!t){e.classList.add("hidden");return}e.classList.remove("hidden");const n=document.getElementById("dashboard-jm-coords"),a=document.getElementById("dashboard-jm-altitude"),r=document.getElementById("dashboard-jm-direction"),o=document.getElementById("dashboard-jm-speed"),s=document.getElementById("dashboard-jm-accuracy"),l=document.getElementById("dashboard-jm-vario"),c={heightUnit:vt(),effectiveWindUnit:pn()==="bft"?"kt":pn(),coordFormat:ei(),refLevel:g.getValue("refLevel","radio","AGL")},u=f.convertCoords(t.latitude,t.longitude,c.coordFormat);let d;const m=y=>`${y.deg}° ${y.min.toFixed(3)}' ${y.dir}`,p=y=>`${y.deg}°${y.min}'${y.sec.toFixed(0)}" ${y.dir}`;c.coordFormat==="MGRS"?d=u.lat:c.coordFormat==="DMS"?d=`${p(u.lat)}, ${p(u.lng)}`:c.coordFormat==="DDM"?d=`${m(u.lat)}, ${m(u.lng)}`:d=`${t.latitude.toFixed(5)}, ${t.longitude.toFixed(5)}`,n.textContent=d;let h="N/A";if(t.deviceAltitude!==null){let y=c.refLevel==="AGL"&&i.lastAltitude?t.deviceAltitude-parseFloat(i.lastAltitude):t.deviceAltitude;h=`${Math.round(f.convertHeight(y,c.heightUnit))} ${c.heightUnit}`}a.textContent=h,r.textContent=`${t.direction}°`;const v=f.convertWind(t.speedMs,c.effectiveWindUnit,"m/s"),b=c.effectiveWindUnit==="bft"?Math.round(v):v.toFixed(1);if(o.textContent=`${b} ${c.effectiveWindUnit}`,s.textContent=`± ${Math.round(f.convertHeight(t.accuracy,c.heightUnit))} ${c.heightUnit}`,l){const{rateOfClimbMps:y}=t,_=c.heightUnit==="ft"?"ft/min":"m/s";let S="N/A";l.classList.remove("vario-climb","vario-descent"),y!==null&&Number.isFinite(y)&&(_==="ft/min"?S=(y*196.85).toFixed(0):S=y.toFixed(1),y>.5?l.classList.add("vario-climb"):y<-.5&&l.classList.add("vario-descent")),l.textContent=`${S} ${_}`}const w=document.getElementById("jumpmaster-line-details"),M=t.showJumpMasterLine;if(w.classList.toggle("hidden",!M),M){const y=document.getElementById("dashboard-jm-target-label"),_=document.getElementById("dashboard-jm-bearing"),S=document.getElementById("dashboard-jm-distance"),E=document.getElementById("dashboard-jm-tot");if(t.jumpMasterLineData){const k={heightUnit:vt()};y.textContent=`JML to ${t.jumpMasterLineData.target}`,_.textContent=`${t.jumpMasterLineData.bearing}°`,S.textContent=`${Math.round(f.convertHeight(t.jumpMasterLineData.distance,k.heightUnit))} ${k.heightUnit}`,E.textContent=t.jumpMasterLineData.tot<1200?`X - ${t.jumpMasterLineData.tot} s`:"N/A"}else y.textContent="JML to --",_.textContent="--",S.textContent="--",E.textContent="--"}}function Ru(){console.log("[App] Setting up application event listeners..."),document.addEventListener("map:moved",()=>{console.log("[main-web] Map has moved or zoomed. Updating visualizations based on new view.");const t=i.map.getZoom();g.state.userSettings.calculateJump&&i.weatherData&&i.lastLat&&(t<Te.MIN_ZOOM||t>Te.MAX_ZOOM?rn(null):se()),g.state.userSettings.showJumpRunTrack&&(t<Te.MIN_ZOOM||t>Te.MAX_ZOOM?Ft(null):he()),g.state.userSettings.showLandingPattern&&_e(),g.state.userSettings.selectedEnsembleModels.length>0&&(t<Te.MIN_ZOOM||t>Te.MAX_ZOOM?Gt():ot(ae(),Ie())),ka({map:i.map,baseMaps:i.baseMaps,onProgress:Ut,onComplete:e=>{Oe(),e&&f.handleMessage(e)},onCancel:()=>{Oe(),f.handleMessage("Caching cancelled.")}})}),document.addEventListener("map:mousemove",t=>{const{lat:e,lng:n}=t.detail;i.lastMouseLatLng={lat:e,lng:n};const a=ei();let r;if(a==="MGRS")r=`MGRS: ${f.decimalToMgrs(e,n)||"N/A"}`;else if(a==="DMS"){const o=s=>`${s.deg}°${s.min}'${s.sec.toFixed(0)}" ${s.dir}`;r=`Lat: ${o(f.decimalToDms(e,!0))}, Lng: ${o(f.decimalToDms(n,!1))}`}else r=`Lat: ${e.toFixed(5)}, Lng: ${n.toFixed(5)}`;i.coordsControl&&i.coordsControl.update(`${r}<br>Elevation: Fetching...<br>QFE: Fetching...`),f.debouncedGetElevationAndQFE(e,n,({elevation:o})=>{var s,l;if(i.lastMouseLatLng&&i.coordsControl){const c=Math.abs(i.lastMouseLatLng.lat-e),u=Math.abs(i.lastMouseLatLng.lng-n),d=.05;if(c<d&&u<d){const m=vt();let p=o==="N/A"?"N/A":o;p!=="N/A"&&(p=f.convertHeight(p,m),p=Math.round(p));let h="N/A";if(o!=="N/A"&&i.weatherData&&i.weatherData.surface_pressure){const v=parseInt((s=document.getElementById("timeSlider"))==null?void 0:s.value)||0,b=i.weatherData.surface_pressure[v],w=((l=i.weatherData.temperature_2m)==null?void 0:l[v])||15,M=i.lastAltitude!=="N/A"?i.lastAltitude:0,y=f.calculateQFE(b,o,M,w);h=y!=="N/A"?`${y} hPa`:"N/A"}i.coordsControl.update(`${r}<br>Elevation: ${p} ${p==="N/A"?"":m}<br>QFE: ${h}`)}}})}),document.addEventListener("map:location_selected",async t=>{const{lat:e,lng:n,source:a}=t.detail;console.log(`App: Event 'map:location_selected' von '${a}' empfangen.`),i.lastLat=e,i.lastLng=n,i.lastAltitude=await f.getAltitude(e,n),Wo(e,n),Er(!0),await nt(e,n),g.state.userSettings.calculateJump&&(se(),Ea()),fn(!0),i.isManualPanning=!1,he(),_e()}),document.addEventListener("favorites:updated",t=>{const{favorites:e}=t.detail;console.log("[App] Favorites updated, redrawing markers on map."),Go(e)}),document.addEventListener("tracking:started",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.disabled=!1,t.style.opacity="1",t.title="")}),document.addEventListener("tracking:stopped",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.checked=!1,t.disabled=!0,t.style.opacity="0.5",t.title="Enable Live Tracking to use Jump Master Line"),g.state.userSettings.showJumpMasterLine&&(g.state.userSettings.showJumpMasterLine=!1,g.save()),fe()}),document.addEventListener("track:loaded",async t=>{const e=document.getElementById("loading");try{const{lat:n,lng:a,timestamp:r,historicalDate:o,summary:s}=t.detail;if(console.log('[main-web] Event "track:loaded" empfangen, starte korrigierte Aktionen.'),o){const u=document.getElementById("autoupdateCheckbox");u&&(u.checked=!1),Yo(),g.state.userSettings.autoupdate=!1,g.save(),f.handleMessage("Autoupdate disabled for historical track viewing.")}await _n(n,a);const l=await nt(n,a,r);if(l){i.weatherData=l;const u=document.getElementById("timeSlider");if(u&&i.weatherData.time){u.max=i.weatherData.time.length-1,u.disabled=u.max<=0;const d=new Date(r).getTime();let m=0,p=1/0;i.weatherData.time.forEach((h,v)=>{const b=Math.abs(new Date(h).getTime()-d);b<p&&(p=b,m=v)}),u.value=m}}await ze(ae(),"weather-table-container","selectedTime"),await Ge(),at(),se(),_e();const c=document.getElementById("info");if(c&&s){const u=/(<br><strong>Available Models:<\/strong><ul>.*?<\/ul>|<br><strong>Available Models:<\/strong> None)/s,d=c.innerHTML.match(u);c.innerHTML=s+(d?d[0]:"")}if(o){const u=document.getElementById("historicalDatePicker");u&&(u.value=o)}}catch(n){console.error("Fehler bei der Verarbeitung von track:loaded:",n),f.handleError("Konnte Track-Daten nicht vollständig verarbeiten.")}finally{e&&(e.style.display="none")}}),document.addEventListener("tracking:positionUpdated",t=>{fe(t.detail)}),document.addEventListener("jml:targetChanged",()=>{fe()}),document.addEventListener("ui:sliderChanged",async t=>{console.log("[main-web] Event 'ui:sliderChanged' empfangen, spezifische Updates werden ausgeführt.");try{const e=ae();i.weatherData&&i.lastLat&&i.lastLng&&(await ze(e,"weather-table-container","selectedTime"),await Ge(),i.lastAltitude!=="N/A"&&at(),_e(),g.state.userSettings.calculateJump&&se(),g.state.userSettings.showJumpRunTrack&&he(),ot(e,Ie()))}catch(e){console.error("Error during slider update:",e),hn(e.message)}}),document.addEventListener("ui:settingChanged",async t=>{const{name:e,value:n}=t.detail;switch(console.log(`[main-web] Setting '${e}' changed to '${n}'. Performing updates.`),e==="timeZone"&&await Vo(),["refLevel","heightUnit","temperatureUnit","windUnit","timeZone"].includes(e)&&await ze(ae(),"weather-table-container","selectedTime"),e){case"heightUnit":case"windUnit":case"refLevel":at(),g.getValue("calculateJump","checkbox",!1)&&se(),_e(),fe(),await Ge();break;case"coordFormat":if(await Ge(),fe(),i.map&&i.lastMouseLatLng){const a=new MouseEvent("mousemove",{bubbles:!0,cancelable:!0,clientX:i.lastMouseLatLng.x,clientY:i.lastMouseLatLng.y});i.map.getContainer().dispatchEvent(a)}break}}),document.addEventListener("ui:radioGroupChanged",async t=>{const{name:e,value:n}=t.detail;if(console.log(`[main-web] Radio group '${e}' changed to '${n}'. Performing updates.`),e==="heightUnit"){const a=document.getElementById("lowerLimit"),r=document.getElementById("upperLimit");if(a&&r){let o=parseFloat(a.value),s=parseFloat(r.value);!isNaN(o)&&!isNaN(s)&&(n==="ft"?(a.value=Math.round(o*3.28084),r.value=Math.round(s*3.28084)):(a.value=Math.round(o/3.28084),r.value=Math.round(s/3.28084)),g.state.userSettings.lowerLimit=a.value,g.state.userSettings.upperLimit=r.value,g.save())}}switch(["refLevel","heightUnit","temperatureUnit","windUnit","timeZone"].includes(e)&&await ze(ae(),"weather-table-container","selectedTime"),e){case"heightUnit":case"windUnit":case"refLevel":at(),g.getValue("calculateJump","checkbox",!1)&&se(),_e(),fe(),await Ge();break;case"coordFormat":await Ge(),fe();break;case"landingDirection":ti(),_e(),se();break}}),document.addEventListener("ui:inputChanged",async t=>{const{name:e,value:n}=t.detail;switch(console.log(`[main-web] Input for '${e}' changed to '${n}'.`),e){case"aircraftSpeedKt":const a=xo(n);Dt("jumperSeparation",a),g.state.userSettings.jumperSeparation=a,g.save(),i.weatherData&&(Xo(),ot(ae())),he();break;case"cutAwayAltitude":i.weatherData&&i.cutAwayLat!==null&&se();break;case"openingAltitude":case"exitAltitude":case"safetyHeight":case"numberOfJumpers":case"jumperSeparation":case"canopySpeed":case"descentRate":case"legHeightFinal":case"legHeightBase":case"legHeightDownwind":i.weatherData&&(se(),_e(),ot(ae()));break;case"jumpRunTrackDirection":case"jumpRunTrackOffset":case"jumpRunTrackForwardOffset":i.weatherData&&he();break;case"lowerLimit":case"upperLimit":case"interpStep":i.weatherData&&(await ze(ae(),"weather-table-container","selectedTime"),at());break;case"customLandingDirectionLL":case"customLandingDirectionRR":i.weatherData&&(_e(),se());break;case"historicalDatePicker":if(i.lastLat&&i.lastLng){const r=n?`${n}T00:00:00Z`:null,o=await nt(i.lastLat,i.lastLng,r);o&&await $t(o)}break}}),document.addEventListener("ui:findJumpShip",()=>{qo()}),document.addEventListener("ui:showJumpMasterLineChanged",()=>{fe()}),document.addEventListener("ui:modelChanged",async t=>{var e,n;if(console.log(`[main-web] Model changed to ${t.detail.model}. Fetching new data.`),i.lastLat&&i.lastLng){const a=ae(),r=((n=(e=i.weatherData)==null?void 0:e.time)==null?void 0:n[a])||null,o=await nt(i.lastLat,i.lastLng,r);o&&await $t(o,a)}else f.handleError("Please select a position on the map first.")}),document.addEventListener("ui:jumpFeatureChanged",()=>{console.log("[main-web] Jump feature changed, recalculating jump."),i.weatherData&&i.lastLat&&i.lastLng&&g.state.userSettings.calculateJump&&se()}),document.addEventListener("ui:showJumpRunTrackChanged",t=>{t.detail.checked?he():(Ft(null),Er(!1))}),document.addEventListener("ui:showCutAwayFinderChanged",t=>{var a;const e=t.detail.checked;console.log(`[main-web] Cut Away Finder toggled: ${e}`);const n=(a=document.getElementById("showCutAwayFinder").closest("li"))==null?void 0:a.querySelector("ul.submenu");n&&n.classList.toggle("hidden",!e),e||(nc(),i.cutAwayLat=null,i.cutAwayLng=null),i.weatherData&&i.lastLat&&i.lastLng&&g.state.userSettings.calculateJump&&se()}),document.addEventListener("ui:trackPositionToggled",t=>{const e=t.detail.checked;console.log(`[main-web] Live Tracking toggled: ${e}`),e?Tu():ln()}),document.addEventListener("ui:landingPatternEnabled",()=>{console.log("[main-web] Landing pattern enabled, updating display."),_e()}),document.addEventListener("ui:landingPatternDisabled",()=>{console.log("[main-web] Landing pattern disabled, clearing display."),It(null)}),document.addEventListener("ui:showTableChanged",t=>{const e=t.detail.checked;console.log(`[main-web] Show Table toggled: ${e}`);const n=document.getElementById("info");n&&(n.style.display=e?"block":"none"),e&&i.weatherData&&i.lastLat&&i.lastLng&&ze(ae(),"weather-table-container","selectedTime"),fn()}),document.addEventListener("ui:showJumpMasterLineChanged",()=>{console.log("[main-web] Jump Master Line checkbox changed, forcing dashboard update."),fe()}),document.addEventListener("ui:jumpMasterLineTargetChanged",()=>{console.log("[main-web] Jump Master Line target changed, updating panel and line."),fe()}),document.addEventListener("ui:downloadClicked",()=>{console.log("[main-web] Download button clicked.");const t=Iu();t==="SurfaceData"?xu():t==="ComprehensiveReport"?$u():Fu(t)}),document.addEventListener("ui:clearDateClicked",async()=>{console.log("[main-web] Clear date button clicked.");const t=document.getElementById("historicalDatePicker");if(t&&(t.value="",i.lastLat&&i.lastLng))try{const e=await nt(i.lastLat,i.lastLng,null);e&&await $t(e)}catch(e){hn(e.message)}}),document.addEventListener("ui:recalculateJump",()=>{console.log("[main-web] Recalculate jump triggered."),i.weatherData&&i.lastLat&&i.lastLng&&g.state.userSettings.calculateJump&&se()}),document.addEventListener("ui:invalidInput",t=>{const{id:e,defaultValue:n}=t.detail;console.log(`[main-web] Received invalid input for ${e}. Resetting UI to ${n}.`),ne(e,n)})}document.addEventListener("DOMContentLoaded",async()=>{Nu(),Du(),_r(),Rl(),await Jl(),Ru(),ku(),_u(),Ca();const t=Ne().filter(e=>e.isFavorite);t.length>0&&(console.log(`[App] Found ${t.length} favorite(s) on startup, plotting on map.`),Go(t)),document.addEventListener("cutaway:marker_placed",()=>{console.log("App: Event 'cutaway:marker_placed' empfangen. Neuberechnung wird ausgelöst."),i.weatherData&&i.lastLat&&i.lastLng&&se()}),document.addEventListener("track:dragend",e=>{console.log("App: Event 'track:dragend' empfangen. Neuberechnung der Offsets relativ zum Ankerpunkt (DIP oder HARP).");const{newPosition:n,originalTrackData:a}=e.detail;let r;const o=i.harpMarker?i.harpMarker.getLatLng():null;o?(r=o,console.log("JRT-Ankerpunkt ist HARP.")):(r=L.latLng(i.lastLat,i.lastLng),console.log("JRT-Ankerpunkt ist DIP."));const s=a.trackLength,l=a.airplane.bearing,c=n,[u,d]=f.calculateNewCenter(c.lat,c.lng,s,(l+180)%360),m=L.latLng(u,d),p=i.map.distance(r,m);let v=f.calculateBearing(r.lat,r.lng,m.lat,m.lng)-l;v=(v+180)%360-180;const b=v*(Math.PI/180),w=Math.round(p*Math.cos(b)),M=Math.round(p*Math.sin(b));g.state.userSettings.jumpRunTrackOffset=M,g.state.userSettings.jumpRunTrackForwardOffset=w,g.save(),Dt("jumpRunTrackOffset",M),Dt("jumpRunTrackForwardOffset",w),he()}),document.addEventListener("harp:updated",()=>{console.log("[App] HARP has been updated, resetting offsets and triggering JRT recalculation."),Dt("jumpRunTrackOffset",0),Dt("jumpRunTrackForwardOffset",0),he(),typeof fe=="function"&&fe()}),document.addEventListener("location:selected",async e=>{var s,l;const{lat:n,lng:a,source:r}=e.detail;console.log(`App: Event 'location:selected' empfangen. Quelle: ${r}`),oc(),i.terrainAnalysisCache=null;const o=document.getElementById("loading");o&&(o.style.display="block");try{const c=ae(),u=((l=(s=i.weatherData)==null?void 0:s.time)==null?void 0:l[c])||null,d=await nt(n,a,u);d?r==="geolocation"||r==="geolocation_fallback"?await $t(d):await $t(d,c):i.weatherData=null,await _n(n,a),await Ge(),fn(!0),i.isManualPanning=!1,(r==="geolocation"||r==="geolocation_fallback")&&(console.log("Starte initiales Caching nach Geolocation..."),ka({map:i.map,baseMaps:i.baseMaps,onProgress:Ut,onComplete:m=>{Oe(),m&&je(m)},onCancel:()=>{Oe(),je("Caching cancelled.")}})),g.state.userSettings.showJumpMasterLine&&fe(),(r==="marker_drag"||r==="dblclick"||r==="search")&&(console.log(`Starte Caching für neue Position via ${r}...`),Uo({map:i.map,lastLat:n,lastLng:a,baseMaps:i.baseMaps,onProgress:Ut,onComplete:je,onCancel:()=>je("Caching cancelled."),radiusKm:5,silent:!0})),g.state.userSettings.selectedEnsembleModels.length>0&&(console.log("DIP moved, triggering ensemble recalculation..."),await _a()&&ot(ae()))}catch(c){console.error('Fehler beim Verarbeiten von "location:selected":',c),hn(c.message)}finally{o&&(o.style.display="none")}}),document.addEventListener("autoupdate:tick",async e=>{if(!g.state.userSettings.autoupdate)return;const n=new Date,a=document.getElementById("timeSlider");if(!a)return;const r=n.getUTCHours(),o=parseInt(a.value,10);(r!==o||e.detail.isInitialTick)&&(console.log(`[App] Autoupdate triggered. Current Hour: ${r}, Slider Hour: ${o}`),await Pu())}),document.addEventListener("ui:lockStateChanged",_r)});function tt(t,e){const n=document.getElementById(t);n&&(n.checked=e)}function Fe(t,e){const n=document.getElementById(t);n?n.value=e:console.warn(`Element ${t} not found`)}function ne(t,e){const n=document.getElementById(t);n&&(n.value=e)}function Dt(t,e){const n=document.getElementById(t);if(n){const a=n.value;n.value=e,console.log(`Set ${t} silently:`,{old:a,new:e})}}function Uu(t,e){const n=document.querySelector(`input[name="${t}"][value="${e}"]`);n?n.checked=!0:console.warn(`Radio ${t} with value ${e} not found`)}
