var ai=Object.defineProperty;var ri=(t,e,n)=>e in t?ai(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var En=(t,e,n)=>ri(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const i={isInitialized:!1,ismapInitialized:!1,isCachingCancelled:!1,hasTileErrorSwitched:!1,map:null,baseMaps:{},coordsControl:null,lastMouseLatLng:null,isManualPanning:!1,isInteractionLocked:!1,labelZoomListener:null,currentMarker:null,lastLat:null,lastLng:null,lastAltitude:null,weatherData:null,cloudThresholds:[],lastModelRun:null,landingWindDir:null,autoupdateInterval:null,jumpVisualizationLayerGroup:null,landingPatternLayerGroup:null,jumpRunTrackLayerGroup:null,lastTrackData:null,isPlacingHarp:!1,harpMarker:null,cutAwayMarker:null,cutAwayLat:null,cutAwayLng:null,cutAwayCircle:null,isJumperSeparationManual:!1,watchId:null,liveMarker:null,livePositionControl:null,accuracyCircle:null,jumpMasterLine:null,aircraftMarker:null,aircraftTrackLayer:null,adsbTrackPoints:[],isArmed:!1,isAutoRecording:!1,isManualRecording:!1,recordedTrackPoints:[],recordedTrackLayer:null,autoRecordingStartTime:null,altitudeCorrectionOffset:0,prevTime:null,prevLat:null,prevLng:null,lastLatitude:null,lastLongitude:null,lastDeviceAltitude:null,lastAltitudeAccuracy:null,lastAccuracy:null,lastSpeed:"N/A",lastSmoothedSpeedMs:0,lastDirection:"N/A",lastTerrainAltitude:"N/A",lastEffectiveWindUnit:"kt",gpxLayer:null,gpxPoints:[],isLoadingGpx:!1,isTrackLoaded:!1,favoritesLayerGroup:null,poiLayerGroup:null,ensembleModelsData:null,selectedEnsembleModels:[],currentEnsembleScenario:"all_models",ensembleLayerGroup:null,ensembleScenarioCircles:{},heatmapLayer:null};class st extends Error{}class oi extends st{constructor(e){super(`Invalid DateTime: ${e.toMessage()}`)}}class ii extends st{constructor(e){super(`Invalid Interval: ${e.toMessage()}`)}}class si extends st{constructor(e){super(`Invalid Duration: ${e.toMessage()}`)}}class ht extends st{}class Sr extends st{constructor(e){super(`Invalid unit ${e}`)}}class le extends st{}class Re extends st{constructor(){super("Zone is an abstract class")}}const D="numeric",Ae="short",pe="long",an={year:D,month:D,day:D},br={year:D,month:Ae,day:D},li={year:D,month:Ae,day:D,weekday:Ae},Er={year:D,month:pe,day:D},_r={year:D,month:pe,day:D,weekday:pe},kr={hour:D,minute:D},Tr={hour:D,minute:D,second:D},Ar={hour:D,minute:D,second:D,timeZoneName:Ae},Cr={hour:D,minute:D,second:D,timeZoneName:pe},Ir={hour:D,minute:D,hourCycle:"h23"},Nr={hour:D,minute:D,second:D,hourCycle:"h23"},Pr={hour:D,minute:D,second:D,hourCycle:"h23",timeZoneName:Ae},Dr={hour:D,minute:D,second:D,hourCycle:"h23",timeZoneName:pe},Fr={year:D,month:D,day:D,hour:D,minute:D},xr={year:D,month:D,day:D,hour:D,minute:D,second:D},$r={year:D,month:Ae,day:D,hour:D,minute:D},Or={year:D,month:Ae,day:D,hour:D,minute:D,second:D},ci={year:D,month:Ae,day:D,weekday:Ae,hour:D,minute:D},Rr={year:D,month:pe,day:D,hour:D,minute:D,timeZoneName:Ae},Wr={year:D,month:pe,day:D,hour:D,minute:D,second:D,timeZoneName:Ae},Ur={year:D,month:pe,day:D,weekday:pe,hour:D,minute:D,timeZoneName:pe},Hr={year:D,month:pe,day:D,weekday:pe,hour:D,minute:D,second:D,timeZoneName:pe};class Rt{get type(){throw new Re}get name(){throw new Re}get ianaName(){return this.name}get isUniversal(){throw new Re}offsetName(e,n){throw new Re}formatOffset(e,n){throw new Re}offset(e){throw new Re}equals(e){throw new Re}get isValid(){throw new Re}}let _n=null;class dn extends Rt{static get instance(){return _n===null&&(_n=new dn),_n}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(e,{format:n,locale:a}){return Xr(e,n,a)}formatOffset(e,n){return Nt(this.offset(e),n)}offset(e){return-new Date(e).getTimezoneOffset()}equals(e){return e.type==="system"}get isValid(){return!0}}const zn=new Map;function ui(t){let e=zn.get(t);return e===void 0&&(e=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"}),zn.set(t,e)),e}const di={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};function mi(t,e){const n=t.format(e).replace(/\u200E/g,""),a=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(n),[,r,o,s,l,c,u,d]=a;return[s,r,o,l,c,u,d]}function hi(t,e){const n=t.formatToParts(e),a=[];for(let r=0;r<n.length;r++){const{type:o,value:s}=n[r],l=di[o];o==="era"?a[l]=s:H(l)||(a[l]=parseInt(s,10))}return a}const kn=new Map;class xe extends Rt{static create(e){let n=kn.get(e);return n===void 0&&kn.set(e,n=new xe(e)),n}static resetCache(){kn.clear(),zn.clear()}static isValidSpecifier(e){return this.isValidZone(e)}static isValidZone(e){if(!e)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:e}).format(),!0}catch{return!1}}constructor(e){super(),this.zoneName=e,this.valid=xe.isValidZone(e)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(e,{format:n,locale:a}){return Xr(e,n,a,this.name)}formatOffset(e,n){return Nt(this.offset(e),n)}offset(e){if(!this.valid)return NaN;const n=new Date(e);if(isNaN(n))return NaN;const a=ui(this.name);let[r,o,s,l,c,u,d]=a.formatToParts?hi(a,n):mi(a,n);l==="BC"&&(r=-Math.abs(r)+1);const p=hn({year:r,month:o,day:s,hour:c===24?0:c,minute:u,second:d,millisecond:0});let h=+n;const v=h%1e3;return h-=v>=0?v:1e3+v,(p-h)/(60*1e3)}equals(e){return e.type==="iana"&&e.name===this.name}get isValid(){return this.valid}}let Pa={};function fi(t,e={}){const n=JSON.stringify([t,e]);let a=Pa[n];return a||(a=new Intl.ListFormat(t,e),Pa[n]=a),a}const Gn=new Map;function Vn(t,e={}){const n=JSON.stringify([t,e]);let a=Gn.get(n);return a===void 0&&(a=new Intl.DateTimeFormat(t,e),Gn.set(n,a)),a}const Zn=new Map;function gi(t,e={}){const n=JSON.stringify([t,e]);let a=Zn.get(n);return a===void 0&&(a=new Intl.NumberFormat(t,e),Zn.set(n,a)),a}const jn=new Map;function pi(t,e={}){const{base:n,...a}=e,r=JSON.stringify([t,a]);let o=jn.get(r);return o===void 0&&(o=new Intl.RelativeTimeFormat(t,e),jn.set(r,o)),o}let kt=null;function yi(){return kt||(kt=new Intl.DateTimeFormat().resolvedOptions().locale,kt)}const Jn=new Map;function Br(t){let e=Jn.get(t);return e===void 0&&(e=new Intl.DateTimeFormat(t).resolvedOptions(),Jn.set(t,e)),e}const qn=new Map;function wi(t){let e=qn.get(t);if(!e){const n=new Intl.Locale(t);e="getWeekInfo"in n?n.getWeekInfo():n.weekInfo,"minimalDays"in e||(e={...zr,...e}),qn.set(t,e)}return e}function vi(t){const e=t.indexOf("-x-");e!==-1&&(t=t.substring(0,e));const n=t.indexOf("-u-");if(n===-1)return[t];{let a,r;try{a=Vn(t).resolvedOptions(),r=t}catch{const c=t.substring(0,n);a=Vn(c).resolvedOptions(),r=c}const{numberingSystem:o,calendar:s}=a;return[r,o,s]}}function Li(t,e,n){return(n||e)&&(t.includes("-u-")||(t+="-u"),n&&(t+=`-ca-${n}`),e&&(t+=`-nu-${e}`)),t}function Mi(t){const e=[];for(let n=1;n<=12;n++){const a=F.utc(2009,n,1);e.push(t(a))}return e}function Si(t){const e=[];for(let n=1;n<=7;n++){const a=F.utc(2016,11,13+n);e.push(t(a))}return e}function Vt(t,e,n,a){const r=t.listingMode();return r==="error"?null:r==="en"?n(e):a(e)}function bi(t){return t.numberingSystem&&t.numberingSystem!=="latn"?!1:t.numberingSystem==="latn"||!t.locale||t.locale.startsWith("en")||Br(t.locale).numberingSystem==="latn"}class Ei{constructor(e,n,a){this.padTo=a.padTo||0,this.floor=a.floor||!1;const{padTo:r,floor:o,...s}=a;if(!n||Object.keys(s).length>0){const l={useGrouping:!1,...a};a.padTo>0&&(l.minimumIntegerDigits=a.padTo),this.inf=gi(e,l)}}format(e){if(this.inf){const n=this.floor?Math.floor(e):e;return this.inf.format(n)}else{const n=this.floor?Math.floor(e):ma(e,3);return Q(n,this.padTo)}}}class _i{constructor(e,n,a){this.opts=a,this.originalZone=void 0;let r;if(this.opts.timeZone)this.dt=e;else if(e.zone.type==="fixed"){const s=-1*(e.offset/60),l=s>=0?`Etc/GMT+${s}`:`Etc/GMT${s}`;e.offset!==0&&xe.create(l).valid?(r=l,this.dt=e):(r="UTC",this.dt=e.offset===0?e:e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone)}else e.zone.type==="system"?this.dt=e:e.zone.type==="iana"?(this.dt=e,r=e.zone.name):(r="UTC",this.dt=e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone);const o={...this.opts};o.timeZone=o.timeZone||r,this.dtf=Vn(n,o)}format(){return this.originalZone?this.formatToParts().map(({value:e})=>e).join(""):this.dtf.format(this.dt.toJSDate())}formatToParts(){const e=this.dtf.formatToParts(this.dt.toJSDate());return this.originalZone?e.map(n=>{if(n.type==="timeZoneName"){const a=this.originalZone.offsetName(this.dt.ts,{locale:this.dt.locale,format:this.opts.timeZoneName});return{...n,value:a}}else return n}):e}resolvedOptions(){return this.dtf.resolvedOptions()}}class ki{constructor(e,n,a){this.opts={style:"long",...a},!n&&Kr()&&(this.rtf=pi(e,a))}format(e,n){return this.rtf?this.rtf.format(e,n):Ji(n,e,this.opts.numeric,this.opts.style!=="long")}formatToParts(e,n){return this.rtf?this.rtf.formatToParts(e,n):[]}}const zr={firstDay:1,minimalDays:4,weekend:[6,7]};class j{static fromOpts(e){return j.create(e.locale,e.numberingSystem,e.outputCalendar,e.weekSettings,e.defaultToEN)}static create(e,n,a,r,o=!1){const s=e||Y.defaultLocale,l=s||(o?"en-US":yi()),c=n||Y.defaultNumberingSystem,u=a||Y.defaultOutputCalendar,d=Yn(r)||Y.defaultWeekSettings;return new j(l,c,u,d,s)}static resetCache(){kt=null,Gn.clear(),Zn.clear(),jn.clear(),Jn.clear(),qn.clear()}static fromObject({locale:e,numberingSystem:n,outputCalendar:a,weekSettings:r}={}){return j.create(e,n,a,r)}constructor(e,n,a,r,o){const[s,l,c]=vi(e);this.locale=s,this.numberingSystem=n||l||null,this.outputCalendar=a||c||null,this.weekSettings=r,this.intl=Li(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=o,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=bi(this)),this.fastNumbersCached}listingMode(){const e=this.isEnglish(),n=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return e&&n?"en":"intl"}clone(e){return!e||Object.getOwnPropertyNames(e).length===0?this:j.create(e.locale||this.specifiedLocale,e.numberingSystem||this.numberingSystem,e.outputCalendar||this.outputCalendar,Yn(e.weekSettings)||this.weekSettings,e.defaultToEN||!1)}redefaultToEN(e={}){return this.clone({...e,defaultToEN:!0})}redefaultToSystem(e={}){return this.clone({...e,defaultToEN:!1})}months(e,n=!1){return Vt(this,e,to,()=>{const a=n?{month:e,day:"numeric"}:{month:e},r=n?"format":"standalone";return this.monthsCache[r][e]||(this.monthsCache[r][e]=Mi(o=>this.extract(o,a,"month"))),this.monthsCache[r][e]})}weekdays(e,n=!1){return Vt(this,e,ro,()=>{const a=n?{weekday:e,year:"numeric",month:"long",day:"numeric"}:{weekday:e},r=n?"format":"standalone";return this.weekdaysCache[r][e]||(this.weekdaysCache[r][e]=Si(o=>this.extract(o,a,"weekday"))),this.weekdaysCache[r][e]})}meridiems(){return Vt(this,void 0,()=>oo,()=>{if(!this.meridiemCache){const e={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[F.utc(2016,11,13,9),F.utc(2016,11,13,19)].map(n=>this.extract(n,e,"dayperiod"))}return this.meridiemCache})}eras(e){return Vt(this,e,io,()=>{const n={era:e};return this.eraCache[e]||(this.eraCache[e]=[F.utc(-40,1,1),F.utc(2017,1,1)].map(a=>this.extract(a,n,"era"))),this.eraCache[e]})}extract(e,n,a){const r=this.dtFormatter(e,n),o=r.formatToParts(),s=o.find(l=>l.type.toLowerCase()===a);return s?s.value:null}numberFormatter(e={}){return new Ei(this.intl,e.forceSimple||this.fastNumbers,e)}dtFormatter(e,n={}){return new _i(e,this.intl,n)}relFormatter(e={}){return new ki(this.intl,this.isEnglish(),e)}listFormatter(e={}){return fi(this.intl,e)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||Br(this.intl).locale.startsWith("en-us")}getWeekSettings(){return this.weekSettings?this.weekSettings:Yr()?wi(this.locale):zr}getStartOfWeek(){return this.getWeekSettings().firstDay}getMinDaysInFirstWeek(){return this.getWeekSettings().minimalDays}getWeekendDays(){return this.getWeekSettings().weekend}equals(e){return this.locale===e.locale&&this.numberingSystem===e.numberingSystem&&this.outputCalendar===e.outputCalendar}toString(){return`Locale(${this.locale}, ${this.numberingSystem}, ${this.outputCalendar})`}}let Tn=null;class de extends Rt{static get utcInstance(){return Tn===null&&(Tn=new de(0)),Tn}static instance(e){return e===0?de.utcInstance:new de(e)}static parseSpecifier(e){if(e){const n=e.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(n)return new de(fn(n[1],n[2]))}return null}constructor(e){super(),this.fixed=e}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${Nt(this.fixed,"narrow")}`}get ianaName(){return this.fixed===0?"Etc/UTC":`Etc/GMT${Nt(-this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(e,n){return Nt(this.fixed,n)}get isUniversal(){return!0}offset(){return this.fixed}equals(e){return e.type==="fixed"&&e.fixed===this.fixed}get isValid(){return!0}}class Ti extends Rt{constructor(e){super(),this.zoneName=e}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function Ge(t,e){if(H(t)||t===null)return e;if(t instanceof Rt)return t;if(Di(t)){const n=t.toLowerCase();return n==="default"?e:n==="local"||n==="system"?dn.instance:n==="utc"||n==="gmt"?de.utcInstance:de.parseSpecifier(n)||xe.create(t)}else return Je(t)?de.instance(t):typeof t=="object"&&"offset"in t&&typeof t.offset=="function"?t:new Ti(t)}const la={arab:"[٠-٩]",arabext:"[۰-۹]",bali:"[᭐-᭙]",beng:"[০-৯]",deva:"[०-९]",fullwide:"[０-９]",gujr:"[૦-૯]",hanidec:"[〇|一|二|三|四|五|六|七|八|九]",khmr:"[០-៩]",knda:"[೦-೯]",laoo:"[໐-໙]",limb:"[᥆-᥏]",mlym:"[൦-൯]",mong:"[᠐-᠙]",mymr:"[၀-၉]",orya:"[୦-୯]",tamldec:"[௦-௯]",telu:"[౦-౯]",thai:"[๐-๙]",tibt:"[༠-༩]",latn:"\\d"},Da={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},Ai=la.hanidec.replace(/[\[|\]]/g,"").split("");function Ci(t){let e=parseInt(t,10);if(isNaN(e)){e="";for(let n=0;n<t.length;n++){const a=t.charCodeAt(n);if(t[n].search(la.hanidec)!==-1)e+=Ai.indexOf(t[n]);else for(const r in Da){const[o,s]=Da[r];a>=o&&a<=s&&(e+=a-o)}}return parseInt(e,10)}else return e}const Kn=new Map;function Ii(){Kn.clear()}function be({numberingSystem:t},e=""){const n=t||"latn";let a=Kn.get(n);a===void 0&&(a=new Map,Kn.set(n,a));let r=a.get(e);return r===void 0&&(r=new RegExp(`${la[n]}${e}`),a.set(e,r)),r}let Fa=()=>Date.now(),xa="system",$a=null,Oa=null,Ra=null,Wa=60,Ua,Ha=null,Y=class{static get now(){return Fa}static set now(e){Fa=e}static set defaultZone(e){xa=e}static get defaultZone(){return Ge(xa,dn.instance)}static get defaultLocale(){return $a}static set defaultLocale(e){$a=e}static get defaultNumberingSystem(){return Oa}static set defaultNumberingSystem(e){Oa=e}static get defaultOutputCalendar(){return Ra}static set defaultOutputCalendar(e){Ra=e}static get defaultWeekSettings(){return Ha}static set defaultWeekSettings(e){Ha=Yn(e)}static get twoDigitCutoffYear(){return Wa}static set twoDigitCutoffYear(e){Wa=e%100}static get throwOnInvalid(){return Ua}static set throwOnInvalid(e){Ua=e}static resetCaches(){j.resetCache(),xe.resetCache(),F.resetCache(),Ii()}};class Te{constructor(e,n){this.reason=e,this.explanation=n}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}const Gr=[0,31,59,90,120,151,181,212,243,273,304,334],Vr=[0,31,60,91,121,152,182,213,244,274,305,335];function Le(t,e){return new Te("unit out of range",`you specified ${e} (of type ${typeof e}) as a ${t}, which is invalid`)}function ca(t,e,n){const a=new Date(Date.UTC(t,e-1,n));t<100&&t>=0&&a.setUTCFullYear(a.getUTCFullYear()-1900);const r=a.getUTCDay();return r===0?7:r}function Zr(t,e,n){return n+(Wt(t)?Vr:Gr)[e-1]}function jr(t,e){const n=Wt(t)?Vr:Gr,a=n.findIndex(o=>o<e),r=e-n[a];return{month:a+1,day:r}}function ua(t,e){return(t-e+7)%7+1}function rn(t,e=4,n=1){const{year:a,month:r,day:o}=t,s=Zr(a,r,o),l=ua(ca(a,r,o),n);let c=Math.floor((s-l+14-e)/7),u;return c<1?(u=a-1,c=xt(u,e,n)):c>xt(a,e,n)?(u=a+1,c=1):u=a,{weekYear:u,weekNumber:c,weekday:l,...gn(t)}}function Ba(t,e=4,n=1){const{weekYear:a,weekNumber:r,weekday:o}=t,s=ua(ca(a,1,e),n),l=gt(a);let c=r*7+o-s-7+e,u;c<1?(u=a-1,c+=gt(u)):c>l?(u=a+1,c-=gt(a)):u=a;const{month:d,day:m}=jr(u,c);return{year:u,month:d,day:m,...gn(t)}}function An(t){const{year:e,month:n,day:a}=t,r=Zr(e,n,a);return{year:e,ordinal:r,...gn(t)}}function za(t){const{year:e,ordinal:n}=t,{month:a,day:r}=jr(e,n);return{year:e,month:a,day:r,...gn(t)}}function Ga(t,e){if(!H(t.localWeekday)||!H(t.localWeekNumber)||!H(t.localWeekYear)){if(!H(t.weekday)||!H(t.weekNumber)||!H(t.weekYear))throw new ht("Cannot mix locale-based week fields with ISO-based week fields");return H(t.localWeekday)||(t.weekday=t.localWeekday),H(t.localWeekNumber)||(t.weekNumber=t.localWeekNumber),H(t.localWeekYear)||(t.weekYear=t.localWeekYear),delete t.localWeekday,delete t.localWeekNumber,delete t.localWeekYear,{minDaysInFirstWeek:e.getMinDaysInFirstWeek(),startOfWeek:e.getStartOfWeek()}}else return{minDaysInFirstWeek:4,startOfWeek:1}}function Ni(t,e=4,n=1){const a=mn(t.weekYear),r=Me(t.weekNumber,1,xt(t.weekYear,e,n)),o=Me(t.weekday,1,7);return a?r?o?!1:Le("weekday",t.weekday):Le("week",t.weekNumber):Le("weekYear",t.weekYear)}function Pi(t){const e=mn(t.year),n=Me(t.ordinal,1,gt(t.year));return e?n?!1:Le("ordinal",t.ordinal):Le("year",t.year)}function Jr(t){const e=mn(t.year),n=Me(t.month,1,12),a=Me(t.day,1,on(t.year,t.month));return e?n?a?!1:Le("day",t.day):Le("month",t.month):Le("year",t.year)}function qr(t){const{hour:e,minute:n,second:a,millisecond:r}=t,o=Me(e,0,23)||e===24&&n===0&&a===0&&r===0,s=Me(n,0,59),l=Me(a,0,59),c=Me(r,0,999);return o?s?l?c?!1:Le("millisecond",r):Le("second",a):Le("minute",n):Le("hour",e)}function H(t){return typeof t>"u"}function Je(t){return typeof t=="number"}function mn(t){return typeof t=="number"&&t%1===0}function Di(t){return typeof t=="string"}function Fi(t){return Object.prototype.toString.call(t)==="[object Date]"}function Kr(){try{return typeof Intl<"u"&&!!Intl.RelativeTimeFormat}catch{return!1}}function Yr(){try{return typeof Intl<"u"&&!!Intl.Locale&&("weekInfo"in Intl.Locale.prototype||"getWeekInfo"in Intl.Locale.prototype)}catch{return!1}}function xi(t){return Array.isArray(t)?t:[t]}function Va(t,e,n){if(t.length!==0)return t.reduce((a,r)=>{const o=[e(r),r];return a&&n(a[0],o[0])===a[0]?a:o},null)[1]}function $i(t,e){return e.reduce((n,a)=>(n[a]=t[a],n),{})}function yt(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Yn(t){if(t==null)return null;if(typeof t!="object")throw new le("Week settings must be an object");if(!Me(t.firstDay,1,7)||!Me(t.minimalDays,1,7)||!Array.isArray(t.weekend)||t.weekend.some(e=>!Me(e,1,7)))throw new le("Invalid week settings");return{firstDay:t.firstDay,minimalDays:t.minimalDays,weekend:Array.from(t.weekend)}}function Me(t,e,n){return mn(t)&&t>=e&&t<=n}function Oi(t,e){return t-e*Math.floor(t/e)}function Q(t,e=2){const n=t<0;let a;return n?a="-"+(""+-t).padStart(e,"0"):a=(""+t).padStart(e,"0"),a}function He(t){if(!(H(t)||t===null||t===""))return parseInt(t,10)}function Xe(t){if(!(H(t)||t===null||t===""))return parseFloat(t)}function da(t){if(!(H(t)||t===null||t==="")){const e=parseFloat("0."+t)*1e3;return Math.floor(e)}}function ma(t,e,n=!1){const a=10**e;return(n?Math.trunc:Math.round)(t*a)/a}function Wt(t){return t%4===0&&(t%100!==0||t%400===0)}function gt(t){return Wt(t)?366:365}function on(t,e){const n=Oi(e-1,12)+1,a=t+(e-n)/12;return n===2?Wt(a)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][n-1]}function hn(t){let e=Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,t.second,t.millisecond);return t.year<100&&t.year>=0&&(e=new Date(e),e.setUTCFullYear(t.year,t.month-1,t.day)),+e}function Za(t,e,n){return-ua(ca(t,1,e),n)+e-1}function xt(t,e=4,n=1){const a=Za(t,e,n),r=Za(t+1,e,n);return(gt(t)-a+r)/7}function Xn(t){return t>99?t:t>Y.twoDigitCutoffYear?1900+t:2e3+t}function Xr(t,e,n,a=null){const r=new Date(t),o={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};a&&(o.timeZone=a);const s={timeZoneName:e,...o},l=new Intl.DateTimeFormat(n,s).formatToParts(r).find(c=>c.type.toLowerCase()==="timezonename");return l?l.value:null}function fn(t,e){let n=parseInt(t,10);Number.isNaN(n)&&(n=0);const a=parseInt(e,10)||0,r=n<0||Object.is(n,-0)?-a:a;return n*60+r}function Qr(t){const e=Number(t);if(typeof t=="boolean"||t===""||Number.isNaN(e))throw new le(`Invalid unit value ${t}`);return e}function sn(t,e){const n={};for(const a in t)if(yt(t,a)){const r=t[a];if(r==null)continue;n[e(a)]=Qr(r)}return n}function Nt(t,e){const n=Math.trunc(Math.abs(t/60)),a=Math.trunc(Math.abs(t%60)),r=t>=0?"+":"-";switch(e){case"short":return`${r}${Q(n,2)}:${Q(a,2)}`;case"narrow":return`${r}${n}${a>0?`:${a}`:""}`;case"techie":return`${r}${Q(n,2)}${Q(a,2)}`;default:throw new RangeError(`Value format ${e} is out of range for property format`)}}function gn(t){return $i(t,["hour","minute","second","millisecond"])}const Ri=["January","February","March","April","May","June","July","August","September","October","November","December"],eo=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Wi=["J","F","M","A","M","J","J","A","S","O","N","D"];function to(t){switch(t){case"narrow":return[...Wi];case"short":return[...eo];case"long":return[...Ri];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const no=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],ao=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Ui=["M","T","W","T","F","S","S"];function ro(t){switch(t){case"narrow":return[...Ui];case"short":return[...ao];case"long":return[...no];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const oo=["AM","PM"],Hi=["Before Christ","Anno Domini"],Bi=["BC","AD"],zi=["B","A"];function io(t){switch(t){case"narrow":return[...zi];case"short":return[...Bi];case"long":return[...Hi];default:return null}}function Gi(t){return oo[t.hour<12?0:1]}function Vi(t,e){return ro(e)[t.weekday-1]}function Zi(t,e){return to(e)[t.month-1]}function ji(t,e){return io(e)[t.year<0?0:1]}function Ji(t,e,n="always",a=!1){const r={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},o=["hours","minutes","seconds"].indexOf(t)===-1;if(n==="auto"&&o){const m=t==="days";switch(e){case 1:return m?"tomorrow":`next ${r[t][0]}`;case-1:return m?"yesterday":`last ${r[t][0]}`;case 0:return m?"today":`this ${r[t][0]}`}}const s=Object.is(e,-0)||e<0,l=Math.abs(e),c=l===1,u=r[t],d=a?c?u[1]:u[2]||u[1]:c?r[t][0]:t;return s?`${l} ${d} ago`:`in ${l} ${d}`}function ja(t,e){let n="";for(const a of t)a.literal?n+=a.val:n+=e(a.val);return n}const qi={D:an,DD:br,DDD:Er,DDDD:_r,t:kr,tt:Tr,ttt:Ar,tttt:Cr,T:Ir,TT:Nr,TTT:Pr,TTTT:Dr,f:Fr,ff:$r,fff:Rr,ffff:Ur,F:xr,FF:Or,FFF:Wr,FFFF:Hr};class ce{static create(e,n={}){return new ce(e,n)}static parseFormat(e){let n=null,a="",r=!1;const o=[];for(let s=0;s<e.length;s++){const l=e.charAt(s);l==="'"?(a.length>0&&o.push({literal:r||/^\s+$/.test(a),val:a}),n=null,a="",r=!r):r||l===n?a+=l:(a.length>0&&o.push({literal:/^\s+$/.test(a),val:a}),a=l,n=l)}return a.length>0&&o.push({literal:r||/^\s+$/.test(a),val:a}),o}static macroTokenToFormatOpts(e){return qi[e]}constructor(e,n){this.opts=n,this.loc=e,this.systemLoc=null}formatWithSystemDefault(e,n){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(e,{...this.opts,...n}).format()}dtFormatter(e,n={}){return this.loc.dtFormatter(e,{...this.opts,...n})}formatDateTime(e,n){return this.dtFormatter(e,n).format()}formatDateTimeParts(e,n){return this.dtFormatter(e,n).formatToParts()}formatInterval(e,n){return this.dtFormatter(e.start,n).dtf.formatRange(e.start.toJSDate(),e.end.toJSDate())}resolvedOptions(e,n){return this.dtFormatter(e,n).resolvedOptions()}num(e,n=0){if(this.opts.forceSimple)return Q(e,n);const a={...this.opts};return n>0&&(a.padTo=n),this.loc.numberFormatter(a).format(e)}formatDateTimeFromString(e,n){const a=this.loc.listingMode()==="en",r=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",o=(h,v)=>this.loc.extract(e,h,v),s=h=>e.isOffsetFixed&&e.offset===0&&h.allowZ?"Z":e.isValid?e.zone.formatOffset(e.ts,h.format):"",l=()=>a?Gi(e):o({hour:"numeric",hourCycle:"h12"},"dayperiod"),c=(h,v)=>a?Zi(e,h):o(v?{month:h}:{month:h,day:"numeric"},"month"),u=(h,v)=>a?Vi(e,h):o(v?{weekday:h}:{weekday:h,month:"long",day:"numeric"},"weekday"),d=h=>{const v=ce.macroTokenToFormatOpts(h);return v?this.formatWithSystemDefault(e,v):h},m=h=>a?ji(e,h):o({era:h},"era"),p=h=>{switch(h){case"S":return this.num(e.millisecond);case"u":case"SSS":return this.num(e.millisecond,3);case"s":return this.num(e.second);case"ss":return this.num(e.second,2);case"uu":return this.num(Math.floor(e.millisecond/10),2);case"uuu":return this.num(Math.floor(e.millisecond/100));case"m":return this.num(e.minute);case"mm":return this.num(e.minute,2);case"h":return this.num(e.hour%12===0?12:e.hour%12);case"hh":return this.num(e.hour%12===0?12:e.hour%12,2);case"H":return this.num(e.hour);case"HH":return this.num(e.hour,2);case"Z":return s({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return s({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return s({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return e.zone.offsetName(e.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return e.zone.offsetName(e.ts,{format:"long",locale:this.loc.locale});case"z":return e.zoneName;case"a":return l();case"d":return r?o({day:"numeric"},"day"):this.num(e.day);case"dd":return r?o({day:"2-digit"},"day"):this.num(e.day,2);case"c":return this.num(e.weekday);case"ccc":return u("short",!0);case"cccc":return u("long",!0);case"ccccc":return u("narrow",!0);case"E":return this.num(e.weekday);case"EEE":return u("short",!1);case"EEEE":return u("long",!1);case"EEEEE":return u("narrow",!1);case"L":return r?o({month:"numeric",day:"numeric"},"month"):this.num(e.month);case"LL":return r?o({month:"2-digit",day:"numeric"},"month"):this.num(e.month,2);case"LLL":return c("short",!0);case"LLLL":return c("long",!0);case"LLLLL":return c("narrow",!0);case"M":return r?o({month:"numeric"},"month"):this.num(e.month);case"MM":return r?o({month:"2-digit"},"month"):this.num(e.month,2);case"MMM":return c("short",!1);case"MMMM":return c("long",!1);case"MMMMM":return c("narrow",!1);case"y":return r?o({year:"numeric"},"year"):this.num(e.year);case"yy":return r?o({year:"2-digit"},"year"):this.num(e.year.toString().slice(-2),2);case"yyyy":return r?o({year:"numeric"},"year"):this.num(e.year,4);case"yyyyyy":return r?o({year:"numeric"},"year"):this.num(e.year,6);case"G":return m("short");case"GG":return m("long");case"GGGGG":return m("narrow");case"kk":return this.num(e.weekYear.toString().slice(-2),2);case"kkkk":return this.num(e.weekYear,4);case"W":return this.num(e.weekNumber);case"WW":return this.num(e.weekNumber,2);case"n":return this.num(e.localWeekNumber);case"nn":return this.num(e.localWeekNumber,2);case"ii":return this.num(e.localWeekYear.toString().slice(-2),2);case"iiii":return this.num(e.localWeekYear,4);case"o":return this.num(e.ordinal);case"ooo":return this.num(e.ordinal,3);case"q":return this.num(e.quarter);case"qq":return this.num(e.quarter,2);case"X":return this.num(Math.floor(e.ts/1e3));case"x":return this.num(e.ts);default:return d(h)}};return ja(ce.parseFormat(n),p)}formatDurationFromString(e,n){const a=c=>{switch(c[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"w":return"week";case"M":return"month";case"y":return"year";default:return null}},r=c=>u=>{const d=a(u);return d?this.num(c.get(d),u.length):u},o=ce.parseFormat(n),s=o.reduce((c,{literal:u,val:d})=>u?c:c.concat(d),[]),l=e.shiftTo(...s.map(a).filter(c=>c));return ja(o,r(l))}}const so=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function Lt(...t){const e=t.reduce((n,a)=>n+a.source,"");return RegExp(`^${e}$`)}function Mt(...t){return e=>t.reduce(([n,a,r],o)=>{const[s,l,c]=o(e,r);return[{...n,...s},l||a,c]},[{},null,1]).slice(0,2)}function St(t,...e){if(t==null)return[null,null];for(const[n,a]of e){const r=n.exec(t);if(r)return a(r)}return[null,null]}function lo(...t){return(e,n)=>{const a={};let r;for(r=0;r<t.length;r++)a[t[r]]=He(e[n+r]);return[a,null,n+r]}}const co=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,Ki=`(?:${co.source}?(?:\\[(${so.source})\\])?)?`,ha=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,uo=RegExp(`${ha.source}${Ki}`),fa=RegExp(`(?:T${uo.source})?`),Yi=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,Xi=/(\d{4})-?W(\d\d)(?:-?(\d))?/,Qi=/(\d{4})-?(\d{3})/,es=lo("weekYear","weekNumber","weekDay"),ts=lo("year","ordinal"),ns=/(\d{4})-(\d\d)-(\d\d)/,mo=RegExp(`${ha.source} ?(?:${co.source}|(${so.source}))?`),as=RegExp(`(?: ${mo.source})?`);function pt(t,e,n){const a=t[e];return H(a)?n:He(a)}function rs(t,e){return[{year:pt(t,e),month:pt(t,e+1,1),day:pt(t,e+2,1)},null,e+3]}function bt(t,e){return[{hours:pt(t,e,0),minutes:pt(t,e+1,0),seconds:pt(t,e+2,0),milliseconds:da(t[e+3])},null,e+4]}function Ut(t,e){const n=!t[e]&&!t[e+1],a=fn(t[e+1],t[e+2]),r=n?null:de.instance(a);return[{},r,e+3]}function Ht(t,e){const n=t[e]?xe.create(t[e]):null;return[{},n,e+1]}const os=RegExp(`^T?${ha.source}$`),is=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function ss(t){const[e,n,a,r,o,s,l,c,u]=t,d=e[0]==="-",m=c&&c[0]==="-",p=(h,v=!1)=>h!==void 0&&(v||h&&d)?-h:h;return[{years:p(Xe(n)),months:p(Xe(a)),weeks:p(Xe(r)),days:p(Xe(o)),hours:p(Xe(s)),minutes:p(Xe(l)),seconds:p(Xe(c),c==="-0"),milliseconds:p(da(u),m)}]}const ls={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function ga(t,e,n,a,r,o,s){const l={year:e.length===2?Xn(He(e)):He(e),month:eo.indexOf(n)+1,day:He(a),hour:He(r),minute:He(o)};return s&&(l.second=He(s)),t&&(l.weekday=t.length>3?no.indexOf(t)+1:ao.indexOf(t)+1),l}const cs=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function us(t){const[,e,n,a,r,o,s,l,c,u,d,m]=t,p=ga(e,r,a,n,o,s,l);let h;return c?h=ls[c]:u?h=0:h=fn(d,m),[p,new de(h)]}function ds(t){return t.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const ms=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,hs=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,fs=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function Ja(t){const[,e,n,a,r,o,s,l]=t;return[ga(e,r,a,n,o,s,l),de.utcInstance]}function gs(t){const[,e,n,a,r,o,s,l]=t;return[ga(e,l,n,a,r,o,s),de.utcInstance]}const ps=Lt(Yi,fa),ys=Lt(Xi,fa),ws=Lt(Qi,fa),vs=Lt(uo),ho=Mt(rs,bt,Ut,Ht),Ls=Mt(es,bt,Ut,Ht),Ms=Mt(ts,bt,Ut,Ht),Ss=Mt(bt,Ut,Ht);function bs(t){return St(t,[ps,ho],[ys,Ls],[ws,Ms],[vs,Ss])}function Es(t){return St(ds(t),[cs,us])}function _s(t){return St(t,[ms,Ja],[hs,Ja],[fs,gs])}function ks(t){return St(t,[is,ss])}const Ts=Mt(bt);function As(t){return St(t,[os,Ts])}const Cs=Lt(ns,as),Is=Lt(mo),Ns=Mt(bt,Ut,Ht);function Ps(t){return St(t,[Cs,ho],[Is,Ns])}const qa="Invalid Duration",fo={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1e3},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1e3},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},Ds={years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1e3},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1e3},...fo},we=146097/400,lt=146097/4800,Fs={years:{quarters:4,months:12,weeks:we/7,days:we,hours:we*24,minutes:we*24*60,seconds:we*24*60*60,milliseconds:we*24*60*60*1e3},quarters:{months:3,weeks:we/28,days:we/4,hours:we*24/4,minutes:we*24*60/4,seconds:we*24*60*60/4,milliseconds:we*24*60*60*1e3/4},months:{weeks:lt/7,days:lt,hours:lt*24,minutes:lt*24*60,seconds:lt*24*60*60,milliseconds:lt*24*60*60*1e3},...fo},at=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],xs=at.slice(0).reverse();function We(t,e,n=!1){const a={values:n?e.values:{...t.values,...e.values||{}},loc:t.loc.clone(e.loc),conversionAccuracy:e.conversionAccuracy||t.conversionAccuracy,matrix:e.matrix||t.matrix};return new G(a)}function go(t,e){let n=e.milliseconds??0;for(const a of xs.slice(1))e[a]&&(n+=e[a]*t[a].milliseconds);return n}function Ka(t,e){const n=go(t,e)<0?-1:1;at.reduceRight((a,r)=>{if(H(e[r]))return a;if(a){const o=e[a]*n,s=t[r][a],l=Math.floor(o/s);e[r]+=l*n,e[a]-=l*s*n}return r},null),at.reduce((a,r)=>{if(H(e[r]))return a;if(a){const o=e[a]%1;e[a]-=o,e[r]+=o*t[a][r]}return r},null)}function $s(t){const e={};for(const[n,a]of Object.entries(t))a!==0&&(e[n]=a);return e}class G{constructor(e){const n=e.conversionAccuracy==="longterm"||!1;let a=n?Fs:Ds;e.matrix&&(a=e.matrix),this.values=e.values,this.loc=e.loc||j.create(),this.conversionAccuracy=n?"longterm":"casual",this.invalid=e.invalid||null,this.matrix=a,this.isLuxonDuration=!0}static fromMillis(e,n){return G.fromObject({milliseconds:e},n)}static fromObject(e,n={}){if(e==null||typeof e!="object")throw new le(`Duration.fromObject: argument expected to be an object, got ${e===null?"null":typeof e}`);return new G({values:sn(e,G.normalizeUnit),loc:j.fromObject(n),conversionAccuracy:n.conversionAccuracy,matrix:n.matrix})}static fromDurationLike(e){if(Je(e))return G.fromMillis(e);if(G.isDuration(e))return e;if(typeof e=="object")return G.fromObject(e);throw new le(`Unknown duration argument ${e} of type ${typeof e}`)}static fromISO(e,n){const[a]=ks(e);return a?G.fromObject(a,n):G.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static fromISOTime(e,n){const[a]=As(e);return a?G.fromObject(a,n):G.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static invalid(e,n=null){if(!e)throw new le("need to specify a reason the Duration is invalid");const a=e instanceof Te?e:new Te(e,n);if(Y.throwOnInvalid)throw new si(a);return new G({invalid:a})}static normalizeUnit(e){const n={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[e&&e.toLowerCase()];if(!n)throw new Sr(e);return n}static isDuration(e){return e&&e.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(e,n={}){const a={...n,floor:n.round!==!1&&n.floor!==!1};return this.isValid?ce.create(this.loc,a).formatDurationFromString(this,e):qa}toHuman(e={}){if(!this.isValid)return qa;const n=at.map(a=>{const r=this.values[a];return H(r)?null:this.loc.numberFormatter({style:"unit",unitDisplay:"long",...e,unit:a.slice(0,-1)}).format(r)}).filter(a=>a);return this.loc.listFormatter({type:"conjunction",style:e.listStyle||"narrow",...e}).format(n)}toObject(){return this.isValid?{...this.values}:{}}toISO(){if(!this.isValid)return null;let e="P";return this.years!==0&&(e+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(e+=this.months+this.quarters*3+"M"),this.weeks!==0&&(e+=this.weeks+"W"),this.days!==0&&(e+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(e+="T"),this.hours!==0&&(e+=this.hours+"H"),this.minutes!==0&&(e+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(e+=ma(this.seconds+this.milliseconds/1e3,3)+"S"),e==="P"&&(e+="T0S"),e}toISOTime(e={}){if(!this.isValid)return null;const n=this.toMillis();return n<0||n>=864e5?null:(e={suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended",...e,includeOffset:!1},F.fromMillis(n,{zone:"UTC"}).toISOTime(e))}toJSON(){return this.toISO()}toString(){return this.toISO()}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Duration { values: ${JSON.stringify(this.values)} }`:`Duration { Invalid, reason: ${this.invalidReason} }`}toMillis(){return this.isValid?go(this.matrix,this.values):NaN}valueOf(){return this.toMillis()}plus(e){if(!this.isValid)return this;const n=G.fromDurationLike(e),a={};for(const r of at)(yt(n.values,r)||yt(this.values,r))&&(a[r]=n.get(r)+this.get(r));return We(this,{values:a},!0)}minus(e){if(!this.isValid)return this;const n=G.fromDurationLike(e);return this.plus(n.negate())}mapUnits(e){if(!this.isValid)return this;const n={};for(const a of Object.keys(this.values))n[a]=Qr(e(this.values[a],a));return We(this,{values:n},!0)}get(e){return this[G.normalizeUnit(e)]}set(e){if(!this.isValid)return this;const n={...this.values,...sn(e,G.normalizeUnit)};return We(this,{values:n})}reconfigure({locale:e,numberingSystem:n,conversionAccuracy:a,matrix:r}={}){const s={loc:this.loc.clone({locale:e,numberingSystem:n}),matrix:r,conversionAccuracy:a};return We(this,s)}as(e){return this.isValid?this.shiftTo(e).get(e):NaN}normalize(){if(!this.isValid)return this;const e=this.toObject();return Ka(this.matrix,e),We(this,{values:e},!0)}rescale(){if(!this.isValid)return this;const e=$s(this.normalize().shiftToAll().toObject());return We(this,{values:e},!0)}shiftTo(...e){if(!this.isValid)return this;if(e.length===0)return this;e=e.map(s=>G.normalizeUnit(s));const n={},a={},r=this.toObject();let o;for(const s of at)if(e.indexOf(s)>=0){o=s;let l=0;for(const u in a)l+=this.matrix[u][s]*a[u],a[u]=0;Je(r[s])&&(l+=r[s]);const c=Math.trunc(l);n[s]=c,a[s]=(l*1e3-c*1e3)/1e3}else Je(r[s])&&(a[s]=r[s]);for(const s in a)a[s]!==0&&(n[o]+=s===o?a[s]:a[s]/this.matrix[o][s]);return Ka(this.matrix,n),We(this,{values:n},!0)}shiftToAll(){return this.isValid?this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds"):this}negate(){if(!this.isValid)return this;const e={};for(const n of Object.keys(this.values))e[n]=this.values[n]===0?0:-this.values[n];return We(this,{values:e},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(e){if(!this.isValid||!e.isValid||!this.loc.equals(e.loc))return!1;function n(a,r){return a===void 0||a===0?r===void 0||r===0:a===r}for(const a of at)if(!n(this.values[a],e.values[a]))return!1;return!0}}const ct="Invalid Interval";function Os(t,e){return!t||!t.isValid?K.invalid("missing or invalid start"):!e||!e.isValid?K.invalid("missing or invalid end"):e<t?K.invalid("end before start",`The end of an interval must be after its start, but you had start=${t.toISO()} and end=${e.toISO()}`):null}class K{constructor(e){this.s=e.start,this.e=e.end,this.invalid=e.invalid||null,this.isLuxonInterval=!0}static invalid(e,n=null){if(!e)throw new le("need to specify a reason the Interval is invalid");const a=e instanceof Te?e:new Te(e,n);if(Y.throwOnInvalid)throw new ii(a);return new K({invalid:a})}static fromDateTimes(e,n){const a=_t(e),r=_t(n),o=Os(a,r);return o??new K({start:a,end:r})}static after(e,n){const a=G.fromDurationLike(n),r=_t(e);return K.fromDateTimes(r,r.plus(a))}static before(e,n){const a=G.fromDurationLike(n),r=_t(e);return K.fromDateTimes(r.minus(a),r)}static fromISO(e,n){const[a,r]=(e||"").split("/",2);if(a&&r){let o,s;try{o=F.fromISO(a,n),s=o.isValid}catch{s=!1}let l,c;try{l=F.fromISO(r,n),c=l.isValid}catch{c=!1}if(s&&c)return K.fromDateTimes(o,l);if(s){const u=G.fromISO(r,n);if(u.isValid)return K.after(o,u)}else if(c){const u=G.fromISO(a,n);if(u.isValid)return K.before(l,u)}}return K.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static isInterval(e){return e&&e.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get lastDateTime(){return this.isValid&&this.e?this.e.minus(1):null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(e="milliseconds"){return this.isValid?this.toDuration(e).get(e):NaN}count(e="milliseconds",n){if(!this.isValid)return NaN;const a=this.start.startOf(e,n);let r;return n!=null&&n.useLocaleWeeks?r=this.end.reconfigure({locale:a.locale}):r=this.end,r=r.startOf(e,n),Math.floor(r.diff(a,e).get(e))+(r.valueOf()!==this.end.valueOf())}hasSame(e){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,e):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(e){return this.isValid?this.s>e:!1}isBefore(e){return this.isValid?this.e<=e:!1}contains(e){return this.isValid?this.s<=e&&this.e>e:!1}set({start:e,end:n}={}){return this.isValid?K.fromDateTimes(e||this.s,n||this.e):this}splitAt(...e){if(!this.isValid)return[];const n=e.map(_t).filter(s=>this.contains(s)).sort((s,l)=>s.toMillis()-l.toMillis()),a=[];let{s:r}=this,o=0;for(;r<this.e;){const s=n[o]||this.e,l=+s>+this.e?this.e:s;a.push(K.fromDateTimes(r,l)),r=l,o+=1}return a}splitBy(e){const n=G.fromDurationLike(e);if(!this.isValid||!n.isValid||n.as("milliseconds")===0)return[];let{s:a}=this,r=1,o;const s=[];for(;a<this.e;){const l=this.start.plus(n.mapUnits(c=>c*r));o=+l>+this.e?this.e:l,s.push(K.fromDateTimes(a,o)),a=o,r+=1}return s}divideEqually(e){return this.isValid?this.splitBy(this.length()/e).slice(0,e):[]}overlaps(e){return this.e>e.s&&this.s<e.e}abutsStart(e){return this.isValid?+this.e==+e.s:!1}abutsEnd(e){return this.isValid?+e.e==+this.s:!1}engulfs(e){return this.isValid?this.s<=e.s&&this.e>=e.e:!1}equals(e){return!this.isValid||!e.isValid?!1:this.s.equals(e.s)&&this.e.equals(e.e)}intersection(e){if(!this.isValid)return this;const n=this.s>e.s?this.s:e.s,a=this.e<e.e?this.e:e.e;return n>=a?null:K.fromDateTimes(n,a)}union(e){if(!this.isValid)return this;const n=this.s<e.s?this.s:e.s,a=this.e>e.e?this.e:e.e;return K.fromDateTimes(n,a)}static merge(e){const[n,a]=e.sort((r,o)=>r.s-o.s).reduce(([r,o],s)=>o?o.overlaps(s)||o.abutsStart(s)?[r,o.union(s)]:[r.concat([o]),s]:[r,s],[[],null]);return a&&n.push(a),n}static xor(e){let n=null,a=0;const r=[],o=e.map(c=>[{time:c.s,type:"s"},{time:c.e,type:"e"}]),s=Array.prototype.concat(...o),l=s.sort((c,u)=>c.time-u.time);for(const c of l)a+=c.type==="s"?1:-1,a===1?n=c.time:(n&&+n!=+c.time&&r.push(K.fromDateTimes(n,c.time)),n=null);return K.merge(r)}difference(...e){return K.xor([this].concat(e)).map(n=>this.intersection(n)).filter(n=>n&&!n.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()} – ${this.e.toISO()})`:ct}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Interval { start: ${this.s.toISO()}, end: ${this.e.toISO()} }`:`Interval { Invalid, reason: ${this.invalidReason} }`}toLocaleString(e=an,n={}){return this.isValid?ce.create(this.s.loc.clone(n),e).formatInterval(this):ct}toISO(e){return this.isValid?`${this.s.toISO(e)}/${this.e.toISO(e)}`:ct}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:ct}toISOTime(e){return this.isValid?`${this.s.toISOTime(e)}/${this.e.toISOTime(e)}`:ct}toFormat(e,{separator:n=" – "}={}){return this.isValid?`${this.s.toFormat(e)}${n}${this.e.toFormat(e)}`:ct}toDuration(e,n){return this.isValid?this.e.diff(this.s,e,n):G.invalid(this.invalidReason)}mapEndpoints(e){return K.fromDateTimes(e(this.s),e(this.e))}}class Zt{static hasDST(e=Y.defaultZone){const n=F.now().setZone(e).set({month:12});return!e.isUniversal&&n.offset!==n.set({month:6}).offset}static isValidIANAZone(e){return xe.isValidZone(e)}static normalizeZone(e){return Ge(e,Y.defaultZone)}static getStartOfWeek({locale:e=null,locObj:n=null}={}){return(n||j.create(e)).getStartOfWeek()}static getMinimumDaysInFirstWeek({locale:e=null,locObj:n=null}={}){return(n||j.create(e)).getMinDaysInFirstWeek()}static getWeekendWeekdays({locale:e=null,locObj:n=null}={}){return(n||j.create(e)).getWeekendDays().slice()}static months(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null,outputCalendar:o="gregory"}={}){return(r||j.create(n,a,o)).months(e)}static monthsFormat(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null,outputCalendar:o="gregory"}={}){return(r||j.create(n,a,o)).months(e,!0)}static weekdays(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null}={}){return(r||j.create(n,a,null)).weekdays(e)}static weekdaysFormat(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null}={}){return(r||j.create(n,a,null)).weekdays(e,!0)}static meridiems({locale:e=null}={}){return j.create(e).meridiems()}static eras(e="short",{locale:n=null}={}){return j.create(n,null,"gregory").eras(e)}static features(){return{relative:Kr(),localeWeek:Yr()}}}function Ya(t,e){const n=r=>r.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),a=n(e)-n(t);return Math.floor(G.fromMillis(a).as("days"))}function Rs(t,e,n){const a=[["years",(c,u)=>u.year-c.year],["quarters",(c,u)=>u.quarter-c.quarter+(u.year-c.year)*4],["months",(c,u)=>u.month-c.month+(u.year-c.year)*12],["weeks",(c,u)=>{const d=Ya(c,u);return(d-d%7)/7}],["days",Ya]],r={},o=t;let s,l;for(const[c,u]of a)n.indexOf(c)>=0&&(s=c,r[c]=u(t,e),l=o.plus(r),l>e?(r[c]--,t=o.plus(r),t>e&&(l=t,r[c]--,t=o.plus(r))):t=l);return[t,r,l,s]}function Ws(t,e,n,a){let[r,o,s,l]=Rs(t,e,n);const c=e-r,u=n.filter(m=>["hours","minutes","seconds","milliseconds"].indexOf(m)>=0);u.length===0&&(s<e&&(s=r.plus({[l]:1})),s!==r&&(o[l]=(o[l]||0)+c/(s-r)));const d=G.fromObject(o,a);return u.length>0?G.fromMillis(c,a).shiftTo(...u).plus(d):d}const Us="missing Intl.DateTimeFormat.formatToParts support";function Z(t,e=n=>n){return{regex:t,deser:([n])=>e(Ci(n))}}const Hs=" ",po=`[ ${Hs}]`,yo=new RegExp(po,"g");function Bs(t){return t.replace(/\./g,"\\.?").replace(yo,po)}function Xa(t){return t.replace(/\./g,"").replace(yo," ").toLowerCase()}function Ee(t,e){return t===null?null:{regex:RegExp(t.map(Bs).join("|")),deser:([n])=>t.findIndex(a=>Xa(n)===Xa(a))+e}}function Qa(t,e){return{regex:t,deser:([,n,a])=>fn(n,a),groups:e}}function jt(t){return{regex:t,deser:([e])=>e}}function zs(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Gs(t,e){const n=be(e),a=be(e,"{2}"),r=be(e,"{3}"),o=be(e,"{4}"),s=be(e,"{6}"),l=be(e,"{1,2}"),c=be(e,"{1,3}"),u=be(e,"{1,6}"),d=be(e,"{1,9}"),m=be(e,"{2,4}"),p=be(e,"{4,6}"),h=w=>({regex:RegExp(zs(w.val)),deser:([M])=>M,literal:!0}),S=(w=>{if(t.literal)return h(w);switch(w.val){case"G":return Ee(e.eras("short"),0);case"GG":return Ee(e.eras("long"),0);case"y":return Z(u);case"yy":return Z(m,Xn);case"yyyy":return Z(o);case"yyyyy":return Z(p);case"yyyyyy":return Z(s);case"M":return Z(l);case"MM":return Z(a);case"MMM":return Ee(e.months("short",!0),1);case"MMMM":return Ee(e.months("long",!0),1);case"L":return Z(l);case"LL":return Z(a);case"LLL":return Ee(e.months("short",!1),1);case"LLLL":return Ee(e.months("long",!1),1);case"d":return Z(l);case"dd":return Z(a);case"o":return Z(c);case"ooo":return Z(r);case"HH":return Z(a);case"H":return Z(l);case"hh":return Z(a);case"h":return Z(l);case"mm":return Z(a);case"m":return Z(l);case"q":return Z(l);case"qq":return Z(a);case"s":return Z(l);case"ss":return Z(a);case"S":return Z(c);case"SSS":return Z(r);case"u":return jt(d);case"uu":return jt(l);case"uuu":return Z(n);case"a":return Ee(e.meridiems(),0);case"kkkk":return Z(o);case"kk":return Z(m,Xn);case"W":return Z(l);case"WW":return Z(a);case"E":case"c":return Z(n);case"EEE":return Ee(e.weekdays("short",!1),1);case"EEEE":return Ee(e.weekdays("long",!1),1);case"ccc":return Ee(e.weekdays("short",!0),1);case"cccc":return Ee(e.weekdays("long",!0),1);case"Z":case"ZZ":return Qa(new RegExp(`([+-]${l.source})(?::(${a.source}))?`),2);case"ZZZ":return Qa(new RegExp(`([+-]${l.source})(${a.source})?`),2);case"z":return jt(/[a-z_+-/]{1,256}?/i);case" ":return jt(/[^\S\n\r]/);default:return h(w)}})(t)||{invalidReason:Us};return S.token=t,S}const Vs={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour12:{numeric:"h","2-digit":"hh"},hour24:{numeric:"H","2-digit":"HH"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"},timeZoneName:{long:"ZZZZZ",short:"ZZZ"}};function Zs(t,e,n){const{type:a,value:r}=t;if(a==="literal"){const c=/^\s+$/.test(r);return{literal:!c,val:c?" ":r}}const o=e[a];let s=a;a==="hour"&&(e.hour12!=null?s=e.hour12?"hour12":"hour24":e.hourCycle!=null?e.hourCycle==="h11"||e.hourCycle==="h12"?s="hour12":s="hour24":s=n.hour12?"hour12":"hour24");let l=Vs[s];if(typeof l=="object"&&(l=l[o]),l)return{literal:!1,val:l}}function js(t){return[`^${t.map(n=>n.regex).reduce((n,a)=>`${n}(${a.source})`,"")}$`,t]}function Js(t,e,n){const a=t.match(e);if(a){const r={};let o=1;for(const s in n)if(yt(n,s)){const l=n[s],c=l.groups?l.groups+1:1;!l.literal&&l.token&&(r[l.token.val[0]]=l.deser(a.slice(o,o+c))),o+=c}return[a,r]}else return[a,{}]}function qs(t){const e=o=>{switch(o){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let n=null,a;return H(t.z)||(n=xe.create(t.z)),H(t.Z)||(n||(n=new de(t.Z)),a=t.Z),H(t.q)||(t.M=(t.q-1)*3+1),H(t.h)||(t.h<12&&t.a===1?t.h+=12:t.h===12&&t.a===0&&(t.h=0)),t.G===0&&t.y&&(t.y=-t.y),H(t.u)||(t.S=da(t.u)),[Object.keys(t).reduce((o,s)=>{const l=e(s);return l&&(o[l]=t[s]),o},{}),n,a]}let Cn=null;function Ks(){return Cn||(Cn=F.fromMillis(1555555555555)),Cn}function Ys(t,e){if(t.literal)return t;const n=ce.macroTokenToFormatOpts(t.val),a=Mo(n,e);return a==null||a.includes(void 0)?t:a}function wo(t,e){return Array.prototype.concat(...t.map(n=>Ys(n,e)))}class vo{constructor(e,n){if(this.locale=e,this.format=n,this.tokens=wo(ce.parseFormat(n),e),this.units=this.tokens.map(a=>Gs(a,e)),this.disqualifyingUnit=this.units.find(a=>a.invalidReason),!this.disqualifyingUnit){const[a,r]=js(this.units);this.regex=RegExp(a,"i"),this.handlers=r}}explainFromTokens(e){if(this.isValid){const[n,a]=Js(e,this.regex,this.handlers),[r,o,s]=a?qs(a):[null,null,void 0];if(yt(a,"a")&&yt(a,"H"))throw new ht("Can't include meridiem when specifying 24-hour format");return{input:e,tokens:this.tokens,regex:this.regex,rawMatches:n,matches:a,result:r,zone:o,specificOffset:s}}else return{input:e,tokens:this.tokens,invalidReason:this.invalidReason}}get isValid(){return!this.disqualifyingUnit}get invalidReason(){return this.disqualifyingUnit?this.disqualifyingUnit.invalidReason:null}}function Lo(t,e,n){return new vo(t,n).explainFromTokens(e)}function Xs(t,e,n){const{result:a,zone:r,specificOffset:o,invalidReason:s}=Lo(t,e,n);return[a,r,o,s]}function Mo(t,e){if(!t)return null;const a=ce.create(e,t).dtFormatter(Ks()),r=a.formatToParts(),o=a.resolvedOptions();return r.map(s=>Zs(s,t,o))}const In="Invalid DateTime",er=864e13;function Tt(t){return new Te("unsupported zone",`the zone "${t.name}" is not supported`)}function Nn(t){return t.weekData===null&&(t.weekData=rn(t.c)),t.weekData}function Pn(t){return t.localWeekData===null&&(t.localWeekData=rn(t.c,t.loc.getMinDaysInFirstWeek(),t.loc.getStartOfWeek())),t.localWeekData}function Qe(t,e){const n={ts:t.ts,zone:t.zone,c:t.c,o:t.o,loc:t.loc,invalid:t.invalid};return new F({...n,...e,old:n})}function So(t,e,n){let a=t-e*60*1e3;const r=n.offset(a);if(e===r)return[a,e];a-=(r-e)*60*1e3;const o=n.offset(a);return r===o?[a,r]:[t-Math.min(r,o)*60*1e3,Math.max(r,o)]}function Jt(t,e){t+=e*60*1e3;const n=new Date(t);return{year:n.getUTCFullYear(),month:n.getUTCMonth()+1,day:n.getUTCDate(),hour:n.getUTCHours(),minute:n.getUTCMinutes(),second:n.getUTCSeconds(),millisecond:n.getUTCMilliseconds()}}function en(t,e,n){return So(hn(t),e,n)}function tr(t,e){const n=t.o,a=t.c.year+Math.trunc(e.years),r=t.c.month+Math.trunc(e.months)+Math.trunc(e.quarters)*3,o={...t.c,year:a,month:r,day:Math.min(t.c.day,on(a,r))+Math.trunc(e.days)+Math.trunc(e.weeks)*7},s=G.fromObject({years:e.years-Math.trunc(e.years),quarters:e.quarters-Math.trunc(e.quarters),months:e.months-Math.trunc(e.months),weeks:e.weeks-Math.trunc(e.weeks),days:e.days-Math.trunc(e.days),hours:e.hours,minutes:e.minutes,seconds:e.seconds,milliseconds:e.milliseconds}).as("milliseconds"),l=hn(o);let[c,u]=So(l,n,t.zone);return s!==0&&(c+=s,u=t.zone.offset(c)),{ts:c,o:u}}function ut(t,e,n,a,r,o){const{setZone:s,zone:l}=n;if(t&&Object.keys(t).length!==0||e){const c=e||l,u=F.fromObject(t,{...n,zone:c,specificOffset:o});return s?u:u.setZone(l)}else return F.invalid(new Te("unparsable",`the input "${r}" can't be parsed as ${a}`))}function qt(t,e,n=!0){return t.isValid?ce.create(j.create("en-US"),{allowZ:n,forceSimple:!0}).formatDateTimeFromString(t,e):null}function Dn(t,e){const n=t.c.year>9999||t.c.year<0;let a="";return n&&t.c.year>=0&&(a+="+"),a+=Q(t.c.year,n?6:4),e?(a+="-",a+=Q(t.c.month),a+="-",a+=Q(t.c.day)):(a+=Q(t.c.month),a+=Q(t.c.day)),a}function nr(t,e,n,a,r,o){let s=Q(t.c.hour);return e?(s+=":",s+=Q(t.c.minute),(t.c.millisecond!==0||t.c.second!==0||!n)&&(s+=":")):s+=Q(t.c.minute),(t.c.millisecond!==0||t.c.second!==0||!n)&&(s+=Q(t.c.second),(t.c.millisecond!==0||!a)&&(s+=".",s+=Q(t.c.millisecond,3))),r&&(t.isOffsetFixed&&t.offset===0&&!o?s+="Z":t.o<0?(s+="-",s+=Q(Math.trunc(-t.o/60)),s+=":",s+=Q(Math.trunc(-t.o%60))):(s+="+",s+=Q(Math.trunc(t.o/60)),s+=":",s+=Q(Math.trunc(t.o%60)))),o&&(s+="["+t.zone.ianaName+"]"),s}const bo={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},Qs={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},el={ordinal:1,hour:0,minute:0,second:0,millisecond:0},Eo=["year","month","day","hour","minute","second","millisecond"],tl=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],nl=["year","ordinal","hour","minute","second","millisecond"];function al(t){const e={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[t.toLowerCase()];if(!e)throw new Sr(t);return e}function ar(t){switch(t.toLowerCase()){case"localweekday":case"localweekdays":return"localWeekday";case"localweeknumber":case"localweeknumbers":return"localWeekNumber";case"localweekyear":case"localweekyears":return"localWeekYear";default:return al(t)}}function rl(t){if(At===void 0&&(At=Y.now()),t.type!=="iana")return t.offset(At);const e=t.name;let n=Qn.get(e);return n===void 0&&(n=t.offset(At),Qn.set(e,n)),n}function rr(t,e){const n=Ge(e.zone,Y.defaultZone);if(!n.isValid)return F.invalid(Tt(n));const a=j.fromObject(e);let r,o;if(H(t.year))r=Y.now();else{for(const c of Eo)H(t[c])&&(t[c]=bo[c]);const s=Jr(t)||qr(t);if(s)return F.invalid(s);const l=rl(n);[r,o]=en(t,l,n)}return new F({ts:r,zone:n,loc:a,o})}function or(t,e,n){const a=H(n.round)?!0:n.round,r=(s,l)=>(s=ma(s,a||n.calendary?0:2,!0),e.loc.clone(n).relFormatter(n).format(s,l)),o=s=>n.calendary?e.hasSame(t,s)?0:e.startOf(s).diff(t.startOf(s),s).get(s):e.diff(t,s).get(s);if(n.unit)return r(o(n.unit),n.unit);for(const s of n.units){const l=o(s);if(Math.abs(l)>=1)return r(l,s)}return r(t>e?-0:0,n.units[n.units.length-1])}function ir(t){let e={},n;return t.length>0&&typeof t[t.length-1]=="object"?(e=t[t.length-1],n=Array.from(t).slice(0,t.length-1)):n=Array.from(t),[e,n]}let At;const Qn=new Map;class F{constructor(e){const n=e.zone||Y.defaultZone;let a=e.invalid||(Number.isNaN(e.ts)?new Te("invalid input"):null)||(n.isValid?null:Tt(n));this.ts=H(e.ts)?Y.now():e.ts;let r=null,o=null;if(!a)if(e.old&&e.old.ts===this.ts&&e.old.zone.equals(n))[r,o]=[e.old.c,e.old.o];else{const l=Je(e.o)&&!e.old?e.o:n.offset(this.ts);r=Jt(this.ts,l),a=Number.isNaN(r.year)?new Te("invalid input"):null,r=a?null:r,o=a?null:l}this._zone=n,this.loc=e.loc||j.create(),this.invalid=a,this.weekData=null,this.localWeekData=null,this.c=r,this.o=o,this.isLuxonDateTime=!0}static now(){return new F({})}static local(){const[e,n]=ir(arguments),[a,r,o,s,l,c,u]=n;return rr({year:a,month:r,day:o,hour:s,minute:l,second:c,millisecond:u},e)}static utc(){const[e,n]=ir(arguments),[a,r,o,s,l,c,u]=n;return e.zone=de.utcInstance,rr({year:a,month:r,day:o,hour:s,minute:l,second:c,millisecond:u},e)}static fromJSDate(e,n={}){const a=Fi(e)?e.valueOf():NaN;if(Number.isNaN(a))return F.invalid("invalid input");const r=Ge(n.zone,Y.defaultZone);return r.isValid?new F({ts:a,zone:r,loc:j.fromObject(n)}):F.invalid(Tt(r))}static fromMillis(e,n={}){if(Je(e))return e<-er||e>er?F.invalid("Timestamp out of range"):new F({ts:e,zone:Ge(n.zone,Y.defaultZone),loc:j.fromObject(n)});throw new le(`fromMillis requires a numerical input, but received a ${typeof e} with value ${e}`)}static fromSeconds(e,n={}){if(Je(e))return new F({ts:e*1e3,zone:Ge(n.zone,Y.defaultZone),loc:j.fromObject(n)});throw new le("fromSeconds requires a numerical input")}static fromObject(e,n={}){e=e||{};const a=Ge(n.zone,Y.defaultZone);if(!a.isValid)return F.invalid(Tt(a));const r=j.fromObject(n),o=sn(e,ar),{minDaysInFirstWeek:s,startOfWeek:l}=Ga(o,r),c=Y.now(),u=H(n.specificOffset)?a.offset(c):n.specificOffset,d=!H(o.ordinal),m=!H(o.year),p=!H(o.month)||!H(o.day),h=m||p,v=o.weekYear||o.weekNumber;if((h||d)&&v)throw new ht("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(p&&d)throw new ht("Can't mix ordinal dates with month/day");const S=v||o.weekday&&!h;let w,M,y=Jt(c,u);S?(w=tl,M=Qs,y=rn(y,s,l)):d?(w=nl,M=el,y=An(y)):(w=Eo,M=bo);let _=!1;for(const P of w){const x=o[P];H(x)?_?o[P]=M[P]:o[P]=y[P]:_=!0}const b=S?Ni(o,s,l):d?Pi(o):Jr(o),E=b||qr(o);if(E)return F.invalid(E);const k=S?Ba(o,s,l):d?za(o):o,[A,T]=en(k,u,a),N=new F({ts:A,zone:a,o:T,loc:r});return o.weekday&&h&&e.weekday!==N.weekday?F.invalid("mismatched weekday",`you can't specify both a weekday of ${o.weekday} and a date of ${N.toISO()}`):N.isValid?N:F.invalid(N.invalid)}static fromISO(e,n={}){const[a,r]=bs(e);return ut(a,r,n,"ISO 8601",e)}static fromRFC2822(e,n={}){const[a,r]=Es(e);return ut(a,r,n,"RFC 2822",e)}static fromHTTP(e,n={}){const[a,r]=_s(e);return ut(a,r,n,"HTTP",n)}static fromFormat(e,n,a={}){if(H(e)||H(n))throw new le("fromFormat requires an input string and a format");const{locale:r=null,numberingSystem:o=null}=a,s=j.fromOpts({locale:r,numberingSystem:o,defaultToEN:!0}),[l,c,u,d]=Xs(s,e,n);return d?F.invalid(d):ut(l,c,a,`format ${n}`,e,u)}static fromString(e,n,a={}){return F.fromFormat(e,n,a)}static fromSQL(e,n={}){const[a,r]=Ps(e);return ut(a,r,n,"SQL",e)}static invalid(e,n=null){if(!e)throw new le("need to specify a reason the DateTime is invalid");const a=e instanceof Te?e:new Te(e,n);if(Y.throwOnInvalid)throw new oi(a);return new F({invalid:a})}static isDateTime(e){return e&&e.isLuxonDateTime||!1}static parseFormatForOpts(e,n={}){const a=Mo(e,j.fromObject(n));return a?a.map(r=>r?r.val:null).join(""):null}static expandFormat(e,n={}){return wo(ce.parseFormat(e),j.fromObject(n)).map(r=>r.val).join("")}static resetCache(){At=void 0,Qn.clear()}get(e){return this[e]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?Nn(this).weekYear:NaN}get weekNumber(){return this.isValid?Nn(this).weekNumber:NaN}get weekday(){return this.isValid?Nn(this).weekday:NaN}get isWeekend(){return this.isValid&&this.loc.getWeekendDays().includes(this.weekday)}get localWeekday(){return this.isValid?Pn(this).weekday:NaN}get localWeekNumber(){return this.isValid?Pn(this).weekNumber:NaN}get localWeekYear(){return this.isValid?Pn(this).weekYear:NaN}get ordinal(){return this.isValid?An(this.c).ordinal:NaN}get monthShort(){return this.isValid?Zt.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?Zt.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?Zt.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?Zt.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset}getPossibleOffsets(){if(!this.isValid||this.isOffsetFixed)return[this];const e=864e5,n=6e4,a=hn(this.c),r=this.zone.offset(a-e),o=this.zone.offset(a+e),s=this.zone.offset(a-r*n),l=this.zone.offset(a-o*n);if(s===l)return[this];const c=a-s*n,u=a-l*n,d=Jt(c,s),m=Jt(u,l);return d.hour===m.hour&&d.minute===m.minute&&d.second===m.second&&d.millisecond===m.millisecond?[Qe(this,{ts:c}),Qe(this,{ts:u})]:[this]}get isInLeapYear(){return Wt(this.year)}get daysInMonth(){return on(this.year,this.month)}get daysInYear(){return this.isValid?gt(this.year):NaN}get weeksInWeekYear(){return this.isValid?xt(this.weekYear):NaN}get weeksInLocalWeekYear(){return this.isValid?xt(this.localWeekYear,this.loc.getMinDaysInFirstWeek(),this.loc.getStartOfWeek()):NaN}resolvedLocaleOptions(e={}){const{locale:n,numberingSystem:a,calendar:r}=ce.create(this.loc.clone(e),e).resolvedOptions(this);return{locale:n,numberingSystem:a,outputCalendar:r}}toUTC(e=0,n={}){return this.setZone(de.instance(e),n)}toLocal(){return this.setZone(Y.defaultZone)}setZone(e,{keepLocalTime:n=!1,keepCalendarTime:a=!1}={}){if(e=Ge(e,Y.defaultZone),e.equals(this.zone))return this;if(e.isValid){let r=this.ts;if(n||a){const o=e.offset(this.ts),s=this.toObject();[r]=en(s,o,e)}return Qe(this,{ts:r,zone:e})}else return F.invalid(Tt(e))}reconfigure({locale:e,numberingSystem:n,outputCalendar:a}={}){const r=this.loc.clone({locale:e,numberingSystem:n,outputCalendar:a});return Qe(this,{loc:r})}setLocale(e){return this.reconfigure({locale:e})}set(e){if(!this.isValid)return this;const n=sn(e,ar),{minDaysInFirstWeek:a,startOfWeek:r}=Ga(n,this.loc),o=!H(n.weekYear)||!H(n.weekNumber)||!H(n.weekday),s=!H(n.ordinal),l=!H(n.year),c=!H(n.month)||!H(n.day),u=l||c,d=n.weekYear||n.weekNumber;if((u||s)&&d)throw new ht("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(c&&s)throw new ht("Can't mix ordinal dates with month/day");let m;o?m=Ba({...rn(this.c,a,r),...n},a,r):H(n.ordinal)?(m={...this.toObject(),...n},H(n.day)&&(m.day=Math.min(on(m.year,m.month),m.day))):m=za({...An(this.c),...n});const[p,h]=en(m,this.o,this.zone);return Qe(this,{ts:p,o:h})}plus(e){if(!this.isValid)return this;const n=G.fromDurationLike(e);return Qe(this,tr(this,n))}minus(e){if(!this.isValid)return this;const n=G.fromDurationLike(e).negate();return Qe(this,tr(this,n))}startOf(e,{useLocaleWeeks:n=!1}={}){if(!this.isValid)return this;const a={},r=G.normalizeUnit(e);switch(r){case"years":a.month=1;case"quarters":case"months":a.day=1;case"weeks":case"days":a.hour=0;case"hours":a.minute=0;case"minutes":a.second=0;case"seconds":a.millisecond=0;break}if(r==="weeks")if(n){const o=this.loc.getStartOfWeek(),{weekday:s}=this;s<o&&(a.weekNumber=this.weekNumber-1),a.weekday=o}else a.weekday=1;if(r==="quarters"){const o=Math.ceil(this.month/3);a.month=(o-1)*3+1}return this.set(a)}endOf(e,n){return this.isValid?this.plus({[e]:1}).startOf(e,n).minus(1):this}toFormat(e,n={}){return this.isValid?ce.create(this.loc.redefaultToEN(n)).formatDateTimeFromString(this,e):In}toLocaleString(e=an,n={}){return this.isValid?ce.create(this.loc.clone(n),e).formatDateTime(this):In}toLocaleParts(e={}){return this.isValid?ce.create(this.loc.clone(e),e).formatDateTimeParts(this):[]}toISO({format:e="extended",suppressSeconds:n=!1,suppressMilliseconds:a=!1,includeOffset:r=!0,extendedZone:o=!1}={}){if(!this.isValid)return null;const s=e==="extended";let l=Dn(this,s);return l+="T",l+=nr(this,s,n,a,r,o),l}toISODate({format:e="extended"}={}){return this.isValid?Dn(this,e==="extended"):null}toISOWeekDate(){return qt(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:e=!1,suppressSeconds:n=!1,includeOffset:a=!0,includePrefix:r=!1,extendedZone:o=!1,format:s="extended"}={}){return this.isValid?(r?"T":"")+nr(this,s==="extended",n,e,a,o):null}toRFC2822(){return qt(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return qt(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?Dn(this,!0):null}toSQLTime({includeOffset:e=!0,includeZone:n=!1,includeOffsetSpace:a=!0}={}){let r="HH:mm:ss.SSS";return(n||e)&&(a&&(r+=" "),n?r+="z":e&&(r+="ZZ")),qt(this,r,!0)}toSQL(e={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(e)}`:null}toString(){return this.isValid?this.toISO():In}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`DateTime { ts: ${this.toISO()}, zone: ${this.zone.name}, locale: ${this.locale} }`:`DateTime { Invalid, reason: ${this.invalidReason} }`}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(e={}){if(!this.isValid)return{};const n={...this.c};return e.includeConfig&&(n.outputCalendar=this.outputCalendar,n.numberingSystem=this.loc.numberingSystem,n.locale=this.loc.locale),n}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(e,n="milliseconds",a={}){if(!this.isValid||!e.isValid)return G.invalid("created by diffing an invalid DateTime");const r={locale:this.locale,numberingSystem:this.numberingSystem,...a},o=xi(n).map(G.normalizeUnit),s=e.valueOf()>this.valueOf(),l=s?this:e,c=s?e:this,u=Ws(l,c,o,r);return s?u.negate():u}diffNow(e="milliseconds",n={}){return this.diff(F.now(),e,n)}until(e){return this.isValid?K.fromDateTimes(this,e):this}hasSame(e,n,a){if(!this.isValid)return!1;const r=e.valueOf(),o=this.setZone(e.zone,{keepLocalTime:!0});return o.startOf(n,a)<=r&&r<=o.endOf(n,a)}equals(e){return this.isValid&&e.isValid&&this.valueOf()===e.valueOf()&&this.zone.equals(e.zone)&&this.loc.equals(e.loc)}toRelative(e={}){if(!this.isValid)return null;const n=e.base||F.fromObject({},{zone:this.zone}),a=e.padding?this<n?-e.padding:e.padding:0;let r=["years","months","days","hours","minutes","seconds"],o=e.unit;return Array.isArray(e.unit)&&(r=e.unit,o=void 0),or(n,this.plus(a),{...e,numeric:"always",units:r,unit:o})}toRelativeCalendar(e={}){return this.isValid?or(e.base||F.fromObject({},{zone:this.zone}),this,{...e,numeric:"auto",units:["years","months","days"],calendary:!0}):null}static min(...e){if(!e.every(F.isDateTime))throw new le("min requires all arguments be DateTimes");return Va(e,n=>n.valueOf(),Math.min)}static max(...e){if(!e.every(F.isDateTime))throw new le("max requires all arguments be DateTimes");return Va(e,n=>n.valueOf(),Math.max)}static fromFormatExplain(e,n,a={}){const{locale:r=null,numberingSystem:o=null}=a,s=j.fromOpts({locale:r,numberingSystem:o,defaultToEN:!0});return Lo(s,e,n)}static fromStringExplain(e,n,a={}){return F.fromFormatExplain(e,n,a)}static buildFormatParser(e,n={}){const{locale:a=null,numberingSystem:r=null}=n,o=j.fromOpts({locale:a,numberingSystem:r,defaultToEN:!0});return new vo(o,e)}static fromFormatParser(e,n,a={}){if(H(e)||H(n))throw new le("fromFormatParser requires an input string and a format parser");const{locale:r=null,numberingSystem:o=null}=a,s=j.fromOpts({locale:r,numberingSystem:o,defaultToEN:!0});if(!s.equals(n.locale))throw new le(`fromFormatParser called with a locale of ${s}, but the format parser was created for ${n.locale}`);const{result:l,zone:c,specificOffset:u,invalidReason:d}=n.explainFromTokens(e);return d?F.invalid(d):ut(l,c,a,`format ${n.format}`,e,u)}static get DATE_SHORT(){return an}static get DATE_MED(){return br}static get DATE_MED_WITH_WEEKDAY(){return li}static get DATE_FULL(){return Er}static get DATE_HUGE(){return _r}static get TIME_SIMPLE(){return kr}static get TIME_WITH_SECONDS(){return Tr}static get TIME_WITH_SHORT_OFFSET(){return Ar}static get TIME_WITH_LONG_OFFSET(){return Cr}static get TIME_24_SIMPLE(){return Ir}static get TIME_24_WITH_SECONDS(){return Nr}static get TIME_24_WITH_SHORT_OFFSET(){return Pr}static get TIME_24_WITH_LONG_OFFSET(){return Dr}static get DATETIME_SHORT(){return Fr}static get DATETIME_SHORT_WITH_SECONDS(){return xr}static get DATETIME_MED(){return $r}static get DATETIME_MED_WITH_SECONDS(){return Or}static get DATETIME_MED_WITH_WEEKDAY(){return ci}static get DATETIME_FULL(){return Rr}static get DATETIME_FULL_WITH_SECONDS(){return Wr}static get DATETIME_HUGE(){return Ur}static get DATETIME_HUGE_WITH_SECONDS(){return Hr}}function _t(t){if(F.isDateTime(t))return t;if(t&&t.valueOf&&Je(t.valueOf()))return F.fromJSDate(t);if(t&&typeof t=="object")return F.fromObject(t);throw new le(`Unknown datetime argument: ${t}, of type ${typeof t}`)}const ft=65,me=73,ve=79;function _o(t,e){if(e=typeof e=="number"?e:5,!Array.isArray(t))throw new TypeError("forward did not receive an array");if(typeof t[0]=="string"||typeof t[1]=="string")throw new TypeError("forward received an array of strings, but it only accepts an array of numbers.");const[n,a]=t;if(n<-180||n>180)throw new TypeError("forward received an invalid longitude of "+n);if(a<-90||a>90)throw new TypeError("forward received an invalid latitude of "+a);if(a<-80||a>84)throw new TypeError(`forward received a latitude of ${a}, but this library does not support conversions of points in polar regions below 80°S and above 84°N`);return function(r,o){const s="00000"+r.easting,l="00000"+r.northing;return r.zoneNumber+r.zoneLetter+function(c,u,d){const m=To(d),p=Math.floor(c/1e5),h=Math.floor(u/1e5)%20;return function(v,S,w){const M=w-1,y="AJSAJS".charCodeAt(M),_="AFAFAF".charCodeAt(M);let b=y+v-1,E=_+S,k=!1;return b>90&&(b=b-90+ft-1,k=!0),(b===me||y<me&&b>me||(b>me||y<me)&&k)&&b++,(b===ve||y<ve&&b>ve||(b>ve||y<ve)&&k)&&(b++,b===me&&b++),b>90&&(b=b-90+ft-1),E>86?(E=E-86+ft-1,k=!0):k=!1,(E===me||_<me&&E>me||(E>me||_<me)&&k)&&E++,(E===ve||_<ve&&E>ve||(E>ve||_<ve)&&k)&&(E++,E===me&&E++),E>86&&(E=E-86+ft-1),String.fromCharCode(b)+String.fromCharCode(E)}(p,h,m)}(r.easting,r.northing,r.zoneNumber)+s.substr(s.length-5,o)+l.substr(l.length-5,o)}(function(r){const o=r.lat,s=r.lon,l=6378137,c=Fn(o),u=Fn(s);let d;d=Math.floor((s+180)/6)+1,s===180&&(d=60),o>=56&&o<64&&s>=3&&s<12&&(d=32),o>=72&&o<84&&(s>=0&&s<9?d=31:s>=9&&s<21?d=33:s>=21&&s<33?d=35:s>=33&&s<42&&(d=37));const m=Fn(6*(d-1)-180+3),p=l/Math.sqrt(1-.00669438*Math.sin(c)*Math.sin(c)),h=Math.tan(c)*Math.tan(c),v=.006739496752268451*Math.cos(c)*Math.cos(c),S=Math.cos(c)*(u-m),w=l*(.9983242984503243*c-.002514607064228144*Math.sin(2*c)+2639046602129982e-21*Math.sin(4*c)-3418046101696858e-24*Math.sin(6*c)),M=.9996*p*(S+(1-h+v)*S*S*S/6+(5-18*h+h*h+72*v-.39089081163157013)*S*S*S*S*S/120)+5e5;let y=.9996*(w+p*Math.tan(c)*(S*S/2+(5-h+9*v+4*v*v)*S*S*S*S/24+(61-58*h+h*h+600*v-2.2240339282485886)*S*S*S*S*S*S/720));return o<0&&(y+=1e7),{northing:Math.trunc(y),easting:Math.trunc(M),zoneNumber:d,zoneLetter:ko(o)}}({lat:a,lon:n}),e)}function ol(t){const e=ya(Ao(t.toUpperCase()));return typeof e.lat=="number"&&typeof e.lon=="number"?[e.lon,e.lat,e.lon,e.lat]:[e.left,e.bottom,e.right,e.top]}function pa(t){if(t==="")throw new TypeError("toPoint received a blank string");const e=ya(Ao(t.toUpperCase()));return typeof e.lat=="number"&&typeof e.lon=="number"?[e.lon,e.lat]:[(e.left+e.right)/2,(e.top+e.bottom)/2]}function Fn(t){return t*(Math.PI/180)}function sr(t){return t/Math.PI*180}function ya(t){const e=t.northing,n=t.easting,{zoneLetter:a,zoneNumber:r}=t;if(r<0||r>60)return null;const o=6378137,s=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),l=n-5e5;let c=e;a<"N"&&(c-=1e7);const u=6*(r-1)-180+3,d=c/.9996/6367449145945056e-9,m=d+(3*s/2-27*s*s*s/32)*Math.sin(2*d)+(21*s*s/16-55*s*s*s*s/32)*Math.sin(4*d)+151*s*s*s/96*Math.sin(6*d),p=o/Math.sqrt(1-.00669438*Math.sin(m)*Math.sin(m)),h=Math.tan(m)*Math.tan(m),v=.006739496752268451*Math.cos(m)*Math.cos(m),S=.99330562*o/Math.pow(1-.00669438*Math.sin(m)*Math.sin(m),1.5),w=l/(.9996*p);let M=m-p*Math.tan(m)/S*(w*w/2-(5+3*h+10*v-4*v*v-.06065547077041606)*w*w*w*w/24+(61+90*h+298*v+45*h*h-1.6983531815716497-3*v*v)*w*w*w*w*w*w/720);M=sr(M);let y,_=(w-(1+2*h+v)*w*w*w/6+(5-2*v+28*h-3*v*v+.05391597401814761+24*h*h)*w*w*w*w*w/120)/Math.cos(m);if(_=u+sr(_),typeof t.accuracy=="number"){const b=ya({northing:t.northing+t.accuracy,easting:t.easting+t.accuracy,zoneLetter:t.zoneLetter,zoneNumber:t.zoneNumber});y={top:b.lat,right:b.lon,bottom:M,left:_}}else y={lat:M,lon:_};return y}function ko(t){return t<=84&&t>=72?"X":t<72&&t>=-80?"CDEFGHJKLMNPQRSTUVWX"[Math.floor((t- -80)/8)]:t>84||t<-80?"Z":void 0}function To(t){let e=t%6;return e===0&&(e=6),e}function Ao(t){if(t&&t.length===0)throw new TypeError("MGRSPoint coverting from nothing");t=t.replace(/ /g,"");const{length:e}=t;let n,a=null,r="",o=0;for(;!/[A-Z]/.test(n=t.charAt(o));){if(o>=2)throw new Error("MGRSPoint bad conversion from: "+t);r+=n,o++}const s=parseInt(r,10);if(o===0||o+3>e)throw new Error("MGRSPoint bad conversion from "+t);const l=t.charAt(o++);if(l<="A"||l==="B"||l==="Y"||l>="Z"||l==="I"||l==="O")throw new Error(`MGRSPoint zone letter ${l} not handled: ${t}`);a=t.substring(o,o+=2);const c=To(s),u=function(y,_){let b="AJSAJS".charCodeAt(_-1),E=1e5,k=!1;for(;b!==y.charCodeAt(0);){if(b++,b===me&&b++,b===ve&&b++,b>90){if(k)throw new Error("Bad character: "+y);b=ft,k=!0}E+=1e5}return E}(a.charAt(0),c);let d=function(y,_){if(y>"V")throw new TypeError("MGRSPoint given invalid Northing "+y);let b="AFAFAF".charCodeAt(_-1),E=0,k=!1;for(;b!==y.charCodeAt(0);){if(b++,b===me&&b++,b===ve&&b++,b>86){if(k)throw new Error("Bad character: "+y);b=ft,k=!0}E+=1e5}return E}(a.charAt(1),c);for(;d<il(l);)d+=2e6;const m=e-o;if(m%2!=0)throw new Error(`MGRSPoint has to have an even number
of digits after the zone letter and two 100km letters - front
half for easting meters, second half for
northing meters `+t);const p=m/2;let h,v,S,w=0,M=0;return p>0&&(h=1e5/Math.pow(10,p),v=t.substring(o,o+p),w=parseFloat(v)*h,S=t.substring(o+p),M=parseFloat(S)*h),{easting:w+u,northing:M+d,zoneLetter:l,zoneNumber:s,accuracy:h}}function il(t){let e;switch(t){case"C":e=11e5;break;case"D":e=2e6;break;case"E":e=28e5;break;case"F":e=37e5;break;case"G":e=46e5;break;case"H":e=55e5;break;case"J":e=64e5;break;case"K":e=73e5;break;case"L":e=82e5;break;case"M":e=91e5;break;case"N":e=0;break;case"P":e=8e5;break;case"Q":e=17e5;break;case"R":e=26e5;break;case"S":e=35e5;break;case"T":e=44e5;break;case"U":e=53e5;break;case"V":e=62e5;break;case"W":e=7e6;break;case"X":e=79e5;break;default:e=-1}if(e>=0)return e;throw new TypeError("Invalid zone letter: "+t)}const sl=Object.freeze(Object.defineProperty({__proto__:null,forward:_o,getLetterDesignator:ko,inverse:ol,toPoint:pa},Symbol.toStringTag,{value:"Module"})),ll="/upper_winds_open_meteo/icon-48.png",cl="/upper_winds_open_meteo/schere_purple.png",ul="/upper_winds_open_meteo/airplane_orange.png",dl="/upper_winds_open_meteo/livePlane.png",lr={135:5,130:5,125:5,120:5,115:5,110:5,105:5,100:6,95:7,90:7,85:7,80:8,75:8,70:9,65:10,60:10,55:11,50:12,45:14,40:15,35:17,30:20,25:24,20:30,15:40,10:60,5:119},ml={TERMINAL_VELOCITY_VERTICAL_MPS:50,GRAVITY_ACCELERATION:9.81,HORIZONTAL_DRAG_TAU_SECONDS:5},Fe=200,xn={OPEN:4.1,PARTIALLY:12.8,COLLAPSED:39.2},hl=150,dt={MIN_TRACK_LENGTH_M:100,MAX_TRACK_LENGTH_M:1e4,MIN_APPROACH_LENGTH_M:100,MAX_APPROACH_LENGTH_M:2e4,APPROACH_TIME_SECONDS:120},Co={LIST:["icon_seamless","icon_global","icon_eu","icon_d2","ecmwf_ifs025","ecmwf_aifs025_single","gfs_seamless","gfs_global","gfs_hrrr","arome_france","gem_hrdps_continental","gem_regional"],API_MAP:{icon_seamless:"dwd_icon",icon_global:"dwd_icon",icon_eu:"dwd_icon_eu",icon_d2:"dwd_icon_d2",ecmwf_ifs025:"ecmwf_ifs025",ecmwf_aifs025_single:"ecmwf_aifs025_single",gfs_seamless:"ncep_gfs013",gfs_global:"ncep_gfs025",gfs_hrrr:"ncep_hrrr_conus",arome_france:"meteofrance_arome_france0025",gem_hrdps_continental:"cmc_gem_hrdps",gem_regional:"cmc_gem_rdps"}},$t={FORECAST:"https://api.open-meteo.com/v1/forecast",HISTORICAL:"https://historical-forecast-api.open-meteo.com/v1/forecast"},re={METERS_TO_FEET:3.28084,FEET_TO_METERS:.3048,KNOTS_TO_MPS:.514444,KNOTS_TO_KMH:1.852,CELSIUS_TO_KELVIN:273.15},cr={MOLAR_MASS_AIR:.0289644,UNIVERSAL_GAS_CONSTANT:8.31446261815324},mt={LAPSE_RATE:.0065,SEA_LEVEL_TEMP_KELVIN:288.15,GRAVITY:9.80665,GAS_CONSTANT_AIR:287.05},Kt={A_LIQUID:17.27,B_LIQUID:237.7,A_ICE:21.87,B_ICE:265.5},fl=6371e3,ur={KNOT_THRESHOLDS:[1,4,7,11,17,22,28,34,41,48,56,64],BEAUFORT_THRESHOLDS:[0,1,3,6,10,16,21,27,33,40,47,55,63]},gl=[1e3,950,925,900,850,800,700,600,500,400,300,250,200],ke={DEFAULT_MAP_CENTER:[47.9808,11.234],DEFAULT_MAP_ZOOM:11,GEOLOCATION_TIMEOUT_MS:2e4,GEOLOCATION_ACCURACY_THRESHOLD_M:500,MIN_ZOOM:11,MAX_ZOOM:14,LANDING_PATTERN_MIN_ZOOM:14},Yt={MIN_TIME_DIFF_FOR_SPEED_CALC_S:.5,SPEED_SMOOTHING_LOW:.5,SPEED_SMOOTHING_HIGH:.2,SPEED_SMOOTHING_TRESHOLD:25},pn={TILE_MAX_AGE_DAYS:7,FETCH_TIMEOUT_MS:15e3,SIZE_LIMIT_MB_WARNING:500},Ve={SCENARIO_COLORS:{MIN_WIND:"rgba(0, 0, 255, 0.7)",MEAN_WIND:"rgba(0, 255, 0, 0.7)",MAX_WIND:"rgba(255, 0, 0, 0.7)"},HEATMAP_MIN_RADIUS_PX:5,HEATMAP_MAX_RADIUS_PX:50,HEATMAP_SCALING_BASE:1.42,HEATMAP_REFERENCE_ZOOM:13},yn={DEFAULT_MARKER:ll,CUTAWAY_MARKER:cl,AIRPLANE_MARKER:ul,LIVEPLANE_MARKER:dl},pl="DZMasterTest",yl="DataTest";let dr=!1;const Ce=()=>{const t=document.getElementById("interpStep");return t?t.value:"200"};function wl(t){dr=t,console.log(`App context set to: ${dr?"Mobile":"Web"}`)}const g={FEATURE_PASSWORD_PLANNER:pl,FEATURE_PASSWORD_DATA:yl,defaultSettings:{model:"icon_global",refLevel:"AGL",heightUnit:"m",temperatureUnit:"C",windUnit:"kt",timeZone:"Z",coordFormat:"Decimal",downloadFormat:"HEIDIS",showTable:!1,canopySpeed:20,descentRate:3.5,showLandingPattern:!1,landingDirection:"LL",customLandingDirectionLL:"",customLandingDirectionRR:"",legHeightDownwind:300,legHeightBase:200,legHeightFinal:100,interpStep:"200",lowerLimit:0,upperLimit:3e3,baseMaps:"Esri Street",calculateJump:!0,openingAltitude:1200,exitAltitude:3e3,showJumpRunTrack:!1,showExitArea:!1,showCanopyArea:!1,showCutAwayFinder:!1,jumpRunTrackOffset:0,jumpRunTrackForwardOffset:0,aircraftSpeedKt:90,jumperSeparation:5,numberOfJumpers:5,cutAwayAltitude:1e3,cutAwayState:"Partially",terrainWarningLayer:null,terrainAnalysisCache:null,terrainClearance:100,trackPosition:!1,showJumpMasterLine:!1,jumpMasterLineTarget:"DIP",harpLat:null,harpLng:null,cacheRadiusKm:10,cacheZoomLevels:[11,12,13,14],autoupdate:!1,selectedEnsembleModels:[],currentEnsembleScenario:"all_models",isInteractionLocked:!1},state:{userSettings:null,unlockedFeatures:{planner:!1,plannerHash:null,data:!1,dataHash:null}},initialize(){const t=this.FEATURE_PASSWORD_PLANNER.split("").reduce((s,l)=>l.charCodeAt(0)+((s<<5)-s),0),e=this.FEATURE_PASSWORD_DATA.split("").reduce((s,l)=>l.charCodeAt(0)+((s<<5)-s),0);let n={planner:!1,plannerHash:null,data:!1,dataHash:null};try{const s=localStorage.getItem("unlockedFeatures");s&&(n={...n,...JSON.parse(s)})}catch(s){this.handleError(s,"Failed to load unlocked features.")}const a=n.planner&&n.plannerHash===t,r=n.data&&n.dataHash===e;this.state.unlockedFeatures={planner:a,plannerHash:a?t:null,data:r,dataHash:r?e:null},this.saveUnlockedFeatures();let o={};try{const s=localStorage.getItem("upperWindsSettings");s&&(o=JSON.parse(s))}catch(s){this.handleError(s,"Failed to load settings.")}this.state.userSettings={...this.defaultSettings,...o},this.state.userSettings.isInteractionLocked=!1,this.state.userSettings.harpLat=null,this.state.userSettings.harpLng=null,this.state.userSettings.jumpRunTrackOffset=0,this.state.userSettings.jumpRunTrackForwardOffset=0,this.state.userSettings.showCutAwayFinder=!1},save(){const t={...this.state.userSettings};delete t.customJumpRunDirection;try{localStorage.setItem("upperWindsSettings",JSON.stringify(t))}catch(e){console.error("Failed to save settings to localStorage:",e)}},isFeatureUnlocked(t){return!0},showPasswordModal(t,e,n){const a=document.getElementById("passwordModal"),r=document.getElementById("passwordInput"),o=document.getElementById("passwordError"),s=document.getElementById("passwordSubmit"),l=document.getElementById("passwordCancel"),c=document.getElementById("modalHeader"),u=document.getElementById("modalMessage");if(!a||!r||!s||!l||!c||!u)return;const d=t==="planner"?this.FEATURE_PASSWORD_PLANNER:this.FEATURE_PASSWORD_DATA,m=t.charAt(0).toUpperCase()+t.slice(1);c.textContent=`${m} Access`,u.textContent=`Please enter the password to enable the ${m.toLowerCase()} functionality:`,r.value="",o.style.display="none",a.style.display="flex";const p=()=>{r.value===d?(a.style.display="none",this.saveUnlockStatus(t,!0),document.dispatchEvent(new CustomEvent("ui:lockStateChanged")),e()):(o.textContent="Incorrect password",o.style.display="block")};s.onclick=p,r.onkeypress=h=>{h.key==="Enter"&&p()},l.onclick=()=>{a.style.display="none",n()}},saveUnlockStatus(t,e){if(t==="planner"){const n=this.FEATURE_PASSWORD_PLANNER.split("").reduce((a,r)=>r.charCodeAt(0)+((a<<5)-a),0);this.state.unlockedFeatures.planner=e,this.state.unlockedFeatures.plannerHash=e?n:null}else if(t==="data"){const n=this.FEATURE_PASSWORD_DATA.split("").reduce((a,r)=>r.charCodeAt(0)+((a<<5)-a),0);this.state.unlockedFeatures.data=e,this.state.unlockedFeatures.dataHash=e?n:null}this.saveUnlockedFeatures()},saveUnlockedFeatures(t=this.state.unlockedFeatures){try{const e=JSON.stringify(t);localStorage.setItem("unlockedFeatures",e)}catch(e){this.handleError(e,"Failed to save unlocked features to localStorage.")}},getValue(t,e,n){if(n===void 0&&typeof e!="string"&&(n=e,e=null),this.state.userSettings&&typeof this.state.userSettings[t]<"u")return this.state.userSettings[t];const a=document.querySelector(`input[name="${t}"]:checked`);if(a)return a.value;const r=document.getElementById(t);if(r&&r.tagName==="SELECT")return r.value;const o=document.getElementById(t);return o&&o.type==="checkbox"?o.checked:n},handleError(t,e="An error occurred."){console.error("Settings Error:",t)}};let $n=console.error,On=console.log;const U=class U{static setErrorHandler(e){$n=e}static setMessageHandler(e){On=e}static handleError(e,n=!0){n&&console.error(e),typeof $n=="function"&&$n(e)}static handleMessage(e){typeof On=="function"?On(e):console.log(e)}static convertHeight(e,n){const a=parseFloat(e);return isNaN(a)?"N/A":n==="ft"?parseFloat((e*re.METERS_TO_FEET).toFixed(0)):e}static convertFeetToMeters(e){return e==null||isNaN(e)?0:e/3.28084}static convertTemperature(e,n){const a=parseFloat(e);return isNaN(a)?"N/A":n==="°F"?a*9/5+32:a}static convertWind(e,n,a="km/h"){if(e==null||isNaN(e))return"N/A";let r;switch(a){case"km/h":r=e;break;case"m/s":r=e*3.6;break;case"kt":r=e*re.KNOTS_TO_KMH;break;case"mph":r=e*1.60934;break;case"bft":r=U.beaufortToKnots(e)*re.KNOTS_TO_KMH;break;default:r=e;break}switch(n){case"km/h":return r;case"m/s":return r/3.6;case"kt":return r/re.KNOTS_TO_KMH;case"mph":return r/1.60934;case"bft":return U.knotsToBeaufort(r/re.KNOTS_TO_KMH);default:return r/re.KNOTS_TO_KMH}}static knotsToBeaufort(e){const n=ur.KNOT_THRESHOLDS.findIndex(a=>e<a);return n===-1?12:n}static beaufortToKnots(e){return ur.BEAUFORT_THRESHOLDS[e]||63}static normalizeAngle(e){return(e%360+360)%360}static calculateDewpoint(e,n){const a=Kt.A_LIQUID,r=Kt.B_LIQUID,o=Kt.A_ICE,s=Kt.B_ICE;let l,c;return e>=0?(l=a*e/(r+e)+Math.log(n/100),c=r*l/(a-l)):(l=o*e/(s+e)+Math.log(n/100),c=s*l/(o-l)),isNaN(c)?null:c}static calculateQFE(e,n,a,r=15){if(!e||n==="N/A"||a==="N/A"||isNaN(e)||isNaN(n)||isNaN(a))return"N/A";const o=mt.GRAVITY,s=cr.MOLAR_MASS_AIR,l=cr.UNIVERSAL_GAS_CONSTANT,c=r+re.CELSIUS_TO_KELVIN,u=mt.LAPSE_RATE,d=e*100,m=n-a,p=o*s/(l*u),h=d*Math.pow(1-u*m/c,p),v=Math.round(h/100);return isNaN(v)?"N/A":v}static linearInterpolate(e,n,a){if(!(e!=null&&e.length)||!(n!=null&&n.length)||e.length!==n.length)return"invalid input for linearInterpolate";let r=!1;e[1]>e[0]&&(n=[...n].reverse(),e=[...e].reverse(),r=!0);const o=e.length-1;try{if(a>e[0]||a<e[o]){let s,l;return a>e[0]?(s=(n[1]-n[0])/(e[1]-e[0]),l=n[1]-s*e[1]):(s=(n[o]-n[o-1])/(e[o]-e[o-1]),l=n[o]-s*e[o]),s*a+l}else{let s;for(s=1;s<=o&&!(a>=e[s]);s++);const l=(n[s]-n[s-1])/(e[s]-e[s-1]),c=n[s]-l*e[s];return l*a+c}}catch{return"interpolation error"}finally{r&&(n.reverse(),e.reverse())}}static linearInterpolateAngle(e,n,a){if(!(e!=null&&e.length)||!(n!=null&&n.length)||e.length!==n.length)return NaN;let r=!1;e[0]<e[e.length-1]&&(e=[...e].reverse(),n=[...n].reverse(),r=!0);const o=e.length;let s=0;for(;s<o&&e[s]>a;)s++;s===0?s=1:s===o&&(s=o-1);const l=e[s-1],c=e[s];let u=n[s-1],m=n[s]-u;if(m>180&&(m-=360),m<-180&&(m+=360),c-l===0)return u;const p=(a-l)/(c-l);let h=u+p*m;return h=(h+360)%360,r&&(e.reverse(),n.reverse()),h}static gaussianInterpolation(e,n,a,r,o){if(a===o)return e;if(r===o)return n;let s=1/Math.abs(a-o),l=1/Math.abs(r-o);return(s*e+l*n)/(s+l)}static interpolateWindAtAltitude(e,n,a,r,o){if(n.length!=a.length||n.length!=r.length||n.length!=o.length)return{u:"Invalid input",v:"Invalid input"};const s=n.map(m=>Math.log(m)),l=U.linearInterpolate(a,s,e);if(typeof l=="string"&&l.includes("error"))return{u:"Interpolation error",v:"Interpolation error"};const c=Math.exp(l),u=U.linearInterpolate(s,r,Math.log(c)),d=U.linearInterpolate(s,o,Math.log(c));return typeof u=="string"&&u.includes("error")||typeof d=="string"&&d.includes("error")?{u:"Interpolation error",v:"Interpolation error"}:{u,v:d}}static interpolatePressure(e,n,a){if(!n||!a||n.length!==a.length||n.length<2||e<a[0]||e>a[a.length-1])return"N/A";for(let r=0;r<a.length-1;r++)if(e>=a[r]&&e<=a[r+1]){const o=a[r],s=a[r+1],l=n[r],c=n[r+1];return l+(c-l)*(e-o)/(s-o)}return"N/A"}static windSpeed(e,n){return Math.sqrt(e*e+n*n)}static windDirection(e,n){return(Math.atan2(-e,-n)*180/Math.PI+360)%360}static calculateMeanWind(e,n,a,r,o){try{if(!e||!n||!a||e.length<2||r>=o)throw new Error("Invalid input data or limits for calculateMeanWind");const s=new Array(4);let l=[o],c=[Number(U.linearInterpolate(e,n,o))],u=[Number(U.linearInterpolate(e,a,o))];const d=Number(U.linearInterpolate(e,n,r)),m=Number(U.linearInterpolate(e,a,r));for(let y=0;y<e.length;y++)e[y]<o&&e[y]>r&&(l.push(e[y]),c.push(n[y]),u.push(a[y]));l.push(r),c.push(d),u.push(m);const p=l.map((y,_)=>_);p.sort((y,_)=>l[_]-l[y]),l=p.map(y=>l[y]),c=p.map(y=>c[y]),u=p.map(y=>u[y]);let h=0,v=0;for(let y=0;y<l.length-1;y++)h+=.5*(c[y]+c[y+1])*(l[y]-l[y+1]),v+=.5*(u[y]+u[y+1])*(l[y]-l[y+1]);const S=l[0]-l[l.length-1];if(S===0)return s[2]=d,s[3]=m,s[1]=U.windSpeed(d,m),s[0]=U.windDirection(d,m),s;const w=h/S,M=v/S;return s[2]=w,s[3]=M,s[1]=U.windSpeed(w,M),s[0]=U.windDirection(w,M),s}catch(s){return console.error("Error in calculateMeanWind:",s,{heights:e,xComponents:n,yComponents:a,lowerLimit:r,upperLimit:o}),U.handleError("Failed to calculate mean wind: "+s.message),null}}static translateWmoCodeToTaf(e){const n={0:"NSW",1:"NSW",2:"NSW",3:"NSW",45:"FG",48:"FZFG",51:"-DZ",53:"DZ",55:"+DZ",56:"-FZDZ",57:"FZDZ",61:"-RA",63:"RA",65:"+RA",66:"-FZRA",67:"FZRA",71:"-SN",73:"SN",75:"+SN",77:"SG",80:"-SHRA",81:"SHRA",82:"+SHRA",83:"-SHRASN",85:"-SHSN",86:"SHSN",95:"TS",96:"TSGR",99:"+TSGR"},a=parseInt(e,10);return isNaN(a)?"N/A":n[a]||"N/A"}static getCloudLayersForMetar(e,n){if(!e||e.length===0)return"N/A";const a=[];let r=null;const o=l=>l<=5?null:l<=25?"FEW":l<=50?"SCT":l<=87?"BKN":"OVC",s={FEW:1,SCT:2,BKN:3,OVC:4};for(const l of e){const c=o(l.cc);if(!c||a.length>=3)continue;(!r||s[c]>s[r])&&(a.push({baseHeight:l.displayHeight,coverCode:c}),r=c)}return a.length===0?"SKC":a.map(l=>{const c=l.baseHeight;let u;return n==="ft"?(u=Math.round(c/100)*100,`${l.coverCode} ${u}ft`):(u=Math.round(c/50)*50,`${l.coverCode} ${u}m`)}).join(", ")}static formatVisibility(e){const n=parseFloat(e);return isNaN(n)?"N/A":n>=1e4?">10000":n>=5e3?(Math.round(n/1e3)*1e3).toString():(Math.round(n/100)*100).toString()}static formatWindDirection(e){const n=parseFloat(e);if(isNaN(n))return"N/A";let a=Math.round(n/10)*10;return(a===0||a>=360)&&(a=360),a.toString().padStart(3,"0")}static calculateTAS(e,n){if(isNaN(e)||isNaN(n)||e<0||n<0)return console.warn("Invalid inputs for calculateTAS:",{ias:e,heightFt:n}),"N/A";const a=mt.LAPSE_RATE,r=mt.SEA_LEVEL_TEMP_KELVIN,o=mt.GRAVITY,s=mt.GAS_CONSTANT_AIR,l=re.FEET_TO_METERS,c=n*l,u=r-a*c,d=u/r,m=1-a*c/r,p=o/(a*s)-1,h=Math.pow(m,p),v=e/Math.sqrt(h);return console.log("calculateTAS debug:",{ias:e,heightFt:n,heightM:c,tempAtAltitude:u,tempRatio:d,base:m,exponent:p,densityRatio:h,tas:v,tasRounded:Number(v.toFixed(2))}),Number(v.toFixed(2))}static calculateTASFromGroundSpeed(e,n,a,r,o){if(isNaN(e)||isNaN(n)||isNaN(a)||isNaN(r))return"N/A";const s=U.convertWind(e,"kt","m/s"),l=U.convertWind(n,"kt","m/s"),c=U.calculateWindAngle(r,a),{crosswind:u,headwind:d}=U.calculateWindComponents(l,c),m=s+d,p=U.calculateTAS(m,o);return Number(p.toFixed(1))}static calculateFlightParameters(e,n,a,r){const o=U.calculateWindAngle(e,n),{crosswind:s,headwind:l}=U.calculateWindComponents(a,o),c=U.calculateWCA(s,r),u=r>Math.abs(s)?Math.sqrt(Math.pow(r,2)-Math.pow(s,2))-l:-l;return{crosswind:Number(s.toFixed(2)),headwind:Number(l.toFixed(2)),wca:Number(c.toFixed(2)),groundSpeed:Number(u.toFixed(2))}}static calculateWindAngle(e,n){let a=U.normalizeAngle(n-e);return a>180&&(a-=360),a}static calculateWindComponents(e,n){const a=n*(Math.PI/180),r=e*Math.sin(a),o=e*Math.cos(a);return{crosswind:r,headwind:o}}static calculateWCA(e,n){const r=Math.abs(Math.asin(e/n))*(180/Math.PI);return isNaN(r)?0:r}static calculateCourseFromHeading(e,n,a,r){const o=U.calculateWindAngle(e,n),{crosswind:s,headwind:l}=U.calculateWindComponents(a,o),c=r*Math.sin(e*Math.PI/180),u=r*Math.cos(e*Math.PI/180),d=(n+180)%360,m=a*Math.sin(d*Math.PI/180),p=a*Math.cos(d*Math.PI/180),h=c+m,v=u+p,S=Math.atan2(h,v)*(180/Math.PI),w=U.normalizeAngle(S),M=Math.sqrt(h*h+v*v),y=U.calculateWCA(s,r)*(s<0?-1:1);return{trueCourse:Number(w.toFixed(2)),groundSpeed:Number(M.toFixed(2)),wca:Number(y.toFixed(2)),crosswind:Number(s.toFixed(2)),headwind:Number(l.toFixed(2))}}static validateLegHeights(e,n,a){const r=parseInt(e.value)||100,o=parseInt(n.value)||200,s=parseInt(a.value)||300;return o<=r?(U.handleError("Base leg must start higher than final leg."),!1):s<=o?(U.handleError("Downwind leg must start higher than base leg."),!1):!0}static convertCoords(e,n,a="Decimal"){if(e===null||n===null||e===void 0||n===void 0)return{lat:"N/A",lng:"N/A"};const r={Decimal:{lat:e.toFixed(6),lng:n.toFixed(6)},DMS:{lat:U.decimalToDms(e,!0),lng:U.decimalToDms(n,!1)},MGRS:U.decimalToMgrs(e,n)};switch(a){case"DMS":return r.DMS;case"MGRS":return{lat:r.MGRS,lng:r.MGRS};case"Decimal":default:return r.Decimal}}static decimalToDms(e,n){if(isNaN(e)||e===null||e===void 0)throw console.warn("Invalid decimal value for DMS conversion:",e),new Error("Invalid coordinate for DMS conversion");const a=Math.abs(e),r=Math.floor(a),o=Math.floor((a-r)*60),s=(a-r)*3600-o*60,l=n?e>=0?"N":"S":e>=0?"E":"W";if(isNaN(r)||isNaN(o)||isNaN(s))throw console.warn("DMS calculation resulted in invalid values:",{deg:r,min:o,sec:s}),new Error("Failed to convert to DMS");return{deg:r,min:o,sec:s,dir:l}}static dmsToDecimal(e,n,a,r){if(isNaN(e)||isNaN(n)||isNaN(a)||!r)throw console.warn("Invalid DMS inputs:",{deg:e,min:n,sec:a,dir:r}),new Error("Invalid DMS values");let o=e+n/60+a/3600;if((r==="S"||r==="W")&&(o=-o),isNaN(o))throw console.warn("DMS to decimal conversion failed:",{deg:e,min:n,sec:a,dir:r}),new Error("Failed to convert DMS to decimal");return o}static decimalToMgrs(e,n){try{return _o([n,e])}catch(a){return console.error("Error converting to MGRS:",a),"Invalid MGRS"}}static mgrsToDecimal(e){try{const[n,a]=pa(e);return{lat:a,lng:n}}catch(n){return console.error("Error converting MGRS to decimal:",n),null}}static calculateNewCenter(e,n,a,r){const o=fl,s=e*Math.PI/180,l=n*Math.PI/180,c=r*Math.PI/180,u=a/o,d=Math.asin(Math.sin(s)*Math.cos(u)+Math.cos(s)*Math.sin(u)*Math.cos(c)),m=l+Math.atan2(Math.sin(c)*Math.sin(u)*Math.cos(s),Math.cos(u)-Math.sin(s)*Math.sin(d)),p=d*180/Math.PI,v=(m*180/Math.PI+540)%360-180;return[p,v]}static calculateBearing(e,n,a,r){const o=m=>m*Math.PI/180,s=m=>m*180/Math.PI,l=o(r-n),c=Math.sin(l)*Math.cos(o(a)),u=Math.cos(o(e))*Math.sin(o(a))-Math.sin(o(e))*Math.cos(o(a))*Math.cos(l);let d=s(Math.atan2(c,u));return d=(d+360)%360,d}static async getLocationData(e,n){const a=`${e.toFixed(4)},${n.toFixed(4)}`;if(U.locationCache.has(a))return U.locationCache.get(a);try{const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${n}&timezone=auto`);if(!r.ok)throw r.status===429&&console.warn("API rate limit hit while fetching location data."),new Error(`Open-Meteo fetch failed: ${r.status}`);const o=await r.json(),s={timezone:o.timezone||"GMT",timezone_abbreviation:o.timezone_abbreviation||"GMT",elevation:o.elevation!==void 0?o.elevation:"N/A"};return U.locationCache.set(a,s),s}catch(r){return console.error("Error fetching location data:",r.message),{timezone:"UTC",elevation:"N/A"}}}static isValidLatLng(e,n){return typeof e=="number"&&typeof n=="number"&&!isNaN(e)&&!isNaN(n)&&e>=-90&&e<=90&&n>=-180&&n<=180&&!(e===0&&n===0)}static async getAltitude(e,n){const{elevation:a}=await U.getLocationData(e,n);return a!=="N/A"?a:"N/A"}static async getMultipleAltitudes(e){if(!e||e.length===0)return[];const n=e.map(r=>r.lat.toFixed(4)).join(","),a=e.map(r=>r.lng.toFixed(4)).join(",");try{const r=await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${n}&longitude=${a}`);if(!r.ok)throw new Error(`Elevation API Error: ${r.status}`);return(await r.json()).elevation||[]}catch(r){return console.error("Error fetching multiple altitudes:",r),e.map(()=>"N/A")}}static formatTime(e){return F.fromISO(e,{zone:"UTC"}).toFormat("yyyy-MM-dd HHmm")+"Z"}static async formatLocalTime(e,n,a){const{timezone:r,timezone_abbreviation:o}=await U.getLocationData(n,a);return F.fromISO(e,{zone:"UTC"}).setZone(r).toFormat("yyyy-MM-dd HHmm")+` ${o}`}static getLastFullHourUTC(){const e=new Date,n=e.getUTCFullYear(),a=e.getUTCMonth(),r=e.getUTCDate(),o=e.getUTCHours(),s=new Date(Date.UTC(n,a,r,o,0,0));return console.log("Last full hour UTC:",s.toISOString()),s}static async getDisplayTime(e,n,a,r="Z"){return r.toLowerCase()==="loc"&&n&&a?await U.formatLocalTime(e,n,a):U.formatTime(e)}static roundToTens(e){const n=Math.round(e/10)*10;return(n===0||n===360)&&(e>=355||e<=4)?360:n}static debounce(e,n){let a;return function(...r){clearTimeout(a),a=setTimeout(()=>e.apply(this,r),n)}}static interpolateColor(e,n=0,a=3e3){const r=Math.min(Math.max((e-n)/(a-n),0),1);return e<0||isNaN(e)?"#808080":r<=.5?`rgb(255, ${Math.round(255*(r*2))}, 0)`:`rgb(${Math.round(255*(1-(r-.5)*2))}, 255, 0)`}static generateWindBarb(e,n,a=null){const r=Math.round(n),o=40,s=40,l=o/2,c=s/2,u=20,m=(typeof a=="number"&&!isNaN(a)?a>=0:!0)?-1:1;let p=Math.floor(r/50),h=r%50,v=Math.floor(h/10),S=Math.floor(h%10/5);r<5?(v=0,S=0):r<10&&S>0&&(S=1);let w=`<svg width="${o}" height="${s}" viewBox="0 0 ${o} ${s}">`;const M=e+180;w+=`<g transform="translate(${l}, ${c}) rotate(${M})">`,w+=`<line x1="0" y1="${u/2}" x2="0" y2="${-u/2}" stroke="black" stroke-width="1"/>`;let y=u/2;const _=4;for(let b=0;b<p;b++)w+=`<polygon points="0,${y-5} 0,${y+5} ${10*m},${y}" fill="black"/>`,y-=_+5;for(let b=0;b<v;b++)w+=`<line x1="0" y1="${y}" x2="${10*m}" y2="${y}" stroke="black" stroke-width="1"/>`,y-=_;return S>0&&(w+=`<line x1="0" y1="${y}" x2="${5*m}" y2="${y}" stroke="black" stroke-width="1"/>`),r<5&&(w+='<circle cx="0" cy="0" r="3" fill="none" stroke="black" stroke-width="1"/>'),w+="</g></svg>",w}static calculateDynamicRadius(e=Ve.HEATMAP_SCALING_BASE,n=Ve.HEATMAP_REFERENCE_ZOOM){const a=i.map.getZoom(),r=Ve.HEATMAP_SCALING_BASE,o=Math.pow(r,a-n),s=e*o,l=Ve.HEATMAP_MIN_RADIUS_PX,c=Ve.HEATMAP_MAX_RADIUS_PX,u=Math.max(l,Math.min(c,s));return console.log("[calculateDynamicRadius] Calculated dynamic radius:",{currentZoom:a,baseRadius:e,scaleFactor:o,dynamicRadius:s,adjustedRadius:u}),u}static getTooltipContent(e,n,a,r){if(!i.map)return console.warn("Map not initialized for getTooltipContent"),"Map not initialized";const o=g.getValue("coordFormat","Decimal"),s=g.getValue("windUnit","kt"),l=g.getValue("heightUnit","m"),c=U.convertCoords(e.lat,e.lng,o);let u=o==="MGRS"?`MGRS: ${c.lat}`:`Lat: ${c.lat}<br>Lng: ${c.lng}`;const d=e.ele;let m=d!==null&&r!==null?d-r:null;if(m!==null){const v=l||"m";m=U.convertHeight(m,v),m=Math.round(m),u+=`<br>Altitude: ${m} ${v} AGL`}else u+="<br>Altitude: N/A";let p="N/A",h="N/A";if(n>0&&e.time&&a[n-1].time&&e.ele!==null&&a[n-1].ele!==null){const v=(e.time.toMillis()-a[n-1].time.toMillis())/1e3;if(v>0){const w=i.map.distance([a[n-1].lat,a[n-1].lng],[e.lat,e.lng])/v;p=U.convertWind(w,s,"m/s"),p=s==="bft"?Math.round(p):p.toFixed(1),h=((e.ele-a[n-1].ele)/v).toFixed(1)}}return u+=`<br>Speed: ${p} ${s}`,u+=`<br>Descent Rate: ${h} m/s`,u}static getConvexHull(e){e.sort((o,s)=>o[0]-s[0]||o[1]-s[1]);const n=(o,s,l)=>(s[0]-o[0])*(l[1]-o[1])-(s[1]-o[1])*(l[0]-o[0]),a=[];for(const o of e){for(;a.length>=2&&n(a[a.length-2],a[a.length-1],o)<=0;)a.pop();a.push(o)}const r=[];for(let o=e.length-1;o>=0;o--){const s=e[o];for(;r.length>=2&&n(r[r.length-2],r[r.length-1],s)<=0;)r.pop();r.push(s)}return a.slice(0,-1).concat(r.slice(0,-1))}};En(U,"locationCache",new Map),En(U,"debouncedGetElevationAndQFE",U.debounce(async(e,n,a)=>{`${e.toFixed(5)}${n.toFixed(5)}`;try{const r=await U.getAltitude(e,n);a&&a({elevation:r})}catch(r){console.warn("Failed to fetch elevation in debouncedGetElevationAndQFE:",r),a&&a({elevation:"N/A"})}},500));let f=U;const vl="modulepreload",Ll=function(t){return"/upper_winds_open_meteo/"+t},mr={},Ml=function(e,n,a){let r=Promise.resolve();if(n&&n.length>0){let s=function(u){return Promise.all(u.map(d=>Promise.resolve(d).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),c=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));r=s(n.map(u=>{if(u=Ll(u),u in mr)return;mr[u]=!0;const d=u.endsWith(".css"),m=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${m}`))return;const p=document.createElement("link");if(p.rel=d?"stylesheet":vl,d||(p.as="script"),p.crossOrigin="",p.href=u,c&&p.setAttribute("nonce",c),document.head.appendChild(p),d)return new Promise((h,v)=>{p.addEventListener("load",h),p.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${u}`)))})}))}function o(s){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=s,window.dispatchEvent(l),!l.defaultPrevented)throw s}return r.then(s=>{for(const l of s||[])l.status==="rejected"&&o(l.reason);return e().catch(o)})};function Io(t){var a,r;if(!t||!t.time||t.time.length===0)return[];const e=[],n=[1e3,950,925,900,850,800,700,600,500,400,300,250,200];for(let o=0;o<t.time.length;o++){const s=t.temperature_2m[o];let l={low:[],mid:[],high:[]};for(const u of n){const d=(a=t[`temperature_${u}hPa`])==null?void 0:a[o],m=(r=t[`geopotential_height_${u}hPa`])==null?void 0:r[o];d===null||m===null||d===void 0||m===void 0||(s<=0?m<=2e3?l.low.push(u):d>-30?l.mid.push(u):l.high.push(u):d>0?l.low.push(u):d>-30?l.mid.push(u):l.high.push(u))}const c=(u,d,m)=>u.length===0?95:Math.max(...u.map(h=>{var v;return((v=t[`cloud_cover_${h}hPa`])==null?void 0:v[o])||0}))>50?d:m;e.push({low:c(l.low,90,75),mid:c(l.mid,85,70),high:65})}return console.log("[WeatherManager] Cloud layer thresholds analyzed for all timesteps."),e}async function tt(t,e,n=null){console.log("[weatherManager] Starting full weather fetch for location:",{lat:t,lng:e});const a=await bl(t,e);return document.dispatchEvent(new CustomEvent("models:available",{detail:{availableModels:a}})),await Sl(t,e,n)}function Se(t,e,n,a,r){if(!t||!t.time||e>=t.time.length)return console.warn("No weather data provided or index out of bounds for interpolation"),[];const o=i.cloudThresholds[e];if(!o&&(console.warn("No pre-analyzed cloud thresholds for this index. Performing on-the-fly analysis."),i.cloudThresholds=Io(t),!i.cloudThresholds[e]))return console.error("Cloud threshold analysis failed. Cannot interpolate weather data."),[];const s=gl,l=s.filter(C=>{var W,z,$;const I=(W=t[`geopotential_height_${C}hPa`])==null?void 0:W[e],O=(z=t[`wind_speed_${C}hPa`])==null?void 0:z[e],R=($=t[`wind_direction_${C}hPa`])==null?void 0:$[e];return[I,O,R].every(V=>V!=null)}),c=s.filter(C=>{var R,W;const I=(R=t[`geopotential_height_${C}hPa`])==null?void 0:R[e],O=(W=t[`cloud_cover_${C}hPa`])==null?void 0:W[e];return I!=null&&O!=null}),u=c.map(C=>t[`geopotential_height_${C}hPa`][e]),d=c.map(C=>t[`cloud_cover_${C}hPa`][e]);if(l.length<2)return console.warn("Insufficient valid pressure level data for interpolation:",l),[];let m=l.map(C=>t[`geopotential_height_${C}hPa`][e]),p=l.map(C=>t[`temperature_${C}hPa`][e]),h=l.map(C=>t[`relative_humidity_${C}hPa`][e]);l.map(C=>{var I;return(I=t[`cloud_cover_${C}hPa`])==null?void 0:I[e]});let v=l.map(C=>t[`wind_speed_${C}hPa`][e]),S=l.map(C=>t[`wind_direction_${C}hPa`][e]);const w=t.surface_pressure[e];if(w==null)return console.warn("Surface pressure missing"),[];let M=v.map((C,I)=>-C*Math.sin(S[I]*Math.PI/180)),y=v.map((C,I)=>-C*Math.cos(S[I]*Math.PI/180));const _=Math.max(...l),b=t[`geopotential_height_${_}hPa`][e];if(w>_&&Number.isFinite(b)){const C=Math.floor((b-a)/n),I=-t.wind_speed_10m[e]*Math.sin(t.wind_direction_10m[e]*Math.PI/180),O=-t.wind_speed_10m[e]*Math.cos(t.wind_direction_10m[e]*Math.PI/180),R=M[l.indexOf(_)],W=y[l.indexOf(_)];for(let z=C-1;z>=1;z--){const $=a+z*n;if($>=b)continue;const V=($-a)/(b-a),B=Math.log(w),J=Math.log(_),X=B+V*(J-B),ue=Math.exp(X),q=Math.log($-a+1),oe=Math.log(1),ee=Math.log(b-a),ie=f.linearInterpolate([oe,ee],[I,R],q),ye=f.linearInterpolate([oe,ee],[O,W],q),Ie=f.windSpeed(ie,ye),Oe=f.windDirection(ie,ye);m.unshift($),l.unshift(ue),p.unshift(f.linearInterpolate([a,b],[t.temperature_2m[e],t[`temperature_${_}hPa`][e]],$)),h.unshift(f.linearInterpolate([a,b],[t.relative_humidity_2m[e],t[`relative_humidity_${_}hPa`][e]],$)),v.unshift(Ie),S.unshift(Oe),M.unshift(ie),y.unshift(ye)}m.unshift(a),l.unshift(w),p.unshift(t.temperature_2m[e]),h.unshift(t.relative_humidity_2m[e]),v.unshift(t.wind_speed_10m[e]),S.unshift(t.wind_direction_10m[e]),M.unshift(I),y.unshift(O)}const E=l.indexOf(Math.min(...l)),k=m[E],A=k-a;if(A<=0||isNaN(A))return console.warn("Invalid max height at lowest pressure level:",{maxHeightASL:k,baseHeight:a,minPressure:l[E]}),[];const T=r==="ft"?A*3.28084:A,N=Math.floor(T/n),P=Array.from({length:N+1},(C,I)=>I*n),x=[];return P.forEach(C=>{var z;const I=r==="ft"?C/3.28084:C,O=a+I;let R,W=0;if(u.length>0){let $=0,V=1/0;u.forEach((B,J)=>{const X=Math.abs(O-B);X<V&&(V=X,$=J)}),W=d[$]}if(I===0){const $=Math.max(...l),V=((z=t[`cloud_cover_${$}hPa`])==null?void 0:z[e])??"N/A";R={height:O,pressure:w,temp:t.temperature_2m[e],rh:t.relative_humidity_2m[e],cc:V,spd:t.wind_speed_10m[e],dir:t.wind_direction_10m[e],dew:f.calculateDewpoint(t.temperature_2m[e],t.relative_humidity_2m[e])}}else{const $=f.interpolatePressure(O,l,m),V=f.interpolateWindAtAltitude(O,l,m,M,y),B=f.windSpeed(V.u,V.v),J=f.windDirection(V.u,V.v),X=f.linearInterpolate(m,p,O),ue=f.linearInterpolate(m,h,O),q=f.calculateDewpoint(X,ue);R={height:O,pressure:Number.isFinite($)?Number($.toFixed(1)):"N/A",temp:Number.isFinite(X)?Number(X.toFixed(1)):"N/A",rh:Number.isFinite(ue)?Number(ue.toFixed(0)):"N/A",cc:Number.isFinite(W)?Number(W.toFixed(0)):"N/A",spd:Number.isFinite(B)?Number(B.toFixed(1)):"N/A",dir:Number.isFinite(J)?Number(J.toFixed(0)):"N/A",dew:Number.isFinite(q)?Number(q.toFixed(1)):"N/A"}}if(Number.isFinite(R.temp)&&Number.isFinite(R.rh)){const $=R.temp,V=R.rh;let B;t.temperature_2m[e]<=0?I<=2e3?B=o.low:$>-30?B=o.mid:B=o.high:$>0?B=o.low:$>-30?B=o.mid:B=o.high,V<B&&(R.cc=0)}R.displayHeight=C,x.push(R)}),console.log(`[DEBUG] interpolateWeatherData finished. baseHeight: ${a}, Returning ${x.length} data points. First point:`,x[0]),x}async function Sl(t,e,n=null){var a,r;document.dispatchEvent(new CustomEvent("loading:start",{detail:{message:"Fetching Weather..."}}));try{const o=((a=document.getElementById("modelSelect"))==null?void 0:a.value)||g.defaultSettings.model;if(!o)throw new Error("No weather model selected.");const l=Co.API_MAP[o]||o;let c=!1,u,d;const m=F.utc().startOf("day");let p=null;if(n){let y=F.fromISO(n,{zone:"utc"});y.isValid&&(p=y.startOf("day"),p<m&&(c=!0))}else{const y=(r=document.getElementById("historicalDatePicker"))==null?void 0:r.value;if(y){let _=F.fromISO(y,{zone:"utc"}).startOf("day");_<m&&(c=!0,p=_)}}let h=$t.FORECAST;if(c&&p)h=$t.HISTORICAL,u=d=p.toFormat("yyyy-MM-dd"),i.lastModelRun="N/A (Historical Data)";else{let y;try{const E=`https://api.open-meteo.com/data/${l}/static/meta.json`,A=await(await fetch(E)).json();y=new Date(A.last_run_initialisation_time*1e3),i.lastModelRun=y.toISOString().replace("T"," ").substring(0,16)+"Z"}catch{y=F.utc().toJSDate(),i.lastModelRun="N/A"}let _=F.fromJSDate(y).setZone("utc").plus({hours:6});_>F.utc()&&(_=F.utc()),u=_.toFormat("yyyy-MM-dd");const b=o.includes("_d2")?2:7;d=_.plus({days:b}).toFormat("yyyy-MM-dd")}const S=`${h}?latitude=${t}&longitude=${e}&hourly=surface_pressure,temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m,wind_gusts_10m,visibility,weather_code,cloud_cover_low,cloud_cover_mid,cloud_cover_high,temperature_1000hPa,relative_humidity_1000hPa,wind_speed_1000hPa,wind_direction_1000hPa,geopotential_height_1000hPa,cloud_cover_1000hPa,temperature_950hPa,relative_humidity_950hPa,wind_speed_950hPa,wind_direction_950hPa,geopotential_height_950hPa,cloud_cover_950hPa,temperature_925hPa,relative_humidity_925hPa,wind_speed_925hPa,wind_direction_925hPa,geopotential_height_925hPa,cloud_cover_925hPa,temperature_900hPa,relative_humidity_900hPa,wind_speed_900hPa,wind_direction_900hPa,geopotential_height_900hPa,cloud_cover_900hPa,temperature_850hPa,relative_humidity_850hPa,wind_speed_850hPa,wind_direction_850hPa,geopotential_height_850hPa,cloud_cover_850hPa,temperature_800hPa,relative_humidity_800hPa,wind_speed_800hPa,wind_direction_800hPa,geopotential_height_800hPa,cloud_cover_800hPa,temperature_700hPa,relative_humidity_700hPa,wind_speed_700hPa,wind_direction_700hPa,geopotential_height_700hPa,cloud_cover_700hPa,temperature_600hPa,relative_humidity_600hPa,wind_speed_600hPa,wind_direction_600hPa,geopotential_height_600hPa,cloud_cover_600hPa,temperature_500hPa,relative_humidity_500hPa,wind_speed_500hPa,wind_direction_500hPa,geopotential_height_500hPa,cloud_cover_500hPa,temperature_400hPa,relative_humidity_400hPa,wind_speed_400hPa,wind_direction_400hPa,geopotential_height_400hPa,cloud_cover_400hPa,temperature_300hPa,relative_humidity_300hPa,wind_speed_300hPa,wind_direction_300hPa,geopotential_height_300hPa,cloud_cover_300hPa,temperature_250hPa,relative_humidity_250hPa,wind_speed_250hPa,wind_direction_250hPa,geopotential_height_250hPa,cloud_cover_250hPa,temperature_200hPa,relative_humidity_200hPa,wind_speed_200hPa,wind_direction_200hPa,geopotential_height_200hPa,cloud_cover_200hPa&models=${o}&start_date=${u}&end_date=${d}`,w=await fetch(S);if(!w.ok)throw w.status===429?new Error("API-Limit reached. Please wait a moment and retry again."):new Error(`HTTP error! Status: ${w.status}`);const M=await w.json();if(!M.hourly||!M.hourly.time||!M.hourly.time.length)throw new Error("No hourly data in API response.");return M.hourly}catch(o){return console.error("[fetchWeather] Error:",o),f.handleError(`Failed to fetch weather: ${o.message}`),null}finally{document.dispatchEvent(new CustomEvent("loading:stop"))}}async function bl(t,e){const n=Co.LIST;let a=[];for(const r of n)try{const o=await fetch(`${$t.FORECAST}?latitude=${t}&longitude=${e}&hourly=temperature_2m&models=${r}`);if(o.ok){const s=await o.json();s.hourly&&s.hourly.temperature_2m&&s.hourly.temperature_2m.some(l=>l!==null)&&a.push(r)}else o.status===429?console.warn(`API-Limit beim Prüfen von Modell '${r}' erreicht.`):console.warn(`Modell '${r}' ist nicht verfügbar (Server-Antwort: ${o.status})`)}catch(o){console.error(`Netzwerkfehler beim Abruf von Modell '${r}':`,o)}return a}f.debounce(async(t,e)=>{try{const n=await f.getElevationAndQFE(t,e,i.apiKey);if(n){const a=document.getElementById("elevation"),r=document.getElementById("qfe");a&&(a.value=n.elevation.toFixed(1)),r&&(r.value=n.qfe.toFixed(2)),i.currentElevation=n.elevation,g.state.userSettings.qfe=n.qfe}}catch(n){console.error("Error fetching elevation and QFE:",n)}},500);function No(t){const e=g.state.userSettings.exitAltitude*re.METERS_TO_FEET,n=f.calculateTAS(t,e);if(n==="N/A"||!Number.isFinite(n)||n<=0)return console.warn("TAS calculation failed or invalid, using default separation"),g.defaultSettings.jumperSeparation;const a=Object.keys(lr).map(Number).sort((s,l)=>l-s);let r=a[0];for(const s of a)if(n<=s)r=s;else break;return lr[r]||7}function wa(t,e=null){var O,R;const n=e?e.lat:i.lastLat,a=e?e.lng:i.lastLng;if(!i.weatherData||!n||!a||i.lastAltitude==="N/A"||!t||!t.length)return null;const r=parseInt((O=document.getElementById("openingAltitude"))==null?void 0:O.value)||1e3,o=Math.round(i.lastAltitude),s=t.map(W=>W.height),l=t.map(W=>-f.convertWind(W.spd,"m/s","km/h")*Math.sin(W.dir*Math.PI/180)),c=t.map(W=>-f.convertWind(W.spd,"m/s","km/h")*Math.cos(W.dir*Math.PI/180)),u=f.calculateMeanWind(s,l,c,o,o+r);if(!u)return null;let d=Math.round(u[0]);const m=parseFloat(g.state.userSettings.customJumpRunDirection);Number.isFinite(m)&&m>=0&&m<=360&&(d=m);const p=parseInt((R=document.getElementById("exitAltitude"))==null?void 0:R.value)||3e3,h=o+p,v=g.state.userSettings.aircraftSpeedKt||90,S=f.calculateTAS(v,h/.3048);let w=v*re.KNOTS_TO_MPS;if(S!=="N/A"&&Number.isFinite(S)){const W=f.linearInterpolate(s.map(oe=>oe-o),t.map(oe=>oe.dir),p),z=f.linearInterpolate(s.map(oe=>oe-o),t.map(oe=>f.convertWind(oe.spd,"m/s","km/h")),p),$=S*re.KNOTS_TO_MPS,V=(W+180)*Math.PI/180,B=z*Math.sin(V),J=z*Math.cos(V),X=d*Math.PI/180,ue=$*Math.sin(X),q=$*Math.cos(X);w=Math.sqrt(Math.pow(ue+B,2)+Math.pow(q+J,2))}const M=Math.max(dt.MIN_TRACK_LENGTH_M,Math.min(dt.MAX_TRACK_LENGTH_M,Math.round((g.state.userSettings.numberOfJumpers||10)*(g.state.userSettings.jumperSeparation||5)*w))),y=Math.max(dt.MIN_APPROACH_LENGTH_M,Math.min(dt.MAX_APPROACH_LENGTH_M,Math.round(w*dt.APPROACH_TIME_SECONDS))),_=g.state.userSettings.jumpRunTrackOffset||0,b=g.state.userSettings.jumpRunTrackForwardOffset||0,E=[n,a],k=f.calculateNewCenter(E[0],E[1],M,d),A=Math.sqrt(_**2+b**2),T=Math.atan2(_,b)*180/Math.PI,N=(d+T+360)%360,P=f.calculateNewCenter(E[0],E[1],A,N),x=f.calculateNewCenter(k[0],k[1],A,N),C=f.calculateNewCenter(P[0],P[1],y,(d+180)%360),I=[P,C];return{direction:d,trackLength:M,meanWindDirection:u[0],meanWindSpeed:u[1],latlngs:[P,x],approachLatLngs:I,approachLength:y,approachTime:dt.APPROACH_TIME_SECONDS}}function Po(t){var R,W,z,$,V;if(console.log("Debug calculateExitCircle: Start",{showExitArea:g.state.userSettings.showExitArea,calculateJump:g.state.userSettings.calculateJump,weatherData:!!i.weatherData,lastLat:i.lastLat,lastLng:i.lastLng,lastAltitude:i.lastAltitude,interpolatedData:!!t&&t.length>0}),!g.state.userSettings.showExitArea||!g.state.userSettings.calculateJump||!i.weatherData||!i.lastLat||!i.lastLng)return console.log("Debug calculateExitCircle: Frühe Rückgabe wegen Einstellungen"),null;if(!t||t.length===0)return console.log("Debug calculateExitCircle: Frühe Rückgabe wegen interpolatedData"),null;const e=parseInt((R=document.getElementById("exitAltitude"))==null?void 0:R.value)||3e3,n=parseInt((W=document.getElementById("openingAltitude"))==null?void 0:W.value)||1200,a=parseInt((z=document.getElementById("legHeightDownwind"))==null?void 0:z.value)||300,r=parseFloat(($=document.getElementById("descentRate"))==null?void 0:$.value)||3.5,o=parseFloat((V=document.getElementById("canopySpeed"))==null?void 0:V.value)||20,s=o*re.KNOTS_TO_MPS,l=g.state.userSettings.safetyHeight||0;console.log("Debug calculateExitCircle: Eingabewerte",{exitAltitude:e,openingAltitude:n,legHeightDownwind:a,descentRate:r,canopySpeedKt:o,safetyHeight:l});const c=l/r*s,u=t.map(B=>B.height),d=t.map(B=>-f.convertWind(B.spd,"m/s","km/h")*Math.sin(B.dir*Math.PI/180)),m=t.map(B=>-f.convertWind(B.spd,"m/s","km/h")*Math.cos(B.dir*Math.PI/180)),p=Math.round(i.lastAltitude),h=(n-Fe-a)/r,v=h*s,S=(n-Fe)/r,w=S*s;console.log("Debug calculateExitCircle: Berechnungen",{flyTime:h,horizontalCanopyDistance:v,flyTimeFull:S,horizontalCanopyDistanceFull:w,reductionDistance:c});const M=f.calculateMeanWind(u,d,m,p+l+a,p+n-Fe),y=f.calculateMeanWind(u,d,m,p+l,p+n-Fe);console.log("Debug calculateExitCircle: meanWind",M),console.log("Debug calculateExitCircle: meanWindFull",y),console.log("Debug calculateExitCircle: Vor calculateLandingPatternCoords");const _=wn(i.lastLat,i.lastLng,t);console.log("Debug calculateExitCircle: Nach calculateLandingPatternCoords",_);let[b,E]=_.downwindStart;Number.isFinite(b)||(console.log("Debug calculateExitCircle: Fallback zu lastLat/lastLng"),b=i.lastLat,E=i.lastLng);const k=f.calculateNewCenter(b,E,M[1]*h,M[0]),A=f.calculateNewCenter(i.lastLat,i.lastLng,y[1]*S,y[0]);console.log("Debug calculateExitCircle: newCenterBlue",k),console.log("Debug calculateExitCircle: newCenterRed",A),console.log("Debug calculateExitCircle: Vor calculateFreeFall");const T=wa(t),N=T?T.direction:0,P=_l(i.weatherData,e,n,t,i.lastLat,i.lastLng,p,N);if(console.log("Debug calculateExitCircle: Nach calculateFreeFall",P),!P)return console.log("Debug calculateExitCircle: Rückgabe null wegen freeFall"),null;const x=(P.directionDeg+180)%360,C=f.calculateNewCenter(A[0],A[1],P.distance,x),I=f.calculateNewCenter(k[0],k[1],P.distance,x);console.log(`[calculateExitCircle] freeFallResult: distance=${P.distance.toFixed(2)} m, directionDeg=${P.directionDeg.toFixed(1)}°`),console.log(`[calculateExitCircle] meanWind: dir=${M[0].toFixed(1)}°, speed=${M[1].toFixed(2)} m/s`),console.log(`[calculateExitCircle] greenCenterFull: lat=${C[0]}, lng=${C[1]}`),console.log(`[calculateExitCircle] greenCenter: lat=${I[0]}, lng=${I[1]}`),console.log("[calculateExitCircle] expected downwindStart: lat=52.51657818951595, lng=13.413705547188442");const O={greenLatFull:C[0],greenLngFull:C[1],greenLat:I[0],greenLng:I[1],greenRadius:Math.max(0,w-c),darkGreenRadius:Math.max(0,v-c),freeFallDirection:P.directionDeg,freeFallDistance:P.distance,freeFallTime:P.time};return console.log("Debug calculateExitCircle: Ergebnis",O),O}function Do(t){var I,O,R,W,z;if(!g.state.userSettings.showCanopyArea||!g.state.userSettings.calculateJump||!i.weatherData||!i.lastLat||!i.lastLng||!t||t.length===0)return null;parseInt((I=document.getElementById("exitAltitude"))==null?void 0:I.value);const e=parseInt((O=document.getElementById("openingAltitude"))==null?void 0:O.value)||1200,n=parseInt((R=document.getElementById("legHeightDownwind"))==null?void 0:R.value)||300,a=parseFloat((W=document.getElementById("descentRate"))==null?void 0:W.value)||3.5,r=(parseFloat((z=document.getElementById("canopySpeed"))==null?void 0:z.value)||20)*re.KNOTS_TO_MPS,o=g.state.userSettings.safetyHeight||0,s=o/a*r,l=t.map($=>$.height),c=t.map($=>-f.convertWind($.spd,"m/s","km/h")*Math.sin($.dir*Math.PI/180)),u=t.map($=>-f.convertWind($.spd,"m/s","km/h")*Math.cos($.dir*Math.PI/180)),d=Math.round(i.lastAltitude),m=(e-Fe-n)/a,p=m*r,h=(e-Fe)/a,v=h*r,S=f.calculateMeanWind(l,c,u,d+n,d+o+e-Fe),w=f.calculateMeanWind(l,c,u,d+o,d+e-Fe),M=wn(i.lastLat,i.lastLng,t);let[y,_]=M.downwindStart;Number.isFinite(y)||(y=i.lastLat,_=i.lastLng);const b=d+e-Fe,E=d+n,k=[],A=[],T=[],N=[];let P=b-E<=1e3?200:500;for(let $=b;$>=E+200;$-=P){const V=($-E)/a,B=V*r;if(B>0){const J=f.calculateMeanWind(l,c,u,E,$);k.push(Math.max(0,B-s)),A.push(J[1]*V),T.push(J[0]),N.push($-d)}}console.log("[calculateCanopyCircles] Debug meanWind:",S),console.log("[calculateCanopyCircles] Debug flyTime:",m),console.log("[calculateCanopyCircles] Debug meanWindFull:",w),console.log("[calculateCanopyCircles] Debug flyTimeFull:",h);const x=f.calculateNewCenter(i.lastLat,i.lastLng,w[1]*h,w[0]);console.log("[calculateCanopyCircles] Tatsächlicher Mittelpunkt roter Kreis:",{lat:x[0].toFixed(3),lng:x[1].toFixed(3)});const C=f.calculateNewCenter(y,_,S[1]*m,S[0]);return console.log("[calculateCanopyCircles] Tatsächlicher Mittelpunkt blauer Kreis:",{lat:C[0].toFixed(3),lng:C[1].toFixed(3)}),{blueLat:y,blueLng:_,redLat:i.lastLat,redLng:i.lastLng,radius:Math.max(0,p-s),radiusFull:Math.max(0,v-s),additionalBlueRadii:k,additionalBlueDisplacements:A,additionalBlueDirections:T,additionalBlueUpperLimits:N,displacement:S[1]*m,direction:S[0],displacementFull:w[1]*h,directionFull:w[0],meanWindForFullCanopyDir:w[0],meanWindForFullCanopySpeedMps:w[1]}}function wn(t,e,n){var Ia,Na;if(!n||n.length===0||i.lastAltitude==="N/A")return null;const a=parseInt(document.getElementById("canopySpeed").value)||20,r=parseFloat(document.getElementById("descentRate").value)||3.5,o=parseInt(document.getElementById("legHeightFinal").value)||100,s=parseInt(document.getElementById("legHeightBase").value)||200,l=parseInt(document.getElementById("legHeightDownwind").value)||300,c=Math.round(i.lastAltitude),u=n.map(Ne=>Ne.height),d=n.map(Ne=>-f.convertWind(Ne.spd,"kt","km/h")*Math.sin(Ne.dir*Math.PI/180)),m=n.map(Ne=>-f.convertWind(Ne.spd,"kt","km/h")*Math.cos(Ne.dir*Math.PI/180)),p=((Ia=document.querySelector('input[name="landingDirection"]:checked'))==null?void 0:Ia.value)||"LL",h=document.getElementById(p==="LL"?"customLandingDirectionLL":"customLandingDirectionRR"),v=h?parseInt(h.value,10):NaN;let S=Number.isFinite(v)?v:Number.isFinite(i.landingWindDir)?i.landingWindDir:(Na=n[0])==null?void 0:Na.dir;if(!Number.isFinite(S))return null;const w=(Ne,Xo,Qo,ei,ti)=>{const ni=ei*.5144444444444445*ti;return f.calculateNewCenter(Ne,Xo,ni,Qo)},M=f.calculateMeanWind(u,d,m,c===0?1:c,c+o),y=M[0],_=M[1],b=S,E=f.calculateWindAngle(b,y),{crosswind:k,headwind:A}=f.calculateWindComponents(_,E),T=f.calculateWCA(k,a)*(k>=0?1:-1),{groundSpeed:N}=f.calculateFlightParameters(b,y,_,a),P=o/r,x=N*(1.852/3.6)*P,C=w(t,e,(b+180)%360,N,P),I=f.calculateMeanWind(u,d,m,c+o,c+s),O=I[0],R=I[1],W=(S+(p==="LL"?90:-90)+360)%360,{trueCourse:z,groundSpeed:$}=f.calculateCourseFromHeading(W,O,R,a),V=f.calculateWindAngle(z,O),{crosswind:B,headwind:J}=f.calculateWindComponents(R,V),X=f.calculateWCA(B,a)*(B>=0?1:-1);let ue=(z+180)%360;$<0&&(ue=(ue+180)%360);const q=(s-o)/r,oe=$*(1.852/3.6)*q,ee=w(C[0],C[1],ue,$,q),ie=f.calculateMeanWind(u,d,m,c+s,c+l),ye=ie[0],Ie=ie[1],Oe=(S+180)%360,zt=f.calculateWindAngle(Oe,ye),{crosswind:Gt,headwind:Mn}=f.calculateWindComponents(Ie,zt),Ye=f.calculateWCA(Gt,a)*(Gt>=0?1:-1),{groundSpeed:Sn}=f.calculateFlightParameters(Oe,ye,Ie,a),Ca=(l-s)/r,Yo=Sn*(1.852/3.6)*Ca,bn=w(ee[0],ee[1],(Oe+180)%360,Sn,Ca);return console.log(`[Pattern] Landing Pattern Updated:
        Final Leg: Wind: ${y.toFixed(1)}° @ ${_.toFixed(1)}kt, Course: ${b.toFixed(1)}°, WCA: ${T.toFixed(1)}°, GS: ${N.toFixed(1)}kt, HW: ${A.toFixed(1)}kt, Length: ${x.toFixed(1)}m
        Base Leg: Wind: ${O.toFixed(1)}° @ ${R.toFixed(1)}kt, Course: ${z.toFixed(1)}°, WCA: ${X.toFixed(1)}°, GS: ${$.toFixed(1)}kt, HW: ${J.toFixed(1)}kt, Length: ${oe.toFixed(1)}m
        Downwind Leg: Wind: ${ye.toFixed(1)}° @ ${Ie.toFixed(1)}kt, Course: ${Oe.toFixed(1)}°, WCA: ${Ye.toFixed(1)}°, GS: ${Sn.toFixed(1)}kt, HW: ${Mn.toFixed(1)}kt, Length: ${Yo.toFixed(1)}m`),console.log("[Pattern] Coordinates DIP: ",t,e,"Altitude DIP:",c),console.log("[Pattern] Coordinates final end: ",C[0],C[1],"Leg Height:",c+o),console.log("[Pattern] Coordinates base end: ",ee[0],ee[1],"Leg Height:",c+s),console.log("[Pattern] Coordinates downwind end: ",bn[0],bn[1],"Leg Height:",c+l),{downwindStart:bn,baseStart:ee,finalStart:C,landingPoint:[t,e]}}function va(t){if(!i.map||i.cutAwayLat===null||i.cutAwayLng===null||!i.weatherData||i.lastAltitude==="N/A"||!t||t.length===0)return null;const e=Math.round(i.lastAltitude),n=g.state.userSettings.cutAwayAltitude,a=e,r=e+n,o=t.map(b=>b.height),s=t.map(b=>-f.convertWind(b.spd,"m/s","km/h")*Math.sin(b.dir*Math.PI/180)),l=t.map(b=>-f.convertWind(b.spd,"m/s","km/h")*Math.cos(b.dir*Math.PI/180)),c=f.calculateMeanWind(o,s,l,a,r);if(!c)return null;const[u,d]=c,m={Open:xn.OPEN,Partially:xn.PARTIALLY,Collapsed:xn.COLLAPSED},p=m[g.state.userSettings.cutAwayState]||m.Partially,h=n/p,v=d*h,S=(u+180)%360,[w,M]=f.calculateNewCenter(i.cutAwayLat,i.cutAwayLng,v,S),_=`<b>Cut-Away (${g.state.userSettings.cutAwayState.replace(/([A-Z])/g," $1").trim()})</b><br>Cut-Away Altitude: ${n} m<br>Displacement: ${u.toFixed(0)}°, ${v.toFixed(0)} m<br>Descent Time/Speed: ${h.toFixed(0)} s at ${p.toFixed(1)} m/s<br>`;return{center:[w,M],radius:hl,tooltipContent:_}}async function El(){var E,k,A,T;const t=parseInt((E=document.getElementById("timeSlider"))==null?void 0:E.value)||0,e=g.getValue("interpStep","select",200),n=g.getValue("heightUnit","m"),a=Se(i.weatherData,t,e,Math.round(i.lastAltitude),n);parseInt((k=document.getElementById("legHeightDownwind"))==null?void 0:k.value);const r=parseFloat((A=document.getElementById("descentRate"))==null?void 0:A.value)||3.5,o=(parseFloat((T=document.getElementById("canopySpeed"))==null?void 0:T.value)||20)*re.KNOTS_TO_MPS,s=i.lastAltitude,l=Do(a);if(!l||l.additionalBlueRadii.length===0)throw new Error("Could not calculate the smallest canopy circle for analysis.");const c=l.additionalBlueRadii.length-1,u=l.additionalBlueRadii[c],d=l.blueLat,m=l.blueLng,p=l.additionalBlueDisplacements[c],h=l.additionalBlueDirections[c],v=f.calculateNewCenter(d,m,p,h),S=l.additionalBlueUpperLimits[c],w=L.latLng(d,m);console.log(`--- TERRAIN ANALYSIS STARTED ---
    - Analyzing Circle Center: ${v[0].toFixed(4)}, ${v[1].toFixed(4)}
    - Circle Radius: ${u.toFixed(0)}m
    - Skydiver Entry Altitude: ${S.toFixed(0)}m AGL (${(s+S).toFixed(0)}m MSL)
    -----------------------------`);const M=`${v[0].toFixed(4)}_${v[1].toFixed(4)}_${u.toFixed(0)}`;let y=[];if(i.terrainAnalysisCache&&i.terrainAnalysisCache.key===M)console.log("Using cached terrain elevation data."),f.handleMessage("Using cached terrain data for instant analysis."),y=i.terrainAnalysisCache.data;else{const P=[],x=L.latLng(v);for(let I=-u;I<=u;I+=75)for(let O=-u;O<=u;O+=75)if(I*I+O*O<=u*u){const R=x.lat+I/111320,W=x.lng+O/(111320*Math.cos(x.lat*Math.PI/180));P.push(L.latLng(R,W))}if(P.length===0)return[];const C=100;for(let I=0;I<P.length;I+=C){const O=P.slice(I,I+C);f.handleMessage(`Analyzing terrain... (${I+O.length}/${P.length})`);const R=await f.getMultipleAltitudes(O);for(let W=0;W<O.length;W++){const z=O[W],$=R[W];y.push({...z,groundEle:$!=="N/A"?$:null})}}i.terrainAnalysisCache={key:M,data:y},console.log("Terrain elevation data has been cached.")}const _=[],b=g.getValue("terrainClearance",100);for(const N of y){const P=N.groundEle;if(P===null)continue;const I=i.map.distance(w,N)/o*r,O=s+S-I,R=O-P;console.log(`[Point Analysis] Lat: ${N.lat.toFixed(4)}, Lng: ${N.lng.toFixed(4)}
            - Ground MSL: ${P.toFixed(0)}m
            - Skydiver MSL (estimated): ${O.toFixed(0)}m
            - CLEARANCE: ${R.toFixed(0)}m`),R<b&&_.push(N)}return console.log(`--- TERRAIN ANALYSIS FINISHED ---
    - Points Analyzed: ${y.length}
    - Dangerous Points Found: ${_.length}
    --------------------------------`),_}function _l(t,e,n,a,r,o,s,l){if(!t||!a||a.length===0)return f.handleError("calculateFreeFall: Wetterdaten fehlen."),null;if(!f.isValidLatLng(r,o)||!Number.isFinite(s))return f.handleError("calculateFreeFall: Ungültige Startkoordinaten oder Geländehöhe."),null;if(e<=n)return f.handleError("calculateFreeFall: Exit-Höhe muss über der Öffnungshöhe liegen."),null;console.log("--- calculateFreeFall: Berechnung gestartet ---");const{TERMINAL_VELOCITY_VERTICAL_MPS:c,GRAVITY_ACCELERATION:u,HORIZONTAL_DRAG_TAU_SECONDS:d}=ml,m=g.state.userSettings.aircraftSpeedKt,p=e/re.FEET_TO_METERS,h=f.calculateTAS(m,p);let v=m*re.KNOTS_TO_MPS;if(Number.isFinite(h)){const q=a.map(Ye=>Ye.height-s),oe=f.linearInterpolate(q,a.map(Ye=>Ye.dir),e),ee=f.linearInterpolate(q,a.map(Ye=>f.convertWind(Ye.spd,"m/s","km/h")),e),ie=h*re.KNOTS_TO_MPS,ye=(oe+180)*Math.PI/180,Ie=ee*Math.sin(ye),Oe=ee*Math.cos(ye),zt=l*Math.PI/180,Gt=ie*Math.sin(zt),Mn=ie*Math.cos(zt);v=Math.sqrt((Gt+Ie)**2+(Mn+Oe)**2)}console.log(`[Freifall-Input] JRT-Richtung: ${l}°, TAS: ${h} kt, Berechnete Ground Speed: ${v.toFixed(1)} m/s`);const S=e-n,w=c/u,M=.5*u*w**2,_=(S>M?S-M:0)/c,b=w+_,E=v*d,k=l,A=a.map(q=>-f.convertWind(q.spd,"m/s","km/h")*Math.sin(q.dir*Math.PI/180)),T=a.map(q=>-f.convertWind(q.spd,"m/s","km/h")*Math.cos(q.dir*Math.PI/180)),N=f.calculateMeanWind(a.map(q=>q.height),A,T,s+n,s+e);if(!N)return f.handleError("calculateFreeFall: Konnte mittleren Wind nicht berechnen."),null;const[P,x]=N;console.log(`[Freifall-Input] Mittelwind: ${P.toFixed(0)}° @ ${(x*3.6/1.852).toFixed(1)} kt`);const C=(P+180)%360,I=x*b;console.log(`[Freifall-Ergebnis] Wurf: ${k.toFixed(0)}°, Distanz: ${E.toFixed(0)} m`),console.log(`[Freifall-Ergebnis] Abdrift: ${C.toFixed(0)}°, Distanz: ${I.toFixed(0)} m`);const O=E*Math.cos(k*Math.PI/180),R=E*Math.sin(k*Math.PI/180),W=I*Math.cos(C*Math.PI/180),z=I*Math.sin(C*Math.PI/180),$=O+W,V=R+z,B=Math.sqrt($**2+V**2),J=(Math.atan2(V,$)*180/Math.PI+360)%360,X=f.calculateNewCenter(r,o,B,J),ue=[{latLng:{lat:r,lng:o},height:s+e,time:0},{latLng:{lat:X[0],lng:X[1]},height:s+n,time:b}];return console.log(`[Freifall-Ergebnis] Zeit: ${b.toFixed(1)} s, Distanz: ${B.toFixed(0)} m, Richtung: ${J.toFixed(1)}°`),console.log("--- calculateFreeFall: Berechnung beendet ---"),{time:b,distance:B,directionDeg:J,path:ue}}async function La(){if(!i.lastLat||!i.lastLng)return f.handleMessage("Please select a location first."),!1;if(!g.state.userSettings.selectedEnsembleModels||g.state.userSettings.selectedEnsembleModels.length===0)return i.ensembleModelsData=null,Bt(),!0;const t=document.getElementById("loading");t&&(t.style.display="block");try{const e=i.lastLat,n=i.lastLng,a=g.state.userSettings.selectedEnsembleModels,r=a.join(","),o=["surface_pressure","temperature_2m","relative_humidity_2m","wind_speed_10m","wind_direction_10m","geopotential_height_1000hPa","temperature_1000hPa","relative_humidity_1000hPa","wind_speed_1000hPa","wind_direction_1000hPa","cloud_cover_1000hPa","geopotential_height_950hPa","temperature_950hPa","relative_humidity_950hPa","wind_speed_950hPa","wind_direction_950hPa","cloud_cover_950hPa","geopotential_height_925hPa","temperature_925hPa","relative_humidity_925hPa","wind_speed_925hPa","wind_direction_925hPa","cloud_cover_925hPa","geopotential_height_900hPa","temperature_900hPa","relative_humidity_900hPa","wind_speed_900hPa","wind_direction_900hPa","cloud_cover_900hPa","geopotential_height_850hPa","temperature_850hPa","relative_humidity_850hPa","wind_speed_850hPa","wind_direction_850hPa","cloud_cover_850hPa","geopotential_height_800hPa","temperature_800hPa","relative_humidity_800hPa","wind_speed_800hPa","wind_direction_800hPa","cloud_cover_800hPa","geopotential_height_700hPa","temperature_700hPa","relative_humidity_700hPa","wind_speed_700hPa","wind_direction_700hPa","cloud_cover_700hPa","geopotential_height_600hPa","temperature_600hPa","relative_humidity_600hPa","wind_speed_600hPa","wind_direction_600hPa","cloud_cover_600hPa","geopotential_height_500hPa","temperature_500hPa","relative_humidity_500hPa","wind_speed_500hPa","wind_direction_500hPa","cloud_cover_500hPa","geopotential_height_400hPa","temperature_400hPa","relative_humidity_400hPa","wind_speed_400hPa","wind_direction_400hPa","cloud_cover_400hPa","geopotential_height_300hPa","temperature_300hPa","relative_humidity_300hPa","wind_speed_300hPa","wind_direction_300hPa","cloud_cover_300hPa","geopotential_height_250hPa","temperature_250hPa","relative_humidity_250hPa","wind_speed_250hPa","wind_direction_250hPa","cloud_cover_250hPa","geopotential_height_200hPa","temperature_200hPa","relative_humidity_200hPa","wind_speed_200hPa","wind_direction_200hPa","cloud_cover_200hPa"],s=o.join(","),l=document.getElementById("historicalDatePicker"),c=l?l.value:null,u=c?F.fromISO(c,{zone:"utc"}):null,d=F.utc().startOf("day"),m=u&&u<d;let p,h,v=$t.FORECAST;if(m)v=$t.HISTORICAL,p=u.toFormat("yyyy-MM-dd"),h=p;else{const _=F.utc();p=_.toFormat("yyyy-MM-dd"),h=_.plus({days:7}).toFormat("yyyy-MM-dd")}const S=`${v}?latitude=${e}&longitude=${n}&hourly=${s}&models=${r}&start_date=${p}&end_date=${h}`,w=await fetch(S);if(!w.ok)throw w.status===429?new Error("API-Limit for ensemble data reached. Please wait a moment and retry again."):new Error(`API request failed: ${w.status}`);const M=await w.json();i.ensembleModelsData={};const y=M.hourly.time;return a.forEach(_=>{const b={time:[...y]};let E=!1;o.forEach(k=>{const A=`${k}_${_}`;M.hourly[A]?(b[k]=M.hourly[A],E=!0):b[k]=null}),E&&(i.ensembleModelsData[_]=b)}),!0}catch(e){return console.error("Failed to fetch ensemble weather data:",e),f.handleError(e.message),!1}finally{t&&(t.style.display="none")}}function rt(t,e){if(Bt(),!i.ensembleModelsData||Object.keys(i.ensembleModelsData).length===0)return;const n=g.state.userSettings.currentEnsembleScenario;switch(console.log(`Processing ensemble scenario: ${n} for slider index: ${t}`),n){case"heatmap":Tl(t);break;case"all_models":for(const a in i.ensembleModelsData){const r=i.ensembleModelsData[a],o=ea(a,t,{hourly:r});o&&hr(o,Al(a),a)}break;case"min_wind":case"mean_wind":case"max_wind":{const a=kl(n);if(a){const r=ea(n,t,a);r&&hr(r,Cl(n),n.replace("_"," "))}break}}}function Bt(){i.ensembleLayerGroup&&i.map.removeLayer(i.ensembleLayerGroup),i.ensembleScenarioCircles={},i.ensembleLayerGroup=L.layerGroup().addTo(i.map)}function kl(t,e){var d;if(!i.ensembleModelsData||Object.keys(i.ensembleModelsData).length===0)return console.warn("No ensemble data available for profile calculation."),null;if(Object.keys(i.ensembleModelsData).length===0)return null;console.log(`Calculating full time-series ensemble profile for: ${t}`);const a={},r=Object.keys(i.ensembleModelsData)[0],o=(d=i.ensembleModelsData[r])==null?void 0:d.time;if(!o||o.length===0)return console.error("Time data missing or empty in the first ensemble model for profile calculation."),null;a.time=[...o];const s=a.time.length,l=["surface_pressure","temperature_2m","relative_humidity_2m","geopotential_height_1000hPa","temperature_1000hPa","relative_humidity_1000hPa","geopotential_height_950hPa","temperature_950hPa","relative_humidity_950hPa","geopotential_height_925hPa","temperature_925hPa","relative_humidity_925hPa","geopotential_height_900hPa","temperature_900hPa","relative_humidity_900hPa","geopotential_height_850hPa","temperature_850hPa","relative_humidity_850hPa","geopotential_height_800hPa","temperature_800hPa","relative_humidity_800hPa","geopotential_height_700hPa","temperature_700hPa","relative_humidity_700hPa","geopotential_height_600hPa","temperature_600hPa","relative_humidity_600hPa","geopotential_height_500hPa","temperature_500hPa","relative_humidity_500hPa","geopotential_height_400hPa","temperature_400hPa","relative_humidity_400hPa","geopotential_height_300hPa","temperature_300hPa","relative_humidity_300hPa","geopotential_height_250hPa","temperature_250hPa","relative_humidity_250hPa","geopotential_height_200hPa","temperature_200hPa","relative_humidity_200hPa"],c=[["wind_speed_10m","wind_direction_10m"]];[1e3,950,925,900,850,800,700,600,500,400,300,250,200].forEach(m=>{c.push([`wind_speed_${m}hPa`,`wind_direction_${m}hPa`])}),l.forEach(m=>{a[m]=new Array(s).fill(null)}),c.forEach(m=>{a[m[0]]=new Array(s).fill(null),a[m[1]]=new Array(s).fill(null)});for(let m=0;m<s;m++)l.forEach(p=>{const h=[];for(const v in i.ensembleModelsData){const S=i.ensembleModelsData[v];if(S&&S[p]){const w=S[p][m];w!=null&&!isNaN(w)&&h.push(w)}}h.length>0&&(t==="min_wind"?a[p][m]=Math.min(...h):t==="max_wind"?a[p][m]=Math.max(...h):a[p][m]=h.reduce((v,S)=>v+S,0)/h.length)}),c.forEach(p=>{const h=p[0],v=p[1];let S=[],w=[],M=[],y=[];for(const _ in i.ensembleModelsData){const b=i.ensembleModelsData[_];if(b&&b[h]&&b[v]){const E=b[h][m],k=b[v][m];E!=null&&!isNaN(E)&&k!==null&&k!==void 0&&!isNaN(k)&&(M.push(E),y.push(k),S.push(-E*Math.sin(k*Math.PI/180)),w.push(-E*Math.cos(k*Math.PI/180)))}}if(M.length>0)if(t==="min_wind"){const _=Math.min(...M),b=M.indexOf(_);a[h][m]=_,a[v][m]=y[b]}else if(t==="max_wind"){const _=Math.max(...M),b=M.indexOf(_);a[h][m]=_,a[v][m]=y[b]}else{const _=S.reduce((E,k)=>E+k,0)/S.length,b=w.reduce((E,k)=>E+k,0)/w.length;a[h][m]=f.windSpeed(_,b),a[v][m]=f.windDirection(_,b)}});return{hourly:a}}function ea(t,e,n=null){var u,d;if(console.log(`Calculating exit circle for ensemble profile/model: ${t} at index ${e}`),e==null)return console.error("sliderIndex is undefined in calculateExitCircleForEnsemble. Aborting."),null;let a;if(n)a=n;else if(i.ensembleModelsData&&i.ensembleModelsData[t])a={hourly:i.ensembleModelsData[t]};else return console.warn(`No data for profile/model ${t} in calculateExitCircleForEnsemble found.`),null;if(!a.hourly||!i.lastLat||!i.lastLng||i.lastAltitude==="N/A")return console.warn(`Incomplete data for calculateExitCircleForEnsemble: ${t}`),null;const r=Ce(),o=g.getValue("heightUnit","m"),s=i.weatherData;i.weatherData=a.hourly;let l=null,c={meanWindDir:"N/A",meanWindSpeedMps:"N/A"};try{const m=g.state.userSettings.calculateJump,p=g.state.userSettings.showExitArea;g.state.userSettings.calculateJump=!0,g.state.userSettings.showExitArea=!0;const h=Se(i.weatherData,e,r,Math.round(i.lastAltitude),o);if(h&&h.length>0){l=Po(h);const v=h.map(A=>A.height),S=h.map(A=>-f.convertWind(A.spd,"m/s","km/h")*Math.sin(A.dir*Math.PI/180)),w=h.map(A=>-f.convertWind(A.spd,"m/s","km/h")*Math.cos(A.dir*Math.PI/180)),M=parseInt((u=document.getElementById("openingAltitude"))==null?void 0:u.value)||1200,y=parseInt((d=document.getElementById("legHeightDownwind"))==null?void 0:d.value)||0,_=Math.round(i.lastAltitude),b=_+M-200,E=_+y,k=f.calculateMeanWind(v,S,w,E,b);k&&Number.isFinite(k[0])&&Number.isFinite(k[1])&&(c={meanWindDir:k[0],meanWindSpeedMps:k[1]})}g.state.userSettings.calculateJump=m,g.state.userSettings.showExitArea=p}catch(m){console.error(`Error in calculateExitCircle for profile ${t}:`,m),l=null}finally{i.weatherData=s}return l?{centerLat:l.greenLat,centerLng:l.greenLng,radius:l.darkGreenRadius,meanWindDir:c.meanWindDir,meanWindSpeedMps:c.meanWindSpeedMps}:(console.warn(`calculateExitCircle returned null for profile ${t}`),null)}function Tl(t,e){if(Bt(),!i.ensembleModelsData||Object.keys(i.ensembleModelsData).length===0)return;const n=[];for(const w in i.ensembleModelsData)if(Object.hasOwnProperty.call(i.ensembleModelsData,w)){const M=i.ensembleModelsData[w],y=ea(w,t,{hourly:M});y&&n.push({centerLat:y.centerLat,centerLng:y.centerLng,radius:y.radius})}if(n.length===0){console.warn("Could not calculate any circles for the heatmap.");return}const a=n.length,r=Math.ceil(a/2);let o=90,s=-90,l=180,c=-180;n.forEach(w=>{const M=w.radius/111320,y=w.radius/(111320*Math.cos(w.centerLat*Math.PI/180));o=Math.min(o,w.centerLat-M),s=Math.max(s,w.centerLat+M),l=Math.min(l,w.centerLng-y),c=Math.max(c,w.centerLng+y)});const u=25,d=u/111320,m=[],p=[],h=[];for(let w=o;w<=s;w+=d){const M=u/(111320*Math.cos(w*Math.PI/180));for(let y=l;y<=c;y+=M){let _=0;const b=L.latLng(w,y);for(const E of n)i.map.distance(b,L.latLng(E.centerLat,E.centerLng))<=E.radius&&_++;_>=1&&m.push([w,y]),_>=r&&p.push([w,y]),_===a&&h.push([w,y])}}const v=w=>{w.sort((b,E)=>b[0]-E[0]||b[1]-E[1]);const M=(b,E,k)=>(E[0]-b[0])*(k[1]-b[1])-(E[1]-b[1])*(k[0]-b[0]),y=[];for(const b of w){for(;y.length>=2&&M(y[y.length-2],y[y.length-1],b)<=0;)y.pop();y.push(b)}const _=[];for(let b=w.length-1;b>=0;b--){const E=w[b];for(;_.length>=2&&M(_[_.length-2],_[_.length-1],E)<=0;)_.pop();_.push(E)}return y.slice(0,-1).concat(_.slice(0,-1))};i.heatmapContourLayers=[];const S=(w,M)=>{if(w.length>2){const y=v(w),_=L.polygon(y,M).addTo(i.ensembleLayerGroup);i.heatmapContourLayers.push(_)}};S(m,{color:"red",weight:2,fillOpacity:.1,interactive:!1}),S(p,{color:"yellow",weight:2,fillOpacity:.15,interactive:!1}),S(h,{color:"green",weight:3,fillOpacity:.2,interactive:!1})}function hr(t,e,n){var S,w;if(!i.map||!t||!i.ensembleLayerGroup)return;const a=[t.centerLat,t.centerLng],r=L.circle(a,{radius:t.radius,color:e,fillColor:e,fillOpacity:.15,weight:2,dashArray:"5, 10",pmIgnore:!0}).addTo(i.ensembleLayerGroup),o=g.getValue("windUnit","kt");let s="N/A";if(t.meanWindSpeedMps!=="N/A"&&Number.isFinite(t.meanWindSpeedMps)){const M=f.convertWind(t.meanWindSpeedMps,o,"m/s");M!=="N/A"&&Number.isFinite(M)&&(s=o==="bft"?Math.round(M):M.toFixed(1))}const l=parseInt((S=document.getElementById("openingAltitude"))==null?void 0:S.value)||g.state.userSettings.openingAltitude||1200,c=parseInt((w=document.getElementById("legHeightDownwind"))==null?void 0:w.value)||g.state.userSettings.legHeightDownwind||0,u=l-200,d=g.getValue("heightUnit","m"),m=Math.round(f.convertHeight(c,d)),p=Math.round(f.convertHeight(u,d)),h=t.meanWindDir!=="N/A"&&Number.isFinite(t.meanWindDir)?f.roundToTens(t.meanWindDir):"N/A",v=`<strong>${n}</strong><br>Mean Wind ${m}-${p} ${d} AGL:<br>${h}° ${s} ${o}`;r.bindTooltip(v,{permanent:!1,direction:"top",className:"wind-tooltip",opacity:.9}),i.ensembleScenarioCircles[n]=r,console.log(`Drew ensemble circle for ${n} at [${a.join(", ")}], radius ${t.radius}`)}function Al(t){let e=0;for(let a=0;a<t.length;a++)e=t.charCodeAt(a)+((e<<5)-e),e=e&e;return`hsl(${e%360}, 70%, 60%)`}function Cl(t){return t==="min_wind"?Ve.SCENARIO_COLORS.MIN_WIND:t==="mean_wind"?Ve.SCENARIO_COLORS.MEAN_WIND:t==="max_wind"?Ve.SCENARIO_COLORS.MAX_WIND:"rgba(128, 128, 128, 0.7)"}function Fo(){var t;return parseInt((t=document.getElementById("timeSlider"))==null?void 0:t.value)||0}function Il({title:t,message:e,onConfirm:n,onCancel:a}){const r=document.getElementById("locationDisclosureModal"),o=document.getElementById("disclosureHeader"),s=document.getElementById("disclosureMessage"),l=document.getElementById("disclosureConfirm"),c=document.getElementById("disclosureCancel");if(!r||!o||!s||!l||!c){console.error("Disclosure modal elements not found!"),n();return}o.textContent=t,s.innerHTML=e,r.style.display="flex";const u=l.cloneNode(!0);l.parentNode.replaceChild(u,l);const d=c.cloneNode(!0);c.parentNode.replaceChild(d,c),u.onclick=()=>{r.style.display="none",n()},d.onclick=()=>{r.style.display="none",a()}}const ge={dbName:"SkydivingTileCache",storeName:"tiles",db:null,async init(){return new Promise((t,e)=>{const n=indexedDB.open(this.dbName,1);n.onupgradeneeded=a=>{a.target.result.createObjectStore(this.storeName,{keyPath:"url"})},n.onsuccess=a=>{this.db=a.target.result,t()},n.onerror=a=>{console.error("IndexedDB initialization failed:",a),e(a)}})},async storeTile(t,e){return this.db||await this.init(),new Promise((n,a)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put({url:t,blob:e,timestamp:Date.now()});s.onsuccess=()=>{console.log(`Stored tile: ${t}`),n(!0)},s.onerror=l=>{console.warn(`Failed to store tile: ${t}`,l),f.handleError("Failed to store some tiles. Try clearing cache."),a(l)}})},async getTile(t){return this.db||await this.init(),new Promise((e,n)=>{const r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName),o=r.get(t);o.onsuccess=s=>{const l=s.target.result;if(l)e(l.blob);else{const c=[t.replace("https://tile.opentopomap.org","https://a.tile.opentopomap.org"),t.replace("https://tile.opentopomap.org","https://b.tile.opentopomap.org"),t.replace("https://tile.opentopomap.org","https://c.tile.opentopomap.org"),t.replace("https://tile.openstreetmap.org","https://a.tile.openstreetmap.org"),t.replace("https://tile.openstreetmap.org","https://b.tile.openstreetmap.org"),t.replace("https://tile.openstreetmap.org","https://c.tile.openstreetmap.org"),t.replace("https://basemaps.cartocdn.com","https://a.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://b.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://c.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://d.basemaps.cartocdn.com")];let u=null;for(const d of c){if(d===t)continue;const m=r.get(d);m.onsuccess=p=>{const h=p.target.result;h&&(u=h.blob,e(u))},m.onerror=()=>{}}setTimeout(()=>{u||e(null)},100)}},o.onerror=s=>{console.warn(`Failed to retrieve tile: ${t}`,s),n(s)}})},async clearCache(){return this.db||await this.init(),new Promise((t,e)=>{const r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();r.onsuccess=()=>{console.log("Tile cache cleared"),t()},r.onerror=o=>{console.error("Failed to clear cache:",o),e(o)}})},async clearOldTiles(t=pn.MAX_AGE_DAYS){this.db||await this.init();const e=t*24*60*60*1e3;return new Promise((n,a)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).openCursor();let l=0,c=0;s.onsuccess=u=>{const d=u.target.result;if(d)Date.now()-d.value.timestamp>e&&(c+=d.value.blob.size||0,d.delete(),l++),d.continue();else{const m=c/1048576;console.log(`Cleared ${l} old tiles, freed ${m.toFixed(2)} MB`),n({deletedCount:l,deletedSizeMB:m})}},s.onerror=u=>{console.error("Failed to clear old tiles:",u),a(u)}})},async getCacheSize(){return this.db||await this.init(),new Promise((t,e)=>{const r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).openCursor();let o=0,s=0;r.onsuccess=l=>{var u;const c=l.target.result;if(c)try{const d=((u=c.value.blob)==null?void 0:u.size)||0;typeof d!="number"||isNaN(d)?console.warn(`Invalid blob size for tile: ${c.value.url}, size: ${d}`):(o+=d,s++),c.continue()}catch(d){console.warn(`Error processing tile during size calculation: ${c.value.url}`,d),c.continue()}else{const d=o/1048576;console.log(`Cache size calculation completed: ${d.toFixed(2)} MB, ${s} tiles`),t(d)}},r.onerror=l=>{console.error("Failed to calculate cache size:",l),e(l)}})},async migrateTiles(){return this.db||await this.init(),new Promise((t,e)=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),r=a.openCursor();let o=0;r.onsuccess=s=>{const l=s.target.result;if(l){const{url:c,blob:u,timestamp:d}=l.value,m=c.replace(/^(https?:\/\/[a-c]\.tile\.openstreetmap\.org)/,"https://tile.openstreetmap.org").replace(/^(https?:\/\/[a-d]\.basemaps\.cartocdn\.com)/,"https://basemaps.cartocdn.com").replace(/^(https?:\/\/[a-c]\.tile\.opentopomap\.org)/,"https://tile.opentopomap.org");c!==m&&(l.delete(),a.put({url:m,blob:u,timestamp:d}),o++),l.continue()}else console.log(`Migrated ${o} tiles to normalized URLs`),t()},r.onerror=s=>{console.error("Failed to migrate tiles:",s),e(s)}})}};L.TileLayer.Cached=L.TileLayer.extend({createTile(t,e){const n=document.createElement("img");L.DomEvent.on(n,"load",()=>{console.log("Tile loaded:",this.getTileUrl(t)),e(null,n)}),L.DomEvent.on(n,"error",()=>{console.warn("Tile error:",this.getTileUrl(t)),e(new Error("Failed to load tile"),n)});const a=this.getTileUrl(t);n.setAttribute("role","presentation");const r=a.replace(/^(https?:\/\/[a-c]\.tile\.openstreetmap\.org)/,"https://tile.openstreetmap.org").replace(/^(https?:\/\/[a-d]\.basemaps\.cartocdn\.com)/,"https://basemaps.cartocdn.com").replace(/^(https?:\/\/[a-c]\.tile\.opentopomap\.org)/,"https://tile.opentopomap.org");return!navigator.onLine&&(t.z<11||t.z>14)?(console.log(`Skipping tile request outside cached zoom levels (11–14): ${a}`),f.handleError("Offline: Zoom restricted to levels 11–14 for cached tiles."),e(new Error("Zoom level not cached"),n),n):(navigator.onLine?(n.src=a,fetch(a,{signal:AbortSignal.timeout(pn.FETCH_TIMEOUT_MS)}).then(o=>{if(!o.ok)throw new Error(`HTTP ${o.status}`);return o.blob()}).then(o=>{ge.storeTile(r,o).catch(s=>console.warn("Failed to cache tile during rendering:",r,s))}).catch(o=>{console.warn("Fetch error for tile during rendering:",a,o),ge.getTile(r).then(s=>{s?(n.src=URL.createObjectURL(s),console.log(`Tile loaded from cache (fallback): ${r}`)):e(o,n)}).catch(s=>{console.warn("Cache fallback error:",r,s),e(s,n)})})):ge.getTile(r).then(o=>{o?(n.src=URL.createObjectURL(o),console.log(`Tile loaded from cache: ${r}`)):(console.warn(`Tile not in cache: ${r}`),f.handleError("This area is not cached. Please cache more tiles while online."),e(new Error("Tile not in cache"),n))}).catch(o=>{console.warn("Cache error for offline tile:",r,o),f.handleError("This area is not cached. Please cache more tiles while online."),e(o,n)}),n)}});L.tileLayer.cached=function(t,e){return new L.TileLayer.Cached(t,e)};async function xo({map:t,lastLat:e,lastLng:n,baseMaps:a,onProgress:r,onComplete:o,onCancel:s,radiusKm:l=null,silent:c=!1}){if(!t){o&&!c&&o("Map not initialized, cannot cache tiles.");return}if(!e||!n){o&&!c&&o("Please select a location to cache map tiles.");return}const u=l!==null?l:g.state.userSettings.cacheRadiusKm||g.defaultSettings.cacheRadiusKm,d=g.state.userSettings.cacheZoomLevels||g.defaultSettings.cacheZoomLevels,m=Nl(e,n,u,d,t),p=[],h=g.state.userSettings.baseMaps,v=a[h];if(v)if(v instanceof L.LayerGroup)v.eachLayer(b=>{const E=b.options.url||b._url;E&&p.push({name:`${h} (${b.options.attribution||"sub-layer"})`,url:E,subdomains:b.options.subdomains,normalizedUrl:E.replace(/{s}\./,"")})});else{const b=v.options.url||v._url;b&&p.push({name:h,url:b,subdomains:v.options.subdomains,normalizedUrl:b.replace(/{s}\./,"")})}const S=m.length*p.length;if(S===0){o&&!c&&o("No tiles to cache for this basemap.");return}let w=0,M=0;const y=[];i.isCachingCancelled=!1,r&&!c&&r(0,S,()=>{i.isCachingCancelled=!0,s&&s()});try{for(const b of p){if(console.log("Processing layer:",b.name),i.isCachingCancelled){console.log("Caching cancelled by user");break}const E=m.map(async(k,A)=>{if(i.isCachingCancelled){console.log("Caching cancelled during tile processing");return}const T=b.url.replace("{z}",k.zoom).replace("{x}",k.x).replace("{y}",k.y).replace("{s}",b.subdomains?b.subdomains[Math.floor(Math.random()*b.subdomains.length)]:""),N=b.normalizedUrl.replace("{z}",k.zoom).replace("{x}",k.x).replace("{y}",k.y);if(console.log(`Processing tile ${A+1}/${m.length} for layer ${b.name}:`,{url:T,normalizedUrl:N}),await ge.getTile(N).catch(C=>(console.error(`Error retrieving tile from cache: ${N}`,C),null)))w++,console.log(`Tile ${A+1} already in cache`);else{const C=await Pl(T);C.success?await ge.storeTile(N,C.blob).catch(O=>(console.error(`Error storing tile: ${N}`,O),!1))?(w++,console.log(`Tile ${A+1} cached successfully`)):(M++,y.push(T),console.log(`Tile ${A+1} failed to store`)):(M++,y.push(T),console.log(`Tile ${A+1} failed to fetch:`,C.error.message))}const x=w+M;((A+1)%10===0||A===m.length-1)&&r&&!c&&r(x,S,()=>{i.isCachingCancelled=!0})});console.log(`Processing batch of ${m.length} tiles for layer ${b.name}`);for(let k=0;k<E.length;k+=20){if(i.isCachingCancelled){console.log("Caching cancelled during batch processing");break}const A=E.slice(k,k+20);await Promise.all(A).catch(T=>{console.error("Error processing batch of tiles:",T)}),console.log(`Completed batch ${k/20+1} for layer ${b.name}`)}}}catch(b){console.error("Unexpected error in cacheTilesForDIP:",b),f.handleError("Failed to cache map tiles: "+b.message)}finally{if(console.log("Hiding progress bar"),o){let b="";i.isCachingCancelled?b=`Caching cancelled: ${w} tiles cached, ${M} failed.`:M>0?b=`Cached ${w} tiles around DIP (${M} failed).`:b=`Cached ${w} tiles around DIP successfully.`,o(b)}}y.length>0&&console.warn(`Failed to cache ${y.length} tiles:`,y),console.log(`DIP caching complete: ${w} tiles cached, ${M} failed`);let _="";i.isCachingCancelled?_=`Caching cancelled: ${w} tiles cached, ${M} failed.`:M>0?_=`Cached ${w} tiles around DIP (${M} failed).`:_=`Cached ${w} tiles around DIP successfully.`,o&&o(_);try{const b=await ge.getCacheSize();console.log(`Cache size after DIP caching: ${b.toFixed(2)} MB`),b>pn.SIZE_LIMIT_MB_WARNING&&f.handleError(`Cache size large (${b.toFixed(2)} MB). Consider clearing cache to free up space.`)}catch(b){console.error("Failed to check cache size after DIP caching:",b),f.handleError("Unable to check cache size. Consider clearing cache to free up space.")}}async function Ma({map:t,baseMaps:e,onProgress:n,onComplete:a,onCancel:r}){if(!t||!navigator.onLine){console.log("Skipping visible tile caching: offline or map not initialized");return}const o=t.getBounds(),s=t.getZoom(),l=g.state.userSettings.cacheZoomLevels||g.defaultSettings.cacheZoomLevels;if(!l.includes(s)){console.log(`Skipping caching: zoom ${s} not in cacheZoomLevels`,l);return}const c=256,u=t.project(o.getSouthWest(),s),d=t.project(o.getNorthEast(),s),m=Math.floor(u.x/c),p=Math.floor(d.x/c),h=Math.floor(d.y/c),v=Math.floor(u.y/c),S=[];for(let k=m;k<=p;k++)for(let A=h;A<=v;A++){const T=2**s;k>=0&&k<T&&A>=0&&A<T&&S.push({zoom:s,x:k,y:A})}console.log(`Caching ${S.length} visible tiles at zoom ${s} for ${g.state.userSettings.baseMaps}`);const w=[],M=g.state.userSettings.baseMaps,y=e[M];if(y)if(y instanceof L.LayerGroup)y.eachLayer(k=>{const A=k.options.url||k._url;A&&w.push({name:`${M} (${k.options.attribution||"sub-layer"})`,url:A,subdomains:k.options.subdomains,normalizedUrl:A.replace(/{s}\./,"")})});else{const k=y.options.url||y._url;k&&w.push({name:M,url:k,subdomains:y.options.subdomains,normalizedUrl:k.replace(/{s}\./,"")})}else{console.warn(`Base map ${M} not found, skipping caching`),a&&a("Selected base map not available for caching.");return}let _=0,b=0;const E=S.length*w.length;i.isCachingCancelled=!1,n&&n(0,E,()=>{i.isCachingCancelled=!0,r&&r()});for(const k of w){if(i.isCachingCancelled)break;const A=S.map(async(T,N)=>{n&&n(_+b,E,()=>{i.isCachingCancelled=!0,r&&r()})});await Promise.all(A)}a&&a("Visible tiles cached.")}function Nl(t,e,n,a,r){if(!r)return console.warn("Map not initialized, cannot calculate tiles"),[];const o=new Set,s=40075016686e-3,l=n*1e3;return a.forEach(c=>{const u=r.project([t,e],c),d=256,m=u.x/d,p=u.y/d,h=t*Math.PI/180,v=s*Math.cos(h)/(d*Math.pow(2,c)),S=Math.ceil(l/(v*d))+1,w=Math.pow(2,c);for(let M=Math.floor(m-S);M<=Math.ceil(m+S);M++)for(let y=Math.floor(p-S);y<=Math.ceil(p+S);y++)M>=0&&M<w&&y>=0&&y<w&&o.add(`${c}/${M}/${y}`)}),Array.from(o).map(c=>{const[u,d,m]=c.split("/").map(Number);return{zoom:u,x:d,y:m}})}async function Pl(t,e=3){let n=null;for(let a=1;a<=e;a++){try{const r=new AbortController,o=setTimeout(()=>r.abort(),pn.FETCH_TIMEOUT_MS),s=await fetch(t,{signal:r.signal});if(clearTimeout(o),s.ok)return{success:!0,blob:await s.blob()};console.warn(`Attempt ${a} failed for ${t}: HTTP ${s.status}`),n=new Error(`HTTP ${s.status}`)}catch(r){console.warn(`Attempt ${a} error for ${t}: ${r.message}`),n=r,r.name==="AbortError"&&console.warn(`Fetch timeout after 15s for ${t}`)}a<e&&await new Promise(r=>setTimeout(r,1e3))}return{success:!1,error:n}}function ot(){const t="ontouchstart"in window||navigator.maxTouchPoints>0,e=window.Capacitor&&window.Capacitor.isNativePlatform();return t||e}function Dl(){ot()&&document.body.classList.add("touch-device")}function ae(){var t;return parseInt((t=document.getElementById("timeSlider"))==null?void 0:t.value)||0}function Fl(t){const e=document.getElementById("modelSelect");if(!e)return;const n=e.value;e.innerHTML="",t.forEach(a=>{const r=document.createElement("option");r.value=a,r.textContent=a.replace(/_/g," ").toUpperCase(),e.appendChild(r)}),t.includes(g.state.userSettings.model)?e.value=g.state.userSettings.model:t.includes(n)?e.value=n:t.length>0&&(e.value=t[0])}function xl(t){let e=g.state.userSettings.selectedEnsembleModels||[],n=e.filter(a=>t.includes(a));e.length!==n.length&&(g.state.userSettings.selectedEnsembleModels=n,g.save())}function Sa(t,e="default"){let n=document.getElementById("snackbar");n||(n=document.createElement("div"),n.id="snackbar",document.body.appendChild(n)),n.textContent=t,n.className="show",e==="success"?n.classList.add("success"):e==="error"?n.classList.add("error"):e==="warning"&&n.classList.add("warning"),window.snackbarTimeout&&clearTimeout(window.snackbarTimeout),window.snackbarTimeout=setTimeout(()=>{n.className=n.className.replace("show","")},3e3)}function Ze(t){console.log("displayMessage called with:",t),Sa(t,"success")}function ln(t){console.log("displayError called with:",t),Sa(t,"error")}function qe(t){console.log("displayWarning called with:",t),Sa(t,"warning")}function Ot(t,e,n){let a=document.getElementById("progress-snackbar");if(!a){a=document.createElement("div"),a.id="progress-snackbar";const o=document.createElement("div");o.className="progress-snackbar-content";const s=document.createElement("div");s.className="progress-snackbar-text";const l=document.createElement("div");l.className="progress-bar-container";const c=document.createElement("div");c.className="progress-bar",l.appendChild(c),o.appendChild(s),o.appendChild(l);const u=document.createElement("button");u.className="cancel-button",u.textContent="Cancel",u.onclick=()=>{n&&n(),$e()},a.appendChild(o),a.appendChild(u),document.body.appendChild(a)}const r=e>0?Math.round(t/e*100):0;a.querySelector(".progress-snackbar-text").textContent=`Caching (${t}/${e})... ${r}%`,a.querySelector(".progress-bar").style.width=`${r}%`,a.classList.contains("show")||a.classList.add("show")}function $e(){const t=document.getElementById("progress-snackbar");t&&t.classList.remove("show")}function ta(){console.log("updateOfflineIndicator called, navigator.onLine:",navigator.onLine);let t=document.getElementById("offline-indicator");t||(t=document.createElement("div"),t.id="offline-indicator",t.textContent="Offline Mode",document.body.appendChild(t),console.log("Offline indicator created and appended")),navigator.onLine?t.classList.remove("show"):t.classList.add("show")}function wt(t,e="Loading..."){const n=document.getElementById("loading");if(!n)return;const a=n.querySelector("p");t?(a&&(a.textContent=e),n.style.display="flex"):n.style.display="none"}let Xt=0;async function $l(){return console.log("MapManager: Starte Karteninitialisierung..."),await Ol(),console.log("MapManager: Karteninitialisierung abgeschlossen."),i.map}async function Ol(){if(i.ismapInitialized||i.map){console.warn("Map already initialized or init in progress.");return}i.ismapInitialized=!0,console.log("initMap started...");const t=ke.DEFAULT_MAP_CENTER,e=ke.DEFAULT_MAP_ZOOM;tc(t,e),i.jumpVisualizationLayerGroup=L.layerGroup().addTo(i.map),i.landingPatternLayerGroup=L.layerGroup().addTo(i.map),i.jumpRunTrackLayerGroup=L.layerGroup().addTo(i.map),i.favoritesLayerGroup=L.layerGroup().addTo(i.map),console.log("Favorite marker layer added!"),i.poiLayerGroup=L.layerGroup().addTo(i.map),console.log("POI marker layer added!"),ic(),nc(),sc(),ac(t),cc(),Promise.all([rc(),hc(t,e)]).then(()=>{console.log("Initial tile caching and geolocation promise resolved.")}).catch(n=>{console.error("Error during parallel initialization of cache/geolocation:",n)}),ta(),console.log("initMap finished.")}function tn(t){if(Hl(),i.labelZoomListener&&i.map&&(i.map.off("zoomend",i.labelZoomListener),i.labelZoomListener=null),!t||!i.jumpVisualizationLayerGroup)return;const e=[];t.exitCircles&&t.exitCircles.forEach(a=>{const r=L.circle(a.center,{radius:a.radius,color:a.color,fillColor:a.fillColor,fillOpacity:a.fillOpacity,weight:a.weight||2,pmIgnore:!0}).addTo(i.jumpVisualizationLayerGroup);a.tooltip&&r.bindTooltip(a.tooltip,{direction:"top",offset:[0,0],className:"wind-tooltip"})}),t.canopyCircles&&t.canopyCircles.forEach(a=>{L.circle(a.center,{...a,pmIgnore:!0}).addTo(i.jumpVisualizationLayerGroup)});function n(a,r){const o=L.latLng(a[0],a[1]),l=r/6378137*(180/Math.PI),c=L.latLng(a[0]+l,a[1]),u=i.map.latLngToLayerPoint(o),d=i.map.latLngToLayerPoint(c);return[25,u.y-d.y+10]}if(t.canopyLabels){const a=i.map.getZoom();t.canopyLabels.forEach(r=>{const o=a<=11,s=L.marker(r.center,{icon:L.divIcon({className:`isoline-label ${o?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${o?"8px":"10px"}">${r.text}</span>`,iconSize:o?[50,12]:[60,14],iconAnchor:n(r.center,r.radius),pmIgnore:!0}),zIndexOffset:2100}).addTo(i.jumpVisualizationLayerGroup);e.push({marker:s,center:r.center,radius:r.radius,text:r.text,pmIgnore:!0})})}e.length>0&&(i.labelZoomListener=function(){const r=i.map.getZoom()<=11;e.forEach(o=>{o.marker.setIcon(L.divIcon({className:`isoline-label ${r?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${r?"8px":"10px"}">${o.text}</span>`,iconSize:r?[50,12]:[60,14],iconAnchor:n(o.center,o.radius)}))})},i.map.on("zoomend",i.labelZoomListener))}function Ct(t){Bl(),t&&(t.legs.forEach(e=>{L.polyline(e.path,{color:"red",weight:3,opacity:.8,dashArray:"5, 10",pmIgnore:!0}).addTo(i.landingPatternLayerGroup)}),t.arrows.forEach(e=>{const n=Jl(e.position[0],e.position[1],e.bearing,e.color);L.marker(e.position,{icon:n,pmIgnore:!0}).addTo(i.landingPatternLayerGroup).bindTooltip(e.tooltipText,{offset:[10,0],direction:"right",className:"wind-tooltip",pmIgnore:!0})}))}function Pt(t){var o,s,l,c;if(zl(),!i.jumpRunTrackLayerGroup){console.error("drawJumpRunTrack called before jumpRunTrackLayerGroup was initialized.");return}if(!t)return;if(!((s=(o=t.path)==null?void 0:o.latlngs)!=null&&s.length)||!((l=t.airplane)!=null&&l.position)){console.warn("Invalid trackData structure:",t);return}const e=L.polyline(t.path.latlngs,t.path.options).bindTooltip(t.path.tooltipText).addTo(i.jumpRunTrackLayerGroup);let n=null;(c=t.approachPath)!=null&&c.latlngs&&(n=L.polyline(t.approachPath.latlngs,t.approachPath.options).bindTooltip(t.approachPath.tooltipText).addTo(i.jumpRunTrackLayerGroup));const a=L.icon({iconUrl:yn.AIRPLANE_MARKER,iconSize:[32,32],iconAnchor:[16,16],shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[13,32]}),r=L.marker(t.airplane.position,{icon:a,rotationAngle:t.airplane.bearing,rotationOrigin:"center center",draggable:!g.state.userSettings.isInteractionLocked,zIndexOffset:2e3,pmIgnore:!0}).bindTooltip("Drag to move Jump Run Track").addTo(i.jumpRunTrackLayerGroup);r.on("mousedown",()=>{g.state.userSettings.isInteractionLocked&&qe("Interaction is locked. Please unlock to move points."),i.map.dragging.disable()}),r.on("mouseup",()=>i.map.dragging.enable()),r.on("drag",u=>{var S;const d=u.target.getLatLng(),m=t.airplane.originalPosition;if(!m||!Number.isFinite(m.lat)||!Number.isFinite(m.lng)){console.warn("Invalid originalPosition:",m);return}const p=d.lat-m.lat,h=d.lng-m.lng;if(!Number.isFinite(p)||!Number.isFinite(h)){console.warn("Invalid delta values:",{deltaLat:p,deltaLng:h});return}const v=t.path.originalLatLngs.map(w=>[Number.isFinite(w[0])?w[0]+p:w[0],Number.isFinite(w[1])?w[1]+h:w[1]]);if(e.setLatLngs(v),n&&((S=t.approachPath)!=null&&S.originalLatLngs)){const w=t.approachPath.originalLatLngs.map(M=>[Number.isFinite(M[0])?M[0]+p:M[0],Number.isFinite(M[1])?M[1]+h:M[1]]);n.setLatLngs(w)}}),r.on("dragstart",u=>{g.state.userSettings.isInteractionLocked&&(u.target.dragging.disable(),qe("Interaction is locked. Please unlock to move points."))}),r.on("dragend",u=>{const d=u.target.getLatLng();if(!Number.isFinite(d.lat)||!Number.isFinite(d.lng)){console.warn("Invalid new position in dragend:",d);return}const m=new CustomEvent("track:dragend",{detail:{newPosition:d,originalTrackData:t},bubbles:!0});i.map.getContainer().dispatchEvent(m)})}function na(t){i.cutAwayCircle&&(i.map.removeLayer(i.cutAwayCircle),i.cutAwayCircle=null),t&&(i.cutAwayCircle=L.circle(t.center,{radius:t.radius,color:"purple",fillColor:"purple",fillOpacity:.2,weight:2,pmIgnore:!0}).addTo(i.map),i.cutAwayCircle.bindTooltip(t.tooltipContent,{permanent:!1,direction:"center",className:"cutaway-tooltip"}))}function Rl(t,e){const n=[[t.lat,t.lng],[e.lat,e.lng]];i.jumpMasterLine?i.jumpMasterLine.setLatLngs(n):i.jumpMasterLine=L.polyline(n,{color:"blue",weight:3,dashArray:"5, 5"}).addTo(i.map)}function Wl(t){if(oc(),i.terrainWarningLayer.clearLayers(),!t||t.length<3)return;const e=f.getConvexHull(t.map(a=>[a.lat,a.lng])),n=g.getValue("terrainClearance",100);L.polygon(e,{color:"red",fillColor:"#f03",fillOpacity:.5,weight:2,pmIgnore:!0}).bindTooltip(`WARNING: Ground clearance in this area may be less than ${n}m!`,{sticky:!0,className:"cutaway-tooltip"}).addTo(i.terrainWarningLayer)}function Ul(t){if(!i.map||t.length<2)return;const e={color:"#007bff",weight:3,opacity:.7,pmIgnore:!0};i.aircraftTrackLayer?i.aircraftTrackLayer.setLatLngs(t):i.aircraftTrackLayer=L.polyline(t,e).addTo(i.map)}function Hl(){i.map&&i.jumpVisualizationLayerGroup&&i.map.removeLayer(i.jumpVisualizationLayerGroup),i.jumpVisualizationLayerGroup=L.layerGroup().addTo(i.map)}function Bl(){i.landingPatternLayerGroup&&i.landingPatternLayerGroup.clearLayers()}function zl(){i.map&&i.jumpRunTrackLayerGroup&&i.map.removeLayer(i.jumpRunTrackLayerGroup),i.jumpRunTrackLayerGroup=L.layerGroup().addTo(i.map)}function Gl(){i.cutAwayMarker&&(i.map.removeLayer(i.cutAwayMarker),i.cutAwayMarker=null),na(null)}function Vl(){i.jumpMasterLine&&(i.map.removeLayer(i.jumpMasterLine),i.jumpMasterLine=null)}function Zl(){if(!i.map){console.warn("Map not initialized, cannot clear HARP marker"),f.handleMessage("Map not initialized, cannot clear HARP marker.");return}i.harpMarker&&(i.map.removeLayer(i.harpMarker),i.harpMarker=null,console.log("Removed HARP marker")),g.state.userSettings.harpLat=null,g.state.userSettings.harpLng=null,g.save();const t=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');if(t&&(t.disabled=!0,console.log("Disabled HARP radio button")),g.state.userSettings.jumpMasterLineTarget==="HARP"&&g.state.userSettings.showJumpMasterLine){i.jumpMasterLine&&(i.map.removeLayer(i.jumpMasterLine),i.jumpMasterLine=null,console.log("Removed Jump Master Line: HARP marker cleared")),g.state.userSettings.jumpMasterLineTarget="DIP";const e=document.querySelector('input[name="jumpMasterLineTarget"][value="DIP"]');e&&(e.checked=!0,console.log("Switched Jump Master Line to DIP")),g.save(),i.liveMarker&&i.currentMarker&&i.lastLat!==null&&i.lastLng!==null&&debouncedPositionUpdate({coords:{latitude:i.lastLatitude,longitude:i.lastLongitude,accuracy:i.lastAccuracy,altitude:i.lastDeviceAltitude,altitudeAccuracy:i.lastAltitudeAccuracy}})}f.handleMessage("HARP marker cleared")}function jl(){i.terrainWarningLayer&&(i.terrainWarningLayer.clearLayers(),console.log("Terrain warning layer cleared."))}function $o(){i.aircraftTrackLayer&&(i.map.removeLayer(i.aircraftTrackLayer),i.aircraftTrackLayer=null)}function Jl(t,e,n,a){const r=(n+360)%360,o=`
        <svg width="40" height="20" viewBox="0 0 40 20" xmlns="http://www.w3.org/2000/svg">
            <line x1="0" y1="10" x2="30" y2="10" stroke="${a}" stroke-width="4" />
            <polygon points="30,5 40,10 30,15" fill="${a}" />
        </svg>
    `;return L.divIcon({html:`<div style="transform-origin: center; transform: rotate(${r}deg);">${o}</div>`,className:"wind-arrow-icon",iconSize:[40,20],iconAnchor:[20,10]})}function ql(t,e){const n=L.icon({iconUrl:yn.CUTAWAY_MARKER,iconSize:[25,25],iconAnchor:[12,12],popupAnchor:[0,-12],pmIgnore:!0});return L.marker([t,e],{icon:n,draggable:!g.state.userSettings.isInteractionLocked,pmIgnore:!0})}function Kl(t){t.on("mousedown",()=>{g.state.userSettings.isInteractionLocked&&qe("Interaction is locked. Please unlock to move points.")}),t.on("dragend",e=>{const n=t.getLatLng();i.cutAwayLat=n.lat,i.cutAwayLng=n.lng,Oo(t,i.cutAwayLat,i.cutAwayLng);const a=new CustomEvent("cutaway:marker_placed",{bubbles:!0});i.map.getContainer().dispatchEvent(a)})}function Oo(t,e,n,a=!1){const r=g.getValue("coordFormat","radio","Decimal"),o=f.convertCoords(e,n,r);let s="<b>Cut-Away Start</b><br>";if(r==="MGRS")s+=`MGRS: ${o.lat}`;else{const l=c=>`${c.deg}°${c.min}'${c.sec.toFixed(0)}" ${c.dir}`;r==="DMS"?s+=`Lat: ${l(f.decimalToDms(e,!0))}<br>Lng: ${l(f.decimalToDms(n,!1))}`:s+=`Lat: ${e.toFixed(5)}<br>Lng: ${n.toFixed(5)}`}ba(t,s,a)}async function vn(t,e){if(console.log("MapManager: Befehl erhalten, Marker zu erstellen/bewegen bei",t,e),typeof t!="number"||typeof e!="number"||t<-90||t>90||e<-180||e>180){console.error("MapManager: Ungültige Koordinaten:",{lat:t,lng:e});return}const n=await f.getAltitude(t,e);if(i.currentMarker)console.log("MapManager: Marker existiert, bewege ihn jetzt mit setLatLng."),i.currentMarker.setLatLng([t,e]);else{console.log("MapManager: Kein Marker vorhanden, erstelle einen neuen.");const r=Yl(t,e);Xl(r),i.currentMarker=r,i.currentMarker.addTo(i.map)}const a=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${n} m`;ba(i.currentMarker,a),i.lastLat=t,i.lastLng=e,i.lastAltitude=n,i.map.invalidateSize()}function Yl(t,e){const n=L.icon({iconUrl:yn.DEFAULT_MARKER,iconSize:[32,32],iconAnchor:[16,20],popupAnchor:[0,-32],pmIgnore:!0});return L.marker([t,e],{icon:n,draggable:!g.state.userSettings.isInteractionLocked,pmIgnore:!0})}function Xl(t){t.on("mousedown",()=>{g.state.userSettings.isInteractionLocked&&qe("Interaction is locked. Please unlock to move points.")}),t.on("dragend",e=>{const n=t.getLatLng(),a=new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lng,source:"marker_drag"},bubbles:!0});i.map.getContainer().dispatchEvent(a)})}function ba(t,e,n=!1){var r;if(!t)return;const a=((r=t.getPopup())==null?void 0:r.isOpen())||n;t.unbindPopup().bindPopup(e),a&&t.openPopup()}function Ro(t){if(!i.map||!i.favoritesLayerGroup){console.warn("Cannot update favorite markers: map or layer group not ready.");return}if(i.favoritesLayerGroup.clearLayers(),!t||t.length===0)return;const e=L.divIcon({html:"★",className:"favorite-marker-icon",iconSize:[24,24],iconAnchor:[12,12]});t.forEach(n=>{const a=L.marker([n.lat,n.lng],{icon:e,pmIgnore:!0}).bindTooltip(n.label,{permanent:!1,direction:"top"}).on("click",()=>{document.dispatchEvent(new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lng,source:"favorite_marker"},bubbles:!0}))});i.favoritesLayerGroup.addLayer(a)})}function aa(t){if(g.state.userSettings.isInteractionLocked){qe("Interaction is locked. Please unlock to move points."),i.isPlacingHarp=!1,i.map.off("click",aa);return}if(!i.isPlacingHarp)return;const{lat:e,lng:n}=t.latlng;i.harpMarker?i.harpMarker.setLatLng([e,n]):i.harpMarker=Wo(e,n).addTo(i.map),g.state.userSettings.harpLat=e,g.state.userSettings.harpLng=n,g.state.userSettings.jumpRunTrackOffset=0,g.state.userSettings.jumpRunTrackForwardOffset=0,console.log("HARP placed. JRT offsets reset to 0."),g.save(),i.isPlacingHarp=!1,i.map.off("click",aa);const a=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');a&&(a.disabled=!1),document.dispatchEvent(new CustomEvent("ui:recalculateJump")),document.dispatchEvent(new CustomEvent("harp:updated"))}function Wo(t,e){return L.marker([t,e],{icon:L.divIcon({className:"harp-marker",html:'<div style="width: 14px; height: 14px; background-color: green; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 6px rgba(0,0,0,0.6);"></div>',iconSize:[20,20],iconAnchor:[10,10]}),pane:"markerPane",pmIgnore:!0})}function Ql(t){if(!i.map||!i.poiLayerGroup){console.warn("Cannot update POI markers: map or layer group not ready.");return}if(i.poiLayerGroup.clearLayers(),!t||t.length===0)return;const e=L.divIcon({html:"🪂",className:"poi-marker-icon",iconSize:[24,24],iconAnchor:[12,12]});t.forEach(n=>{const a=L.marker([n.lat,n.lon],{icon:e,pmIgnore:!0}).bindTooltip(n.display_name,{permanent:!1,direction:"top"}).on("click",()=>{document.dispatchEvent(new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lon,source:"poi_marker"},bubbles:!0}))});i.poiLayerGroup.addLayer(a)})}function ec(t,e,n){const a=L.icon({iconUrl:yn.LIVEPLANE_MARKER,iconSize:[32,32],iconAnchor:[16,16],color:"red"}),r=L.marker([t,e],{icon:a,rotationAngle:n,rotationOrigin:"center center",zIndexOffset:1500,pmIgnore:!0}).addTo(i.map);return i.aircraftMarker=r,r}function tc(t,e){i.lastLat=i.lastLat||t[0],i.lastLng=i.lastLng||t[1],i.map=L.map("map",{center:t,zoom:e,zoomControl:!1,doubleClickZoom:!1,maxZoom:19,minZoom:navigator.onLine?6:11}),console.log("Map instance created.")}function nc(){if(!i.map){console.error("Karte nicht initialisiert, bevor Controls hinzugefügt werden können.");return}L.control.layers(i.baseMaps,null,{position:"topright"}).addTo(i.map),i.map.on("baselayerchange",function(t){g&&g.state&&g.state.userSettings&&(g.state.userSettings.baseMaps=t.name,g.save()),i.hasTileErrorSwitched=!1,i.lastLat&&i.lastLng&&typeof cacheTilesForDIP=="function"&&cacheTilesForDIP({map:i.map,lastLat:i.lastLat,lastLng:i.lastLng,baseMaps:i.baseMaps})}),L.control.zoom({position:"topright"}).addTo(i.map),L.control.scale({position:"bottomleft",metric:!0,imperial:!1,maxWidth:100}).addTo(i.map),i.map.pm.addControls({position:"topright",drawMarker:!0,drawCircleMarker:!1,drawPolyline:!0,drawPolygon:!1,drawRectangle:!1,drawCircle:!0,cutPolygon:!1,editMode:!0,dragMode:!0,removalMode:!0,rotateMode:!1}),i.map.pm.setLang("en"),ot()&&(i.map.pm.setGlobalOptions({hintlineStyle:{opacity:0,color:"green"}}),console.log("Geoman global options set for mobile to hide helper lines.")),console.log("Standard map controls including Geoman have been added.")}async function ac(t,e){console.log("MapManager: Initialisiere den Standard-Marker..."),await vn(t[0],t[1]),i.isManualPanning=!1,console.log("Default marker initialized using the new standard method.")}async function rc(){try{if(await ge.init(),await ge.migrateTiles(),await ge.getCacheSize()>500){const e=await ge.clearOldTiles(3);f.handleMessage(`Cleared ${e.deletedCount} old tiles: ${e.deletedSizeMB.toFixed(2)} MB freed.`)}else await ge.clearOldTiles()}catch(t){console.error("Failed to initialize or manage tile cache:",t),f.handleError("Tile caching setup failed.")}console.log("Tile cache logic initialized.")}function oc(){i.terrainWarningLayer||(i.terrainWarningLayer=L.layerGroup().addTo(i.map))}function ic(){i.baseMaps={OpenStreetMap:L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}),OpenTopoMap:L.tileLayer.cached("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,attribution:'© <a href="https://www.openstreetmap.org/copyright">OSM</a>, <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)',subdomains:["a","b","c"]}),"Esri Street":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Topo":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Satellite":L.layerGroup([L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19}),L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© EsriEsri, USDA, USGS © OpenStreetMap contributors, and the GIS user community",pane:"shadowPane"})]),"Esri Satellite + OSM":L.layerGroup([L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USDA, USGS",zIndex:1}),L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',opacity:.5,zIndex:2,updateWhenIdle:!0,keepBuffer:2,subdomains:["a","b","c"]})],{attribution:'© Esri, USDA, USGS | © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),"OpenTopoMap + Airspaces":L.layerGroup([L.tileLayer.cached("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)',subdomains:["a","b","c"]}),L.tileLayer.cached("https://nwy-tiles-api.prod.newaydata.com/tiles/{z}/{x}/{y}.png?path=latest/aero/latest",{maxZoom:19,attribution:'© <a href="https://www.openflightmaps.org">openflightmaps.org</a>',opacity:.5,zIndex:2,updateWhenIdle:!0,keepBuffer:2,subdomains:["a","b","c"]})],{attribution:'© Esri, USDA, USGS | © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),"Open Flight Map":L.tileLayer.cached("https://nwy-tiles-api.prod.newaydata.com/tiles/{z}/{x}/{y}.png?path=latest/aero/latest",{maxZoom:19,attribution:'© <a href="https://www.openflightmaps.org">openflightmaps.org</a>'})},i.map&&i.map.attributionControl&&i.map.attributionControl.addAttribution('Weather data by <a href="https://open-meteo.com">Open-Meteo</a>');const e=g.state.userSettings.baseMaps in i.baseMaps?g.state.userSettings.baseMaps:"Esri Street",n=i.baseMaps[e];n&&typeof n.on=="function"?(n.on("tileerror",()=>{if(!navigator.onLine){i.hasTileErrorSwitched||(console.warn(`${e} tiles unavailable offline. Zoom restricted.`),f.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."),i.hasTileErrorSwitched=!0);return}if(!i.hasTileErrorSwitched&&i.map.hasLayer(n)){const a="OpenStreetMap";console.warn(`${e} tiles unavailable, switching to ${a}`),i.map.removeLayer(n),i.baseMaps[a].addTo(i.map),g.state.userSettings.baseMaps=a,g.save(),f.handleMessage(`${e} tiles unavailable. Switched to ${a}.`),i.hasTileErrorSwitched=!0}else i.hasTileErrorSwitched||console.warn(`Tile error in ${e}, attempting to continue.`)}),n.addTo(i.map)):(console.error(`Default base map "${e}" could not be added.`),i.baseMaps.OpenStreetMap.addTo(i.map)),i.map&&i.map.invalidateSize(),window.addEventListener("online",()=>{i.hasTileErrorSwitched=!1,i.map&&(i.map.options.minZoom=6),ta()}),window.addEventListener("offline",()=>{i.map&&(i.map.options.minZoom=9),ta()}),console.log("Base layers and online/offline handlers set up.")}function sc(){i.map.createPane("gpxTrackPane"),i.map.getPane("gpxTrackPane").style.zIndex=650,i.map.getPane("tooltipPane").style.zIndex=700,i.map.getPane("popupPane").style.zIndex=700,console.log("Custom map panes created.")}function lc(){const t=i.map;if(!t){console.log("No map available");return}console.log("Leaflet-Geoman Version:",L.PM.version);const e=document.querySelector(".leaflet-pm-toolbar");e&&["click","dblclick","mousedown","mouseup","touchstart","touchend","pointerdown","pointerup","contextmenu"].forEach(v=>{e.addEventListener(v,S=>{L.DomEvent.stopPropagation(S),console.log(`Stopped '${S.type}' event on Geoman toolbar.`)})});const n=L.DomUtil.create("div","leaflet-measure-label",t.getContainer()),a=L.layerGroup().addTo(t);let r=null,o=null,s=null,l=!1;function c(h,v){const S=h[v],w=v>0?h[v-1]:null;if(!w)return;const M=v<h.length-1?h[v+1]:null,y=f.calculateBearing(w.lat,w.lng,S.lat,S.lng),_=w.distanceTo(S),b=_<1e3?`${_.toFixed(0)} m`:`${(_/1e3).toFixed(2)} km`;let E=0;for(let P=1;P<=v;P++)E+=h[P-1].distanceTo(h[P]);const k=E<1e3?`${E.toFixed(0)} m`:`${(E/1e3).toFixed(2)} km`,A=M?`${f.calculateBearing(S.lat,S.lng,M.lat,M.lng).toFixed(0)}°`:"---",T=`
            <div class="geoman-permanent-label">
                <div>In: ${y.toFixed(0)}°</div>
                <div>Out: ${A}</div>
                <div>+: ${b}</div>
                <div>∑: ${k}</div>
            </div>
        `;L.marker(S,{icon:L.divIcon({className:"geoman-label-container",html:T,iconAnchor:[-5,-5]}),pmIgnore:!0}).addTo(a)}function u(h){const v=h.getLatLng(),S=h.getRadius(),M=`<div class="geoman-permanent-label">Radius:<br> ${S<1e3?`${S.toFixed(0)} m`:`${(S/1e3).toFixed(2)} km`}</div>`,y=L.marker(v,{icon:L.divIcon({className:"geoman-label-container",html:M,iconAnchor:[0,0]}),pmIgnore:!0});y.addTo(a),h.permanentLabel=y}function d(h){if(!h||!(h instanceof L.Polyline))return;a.clearLayers();const v=h.getLatLngs();Array.isArray(v[0])?v.forEach(S=>{S.forEach((w,M)=>c(S,M))}):v.forEach((S,w)=>c(v,w)),r=JSON.stringify(v),s=h}function m(h){!h||!(h instanceof L.Circle)||(h.permanentLabel&&a.removeLayer(h.permanentLabel),u(h))}function p(){setInterval(()=>{if(s){if(s instanceof L.Polyline)JSON.stringify(s.getLatLngs())!==r&&d(s);else if(s instanceof L.Circle){const h=JSON.stringify({center:s.getLatLng(),radius:s.getRadius()});h!==o&&(m(s),o=h)}}},500)}p(),t.on("pm:drawstart",h=>{l=!1;const v=h.workingLayer;a.clearLayers(),n.style.display="block";let S,w,M,y,_;if(h.shape==="Line")if(ot()){n.innerHTML="Tap to set first point.";let E=null,k=null;y=()=>{const A=v.getLatLngs();if(A.length>0){E=A[A.length-1];const T=t.getCenter();k&&t.removeLayer(k),k=L.polyline([E,T],{color:" #3388ff",dashArray:"5, 5",weight:3,interactive:!1}).addTo(t);const N=E.distanceTo(T),P=f.calculateBearing(E.lat,E.lng,T.lat,T.lng),x=N<1e3?`${N.toFixed(0)} m`:`${(N/1e3).toFixed(2)} km`;n.innerHTML=`In: ${P.toFixed(0)}°<br>Out: ---°<br>+: ${x}`;const C=t.getSize(),I=L.point(C.x/2+20,C.y/2-40);L.DomUtil.setPosition(n,I)}else k&&(t.removeLayer(k),k=null),n.innerHTML="Tap to set first point."},w=()=>{k&&(t.removeLayer(k),k=null),setTimeout(()=>{d(v),t.fire("move")},50)},M=()=>{setTimeout(()=>{d(v),t.fire("move")},50)},t.on("move",y),v.on("pm:vertexadded",w),v.on("pm:vertexremoved",M),_=()=>{t.off("move",y),v.off("pm:vertexadded",w),v.off("pm:vertexremoved",M),k&&(t.removeLayer(k),k=null)}}else n.innerHTML="Click to set the first point.",S=E=>{const k=v.getLatLngs();if(k.length>0){const A=k[k.length-1],T=A.distanceTo(E.latlng),N=f.calculateBearing(A.lat,A.lng,E.latlng.lat,E.latlng.lng),P=T<1e3?`${T.toFixed(0)} m`:`${(T/1e3).toFixed(2)} km`;n.innerHTML=`In: ${N.toFixed(0)}°<br>Out: ---°<br>+: ${P}`,L.DomUtil.setPosition(n,E.containerPoint.add([15,-15]))}},w=()=>{setTimeout(()=>d(v),50)},M=()=>{setTimeout(()=>{d(v)},50)},t.on("mousemove",S),v.on("pm:vertexadded",w),v.on("pm:vertexremoved",M),_=()=>{t.off("mousemove",S),v.off("pm:vertexadded",w),v.off("pm:vertexremoved",M)};else if(h.shape==="Circle")if(ot()){n.innerHTML="";const E=t.getSize(),k=L.point(E.x/2,E.y/2-40);L.DomUtil.setPosition(n,k);let A=!1;y=()=>{if(A){const T=v.getLatLng();if(T){const N=t.getCenter(),P=T.distanceTo(N);v.setRadius(P);const x=P<1e3?`${P.toFixed(0)} m`:`${(P/1e3).toFixed(2)} km`;n.innerHTML=`Radius: ${x}`;const C=t.getSize(),I=L.point(C.x/2,C.y/2-40);L.DomUtil.setPosition(n,I)}}},w=()=>{if(A)b(),m(v),s=v,o=JSON.stringify({center:v.getLatLng(),radius:v.getRadius()});else{A=!0,n.innerHTML="Move map to adjust radius. Tap again to finish.";const T=t.getSize(),N=L.point(T.x/2,T.y/2-40);L.DomUtil.setPosition(n,N),t.on("move",y)}},v.on("pm:vertexadded",w),_=()=>{t.off("move",y),v.off("pm:vertexadded",w),A=!1,n.style.display="none"}}else n.innerHTML="Click and drag to draw a circle.",S=E=>{const k=v.getLatLng();if(k){const A=k.distanceTo(E.latlng),T=A<1e3?`${A.toFixed(0)} m`:`${(A/1e3).toFixed(2)} km`;n.innerHTML=`Radius: ${T}`,L.DomUtil.setPosition(n,E.containerPoint.add([15,-15]))}},t.on("mousemove",S),_=()=>t.off("mousemove",S);const b=()=>{_&&_(),n.style.display="none"};t.once("pm:create",E=>{l=!0,b(),E.shape==="Line"&&E.layer instanceof L.Polyline?d(E.layer):E.shape==="Circle"&&E.layer instanceof L.Circle&&(m(E.layer),s=E.layer,o=JSON.stringify({center:E.layer.getLatLng(),radius:E.layer.getRadius()})),E.layer.pm&&E.layer.pm.enable()}),t.once("pm:drawend",()=>{l||(console.log("Drawing was cancelled, cleaning up visuals."),b(),a.clearLayers())})}),t.on("pm:edit",h=>{if(h.shape==="Line"&&h.layer instanceof L.Polyline)setTimeout(()=>d(h.layer),300);else if(h.shape==="Circle"&&h.layer instanceof L.Circle){if(ot()){n.style.display="block";const v=h.layer.getRadius(),S=v<1e3?`${v.toFixed(0)} m`:`${(v/1e3).toFixed(2)} km`;n.innerHTML=`Radius: ${S}`;const w=t.getSize(),M=L.point(w.x/2,w.y/2-40);L.DomUtil.setPosition(n,M)}setTimeout(()=>{m(h.layer),s=h.layer,o=JSON.stringify({center:h.layer.getLatLng(),radius:h.layer.getRadius()})},300)}}),t.on("pm:editend",()=>{ot()&&(n.style.display="none")}),t.on("pm:remove",h=>{a.clearLayers(),o=null,r=null,s=null,n.style.display="none"})}function cc(){if(!i.map){console.error("Karte nicht initialisiert in _setupCoreMapEventHandlers");return}if(!i.coordsControl){const e={enableUserInput:!1};i.coordsControl=new L.Control.Coordinates(e),i.coordsControl.addTo(i.map)}ot()?uc(i.map):dc(i.map),i.map.on("dblclick",Rn),i.map.on("zoomstart",e=>{if(!navigator.onLine){const n=e.target._zoom||i.map.getZoom();n<11?(e.target._zoom=11,i.map.setZoom(11),f.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles.")):n>14&&(e.target._zoom=14,i.map.setZoom(14),f.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."))}}),i.map.on("zoomend",()=>{const e=i.map.getZoom(),n=new CustomEvent("map:zoomend",{detail:{zoom:e},bubbles:!0,cancelable:!0});if(i.map.getContainer().dispatchEvent(n),i.jumpRunTrackLayer&&g.state.userSettings.showJumpRunTrack){const a=i.jumpRunTrackLayer.getLayers().find(r=>{var o;return((o=r.options.icon)==null?void 0:o.options.className)==="jrt-anchor-marker"});if(a){const r=e<=11?10:e<=12?12:e<=13?14:16;a.setIcon(L.divIcon({className:"jrt-anchor-marker",html:`<div style="background-color: orange; width: ${r}px; height: ${r}px; border-radius: 50%; border: 2px solid white; opacity: 0.8;"></div>`,iconSize:[r,r],iconAnchor:[r/2,r/2],tooltipAnchor:[0,-(r/2+5)]}))}}}),i.map.on("movestart",e=>{e.target===i.map&&(!e.originalEvent||e.originalEvent.target===i.map.getContainer())&&(i.isManualPanning=!0,console.log("Manual map panning detected."))}),i.map.on("contextmenu",e=>{if(g.state.userSettings.isInteractionLocked){qe("Interaction is locked. Please unlock to place a new DIP.");return}const{lat:n,lng:a}=e.latlng;console.log('MapManager: Rechtsklick/Langes Drücken erkannt. Sende "location:selected"-Event.');const r=new CustomEvent("location:selected",{detail:{lat:n,lng:a,source:"contextmenu"},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(r)});const t=i.map.getContainer();t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-Xt;if(a<300&&a>0){e.preventDefault();const o=t.getBoundingClientRect(),s=e.touches[0].clientX-o.left,l=e.touches[0].clientY-o.top,c=i.map.containerPointToLatLng([s,l]);await Rn({latlng:c,containerPoint:L.point(s,l),layerPoint:i.map.latLngToLayerPoint(c)})}Xt=n},{passive:!1}),i.map.on("click",e=>{}),i.map.on("mousedown",e=>{}),t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-Xt;if(a<300&&a>0){e.preventDefault();const o=t.getBoundingClientRect(),s=e.touches[0].clientX-o.left,l=e.touches[0].clientY-o.top,c=i.map.containerPointToLatLng([s,l]);await Rn({latlng:c,containerPoint:L.point(s,l),layerPoint:i.map.latLngToLayerPoint(c)})}Xt=n},{passive:!1}),lc(),console.log("All core map event handlers have been set up.")}function uc(t){const e=({elevation:a},r)=>{var h,v;const o=t.getCenter();if(Math.abs(o.lat-r.lat)>1e-4||Math.abs(o.lng-r.lng)>1e-4)return;const l=i.coordsControl._container.innerHTML.split("<br>")[0],c=g.getValue("heightUnit","radio","m");let u="N/A";if(a!=="N/A"){const S=f.convertHeight(a,c);u=Math.round(S)}const d=u==="N/A"?"N/A":`${u}${c}`;let m="N/A";if(a!=="N/A"&&i.weatherData&&i.weatherData.surface_pressure){const S=parseInt((h=document.getElementById("timeSlider"))==null?void 0:h.value)||0,w=i.weatherData.surface_pressure[S],M=((v=i.weatherData.temperature_2m)==null?void 0:v[S])||15,y=i.lastAltitude!=="N/A"?i.lastAltitude:0,_=f.calculateQFE(w,a,y,M);m=_!=="N/A"?`${_} hPa`:"N/A"}const p=`${l}<br>Elevation: ${d}<br>QFE: ${m}`;i.coordsControl.update(p)},n=()=>{const a=t.getCenter(),r=g.getValue("coordFormat","radio","Decimal"),o=f.convertCoords(a.lat,a.lng,r),s=r==="MGRS"?`MGRS: ${o.lat}`:`${a.lat.toFixed(5)}, ${a.lng.toFixed(5)}`;i.coordsControl.update(`${s}<br>Elevation: ...<br>QFE: ...`),f.debouncedGetElevationAndQFE(a.lat,a.lng,l=>{e(l,a)})};t.on("move",n),setTimeout(()=>t.fire("move"),200),console.log("Crosshair coordinate handler initialized.")}function dc(t){t.on("mousemove",gc),t.on("mouseout",function(){i.coordsControl&&i.coordsControl.getContainer()&&(i.coordsControl.getContainer().innerHTML="Move mouse over map")}),console.log("Mouse coordinate handler initialized.")}async function mc(t,e){const{latitude:n,longitude:a}=t.coords;console.log("MapManager: Geolocation erfolgreich. Sende Event."),i.lastLat=n,i.lastLng=a,i.lastAltitude=await f.getAltitude(n,a),i.map.setView([n,a],e);const r=new CustomEvent("location:selected",{detail:{lat:n,lng:a,source:"geolocation"},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(r)}async function fr(t,e,n){console.warn(`Geolocation error: ${t.message}`),f.handleMessage("Unable to retrieve your location. Using default location."),await vn(e[0],e[1]),i.map.setView(e,n),cn(!0),i.isManualPanning=!1;const a=new CustomEvent("location:selected",{detail:{lat:e[0],lng:e[1],source:"geolocation_fallback"},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(a),console.log("Dispatched 'location:selected' event from geolocation fallback.")}async function hc(t,e){navigator.geolocation?navigator.geolocation.getCurrentPosition(n=>mc(n,e),n=>fr(n,t,e),{enableHighAccuracy:!0,timeout:ke.GEOLOCATION_TIMEOUT_MS,maximumAge:0}):(console.warn("Geolocation not supported."),await fr({message:"Geolocation not supported by this browser."},t,e))}function fc(t){if(!i.map||!i.map.pm)return;const e=document.querySelector(".leaflet-pm-toolbar");t?(e&&(e.style.display="none"),i.map.pm.globalDrawModeEnabled()&&i.map.pm.disableDraw(),i.map.pm.globalEditModeEnabled()&&i.map.pm.disableGlobalEditMode(),i.map.pm.globalRemovalModeEnabled()&&i.map.pm.disableGlobalRemovalMode()):e&&(e.style.display="block")}function gc(t){const{lat:e,lng:n}=t.latlng;i.lastMouseLatLng={lat:e,lng:n};const a=g.getValue("coordFormat","radio","Decimal");let r;if(a==="MGRS")r=`MGRS: ${f.decimalToMgrs(e,n)||"N/A"}`;else if(a==="DMS"){const o=s=>`${s.deg}°${s.min}'${s.sec.toFixed(0)}" ${s.dir}`;r=`Lat: ${o(f.decimalToDms(e,!0))}, Lng: ${o(f.decimalToDms(n,!1))}`}else r=`Lat: ${e.toFixed(5)}, Lng: ${n.toFixed(5)}`;i.coordsControl&&i.coordsControl.update(`${r}<br>Elevation: Fetching...<br>QFE: Fetching...`),f.debouncedGetElevationAndQFE(e,n,({elevation:o})=>{var s,l;if(i.lastMouseLatLng&&i.coordsControl&&Math.abs(i.lastMouseLatLng.lat-e)<.05&&Math.abs(i.lastMouseLatLng.lng-n)<.05){const c=g.getValue("heightUnit","radio","m");let u=o==="N/A"?"N/A":Math.round(f.convertHeight(o,c)),d="N/A";if(o!=="N/A"&&i.weatherData&&i.weatherData.surface_pressure){const m=parseInt((s=document.getElementById("timeSlider"))==null?void 0:s.value)||0,p=i.weatherData.surface_pressure[m],h=((l=i.weatherData.temperature_2m)==null?void 0:l[m])||15,v=i.lastAltitude!=="N/A"?i.lastAltitude:0,S=f.calculateQFE(p,o,v,h);d=S!=="N/A"?`${S} hPa`:"N/A"}i.coordsControl.update(`${r}<br>Elevation: ${u} ${u==="N/A"?"":c}<br>QFE: ${d}`)}})}function Rn(t){if(g.state.userSettings.isInteractionLocked){qe("Interaction is locked. Please unlock to move points.");return}if(!g.state.userSettings.showCutAwayFinder)return;const{lat:e,lng:n}=t.latlng;i.cutAwayMarker?i.cutAwayMarker.setLatLng([e,n]):(i.cutAwayMarker=ql(e,n).addTo(i.map),Kl(i.cutAwayMarker)),i.cutAwayLat=e,i.cutAwayLng=n,Oo(i.cutAwayMarker,e,n);const a=new CustomEvent("cutaway:marker_placed",{bubbles:!0});i.map.getContainer().dispatchEvent(a)}function cn(t=!1){i.isManualPanning&&!t||i.map&&i.currentMarker&&i.map.panTo(i.currentMarker.getLatLng())}let Wn=null;function pc(t,e){const n=document.getElementById("windspinne-chart");if(!n)return;const a=n.getContext("2d"),r=t.map(M=>M.height),o=t.map(M=>M.dir),s=t.map(M=>f.convertWind(M.spd,"m/s","km/h")),l=Math.max(...r),c=Math.min(l,e+i.lastAltitude),u=e,d=M=>M<=5?"blue":M<=10?"green":M<=15?"orange":M<=20?"red":"purple",m=[];for(let M=i.lastAltitude;M<=c;M+=50){const y=M-i.lastAltitude;y>=0&&m.push({r:y,t:f.linearInterpolateAngle(r,o,M),speed:f.linearInterpolate(r,s,M)*1.94384})}const p=[],h=u<=4e3?200:500;for(let M=i.lastAltitude;M<=c;M+=h){const y=M-i.lastAltitude;y>=0&&p.push({r:y,t:f.linearInterpolateAngle(r,o,M),speed:f.linearInterpolate(r,s,M)*1.94384})}const v=M=>M.map(y=>({x:y.r*Math.cos((90-y.t)*Math.PI/180),y:y.r*Math.sin((90-y.t)*Math.PI/180),original:y}));Wn&&Wn.destroy(),Wn=new Chart(a,{type:"scatter",data:{datasets:[{data:v(m),showLine:!0,pointRadius:0,segment:{borderColor:M=>d((M.p0.raw.original.speed+M.p1.raw.original.speed)/2),borderWidth:2.5}},{data:v(p),showLine:!1,pointRadius:3,pointBackgroundColor:M=>d(M.raw.original.speed)}]},options:{maintainAspectRatio:!1,layout:{padding:{bottom:25,left:25,right:25}},scales:{x:{display:!1,min:-u,max:u},y:{display:!1,min:-u,max:u}},plugins:{title:{display:!0,text:"Wind chart for current location",font:{size:16},padding:{top:5,bottom:35}},legend:{display:!1},tooltip:{filter:M=>M.datasetIndex===1,callbacks:{label:M=>`${M.raw.original.r}m: ${Math.round(M.raw.original.t)}° / ${Math.round(M.raw.original.speed)} kt`}}}},plugins:[{id:"polarGrid",beforeDraw:M=>{const{ctx:y,scales:{x:_,y:b}}=M;if(!M.chartArea)return;const E=_.getPixelForValue(0),k=b.getPixelForValue(0);y.save(),y.font="10px Roboto";const A=u<=4e3?200:500,T=1e3;y.strokeStyle="#eee",y.lineWidth=.5;for(let x=A;x<=u;x+=A)if(x%T!==0){const C=Math.abs(_.getPixelForValue(x)-E),I=Math.abs(b.getPixelForValue(x)-k);y.beginPath(),y.ellipse(E,k,C,I,0,0,2*Math.PI),y.stroke()}y.strokeStyle="#ccc",y.lineWidth=1.5;for(let x=T;x<=u;x+=T){const C=Math.abs(_.getPixelForValue(x)-E),I=Math.abs(b.getPixelForValue(x)-k);y.beginPath(),y.ellipse(E,k,C,I,0,0,2*Math.PI),y.stroke(),y.fillStyle="#666",y.fillText(`${x}m`,E+5,k-I-5)}const N=(M.chartArea.right-M.chartArea.left)/2,P=(M.chartArea.bottom-M.chartArea.top)/2;y.strokeStyle="#ccc",y.lineWidth=1;for(let x=0;x<360;x+=30){const C=(x-90)*(Math.PI/180);y.beginPath(),y.moveTo(E,k),y.lineTo(E+N*Math.cos(C),k+P*Math.sin(C)),y.stroke(),y.save(),y.translate(E+(N+15)*Math.cos(C),k+(P+15)*Math.sin(C)),y.rotate(C+Math.PI/2),y.textAlign="center",y.fillText(`${x}°`,0,0),y.restore()}y.restore()}}]});const S=document.getElementById("windspinne-legend");S.innerHTML="",[{speed:"0-5 kt",color:"blue"},{speed:"6-10 kt",color:"green"},{speed:"11-15 kt",color:"orange"},{speed:"16-20 kt",color:"red"},{speed:"> 20 kt",color:"purple"}].forEach(M=>{const y=document.createElement("div");y.className="legend-item",y.innerHTML=`<div class="legend-color-box" style="background-color: ${M.color};"></div><span>${M.speed}</span>`,S.appendChild(y)})}async function Be(t,e,n,a=null){var T,N,P,x,C;console.log(`updateWeatherDisplay called for index: ${t} -> into ${e}`);const r=document.getElementById(e),o=document.getElementById(n);if(!r||!o){console.error("Target container(s) for weather display not found!",{tableContainerId:e,timeContainerId:n});return}if(!i.weatherData||!i.weatherData.time||t<0||t>=i.weatherData.time.length){console.error("No weather data available or index out of bounds:",t),r.innerHTML='<p style="padding: 20px; text-align: center;">No weather data available</p>',o.innerHTML="Selected Time: ";const I=document.getElementById("timeSlider");I&&(I.value=0);return}const s=(T=i.weatherData.visibility)==null?void 0:T[t],l=(N=i.weatherData.weather_code)==null?void 0:N[t],c=f.translateWmoCodeToTaf(l);console.log(`--- Bodenwetter für Index ${t} ---`),console.log(`Sichtweite (Visibility): ${s??"N/A"} m`),console.log(`Wetter-Code (WMO 4677): ${l??"N/A"} (${c})`),console.log("---------------------------------"),i.landingWindDir=i.weatherData.wind_direction_10m[t]||null,console.log("landingWindDir updated to:",i.landingWindDir);const u=document.getElementById("customLandingDirectionLL"),d=document.getElementById("customLandingDirectionRR");u&&d&&i.landingWindDir!==null&&(u.value=Math.round(i.landingWindDir),d.value=Math.round(i.landingWindDir));const m=((P=document.getElementById("refLevel"))==null?void 0:P.value)||"AGL",p=g.getValue("heightUnit","radio","m"),h=g.getValue("windUnit","radio","kt"),v=g.getValue("temperatureUnit","radio","C"),S=g.getValue("timeZone","radio","Z"),w=await f.getDisplayTime(i.weatherData.time[t],i.lastLat,i.lastLng,S),M=Ce(),y=Se(i.weatherData,t,M,Math.round(i.lastAltitude),p),_=m==="AMSL"&&i.lastAltitude!=="N/A"?Math.round(i.lastAltitude):0,b=parseInt((x=document.getElementById("upperLimit"))==null?void 0:x.value)||3e3,k=y.filter(I=>I.displayHeight<=b).map(I=>{const O=parseFloat(I.spd);let R="";if(h==="bft"){const ee=f.convertWind(O,"kt","km/h"),ie=f.knotsToBeaufort(ee);ie<=1?R="wind-low":ie<=3?R="wind-moderate":ie<=4?R="wind-high":R="wind-very-high"}else{const ee=f.convertWind(O,"kt","km/h");ee<=3?R="wind-low":ee<=10?R="wind-moderate":ee<=16?R="wind-high":R="wind-very-high"}const W=I.cc;let z="";W!=="N/A"&&Number.isFinite(W)&&(W<=10?z="cloud-cover-clear":W<=25?z="cloud-cover-few":W<=50?z="cloud-cover-scattered":W<=87?z="cloud-cover-broken":z="cloud-cover-overcast");const $=m==="AMSL"?I.displayHeight+(p==="ft"?Math.round(_*3.28084):_):I.displayHeight,V=f.convertTemperature(I.temp,v==="C"?"°C":"°F"),B=V==="N/A"?"N/A":V.toFixed(0),J=f.convertWind(O,h,"km/h");let X;const ue=m==="AMSL"?p==="ft"?Math.round(_*3.28084):_:0;if(Math.round($)===ue&&i.weatherData.wind_gusts_10m[t]!==void 0&&Number.isFinite(i.weatherData.wind_gusts_10m[t])){const ee=i.weatherData.wind_gusts_10m[t],ie=f.convertWind(ee,h,"km/h"),ye=h==="bft"?Math.round(J):J.toFixed(0),Ie=h==="bft"?Math.round(ie):ie.toFixed(0);X=`${ye} G ${Ie}`}else X=J==="N/A"?"N/A":h==="bft"?Math.round(J):J.toFixed(0);const q=Math.round(f.convertWind(O,"kt","km/h")/5)*5,oe=I.dir==="N/A"||isNaN(q)?"N/A":f.generateWindBarb(I.dir,q);return`<tr class="${R} ${z}">
                    <td>${Math.round($)}</td>
                    <td>${f.roundToTens(I.dir)}</td>
                    <td>${X}</td>
                    <td>${oe}</td>
                    <td>${B}</td>
                    <td>${Math.round(I.rh)}</td>
                    <td>${I.cc}</td> <!-- NEUE SPALTE für Wolkenbedeckung -->
                </tr>`}).join(""),A=`
        <table id="weatherTable">
            <thead>
                <tr>
                    <th>Height (${p} ${m})</th>
                    <th>Dir (deg)</th>
                    <th>Spd (${h})</th>
                    <th>Wind</th>
                    <th>T (${v==="C"?"°C":"°F"})</th>
                    <th>RH (%)</th>
                    <th>CC (%)</th> <!-- NEUE SPALTE für Wolkenbedeckung -->
                </tr>
            </thead>
            <tbody>
                ${k}
            </tbody>
        </table>`;if(r.innerHTML=A,o.innerHTML=`Selected Time: ${w}`,y.length>0){const I=parseInt((C=document.getElementById("upperLimit"))==null?void 0:C.value)||3e3;pc(y,I)}}async function ze(){var p;if(!i.currentMarker||i.lastLat===null)return;const t=i.lastLat,e=i.lastLng,n=i.lastAltitude,a=g.getValue("heightUnit","radio","m");let r="N/A",o="";n!=="N/A"&&(a==="ft"?(r=Math.round(f.convertHeight(n,"ft")),o="ft"):(r=n,o="m"));const s=g.getValue("coordFormat","radio","Decimal"),l=Fo(),c=(p=i.weatherData.weather_code)==null?void 0:p[l],u=f.translateWmoCodeToTaf(c),d=f.convertCoords(t,e,s);let m;if(s==="MGRS")m=`MGRS: ${d.lat}<br>Alt: ${r} ${o}`;else{const h=v=>`${v.deg}°${v.min}'${v.sec.toFixed(0)}" ${v.dir}`;s==="DMS"?m=`Lat: ${h(f.decimalToDms(t,!0))}<br>Lng: ${h(f.decimalToDms(e,!1))}<br>Alt: ${r} ${o}`:m=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${r} ${o}`}if(i.weatherData&&i.weatherData.surface_pressure){const h=i.weatherData.surface_pressure[l];h?m+=` QFE: ${h.toFixed(0)} hPa`:m+=" QFE: N/A",u&&u!=="N/A"&&u!=="SKC"&&(m+=`<br>Weather: ${u}`)}else m+=" QFE: N/A";ba(i.currentMarker,m)}function yc(){const t=document.getElementById("modelInfoPopup"),e=document.getElementById("modelSelect");if(!t||!e)return;const n=e.value,a=i.lastModelRun||"N/A",r=`Model: ${n.replace(/_/g," ").toUpperCase()}\\nRun: ${a}`;t.innerHTML=r.replace(/\\n/g,"<br>")}async function Uo(){const t=document.getElementById("timeSlider"),e=document.getElementById("slider-labels");if(!t||!e||!i.weatherData||!i.weatherData.time){e&&(e.innerHTML="");return}e.innerHTML="";const n=i.weatherData.time,a=parseInt(t.max,10);if(a<=0)return;const r=g.getValue("timeZone","radio","Z");let o="utc";r==="loc"&&i.lastLat&&(o=(await f.getLocationData(i.lastLat,i.lastLng)).timezone||"utc");let s=null;for(let l=0;l<n.length;l++){const c=n[l],u=F.fromISO(c,{zone:"utc"}).setZone(o),d=u.day;if(d!==s){let m=l,p=Math.abs(u.hour);for(let h=1;h<4&&l+h<n.length;h++){const v=F.fromISO(n[l+h],{zone:"utc"}).setZone(o);if(v.day===d)Math.abs(v.hour)<p&&(p=Math.abs(v.hour),m=l+h);else break}if(d!==s){const h=document.createElement("div");h.className="slider-label",h.textContent=u.toFormat("MMM dd");const v=m/a*100;m===0?(h.style.left="0",h.style.transform="translateX(0)"):v>98?(h.style.left="100%",h.style.transform="translateX(-100%)"):(h.style.left=`${v}%`,h.style.transform="translateX(0)"),e.appendChild(h),s=d}}}}function _e(){if(!i.currentMarker||typeof i.currentMarker.getLatLng!="function")return;const t=i.currentMarker.getLatLng();if(!t)return;if(!g.state.userSettings.showLandingPattern||!i.weatherData||i.map.getZoom()<ke.LANDING_PATTERN_MIN_ZOOM){Ct(null);return}const e=parseInt(document.getElementById("timeSlider").value)||0,n=Ce(),a=g.getValue("heightUnit","m"),r=g.getValue("windUnit","kt"),o=Math.round(i.lastAltitude),s=Se(i.weatherData,e,n,o,a);if(!s||s.length===0){Ct(null);return}const l=wn(t.lat,t.lng,s);if(!l){Ct(null);return}const{downwindStart:c,baseStart:u,finalStart:d,landingPoint:m}=l,p=s.map(T=>T.height),h=s.map(T=>-f.convertWind(T.spd,"kt","km/h")*Math.sin(T.dir*Math.PI/180)),v=s.map(T=>-f.convertWind(T.spd,"kt","km/h")*Math.cos(T.dir*Math.PI/180)),S=parseInt(document.getElementById("legHeightFinal").value)||100,w=parseInt(document.getElementById("legHeightBase").value)||200,M=parseInt(document.getElementById("legHeightDownwind").value)||300,y=f.calculateMeanWind(p,h,v,o,o+S),_=f.calculateMeanWind(p,h,v,o+S,o+w),b=f.calculateMeanWind(p,h,v,o+w,o+M),E=T=>T<=3?"lightblue":T<=10?"lightgreen":T<=16?"#f5f34f":"#ffcccc",k=T=>{const N=f.convertWind(T,r,"kt");return r==="bft"?Math.round(N):N.toFixed(1)},A={legs:[{path:[m,d]},{path:[d,u]},{path:[u,c]}],arrows:[{position:[(m[0]+d[0])/2,(m[1]+d[1])/2],bearing:(y[0]-90+180)%360,color:E(y[1]),tooltipText:`${Math.round(y[0])}° ${k(y[1])} ${r}`},{position:[(d[0]+u[0])/2,(d[1]+u[1])/2],bearing:(_[0]-90+180)%360,color:E(_[1]),tooltipText:`${Math.round(_[0])}° ${k(_[1])} ${r}`},{position:[(u[0]+c[0])/2,(u[1]+c[1])/2],bearing:(b[0]-90+180)%360,color:E(b[1]),tooltipText:`${Math.round(b[0])}° ${k(b[1])} ${r}`}]};Ct(A)}function he(){var c,u,d,m,p,h,v,S;if(console.log("updateJumpRunTrackDisplay called"),!i.map){console.warn("Map not initialized, cannot update jump run track display");return}if(!(g.state.userSettings.showJumpRunTrack&&i.weatherData&&i.lastLat&&i.lastLng&&g.state.userSettings.calculateJump)){console.log("Conditions not met to show JRT, clearing display."),Pt(null),i.lastTrackData=null;const w=document.getElementById("jumpRunTrackDirection");w&&!g.state.userSettings.customJumpRunDirection&&(w.value="");return}const e=Fo(),n=Ce(),a=g.getValue("heightUnit","radio","m"),r=Se(i.weatherData,e,n,Math.round(i.lastAltitude),a),o=i.harpMarker?i.harpMarker.getLatLng():null,s=wa(r,o),l=document.getElementById("jumpRunTrackDirection");if(s&&((c=s.latlngs)==null?void 0:c.length)===2&&s.latlngs.every(w=>Number.isFinite(w[0])&&Number.isFinite(w[1]))){console.log("Drawing jump run track with data:",s),l&&!g.state.userSettings.customJumpRunDirection&&(l.value=s.direction);const w={path:{latlngs:s.latlngs,options:{color:"orange",weight:5,opacity:.8},tooltipText:`Jump Run: ${s.direction}°, ${s.trackLength} m`,originalLatLngs:((d=(u=i.lastTrackData)==null?void 0:u.latlngs)==null?void 0:d.length)===2?i.lastTrackData.latlngs:s.latlngs},approachPath:((m=s.approachLatLngs)==null?void 0:m.length)===2&&s.approachLatLngs.every(M=>Number.isFinite(M[0])&&Number.isFinite(M[1]))?{latlngs:s.approachLatLngs,options:{color:"orange",weight:5,opacity:.8,dashArray:"5, 10"},tooltipText:`Approach: ${s.direction}°, ${s.approachLength} m`,originalLatLngs:((h=(p=i.lastTrackData)==null?void 0:p.approachLatLngs)==null?void 0:h.length)===2?i.lastTrackData.approachLatLngs:s.approachLatLngs}:null,trackLength:s.trackLength,airplane:{position:L.latLng(s.latlngs[1][0],s.latlngs[1][1]),bearing:s.direction,originalPosition:(S=(v=i.lastTrackData)==null?void 0:v.latlngs)!=null&&S[1]&&Number.isFinite(i.lastTrackData.latlngs[1][0])?L.latLng(i.lastTrackData.latlngs[1][0],i.lastTrackData.latlngs[1][1]):L.latLng(s.latlngs[1][0],s.latlngs[1][1])}};Pt(w),i.lastTrackData={latlngs:s.latlngs,approachLatLngs:s.approachLatLngs,direction:s.direction,trackLength:s.trackLength,approachLength:s.approachLength},console.log("Updated AppState.lastTrackData:",i.lastTrackData)}else console.warn("No valid track data to display:",s),Pt(null),i.lastTrackData=null,l&&!g.state.userSettings.customJumpRunDirection&&(l.value="")}let je=JSON.parse(localStorage.getItem("searchCache"))||{},Un=!1;async function wc(t){if(!t.trim())return[];const e=Bo(t);if(e)return[{display_name:`Coordinate: ${e.lat.toFixed(5)}, ${e.lng.toFixed(5)}`,lat:e.lat,lon:e.lng,type:"coordinate"}];if(je[t])return je[t];try{const n=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(t)}&count=10&language=de&format=json`,a=await fetch(n);if(!a.ok)throw new Error(`Geocoding API Error: ${a.statusText}`);const r=await a.json();if(!r.results)return[];const o=r.results.map(s=>({display_name:[s.name,s.admin1,s.country].filter(Boolean).join(", "),lat:s.latitude,lon:s.longitude}));return je[t]=o,localStorage.setItem("searchCache",JSON.stringify(je)),o}catch(n){return console.error("Search failed:",n),f.handleError("Could not find location. Please check network."),[]}}async function vc(t,e,n,a){if(console.log("findParachutingPOIs: Searching for POIs in bbox:",{minLat:t,minLon:e,maxLat:n,maxLon:a}),isNaN(t)||isNaN(e)||isNaN(n)||isNaN(a)||t<-90||n>90||e<-180||a>180||t>n||e>a)return console.error("findParachutingPOIs: Invalid bounding box coordinates"),f.handleError("Invalid map bounds for POI search."),[];const r=`parachutingPOIs_${t}_${e}_${n}_${a}`;if(je[r])return console.log("findParachutingPOIs: Returning cached results for bbox:",r),je[r];try{const o=`
            [out:json][timeout:50][bbox:${t},${e},${n},${a}];
            (
                nwr["sport"="parachuting"];
                nwr[~"^(name|description|alt_name|official_name)$"~"Skydiv|Fallschirm|Dropzone|Sprungplatz|Tandemspr", i];
                nwr["aeroway"~"aerodrome|airfield"]["service"~"skydiving|parachuting", i];
            );
            out center;
        `,s=`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(o)}`;console.log("findParachutingPOIs: Sending Overpass query:",o);const l=await fetch(s);if(!l.ok)throw new Error(`Overpass API Error: ${l.statusText}`);const c=await l.json();console.log("findParachutingPOIs: Raw Overpass response:",c);const u=c.elements.map(p=>{var S,w;const h=p.tags||{};return{display_name:[h.name,h["addr:street"]||h.street,h["addr:city"]||h.city,h["addr:state"]||h.state,h["addr:country"]||h.country,h.sport?`(${h.sport})`:null,h.aeroway==="aerodrome"?"(Airfield)":null].filter(Boolean).join(", ")||"Unnamed Parachuting Location",lat:p.lat||((S=p.center)==null?void 0:S.lat),lon:p.lon||((w=p.center)==null?void 0:w.lon),type:h.sport||h.aeroway||h.leisure||"parachuting"}}),d=[],m=new Set;for(const p of u){const h=`${p.lat.toFixed(5)}_${p.lon.toFixed(5)}`;m.has(h)||(m.add(h),d.push(p))}return console.log("findParachutingPOIs: Caching results for bbox:",r),je[r]=d,localStorage.setItem("searchCache",JSON.stringify(je)),d.length===0?(console.log("findParachutingPOIs: No parachuting POIs found in bbox"),f.handleMessage("No parachuting locations found in this area.")):(console.log("findParachutingPOIs: Found POIs:",d),f.handleMessage(`Found ${d.length} parachuting location(s) in this area.`)),d}catch(o){return console.error("findParachutingPOIs: Search failed:",o),f.handleError("Could not find parachuting locations. Please check network."),[]}}function Ho(t,e,n,a=!1){if(console.log("addCoordToHistory: Adding:",{lat:t,lng:e,label:n,isFavorite:a}),isNaN(t)||isNaN(e)){console.error("addCoordToHistory: Invalid coordinates");return}let r=Ke();const o=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5));r=r.filter(u=>Math.abs(u.lat-o)>.001||Math.abs(u.lng-s)>.001),r.unshift({lat:o,lng:s,label:n,isFavorite:a,timestamp:Date.now()});const l=r.filter(u=>u.isFavorite),c=r.filter(u=>!u.isFavorite).slice(0,5);Ln([...l,...c])}function Lc(t,e,n,a=!1){if(console.log("addOrUpdateFavorite: Processing:",{lat:t,lng:e,name:n}),isNaN(t)||isNaN(e)){console.error("addOrUpdateFavorite: Invalid coordinates");return}if(Un){console.log("addOrUpdateFavorite: Blocked due to ongoing operation");return}Un=!0;try{let r=Ke();const o=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5)),l=r.find(c=>Math.abs(c.lat-o)<.001&&Math.abs(c.lng-s)<.001);if(l)console.log("addOrUpdateFavorite: Updating existing entry:",l),l.isFavorite=!0,l.label=n;else{const c={lat:o,lng:s,label:n,isFavorite:!0,timestamp:Date.now()};console.log("addOrUpdateFavorite: Adding new entry:",c),r.unshift(c)}Ln(r),a||f.handleMessage(`"${n}" saved as favorite.`),Ea()}catch(r){console.error("addOrUpdateFavorite: Error:",r)}finally{Un=!1,console.log("addOrUpdateFavorite: Completed")}}function Mc(t,e,n,a){let r=Ke();const o=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5)),l=r.find(c=>Math.abs(c.lat-o)<1e-4&&Math.abs(c.lng-s)<1e-4);l&&(l.isFavorite=a),Ln(r),Ea(),f.handleMessage(`"${n}" removed from favorites.`)}function Sc(t,e){if(console.log("removeLocationFromHistory: Removing:",{lat:t,lng:e}),isNaN(t)||isNaN(e)){console.error("removeLocationFromHistory: Invalid coordinates");return}const a=Ke().filter(r=>{const o=parseFloat(r.lat),s=parseFloat(r.lng||r.lon);return Math.abs(o-t)>.001||Math.abs(s-e)>.001});Ln(a),f.handleMessage("Location deleted."),Ea()}function Ke(){console.log("getCoordHistory: Retrieving history");try{const t=JSON.parse(localStorage.getItem("coordHistory"))||[];return console.log("getCoordHistory: History retrieved:",t),t}catch(t){return console.error("getCoordHistory: Error retrieving history:",t),[]}}function Ln(t){console.log("saveCoordHistory: Saving history:",t);try{localStorage.setItem("coordHistory",JSON.stringify(t)),console.log("saveCoordHistory: History saved")}catch(e){console.error("saveCoordHistory: Error saving history:",e)}}function Bo(t){console.log("parseQueryAsCoordinates: Parsing query:",t);const e=t.trim(),a=e.replace(/[,;\t]+/g," ").trim().match(/^(-?\d{1,3}(?:\.\d+)?)\s+(-?\d{1,3}(?:\.\d+)?)$/);if(a){console.log("parseQueryAsCoordinates: Regex match:",a);const s=parseFloat(a[1]),l=parseFloat(a[2]);if(console.log("parseQueryAsCoordinates: Decimal degrees detected:",{lat:s,lng:l}),!isNaN(s)&&!isNaN(l)&&s>=-90&&s<=90&&l>=-180&&l<=180)return{lat:s,lng:l};console.warn("parseQueryAsCoordinates: Invalid coordinate ranges:",{lat:s,lng:l})}const r=e.replace(/\s/g,"").toUpperCase(),o=/^[0-9]{1,2}[C-HJ-NP-X][A-HJ-NP-Z]{2}(\d{2}|\d{4}|\d{6}|\d{8}|\d{10})$/;if(typeof sl>"u")return console.warn("parseQueryAsCoordinates: MGRS library not loaded"),null;if(o.test(r))try{const[s,l]=pa(r);if(console.log("parseQueryAsCoordinates: MGRS detected:",{lat:l,lng:s}),!isNaN(l)&&!isNaN(s))return{lat:l,lng:s};console.warn("parseQueryAsCoordinates: Invalid MGRS coordinates:",{lat:l,lng:s})}catch(s){return console.warn("parseQueryAsCoordinates: MGRS parsing failed:",s.message),null}return console.log("parseQueryAsCoordinates: No coordinates detected"),null}function Ea(){console.log("_dispatchFavoritesUpdate: Dispatching event");const e=Ke().filter(a=>a.isFavorite),n=new CustomEvent("favorites:updated",{detail:{favorites:e},bubbles:!0,cancelable:!0});document.dispatchEvent(n),console.log("_dispatchFavoritesUpdate: Event dispatched")}let De=null;function _a(){const t=document.getElementById("locationSearchInput"),e=document.getElementById("locationResults"),n=document.getElementById("clearSearchInput"),a=document.getElementById("saveFavoriteBtn"),r=document.getElementById("favoriteModal"),o=document.getElementById("favoriteNameInput"),s=document.getElementById("submitFavoriteName"),l=document.getElementById("cancelFavoriteName");if(!t||!e||!a||!r){console.error("Einige UI-Elemente für die Ortssuche wurden nicht gefunden.");return}const c=f.debounce(_c,300);t.addEventListener("input",()=>{c(t.value),n.style.display=t.value.trim()?"block":"none"}),n.addEventListener("click",()=>{t.value="",n.style.display="none",it(),t.focus()}),a.addEventListener("click",()=>{if(i.lastLat===null||i.lastLng===null){f.handleError("Please select a location on the map first.");return}De={lat:i.lastLat,lng:i.lastLng,defaultName:`DIP at ${i.lastLat.toFixed(4)}, ${i.lastLng.toFixed(4)}`},o.value=De.defaultName,r.style.display="flex"}),s.addEventListener("click",()=>{if(De){const u=o.value.trim()||De.defaultName;Lc(De.lat,De.lng,u),it()}r.style.display="none",De=null}),l.addEventListener("click",()=>{r.style.display="none",De=null}),it()}function it(t=[]){const e=document.getElementById("locationResults");if(!e)return;e.innerHTML="";const n=Ke(),a=n.filter(s=>s.isFavorite),r=n.filter(s=>!s.isFavorite),o=(s,l)=>{if(l.length===0)return;const c=document.createElement("div");c.className="search-section";const u=document.createElement("h5");u.textContent=s,c.appendChild(u);const d=document.createElement("ul");l.forEach(m=>{const p=bc(m);p&&d.appendChild(p)}),c.appendChild(d),e.appendChild(c)};o("Results",t),o("Favorites",a),o("Recent Searches",r)}function bc(t){const e=parseFloat(t.lat),n=parseFloat(t.lng||t.lon);if(isNaN(e)||isNaN(n))return null;const a=document.createElement("li");a.className="search-item",a.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("location:selected",{detail:{lat:e,lng:n,source:"search"},bubbles:!0})),Ho(e,n,t.display_name||t.label,t.isFavorite)});const r=document.createElement("span");r.className="search-item-text",r.innerHTML=`<span class="name">${t.display_name||t.label}</span>`,a.appendChild(r);const o=document.createElement("div");o.className="search-item-actions";const s=document.createElement("button");s.className=`favorite-toggle ${t.isFavorite?"is-favorite":""}`,s.innerHTML="★",s.title="Toggle favorite",s.addEventListener("click",c=>{c.stopPropagation(),Ec(e,n,t.display_name||t.label)}),o.appendChild(s);const l=document.createElement("button");return l.className="delete-btn",l.textContent="×",l.title="Delete this entry",l.addEventListener("click",c=>{c.stopPropagation(),confirm(`Delete "${t.display_name||t.label}"?`)&&(Sc(e,n),it())}),o.appendChild(l),a.appendChild(o),a}function Ec(t,e,n){const a=Ke().find(o=>Math.abs(o.lat-t)<1e-4&&Math.abs(o.lng-e)<1e-4);if(a&&a.isFavorite)Mc(t,e,n,!1),it();else{De={lat:t,lng:e,defaultName:n};const o=document.getElementById("favoriteModal"),s=document.getElementById("favoriteNameInput");s.value=n,o.style.display="flex"}}async function _c(t){if(!t.trim()){it();return}const e=await wc(t);it(e)}const kc=Object.freeze(Object.defineProperty({__proto__:null,initializeLocationSearch:_a},Symbol.toStringTag,{value:"Module"})),Tc=null,Ac=null,Cc=null;let Hn=null;async function Ic(){return window.Capacitor&&window.Capacitor.isNativePlatform()?{Geolocation:Tc,Filesystem:Ac,Directory:Cc,isNative:!0}:{Geolocation:null,Filesystem:null,Directory:null,isNative:!1}}function Et(){return Hn||(Hn=Ic()),Hn}async function Nc(t){if(!i.map)return f.handleError("Map not initialized."),null;i.isLoadingGpx=!0;try{const e=await Ta(t),a=new DOMParser().parseFromString(e,"text/xml"),r=toGeoJSON.kml(a),o=[];if(L.geoJSON(r,{onEachFeature:function(l,c){const u=l.properties.coordTimes||l.properties.times;l.geometry&&l.geometry.type==="LineString"&&l.geometry.coordinates.forEach((d,m)=>{const[p,h,v]=d;let S=null;if(u&&u[m]){const w=u[m];let M=null;w&&(w.includes(".")?M=w.split(".")[0]+"Z":M=w),S=M?F.fromISO(M,{zone:"utc"}):null}o.push({lat:h,lng:p,ele:v||null,time:S})})}}),o.length<2)throw new Error("KML file contains no valid track with at least two points.");return await ka(o,t.name)}catch(e){return console.error("[trackManager] Error in loadKmlTrack:",e),f.handleError("Error parsing KML file: "+e.message),null}finally{i.isLoadingGpx=!1}}async function Pc(t){var e,n;if(!i.map)return f.handleError("Map not initialized."),null;i.isLoadingGpx=!0;try{const a=await Ta(t),s=new DOMParser().parseFromString(a,"text/xml").getElementsByTagName("trkpt"),l=[];for(let u=0;u<s.length;u++){const d=parseFloat(s[u].getAttribute("lat")),m=parseFloat(s[u].getAttribute("lon"));if(isNaN(d)||isNaN(m))continue;const p=(e=s[u].getElementsByTagName("ele")[0])==null?void 0:e.textContent,h=(n=s[u].getElementsByTagName("time")[0])==null?void 0:n.textContent;let v=null;h&&(h.includes(".")?v=h.split(".")[0]+"Z":v=h),l.push({lat:d,lng:m,ele:p?parseFloat(p):null,time:v?F.fromISO(v,{zone:"utc"}):null})}if(l.length<2)throw new Error("GPX track has insufficient points.");return await ka(l,t.name)}catch(a){return console.error("[trackManager] Error in loadGpxTrack:",a),f.handleError("Error parsing GPX file: "+a.message),null}finally{i.isLoadingGpx=!1}}async function Dc(t){if(!i.map)return f.handleError("Map not initialized."),null;i.isLoadingGpx=!0;try{const e=await Ta(t);return new Promise(async(n,a)=>{const r=[];Papa.parse(e,{skipEmptyLines:!0,step:function(o){const s=o.data;if(s[0]&&s[0].toUpperCase()==="$GNSS"&&s.length>=5){let l=s[1];const c=parseFloat(s[2]),u=parseFloat(s[3]),d=parseFloat(s[4]);if(isNaN(c)||isNaN(u)||isNaN(d))return;let m=null;l&&(l.includes(".")?m=l.split(".")[0]+"Z":m=l);let p=null;try{p=F.fromISO(m,{setZone:!0}).toUTC(),p.isValid||(p=null)}catch{p=null}r.push({lat:c,lng:u,ele:d,time:p})}},complete:async function(){if(r.length<2){a(new Error("CSV track has insufficient points."));return}const o=await ka(r,t.name);n(o)},error:function(o){a(new Error("Error parsing CSV: "+o.message))}})})}catch(e){return console.error("[trackManager] Error in loadCsvTrackUTC:",e),f.handleError("Error reading or parsing CSV file: "+e.message),null}finally{i.isLoadingGpx=!1}}async function Fc(t,e,n){if(console.log("--- GPX EXPORT DEBUG START ---"),!Settings.getValue("showJumpRunTrack",!1)){f.handleError("Activate 'Show Jump Run Track' to export the track.");return}if(!i.weatherData||!i.lastLat||!i.lastLng||i.lastAltitude==="N/A"){f.handleError("Wetterdaten oder DIP-Position nicht verfügbar. GPX-Export nicht möglich.");return}const a=i.lastLat,r=i.lastLng,o=Math.round(i.lastAltitude),s=i.harpMarker?i.harpMarker.getLatLng():null;let l=null;s&&(l=await f.getAltitude(s.lat,s.lng),l=l!=="N/A"?Math.round(l):null);const c=Se(i.weatherData,t,e,o,n);if(!c||c.length===0){f.handleError("Keine Wetterdaten für die GPX-Erstellung verfügbar.");return}const u=wa(c,s);if(!u||!u.latlngs||!u.approachLatLngs){f.handleError("Jump Run Track konnte nicht berechnet werden.");return}const[d,m]=u.approachLatLngs[1],[p,h]=u.latlngs[0],[v,S]=u.latlngs[1],w=Settings.getValue("exitAltitude",3e3),M=o+w;let y=`<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<gpx version="1.1" creator="DZMaster" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
  <metadata>
    <name>Jump Run - ${new Date().toLocaleString()}</name>
    <desc>Generated by DZMaster. Jump Run Direction: ${u.direction}°</desc>
  </metadata>
`;y+=`  <wpt lat="${a}" lon="${r}">
    <name>DIP</name>
    <ele>${o}</ele>
    <sym>Flag, Blue</sym>
  </wpt>
`,s&&l!==null&&(y+=`  <wpt lat="${s.lat}" lon="${s.lng}">
    <name>HARP</name>
    <ele>${l}</ele>
    <sym>Flag, Green</sym>
  </wpt>
`),y+=`  <wpt lat="${d}" lon="${m}">
    <name>x-2, ${u.direction}°</name>
    <ele>${M}</ele>
    <sym>Airplane</sym>
  </wpt>
`,y+=`  <wpt lat="${p}" lon="${h}">
    <name>First Out ${w} m AGL</name>
    <ele>${M}</ele>
    <sym>Airplane</sym>
  </wpt>
`,y+=`  <wpt lat="${v}" lon="${S}">
    <name>Last Out</name>
    <ele>${M}</ele>
    <sym>Airplane</sym>
  </wpt>
`,y+=`  <trk>
    <name>Jump Run and Approach</name>
    <trkseg>
`,y+=`      <trkpt lat="${d}" lon="${m}"><ele>${M}</ele></trkpt>
`,y+=`      <trkpt lat="${p}" lon="${h}"><ele>${M}</ele></trkpt>
`,y+=`      <trkpt lat="${v}" lon="${S}"><ele>${M}</ele></trkpt>
`,y+=`    </trkseg>
  </trk>
</gpx>`;const b=`${f.formatTime(i.weatherData.time[t]).replace(/ /g,"_").replace(/:/g,"")}_JumpRun_Track.gpx`;try{const{Filesystem:E,Directory:k,isNative:A}=await Et();if(A&&E)await E.writeFile({path:`DZMaster/${b}`,data:y,directory:k.Documents,encoding:"utf8",recursive:!0}),f.handleMessage("GPX saved in Documents/DZMaster");else{const T=new Blob([y],{type:"application/gpx+xml;charset=utf-8"}),N=window.URL.createObjectURL(T),P=document.createElement("a");P.href=N,P.download=b,document.body.appendChild(P),P.click(),document.body.removeChild(P),window.URL.revokeObjectURL(N)}}catch(E){console.error("Error saving GPX file:",E),f.handleError("Could not save GPX file.")}}async function xc(){var _;console.log("--- GPX Landing Pattern Export gestartet ---");const t=parseInt((_=document.getElementById("timeSlider"))==null?void 0:_.value)||0,e=Settings.getValue("interpStep","select",200),n=Settings.getValue("heightUnit","m");if(!Settings.getValue("showLandingPattern",!1)){f.handleError("Activate 'Landing Pattern' before export.");return}if(!i.weatherData||!i.lastLat||!i.lastLng||i.lastAltitude==="N/A"){f.handleError("Wetterdaten oder DIP-Position für GPX-Export nicht verfügbar.");return}console.log("Schritt 1: Vorbedingungen erfüllt. Wetterdaten und Position vorhanden.");const a=weatherManager.interpolateWeatherData(i.weatherData,t,e,Math.round(i.lastAltitude),n);if(!a||a.length===0){f.handleError("Fehler in Schritt 2: Keine interpolierten Wetterdaten für GPX-Erstellung verfügbar.");return}console.log("Schritt 2: Wetterdaten erfolgreich interpoliert.");const r=wn(i.lastLat,i.lastLng,a);if(console.log("Schritt 3: Ergebnis von calculateLandingPatternCoords:",r),!r){f.handleError("Fehler in Schritt 3: calculateLandingPatternCoords hat keine Daten zurückgegeben. Export abgebrochen.");return}console.log("Schritt 3: Koordinaten des Landemusters erfolgreich berechnet.");const{downwindStart:o,baseStart:s,finalStart:l,landingPoint:c}=r,u=Math.round(i.lastAltitude),d=Settings.getValue("legHeightDownwind",300),m=Settings.getValue("legHeightBase",200),p=Settings.getValue("legHeightFinal",100),h=u+d,v=u+m,S=u+p;let w=`<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<gpx version="1.1" creator="DZMaster" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
  <metadata>
    <name>Landing Pattern - ${new Date().toLocaleString()}</name>
    <desc>Generated by DZMaster Application.</desc>
  </metadata>
`;w+=`  <wpt lat="${o[0]}" lon="${o[1]}"><name>Downwind ${d} m AGL</name><ele>${h}</ele></wpt>
`,w+=`  <wpt lat="${s[0]}" lon="${s[1]}"><name>Base ${m} m AGL</name><ele>${v}</ele></wpt>
`,w+=`  <wpt lat="${l[0]}" lon="${l[1]}"><name>Final ${p} m AGL</name><ele>${S}</ele></wpt>
`,w+=`  <wpt lat="${c[0]}" lon="${c[1]}"><name>DIP</name><ele>${u}</ele></wpt>
`,w+=`  <trk>
    <name>Landing Pattern</name>
    <trkseg>
      <trkpt lat="${o[0]}" lon="${o[1]}"><ele>${h}</ele></trkpt>
      <trkpt lat="${s[0]}" lon="${s[1]}"><ele>${v}</ele></trkpt>
      <trkpt lat="${l[0]}" lon="${l[1]}"><ele>${S}</ele></trkpt>
      <trkpt lat="${c[0]}" lon="${c[1]}"><ele>${u}</ele></trkpt>
    </trkseg>
  </trk>
</gpx>`,console.log("Schritt 4: GPX-String wurde erfolgreich erstellt."),console.log(w);const y=`${f.formatTime(i.weatherData.time[t]).replace(/ /g,"_").replace(/:/g,"")}_Landing_Pattern.gpx`;try{const{Filesystem:b,Directory:E,isNative:k}=await Et();if(k&&b)await b.writeFile({path:`DZMaster/${y}`,data:w,directory:E.Documents,encoding:"utf8",recursive:!0}),f.handleMessage("Landing Pattern GPX saved in Documents/DZMaster");else{const A=new Blob([w],{type:"application/gpx+xml;charset=utf-8"}),T=window.URL.createObjectURL(A),N=document.createElement("a");N.href=T,N.download=y,document.body.appendChild(N),N.click(),document.body.removeChild(N),window.URL.revokeObjectURL(T)}}catch(b){console.error("Error saving Landing Pattern GPX file:",b),f.handleError("Could not save Landing Pattern GPX file.")}console.log("--- GPX Landing Pattern Export beendet ---")}async function ka(t,e){try{if(console.log(`[trackManager] renderTrack called for ${e} with ${t.length} points.`),!i.map)return console.warn("[trackManager] Map object in AppState is not available in renderTrack."),f.handleError("Map not initialized. Cannot render track."),null;i.gpxLayer&&i.map.hasLayer(i.gpxLayer)&&i.map.removeLayer(i.gpxLayer),i.gpxLayer=null,i.gpxPoints=t,i.isTrackLoaded=!1;const n={finalPointData:null,timestampToUseForWeather:null,historicalDateString:null,summaryForInfoElement:"",success:!1};if(t.length>0){const r=t[t.length-1];if(i.lastLat=r.lat,i.lastLng=r.lng,i.lastAltitude=await f.getAltitude(i.lastLat,i.lastLng),n.finalPointData={lat:i.lastLat,lng:i.lastLng,altitude:i.lastAltitude},t[0].time&&t[0].time.isValid){const d=t[0].time,m=F.utc().startOf("day"),p=d.startOf("day");p<m&&(n.historicalDateString=p.toFormat("yyyy-MM-dd"));let h=d.startOf("hour");d.minute>=30&&(h=h.plus({hours:1})),n.timestampToUseForWeather=h.toISO()}const o=(t.reduce((d,m,p)=>{if(p===0||!i.map)return 0;const h=t[p-1];return d+i.map.distance([h.lat,h.lng],[m.lat,m.lng])},0)/1e3).toFixed(2),s=t.map(d=>d.ele).filter(d=>d!==null),l=s.length?Math.min(...s).toFixed(0):"N/A",c=s.length?Math.max(...s).toFixed(0):"N/A",u=new CustomEvent("track:loaded",{detail:{lat:i.lastLat,lng:i.lastLng,altitude:i.lastAltitude,timestamp:n.timestampToUseForWeather,historicalDate:n.historicalDateString,summary:`<br><strong>Track:</strong> Distance: ${o} km, Min Elevation: ${l} m, Max Elevation: ${c} m (Source: ${e})`},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(u)}i.gpxLayer=L.layerGroup([],{pane:"gpxTrackPane"});const a=i.lastAltitude!=="N/A"&&!isNaN(i.lastAltitude)?parseFloat(i.lastAltitude):null;for(let r=0;r<t.length-1;r++){const o=t[r],s=t[r+1],l=o.ele,c=s.ele;let u="#808080";if(a!==null&&l!==null&&c!==null){const m=l-a,p=c-a,h=(m+p)/2;u=f.interpolateColor(h)}const d=L.polyline([[o.lat,o.lng],[s.lat,s.lng]],{color:u,weight:4,opacity:.75,pane:"gpxTrackPane"}).bindTooltip("",{sticky:!0});d.on("mousemove",function(m){const p=m.latlng;let h=t[0],v=1/0,S=0;t.forEach((w,M)=>{const y=Math.sqrt(Math.pow(w.lat-p.lat,2)+Math.pow(w.lng-p.lng,2));y<v&&(v=y,h=w,S=M)}),d.setTooltipContent(f.getTooltipContent(h,S,t,a)).openTooltip(p)}),i.gpxLayer.addLayer(d)}if(i.map&&i.gpxLayer.addTo(i.map),i.isTrackLoaded=!0,t.length>0&&i.map){const r=L.latLngBounds(t.map(o=>[o.lat,o.lng]));r.isValid()?i.map.fitBounds(r,{padding:[50,50],maxZoom:i.map.getMaxZoom()||18}):f.handleError("Unable to display track: invalid coordinates.")}return n.success=!0,console.log("[trackManager] renderTrack finished successfully."),n}catch(n){return console.error("[trackManager] Error in renderTrack:",n),f.handleError("Error rendering track: "+n.message),i.gpxPoints=[],i.gpxLayer&&i.map&&i.map.hasLayer(i.gpxLayer)&&i.map.removeLayer(i.gpxLayer),i.gpxLayer=null,i.isTrackLoaded=!1,{success:!1,error:n.message}}}async function Ta(t){const{Filesystem:e,isNative:n,Directory:a}=await Et();if(n&&t.path&&e){console.log(`[trackManager] Reading file via Capacitor Filesystem API: ${t.path}`);try{return(await e.readFile({path:t.path,encoding:"utf8"})).data}catch(r){if(console.error("[trackManager] Error reading file with Capacitor:",r),t.webPath)return await(await fetch(t.webPath)).text();throw new Error("Could not read file using native API.")}}else return console.log(`[trackManager] Reading file via Web FileReader: ${t.name}`),new Promise((r,o)=>{const s=new FileReader;s.onload=l=>r(l.target.result),s.onerror=l=>o(new Error("Error reading file.")),s.readAsText(t)})}var $c=15e3,ra=1e3,oa=60*ra,nn=60*oa,Bn=24*nn,Oc="http://www.topografix.com/GPX/gpx_style/0/2",Qt=new L.Icon.Default,Rc={startIcon:Qt,endIcon:Qt,wptIcons:{"":Qt},wptTypeIcons:{"":Qt},pointMatchers:[]},Wc={iconSize:[33,45],iconAnchor:[16,45],clickable:!1},Uc={color:"blue"},Hc={parseElements:["track","route","waypoint"],joinTrackSegments:!0};L.GPX=L.FeatureGroup.extend({initialize:function(t,e){e.max_point_interval=e.max_point_interval||$c,e.markers=this._merge_objs(Rc,e.markers||{}),e.marker_options=this._merge_objs(Wc,e.marker_options||{}),e.polyline_options=e.polyline_options||[],e.gpx_options=this._merge_objs(Hc,e.gpx_options||{}),L.Util.setOptions(this,e),L.GPXTrackIcon=L.Icon.extend({options:e.marker_options}),this._gpx=t,this._layers={},this._prepare_markers(e.markers),this._init_info(),t&&this._parse(t,e,this.options.async)},get_duration_string:function(t,e){var n="";t>=Bn&&(n+=Math.floor(t/Bn)+"d ",t=t%Bn),t>=nn&&(n+=Math.floor(t/nn)+":",t=t%nn);var a=Math.floor(t/oa);t=t%oa,a<10&&(n+="0"),n+=a+"'";var r=Math.floor(t/ra);return t=t%ra,r<10&&(n+="0"),n+=r,!e&&t>0?n+="."+Math.round(Math.floor(t)*1e3)/1e3:n+='"',n},get_duration_string_iso:function(t,e){var n=this.get_duration_string(t,e);return n.replace("'",":").replace('"',"")},_toFixed_helper:function(t,e=0){return typeof t=="number"?t.toFixed(e):"?"},to_miles:function(t){return t/1.60934},to_ft:function(t){return t*3.28084},m_to_km:function(t){return t/1e3},m_to_mi:function(t){return t/1609.34},ms_to_kmh:function(t){return t*3.6},ms_to_mih:function(t){return t/1609.34*3600},get_name:function(){return this._info.name},get_desc:function(){return this._info.desc},get_author:function(){return this._info.author},get_copyright:function(){return this._info.copyright},get_distance:function(){return this._info.length},get_distance_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))},get_start_time:function(){return this._info.duration.start},get_end_time:function(){return this._info.duration.end},get_moving_time:function(){return this._info.duration.moving},get_total_time:function(){return this._info.duration.total},get_moving_pace:function(){return this.get_moving_time()/this.m_to_km(this.get_distance())},get_moving_pace_imp:function(){return this.get_moving_time()/this.get_distance_imp()},get_moving_speed:function(){return this.m_to_km(this.get_distance())/(this.get_moving_time()/(3600*1e3))},get_moving_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_moving_time()/(3600*1e3))},get_total_speed:function(){return this.m_to_km(this.get_distance())/(this.get_total_time()/(3600*1e3))},get_total_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_total_time()/(3600*1e3))},get_elevation_gain:function(){return this._info.elevation.gain},get_elevation_loss:function(){return this._info.elevation.loss},get_elevation_gain_imp:function(){return this.to_ft(this.get_elevation_gain())},get_elevation_loss_imp:function(){return this.to_ft(this.get_elevation_loss())},get_elevation_data:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" m"})})},get_elevation_data_imp:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.to_ft,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" ft"})})},get_elevation_max:function(){return this._info.elevation.max},get_elevation_min:function(){return this._info.elevation.min},get_elevation_max_imp:function(){return this.to_ft(this.get_elevation_max())},get_elevation_min_imp:function(){return this.to_ft(this.get_elevation_min())},get_speed_data:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,t.ms_to_kmh,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,2)+" km/h"})})},get_speed_data_imp:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.ms_to_mih,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,2)+" mi/h"})})},get_speed_max:function(){return this.m_to_km(this._info.speed.max)*3600},get_speed_max_imp:function(){return this.to_miles(this.get_speed_max())},get_average_hr:function(){return this._info.hr.avg},get_average_temp:function(){return this._info.atemp.avg},get_average_cadence:function(){return this._info.cad.avg},get_heartrate_data:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" bpm"})})},get_heartrate_data_imp:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" bpm"})})},get_cadence_data:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" rpm"})})},get_temp_data:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" degrees"})})},get_cadence_data_imp:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" rpm"})})},get_temp_data_imp:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" degrees"})})},reload:function(){this._init_info(),this.clearLayers(),this._parse(this._gpx,this.options,this.options.async)},_merge_objs:function(t,e){var n={};for(var a in t)n[a]=t[a];for(var a in e)n[a]=e[a];return n},_prepare_data_point:function(t,e,n,a){var r=[e&&e(t[0])||t[0],n&&n(t[1])||t[1]];return r.push(a&&a(r[0],r[1])||r[0]+": "+r[1]),r},_prepare_markers:function(t){function e(n){return new L.GPXTrackIcon({iconUrl:n})}return Object.entries(t).forEach(([n,a])=>{n==="wptIcons"||n==="wptTypeIcons"?t[n]=this._prepare_markers(a):n==="pointMatchers"?t[n]=a.map(r=>(typeof r.icon=="string"&&(r.icon=e(r.icon)),r)):typeof a=="string"?t[n]=e(a):typeof a=="object"&&a!==null&&(t[n]=a)}),t},_init_info:function(){this._info={name:null,length:0,elevation:{gain:0,loss:0,max:0,min:1/0,_points:[]},speed:{max:0,_points:[]},hr:{avg:0,_total:0,_points:[]},duration:{start:null,end:null,moving:0,total:0},atemp:{avg:0,_total:0,_points:[]},cad:{avg:0,_total:0,_points:[]}}},_load_xml:function(t,e,n,a){a==null&&(a=this.options.async),n==null&&(n=this.options);var r=this,o=new window.XMLHttpRequest;o.open("GET",t,a);try{o.overrideMimeType("text/xml")}catch{}o.onloadend=function(){o.status==200?e(o.responseXML,n):r.fire("error",{err:"Error fetching resource: "+t})},o.send(null)},_parse:function(t,e,n){var a=this,r=function(s,l){var c=a._parse_gpx_data(s,l);if(!c){a.fire("error",{err:"No parseable layers of type(s) "+JSON.stringify(l.gpx_options.parseElements)});return}a.addLayer(c),a.fire("loaded",{layers:c,element:s})};if(t.substr(0,1)==="<"){var o=new DOMParser;n?setTimeout(function(){r(o.parseFromString(t,"text/xml"),e)}):r(o.parseFromString(t,"text/xml"),e)}else this._load_xml(t,r,e,n)},_parse_gpx_data:function(t,e){var n,a,r=[],o=t.getElementsByTagName("name");o.length>0&&(this._info.name=o[0].textContent);var s=t.getElementsByTagName("desc");s.length>0&&(this._info.desc=s[0].textContent);var l=t.getElementsByTagName("author");l.length>0&&(this._info.author=l[0].textContent);var c=t.getElementsByTagName("copyright");c.length>0&&(this._info.copyright=c[0].textContent);var u=e.gpx_options.parseElements;if(u.indexOf("route")>-1){var d=t.getElementsByTagName("rte");for(n=0;n<d.length;n++){var m=d[n],p=this._extract_styling(m),h=this._get_polyline_options(e.polyline_options,n);r=r.concat(this._parse_segment(d[n],e,p,h,"rtept"))}}if(u.indexOf("track")>-1){var v=t.getElementsByTagName("trk");for(n=0;n<v.length;n++){var S=v[n],p=this._extract_styling(S),h=this._get_polyline_options(e.polyline_options,n);if(e.gpx_options.joinTrackSegments)r=r.concat(this._parse_segment(S,e,p,h,"trkpt"));else{var w=S.getElementsByTagName("trkseg");for(C=0;C<w.length;C++)r=r.concat(this._parse_segment(w[C],e,p,h,"trkpt"))}}}if(this._info.hr.avg=Math.round(this._info.hr._total/this._info.hr._points.length),this._info.cad.avg=Math.round(this._info.cad._total/this._info.cad._points.length),this._info.atemp.avg=Math.round(this._info.atemp._total/this._info.atemp._points.length),u.indexOf("waypoint")>-1)for(a=t.getElementsByTagName("wpt"),n=0;n<a.length;n++){var M=new L.LatLng(a[n].getAttribute("lat"),a[n].getAttribute("lon")),y=a[n].getElementsByTagName("name"),o=y.length>0?y[0].textContent:"",_=a[n].getElementsByTagName("desc"),s=_.length>0?_[0].textContent:"",b=a[n].getElementsByTagName("sym"),E=b.length>0?b[0].textContent:null,k=a[n].getElementsByTagName("type"),A=k.length>0?k[0].textContent:null,T=e.markers.wptIcons,N=e.markers.wptTypeIcons,P=e.markers.pointMatchers||[],x;if(T&&E&&T[E])x=T[E];else if(N&&A&&N[A])x=N[A];else if(P.length>0){for(var C=0;C<P.length;C++)if(P[C].regex.test(o)){x=P[C].icon;break}}else T&&T[""]&&(x=T[""]);if(!x){console.log("No waypoint icon could be matched for symKey=%s,typeKey=%s,name=%s on waypoint %o",E,A,o,a[n]);continue}var I=new L.Marker(M,{clickable:e.marker_options.clickable,title:o,icon:x,type:"waypoint"});I.bindPopup("<b>"+o+"</b>"+(s.length>0?"<br>"+s:"")).openPopup(),this.fire("addpoint",{point:I,point_type:"waypoint",element:a[n]}),r.push(I)}if(r.length>1)return new L.FeatureGroup(r);if(r.length==1)return r[0]},_parse_segment:function(t,e,n,a,r){var o=t.getElementsByTagName(r);if(!o.length)return[];for(var s=[],l=[],c=[],u=null,d=0;d<o.length;d++){var m,p=new L.LatLng(o[d].getAttribute("lat"),o[d].getAttribute("lon"));p.meta={time:null,ele:null,hr:null,cad:null,atemp:null,speed:null},m=o[d].getElementsByTagName("time"),m.length>0?p.meta.time=new Date(Date.parse(m[0].textContent)):p.meta.time=new Date("1970-01-01T00:00:00");var h=u!=null?Math.abs(p.meta.time-u.meta.time):0;m=o[d].getElementsByTagName("ele"),m.length>0?p.meta.ele=parseFloat(m[0].textContent):p.meta.ele=u!=null?u.meta.ele:null;var v=u!=null?p.meta.ele-u.meta.ele:0,S=u!=null?this._dist3d(u,p):0;if(m=o[d].getElementsByTagName("speed"),m.length>0?p.meta.speed=parseFloat(m[0].textContent):p.meta.speed=h>0?1e3*S/h:0,m=o[d].getElementsByTagName("name"),m.length>0){for(var w=m[0].textContent,M=e.markers.pointMatchers||[],y=0;y<M.length;y++)if(M[y].regex.test(w)){l.push({label:w,coords:p,icon:M[y].icon,element:o[d]});break}}this._info.length+=S,m=o[d].getElementsByTagNameNS("*","hr"),m.length>0&&(p.meta.hr=parseInt(m[0].textContent),this._info.hr._points.push([this._info.length,p.meta.hr]),this._info.hr._total+=p.meta.hr),m=o[d].getElementsByTagNameNS("*","cad"),m.length>0&&(p.meta.cad=parseInt(m[0].textContent),this._info.cad._points.push([this._info.length,p.meta.cad]),this._info.cad._total+=p.meta.cad),m=o[d].getElementsByTagNameNS("*","atemp"),m.length>0&&(p.meta.atemp=parseInt(m[0].textContent),this._info.atemp._points.push([this._info.length,p.meta.atemp]),this._info.atemp._total+=p.meta.atemp),p.meta.ele>this._info.elevation.max&&(this._info.elevation.max=p.meta.ele),p.meta.ele<this._info.elevation.min&&(this._info.elevation.min=p.meta.ele),this._info.elevation._points.push([this._info.length,p.meta.ele]),p.meta.speed>this._info.speed.max&&(this._info.speed.max=p.meta.speed),this._info.speed._points.push([this._info.length,p.meta.speed]),u==null&&this._info.duration.start==null&&(this._info.duration.start=p.meta.time),this._info.duration.end=p.meta.time,this._info.duration.total+=h,h<e.max_point_interval&&(this._info.duration.moving+=h),v>0?this._info.elevation.gain+=v:this._info.elevation.loss+=Math.abs(v),u=p,s.push(p)}var _=new L.Polyline(s,this._extract_styling(t,n,a));if(this.fire("addline",{line:_,element:t}),c.push(_),e.markers.startIcon){var b=new L.Marker(s[0],{clickable:e.marker_options.clickable,icon:e.markers.startIcon});this.fire("addpoint",{point:b,point_type:"start",element:o[0],line:t}),c.push(b)}if(e.markers.endIcon){var b=new L.Marker(s[s.length-1],{clickable:e.marker_options.clickable,icon:e.markers.endIcon});this.fire("addpoint",{point:b,point_type:"end",element:o[o.length-1],line:t}),c.push(b)}for(var d=0;d<l.length;d++){var b=new L.Marker(l[d].coords,{clickable:e.marker_options.clickable,title:l[d].label,icon:l[d].icon});this.fire("addpoint",{point:b,point_type:"label",element:l[d].element}),c.push(b)}return c},_get_polyline_options:function(t,e){return Array.isArray(t)?t[e]||{}:t},_extract_styling:function(t,e,n){var a=this._merge_objs(Uc,e),r=t.getElementsByTagNameNS(Oc,"line");if(r.length>0){var o=r[0].getElementsByTagName("color");o.length>0&&(a.color="#"+o[0].textContent);var o=r[0].getElementsByTagName("opacity");o.length>0&&(a.opacity=o[0].textContent);var o=r[0].getElementsByTagName("weight");o.length>0&&(a.weight=o[0].textContent);var o=r[0].getElementsByTagName("linecap");o.length>0&&(a.lineCap=o[0].textContent);var o=r[0].getElementsByTagName("linejoin");o.length>0&&(a.lineJoin=o[0].textContent);var o=r[0].getElementsByTagName("dasharray");o.length>0&&(a.dashArray=o[0].textContent);var o=r[0].getElementsByTagName("dashoffset");o.length>0&&(a.dashOffset=o[0].textContent)}return this._merge_objs(a,n)},_dist2d:function(t,e){var n=6371e3,a=this._deg2rad(e.lat-t.lat),r=this._deg2rad(e.lng-t.lng),o=Math.sin(a/2)*Math.sin(a/2)+Math.cos(this._deg2rad(t.lat))*Math.cos(this._deg2rad(e.lat))*Math.sin(r/2)*Math.sin(r/2),s=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)),l=n*s;return l},_dist3d:function(t,e){var n=this._dist2d(t,e),a=Math.abs(e.meta.ele-t.meta.ele);return Math.sqrt(Math.pow(n,2)+Math.pow(a,2))},_deg2rad:function(t){return t*Math.PI/180}});let gr=!1;function Ue(t,e,n){console.log(`setupCheckbox called for id: ${t}`);const a=document.getElementById(t);a?(a._changeHandler&&(a.removeEventListener("change",a._changeHandler),console.log(`Removed previous change listener for ${t}`)),a._changeHandler=r=>{console.log(`Change event fired for ${t}, checked: ${a.checked}, event:`,r),r.stopPropagation(),n(a)},a.addEventListener("change",a._changeHandler),a.addEventListener("click",r=>{console.log(`Click event on ${t}, checked: ${a.checked}, target:`,r.target)}),console.log(`Attached change and click listeners to ${t}`)):console.warn(`Checkbox ${t} not found`)}function ia(t,e){document.querySelectorAll(`input[name="${t}"]`).forEach(a=>{a.addEventListener("change",()=>{const r=document.querySelector(`input[name="${t}"]:checked`);if(!r)return;const o=r.value;if(g.state.userSettings[t]=o,g.save(),console.log(`${t} changed to: ${o} and saved to localStorage`),t==="landingDirection"){const s=document.getElementById("customLandingDirectionLL"),l=document.getElementById("customLandingDirectionRR");s&&(s.disabled=o!=="LL"),l&&(l.disabled=o!=="RR"),o==="LL"&&s&&!s.value&&g.state.userSettings.customLandingDirectionLL===""&&(s.value=Math.round(i.landingWindDir||0),g.state.userSettings.customLandingDirectionLL=parseInt(s.value),g.save(),console.log(`Set customLandingDirectionLL to ${s.value}`)),o==="RR"&&l&&!l.value&&g.state.userSettings.customLandingDirectionRR===""&&(l.value=Math.round(i.landingWindDir||0),g.state.userSettings.customLandingDirectionRR=parseInt(l.value),g.save(),console.log(`Set customLandingDirectionRR to ${l.value}`))}document.dispatchEvent(new CustomEvent("ui:radioGroupChanged",{detail:{name:t,value:o}})),e&&e()})})}function te(t,e,n,a){const r=document.getElementById(t);r&&r.addEventListener(e,f.debounce(()=>{const o=r.type==="number"?parseFloat(r.value):r.value;a&&a(o)===!1||(g.state.userSettings[t]=o,g.save(),console.log(`${t} changed to: ${o} and saved to localStorage`),document.dispatchEvent(new CustomEvent("ui:inputChanged",{detail:{name:t,value:o}})))},n))}function Bc(){const t=document.querySelector(".main-layout"),e=document.querySelectorAll(".sidebar-icon"),n=document.querySelectorAll(".panel");let a=null;if(!t){console.error("Layout-Elemente für Sidebar-Logik nicht gefunden.");return}e.forEach(r=>{r.addEventListener("click",()=>{const o=r.dataset.panelId,s=o.replace("panel-","");if((s==="planner"||s==="data")&&!g.isFeatureUnlocked(s)){g.showPasswordModal(s,()=>{r.click()},()=>{});return}const l=t.classList.contains("sidebar-expanded")&&a===o;t.classList.remove("sidebar-expanded","data-panel-visible"),e.forEach(c=>c.classList.remove("active")),l?a=null:(t.classList.add("sidebar-expanded"),r.classList.add("active"),a=o,n.forEach(c=>c.classList.toggle("hidden",c.id!==o)),o==="panel-data"&&t.classList.add("data-panel-visible")),setTimeout(()=>{i.map&&i.map.invalidateSize({animate:!0})},300)})})}function zc(){document.querySelectorAll(".accordion-header").forEach(e=>{e.addEventListener("click",()=>{e.parentElement.classList.toggle("active")})})}function Gc(){const t=document.getElementById("timeSlider");t&&(t.addEventListener("input",()=>{document.dispatchEvent(new CustomEvent("ui:sliderChanged",{detail:{sliderValue:t.value},bubbles:!0,cancelable:!0}))}),t.addEventListener("change",async()=>{document.dispatchEvent(new CustomEvent("ui:sliderChangeFinished",{detail:{sliderValue:t.value},bubbles:!0,cancelable:!0}))}))}function Vc(){const t=document.getElementById("modelSelect");t&&(t.addEventListener("change",()=>{const e=t.value;console.log("Model select changed to:",e),g.state.userSettings.model=e,g.save(),document.dispatchEvent(new CustomEvent("ui:modelChanged",{detail:{model:e}}))}),document.addEventListener("models:available",e=>{const{availableModels:n}=e.detail;Fl(n),hu(n),xl(n)}))}function Zc(){_a(),console.log("Coordinate events setup complete.")}function jc(){if(console.log("App: Richte Event-Listener für Karten-Events ein."),!i.map){console.error("Karte nicht initialisiert, Event-Listener können nicht gesetzt werden.");return}const t=()=>{document.dispatchEvent(new CustomEvent("map:moved"))},e=f.debounce(()=>{Ma({map:i.map,baseMaps:i.baseMaps,onProgress:Ot,onComplete:n=>{$e(),n&&f.handleMessage(n)},onCancel:()=>{$e(),f.handleMessage("Caching cancelled.")}})},1e3);i.map.on("zoomend",t),i.map.on("moveend",t),i.map.on("moveend",e)}function Jc(){const t=document.getElementById("modelInfoButton"),e=document.getElementById("modelInfoPopup");!t||!e||(t.addEventListener("click",n=>{n.stopPropagation();const a=e.style.display==="block";e.style.display=a?"none":"block"}),document.addEventListener("click",n=>{e.style.display==="block"&&!t.contains(n.target)&&(e.style.display="none")}))}function qc(){document.querySelectorAll(".info-icon").forEach(e=>{const n=e.nextElementSibling;if(n&&n.classList.contains("info-popup")){const a=e.dataset.info;a&&(n.textContent=a),e.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),document.querySelectorAll(".info-popup").forEach(s=>{s!==n&&(s.style.display="none")});const o=n.style.display==="block";n.style.display=o?"none":"block"})}}),document.addEventListener("click",e=>{e.target.closest(".info-icon")||document.querySelectorAll(".info-popup").forEach(n=>{n.style.display="none"})})}function Kc(){console.log("App: Richte Event-Listener für Track-Einstellungen ein.");const t=(a,r)=>{const o=document.getElementById(a);o&&(o.value=g.state.userSettings[r]||0,console.log(`Set ${a} to initial value:`,o.value),o.addEventListener("input",()=>{const s=parseFloat(o.value);isNaN(s)||(g.state.userSettings[r]=s,g.save(),he())}))};t("numberOfJumpers","numberOfJumpers"),t("jumperSeparation","jumperSeparation"),t("jumpRunTrackOffset","jumpRunTrackOffset"),t("jumpRunTrackForwardOffset","jumpRunTrackForwardOffset");const e=document.getElementById("jumpRunTrackDirection");e&&(e.value=g.state.userSettings.customJumpRunDirection||"",e.addEventListener("change",()=>{const a=parseFloat(e.value);g.state.userSettings.jumpRunTrackOffset=0,g.state.userSettings.jumpRunTrackForwardOffset=0;const r=document.getElementById("jumpRunTrackOffset"),o=document.getElementById("jumpRunTrackForwardOffset");r&&(r.value=0),o&&(o.value=0),console.log("Manuelle JRT-Richtungsänderung: Offsets auf 0 zurückgesetzt."),Number.isFinite(a)&&a>=0&&a<=360?(g.state.userSettings.customJumpRunDirection=a,console.log("Set 'customJumpRunDirection' on change to:",a)):(g.state.userSettings.customJumpRunDirection=null,e.value="",console.log("Invalid direction, resetting to calculated.")),g.save(),he(),document.dispatchEvent(new CustomEvent("ui:recalculateJump"))}));const n=document.getElementById("showJumpRunTrack");n&&n.addEventListener("change",a=>{g.state.userSettings.showJumpRunTrack=a.target.checked,g.save(),he()})}function Yc(){const t=document.querySelectorAll('input[name="cutAwayState"]');if(t.length===0)return;const e=g.state.userSettings.cutAwayState||"Partially",n=document.querySelector(`input[name="cutAwayState"][value="${e}"]`);n&&(n.checked=!0),t.forEach(a=>{a.addEventListener("change",()=>{a.checked&&(console.log(`Cut Away State changed to: ${a.value}`),g.state.userSettings.cutAwayState=a.value,g.save(),document.dispatchEvent(new CustomEvent("ui:recalculateJump")))})})}function Xc(){const t=document.getElementById("resetCutAwayMarker");t&&t.addEventListener("click",()=>{if(!i.map){console.warn("Map not initialized, cannot reset cut-away marker");return}i.cutAwayMarker&&(i.map.removeLayer(i.cutAwayMarker),i.cutAwayMarker=null,i.cutAwayLat=null,i.cutAwayLng=null,console.log("Cut-away marker reset"),i.cutAwayCircle&&(i.map.removeLayer(i.cutAwayCircle),i.cutAwayCircle=null,console.log("Cleared cut-away circle")),document.getElementById("info").innerHTML="Right-click map to place cut-away marker")})}function Qc(){const t=document.getElementById("deselectAllEnsembleButton");t&&t.addEventListener("click",()=>{document.querySelectorAll('#ensembleModelsSubmenu input[type="checkbox"]').forEach(n=>{n.checked=!1}),g.state.userSettings.selectedEnsembleModels=[],g.save(),i.ensembleModelsData=null,Bt(),f.handleMessage("All ensemble models deselected.")})}function eu(){const t=document.getElementById("analyzeTerrainButton");t&&t.addEventListener("click",async()=>{if(!i.weatherData||!i.lastLat||!i.lastLng){f.handleError("Please select a location and fetch weather data first.");return}wt(!0,"Analyzing terrain, this may take a moment...");try{const e=await El();Wl(e),e.length>0?f.handleMessage("Warning: Low clearance areas detected and marked in red."):f.handleMessage("Terrain analysis complete. No low clearance areas found.")}catch(e){console.error("Terrain analysis failed:",e),f.handleError("An error occurred during terrain analysis.")}finally{wt(!1)}})}function tu(){const t=document.getElementById("uploadTrackButton"),e=document.getElementById("trackFileInput"),n=document.getElementById("fileNameDisplay"),a=document.getElementById("clearTrack");if(!t||!e||!n||!a){console.error("One or more track upload elements are missing from the DOM.");return}t.addEventListener("click",()=>{e.click()}),e.addEventListener("change",async r=>{const o=document.getElementById("loading");if(r.target.files&&r.target.files.length>0){const s=r.target.files[0];n.textContent=s.name,n.style.fontStyle="normal",o&&(o.style.display="block");const l=s.name.split(".").pop().toLowerCase();try{l==="gpx"?await Pc(s):l==="csv"?await Dc(s):l==="kml"?await Nc(s):f.handleError("Unsupported file type. Please upload a .gpx or .csv file.")}catch(c){console.error("Error during track file processing:",c),f.handleError("Failed to process track file.")}finally{o&&(o.style.display="none")}}}),a.addEventListener("click",r=>{if(r.stopPropagation(),!i.map){f.handleError("Cannot clear track: map not initialized.");return}if(i.gpxLayer)try{i.map.hasLayer(i.gpxLayer)&&i.map.removeLayer(i.gpxLayer),i.gpxLayer=null,i.gpxPoints=[],i.isTrackLoaded=!1,e.value="",n.textContent="No file chosen",n.style.fontStyle="italic"}catch(o){f.handleError("Failed to clear track: "+o.message)}else f.handleMessage("No track to clear.")})}function nu(){ae(),Ce(),g.getValue("heightUnit","m");const t=document.getElementById("exportGpxButton");t&&t.addEventListener("click",async()=>{const n=ae(),a=Ce(),r=g.getValue("heightUnit","m");await Fc(n,a,r)});const e=document.getElementById("exportLandingPatternGpxButton");e&&e.addEventListener("click",()=>{console.log("DEBUG: Klick auf 'exportLandingPatternGpxButton' registriert."),xc()})}function au(){if(!i.map){console.warn("Map not initialized, skipping setupCheckboxEvents");return}Ue("showExitAreaCheckbox","showExitArea",a=>{g.state.userSettings.showExitArea=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:jumpFeatureChanged"))}),Ue("showCanopyAreaCheckbox","showCanopyArea",a=>{g.state.userSettings.showCanopyArea=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:jumpFeatureChanged"))}),Ue("showJumpRunTrack","showJumpRunTrack",a=>{g.state.userSettings.showJumpRunTrack=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:showJumpRunTrackChanged",{detail:{checked:a.checked}}))}),Ue("showCutAwayFinder","showCutAwayFinder",a=>{g.state.userSettings.showCutAwayFinder=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:showCutAwayFinderChanged",{detail:{checked:a.checked}}))}),Ue("showLandingPattern","showLandingPattern",a=>{g.state.userSettings.showLandingPattern=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:landingPatternEnabled"))}),Ue("trackPositionCheckbox","trackPosition",a=>{g.state.userSettings.trackPosition=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:trackPositionToggled",{detail:{checked:a.checked}}))}),Ue("showJumpMasterLine","showJumpMasterLine",a=>{var o;if(a.checked&&!g.state.userSettings.trackPosition){a.checked=!1,f.handleError("Please start Live Tracking first.");return}g.state.userSettings.showJumpMasterLine=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:showJumpMasterLineChanged"));const r=(o=a.closest("li"))==null?void 0:o.querySelector("ul.submenu");r&&r.classList.toggle("hidden",!a.checked)}),ia("jumpMasterLineTarget",()=>{const a=g.getValue("jumpMasterLineTarget","radio","DIP");g.state.userSettings.jumpMasterLineTarget=a,g.save(),console.log("jumpMasterLineTarget changed:",a),document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged"))}),Ue("lockInteractionCheckbox","isInteractionLocked",a=>{const r=a.checked;g.state.userSettings.isInteractionLocked=r,g.save(),fc(r),i.jumpRunTrackLayerGroup&&i.jumpRunTrackLayerGroup.eachLayer(o=>{o instanceof L.Marker&&o.options.icon&&o.options.icon.options.iconUrl.includes("airplane")&&(r?o.dragging.disable():o.dragging.enable())}),i.currentMarker&&(r?i.currentMarker.dragging.disable():i.currentMarker.dragging.enable()),i.harpMarker&&(r?i.harpMarker.dragging&&i.harpMarker.dragging.disable():i.harpMarker.dragging&&i.harpMarker.dragging.enable()),i.cutAwayMarker&&(r?i.cutAwayMarker.dragging.disable():i.cutAwayMarker.dragging.enable()),r?f.handleMessage("Map interactions are now locked."):f.handleMessage("Map interactions are now unlocked.")});const t=document.getElementById("placeHarpButton");t&&t.addEventListener("click",()=>{i.isPlacingHarp=!0,console.log("HARP placement mode activated"),i.map.on("click",aa),f.handleMessage("Click the map to place the HARP marker");const a=document.querySelector(".main-layout");a&&a.classList.remove("sidebar-expanded","data-panel-visible"),document.querySelectorAll(".sidebar-icon.active").forEach(r=>r.classList.remove("active")),setTimeout(()=>{i.map&&i.map.invalidateSize({animate:!0})},300)});const e=document.getElementById("clearHarpButton");e&&e.addEventListener("click",Zl);const n=document.querySelector(".hamburger-menu");n&&n.addEventListener("click",a=>{console.log("Menu click:",a.target,"class:",a.target.className,"id:",a.target.id)})}function ru(){ia("landingDirection",()=>{}),ia("jumpMasterLineTarget",()=>{document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged"))}),document.querySelectorAll('input[name="ensembleScenario"]').forEach(a=>{a.addEventListener("change",async()=>{if(a.checked){if(g.state.userSettings.currentEnsembleScenario=a.value,i.currentEnsembleScenario=a.value,g.save(),console.log("Ensemble scenario changed to:",a.value),!g.state.userSettings.selectedEnsembleModels.every(s=>i.ensembleModelsData&&i.ensembleModelsData[s])&&a.value!=="all_models"&&!await La()){f.handleError("Failed to fetch data for scenario.");return}const o=ae();rt(o)}})});const e=g.state.userSettings.currentEnsembleScenario||"all_models",n=document.querySelector(`input[name="ensembleScenario"][value="${e}"]`);n&&(n.checked=!0,i.currentEnsembleScenario=e),i.map&&!i.ensembleLayerGroup&&(i.ensembleLayerGroup=L.layerGroup().addTo(i.map))}function ou(){["refLevel","heightUnit","temperatureUnit","windUnit","timeZone","coordFormat","downloadFormat"].forEach(e=>{const n=document.getElementById(e);n?n.addEventListener("change",()=>{const a=n.value;g.state.userSettings[e]=a,g.save(),console.log(`Setting '${e}' changed to: ${a} and saved.`),document.dispatchEvent(new CustomEvent("ui:settingChanged",{detail:{name:e,value:a}}))}):console.warn(`Select element with id '${e}' not found.`)})}function iu(){const t=(e,n)=>{const a=document.getElementById(e);a&&a.addEventListener("blur",()=>{let r=parseInt(a.value)||n;const o=document.getElementById("legHeightFinal"),s=document.getElementById("legHeightBase"),l=document.getElementById("legHeightDownwind");if(!(!isNaN(r)&&r>=50&&r<=1e3&&f.validateLegHeights(o,s,l))){let u=n;const d=parseInt(o.value)||100,m=parseInt(s.value)||200,p=parseInt(l.value)||300;e==="legHeightFinal"&&(u=Math.min(m-1,100)),e==="legHeightBase"&&(u=Math.max(d+1,Math.min(p-1,200))),e==="legHeightDownwind"&&(u=Math.max(m+1,300)),a.value=u,r=u,f.handleError(`Adjusted ${e} to ${u} to maintain valid leg order.`)}g.state.userSettings[e]=r,g.save(),document.dispatchEvent(new CustomEvent("ui:inputChanged",{detail:{name:e,value:r}}))})};t("legHeightFinal",100),t("legHeightBase",200),t("legHeightDownwind",300),te("lowerLimit","change",300),te("upperLimit","change",300),te("openingAltitude","change",300,e=>isNaN(e)||e<500||e>15e3?(f.handleError("Opening altitude must be between 500 and 15000 meters."),document.dispatchEvent(new CustomEvent("ui:invalidInput",{detail:{id:"openingAltitude",defaultValue:1200}})),!1):!0),te("exitAltitude","change",300,e=>isNaN(e)||e<500||e>15e3?(f.handleError("Exit altitude must be between 500 and 15000 meters."),document.dispatchEvent(new CustomEvent("ui:invalidInput",{detail:{id:"exitAltitude",defaultValue:3e3}})),!1):!0),te("safetyHeight","change",300),te("canopySpeed","change",300),te("descentRate","change",300),te("interpStep","change",300,null),te("customLandingDirectionLL","input",100),te("customLandingDirectionRR","input",100),te("jumpRunTrackDirection","change",0),te("jumpRunTrackOffset","change",0),te("jumpRunTrackForwardOffset","change",0),te("aircraftSpeedKt","change",300),te("numberOfJumpers","change",300),te("jumperSeparation","change",300),te("cutAwayAltitude","change",300),te("terrainClearance","change",300),te("historicalDatePicker","change",300)}function su(){const t=document.getElementById("downloadButton");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("ui:downloadClicked"))})}function lu(){const t=document.getElementById("clearHistoricalDate");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("ui:clearDateClicked"))})}function cu(){const t=document.getElementById("app-management-settings");if(!t){console.error("Ziel-Container für App-Management-Buttons nicht gefunden.");return}const e=document.createElement("div");e.id="settings-cache-buttons",e.className="settings-grid";const n=document.createElement("button");n.id="resetButton",n.textContent="Reset Settings",n.title="Resets all settings to their default values and locks all features",n.className="btn btn-danger",n.addEventListener("click",()=>{confirm("Are you sure you want to reset all settings and lock all features?")&&(localStorage.removeItem("unlockedFeatures"),localStorage.removeItem("upperWindsSettings"),window.location.reload())}),e.appendChild(document.createElement("label")),e.appendChild(n);const a=document.createElement("button");a.id="clearCacheButton",a.textContent="Clear Tile Cache",a.title="Clears cached map tiles. Pan/zoom to cache more tiles for offline use.",a.className="btn btn-danger",a.addEventListener("click",async()=>{try{const r=await ge.getCacheSize();await ge.clearCache(),f.handleMessage(`Tile cache cleared successfully (freed ${r.toFixed(2)} MB).`)}catch(r){f.handleError("Failed to clear tile cache: "+r.message)}}),e.appendChild(document.createElement("label")),e.appendChild(a),t.appendChild(e)}function uu(){const t=document.getElementById("cacheRadiusSelect");t?(t.value=g.state.userSettings.cacheRadiusKm||10,t.addEventListener("change",()=>{if(!g.state||!g.state.userSettings){console.error("Settings not properly initialized");return}let r=parseInt(t.value,10);isNaN(r)||r<1?(r=1,f.handleMessage("Cache radius must be at least 1 km.")):r>50&&(r=50,f.handleMessage("Cache radius cannot exceed 50 km.")),t.value=r,g.state.userSettings.cacheRadiusKm=r,g.save(),console.log("Updated cacheRadiusKm:",g.state.userSettings.cacheRadiusKm)}),console.log("cacheRadiusSelect listener attached, initial value:",t.value)):console.warn("cacheRadiusSelect not found in DOM");const e=document.getElementById("cacheZoomMin"),n=document.getElementById("cacheZoomMax");if(e&&n){const r=()=>{let s=parseInt(e.value,10),l=parseInt(n.value,10);(isNaN(s)||s<6)&&(s=6),(isNaN(l)||l>15)&&(l=15),s>l&&(l=s,n.value=l,f.handleMessage("Max zoom cannot be less than min zoom.")),e.value=s,n.value=l;const c=Array.from({length:l-s+1},(u,d)=>s+d);g.state.userSettings.cacheZoomLevels=c,g.save(),console.log("Updated cacheZoomLevels:",g.state.userSettings.cacheZoomLevels)},o=g.state.userSettings.cacheZoomLevels||[11,12,13,14];e.value=Math.min(...o),n.value=Math.max(...o),e.addEventListener("change",r),n.addEventListener("change",r)}else console.warn("Zoom level input fields not found in DOM");const a=document.getElementById("recacheNowButton");a?(a.addEventListener("click",()=>{xo({map:i.map,lastLat:i.lastLat,lastLng:i.lastLng,baseMaps:i.baseMaps,onProgress:Ot,onComplete:r=>{$e(),r&&Ze(r)},onCancel:()=>{$e(),Ze("Caching cancelled.")}})}),console.log("recacheNowButton listener attached")):console.warn("recacheNowButton not found in DOM")}function du(){const t=document.getElementById("harpCoordInput"),e=document.getElementById("placeHarpCoordButton"),n=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');if(!t||!e||!n){console.warn("HARP coordinate input elements not found. Skipping setup.");return}e.addEventListener("click",async()=>{const a=t.value.trim();if(!a){f.handleError("Please enter coordinates.");return}const r=Bo(a);if(r){i.harpMarker&&i.map.removeLayer(i.harpMarker),i.harpMarker=Wo(r.lat,r.lng).addTo(i.map),i.map.panTo([r.lat,r.lng]),g.state.userSettings.harpLat=r.lat,g.state.userSettings.harpLng=r.lng,g.state.userSettings.jumpRunTrackOffset=0,g.state.userSettings.jumpRunTrackForwardOffset=0,console.log("HARP placed via coords. JRT offsets reset to 0."),g.save(),f.handleMessage("HARP marker placed successfully."),n.disabled=!1,n.checked=!0,document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged")),document.dispatchEvent(new CustomEvent("ui:recalculateJump")),document.dispatchEvent(new CustomEvent("harp:updated"));const o=document.querySelector(".main-layout");o&&o.classList.remove("sidebar-expanded","data-panel-visible"),document.querySelectorAll(".sidebar-icon.active").forEach(s=>s.classList.remove("active")),setTimeout(()=>{i.map&&i.map.invalidateSize({animate:!0})},300)}else f.handleError("Invalid coordinates. Please enter a valid MGRS or Decimal Degree format.")})}function mu(){console.log("[EventManager] Trying to setup ADSB events...");const t=document.getElementById("findJumpShipBtn");t?(console.log('[EventManager] Found "findJumpShipBtn" button.'),t.addEventListener("click",()=>{console.log('[EventManager] "findJumpShipBtn" CLICKED! Dispatching ui:findJumpShip event.'),document.dispatchEvent(new CustomEvent("ui:findJumpShip"))})):console.warn('[EventManager] ADSB "Find Jump Ship" button NOT FOUND in DOM.')}function hu(t){const e=document.getElementById("ensembleModelsSubmenu");e&&(e.innerHTML="",t.forEach(n=>{const a=document.createElement("li"),r=document.createElement("label");r.className="radio-label";const o=document.createElement("input");o.type="checkbox",o.name="ensembleModel",o.value=n,o.checked=g.state.userSettings.selectedEnsembleModels.includes(n),o.addEventListener("change",async()=>{const s=Array.from(e.querySelectorAll("input:checked")).map(c=>c.value);if(g.state.userSettings.selectedEnsembleModels=s,g.save(),await La()){const c=ae();rt(c)}}),r.append(o,` ${n.replace(/_/g," ").toUpperCase()}`),a.appendChild(r),e.appendChild(a)}))}function fu(){const t=document.getElementById("findPoisInViewBtn");if(!t){console.warn("POI search button not found.");return}t.addEventListener("click",async()=>{if(!i.map){f.handleError("Map is not available.");return}const e=i.map.getZoom(),n=10;if(e<n){qe(`Please zoom in to Level ${n}+ to search for dropzones.`);return}try{wt(!0,"Searching for Dropzones...");const a=i.map.getBounds(),r=a.getSouthWest(),o=a.getNorthEast(),s=await vc(r.lat,r.lng,o.lat,o.lng);Ql(s);const l=await Ml(()=>Promise.resolve().then(()=>kc),void 0);l&&typeof l.renderResultsList=="function"&&l.renderResultsList(s)}catch(a){console.error("Error during POI search:",a),f.handleError("An error occurred during the search.")}finally{wt(!1)}})}function gu(){gr||(console.log("Initializing all UI event listeners..."),Bc(),zc(),Gc(),Vc(),Zc(),Jc(),qc(),au(),ru(),ou(),iu(),su(),lu(),Kc(),Yc(),Xc(),Qc(),eu(),tu(),nu(),cu(),uu(),du(),mu(),fu(),jc(),document.addEventListener("loading:start",t=>wt(!0,t.detail.message)),document.addEventListener("loading:stop",()=>wt(!1)),gr=!0,console.log("Event listeners initialized successfully (first and only time)."))}function pr(){if(i.autoupdateInterval){console.log("[AutoupdateManager] Autoupdate is already running.");return}if(!navigator.onLine){f.handleError("Cannot enable autoupdate while offline.");const t=document.getElementById("autoupdateCheckbox");t&&(t.checked=!1),g.state.userSettings.autoupdate=!1,g.save();return}console.log("[AutoupdateManager] Starting autoupdate interval."),document.dispatchEvent(new CustomEvent("autoupdate:tick",{detail:{isInitialTick:!0}})),i.autoupdateInterval=setInterval(()=>{console.log("[AutoupdateManager] Tick..."),document.dispatchEvent(new CustomEvent("autoupdate:tick",{detail:{isInitialTick:!1}}))},60*1e3),f.handleMessage("Autoupdate enabled")}function zo(){i.autoupdateInterval&&(clearInterval(i.autoupdateInterval),i.autoupdateInterval=null,console.log("[AutoupdateManager] Stopped autoupdate interval."),f.handleMessage("Autoupdate disabled"))}function pu(){var e;const t=document.getElementById("autoupdateCheckbox");if(!t){console.warn("[AutoupdateManager] Autoupdate checkbox not found.");return}t.checked=g.state.userSettings.autoupdate,t.addEventListener("change",()=>{g.state.userSettings.autoupdate=t.checked,g.save();const n=document.getElementById("historicalDatePicker");if(t.checked&&(n!=null&&n.value)){t.checked=!1,g.state.userSettings.autoupdate=!1,g.save(),f.handleError("Autoupdate cannot be enabled with a historical date set.");return}t.checked?pr():zo()}),g.state.userSettings.autoupdate&&!((e=document.getElementById("historicalDatePicker"))!=null&&e.value)&&pr()}async function yu(){if(i.watchId!==null)return;console.log("[LiveTrackingManager] Attempting to start position tracking...");const t=localStorage.getItem("hasAcknowledgedLocationDisclosure"),e=async()=>{const{Geolocation:n,isNative:a}=await Et();if(console.log("[LiveTrackingManager] Platform:",a?window.Capacitor.getPlatform():"Web","IsNative:",a),a&&n)try{const r=await vu();if(console.log("[LiveTrackingManager] Permissions result:",r),!r){console.warn("[LiveTrackingManager] Permissions not granted, stopping tracking.");return}const o=await n.watchPosition({enableHighAccuracy:!0,timeout:1e4,maximumAge:0},(s,l)=>{if(l){console.error("[LiveTrackingManager] Geolocation error:",l),f.handleError(`Geolocation error: ${l.message||"Unknown error"}`),sa();return}s&&(console.log("[LiveTrackingManager] Received position:",s.coords),yr(s))});i.watchId=o,console.log("[LiveTrackingManager] Native Geolocation watcher started:",o),document.dispatchEvent(new CustomEvent("tracking:started"))}catch(r){console.error("[LiveTrackingManager] Failed to start native tracking:",r),f.handleError(`Failed to start tracking: ${r.message||"Unknown error"}`)}else{if(console.log("[LiveTrackingManager] Using navigator.geolocation for tracking (Web)."),!navigator.geolocation){f.handleError("Geolocation is not supported by your browser."),document.dispatchEvent(new CustomEvent("tracking:stopped"));return}i.watchId=navigator.geolocation.watchPosition(r=>{console.log("[LiveTrackingManager] Web position:",r.coords),yr(r)},r=>{console.error("[LiveTrackingManager] Web Geolocation error:",r),f.handleError(`Geolocation error: ${r.message||"Unknown error"}`),sa()},{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}),console.log("[LiveTrackingManager] Web Geolocation watcher started:",i.watchId),document.dispatchEvent(new CustomEvent("tracking:started"))}};t?e():Il({title:"Hinweis zur Standortnutzung",message:"DZMaster erfasst Standortdaten, um die Funktionen <strong>'Live Tracking'</strong> und <strong>'Automatische Sprungaufzeichnung'</strong> zu ermöglichen. Dies geschieht auch, wenn die App im Hintergrund läuft oder der Bildschirm ausgeschaltet ist, um deinen vollständigen Sprung aufzuzeichnen.<br><br>Diese Daten werden nur lokal auf deinem Gerät gespeichert und nicht geteilt.",onConfirm:()=>{localStorage.setItem("hasAcknowledgedLocationDisclosure","true"),e()},onCancel:()=>{const n=document.getElementById("trackPositionCheckbox");n&&(n.checked=!1),Settings.state.userSettings.trackPosition=!1,Settings.save(),f.handleMessage("Standortzugriff abgebrochen.")}})}async function sa(){if(i.watchId!==null){const{Geolocation:t,isNative:e}=await Et();if(e&&t)try{await t.clearWatch({id:i.watchId}),console.log("[LiveTrackingManager] Stopped native Geolocation watcher:",i.watchId)}catch(n){console.error("[LiveTrackingManager] Error stopping native watcher:",n)}else navigator.geolocation&&(navigator.geolocation.clearWatch(i.watchId),console.log("[LiveTrackingManager] Stopped navigator.geolocation watcher:",i.watchId));i.watchId=null}i.liveMarker&&i.map.removeLayer(i.liveMarker),i.accuracyCircle&&i.map.removeLayer(i.accuracyCircle),i.liveMarker=null,i.accuracyCircle=null,i.prevLat=null,i.prevLng=null,i.altitudeCorrectionOffset=0,document.dispatchEvent(new CustomEvent("tracking:stopped"))}const yr=f.debounce(async t=>{if(console.log("[LiveTrackingManager] Received position data:",t),!i.map){console.warn("[LiveTrackingManager] Map not initialized, skipping position update.");return}const{latitude:e,longitude:n,accuracy:a,altitude:r,altitudeAccuracy:o}=t.coords;if(i.recordedTrackPoints.length===0&&i.altitudeCorrectionOffset===0&&r!==null&&i.lastAltitude!=="N/A"){const w=Math.abs(r-i.lastAltitude);w<150?(i.altitudeCorrectionOffset=r-i.lastAltitude,console.log(`Bodenstart erkannt. Korrektur-Offset berechnet: ${i.altitudeCorrectionOffset.toFixed(2)}m`)):(i.altitudeCorrectionOffset=0,console.warn(`Start in der Luft erkannt (Höhendifferenz: ${w.toFixed(0)}m). Es wird keine Höhenkorrektur angewendet.`),f.handleMessage("Airborne start: Altitudes are uncorrected (Ellipsoid)."))}const s=r!==null&&i.altitudeCorrectionOffset!==0?r-i.altitudeCorrectionOffset:r,c=!i.liveMarker?500:ke.GEOLOCATION_ACCURACY_THRESHOLD_M;if(a>c){console.log(`[LiveTrackingManager] Skipping position update. Accuracy (${a}m) is lower than threshold (${c}m).`);return}const u=Date.now();let d=0,m="N/A",p=0;if(i.prevLat!==null&&i.prevLng!==null&&i.prevTime!==null&&i.prevAltitude!==null){const w=(u-i.prevTime)/1e3;w>Yt.MIN_TIME_DIFF_FOR_SPEED_CALC_S&&(d=i.map.distance([i.prevLat,i.prevLng],[e,n])/w,m=f.calculateBearing(i.prevLat,i.prevLng,e,n),p=(r-i.prevAltitude)/w)}const h=d<Yt.SPEED_SMOOTHING_TRESHOLD?Yt.SPEED_SMOOTHING_LOW:Yt.SPEED_SMOOTHING_HIGH;i.lastSmoothedSpeedMs=h*d+(1-h)*i.lastSmoothedSpeedMs;const v=.5;i.lastSmoothedRateOfClimbMps=v*p+(1-v)*(i.lastSmoothedRateOfClimbMps||0),i.liveMarker?(i.liveMarker.setLatLng([e,n]),i.liveMarker.setIcon(wr(m))):i.liveMarker=L.marker([e,n],{icon:wr(m),zIndexOffset:1e3,pmIgnore:!0}).addTo(i.map),a&&wu(e,n,a),i.prevLat=e,i.prevLng=n,i.prevTime=u,i.prevAltitude=r;const S=new CustomEvent("tracking:positionUpdated",{detail:{latitude:e,longitude:n,deviceAltitude:s,altitudeAccuracy:o,accuracy:a,speedMs:i.lastSmoothedSpeedMs,rateOfClimbMps:i.lastSmoothedRateOfClimbMps,direction:typeof m=="number"?m.toFixed(0):"N/A"},bubbles:!0,cancelable:!0});console.log("[LiveTrackingManager] Dispatching tracking:positionUpdated with data:",S.detail),document.dispatchEvent(S)},300);function wr(t){const n=`
        <div class="live-marker-wrapper" style="transform: rotate(${typeof t=="number"&&isFinite(t)?t:0}deg);">
            <div class="live-marker-dot"></div>
            <div class="live-marker-arrow"></div>
        </div>
    `;return L.divIcon({className:"live-marker-container",html:n,iconSize:[24,24],iconAnchor:[12,12],pmIgnore:!0})}function wu(t,e,n){i.accuracyCircle&&i.map.removeLayer(i.accuracyCircle),i.accuracyCircle=L.circle([t,e],{radius:n,color:"blue",fillOpacity:.1,weight:1,dashArray:"5, 5",pmIgnore:!0}).addTo(i.map)}async function vu(){const{Geolocation:t}=await Et();let e=await t.checkPermissions();if(console.log("Initial geolocation permissions state:",e),e.location==="denied")return f.handleError('GPS permission was denied. Please enable "Always" in the app settings.'),!1;if(e.location==="prompt"||e.location==="prompt-with-rationale")try{if(e=await t.requestPermissions({permissions:["location","coarseLocation"]}),console.log("New geolocation permissions state:",e),window.Capacitor.getPlatform()==="ios"&&e.location!=="granted")return f.handleError('Please allow "Always" location access in Settings for background tracking.'),!1}catch(n){return console.error("[LiveTrackingManager] Permission request error:",n),f.handleError(`Failed to request permissions: ${n.message}`),!1}return e.location!=="granted"?(f.handleError("GPS permission is required for live tracking."),!1):!0}let Dt=null;const Go="https://corsproxy.io/?",Vo='ADS-B Data provided by <a href="https://www.adsbexchange.com/" target="_blank">ADSBexchange.com</a>',Aa=new Headers;Aa.append("Accept","application/json");async function Lu(){if(Dt){Zo(),f.handleMessage("ADSB-Tracking gestoppt.");return}if(!i.liveMarker){f.handleError("Bitte starte zuerst das Live-Tracking.");return}f.handleMessage("Suche nach Flugzeugen in der Nähe...");try{const t=i.liveMarker.getLatLng(),e=`https://api.adsb.lol/v2/lat/${t.lat}/lon/${t.lng}/dist/15`,n=await fetch(Go+encodeURIComponent(e),{headers:Aa});if(!n.ok){const o=await n.json().catch(()=>({msg:"Unbekannter API-Fehler"}));throw new Error(`API Error ${n.status}: ${o.msg}`)}const a=await n.json();if(!a.ac||a.ac.length===0){f.handleMessage("Keine Flugzeuge in der Nähe gefunden.");return}const r=a.ac.filter(o=>o.lat&&o.lon&&o.alt_baro).map(o=>({icao24:o.hex,callsign:o.flight?o.flight.trim():"N/A",altitude:o.alt_baro,lat:o.lat,lon:o.lon,track:o.track,velocity:o.gs,vertical_rate:o.baro_rate}));Mu(r)}catch(t){console.error("Fehler bei der ADSB-Abfrage:",t),f.handleError(`Konnte Flugzeugdaten nicht abrufen: ${t.message}`)}}function Mu(t){const e=document.getElementById("adsbSelectionModal"),n=document.getElementById("aircraftList"),a=document.getElementById("adsbCancel");!e||!n||!a||(n.innerHTML="",t.sort((r,o)=>o.altitude-r.altitude),t.forEach(r=>{const o=document.createElement("li");o.textContent=`${r.callsign} / ${r.altitude} ft`,o.onclick=()=>{e.style.display="none",Su(r)},n.appendChild(o)}),a.onclick=()=>{e.style.display="none"},e.style.display="flex")}function Su(t){f.handleMessage(`Tracking ${t.callsign}...`);const e=document.getElementById("findJumpShipBtn");e&&(e.textContent="Stop ADSB Tracking",e.classList.remove("btn-secondary"),e.classList.add("btn-danger")),i.aircraftMarker&&i.map.removeLayer(i.aircraftMarker),i.adsbTrackPoints=[[t.lat,t.lon]],$o(),ec(t.lat,t.lon,t.track).bindTooltip("",{permanent:!0,direction:"top",offset:[0,-15],className:"adsb-tooltip"}),vr(t),i.map&&i.map.attributionControl&&i.map.attributionControl.addAttribution(Vo);const a=async()=>{try{const r=`https://api.adsb.lol/v2/hex/${t.icao24}`,o=await fetch(Go+encodeURIComponent(r),{headers:Aa});if(o.status===404){Zo(),f.handleMessage(`${t.callsign} ist nicht mehr sichtbar. Tracking gestoppt.`);return}if(!o.ok)throw new Error(`API Error ${o.status}`);const s=await o.json();if(s.ac&&s.ac.length>0){const l=s.ac[0],c={icao24:l.hex,callsign:l.flight?l.flight.trim():"N/A",lat:l.lat,lon:l.lon,track:l.track,altitude:l.alt_baro,velocity:l.gs,vertical_rate:l.baro_rate};i.aircraftMarker&&c.lat&&c.lon&&(i.aircraftMarker.setLatLng([c.lat,c.lon]),i.aircraftMarker.setRotationAngle(c.track),vr(c),i.adsbTrackPoints.push([c.lat,c.lon]),Ul(i.adsbTrackPoints))}}catch(r){console.error("Fehler beim ADSB-Tracking:",r)}};a(),Dt=setInterval(a,1e4)}function Zo(){Dt&&(clearInterval(Dt),Dt=null),i.aircraftMarker&&(i.map.removeLayer(i.aircraftMarker),i.aircraftMarker=null),$o(),i.adsbTrackPoints=[],i.map&&i.map.attributionControl&&i.map.attributionControl.removeAttribution(Vo);const t=document.getElementById("findJumpShipBtn");t&&(t.textContent="Find Aircraft",t.classList.remove("btn-danger"),t.classList.add("btn-secondary"))}function vr(t){if(!i.aircraftMarker)return;const e=g.getValue("heightUnit","m"),n=g.getValue("windUnit","kt"),a=t.altitude,r=e==="m"?`${Math.round(a*.3048)} m`:`${a} ft`,o=t.velocity,s=f.convertWind(o,n,"kt"),l=`${n==="bft"?Math.round(s):s.toFixed(0)} ${n}`;let c="Level";if(t.vertical_rate){const d=t.vertical_rate;d>100?c=`+${d} ft/min`:d<-100&&(c=`${d} ft/min`)}const u=`
        <strong>${t.callsign||"N/A"}</strong><br>
        Höhe: ${r}<br>
        Speed: ${l}<br>
        V/S: ${c}
    `;i.aircraftMarker.setTooltipContent(u)}const jo=f.debounce(se,300);L.Control.Coordinates=L.Control.extend({options:{position:"bottomleft"},onAdd:function(t){var e=L.DomUtil.create("div","leaflet-control-coordinates");return e.style.background="rgba(255, 255, 255, 0.8)",e.style.padding="5px",e.style.borderRadius="4px",e.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",e.innerHTML="Move mouse over map",this._container=e,e},update:function(t){this._container.innerHTML=t}});f.setErrorHandler(ln);f.setMessageHandler(Ze);f.handleMessage=Ze;const Jo=()=>g.getValue("temperatureUnit","radio","C"),vt=()=>g.getValue("heightUnit","radio","m"),un=()=>g.getValue("windUnit","radio","kt"),qo=()=>g.getValue("coordFormat","radio","Decimal"),bu=()=>g.getValue("downloadFormat","radio","csv");function Eu(){wl(!0),g.initialize(),g.state.isPlannerUnlocked=g.state.unlockedFeatures.planner,console.log("Initial unlock status for planner:",g.state.isPlannerUnlocked),!i.isInitialized&&(i.isInitialized=!0,console.log("Initializing app"))}function _u(){Pe("modelSelect",g.state.userSettings.model),Pe("refLevel",g.state.userSettings.refLevel),Pe("heightUnit",g.state.userSettings.heightUnit),Pe("temperatureUnit",g.state.userSettings.temperatureUnit),Pe("windUnit",g.state.userSettings.windUnit),Pe("timeZone",g.state.userSettings.timeZone),Pe("coordFormat",g.state.userSettings.coordFormat),Pe("downloadFormat",g.state.userSettings.downloadFormat),Pu("landingDirection",g.state.userSettings.landingDirection),ne("canopySpeed",g.state.userSettings.canopySpeed),ne("descentRate",g.state.userSettings.descentRate),ne("legHeightDownwind",g.state.userSettings.legHeightDownwind),ne("legHeightBase",g.state.userSettings.legHeightBase),ne("legHeightFinal",g.state.userSettings.legHeightFinal),ne("customLandingDirectionLL",g.state.userSettings.customLandingDirectionLL),ne("customLandingDirectionRR",g.state.userSettings.customLandingDirectionRR),ne("lowerLimit",g.state.userSettings.lowerLimit),ne("upperLimit",g.state.userSettings.upperLimit),ne("openingAltitude",g.state.userSettings.openingAltitude),ne("exitAltitude",g.state.userSettings.exitAltitude),ne("safetyHeight",g.state.userSettings.safetyHeight),Pe("interpStep",g.state.userSettings.interpStep),ne("aircraftSpeedKt",g.state.userSettings.aircraftSpeedKt),ne("jumpRunTrackOffset",g.state.userSettings.jumpRunTrackOffset),ne("numberOfJumpers",g.state.userSettings.numberOfJumpers),et("showTableCheckbox",g.state.userSettings.showTable),et("calculateJumpCheckbox",g.state.userSettings.calculateJump),et("showLandingPattern",g.state.userSettings.showLandingPattern),et("showJumpRunTrack",g.state.userSettings.showJumpRunTrack),et("showCanopyAreaCheckbox",g.state.userSettings.showCanopyArea),et("showExitAreaCheckbox",g.state.userSettings.showExitArea),et("showCutAwayFinder",g.state.userSettings.showCutAwayFinder),ne("terrainClearance",g.state.userSettings.terrainClearance),g.state.userSettings.isCustomJumpRunDirection=g.state.userSettings.isCustomJumpRunDirection||!1;const t=document.getElementById("customLandingDirectionLL"),e=document.getElementById("customLandingDirectionRR");t&&g.state.userSettings.customLandingDirectionLL!==""&&!isNaN(g.state.userSettings.customLandingDirectionLL)&&(t.value=g.state.userSettings.customLandingDirectionLL),e&&g.state.userSettings.customLandingDirectionRR!==""&&!isNaN(g.state.userSettings.customLandingDirectionRR)&&(e.value=g.state.userSettings.customLandingDirectionRR);const n=No(g.state.userSettings.aircraftSpeedKt);ne("jumperSeparation",n),g.state.userSettings.jumperSeparation=n,g.save();const a=document.getElementById("showJumpMasterLine");a&&(a.disabled=!g.state.userSettings.trackPosition,a.style.opacity=a.disabled?"0.5":"1",a.title=a.disabled?"Enable Live Tracking to use Jump Master Line":"");const r=document.getElementById("jumpRunTrackDirection");r&&(r.textContent="-"),Ko()}function se(){const t=ae(),e=Ce(),n=vt();let a=g.state.userSettings.openingAltitude,r=g.state.userSettings.exitAltitude;if(n==="ft"&&(a=f.convertFeetToMeters(a),r=f.convertFeetToMeters(r)),!g.state.userSettings.calculateJump){tn(null),na(null);return}if(!i.weatherData||!i.lastLat||!i.lastLng){tn(null);return}const o=Se(i.weatherData,t,e,Math.round(i.lastAltitude),n),s={exitCircles:[],canopyCircles:[],canopyLabels:[]};if(g.state.userSettings.showExitArea){const c=Po(o);if(c){s.exitCircles.push({center:[c.greenLatFull,c.greenLngFull],radius:c.greenRadius,color:"green",fillColor:"green",fillOpacity:.2,weight:2});const u=`
                Exit areas calculated with:<br>
                Throw/Drift: ${Number.isFinite(c.freeFallDirection)?Math.round(c.freeFallDirection):"N/A"}° ${Number.isFinite(c.freeFallDistance)?Math.round(c.freeFallDistance):"N/A"} m<br>
                Free Fall Time: ${c.freeFallTime!=null&&!isNaN(c.freeFallTime)?Math.round(c.freeFallTime):"N/A"} sec
            `;s.exitCircles.push({center:[c.greenLat,c.greenLng],radius:c.darkGreenRadius,color:"darkgreen",fillColor:"darkgreen",fillOpacity:.2,weight:2,tooltip:u})}}if(g.state.userSettings.showCanopyArea){const c=Do(o);if(c){const u=f.calculateNewCenter(c.redLat,c.redLng,c.displacementFull,c.directionFull);s.canopyCircles.push({center:u,radius:c.radiusFull,color:"red",weight:2,opacity:.8,fillOpacity:0}),c.additionalBlueRadii.forEach((d,m)=>{const p=f.calculateNewCenter(c.blueLat,c.blueLng,c.additionalBlueDisplacements[m],c.additionalBlueDirections[m]);s.canopyCircles.push({center:p,radius:d,color:"blue",weight:1,fillColor:"blue",fillOpacity:.1,opacity:1}),s.canopyLabels.push({center:p,radius:d,text:`${Math.round(c.additionalBlueUpperLimits[m])}m`})})}}tn(s);let l=null;if(g.state.userSettings.showCutAwayFinder&&i.cutAwayLat!==null){const c=va(o);c&&(l={center:c.center,radius:c.radius,tooltipContent:c.tooltipContent})}na(l)}function nt(){var A;console.log("Calculating mean wind with model:",document.getElementById("modelSelect").value,"weatherData:",i.weatherData);const t=((A=document.getElementById("refLevel"))==null?void 0:A.value)||"AGL",e=g.getValue("heightUnit","radio","m"),n=g.getValue("windUnit","radio","kt"),a=document.getElementById("timeSlider").value||0,r=Se(i.weatherData,a,Ce(),Math.round(i.lastAltitude),e);let o=parseFloat(document.getElementById("lowerLimit").value)||0,s=parseFloat(document.getElementById("upperLimit").value);const l=Math.round(i.lastAltitude);if(!i.weatherData||i.lastAltitude==="N/A"){f.handleError("Cannot calculate mean wind: missing data or altitude");return}o=e==="ft"?o/3.28084:o,s=e==="ft"?s/3.28084:s;let c=t==="AGL"?o+l:o,u=t==="AGL"?s+l:s;if(isNaN(o)||isNaN(s)||o>=s){f.handleError("Invalid layer limits. Ensure Lower < Upper and both are numbers.");return}if(t==="AMSL"&&u<l){f.handleError(`The entire selected layer (${Math.round(f.convertHeight(c,e))}-${Math.round(f.convertHeight(u,e))} ${e}) is below the terrain altitude of ${Math.round(f.convertHeight(l,e))} ${e}.`),document.getElementById("meanWindResult").innerHTML="Mean wind: N/A (Layer is below ground)";return}if(t==="AMSL"&&c<l){f.handleMessage(`Note: Lower limit adjusted to terrain altitude (${Math.round(f.convertHeight(l,e))} ${e}) as it cannot be below ground level.`);const T=Math.round(f.convertHeight(l,e));ne("lowerLimit",T),g.state.userSettings.lowerLimit=T,g.save(),c=l}if(!r||r.length===0){f.handleError("No valid weather data available to calculate mean wind.");return}const d=r.map(T=>T.height),m=r.map(T=>parseFloat(T.dir)||0),p=r.map(T=>f.convertWind(parseFloat(T.spd)||0,n,"km/h")),h=p.map((T,N)=>-T*Math.sin(m[N]*Math.PI/180)),v=p.map((T,N)=>-T*Math.cos(m[N]*Math.PI/180)),S=f.calculateMeanWind(d,h,v,c,u),[w,M]=S,y=f.roundToTens(w)===0&&w>=0&&w<5?360:f.roundToTens(w),_=Math.round(f.convertHeight(o,e)),b=Math.round(f.convertHeight(s,e));f.convertWind(M,n,"kt");const E=Number.isFinite(M)?n==="bft"?Math.round(M):M.toFixed(1):"N/A",k=`Mean wind (${_}-${b} ${e} ${t}): ${y}° ${E} ${n}`;document.getElementById("meanWindResult").innerHTML=k,console.log("Calculated Mean Wind:",k,"u:",S[2],"v:",S[3])}async function ku(){if(!i.lastLat||!i.lastLng){console.warn("No location selected, cannot update weather data"),f.handleError("Please select a location to enable autoupdate."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,g.state.userSettings.autoupdate=!1,g.save();return}if(!navigator.onLine){console.warn("Cannot update weather data: offline"),f.handleError("Cannot update weather data while offline."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,g.state.userSettings.autoupdate=!1,g.save();return}const t=document.getElementById("timeSlider");if(!t){console.warn("Time slider not found, cannot update to current hour");return}const n=new Date().getUTCHours();t.value=n,console.log(`Set slider to current hour: ${n}`);try{await tt(i.lastLat,i.lastLng,null,!1),console.log("Weather data fetched for current hour"),await Be(n,"weather-table-container","selectedTime"),i.lastAltitude!=="N/A"&&nt(),g.state.userSettings.calculateJump&&g.state.isCalculateJumpUnlocked&&(jo(),va(),g.state.userSettings.showJumpRunTrack&&he()),console.log("Updated all displays for current hour")}catch(a){console.error("Error updating to current hour:",a),f.handleError("Failed to update weather data: "+a.message)}}function Tu(t){var v;if(!i.weatherData||!i.weatherData.time){f.handleError("No weather data available to download.");return}const e=document.getElementById("timeSlider").value||0,n=document.getElementById("modelSelect").value.toUpperCase(),a=f.formatTime(i.weatherData.time[e]).replace(" ","_"),r=`${a}_${n}_${t}.txt`,s={ATAK:{interpStep:1e3,heightUnit:"ft",refLevel:"AGL",windUnit:"kt"},Windwatch:{interpStep:100,heightUnit:"ft",refLevel:"AGL",windUnit:"km/h"},HEIDIS:{interpStep:100,heightUnit:"m",refLevel:"AGL",temperatureUnit:"C",windUnit:"m/s"},Customized:{}}[t]||{},l={interpStep:s.interpStep||Ce(),heightUnit:s.heightUnit||g.getValue("heightUnit","radio","m"),refLevel:s.refLevel||((v=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:v.value)||"AGL",windUnit:s.windUnit||g.getValue("windUnit","radio","kt"),temperatureUnit:s.temperatureUnit||g.getValue("temperatureUnit","radio","C")},c=Se(i.weatherData,e,l.interpStep,Math.round(i.lastAltitude),l.heightUnit);if(!c||c.length===0){f.handleError("No interpolated data available to download.");return}let u="",d="";switch(t){case"ATAK":d=`Alt	Dir	Spd
${l.heightUnit}${l.refLevel}	deg	kts
`;break;case"Windwatch":const S=Math.round(f.convertHeight(i.lastAltitude,"ft"));d=`Version 1.0, ID = 9999999999
${a}, Ground Level: ${S} ft
Windsond ${n}
AGL[ft] Wind[°] Speed[km/h]
`;break;case"HEIDIS":case"Customized":default:d=`h(${l.heightUnit}${l.refLevel}) p(hPa) T(${l.temperatureUnit}) Dew(${l.temperatureUnit}) Dir(°) Spd(${l.windUnit}) RH(%)
`;break}u+=d,c.forEach(S=>{const w=Math.round(S.displayHeight),M=Math.round(S.dir),y=f.convertWind(S.spd,l.windUnit,"km/h"),_=Number.isFinite(y)?l.windUnit==="bft"?Math.round(y):y.toFixed(1):"N/A";if(t==="ATAK"||t==="Windwatch")u+=`${w}	${M}	${Math.round(y)}
`;else{const b=S.pressure==="N/A"?"N/A":S.pressure.toFixed(1),E=f.convertTemperature(S.temp,l.temperatureUnit),k=E==="N/A"?"N/A":E.toFixed(1),A=f.convertTemperature(S.dew,l.temperatureUnit),T=A==="N/A"?"N/A":A.toFixed(1),N=S.rh==="N/A"?"N/A":Math.round(S.rh);u+=`${w} ${b} ${k} ${T} ${M} ${_} ${N}
`}});const m=new Blob([u],{type:"text/plain"}),p=window.URL.createObjectURL(m),h=document.createElement("a");h.href=p,h.download=r,document.body.appendChild(h),h.click(),document.body.removeChild(h),window.URL.revokeObjectURL(p)}async function Au(){if(!i.weatherData||!i.weatherData.time){f.handleError("No weather data available to download.");return}const{time:t,wind_direction_10m:e,wind_speed_10m:n,wind_gusts_10m:a,visibility:r,weather_code:o,temperature_2m:s}=i.weatherData,l=un(),c=Jo(),u=vt(),d=g.getValue("timeZone","radio","Z"),m=document.getElementById("modelSelect").value.toUpperCase(),h=`${f.formatTime(t[0]).replace(" ","_")}_${m}_Surface.txt`;let S=`Date	${`Time (${d})`}	Wind Dir (°)	Wind Spd/Gust (${l})	Visibility (m)	Weather	Clouds	Temp (${c})
`;for(let _=0;_<t.length;_++){const b=await f.getDisplayTime(t[_],i.lastLat,i.lastLng,d),[E,k]=b.split(" "),A=f.convertWind(n[_],l,"km/h"),T=f.convertWind(a[_],l,"km/h"),N=typeof A=="number"?A.toFixed(0):"N/A",P=typeof T=="number"?T.toFixed(0):"N/A",x=`${N} G ${P}`,C=f.convertTemperature(s[_],c),I=typeof C=="number"?C.toFixed(1):"N/A",O=f.formatVisibility(r==null?void 0:r[_]),R=f.translateWmoCodeToTaf(o==null?void 0:o[_]),W=Se(i.weatherData,_,100,Math.round(i.lastAltitude),u),z=f.getCloudLayersForMetar(W,u);S+=`${E}	${k}	${e[_]}	${x}	${O}	${R}	${z}	${I}
`}const w=new Blob([S],{type:"text/plain"}),M=window.URL.createObjectURL(w),y=document.createElement("a");y.href=M,y.download=h,document.body.appendChild(y),y.click(),document.body.removeChild(y),window.URL.revokeObjectURL(M)}async function Cu(){if(!i.weatherData||!i.lastLat||!i.lastLng){f.handleError("No weather data available for the report.");return}const t=i.lastLat,e=i.lastLng,n=document.getElementById("modelSelect").value.toUpperCase(),a=i.lastModelRun||"N/A",r=F.utc().toFormat("yyyy-MM-dd"),o=un(),s=Jo(),l=vt(),c=g.getValue("timeZone","radio","Z"),u=g.getValue("upperLimit","number",3e3);let d=`Lat ${t.toFixed(4)}, Lon ${e.toFixed(4)}`;try{d=(await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t}&lon=${e}`)).json()).display_name||d}catch{console.warn("Reverse geocoding failed, using coordinates.")}let m=`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DZMaster Weather Briefing</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 1000px; margin: 20px auto; padding: 20px; }
        h1, h2, h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { padding: 8px 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .header-info { background-color: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .header-info p { margin: 5px 0; }
        .section { margin-top: 40px; }
        @media print {
            body { font-size: 10pt; }
            .container { margin: 0; padding: 0; max-width: 100%; }
            h1, h2, h3 { page-break-after: avoid; }
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>DZMaster - Weather Briefing</h1>
    <div class="header-info">
        <p><strong>Location:</strong> ${d}</p>
        <p><strong>Model:</strong> ${n}</p>
        <p><strong>Model Run:</strong> ${a}</p>
        <p><strong>Forecast Day:</strong> ${r}</p>
    </div>

    <div class="section">
        <h2>Surface Data (Today)</h2>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time (${c})</th>
                    <th>Wind Dir (°)</th>
                    <th>Wind (${o})</th>
                    <th>Visibility (m)</th>
                    <th>Weather</th>
                    <th>Clouds</th>
                    <th>Temp (${s})</th>
                </tr>
            </thead>
            <tbody>`;const{time:p,wind_direction_10m:h,wind_speed_10m:v,wind_gusts_10m:S,visibility:w,weather_code:M,temperature_2m:y}=i.weatherData,_=p.map((E,k)=>F.fromISO(E).toFormat("yyyy-MM-dd")===r?k:-1).filter(E=>E!==-1);for(const E of _){const k=await f.getDisplayTime(p[E],t,e,c),[A,T]=k.split(" "),N=f.convertWind(v[E],o,"km/h"),P=f.convertWind(S[E],o,"km/h"),x=`${typeof N=="number"?N.toFixed(0):"N/A"} G ${typeof P=="number"?P.toFixed(0):"N/A"}`,C=f.convertTemperature(y[E],s),I=Se(i.weatherData,E,100,Math.round(i.lastAltitude),l),O=f.getCloudLayersForMetar(I,l),R=f.formatWindDirection(h[E]),W=f.formatVisibility(w==null?void 0:w[E]);m+=`<tr>
            <td>${A}</td>
            <td>${T}</td>
            <td>${R}</td>
            <td>${x}</td>
            <td>${W}</td>
            <td>${f.translateWmoCodeToTaf(M==null?void 0:M[E])}</td>
            <td>${O}</td>
            <td>${typeof C=="number"?C.toFixed(0):"N/A"}</td>
        </tr>`}m+="</tbody></table></div>",m+=`<div class="section">
                <h2>Upper Air Data (Today, hourly, up to ${u}${l} AGL)</h2>`;for(const E of _){const k=await f.getDisplayTime(p[E],t,e,"Z");m+=`<h3>${k}</h3>
                 <table>
                    <thead>
                        <tr>
                            <th>h(${l} AGL)</th>
                            <th>p(hPa)</th>
                            <th>T(${s})</th>
                            <th>Dew(${s})</th>
                            <th>Dir(°)</th>
                            <th>Spd(${o})</th>
                            <th>RH(%)</th>
                            <th>Clouds(%)</th>
                        </tr>
                    </thead>
                    <tbody>`,Se(i.weatherData,E,100,Math.round(i.lastAltitude),l).filter(T=>T.displayHeight<=u).forEach(T=>{const N=f.convertTemperature(T.temp,s),P=f.convertTemperature(T.dew,s),x=f.convertWind(T.spd,o,"km/h"),C=f.formatWindDirection(T.dir);m+=`<tr>
                    <td>${T.displayHeight}</td>
                    <td>${typeof T.pressure=="number"?T.pressure.toFixed(1):"N/A"}</td>
                    <td>${typeof N=="number"?N.toFixed(1):"N/A"}</td>
                    <td>${typeof P=="number"?P.toFixed(1):"N/A"}</td>
                    <td>${C}</td>
                    <td>${typeof x=="number"?x.toFixed(1):"N/A"}</td>
                    <td>${typeof T.rh=="number"?Math.round(T.rh):"N/A"}</td>
                    <td>${typeof T.cc=="number"?Math.round(T.cc):"N/A"}</td>
                </tr>`}),m+="</tbody></table>"}m+="</div></div></body></html>";const b=window.open();b.document.open(),b.document.write(m),b.document.close()}function Lr(t=!0){g.state.userSettings.customJumpRunDirection=null,g.save(),console.log("Persisted custom JRT direction has been reset.");const e=document.getElementById("jumpRunTrackDirection");e&&(e.value=""),t&&g.state.userSettings.showJumpRunTrack&&i.weatherData&&he()}async function Ft(t,e=null){i.weatherData=t,i.cloudThresholds=Io(t);const n=document.getElementById("timeSlider");if(!n)return;const r=(o=>{const s=o==null?void 0:o.temperature_2m;if(!s||s.length===0)return 0;for(let l=s.length-1;l>=0;l--)if(s[l]!==null&&s[l]!==void 0)return l;return 0})(t);if(n.max=r,n.disabled=n.max<=0,e!==null&&e<=r)n.value=e,console.log(`Slider restored to preserved index: ${e}`);else{const o=new Date().getUTCHours();o<=r?n.value=o:n.value=r,console.log(`Slider set to default (current hour or max): ${n.value}`)}await Uo(),await Be(n.value,"weather-table-container","selectedTime"),await ze(),i.lastAltitude!=="N/A"&&nt(),yc(),console.log("Model changed. Triggering recalculation of jump parameters."),_e(),g.state.userSettings.calculateJump&&se(),g.state.userSettings.showJumpRunTrack&&he()}function Ko(){const t=document.getElementById("info");t&&(t.style.display=g.state.userSettings.showTable?"block":"none");const e=document.getElementById("customLandingDirectionLL"),n=document.getElementById("customLandingDirectionRR"),a=document.getElementById("showJumpRunTrack"),r=document.getElementById("showExitAreaCheckbox");e&&(e.disabled=g.state.userSettings.landingDirection!=="LL"),n&&(n.disabled=g.state.userSettings.landingDirection!=="RR"),a&&(a.disabled=!g.state.userSettings.calculateJump),r&&(r.disabled=!g.state.userSettings.calculateJump)}function Mr(){const t=document.querySelector('.sidebar-icon[data-panel-id="panel-planner"]');t&&(g.isFeatureUnlocked("planner")?(t.style.opacity="1",t.title="Planner"):(t.style.opacity="0.5",t.title="Feature locked. Click to enter password."));const e=document.querySelector('.sidebar-icon[data-panel-id="panel-data"]');e&&(g.isFeatureUnlocked("data")?(e.style.opacity="1",e.title="Data"):(e.style.opacity="0.5",e.title="Feature locked. Click to enter password."))}function fe(t=null){const e=g.state.userSettings.showJumpMasterLine;let n=null,a=null;if(i.watchId!==null&&(a=i.liveMarker?i.liveMarker.getLatLng():null,n=t||{latitude:a?a.lat:i.lastLatitude,longitude:a?a.lng:i.lastLongitude,speedMs:i.lastSmoothedSpeedMs,direction:i.lastDirection,deviceAltitude:i.lastDeviceAltitude,altitudeAccuracy:i.lastAltitudeAccuracy,accuracy:i.lastAccuracy},n.showJumpMasterLine=e),e&&a){let r=null,o="";if(g.state.userSettings.jumpMasterLineTarget==="HARP"&&i.harpMarker?(r=i.harpMarker.getLatLng(),o="HARP"):i.currentMarker&&(r=i.currentMarker.getLatLng(),o="DIP"),r){const s=i.map.distance(a,r),l=Math.round(f.calculateBearing(a.lat,a.lng,r.lat,r.lng)),c=n.speedMs>1?n.speedMs:1,u=Math.round(s/c);n.jumpMasterLineData={distance:s,bearing:l,tot:u,target:o},Rl(a,r)}}else Vl();Iu(n)}function Iu(t){const e=document.getElementById("jumpmaster-dashboard");if(!e)return;if(!t){e.classList.add("hidden");return}e.classList.remove("hidden");const n=document.getElementById("dashboard-jm-coords"),a=document.getElementById("dashboard-jm-altitude"),r=document.getElementById("dashboard-jm-direction"),o=document.getElementById("dashboard-jm-speed"),s=document.getElementById("dashboard-jm-accuracy"),l=document.getElementById("dashboard-jm-vario"),c={heightUnit:vt(),effectiveWindUnit:un()==="bft"?"kt":un(),coordFormat:qo(),refLevel:g.getValue("refLevel","radio","AGL")},u=f.convertCoords(t.latitude,t.longitude,c.coordFormat);let d;if(c.coordFormat==="MGRS")d=u.lat;else if(c.coordFormat==="DMS"){const w=M=>`${M.deg}°${M.min}'${M.sec.toFixed(0)}" ${M.dir}`;d=`${w(u.lat)}, ${w(u.lng)}`}else d=`${u.lat}, ${u.lng}`;n.textContent=d;let m="N/A";if(t.deviceAltitude!==null){let w=c.refLevel==="AGL"&&i.lastAltitude?t.deviceAltitude-parseFloat(i.lastAltitude):t.deviceAltitude;m=`${Math.round(f.convertHeight(w,c.heightUnit))} ${c.heightUnit}`}a.textContent=m,r.textContent=`${t.direction}°`;const p=f.convertWind(t.speedMs,c.effectiveWindUnit,"m/s"),h=c.effectiveWindUnit==="bft"?Math.round(p):p.toFixed(1);if(o.textContent=`${h} ${c.effectiveWindUnit}`,s.textContent=`± ${Math.round(f.convertHeight(t.accuracy,c.heightUnit))} ${c.heightUnit}`,l){const{rateOfClimbMps:w}=t,M=c.heightUnit==="ft"?"ft/min":"m/s";let y="N/A";l.classList.remove("vario-climb","vario-descent"),w!==null&&Number.isFinite(w)&&(M==="ft/min"?y=(w*196.85).toFixed(0):y=w.toFixed(1),w>.5?l.classList.add("vario-climb"):w<-.5&&l.classList.add("vario-descent")),l.textContent=`${y} ${M}`}const v=document.getElementById("jumpmaster-line-details"),S=t.showJumpMasterLine;if(v.classList.toggle("hidden",!S),S){const w=document.getElementById("dashboard-jm-target-label"),M=document.getElementById("dashboard-jm-bearing"),y=document.getElementById("dashboard-jm-distance"),_=document.getElementById("dashboard-jm-tot");if(t.jumpMasterLineData){const b={heightUnit:vt()};w.textContent=`JML to ${t.jumpMasterLineData.target}`,M.textContent=`${t.jumpMasterLineData.bearing}°`,y.textContent=`${Math.round(f.convertHeight(t.jumpMasterLineData.distance,b.heightUnit))} ${b.heightUnit}`,_.textContent=t.jumpMasterLineData.tot<1200?`X - ${t.jumpMasterLineData.tot} s`:"N/A"}else w.textContent="JML to --",M.textContent="--",y.textContent="--",_.textContent="--"}}function Nu(){console.log("[App] Setting up application event listeners..."),document.addEventListener("map:moved",()=>{console.log("[main-web] Map has moved or zoomed. Updating visualizations based on new view.");const t=i.map.getZoom();g.state.userSettings.calculateJump&&i.weatherData&&i.lastLat&&(t<ke.MIN_ZOOM||t>ke.MAX_ZOOM?tn(null):se()),g.state.userSettings.showJumpRunTrack&&(t<ke.MIN_ZOOM||t>ke.MAX_ZOOM?Pt(null):he()),g.state.userSettings.showLandingPattern&&_e(),g.state.userSettings.selectedEnsembleModels.length>0&&(t<ke.MIN_ZOOM||t>ke.MAX_ZOOM?Bt():rt(ae(),Ce())),Ma({map:i.map,baseMaps:i.baseMaps,onProgress:Ot,onComplete:e=>{$e(),e&&f.handleMessage(e)},onCancel:()=>{$e(),f.handleMessage("Caching cancelled.")}})}),document.addEventListener("map:mousemove",t=>{const{lat:e,lng:n}=t.detail;i.lastMouseLatLng={lat:e,lng:n};const a=qo();let r;if(a==="MGRS")r=`MGRS: ${f.decimalToMgrs(e,n)||"N/A"}`;else if(a==="DMS"){const o=s=>`${s.deg}°${s.min}'${s.sec.toFixed(0)}" ${s.dir}`;r=`Lat: ${o(f.decimalToDms(e,!0))}, Lng: ${o(f.decimalToDms(n,!1))}`}else r=`Lat: ${e.toFixed(5)}, Lng: ${n.toFixed(5)}`;i.coordsControl&&i.coordsControl.update(`${r}<br>Elevation: Fetching...<br>QFE: Fetching...`),f.debouncedGetElevationAndQFE(e,n,({elevation:o})=>{var s,l;if(i.lastMouseLatLng&&i.coordsControl){const c=Math.abs(i.lastMouseLatLng.lat-e),u=Math.abs(i.lastMouseLatLng.lng-n),d=.05;if(c<d&&u<d){const m=vt();let p=o==="N/A"?"N/A":o;p!=="N/A"&&(p=f.convertHeight(p,m),p=Math.round(p));let h="N/A";if(o!=="N/A"&&i.weatherData&&i.weatherData.surface_pressure){const v=parseInt((s=document.getElementById("timeSlider"))==null?void 0:s.value)||0,S=i.weatherData.surface_pressure[v],w=((l=i.weatherData.temperature_2m)==null?void 0:l[v])||15,M=i.lastAltitude!=="N/A"?i.lastAltitude:0,y=f.calculateQFE(S,o,M,w);h=y!=="N/A"?`${y} hPa`:"N/A"}i.coordsControl.update(`${r}<br>Elevation: ${p} ${p==="N/A"?"":m}<br>QFE: ${h}`)}}})}),document.addEventListener("map:location_selected",async t=>{const{lat:e,lng:n,source:a}=t.detail;console.log(`App: Event 'map:location_selected' von '${a}' empfangen.`),i.lastLat=e,i.lastLng=n,i.lastAltitude=await f.getAltitude(e,n),Ho(e,n),Lr(!0),await tt(e,n),g.state.userSettings.calculateJump&&(se(),va()),cn(!0),i.isManualPanning=!1,he(),_e()}),document.addEventListener("favorites:updated",t=>{const{favorites:e}=t.detail;console.log("[App] Favorites updated, redrawing markers on map."),Ro(e)}),document.addEventListener("tracking:started",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.disabled=!1,t.style.opacity="1",t.title="")}),document.addEventListener("tracking:stopped",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.checked=!1,t.disabled=!0,t.style.opacity="0.5",t.title="Enable Live Tracking to use Jump Master Line"),g.state.userSettings.showJumpMasterLine&&(g.state.userSettings.showJumpMasterLine=!1,g.save()),fe()}),document.addEventListener("track:loaded",async t=>{const e=document.getElementById("loading");try{const{lat:n,lng:a,timestamp:r,historicalDate:o,summary:s}=t.detail;if(console.log('[main-web] Event "track:loaded" empfangen, starte korrigierte Aktionen.'),o){const u=document.getElementById("autoupdateCheckbox");u&&(u.checked=!1),zo(),g.state.userSettings.autoupdate=!1,g.save(),f.handleMessage("Autoupdate disabled for historical track viewing.")}await vn(n,a);const l=await tt(n,a,r);if(l){i.weatherData=l;const u=document.getElementById("timeSlider");if(u&&i.weatherData.time){u.max=i.weatherData.time.length-1,u.disabled=u.max<=0;const d=new Date(r).getTime();let m=0,p=1/0;i.weatherData.time.forEach((h,v)=>{const S=Math.abs(new Date(h).getTime()-d);S<p&&(p=S,m=v)}),u.value=m}}await Be(ae(),"weather-table-container","selectedTime"),await ze(),nt(),se(),_e();const c=document.getElementById("info");if(c&&s){const u=/(<br><strong>Available Models:<\/strong><ul>.*?<\/ul>|<br><strong>Available Models:<\/strong> None)/s,d=c.innerHTML.match(u);c.innerHTML=s+(d?d[0]:"")}if(o){const u=document.getElementById("historicalDatePicker");u&&(u.value=o)}}catch(n){console.error("Fehler bei der Verarbeitung von track:loaded:",n),f.handleError("Konnte Track-Daten nicht vollständig verarbeiten.")}finally{e&&(e.style.display="none")}}),document.addEventListener("tracking:positionUpdated",t=>{fe(t.detail)}),document.addEventListener("jml:targetChanged",()=>{fe()}),document.addEventListener("ui:sliderChanged",async t=>{console.log("[main-web] Event 'ui:sliderChanged' empfangen, spezifische Updates werden ausgeführt.");try{const e=ae();i.weatherData&&i.lastLat&&i.lastLng&&(await Be(e,"weather-table-container","selectedTime"),await ze(),i.lastAltitude!=="N/A"&&nt(),_e(),g.state.userSettings.calculateJump&&se(),g.state.userSettings.showJumpRunTrack&&he(),rt(e,Ce()))}catch(e){console.error("Error during slider update:",e),ln(e.message)}}),document.addEventListener("ui:settingChanged",async t=>{const{name:e,value:n}=t.detail;switch(console.log(`[main-web] Setting '${e}' changed to '${n}'. Performing updates.`),e==="timeZone"&&await Uo(),["refLevel","heightUnit","temperatureUnit","windUnit","timeZone"].includes(e)&&await Be(ae(),"weather-table-container","selectedTime"),e){case"heightUnit":case"windUnit":case"refLevel":nt(),g.getValue("calculateJump","checkbox",!1)&&se(),_e(),fe(),await ze();break;case"coordFormat":if(await ze(),fe(),i.map&&i.lastMouseLatLng){const a=new MouseEvent("mousemove",{bubbles:!0,cancelable:!0,clientX:i.lastMouseLatLng.x,clientY:i.lastMouseLatLng.y});i.map.getContainer().dispatchEvent(a)}break}}),document.addEventListener("ui:radioGroupChanged",async t=>{const{name:e,value:n}=t.detail;if(console.log(`[main-web] Radio group '${e}' changed to '${n}'. Performing updates.`),e==="heightUnit"){const a=document.getElementById("lowerLimit"),r=document.getElementById("upperLimit");if(a&&r){let o=parseFloat(a.value),s=parseFloat(r.value);!isNaN(o)&&!isNaN(s)&&(n==="ft"?(a.value=Math.round(o*3.28084),r.value=Math.round(s*3.28084)):(a.value=Math.round(o/3.28084),r.value=Math.round(s/3.28084)),g.state.userSettings.lowerLimit=a.value,g.state.userSettings.upperLimit=r.value,g.save())}}switch(["refLevel","heightUnit","temperatureUnit","windUnit","timeZone"].includes(e)&&await Be(ae(),"weather-table-container","selectedTime"),e){case"heightUnit":case"windUnit":case"refLevel":nt(),g.getValue("calculateJump","checkbox",!1)&&se(),_e(),fe(),await ze();break;case"coordFormat":await ze(),fe();break;case"landingDirection":Ko(),_e(),se();break}}),document.addEventListener("ui:inputChanged",async t=>{const{name:e,value:n}=t.detail;switch(console.log(`[main-web] Input for '${e}' changed to '${n}'.`),e){case"aircraftSpeedKt":const a=No(n);It("jumperSeparation",a),g.state.userSettings.jumperSeparation=a,g.save(),i.weatherData&&(jo(),rt(ae())),he();break;case"cutAwayAltitude":i.weatherData&&i.cutAwayLat!==null&&se();break;case"openingAltitude":case"exitAltitude":case"safetyHeight":case"numberOfJumpers":case"jumperSeparation":case"canopySpeed":case"descentRate":case"legHeightFinal":case"legHeightBase":case"legHeightDownwind":i.weatherData&&(se(),_e(),rt(ae()));break;case"jumpRunTrackDirection":case"jumpRunTrackOffset":case"jumpRunTrackForwardOffset":i.weatherData&&he();break;case"lowerLimit":case"upperLimit":case"interpStep":i.weatherData&&(await Be(ae(),"weather-table-container","selectedTime"),nt());break;case"customLandingDirectionLL":case"customLandingDirectionRR":i.weatherData&&(_e(),se());break;case"historicalDatePicker":if(i.lastLat&&i.lastLng){const r=n?`${n}T00:00:00Z`:null,o=await tt(i.lastLat,i.lastLng,r);o&&await Ft(o)}break}}),document.addEventListener("ui:findJumpShip",()=>{Lu()}),document.addEventListener("ui:showJumpMasterLineChanged",()=>{fe()}),document.addEventListener("ui:modelChanged",async t=>{var e,n;if(console.log(`[main-web] Model changed to ${t.detail.model}. Fetching new data.`),i.lastLat&&i.lastLng){const a=ae(),r=((n=(e=i.weatherData)==null?void 0:e.time)==null?void 0:n[a])||null,o=await tt(i.lastLat,i.lastLng,r);o&&await Ft(o,a)}else f.handleError("Please select a position on the map first.")}),document.addEventListener("ui:jumpFeatureChanged",()=>{console.log("[main-web] Jump feature changed, recalculating jump."),i.weatherData&&i.lastLat&&i.lastLng&&g.state.userSettings.calculateJump&&se()}),document.addEventListener("ui:showJumpRunTrackChanged",t=>{t.detail.checked?he():(Pt(null),Lr(!1))}),document.addEventListener("ui:showCutAwayFinderChanged",t=>{var a;const e=t.detail.checked;console.log(`[main-web] Cut Away Finder toggled: ${e}`);const n=(a=document.getElementById("showCutAwayFinder").closest("li"))==null?void 0:a.querySelector("ul.submenu");n&&n.classList.toggle("hidden",!e),e||(Gl(),i.cutAwayLat=null,i.cutAwayLng=null),i.weatherData&&i.lastLat&&i.lastLng&&g.state.userSettings.calculateJump&&se()}),document.addEventListener("ui:trackPositionToggled",t=>{const e=t.detail.checked;console.log(`[main-web] Live Tracking toggled: ${e}`),e?yu():sa()}),document.addEventListener("ui:landingPatternEnabled",()=>{console.log("[main-web] Landing pattern enabled, updating display."),_e()}),document.addEventListener("ui:landingPatternDisabled",()=>{console.log("[main-web] Landing pattern disabled, clearing display."),Ct(null)}),document.addEventListener("ui:showTableChanged",t=>{const e=t.detail.checked;console.log(`[main-web] Show Table toggled: ${e}`);const n=document.getElementById("info");n&&(n.style.display=e?"block":"none"),e&&i.weatherData&&i.lastLat&&i.lastLng&&Be(ae(),"weather-table-container","selectedTime"),cn()}),document.addEventListener("ui:showJumpMasterLineChanged",()=>{console.log("[main-web] Jump Master Line checkbox changed, forcing dashboard update."),fe()}),document.addEventListener("ui:jumpMasterLineTargetChanged",()=>{console.log("[main-web] Jump Master Line target changed, updating panel and line."),fe()}),document.addEventListener("ui:downloadClicked",()=>{console.log("[main-web] Download button clicked.");const t=bu();t==="SurfaceData"?Au():t==="ComprehensiveReport"?Cu():Tu(t)}),document.addEventListener("ui:clearDateClicked",async()=>{console.log("[main-web] Clear date button clicked.");const t=document.getElementById("historicalDatePicker");if(t&&(t.value="",i.lastLat&&i.lastLng))try{const e=await tt(i.lastLat,i.lastLng,null);e&&await Ft(e)}catch(e){ln(e.message)}}),document.addEventListener("ui:recalculateJump",()=>{console.log("[main-web] Recalculate jump triggered."),i.weatherData&&i.lastLat&&i.lastLng&&g.state.userSettings.calculateJump&&se()}),document.addEventListener("ui:invalidInput",t=>{const{id:e,defaultValue:n}=t.detail;console.log(`[main-web] Received invalid input for ${e}. Resetting UI to ${n}.`),ne(e,n)})}document.addEventListener("DOMContentLoaded",async()=>{Eu(),_u(),Mr(),Dl(),await $l(),Nu(),pu(),gu(),_a();const t=Ke().filter(e=>e.isFavorite);t.length>0&&(console.log(`[App] Found ${t.length} favorite(s) on startup, plotting on map.`),Ro(t)),document.addEventListener("cutaway:marker_placed",()=>{console.log("App: Event 'cutaway:marker_placed' empfangen. Neuberechnung wird ausgelöst."),i.weatherData&&i.lastLat&&i.lastLng&&se()}),document.addEventListener("track:dragend",e=>{console.log("App: Event 'track:dragend' empfangen. Neuberechnung der Offsets relativ zum Ankerpunkt (DIP oder HARP).");const{newPosition:n,originalTrackData:a}=e.detail;let r;const o=i.harpMarker?i.harpMarker.getLatLng():null;o?(r=o,console.log("JRT-Ankerpunkt ist HARP.")):(r=L.latLng(i.lastLat,i.lastLng),console.log("JRT-Ankerpunkt ist DIP."));const s=a.trackLength,l=a.airplane.bearing,c=n,[u,d]=f.calculateNewCenter(c.lat,c.lng,s,(l+180)%360),m=L.latLng(u,d),p=i.map.distance(r,m);let v=f.calculateBearing(r.lat,r.lng,m.lat,m.lng)-l;v=(v+180)%360-180;const S=v*(Math.PI/180),w=Math.round(p*Math.cos(S)),M=Math.round(p*Math.sin(S));g.state.userSettings.jumpRunTrackOffset=M,g.state.userSettings.jumpRunTrackForwardOffset=w,g.save(),It("jumpRunTrackOffset",M),It("jumpRunTrackForwardOffset",w),he()}),document.addEventListener("harp:updated",()=>{console.log("[App] HARP has been updated, resetting offsets and triggering JRT recalculation."),It("jumpRunTrackOffset",0),It("jumpRunTrackForwardOffset",0),he(),typeof fe=="function"&&fe()}),document.addEventListener("location:selected",async e=>{var s,l;const{lat:n,lng:a,source:r}=e.detail;console.log(`App: Event 'location:selected' empfangen. Quelle: ${r}`),jl(),i.terrainAnalysisCache=null;const o=document.getElementById("loading");o&&(o.style.display="block");try{const c=ae(),u=((l=(s=i.weatherData)==null?void 0:s.time)==null?void 0:l[c])||null,d=await tt(n,a,u);d?r==="geolocation"||r==="geolocation_fallback"?await Ft(d):await Ft(d,c):i.weatherData=null,await vn(n,a),await ze(),cn(!0),i.isManualPanning=!1,(r==="geolocation"||r==="geolocation_fallback")&&(console.log("Starte initiales Caching nach Geolocation..."),Ma({map:i.map,baseMaps:i.baseMaps,onProgress:Ot,onComplete:m=>{$e(),m&&Ze(m)},onCancel:()=>{$e(),Ze("Caching cancelled.")}})),g.state.userSettings.showJumpMasterLine&&fe(),(r==="marker_drag"||r==="dblclick"||r==="search")&&(console.log(`Starte Caching für neue Position via ${r}...`),xo({map:i.map,lastLat:n,lastLng:a,baseMaps:i.baseMaps,onProgress:Ot,onComplete:Ze,onCancel:()=>Ze("Caching cancelled."),radiusKm:5,silent:!0})),g.state.userSettings.selectedEnsembleModels.length>0&&(console.log("DIP moved, triggering ensemble recalculation..."),await La()&&rt(ae()))}catch(c){console.error('Fehler beim Verarbeiten von "location:selected":',c),ln(c.message)}finally{o&&(o.style.display="none")}}),document.addEventListener("autoupdate:tick",async e=>{if(!g.state.userSettings.autoupdate)return;const n=new Date,a=document.getElementById("timeSlider");if(!a)return;const r=n.getUTCHours(),o=parseInt(a.value,10);(r!==o||e.detail.isInitialTick)&&(console.log(`[App] Autoupdate triggered. Current Hour: ${r}, Slider Hour: ${o}`),await ku())}),document.addEventListener("ui:lockStateChanged",Mr)});function et(t,e){const n=document.getElementById(t);n&&(n.checked=e)}function Pe(t,e){const n=document.getElementById(t);n?n.value=e:console.warn(`Element ${t} not found`)}function ne(t,e){const n=document.getElementById(t);n&&(n.value=e)}function It(t,e){const n=document.getElementById(t);if(n){const a=n.value;n.value=e,console.log(`Set ${t} silently:`,{old:a,new:e})}}function Pu(t,e){const n=document.querySelector(`input[name="${t}"][value="${e}"]`);n?n.checked=!0:console.warn(`Radio ${t} with value ${e} not found`)}
