var Fi=Object.defineProperty;var $i=(t,e,n)=>e in t?Fi(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var Kn=(t,e,n)=>$i(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const i={isInitialized:!1,ismapInitialized:!1,isCachingCancelled:!1,hasTileErrorSwitched:!1,map:null,baseMaps:{},coordsControl:null,lastMouseLatLng:null,isManualPanning:!1,isInteractionLocked:!1,labelZoomListener:null,currentMarker:null,lastLat:null,lastLng:null,lastAltitude:null,weatherData:null,cloudThresholds:[],lastModelRun:null,landingWindDir:null,autoupdateInterval:null,jumpVisualizationLayerGroup:null,landingPatternLayerGroup:null,jumpRunTrackLayerGroup:null,lastTrackData:null,isPlacingHarp:!1,harpMarker:null,cutAwayMarker:null,cutAwayLat:null,cutAwayLng:null,cutAwayCircle:null,isJumperSeparationManual:!1,watchId:null,liveMarker:null,livePositionControl:null,accuracyCircle:null,jumpMasterLine:null,aircraftMarker:null,aircraftTrackLayer:null,adsbTrackPoints:[],isArmed:!1,isAutoRecording:!1,altitudeCorrectionPerformed:!1,isManualRecording:!1,recordedTrackPoints:[],recordedTrackLayer:null,autoRecordingStartTime:null,altitudeCorrectionOffset:0,prevTime:null,prevLat:null,prevLng:null,lastLatitude:null,lastLongitude:null,lastDeviceAltitude:null,lastAltitudeAccuracy:null,lastAccuracy:null,lastSpeed:"N/A",lastSmoothedSpeedMs:0,lastDirection:"N/A",lastTerrainAltitude:"N/A",lastEffectiveWindUnit:"kt",gpxLayer:null,gpxPoints:[],isLoadingGpx:!1,isTrackLoaded:!1,favoritesLayerGroup:null,poiLayerGroup:null,ensembleModelsData:null,selectedEnsembleModels:[],currentEnsembleScenario:"all_models",ensembleLayerGroup:null,ensembleScenarioCircles:{},heatmapLayer:null};class Tt extends Error{}class Oi extends Tt{constructor(e){super(`Invalid DateTime: ${e.toMessage()}`)}}class Ri extends Tt{constructor(e){super(`Invalid Interval: ${e.toMessage()}`)}}class Wi extends Tt{constructor(e){super(`Invalid Duration: ${e.toMessage()}`)}}class xt extends Tt{}class ao extends Tt{constructor(e){super(`Invalid unit ${e}`)}}class ye extends Tt{}class lt extends Tt{constructor(){super("Zone is an abstract class")}}const x="numeric",qe="short",Te="long",Dn={year:x,month:x,day:x},ro={year:x,month:qe,day:x},Ui={year:x,month:qe,day:x,weekday:qe},oo={year:x,month:Te,day:x},io={year:x,month:Te,day:x,weekday:Te},so={hour:x,minute:x},lo={hour:x,minute:x,second:x},co={hour:x,minute:x,second:x,timeZoneName:qe},uo={hour:x,minute:x,second:x,timeZoneName:Te},mo={hour:x,minute:x,hourCycle:"h23"},ho={hour:x,minute:x,second:x,hourCycle:"h23"},go={hour:x,minute:x,second:x,hourCycle:"h23",timeZoneName:qe},fo={hour:x,minute:x,second:x,hourCycle:"h23",timeZoneName:Te},po={year:x,month:x,day:x,hour:x,minute:x},yo={year:x,month:x,day:x,hour:x,minute:x,second:x},wo={year:x,month:qe,day:x,hour:x,minute:x},vo={year:x,month:qe,day:x,hour:x,minute:x,second:x},Hi={year:x,month:qe,day:x,weekday:qe,hour:x,minute:x},Lo={year:x,month:Te,day:x,hour:x,minute:x,timeZoneName:qe},bo={year:x,month:Te,day:x,hour:x,minute:x,second:x,timeZoneName:qe},Mo={year:x,month:Te,day:x,weekday:Te,hour:x,minute:x,timeZoneName:Te},So={year:x,month:Te,day:x,weekday:Te,hour:x,minute:x,second:x,timeZoneName:Te};class un{get type(){throw new lt}get name(){throw new lt}get ianaName(){return this.name}get isUniversal(){throw new lt}offsetName(e,n){throw new lt}formatOffset(e,n){throw new lt}offset(e){throw new lt}equals(e){throw new lt}get isValid(){throw new lt}}let Yn=null;class Un extends un{static get instance(){return Yn===null&&(Yn=new Un),Yn}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(e,{format:n,locale:a}){return xo(e,n,a)}formatOffset(e,n){return an(this.offset(e),n)}offset(e){return-new Date(e).getTimezoneOffset()}equals(e){return e.type==="system"}get isValid(){return!0}}const ya=new Map;function Bi(t){let e=ya.get(t);return e===void 0&&(e=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"}),ya.set(t,e)),e}const Gi={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};function zi(t,e){const n=t.format(e).replace(/\u200E/g,""),a=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(n),[,r,o,s,l,c,u,d]=a;return[s,r,o,l,c,u,d]}function Vi(t,e){const n=t.formatToParts(e),a=[];for(let r=0;r<n.length;r++){const{type:o,value:s}=n[r],l=Gi[o];o==="era"?a[l]=s:H(l)||(a[l]=parseInt(s,10))}return a}const Xn=new Map;class rt extends un{static create(e){let n=Xn.get(e);return n===void 0&&Xn.set(e,n=new rt(e)),n}static resetCache(){Xn.clear(),ya.clear()}static isValidSpecifier(e){return this.isValidZone(e)}static isValidZone(e){if(!e)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:e}).format(),!0}catch{return!1}}constructor(e){super(),this.zoneName=e,this.valid=rt.isValidZone(e)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(e,{format:n,locale:a}){return xo(e,n,a,this.name)}formatOffset(e,n){return an(this.offset(e),n)}offset(e){if(!this.valid)return NaN;const n=new Date(e);if(isNaN(n))return NaN;const a=Bi(this.name);let[r,o,s,l,c,u,d]=a.formatToParts?Vi(a,n):zi(a,n);l==="BC"&&(r=-Math.abs(r)+1);const p=Bn({year:r,month:o,day:s,hour:c===24?0:c,minute:u,second:d,millisecond:0});let h=+n;const v=h%1e3;return h-=v>=0?v:1e3+v,(p-h)/(60*1e3)}equals(e){return e.type==="iana"&&e.name===this.name}get isValid(){return this.valid}}let cr={};function Zi(t,e={}){const n=JSON.stringify([t,e]);let a=cr[n];return a||(a=new Intl.ListFormat(t,e),cr[n]=a),a}const wa=new Map;function va(t,e={}){const n=JSON.stringify([t,e]);let a=wa.get(n);return a===void 0&&(a=new Intl.DateTimeFormat(t,e),wa.set(n,a)),a}const La=new Map;function ji(t,e={}){const n=JSON.stringify([t,e]);let a=La.get(n);return a===void 0&&(a=new Intl.NumberFormat(t,e),La.set(n,a)),a}const ba=new Map;function Ji(t,e={}){const{base:n,...a}=e,r=JSON.stringify([t,a]);let o=ba.get(r);return o===void 0&&(o=new Intl.RelativeTimeFormat(t,e),ba.set(r,o)),o}let Yt=null;function qi(){return Yt||(Yt=new Intl.DateTimeFormat().resolvedOptions().locale,Yt)}const Ma=new Map;function Eo(t){let e=Ma.get(t);return e===void 0&&(e=new Intl.DateTimeFormat(t).resolvedOptions(),Ma.set(t,e)),e}const Sa=new Map;function Ki(t){let e=Sa.get(t);if(!e){const n=new Intl.Locale(t);e="getWeekInfo"in n?n.getWeekInfo():n.weekInfo,"minimalDays"in e||(e={...ko,...e}),Sa.set(t,e)}return e}function Yi(t){const e=t.indexOf("-x-");e!==-1&&(t=t.substring(0,e));const n=t.indexOf("-u-");if(n===-1)return[t];{let a,r;try{a=va(t).resolvedOptions(),r=t}catch{const c=t.substring(0,n);a=va(c).resolvedOptions(),r=c}const{numberingSystem:o,calendar:s}=a;return[r,o,s]}}function Xi(t,e,n){return(n||e)&&(t.includes("-u-")||(t+="-u"),n&&(t+=`-ca-${n}`),e&&(t+=`-nu-${e}`)),t}function Qi(t){const e=[];for(let n=1;n<=12;n++){const a=$.utc(2009,n,1);e.push(t(a))}return e}function es(t){const e=[];for(let n=1;n<=7;n++){const a=$.utc(2016,11,13+n);e.push(t(a))}return e}function yn(t,e,n,a){const r=t.listingMode();return r==="error"?null:r==="en"?n(e):a(e)}function ts(t){return t.numberingSystem&&t.numberingSystem!=="latn"?!1:t.numberingSystem==="latn"||!t.locale||t.locale.startsWith("en")||Eo(t.locale).numberingSystem==="latn"}class ns{constructor(e,n,a){this.padTo=a.padTo||0,this.floor=a.floor||!1;const{padTo:r,floor:o,...s}=a;if(!n||Object.keys(s).length>0){const l={useGrouping:!1,...a};a.padTo>0&&(l.minimumIntegerDigits=a.padTo),this.inf=ji(e,l)}}format(e){if(this.inf){const n=this.floor?Math.floor(e):e;return this.inf.format(n)}else{const n=this.floor?Math.floor(e):Wa(e,3);return le(n,this.padTo)}}}class as{constructor(e,n,a){this.opts=a,this.originalZone=void 0;let r;if(this.opts.timeZone)this.dt=e;else if(e.zone.type==="fixed"){const s=-1*(e.offset/60),l=s>=0?`Etc/GMT+${s}`:`Etc/GMT${s}`;e.offset!==0&&rt.create(l).valid?(r=l,this.dt=e):(r="UTC",this.dt=e.offset===0?e:e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone)}else e.zone.type==="system"?this.dt=e:e.zone.type==="iana"?(this.dt=e,r=e.zone.name):(r="UTC",this.dt=e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone);const o={...this.opts};o.timeZone=o.timeZone||r,this.dtf=va(n,o)}format(){return this.originalZone?this.formatToParts().map(({value:e})=>e).join(""):this.dtf.format(this.dt.toJSDate())}formatToParts(){const e=this.dtf.formatToParts(this.dt.toJSDate());return this.originalZone?e.map(n=>{if(n.type==="timeZoneName"){const a=this.originalZone.offsetName(this.dt.ts,{locale:this.dt.locale,format:this.opts.timeZoneName});return{...n,value:a}}else return n}):e}resolvedOptions(){return this.dtf.resolvedOptions()}}class rs{constructor(e,n,a){this.opts={style:"long",...a},!n&&Po()&&(this.rtf=Ji(e,a))}format(e,n){return this.rtf?this.rtf.format(e,n):_s(n,e,this.opts.numeric,this.opts.style!=="long")}formatToParts(e,n){return this.rtf?this.rtf.formatToParts(e,n):[]}}const ko={firstDay:1,minimalDays:4,weekend:[6,7]};class K{static fromOpts(e){return K.create(e.locale,e.numberingSystem,e.outputCalendar,e.weekSettings,e.defaultToEN)}static create(e,n,a,r,o=!1){const s=e||oe.defaultLocale,l=s||(o?"en-US":qi()),c=n||oe.defaultNumberingSystem,u=a||oe.defaultOutputCalendar,d=ka(r)||oe.defaultWeekSettings;return new K(l,c,u,d,s)}static resetCache(){Yt=null,wa.clear(),La.clear(),ba.clear(),Ma.clear(),Sa.clear()}static fromObject({locale:e,numberingSystem:n,outputCalendar:a,weekSettings:r}={}){return K.create(e,n,a,r)}constructor(e,n,a,r,o){const[s,l,c]=Yi(e);this.locale=s,this.numberingSystem=n||l||null,this.outputCalendar=a||c||null,this.weekSettings=r,this.intl=Xi(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=o,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=ts(this)),this.fastNumbersCached}listingMode(){const e=this.isEnglish(),n=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return e&&n?"en":"intl"}clone(e){return!e||Object.getOwnPropertyNames(e).length===0?this:K.create(e.locale||this.specifiedLocale,e.numberingSystem||this.numberingSystem,e.outputCalendar||this.outputCalendar,ka(e.weekSettings)||this.weekSettings,e.defaultToEN||!1)}redefaultToEN(e={}){return this.clone({...e,defaultToEN:!0})}redefaultToSystem(e={}){return this.clone({...e,defaultToEN:!1})}months(e,n=!1){return yn(this,e,Oo,()=>{const a=n?{month:e,day:"numeric"}:{month:e},r=n?"format":"standalone";return this.monthsCache[r][e]||(this.monthsCache[r][e]=Qi(o=>this.extract(o,a,"month"))),this.monthsCache[r][e]})}weekdays(e,n=!1){return yn(this,e,Uo,()=>{const a=n?{weekday:e,year:"numeric",month:"long",day:"numeric"}:{weekday:e},r=n?"format":"standalone";return this.weekdaysCache[r][e]||(this.weekdaysCache[r][e]=es(o=>this.extract(o,a,"weekday"))),this.weekdaysCache[r][e]})}meridiems(){return yn(this,void 0,()=>Ho,()=>{if(!this.meridiemCache){const e={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[$.utc(2016,11,13,9),$.utc(2016,11,13,19)].map(n=>this.extract(n,e,"dayperiod"))}return this.meridiemCache})}eras(e){return yn(this,e,Bo,()=>{const n={era:e};return this.eraCache[e]||(this.eraCache[e]=[$.utc(-40,1,1),$.utc(2017,1,1)].map(a=>this.extract(a,n,"era"))),this.eraCache[e]})}extract(e,n,a){const r=this.dtFormatter(e,n),o=r.formatToParts(),s=o.find(l=>l.type.toLowerCase()===a);return s?s.value:null}numberFormatter(e={}){return new ns(this.intl,e.forceSimple||this.fastNumbers,e)}dtFormatter(e,n={}){return new as(e,this.intl,n)}relFormatter(e={}){return new rs(this.intl,this.isEnglish(),e)}listFormatter(e={}){return Zi(this.intl,e)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||Eo(this.intl).locale.startsWith("en-us")}getWeekSettings(){return this.weekSettings?this.weekSettings:No()?Ki(this.locale):ko}getStartOfWeek(){return this.getWeekSettings().firstDay}getMinDaysInFirstWeek(){return this.getWeekSettings().minimalDays}getWeekendDays(){return this.getWeekSettings().weekend}equals(e){return this.locale===e.locale&&this.numberingSystem===e.numberingSystem&&this.outputCalendar===e.outputCalendar}toString(){return`Locale(${this.locale}, ${this.numberingSystem}, ${this.outputCalendar})`}}let Qn=null;class Me extends un{static get utcInstance(){return Qn===null&&(Qn=new Me(0)),Qn}static instance(e){return e===0?Me.utcInstance:new Me(e)}static parseSpecifier(e){if(e){const n=e.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(n)return new Me(Gn(n[1],n[2]))}return null}constructor(e){super(),this.fixed=e}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${an(this.fixed,"narrow")}`}get ianaName(){return this.fixed===0?"Etc/UTC":`Etc/GMT${an(-this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(e,n){return an(this.fixed,n)}get isUniversal(){return!0}offset(){return this.fixed}equals(e){return e.type==="fixed"&&e.fixed===this.fixed}get isValid(){return!0}}class os extends un{constructor(e){super(),this.zoneName=e}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function dt(t,e){if(H(t)||t===null)return e;if(t instanceof un)return t;if(ds(t)){const n=t.toLowerCase();return n==="default"?e:n==="local"||n==="system"?Un.instance:n==="utc"||n==="gmt"?Me.utcInstance:Me.parseSpecifier(n)||rt.create(t)}else return pt(t)?Me.instance(t):typeof t=="object"&&"offset"in t&&typeof t.offset=="function"?t:new os(t)}const Fa={arab:"[٠-٩]",arabext:"[۰-۹]",bali:"[᭐-᭙]",beng:"[০-৯]",deva:"[०-९]",fullwide:"[０-９]",gujr:"[૦-૯]",hanidec:"[〇|一|二|三|四|五|六|七|八|九]",khmr:"[០-៩]",knda:"[೦-೯]",laoo:"[໐-໙]",limb:"[᥆-᥏]",mlym:"[൦-൯]",mong:"[᠐-᠙]",mymr:"[၀-၉]",orya:"[୦-୯]",tamldec:"[௦-௯]",telu:"[౦-౯]",thai:"[๐-๙]",tibt:"[༠-༩]",latn:"\\d"},ur={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},is=Fa.hanidec.replace(/[\[|\]]/g,"").split("");function ss(t){let e=parseInt(t,10);if(isNaN(e)){e="";for(let n=0;n<t.length;n++){const a=t.charCodeAt(n);if(t[n].search(Fa.hanidec)!==-1)e+=is.indexOf(t[n]);else for(const r in ur){const[o,s]=ur[r];a>=o&&a<=s&&(e+=a-o)}}return parseInt(e,10)}else return e}const Ea=new Map;function ls(){Ea.clear()}function Ge({numberingSystem:t},e=""){const n=t||"latn";let a=Ea.get(n);a===void 0&&(a=new Map,Ea.set(n,a));let r=a.get(e);return r===void 0&&(r=new RegExp(`${Fa[n]}${e}`),a.set(e,r)),r}let dr=()=>Date.now(),mr="system",hr=null,gr=null,fr=null,pr=60,yr,wr=null,oe=class{static get now(){return dr}static set now(e){dr=e}static set defaultZone(e){mr=e}static get defaultZone(){return dt(mr,Un.instance)}static get defaultLocale(){return hr}static set defaultLocale(e){hr=e}static get defaultNumberingSystem(){return gr}static set defaultNumberingSystem(e){gr=e}static get defaultOutputCalendar(){return fr}static set defaultOutputCalendar(e){fr=e}static get defaultWeekSettings(){return wr}static set defaultWeekSettings(e){wr=ka(e)}static get twoDigitCutoffYear(){return pr}static set twoDigitCutoffYear(e){pr=e%100}static get throwOnInvalid(){return yr}static set throwOnInvalid(e){yr=e}static resetCaches(){K.resetCache(),rt.resetCache(),$.resetCache(),ls()}};class Je{constructor(e,n){this.reason=e,this.explanation=n}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}const _o=[0,31,59,90,120,151,181,212,243,273,304,334],To=[0,31,60,91,121,152,182,213,244,274,305,335];function Oe(t,e){return new Je("unit out of range",`you specified ${e} (of type ${typeof e}) as a ${t}, which is invalid`)}function $a(t,e,n){const a=new Date(Date.UTC(t,e-1,n));t<100&&t>=0&&a.setUTCFullYear(a.getUTCFullYear()-1900);const r=a.getUTCDay();return r===0?7:r}function Ao(t,e,n){return n+(dn(t)?To:_o)[e-1]}function Co(t,e){const n=dn(t)?To:_o,a=n.findIndex(o=>o<e),r=e-n[a];return{month:a+1,day:r}}function Oa(t,e){return(t-e+7)%7+1}function Pn(t,e=4,n=1){const{year:a,month:r,day:o}=t,s=Ao(a,r,o),l=Oa($a(a,r,o),n);let c=Math.floor((s-l+14-e)/7),u;return c<1?(u=a-1,c=sn(u,e,n)):c>sn(a,e,n)?(u=a+1,c=1):u=a,{weekYear:u,weekNumber:c,weekday:l,...zn(t)}}function vr(t,e=4,n=1){const{weekYear:a,weekNumber:r,weekday:o}=t,s=Oa($a(a,1,e),n),l=Ot(a);let c=r*7+o-s-7+e,u;c<1?(u=a-1,c+=Ot(u)):c>l?(u=a+1,c-=Ot(a)):u=a;const{month:d,day:m}=Co(u,c);return{year:u,month:d,day:m,...zn(t)}}function ea(t){const{year:e,month:n,day:a}=t,r=Ao(e,n,a);return{year:e,ordinal:r,...zn(t)}}function Lr(t){const{year:e,ordinal:n}=t,{month:a,day:r}=Co(e,n);return{year:e,month:a,day:r,...zn(t)}}function br(t,e){if(!H(t.localWeekday)||!H(t.localWeekNumber)||!H(t.localWeekYear)){if(!H(t.weekday)||!H(t.weekNumber)||!H(t.weekYear))throw new xt("Cannot mix locale-based week fields with ISO-based week fields");return H(t.localWeekday)||(t.weekday=t.localWeekday),H(t.localWeekNumber)||(t.weekNumber=t.localWeekNumber),H(t.localWeekYear)||(t.weekYear=t.localWeekYear),delete t.localWeekday,delete t.localWeekNumber,delete t.localWeekYear,{minDaysInFirstWeek:e.getMinDaysInFirstWeek(),startOfWeek:e.getStartOfWeek()}}else return{minDaysInFirstWeek:4,startOfWeek:1}}function cs(t,e=4,n=1){const a=Hn(t.weekYear),r=Re(t.weekNumber,1,sn(t.weekYear,e,n)),o=Re(t.weekday,1,7);return a?r?o?!1:Oe("weekday",t.weekday):Oe("week",t.weekNumber):Oe("weekYear",t.weekYear)}function us(t){const e=Hn(t.year),n=Re(t.ordinal,1,Ot(t.year));return e?n?!1:Oe("ordinal",t.ordinal):Oe("year",t.year)}function Io(t){const e=Hn(t.year),n=Re(t.month,1,12),a=Re(t.day,1,Nn(t.year,t.month));return e?n?a?!1:Oe("day",t.day):Oe("month",t.month):Oe("year",t.year)}function Do(t){const{hour:e,minute:n,second:a,millisecond:r}=t,o=Re(e,0,23)||e===24&&n===0&&a===0&&r===0,s=Re(n,0,59),l=Re(a,0,59),c=Re(r,0,999);return o?s?l?c?!1:Oe("millisecond",r):Oe("second",a):Oe("minute",n):Oe("hour",e)}function H(t){return typeof t>"u"}function pt(t){return typeof t=="number"}function Hn(t){return typeof t=="number"&&t%1===0}function ds(t){return typeof t=="string"}function ms(t){return Object.prototype.toString.call(t)==="[object Date]"}function Po(){try{return typeof Intl<"u"&&!!Intl.RelativeTimeFormat}catch{return!1}}function No(){try{return typeof Intl<"u"&&!!Intl.Locale&&("weekInfo"in Intl.Locale.prototype||"getWeekInfo"in Intl.Locale.prototype)}catch{return!1}}function hs(t){return Array.isArray(t)?t:[t]}function Mr(t,e,n){if(t.length!==0)return t.reduce((a,r)=>{const o=[e(r),r];return a&&n(a[0],o[0])===a[0]?a:o},null)[1]}function gs(t,e){return e.reduce((n,a)=>(n[a]=t[a],n),{})}function Wt(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function ka(t){if(t==null)return null;if(typeof t!="object")throw new ye("Week settings must be an object");if(!Re(t.firstDay,1,7)||!Re(t.minimalDays,1,7)||!Array.isArray(t.weekend)||t.weekend.some(e=>!Re(e,1,7)))throw new ye("Invalid week settings");return{firstDay:t.firstDay,minimalDays:t.minimalDays,weekend:Array.from(t.weekend)}}function Re(t,e,n){return Hn(t)&&t>=e&&t<=n}function fs(t,e){return t-e*Math.floor(t/e)}function le(t,e=2){const n=t<0;let a;return n?a="-"+(""+-t).padStart(e,"0"):a=(""+t).padStart(e,"0"),a}function ut(t){if(!(H(t)||t===null||t===""))return parseInt(t,10)}function wt(t){if(!(H(t)||t===null||t===""))return parseFloat(t)}function Ra(t){if(!(H(t)||t===null||t==="")){const e=parseFloat("0."+t)*1e3;return Math.floor(e)}}function Wa(t,e,n=!1){const a=10**e;return(n?Math.trunc:Math.round)(t*a)/a}function dn(t){return t%4===0&&(t%100!==0||t%400===0)}function Ot(t){return dn(t)?366:365}function Nn(t,e){const n=fs(e-1,12)+1,a=t+(e-n)/12;return n===2?dn(a)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][n-1]}function Bn(t){let e=Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,t.second,t.millisecond);return t.year<100&&t.year>=0&&(e=new Date(e),e.setUTCFullYear(t.year,t.month-1,t.day)),+e}function Sr(t,e,n){return-Oa($a(t,1,e),n)+e-1}function sn(t,e=4,n=1){const a=Sr(t,e,n),r=Sr(t+1,e,n);return(Ot(t)-a+r)/7}function _a(t){return t>99?t:t>oe.twoDigitCutoffYear?1900+t:2e3+t}function xo(t,e,n,a=null){const r=new Date(t),o={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};a&&(o.timeZone=a);const s={timeZoneName:e,...o},l=new Intl.DateTimeFormat(n,s).formatToParts(r).find(c=>c.type.toLowerCase()==="timezonename");return l?l.value:null}function Gn(t,e){let n=parseInt(t,10);Number.isNaN(n)&&(n=0);const a=parseInt(e,10)||0,r=n<0||Object.is(n,-0)?-a:a;return n*60+r}function Fo(t){const e=Number(t);if(typeof t=="boolean"||t===""||Number.isNaN(e))throw new ye(`Invalid unit value ${t}`);return e}function xn(t,e){const n={};for(const a in t)if(Wt(t,a)){const r=t[a];if(r==null)continue;n[e(a)]=Fo(r)}return n}function an(t,e){const n=Math.trunc(Math.abs(t/60)),a=Math.trunc(Math.abs(t%60)),r=t>=0?"+":"-";switch(e){case"short":return`${r}${le(n,2)}:${le(a,2)}`;case"narrow":return`${r}${n}${a>0?`:${a}`:""}`;case"techie":return`${r}${le(n,2)}${le(a,2)}`;default:throw new RangeError(`Value format ${e} is out of range for property format`)}}function zn(t){return gs(t,["hour","minute","second","millisecond"])}const ps=["January","February","March","April","May","June","July","August","September","October","November","December"],$o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],ys=["J","F","M","A","M","J","J","A","S","O","N","D"];function Oo(t){switch(t){case"narrow":return[...ys];case"short":return[...$o];case"long":return[...ps];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const Ro=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],Wo=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],ws=["M","T","W","T","F","S","S"];function Uo(t){switch(t){case"narrow":return[...ws];case"short":return[...Wo];case"long":return[...Ro];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const Ho=["AM","PM"],vs=["Before Christ","Anno Domini"],Ls=["BC","AD"],bs=["B","A"];function Bo(t){switch(t){case"narrow":return[...bs];case"short":return[...Ls];case"long":return[...vs];default:return null}}function Ms(t){return Ho[t.hour<12?0:1]}function Ss(t,e){return Uo(e)[t.weekday-1]}function Es(t,e){return Oo(e)[t.month-1]}function ks(t,e){return Bo(e)[t.year<0?0:1]}function _s(t,e,n="always",a=!1){const r={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},o=["hours","minutes","seconds"].indexOf(t)===-1;if(n==="auto"&&o){const m=t==="days";switch(e){case 1:return m?"tomorrow":`next ${r[t][0]}`;case-1:return m?"yesterday":`last ${r[t][0]}`;case 0:return m?"today":`this ${r[t][0]}`}}const s=Object.is(e,-0)||e<0,l=Math.abs(e),c=l===1,u=r[t],d=a?c?u[1]:u[2]||u[1]:c?r[t][0]:t;return s?`${l} ${d} ago`:`in ${l} ${d}`}function Er(t,e){let n="";for(const a of t)a.literal?n+=a.val:n+=e(a.val);return n}const Ts={D:Dn,DD:ro,DDD:oo,DDDD:io,t:so,tt:lo,ttt:co,tttt:uo,T:mo,TT:ho,TTT:go,TTTT:fo,f:po,ff:wo,fff:Lo,ffff:Mo,F:yo,FF:vo,FFF:bo,FFFF:So};class we{static create(e,n={}){return new we(e,n)}static parseFormat(e){let n=null,a="",r=!1;const o=[];for(let s=0;s<e.length;s++){const l=e.charAt(s);l==="'"?(a.length>0&&o.push({literal:r||/^\s+$/.test(a),val:a}),n=null,a="",r=!r):r||l===n?a+=l:(a.length>0&&o.push({literal:/^\s+$/.test(a),val:a}),a=l,n=l)}return a.length>0&&o.push({literal:r||/^\s+$/.test(a),val:a}),o}static macroTokenToFormatOpts(e){return Ts[e]}constructor(e,n){this.opts=n,this.loc=e,this.systemLoc=null}formatWithSystemDefault(e,n){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(e,{...this.opts,...n}).format()}dtFormatter(e,n={}){return this.loc.dtFormatter(e,{...this.opts,...n})}formatDateTime(e,n){return this.dtFormatter(e,n).format()}formatDateTimeParts(e,n){return this.dtFormatter(e,n).formatToParts()}formatInterval(e,n){return this.dtFormatter(e.start,n).dtf.formatRange(e.start.toJSDate(),e.end.toJSDate())}resolvedOptions(e,n){return this.dtFormatter(e,n).resolvedOptions()}num(e,n=0){if(this.opts.forceSimple)return le(e,n);const a={...this.opts};return n>0&&(a.padTo=n),this.loc.numberFormatter(a).format(e)}formatDateTimeFromString(e,n){const a=this.loc.listingMode()==="en",r=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",o=(h,v)=>this.loc.extract(e,h,v),s=h=>e.isOffsetFixed&&e.offset===0&&h.allowZ?"Z":e.isValid?e.zone.formatOffset(e.ts,h.format):"",l=()=>a?Ms(e):o({hour:"numeric",hourCycle:"h12"},"dayperiod"),c=(h,v)=>a?Es(e,h):o(v?{month:h}:{month:h,day:"numeric"},"month"),u=(h,v)=>a?Ss(e,h):o(v?{weekday:h}:{weekday:h,month:"long",day:"numeric"},"weekday"),d=h=>{const v=we.macroTokenToFormatOpts(h);return v?this.formatWithSystemDefault(e,v):h},m=h=>a?ks(e,h):o({era:h},"era"),p=h=>{switch(h){case"S":return this.num(e.millisecond);case"u":case"SSS":return this.num(e.millisecond,3);case"s":return this.num(e.second);case"ss":return this.num(e.second,2);case"uu":return this.num(Math.floor(e.millisecond/10),2);case"uuu":return this.num(Math.floor(e.millisecond/100));case"m":return this.num(e.minute);case"mm":return this.num(e.minute,2);case"h":return this.num(e.hour%12===0?12:e.hour%12);case"hh":return this.num(e.hour%12===0?12:e.hour%12,2);case"H":return this.num(e.hour);case"HH":return this.num(e.hour,2);case"Z":return s({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return s({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return s({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return e.zone.offsetName(e.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return e.zone.offsetName(e.ts,{format:"long",locale:this.loc.locale});case"z":return e.zoneName;case"a":return l();case"d":return r?o({day:"numeric"},"day"):this.num(e.day);case"dd":return r?o({day:"2-digit"},"day"):this.num(e.day,2);case"c":return this.num(e.weekday);case"ccc":return u("short",!0);case"cccc":return u("long",!0);case"ccccc":return u("narrow",!0);case"E":return this.num(e.weekday);case"EEE":return u("short",!1);case"EEEE":return u("long",!1);case"EEEEE":return u("narrow",!1);case"L":return r?o({month:"numeric",day:"numeric"},"month"):this.num(e.month);case"LL":return r?o({month:"2-digit",day:"numeric"},"month"):this.num(e.month,2);case"LLL":return c("short",!0);case"LLLL":return c("long",!0);case"LLLLL":return c("narrow",!0);case"M":return r?o({month:"numeric"},"month"):this.num(e.month);case"MM":return r?o({month:"2-digit"},"month"):this.num(e.month,2);case"MMM":return c("short",!1);case"MMMM":return c("long",!1);case"MMMMM":return c("narrow",!1);case"y":return r?o({year:"numeric"},"year"):this.num(e.year);case"yy":return r?o({year:"2-digit"},"year"):this.num(e.year.toString().slice(-2),2);case"yyyy":return r?o({year:"numeric"},"year"):this.num(e.year,4);case"yyyyyy":return r?o({year:"numeric"},"year"):this.num(e.year,6);case"G":return m("short");case"GG":return m("long");case"GGGGG":return m("narrow");case"kk":return this.num(e.weekYear.toString().slice(-2),2);case"kkkk":return this.num(e.weekYear,4);case"W":return this.num(e.weekNumber);case"WW":return this.num(e.weekNumber,2);case"n":return this.num(e.localWeekNumber);case"nn":return this.num(e.localWeekNumber,2);case"ii":return this.num(e.localWeekYear.toString().slice(-2),2);case"iiii":return this.num(e.localWeekYear,4);case"o":return this.num(e.ordinal);case"ooo":return this.num(e.ordinal,3);case"q":return this.num(e.quarter);case"qq":return this.num(e.quarter,2);case"X":return this.num(Math.floor(e.ts/1e3));case"x":return this.num(e.ts);default:return d(h)}};return Er(we.parseFormat(n),p)}formatDurationFromString(e,n){const a=c=>{switch(c[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"w":return"week";case"M":return"month";case"y":return"year";default:return null}},r=c=>u=>{const d=a(u);return d?this.num(c.get(d),u.length):u},o=we.parseFormat(n),s=o.reduce((c,{literal:u,val:d})=>u?c:c.concat(d),[]),l=e.shiftTo(...s.map(a).filter(c=>c));return Er(o,r(l))}}const Go=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function Gt(...t){const e=t.reduce((n,a)=>n+a.source,"");return RegExp(`^${e}$`)}function zt(...t){return e=>t.reduce(([n,a,r],o)=>{const[s,l,c]=o(e,r);return[{...n,...s},l||a,c]},[{},null,1]).slice(0,2)}function Vt(t,...e){if(t==null)return[null,null];for(const[n,a]of e){const r=n.exec(t);if(r)return a(r)}return[null,null]}function zo(...t){return(e,n)=>{const a={};let r;for(r=0;r<t.length;r++)a[t[r]]=ut(e[n+r]);return[a,null,n+r]}}const Vo=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,As=`(?:${Vo.source}?(?:\\[(${Go.source})\\])?)?`,Ua=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,Zo=RegExp(`${Ua.source}${As}`),Ha=RegExp(`(?:T${Zo.source})?`),Cs=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,Is=/(\d{4})-?W(\d\d)(?:-?(\d))?/,Ds=/(\d{4})-?(\d{3})/,Ps=zo("weekYear","weekNumber","weekDay"),Ns=zo("year","ordinal"),xs=/(\d{4})-(\d\d)-(\d\d)/,jo=RegExp(`${Ua.source} ?(?:${Vo.source}|(${Go.source}))?`),Fs=RegExp(`(?: ${jo.source})?`);function Rt(t,e,n){const a=t[e];return H(a)?n:ut(a)}function $s(t,e){return[{year:Rt(t,e),month:Rt(t,e+1,1),day:Rt(t,e+2,1)},null,e+3]}function Zt(t,e){return[{hours:Rt(t,e,0),minutes:Rt(t,e+1,0),seconds:Rt(t,e+2,0),milliseconds:Ra(t[e+3])},null,e+4]}function mn(t,e){const n=!t[e]&&!t[e+1],a=Gn(t[e+1],t[e+2]),r=n?null:Me.instance(a);return[{},r,e+3]}function hn(t,e){const n=t[e]?rt.create(t[e]):null;return[{},n,e+1]}const Os=RegExp(`^T?${Ua.source}$`),Rs=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function Ws(t){const[e,n,a,r,o,s,l,c,u]=t,d=e[0]==="-",m=c&&c[0]==="-",p=(h,v=!1)=>h!==void 0&&(v||h&&d)?-h:h;return[{years:p(wt(n)),months:p(wt(a)),weeks:p(wt(r)),days:p(wt(o)),hours:p(wt(s)),minutes:p(wt(l)),seconds:p(wt(c),c==="-0"),milliseconds:p(Ra(u),m)}]}const Us={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function Ba(t,e,n,a,r,o,s){const l={year:e.length===2?_a(ut(e)):ut(e),month:$o.indexOf(n)+1,day:ut(a),hour:ut(r),minute:ut(o)};return s&&(l.second=ut(s)),t&&(l.weekday=t.length>3?Ro.indexOf(t)+1:Wo.indexOf(t)+1),l}const Hs=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function Bs(t){const[,e,n,a,r,o,s,l,c,u,d,m]=t,p=Ba(e,r,a,n,o,s,l);let h;return c?h=Us[c]:u?h=0:h=Gn(d,m),[p,new Me(h)]}function Gs(t){return t.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const zs=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,Vs=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,Zs=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function kr(t){const[,e,n,a,r,o,s,l]=t;return[Ba(e,r,a,n,o,s,l),Me.utcInstance]}function js(t){const[,e,n,a,r,o,s,l]=t;return[Ba(e,l,n,a,r,o,s),Me.utcInstance]}const Js=Gt(Cs,Ha),qs=Gt(Is,Ha),Ks=Gt(Ds,Ha),Ys=Gt(Zo),Jo=zt($s,Zt,mn,hn),Xs=zt(Ps,Zt,mn,hn),Qs=zt(Ns,Zt,mn,hn),el=zt(Zt,mn,hn);function tl(t){return Vt(t,[Js,Jo],[qs,Xs],[Ks,Qs],[Ys,el])}function nl(t){return Vt(Gs(t),[Hs,Bs])}function al(t){return Vt(t,[zs,kr],[Vs,kr],[Zs,js])}function rl(t){return Vt(t,[Rs,Ws])}const ol=zt(Zt);function il(t){return Vt(t,[Os,ol])}const sl=Gt(xs,Fs),ll=Gt(jo),cl=zt(Zt,mn,hn);function ul(t){return Vt(t,[sl,Jo],[ll,cl])}const _r="Invalid Duration",qo={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1e3},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1e3},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},dl={years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1e3},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1e3},...qo},Pe=146097/400,At=146097/4800,ml={years:{quarters:4,months:12,weeks:Pe/7,days:Pe,hours:Pe*24,minutes:Pe*24*60,seconds:Pe*24*60*60,milliseconds:Pe*24*60*60*1e3},quarters:{months:3,weeks:Pe/28,days:Pe/4,hours:Pe*24/4,minutes:Pe*24*60/4,seconds:Pe*24*60*60/4,milliseconds:Pe*24*60*60*1e3/4},months:{weeks:At/7,days:At,hours:At*24,minutes:At*24*60,seconds:At*24*60*60,milliseconds:At*24*60*60*1e3},...qo},Mt=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],hl=Mt.slice(0).reverse();function ct(t,e,n=!1){const a={values:n?e.values:{...t.values,...e.values||{}},loc:t.loc.clone(e.loc),conversionAccuracy:e.conversionAccuracy||t.conversionAccuracy,matrix:e.matrix||t.matrix};return new Z(a)}function Ko(t,e){let n=e.milliseconds??0;for(const a of hl.slice(1))e[a]&&(n+=e[a]*t[a].milliseconds);return n}function Tr(t,e){const n=Ko(t,e)<0?-1:1;Mt.reduceRight((a,r)=>{if(H(e[r]))return a;if(a){const o=e[a]*n,s=t[r][a],l=Math.floor(o/s);e[r]+=l*n,e[a]-=l*s*n}return r},null),Mt.reduce((a,r)=>{if(H(e[r]))return a;if(a){const o=e[a]%1;e[a]-=o,e[r]+=o*t[a][r]}return r},null)}function gl(t){const e={};for(const[n,a]of Object.entries(t))a!==0&&(e[n]=a);return e}class Z{constructor(e){const n=e.conversionAccuracy==="longterm"||!1;let a=n?ml:dl;e.matrix&&(a=e.matrix),this.values=e.values,this.loc=e.loc||K.create(),this.conversionAccuracy=n?"longterm":"casual",this.invalid=e.invalid||null,this.matrix=a,this.isLuxonDuration=!0}static fromMillis(e,n){return Z.fromObject({milliseconds:e},n)}static fromObject(e,n={}){if(e==null||typeof e!="object")throw new ye(`Duration.fromObject: argument expected to be an object, got ${e===null?"null":typeof e}`);return new Z({values:xn(e,Z.normalizeUnit),loc:K.fromObject(n),conversionAccuracy:n.conversionAccuracy,matrix:n.matrix})}static fromDurationLike(e){if(pt(e))return Z.fromMillis(e);if(Z.isDuration(e))return e;if(typeof e=="object")return Z.fromObject(e);throw new ye(`Unknown duration argument ${e} of type ${typeof e}`)}static fromISO(e,n){const[a]=rl(e);return a?Z.fromObject(a,n):Z.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static fromISOTime(e,n){const[a]=il(e);return a?Z.fromObject(a,n):Z.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static invalid(e,n=null){if(!e)throw new ye("need to specify a reason the Duration is invalid");const a=e instanceof Je?e:new Je(e,n);if(oe.throwOnInvalid)throw new Wi(a);return new Z({invalid:a})}static normalizeUnit(e){const n={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[e&&e.toLowerCase()];if(!n)throw new ao(e);return n}static isDuration(e){return e&&e.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(e,n={}){const a={...n,floor:n.round!==!1&&n.floor!==!1};return this.isValid?we.create(this.loc,a).formatDurationFromString(this,e):_r}toHuman(e={}){if(!this.isValid)return _r;const n=Mt.map(a=>{const r=this.values[a];return H(r)?null:this.loc.numberFormatter({style:"unit",unitDisplay:"long",...e,unit:a.slice(0,-1)}).format(r)}).filter(a=>a);return this.loc.listFormatter({type:"conjunction",style:e.listStyle||"narrow",...e}).format(n)}toObject(){return this.isValid?{...this.values}:{}}toISO(){if(!this.isValid)return null;let e="P";return this.years!==0&&(e+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(e+=this.months+this.quarters*3+"M"),this.weeks!==0&&(e+=this.weeks+"W"),this.days!==0&&(e+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(e+="T"),this.hours!==0&&(e+=this.hours+"H"),this.minutes!==0&&(e+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(e+=Wa(this.seconds+this.milliseconds/1e3,3)+"S"),e==="P"&&(e+="T0S"),e}toISOTime(e={}){if(!this.isValid)return null;const n=this.toMillis();return n<0||n>=864e5?null:(e={suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended",...e,includeOffset:!1},$.fromMillis(n,{zone:"UTC"}).toISOTime(e))}toJSON(){return this.toISO()}toString(){return this.toISO()}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Duration { values: ${JSON.stringify(this.values)} }`:`Duration { Invalid, reason: ${this.invalidReason} }`}toMillis(){return this.isValid?Ko(this.matrix,this.values):NaN}valueOf(){return this.toMillis()}plus(e){if(!this.isValid)return this;const n=Z.fromDurationLike(e),a={};for(const r of Mt)(Wt(n.values,r)||Wt(this.values,r))&&(a[r]=n.get(r)+this.get(r));return ct(this,{values:a},!0)}minus(e){if(!this.isValid)return this;const n=Z.fromDurationLike(e);return this.plus(n.negate())}mapUnits(e){if(!this.isValid)return this;const n={};for(const a of Object.keys(this.values))n[a]=Fo(e(this.values[a],a));return ct(this,{values:n},!0)}get(e){return this[Z.normalizeUnit(e)]}set(e){if(!this.isValid)return this;const n={...this.values,...xn(e,Z.normalizeUnit)};return ct(this,{values:n})}reconfigure({locale:e,numberingSystem:n,conversionAccuracy:a,matrix:r}={}){const s={loc:this.loc.clone({locale:e,numberingSystem:n}),matrix:r,conversionAccuracy:a};return ct(this,s)}as(e){return this.isValid?this.shiftTo(e).get(e):NaN}normalize(){if(!this.isValid)return this;const e=this.toObject();return Tr(this.matrix,e),ct(this,{values:e},!0)}rescale(){if(!this.isValid)return this;const e=gl(this.normalize().shiftToAll().toObject());return ct(this,{values:e},!0)}shiftTo(...e){if(!this.isValid)return this;if(e.length===0)return this;e=e.map(s=>Z.normalizeUnit(s));const n={},a={},r=this.toObject();let o;for(const s of Mt)if(e.indexOf(s)>=0){o=s;let l=0;for(const u in a)l+=this.matrix[u][s]*a[u],a[u]=0;pt(r[s])&&(l+=r[s]);const c=Math.trunc(l);n[s]=c,a[s]=(l*1e3-c*1e3)/1e3}else pt(r[s])&&(a[s]=r[s]);for(const s in a)a[s]!==0&&(n[o]+=s===o?a[s]:a[s]/this.matrix[o][s]);return Tr(this.matrix,n),ct(this,{values:n},!0)}shiftToAll(){return this.isValid?this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds"):this}negate(){if(!this.isValid)return this;const e={};for(const n of Object.keys(this.values))e[n]=this.values[n]===0?0:-this.values[n];return ct(this,{values:e},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(e){if(!this.isValid||!e.isValid||!this.loc.equals(e.loc))return!1;function n(a,r){return a===void 0||a===0?r===void 0||r===0:a===r}for(const a of Mt)if(!n(this.values[a],e.values[a]))return!1;return!0}}const Ct="Invalid Interval";function fl(t,e){return!t||!t.isValid?re.invalid("missing or invalid start"):!e||!e.isValid?re.invalid("missing or invalid end"):e<t?re.invalid("end before start",`The end of an interval must be after its start, but you had start=${t.toISO()} and end=${e.toISO()}`):null}class re{constructor(e){this.s=e.start,this.e=e.end,this.invalid=e.invalid||null,this.isLuxonInterval=!0}static invalid(e,n=null){if(!e)throw new ye("need to specify a reason the Interval is invalid");const a=e instanceof Je?e:new Je(e,n);if(oe.throwOnInvalid)throw new Ri(a);return new re({invalid:a})}static fromDateTimes(e,n){const a=Kt(e),r=Kt(n),o=fl(a,r);return o??new re({start:a,end:r})}static after(e,n){const a=Z.fromDurationLike(n),r=Kt(e);return re.fromDateTimes(r,r.plus(a))}static before(e,n){const a=Z.fromDurationLike(n),r=Kt(e);return re.fromDateTimes(r.minus(a),r)}static fromISO(e,n){const[a,r]=(e||"").split("/",2);if(a&&r){let o,s;try{o=$.fromISO(a,n),s=o.isValid}catch{s=!1}let l,c;try{l=$.fromISO(r,n),c=l.isValid}catch{c=!1}if(s&&c)return re.fromDateTimes(o,l);if(s){const u=Z.fromISO(r,n);if(u.isValid)return re.after(o,u)}else if(c){const u=Z.fromISO(a,n);if(u.isValid)return re.before(l,u)}}return re.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static isInterval(e){return e&&e.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get lastDateTime(){return this.isValid&&this.e?this.e.minus(1):null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(e="milliseconds"){return this.isValid?this.toDuration(e).get(e):NaN}count(e="milliseconds",n){if(!this.isValid)return NaN;const a=this.start.startOf(e,n);let r;return n!=null&&n.useLocaleWeeks?r=this.end.reconfigure({locale:a.locale}):r=this.end,r=r.startOf(e,n),Math.floor(r.diff(a,e).get(e))+(r.valueOf()!==this.end.valueOf())}hasSame(e){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,e):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(e){return this.isValid?this.s>e:!1}isBefore(e){return this.isValid?this.e<=e:!1}contains(e){return this.isValid?this.s<=e&&this.e>e:!1}set({start:e,end:n}={}){return this.isValid?re.fromDateTimes(e||this.s,n||this.e):this}splitAt(...e){if(!this.isValid)return[];const n=e.map(Kt).filter(s=>this.contains(s)).sort((s,l)=>s.toMillis()-l.toMillis()),a=[];let{s:r}=this,o=0;for(;r<this.e;){const s=n[o]||this.e,l=+s>+this.e?this.e:s;a.push(re.fromDateTimes(r,l)),r=l,o+=1}return a}splitBy(e){const n=Z.fromDurationLike(e);if(!this.isValid||!n.isValid||n.as("milliseconds")===0)return[];let{s:a}=this,r=1,o;const s=[];for(;a<this.e;){const l=this.start.plus(n.mapUnits(c=>c*r));o=+l>+this.e?this.e:l,s.push(re.fromDateTimes(a,o)),a=o,r+=1}return s}divideEqually(e){return this.isValid?this.splitBy(this.length()/e).slice(0,e):[]}overlaps(e){return this.e>e.s&&this.s<e.e}abutsStart(e){return this.isValid?+this.e==+e.s:!1}abutsEnd(e){return this.isValid?+e.e==+this.s:!1}engulfs(e){return this.isValid?this.s<=e.s&&this.e>=e.e:!1}equals(e){return!this.isValid||!e.isValid?!1:this.s.equals(e.s)&&this.e.equals(e.e)}intersection(e){if(!this.isValid)return this;const n=this.s>e.s?this.s:e.s,a=this.e<e.e?this.e:e.e;return n>=a?null:re.fromDateTimes(n,a)}union(e){if(!this.isValid)return this;const n=this.s<e.s?this.s:e.s,a=this.e>e.e?this.e:e.e;return re.fromDateTimes(n,a)}static merge(e){const[n,a]=e.sort((r,o)=>r.s-o.s).reduce(([r,o],s)=>o?o.overlaps(s)||o.abutsStart(s)?[r,o.union(s)]:[r.concat([o]),s]:[r,s],[[],null]);return a&&n.push(a),n}static xor(e){let n=null,a=0;const r=[],o=e.map(c=>[{time:c.s,type:"s"},{time:c.e,type:"e"}]),s=Array.prototype.concat(...o),l=s.sort((c,u)=>c.time-u.time);for(const c of l)a+=c.type==="s"?1:-1,a===1?n=c.time:(n&&+n!=+c.time&&r.push(re.fromDateTimes(n,c.time)),n=null);return re.merge(r)}difference(...e){return re.xor([this].concat(e)).map(n=>this.intersection(n)).filter(n=>n&&!n.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()} – ${this.e.toISO()})`:Ct}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Interval { start: ${this.s.toISO()}, end: ${this.e.toISO()} }`:`Interval { Invalid, reason: ${this.invalidReason} }`}toLocaleString(e=Dn,n={}){return this.isValid?we.create(this.s.loc.clone(n),e).formatInterval(this):Ct}toISO(e){return this.isValid?`${this.s.toISO(e)}/${this.e.toISO(e)}`:Ct}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:Ct}toISOTime(e){return this.isValid?`${this.s.toISOTime(e)}/${this.e.toISOTime(e)}`:Ct}toFormat(e,{separator:n=" – "}={}){return this.isValid?`${this.s.toFormat(e)}${n}${this.e.toFormat(e)}`:Ct}toDuration(e,n){return this.isValid?this.e.diff(this.s,e,n):Z.invalid(this.invalidReason)}mapEndpoints(e){return re.fromDateTimes(e(this.s),e(this.e))}}class wn{static hasDST(e=oe.defaultZone){const n=$.now().setZone(e).set({month:12});return!e.isUniversal&&n.offset!==n.set({month:6}).offset}static isValidIANAZone(e){return rt.isValidZone(e)}static normalizeZone(e){return dt(e,oe.defaultZone)}static getStartOfWeek({locale:e=null,locObj:n=null}={}){return(n||K.create(e)).getStartOfWeek()}static getMinimumDaysInFirstWeek({locale:e=null,locObj:n=null}={}){return(n||K.create(e)).getMinDaysInFirstWeek()}static getWeekendWeekdays({locale:e=null,locObj:n=null}={}){return(n||K.create(e)).getWeekendDays().slice()}static months(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null,outputCalendar:o="gregory"}={}){return(r||K.create(n,a,o)).months(e)}static monthsFormat(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null,outputCalendar:o="gregory"}={}){return(r||K.create(n,a,o)).months(e,!0)}static weekdays(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null}={}){return(r||K.create(n,a,null)).weekdays(e)}static weekdaysFormat(e="long",{locale:n=null,numberingSystem:a=null,locObj:r=null}={}){return(r||K.create(n,a,null)).weekdays(e,!0)}static meridiems({locale:e=null}={}){return K.create(e).meridiems()}static eras(e="short",{locale:n=null}={}){return K.create(n,null,"gregory").eras(e)}static features(){return{relative:Po(),localeWeek:No()}}}function Ar(t,e){const n=r=>r.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),a=n(e)-n(t);return Math.floor(Z.fromMillis(a).as("days"))}function pl(t,e,n){const a=[["years",(c,u)=>u.year-c.year],["quarters",(c,u)=>u.quarter-c.quarter+(u.year-c.year)*4],["months",(c,u)=>u.month-c.month+(u.year-c.year)*12],["weeks",(c,u)=>{const d=Ar(c,u);return(d-d%7)/7}],["days",Ar]],r={},o=t;let s,l;for(const[c,u]of a)n.indexOf(c)>=0&&(s=c,r[c]=u(t,e),l=o.plus(r),l>e?(r[c]--,t=o.plus(r),t>e&&(l=t,r[c]--,t=o.plus(r))):t=l);return[t,r,l,s]}function yl(t,e,n,a){let[r,o,s,l]=pl(t,e,n);const c=e-r,u=n.filter(m=>["hours","minutes","seconds","milliseconds"].indexOf(m)>=0);u.length===0&&(s<e&&(s=r.plus({[l]:1})),s!==r&&(o[l]=(o[l]||0)+c/(s-r)));const d=Z.fromObject(o,a);return u.length>0?Z.fromMillis(c,a).shiftTo(...u).plus(d):d}const wl="missing Intl.DateTimeFormat.formatToParts support";function J(t,e=n=>n){return{regex:t,deser:([n])=>e(ss(n))}}const vl=" ",Yo=`[ ${vl}]`,Xo=new RegExp(Yo,"g");function Ll(t){return t.replace(/\./g,"\\.?").replace(Xo,Yo)}function Cr(t){return t.replace(/\./g,"").replace(Xo," ").toLowerCase()}function ze(t,e){return t===null?null:{regex:RegExp(t.map(Ll).join("|")),deser:([n])=>t.findIndex(a=>Cr(n)===Cr(a))+e}}function Ir(t,e){return{regex:t,deser:([,n,a])=>Gn(n,a),groups:e}}function vn(t){return{regex:t,deser:([e])=>e}}function bl(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Ml(t,e){const n=Ge(e),a=Ge(e,"{2}"),r=Ge(e,"{3}"),o=Ge(e,"{4}"),s=Ge(e,"{6}"),l=Ge(e,"{1,2}"),c=Ge(e,"{1,3}"),u=Ge(e,"{1,6}"),d=Ge(e,"{1,9}"),m=Ge(e,"{2,4}"),p=Ge(e,"{4,6}"),h=y=>({regex:RegExp(bl(y.val)),deser:([S])=>S,literal:!0}),b=(y=>{if(t.literal)return h(y);switch(y.val){case"G":return ze(e.eras("short"),0);case"GG":return ze(e.eras("long"),0);case"y":return J(u);case"yy":return J(m,_a);case"yyyy":return J(o);case"yyyyy":return J(p);case"yyyyyy":return J(s);case"M":return J(l);case"MM":return J(a);case"MMM":return ze(e.months("short",!0),1);case"MMMM":return ze(e.months("long",!0),1);case"L":return J(l);case"LL":return J(a);case"LLL":return ze(e.months("short",!1),1);case"LLLL":return ze(e.months("long",!1),1);case"d":return J(l);case"dd":return J(a);case"o":return J(c);case"ooo":return J(r);case"HH":return J(a);case"H":return J(l);case"hh":return J(a);case"h":return J(l);case"mm":return J(a);case"m":return J(l);case"q":return J(l);case"qq":return J(a);case"s":return J(l);case"ss":return J(a);case"S":return J(c);case"SSS":return J(r);case"u":return vn(d);case"uu":return vn(l);case"uuu":return J(n);case"a":return ze(e.meridiems(),0);case"kkkk":return J(o);case"kk":return J(m,_a);case"W":return J(l);case"WW":return J(a);case"E":case"c":return J(n);case"EEE":return ze(e.weekdays("short",!1),1);case"EEEE":return ze(e.weekdays("long",!1),1);case"ccc":return ze(e.weekdays("short",!0),1);case"cccc":return ze(e.weekdays("long",!0),1);case"Z":case"ZZ":return Ir(new RegExp(`([+-]${l.source})(?::(${a.source}))?`),2);case"ZZZ":return Ir(new RegExp(`([+-]${l.source})(${a.source})?`),2);case"z":return vn(/[a-z_+-/]{1,256}?/i);case" ":return vn(/[^\S\n\r]/);default:return h(y)}})(t)||{invalidReason:wl};return b.token=t,b}const Sl={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour12:{numeric:"h","2-digit":"hh"},hour24:{numeric:"H","2-digit":"HH"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"},timeZoneName:{long:"ZZZZZ",short:"ZZZ"}};function El(t,e,n){const{type:a,value:r}=t;if(a==="literal"){const c=/^\s+$/.test(r);return{literal:!c,val:c?" ":r}}const o=e[a];let s=a;a==="hour"&&(e.hour12!=null?s=e.hour12?"hour12":"hour24":e.hourCycle!=null?e.hourCycle==="h11"||e.hourCycle==="h12"?s="hour12":s="hour24":s=n.hour12?"hour12":"hour24");let l=Sl[s];if(typeof l=="object"&&(l=l[o]),l)return{literal:!1,val:l}}function kl(t){return[`^${t.map(n=>n.regex).reduce((n,a)=>`${n}(${a.source})`,"")}$`,t]}function _l(t,e,n){const a=t.match(e);if(a){const r={};let o=1;for(const s in n)if(Wt(n,s)){const l=n[s],c=l.groups?l.groups+1:1;!l.literal&&l.token&&(r[l.token.val[0]]=l.deser(a.slice(o,o+c))),o+=c}return[a,r]}else return[a,{}]}function Tl(t){const e=o=>{switch(o){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let n=null,a;return H(t.z)||(n=rt.create(t.z)),H(t.Z)||(n||(n=new Me(t.Z)),a=t.Z),H(t.q)||(t.M=(t.q-1)*3+1),H(t.h)||(t.h<12&&t.a===1?t.h+=12:t.h===12&&t.a===0&&(t.h=0)),t.G===0&&t.y&&(t.y=-t.y),H(t.u)||(t.S=Ra(t.u)),[Object.keys(t).reduce((o,s)=>{const l=e(s);return l&&(o[l]=t[s]),o},{}),n,a]}let ta=null;function Al(){return ta||(ta=$.fromMillis(1555555555555)),ta}function Cl(t,e){if(t.literal)return t;const n=we.macroTokenToFormatOpts(t.val),a=ni(n,e);return a==null||a.includes(void 0)?t:a}function Qo(t,e){return Array.prototype.concat(...t.map(n=>Cl(n,e)))}class ei{constructor(e,n){if(this.locale=e,this.format=n,this.tokens=Qo(we.parseFormat(n),e),this.units=this.tokens.map(a=>Ml(a,e)),this.disqualifyingUnit=this.units.find(a=>a.invalidReason),!this.disqualifyingUnit){const[a,r]=kl(this.units);this.regex=RegExp(a,"i"),this.handlers=r}}explainFromTokens(e){if(this.isValid){const[n,a]=_l(e,this.regex,this.handlers),[r,o,s]=a?Tl(a):[null,null,void 0];if(Wt(a,"a")&&Wt(a,"H"))throw new xt("Can't include meridiem when specifying 24-hour format");return{input:e,tokens:this.tokens,regex:this.regex,rawMatches:n,matches:a,result:r,zone:o,specificOffset:s}}else return{input:e,tokens:this.tokens,invalidReason:this.invalidReason}}get isValid(){return!this.disqualifyingUnit}get invalidReason(){return this.disqualifyingUnit?this.disqualifyingUnit.invalidReason:null}}function ti(t,e,n){return new ei(t,n).explainFromTokens(e)}function Il(t,e,n){const{result:a,zone:r,specificOffset:o,invalidReason:s}=ti(t,e,n);return[a,r,o,s]}function ni(t,e){if(!t)return null;const a=we.create(e,t).dtFormatter(Al()),r=a.formatToParts(),o=a.resolvedOptions();return r.map(s=>El(s,t,o))}const na="Invalid DateTime",Dr=864e13;function Xt(t){return new Je("unsupported zone",`the zone "${t.name}" is not supported`)}function aa(t){return t.weekData===null&&(t.weekData=Pn(t.c)),t.weekData}function ra(t){return t.localWeekData===null&&(t.localWeekData=Pn(t.c,t.loc.getMinDaysInFirstWeek(),t.loc.getStartOfWeek())),t.localWeekData}function vt(t,e){const n={ts:t.ts,zone:t.zone,c:t.c,o:t.o,loc:t.loc,invalid:t.invalid};return new $({...n,...e,old:n})}function ai(t,e,n){let a=t-e*60*1e3;const r=n.offset(a);if(e===r)return[a,e];a-=(r-e)*60*1e3;const o=n.offset(a);return r===o?[a,r]:[t-Math.min(r,o)*60*1e3,Math.max(r,o)]}function Ln(t,e){t+=e*60*1e3;const n=new Date(t);return{year:n.getUTCFullYear(),month:n.getUTCMonth()+1,day:n.getUTCDate(),hour:n.getUTCHours(),minute:n.getUTCMinutes(),second:n.getUTCSeconds(),millisecond:n.getUTCMilliseconds()}}function _n(t,e,n){return ai(Bn(t),e,n)}function Pr(t,e){const n=t.o,a=t.c.year+Math.trunc(e.years),r=t.c.month+Math.trunc(e.months)+Math.trunc(e.quarters)*3,o={...t.c,year:a,month:r,day:Math.min(t.c.day,Nn(a,r))+Math.trunc(e.days)+Math.trunc(e.weeks)*7},s=Z.fromObject({years:e.years-Math.trunc(e.years),quarters:e.quarters-Math.trunc(e.quarters),months:e.months-Math.trunc(e.months),weeks:e.weeks-Math.trunc(e.weeks),days:e.days-Math.trunc(e.days),hours:e.hours,minutes:e.minutes,seconds:e.seconds,milliseconds:e.milliseconds}).as("milliseconds"),l=Bn(o);let[c,u]=ai(l,n,t.zone);return s!==0&&(c+=s,u=t.zone.offset(c)),{ts:c,o:u}}function It(t,e,n,a,r,o){const{setZone:s,zone:l}=n;if(t&&Object.keys(t).length!==0||e){const c=e||l,u=$.fromObject(t,{...n,zone:c,specificOffset:o});return s?u:u.setZone(l)}else return $.invalid(new Je("unparsable",`the input "${r}" can't be parsed as ${a}`))}function bn(t,e,n=!0){return t.isValid?we.create(K.create("en-US"),{allowZ:n,forceSimple:!0}).formatDateTimeFromString(t,e):null}function oa(t,e){const n=t.c.year>9999||t.c.year<0;let a="";return n&&t.c.year>=0&&(a+="+"),a+=le(t.c.year,n?6:4),e?(a+="-",a+=le(t.c.month),a+="-",a+=le(t.c.day)):(a+=le(t.c.month),a+=le(t.c.day)),a}function Nr(t,e,n,a,r,o){let s=le(t.c.hour);return e?(s+=":",s+=le(t.c.minute),(t.c.millisecond!==0||t.c.second!==0||!n)&&(s+=":")):s+=le(t.c.minute),(t.c.millisecond!==0||t.c.second!==0||!n)&&(s+=le(t.c.second),(t.c.millisecond!==0||!a)&&(s+=".",s+=le(t.c.millisecond,3))),r&&(t.isOffsetFixed&&t.offset===0&&!o?s+="Z":t.o<0?(s+="-",s+=le(Math.trunc(-t.o/60)),s+=":",s+=le(Math.trunc(-t.o%60))):(s+="+",s+=le(Math.trunc(t.o/60)),s+=":",s+=le(Math.trunc(t.o%60)))),o&&(s+="["+t.zone.ianaName+"]"),s}const ri={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},Dl={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},Pl={ordinal:1,hour:0,minute:0,second:0,millisecond:0},oi=["year","month","day","hour","minute","second","millisecond"],Nl=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],xl=["year","ordinal","hour","minute","second","millisecond"];function Fl(t){const e={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[t.toLowerCase()];if(!e)throw new ao(t);return e}function xr(t){switch(t.toLowerCase()){case"localweekday":case"localweekdays":return"localWeekday";case"localweeknumber":case"localweeknumbers":return"localWeekNumber";case"localweekyear":case"localweekyears":return"localWeekYear";default:return Fl(t)}}function $l(t){if(Qt===void 0&&(Qt=oe.now()),t.type!=="iana")return t.offset(Qt);const e=t.name;let n=Ta.get(e);return n===void 0&&(n=t.offset(Qt),Ta.set(e,n)),n}function Fr(t,e){const n=dt(e.zone,oe.defaultZone);if(!n.isValid)return $.invalid(Xt(n));const a=K.fromObject(e);let r,o;if(H(t.year))r=oe.now();else{for(const c of oi)H(t[c])&&(t[c]=ri[c]);const s=Io(t)||Do(t);if(s)return $.invalid(s);const l=$l(n);[r,o]=_n(t,l,n)}return new $({ts:r,zone:n,loc:a,o})}function $r(t,e,n){const a=H(n.round)?!0:n.round,r=(s,l)=>(s=Wa(s,a||n.calendary?0:2,!0),e.loc.clone(n).relFormatter(n).format(s,l)),o=s=>n.calendary?e.hasSame(t,s)?0:e.startOf(s).diff(t.startOf(s),s).get(s):e.diff(t,s).get(s);if(n.unit)return r(o(n.unit),n.unit);for(const s of n.units){const l=o(s);if(Math.abs(l)>=1)return r(l,s)}return r(t>e?-0:0,n.units[n.units.length-1])}function Or(t){let e={},n;return t.length>0&&typeof t[t.length-1]=="object"?(e=t[t.length-1],n=Array.from(t).slice(0,t.length-1)):n=Array.from(t),[e,n]}let Qt;const Ta=new Map;class ${constructor(e){const n=e.zone||oe.defaultZone;let a=e.invalid||(Number.isNaN(e.ts)?new Je("invalid input"):null)||(n.isValid?null:Xt(n));this.ts=H(e.ts)?oe.now():e.ts;let r=null,o=null;if(!a)if(e.old&&e.old.ts===this.ts&&e.old.zone.equals(n))[r,o]=[e.old.c,e.old.o];else{const l=pt(e.o)&&!e.old?e.o:n.offset(this.ts);r=Ln(this.ts,l),a=Number.isNaN(r.year)?new Je("invalid input"):null,r=a?null:r,o=a?null:l}this._zone=n,this.loc=e.loc||K.create(),this.invalid=a,this.weekData=null,this.localWeekData=null,this.c=r,this.o=o,this.isLuxonDateTime=!0}static now(){return new $({})}static local(){const[e,n]=Or(arguments),[a,r,o,s,l,c,u]=n;return Fr({year:a,month:r,day:o,hour:s,minute:l,second:c,millisecond:u},e)}static utc(){const[e,n]=Or(arguments),[a,r,o,s,l,c,u]=n;return e.zone=Me.utcInstance,Fr({year:a,month:r,day:o,hour:s,minute:l,second:c,millisecond:u},e)}static fromJSDate(e,n={}){const a=ms(e)?e.valueOf():NaN;if(Number.isNaN(a))return $.invalid("invalid input");const r=dt(n.zone,oe.defaultZone);return r.isValid?new $({ts:a,zone:r,loc:K.fromObject(n)}):$.invalid(Xt(r))}static fromMillis(e,n={}){if(pt(e))return e<-Dr||e>Dr?$.invalid("Timestamp out of range"):new $({ts:e,zone:dt(n.zone,oe.defaultZone),loc:K.fromObject(n)});throw new ye(`fromMillis requires a numerical input, but received a ${typeof e} with value ${e}`)}static fromSeconds(e,n={}){if(pt(e))return new $({ts:e*1e3,zone:dt(n.zone,oe.defaultZone),loc:K.fromObject(n)});throw new ye("fromSeconds requires a numerical input")}static fromObject(e,n={}){e=e||{};const a=dt(n.zone,oe.defaultZone);if(!a.isValid)return $.invalid(Xt(a));const r=K.fromObject(n),o=xn(e,xr),{minDaysInFirstWeek:s,startOfWeek:l}=br(o,r),c=oe.now(),u=H(n.specificOffset)?a.offset(c):n.specificOffset,d=!H(o.ordinal),m=!H(o.year),p=!H(o.month)||!H(o.day),h=m||p,v=o.weekYear||o.weekNumber;if((h||d)&&v)throw new xt("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(p&&d)throw new xt("Can't mix ordinal dates with month/day");const b=v||o.weekday&&!h;let y,S,w=Ln(c,u);b?(y=Nl,S=Dl,w=Pn(w,s,l)):d?(y=xl,S=Pl,w=ea(w)):(y=oi,S=ri);let M=!1;for(const I of y){const R=o[I];H(R)?M?o[I]=S[I]:o[I]=w[I]:M=!0}const E=b?cs(o,s,l):d?us(o):Io(o),k=E||Do(o);if(k)return $.invalid(k);const _=b?vr(o,s,l):d?Lr(o):o,[A,T]=_n(_,u,a),C=new $({ts:A,zone:a,o:T,loc:r});return o.weekday&&h&&e.weekday!==C.weekday?$.invalid("mismatched weekday",`you can't specify both a weekday of ${o.weekday} and a date of ${C.toISO()}`):C.isValid?C:$.invalid(C.invalid)}static fromISO(e,n={}){const[a,r]=tl(e);return It(a,r,n,"ISO 8601",e)}static fromRFC2822(e,n={}){const[a,r]=nl(e);return It(a,r,n,"RFC 2822",e)}static fromHTTP(e,n={}){const[a,r]=al(e);return It(a,r,n,"HTTP",n)}static fromFormat(e,n,a={}){if(H(e)||H(n))throw new ye("fromFormat requires an input string and a format");const{locale:r=null,numberingSystem:o=null}=a,s=K.fromOpts({locale:r,numberingSystem:o,defaultToEN:!0}),[l,c,u,d]=Il(s,e,n);return d?$.invalid(d):It(l,c,a,`format ${n}`,e,u)}static fromString(e,n,a={}){return $.fromFormat(e,n,a)}static fromSQL(e,n={}){const[a,r]=ul(e);return It(a,r,n,"SQL",e)}static invalid(e,n=null){if(!e)throw new ye("need to specify a reason the DateTime is invalid");const a=e instanceof Je?e:new Je(e,n);if(oe.throwOnInvalid)throw new Oi(a);return new $({invalid:a})}static isDateTime(e){return e&&e.isLuxonDateTime||!1}static parseFormatForOpts(e,n={}){const a=ni(e,K.fromObject(n));return a?a.map(r=>r?r.val:null).join(""):null}static expandFormat(e,n={}){return Qo(we.parseFormat(e),K.fromObject(n)).map(r=>r.val).join("")}static resetCache(){Qt=void 0,Ta.clear()}get(e){return this[e]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?aa(this).weekYear:NaN}get weekNumber(){return this.isValid?aa(this).weekNumber:NaN}get weekday(){return this.isValid?aa(this).weekday:NaN}get isWeekend(){return this.isValid&&this.loc.getWeekendDays().includes(this.weekday)}get localWeekday(){return this.isValid?ra(this).weekday:NaN}get localWeekNumber(){return this.isValid?ra(this).weekNumber:NaN}get localWeekYear(){return this.isValid?ra(this).weekYear:NaN}get ordinal(){return this.isValid?ea(this.c).ordinal:NaN}get monthShort(){return this.isValid?wn.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?wn.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?wn.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?wn.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset}getPossibleOffsets(){if(!this.isValid||this.isOffsetFixed)return[this];const e=864e5,n=6e4,a=Bn(this.c),r=this.zone.offset(a-e),o=this.zone.offset(a+e),s=this.zone.offset(a-r*n),l=this.zone.offset(a-o*n);if(s===l)return[this];const c=a-s*n,u=a-l*n,d=Ln(c,s),m=Ln(u,l);return d.hour===m.hour&&d.minute===m.minute&&d.second===m.second&&d.millisecond===m.millisecond?[vt(this,{ts:c}),vt(this,{ts:u})]:[this]}get isInLeapYear(){return dn(this.year)}get daysInMonth(){return Nn(this.year,this.month)}get daysInYear(){return this.isValid?Ot(this.year):NaN}get weeksInWeekYear(){return this.isValid?sn(this.weekYear):NaN}get weeksInLocalWeekYear(){return this.isValid?sn(this.localWeekYear,this.loc.getMinDaysInFirstWeek(),this.loc.getStartOfWeek()):NaN}resolvedLocaleOptions(e={}){const{locale:n,numberingSystem:a,calendar:r}=we.create(this.loc.clone(e),e).resolvedOptions(this);return{locale:n,numberingSystem:a,outputCalendar:r}}toUTC(e=0,n={}){return this.setZone(Me.instance(e),n)}toLocal(){return this.setZone(oe.defaultZone)}setZone(e,{keepLocalTime:n=!1,keepCalendarTime:a=!1}={}){if(e=dt(e,oe.defaultZone),e.equals(this.zone))return this;if(e.isValid){let r=this.ts;if(n||a){const o=e.offset(this.ts),s=this.toObject();[r]=_n(s,o,e)}return vt(this,{ts:r,zone:e})}else return $.invalid(Xt(e))}reconfigure({locale:e,numberingSystem:n,outputCalendar:a}={}){const r=this.loc.clone({locale:e,numberingSystem:n,outputCalendar:a});return vt(this,{loc:r})}setLocale(e){return this.reconfigure({locale:e})}set(e){if(!this.isValid)return this;const n=xn(e,xr),{minDaysInFirstWeek:a,startOfWeek:r}=br(n,this.loc),o=!H(n.weekYear)||!H(n.weekNumber)||!H(n.weekday),s=!H(n.ordinal),l=!H(n.year),c=!H(n.month)||!H(n.day),u=l||c,d=n.weekYear||n.weekNumber;if((u||s)&&d)throw new xt("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(c&&s)throw new xt("Can't mix ordinal dates with month/day");let m;o?m=vr({...Pn(this.c,a,r),...n},a,r):H(n.ordinal)?(m={...this.toObject(),...n},H(n.day)&&(m.day=Math.min(Nn(m.year,m.month),m.day))):m=Lr({...ea(this.c),...n});const[p,h]=_n(m,this.o,this.zone);return vt(this,{ts:p,o:h})}plus(e){if(!this.isValid)return this;const n=Z.fromDurationLike(e);return vt(this,Pr(this,n))}minus(e){if(!this.isValid)return this;const n=Z.fromDurationLike(e).negate();return vt(this,Pr(this,n))}startOf(e,{useLocaleWeeks:n=!1}={}){if(!this.isValid)return this;const a={},r=Z.normalizeUnit(e);switch(r){case"years":a.month=1;case"quarters":case"months":a.day=1;case"weeks":case"days":a.hour=0;case"hours":a.minute=0;case"minutes":a.second=0;case"seconds":a.millisecond=0;break}if(r==="weeks")if(n){const o=this.loc.getStartOfWeek(),{weekday:s}=this;s<o&&(a.weekNumber=this.weekNumber-1),a.weekday=o}else a.weekday=1;if(r==="quarters"){const o=Math.ceil(this.month/3);a.month=(o-1)*3+1}return this.set(a)}endOf(e,n){return this.isValid?this.plus({[e]:1}).startOf(e,n).minus(1):this}toFormat(e,n={}){return this.isValid?we.create(this.loc.redefaultToEN(n)).formatDateTimeFromString(this,e):na}toLocaleString(e=Dn,n={}){return this.isValid?we.create(this.loc.clone(n),e).formatDateTime(this):na}toLocaleParts(e={}){return this.isValid?we.create(this.loc.clone(e),e).formatDateTimeParts(this):[]}toISO({format:e="extended",suppressSeconds:n=!1,suppressMilliseconds:a=!1,includeOffset:r=!0,extendedZone:o=!1}={}){if(!this.isValid)return null;const s=e==="extended";let l=oa(this,s);return l+="T",l+=Nr(this,s,n,a,r,o),l}toISODate({format:e="extended"}={}){return this.isValid?oa(this,e==="extended"):null}toISOWeekDate(){return bn(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:e=!1,suppressSeconds:n=!1,includeOffset:a=!0,includePrefix:r=!1,extendedZone:o=!1,format:s="extended"}={}){return this.isValid?(r?"T":"")+Nr(this,s==="extended",n,e,a,o):null}toRFC2822(){return bn(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return bn(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?oa(this,!0):null}toSQLTime({includeOffset:e=!0,includeZone:n=!1,includeOffsetSpace:a=!0}={}){let r="HH:mm:ss.SSS";return(n||e)&&(a&&(r+=" "),n?r+="z":e&&(r+="ZZ")),bn(this,r,!0)}toSQL(e={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(e)}`:null}toString(){return this.isValid?this.toISO():na}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`DateTime { ts: ${this.toISO()}, zone: ${this.zone.name}, locale: ${this.locale} }`:`DateTime { Invalid, reason: ${this.invalidReason} }`}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(e={}){if(!this.isValid)return{};const n={...this.c};return e.includeConfig&&(n.outputCalendar=this.outputCalendar,n.numberingSystem=this.loc.numberingSystem,n.locale=this.loc.locale),n}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(e,n="milliseconds",a={}){if(!this.isValid||!e.isValid)return Z.invalid("created by diffing an invalid DateTime");const r={locale:this.locale,numberingSystem:this.numberingSystem,...a},o=hs(n).map(Z.normalizeUnit),s=e.valueOf()>this.valueOf(),l=s?this:e,c=s?e:this,u=yl(l,c,o,r);return s?u.negate():u}diffNow(e="milliseconds",n={}){return this.diff($.now(),e,n)}until(e){return this.isValid?re.fromDateTimes(this,e):this}hasSame(e,n,a){if(!this.isValid)return!1;const r=e.valueOf(),o=this.setZone(e.zone,{keepLocalTime:!0});return o.startOf(n,a)<=r&&r<=o.endOf(n,a)}equals(e){return this.isValid&&e.isValid&&this.valueOf()===e.valueOf()&&this.zone.equals(e.zone)&&this.loc.equals(e.loc)}toRelative(e={}){if(!this.isValid)return null;const n=e.base||$.fromObject({},{zone:this.zone}),a=e.padding?this<n?-e.padding:e.padding:0;let r=["years","months","days","hours","minutes","seconds"],o=e.unit;return Array.isArray(e.unit)&&(r=e.unit,o=void 0),$r(n,this.plus(a),{...e,numeric:"always",units:r,unit:o})}toRelativeCalendar(e={}){return this.isValid?$r(e.base||$.fromObject({},{zone:this.zone}),this,{...e,numeric:"auto",units:["years","months","days"],calendary:!0}):null}static min(...e){if(!e.every($.isDateTime))throw new ye("min requires all arguments be DateTimes");return Mr(e,n=>n.valueOf(),Math.min)}static max(...e){if(!e.every($.isDateTime))throw new ye("max requires all arguments be DateTimes");return Mr(e,n=>n.valueOf(),Math.max)}static fromFormatExplain(e,n,a={}){const{locale:r=null,numberingSystem:o=null}=a,s=K.fromOpts({locale:r,numberingSystem:o,defaultToEN:!0});return ti(s,e,n)}static fromStringExplain(e,n,a={}){return $.fromFormatExplain(e,n,a)}static buildFormatParser(e,n={}){const{locale:a=null,numberingSystem:r=null}=n,o=K.fromOpts({locale:a,numberingSystem:r,defaultToEN:!0});return new ei(o,e)}static fromFormatParser(e,n,a={}){if(H(e)||H(n))throw new ye("fromFormatParser requires an input string and a format parser");const{locale:r=null,numberingSystem:o=null}=a,s=K.fromOpts({locale:r,numberingSystem:o,defaultToEN:!0});if(!s.equals(n.locale))throw new ye(`fromFormatParser called with a locale of ${s}, but the format parser was created for ${n.locale}`);const{result:l,zone:c,specificOffset:u,invalidReason:d}=n.explainFromTokens(e);return d?$.invalid(d):It(l,c,a,`format ${n.format}`,e,u)}static get DATE_SHORT(){return Dn}static get DATE_MED(){return ro}static get DATE_MED_WITH_WEEKDAY(){return Ui}static get DATE_FULL(){return oo}static get DATE_HUGE(){return io}static get TIME_SIMPLE(){return so}static get TIME_WITH_SECONDS(){return lo}static get TIME_WITH_SHORT_OFFSET(){return co}static get TIME_WITH_LONG_OFFSET(){return uo}static get TIME_24_SIMPLE(){return mo}static get TIME_24_WITH_SECONDS(){return ho}static get TIME_24_WITH_SHORT_OFFSET(){return go}static get TIME_24_WITH_LONG_OFFSET(){return fo}static get DATETIME_SHORT(){return po}static get DATETIME_SHORT_WITH_SECONDS(){return yo}static get DATETIME_MED(){return wo}static get DATETIME_MED_WITH_SECONDS(){return vo}static get DATETIME_MED_WITH_WEEKDAY(){return Hi}static get DATETIME_FULL(){return Lo}static get DATETIME_FULL_WITH_SECONDS(){return bo}static get DATETIME_HUGE(){return Mo}static get DATETIME_HUGE_WITH_SECONDS(){return So}}function Kt(t){if($.isDateTime(t))return t;if(t&&t.valueOf&&pt(t.valueOf()))return $.fromJSDate(t);if(t&&typeof t=="object")return $.fromObject(t);throw new ye(`Unknown datetime argument: ${t}, of type ${typeof t}`)}const Ft=65,Ee=73,Ne=79;function ii(t,e){if(e=typeof e=="number"?e:5,!Array.isArray(t))throw new TypeError("forward did not receive an array");if(typeof t[0]=="string"||typeof t[1]=="string")throw new TypeError("forward received an array of strings, but it only accepts an array of numbers.");const[n,a]=t;if(n<-180||n>180)throw new TypeError("forward received an invalid longitude of "+n);if(a<-90||a>90)throw new TypeError("forward received an invalid latitude of "+a);if(a<-80||a>84)throw new TypeError(`forward received a latitude of ${a}, but this library does not support conversions of points in polar regions below 80°S and above 84°N`);return function(r,o){const s="00000"+r.easting,l="00000"+r.northing;return r.zoneNumber+r.zoneLetter+function(c,u,d){const m=li(d),p=Math.floor(c/1e5),h=Math.floor(u/1e5)%20;return function(v,b,y){const S=y-1,w="AJSAJS".charCodeAt(S),M="AFAFAF".charCodeAt(S);let E=w+v-1,k=M+b,_=!1;return E>90&&(E=E-90+Ft-1,_=!0),(E===Ee||w<Ee&&E>Ee||(E>Ee||w<Ee)&&_)&&E++,(E===Ne||w<Ne&&E>Ne||(E>Ne||w<Ne)&&_)&&(E++,E===Ee&&E++),E>90&&(E=E-90+Ft-1),k>86?(k=k-86+Ft-1,_=!0):_=!1,(k===Ee||M<Ee&&k>Ee||(k>Ee||M<Ee)&&_)&&k++,(k===Ne||M<Ne&&k>Ne||(k>Ne||M<Ne)&&_)&&(k++,k===Ee&&k++),k>86&&(k=k-86+Ft-1),String.fromCharCode(E)+String.fromCharCode(k)}(p,h,m)}(r.easting,r.northing,r.zoneNumber)+s.substr(s.length-5,o)+l.substr(l.length-5,o)}(function(r){const o=r.lat,s=r.lon,l=6378137,c=ia(o),u=ia(s);let d;d=Math.floor((s+180)/6)+1,s===180&&(d=60),o>=56&&o<64&&s>=3&&s<12&&(d=32),o>=72&&o<84&&(s>=0&&s<9?d=31:s>=9&&s<21?d=33:s>=21&&s<33?d=35:s>=33&&s<42&&(d=37));const m=ia(6*(d-1)-180+3),p=l/Math.sqrt(1-.00669438*Math.sin(c)*Math.sin(c)),h=Math.tan(c)*Math.tan(c),v=.006739496752268451*Math.cos(c)*Math.cos(c),b=Math.cos(c)*(u-m),y=l*(.9983242984503243*c-.002514607064228144*Math.sin(2*c)+2639046602129982e-21*Math.sin(4*c)-3418046101696858e-24*Math.sin(6*c)),S=.9996*p*(b+(1-h+v)*b*b*b/6+(5-18*h+h*h+72*v-.39089081163157013)*b*b*b*b*b/120)+5e5;let w=.9996*(y+p*Math.tan(c)*(b*b/2+(5-h+9*v+4*v*v)*b*b*b*b/24+(61-58*h+h*h+600*v-2.2240339282485886)*b*b*b*b*b*b/720));return o<0&&(w+=1e7),{northing:Math.trunc(w),easting:Math.trunc(S),zoneNumber:d,zoneLetter:si(o)}}({lat:a,lon:n}),e)}function Ol(t){const e=za(ci(t.toUpperCase()));return typeof e.lat=="number"&&typeof e.lon=="number"?[e.lon,e.lat,e.lon,e.lat]:[e.left,e.bottom,e.right,e.top]}function Ga(t){if(t==="")throw new TypeError("toPoint received a blank string");const e=za(ci(t.toUpperCase()));return typeof e.lat=="number"&&typeof e.lon=="number"?[e.lon,e.lat]:[(e.left+e.right)/2,(e.top+e.bottom)/2]}function ia(t){return t*(Math.PI/180)}function Rr(t){return t/Math.PI*180}function za(t){const e=t.northing,n=t.easting,{zoneLetter:a,zoneNumber:r}=t;if(r<0||r>60)return null;const o=6378137,s=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),l=n-5e5;let c=e;a<"N"&&(c-=1e7);const u=6*(r-1)-180+3,d=c/.9996/6367449145945056e-9,m=d+(3*s/2-27*s*s*s/32)*Math.sin(2*d)+(21*s*s/16-55*s*s*s*s/32)*Math.sin(4*d)+151*s*s*s/96*Math.sin(6*d),p=o/Math.sqrt(1-.00669438*Math.sin(m)*Math.sin(m)),h=Math.tan(m)*Math.tan(m),v=.006739496752268451*Math.cos(m)*Math.cos(m),b=.99330562*o/Math.pow(1-.00669438*Math.sin(m)*Math.sin(m),1.5),y=l/(.9996*p);let S=m-p*Math.tan(m)/b*(y*y/2-(5+3*h+10*v-4*v*v-.06065547077041606)*y*y*y*y/24+(61+90*h+298*v+45*h*h-1.6983531815716497-3*v*v)*y*y*y*y*y*y/720);S=Rr(S);let w,M=(y-(1+2*h+v)*y*y*y/6+(5-2*v+28*h-3*v*v+.05391597401814761+24*h*h)*y*y*y*y*y/120)/Math.cos(m);if(M=u+Rr(M),typeof t.accuracy=="number"){const E=za({northing:t.northing+t.accuracy,easting:t.easting+t.accuracy,zoneLetter:t.zoneLetter,zoneNumber:t.zoneNumber});w={top:E.lat,right:E.lon,bottom:S,left:M}}else w={lat:S,lon:M};return w}function si(t){return t<=84&&t>=72?"X":t<72&&t>=-80?"CDEFGHJKLMNPQRSTUVWX"[Math.floor((t- -80)/8)]:t>84||t<-80?"Z":void 0}function li(t){let e=t%6;return e===0&&(e=6),e}function ci(t){if(t&&t.length===0)throw new TypeError("MGRSPoint coverting from nothing");t=t.replace(/ /g,"");const{length:e}=t;let n,a=null,r="",o=0;for(;!/[A-Z]/.test(n=t.charAt(o));){if(o>=2)throw new Error("MGRSPoint bad conversion from: "+t);r+=n,o++}const s=parseInt(r,10);if(o===0||o+3>e)throw new Error("MGRSPoint bad conversion from "+t);const l=t.charAt(o++);if(l<="A"||l==="B"||l==="Y"||l>="Z"||l==="I"||l==="O")throw new Error(`MGRSPoint zone letter ${l} not handled: ${t}`);a=t.substring(o,o+=2);const c=li(s),u=function(w,M){let E="AJSAJS".charCodeAt(M-1),k=1e5,_=!1;for(;E!==w.charCodeAt(0);){if(E++,E===Ee&&E++,E===Ne&&E++,E>90){if(_)throw new Error("Bad character: "+w);E=Ft,_=!0}k+=1e5}return k}(a.charAt(0),c);let d=function(w,M){if(w>"V")throw new TypeError("MGRSPoint given invalid Northing "+w);let E="AFAFAF".charCodeAt(M-1),k=0,_=!1;for(;E!==w.charCodeAt(0);){if(E++,E===Ee&&E++,E===Ne&&E++,E>86){if(_)throw new Error("Bad character: "+w);E=Ft,_=!0}k+=1e5}return k}(a.charAt(1),c);for(;d<Rl(l);)d+=2e6;const m=e-o;if(m%2!=0)throw new Error(`MGRSPoint has to have an even number
of digits after the zone letter and two 100km letters - front
half for easting meters, second half for
northing meters `+t);const p=m/2;let h,v,b,y=0,S=0;return p>0&&(h=1e5/Math.pow(10,p),v=t.substring(o,o+p),y=parseFloat(v)*h,b=t.substring(o+p),S=parseFloat(b)*h),{easting:y+u,northing:S+d,zoneLetter:l,zoneNumber:s,accuracy:h}}function Rl(t){let e;switch(t){case"C":e=11e5;break;case"D":e=2e6;break;case"E":e=28e5;break;case"F":e=37e5;break;case"G":e=46e5;break;case"H":e=55e5;break;case"J":e=64e5;break;case"K":e=73e5;break;case"L":e=82e5;break;case"M":e=91e5;break;case"N":e=0;break;case"P":e=8e5;break;case"Q":e=17e5;break;case"R":e=26e5;break;case"S":e=35e5;break;case"T":e=44e5;break;case"U":e=53e5;break;case"V":e=62e5;break;case"W":e=7e6;break;case"X":e=79e5;break;default:e=-1}if(e>=0)return e;throw new TypeError("Invalid zone letter: "+t)}const Wl=Object.freeze(Object.defineProperty({__proto__:null,forward:ii,getLetterDesignator:si,inverse:Ol,toPoint:Ga},Symbol.toStringTag,{value:"Module"})),Ul="/upper_winds_open_meteo/icon-48.png",Hl="/upper_winds_open_meteo/schere_purple.png",Bl="/upper_winds_open_meteo/airplane_orange.png",Gl="/upper_winds_open_meteo/livePlane.png",Wr={135:5,130:5,125:5,120:5,115:5,110:5,105:5,100:6,95:7,90:7,85:7,80:8,75:8,70:9,65:10,60:10,55:11,50:12,45:14,40:15,35:17,30:20,25:24,20:30,15:40,10:60,5:119},zl={TERMINAL_VELOCITY_VERTICAL_MPS:50,GRAVITY_ACCELERATION:9.81,HORIZONTAL_DRAG_TAU_SECONDS:5},at=200,sa={OPEN:4.1,PARTIALLY:12.8,COLLAPSED:39.2},Vl=150,Dt={MIN_TRACK_LENGTH_M:100,MAX_TRACK_LENGTH_M:1e4,MIN_APPROACH_LENGTH_M:100,MAX_APPROACH_LENGTH_M:2e4,APPROACH_TIME_SECONDS:120},Ur={SURFACE_WIND_WARNING_KT:16,GUST_WARNING_KT:25},Zl=[95,96,99],ui={LIST:["icon_seamless","icon_global","icon_eu","icon_d2","ecmwf_ifs025","ecmwf_aifs025_single","gfs_seamless","gfs_global","gfs_hrrr","gfs_graphcast025","arome_france","gem_hrdps_continental","gem_regional"],API_MAP:{icon_seamless:"dwd_icon",icon_global:"dwd_icon",icon_eu:"dwd_icon_eu",icon_d2:"dwd_icon_d2",ecmwf_ifs025:"ecmwf_ifs025",ecmwf_aifs025_single:"ecmwf_aifs025_single",gfs_seamless:"ncep_gfs013",gfs_global:"ncep_gfs025",gfs_hrrr:"ncep_hrrr_conus",arome_france:"meteofrance_arome_france0025",gfs_graphcast025:"ncep_gfs_graphcast025",gem_hrdps_continental:"cmc_gem_hrdps",gem_regional:"cmc_gem_rdps"}},ln={FORECAST:"https://api.open-meteo.com/v1/forecast",HISTORICAL:"https://historical-forecast-api.open-meteo.com/v1/forecast"},fe={METERS_TO_FEET:3.28084,FEET_TO_METERS:.3048,KNOTS_TO_MPS:.514444,KNOTS_TO_KMH:1.852,CELSIUS_TO_KELVIN:273.15},Hr={MOLAR_MASS_AIR:.0289644,UNIVERSAL_GAS_CONSTANT:8.31446261815324},Pt={LAPSE_RATE:.0065,SEA_LEVEL_TEMP_KELVIN:288.15,GRAVITY:9.80665,GAS_CONSTANT_AIR:287.05},Mn={A_LIQUID:17.27,B_LIQUID:237.7,A_ICE:21.87,B_ICE:265.5},jl=6371e3,Br={KNOT_THRESHOLDS:[1,4,7,11,17,22,28,34,41,48,56,64],BEAUFORT_THRESHOLDS:[0,1,3,6,10,16,21,27,33,40,47,55,63]},Jl=[1e3,950,925,900,850,800,700,600,500,400,300,250,200],je={DEFAULT_MAP_CENTER:[47.9808,11.234],DEFAULT_MAP_ZOOM:11,GEOLOCATION_TIMEOUT_MS:2e4,GEOLOCATION_ACCURACY_THRESHOLD_M:500,MIN_ZOOM:11,MAX_ZOOM:15,LANDING_PATTERN_MIN_ZOOM:14},Sn={MIN_TIME_DIFF_FOR_SPEED_CALC_S:.5,SPEED_SMOOTHING_LOW:.5,SPEED_SMOOTHING_HIGH:.2,SPEED_SMOOTHING_TRESHOLD:25},Va={TILE_MAX_AGE_DAYS:7,FETCH_TIMEOUT_MS:15e3,SIZE_LIMIT_MB_WARNING:500},mt={SCENARIO_COLORS:{MIN_WIND:"rgba(0, 0, 255, 0.7)",MEAN_WIND:"rgba(0, 255, 0, 0.7)",MAX_WIND:"rgba(255, 0, 0, 0.7)"},HEATMAP_MIN_RADIUS_PX:5,HEATMAP_MAX_RADIUS_PX:50,HEATMAP_SCALING_BASE:1.42,HEATMAP_REFERENCE_ZOOM:13},Vn={DEFAULT_MARKER:Ul,CUTAWAY_MARKER:Hl,AIRPLANE_MARKER:Bl,LIVEPLANE_MARKER:Gl},ql="DZMasterTest",Kl="DataTest";let Gr=!1;const Ke=()=>{const t=document.getElementById("interpStep");return t?t.value:"200"};function Yl(t){Gr=t,console.log(`App context set to: ${Gr?"Mobile":"Web"}`)}const g={FEATURE_PASSWORD_PLANNER:ql,FEATURE_PASSWORD_DATA:Kl,defaultSettings:{model:"icon_global",refLevel:"AGL",heightUnit:"m",temperatureUnit:"C",windUnit:"kt",timeZone:"Z",coordFormat:"Decimal",downloadFormat:"HEIDIS",maxForecastTime:"Maximum",showTable:!1,canopySpeed:20,descentRate:3.5,showLandingPattern:!1,landingDirection:"LL",customLandingDirectionLL:"",customLandingDirectionRR:"",legHeightDownwind:300,legHeightBase:200,legHeightFinal:100,interpStep:"200",lowerLimit:0,upperLimit:3e3,baseMaps:"Esri Street",calculateJump:!0,openingAltitude:1200,exitAltitude:3e3,showJumpRunTrack:!1,showExitArea:!1,showCanopyArea:!1,showCutAwayFinder:!1,jumpRunTrackOffset:0,jumpRunTrackForwardOffset:0,aircraftSpeedKt:90,jumperSeparation:5,numberOfJumpers:5,cutAwayAltitude:1e3,cutAwayState:"Partially",terrainWarningLayer:null,terrainAnalysisCache:null,terrainClearance:100,trackPosition:!1,showJumpMasterLine:!1,jumpMasterLineTarget:"DIP",harpLat:null,harpLng:null,cacheRadiusKm:10,cacheZoomLevels:[11,12,13,14],autoupdate:!1,selectedEnsembleModels:[],currentEnsembleScenario:"all_models",isInteractionLocked:!1,enableWindAlert:!0,alerts:{wind:{enabled:!0,threshold:16},gust:{enabled:!0,threshold:25},thunderstorm:{enabled:!0},clouds:{enabled:!0,cover:"BKN",base:1e3}}},state:{userSettings:null,unlockedFeatures:{planner:!1,plannerHash:null,data:!1,dataHash:null}},initialize(){var s,l,c,u;const t=this.FEATURE_PASSWORD_PLANNER.split("").reduce((d,m)=>m.charCodeAt(0)+((d<<5)-d),0),e=this.FEATURE_PASSWORD_DATA.split("").reduce((d,m)=>m.charCodeAt(0)+((d<<5)-d),0);let n={planner:!1,plannerHash:null,data:!1,dataHash:null};try{const d=localStorage.getItem("unlockedFeatures");d&&(n={...n,...JSON.parse(d)})}catch(d){this.handleError(d,"Failed to load unlocked features.")}const a=n.planner&&n.plannerHash===t,r=n.data&&n.dataHash===e;this.state.unlockedFeatures={planner:a,plannerHash:a?t:null,data:r,dataHash:r?e:null},this.saveUnlockedFeatures();let o={};try{const d=localStorage.getItem("upperWindsSettings");d&&(o=JSON.parse(d))}catch(d){this.handleError(d,"Failed to load settings.")}this.state.userSettings={...this.defaultSettings,...o,alerts:{...this.defaultSettings.alerts,...o.alerts||{},wind:{...this.defaultSettings.alerts.wind,...((s=o.alerts)==null?void 0:s.wind)||{}},gust:{...this.defaultSettings.alerts.gust,...((l=o.alerts)==null?void 0:l.gust)||{}},thunderstorm:{...this.defaultSettings.alerts.thunderstorm,...((c=o.alerts)==null?void 0:c.thunderstorm)||{}},clouds:{...this.defaultSettings.alerts.clouds,...((u=o.alerts)==null?void 0:u.clouds)||{}}}},this.state.userSettings.isInteractionLocked=!1,this.state.userSettings.harpLat=null,this.state.userSettings.harpLng=null,this.state.userSettings.jumpRunTrackOffset=0,this.state.userSettings.jumpRunTrackForwardOffset=0,this.state.userSettings.showCutAwayFinder=!1},save(){const t={...this.state.userSettings};delete t.customJumpRunDirection;try{localStorage.setItem("upperWindsSettings",JSON.stringify(t))}catch(e){console.error("Failed to save settings to localStorage:",e)}},isFeatureUnlocked(t){return!0},showPasswordModal(t,e,n){const a=document.getElementById("passwordModal"),r=document.getElementById("passwordInput"),o=document.getElementById("passwordError"),s=document.getElementById("passwordSubmit"),l=document.getElementById("passwordCancel"),c=document.getElementById("modalHeader"),u=document.getElementById("modalMessage");if(!a||!r||!s||!l||!c||!u)return;const d=t==="planner"?this.FEATURE_PASSWORD_PLANNER:this.FEATURE_PASSWORD_DATA,m=t.charAt(0).toUpperCase()+t.slice(1);c.textContent=`${m} Access`,u.textContent=`Please enter the password to enable the ${m.toLowerCase()} functionality:`,r.value="",o.style.display="none",a.style.display="flex";const p=()=>{r.value===d?(a.style.display="none",this.saveUnlockStatus(t,!0),document.dispatchEvent(new CustomEvent("ui:lockStateChanged")),e()):(o.textContent="Incorrect password",o.style.display="block")};s.onclick=p,r.onkeypress=h=>{h.key==="Enter"&&p()},l.onclick=()=>{a.style.display="none",n()}},saveUnlockStatus(t,e){if(t==="planner"){const n=this.FEATURE_PASSWORD_PLANNER.split("").reduce((a,r)=>r.charCodeAt(0)+((a<<5)-a),0);this.state.unlockedFeatures.planner=e,this.state.unlockedFeatures.plannerHash=e?n:null}else if(t==="data"){const n=this.FEATURE_PASSWORD_DATA.split("").reduce((a,r)=>r.charCodeAt(0)+((a<<5)-a),0);this.state.unlockedFeatures.data=e,this.state.unlockedFeatures.dataHash=e?n:null}this.saveUnlockedFeatures()},saveUnlockedFeatures(t=this.state.unlockedFeatures){try{const e=JSON.stringify(t);localStorage.setItem("unlockedFeatures",e)}catch(e){this.handleError(e,"Failed to save unlocked features to localStorage.")}},getValue(t,e,n){if(n===void 0&&typeof e!="string"&&(n=e,e=null),this.state.userSettings&&typeof this.state.userSettings[t]<"u")return this.state.userSettings[t];const a=document.querySelector(`input[name="${t}"]:checked`);if(a)return a.value;const r=document.getElementById(t);if(r&&r.tagName==="SELECT")return r.value;const o=document.getElementById(t);return o&&o.type==="checkbox"?o.checked:n},handleError(t,e="An error occurred."){console.error("Settings Error:",t)}};let la=console.error,ca=console.log;const W=class W{static setErrorHandler(e){la=e}static setMessageHandler(e){ca=e}static handleError(e,n=!0){n&&console.error(e),typeof la=="function"&&la(e)}static handleMessage(e){typeof ca=="function"?ca(e):console.log(e)}static convertHeight(e,n){const a=parseFloat(e);return isNaN(a)?"N/A":n==="ft"?parseFloat((e*fe.METERS_TO_FEET).toFixed(0)):e}static convertFeetToMeters(e){return e==null||isNaN(e)?0:e/3.28084}static convertTemperature(e,n){const a=parseFloat(e);return isNaN(a)?"N/A":n==="°F"?a*9/5+32:a}static convertWind(e,n,a="km/h"){if(e==null||isNaN(e))return"N/A";let r;switch(a){case"km/h":r=e;break;case"m/s":r=e*3.6;break;case"kt":r=e*fe.KNOTS_TO_KMH;break;case"mph":r=e*1.60934;break;case"bft":r=W.beaufortToKnots(e)*fe.KNOTS_TO_KMH;break;default:r=e;break}switch(n){case"km/h":return r;case"m/s":return r/3.6;case"kt":return r/fe.KNOTS_TO_KMH;case"mph":return r/1.60934;case"bft":return W.knotsToBeaufort(r/fe.KNOTS_TO_KMH);default:return r/fe.KNOTS_TO_KMH}}static knotsToBeaufort(e){const n=Br.KNOT_THRESHOLDS.findIndex(a=>e<a);return n===-1?12:n}static beaufortToKnots(e){return Br.BEAUFORT_THRESHOLDS[e]||63}static normalizeAngle(e){return(e%360+360)%360}static calculateDewpoint(e,n){const a=Mn.A_LIQUID,r=Mn.B_LIQUID,o=Mn.A_ICE,s=Mn.B_ICE;let l,c;return e>=0?(l=a*e/(r+e)+Math.log(n/100),c=r*l/(a-l)):(l=o*e/(s+e)+Math.log(n/100),c=s*l/(o-l)),isNaN(c)?null:c}static calculateQFE(e,n,a,r=15){if(!e||n==="N/A"||a==="N/A"||isNaN(e)||isNaN(n)||isNaN(a))return"N/A";const o=Pt.GRAVITY,s=Hr.MOLAR_MASS_AIR,l=Hr.UNIVERSAL_GAS_CONSTANT,c=r+fe.CELSIUS_TO_KELVIN,u=Pt.LAPSE_RATE,d=e*100,m=n-a,p=o*s/(l*u),h=d*Math.pow(1-u*m/c,p),v=Math.round(h/100);return isNaN(v)?"N/A":v}static linearInterpolate(e,n,a){if(!(e!=null&&e.length)||!(n!=null&&n.length)||e.length!==n.length)return"invalid input for linearInterpolate";let r=!1;e[1]>e[0]&&(n=[...n].reverse(),e=[...e].reverse(),r=!0);const o=e.length-1;try{if(a>e[0]||a<e[o]){let s,l;return a>e[0]?(s=(n[1]-n[0])/(e[1]-e[0]),l=n[1]-s*e[1]):(s=(n[o]-n[o-1])/(e[o]-e[o-1]),l=n[o]-s*e[o]),s*a+l}else{let s;for(s=1;s<=o&&!(a>=e[s]);s++);const l=(n[s]-n[s-1])/(e[s]-e[s-1]),c=n[s]-l*e[s];return l*a+c}}catch{return"interpolation error"}finally{r&&(n.reverse(),e.reverse())}}static linearInterpolateAngle(e,n,a){if(!(e!=null&&e.length)||!(n!=null&&n.length)||e.length!==n.length)return NaN;let r=!1;e[0]<e[e.length-1]&&(e=[...e].reverse(),n=[...n].reverse(),r=!0);const o=e.length;let s=0;for(;s<o&&e[s]>a;)s++;s===0?s=1:s===o&&(s=o-1);const l=e[s-1],c=e[s];let u=n[s-1],m=n[s]-u;if(m>180&&(m-=360),m<-180&&(m+=360),c-l===0)return u;const p=(a-l)/(c-l);let h=u+p*m;return h=(h+360)%360,r&&(e.reverse(),n.reverse()),h}static linearInterpolateAngle(e,n,a){if(!(e!=null&&e.length)||!(n!=null&&n.length)||e.length!==n.length||e.length<2)return NaN;const r=e.length,o=e[0]<e[r-1];let s=1;if(o)for(;s<r&&a>e[s];)s++;else for(;s<r&&a<e[s];)s++;o?(a>=e[r-1]&&(s=r-1),a<e[0]&&(s=1)):(a<=e[r-1]&&(s=r-1),a>e[0]&&(s=1));const l=e[s-1],c=e[s],u=n[s-1],d=n[s];if(c===l)return u;let m=d-u;m>180?m-=360:m<-180&&(m+=360);const p=(a-l)/(c-l);return(u+p*m+360)%360}static gaussianInterpolation(e,n,a,r,o){if(a===o)return e;if(r===o)return n;let s=1/Math.abs(a-o),l=1/Math.abs(r-o);return(s*e+l*n)/(s+l)}static interpolateWindAtAltitude(e,n,a,r,o){if(n.length!=a.length||n.length!=r.length||n.length!=o.length)return{u:"Invalid input",v:"Invalid input"};const s=n.map(m=>Math.log(m)),l=W.linearInterpolate(a,s,e);if(typeof l=="string"&&l.includes("error"))return{u:"Interpolation error",v:"Interpolation error"};const c=Math.exp(l),u=W.linearInterpolate(s,r,Math.log(c)),d=W.linearInterpolate(s,o,Math.log(c));return typeof u=="string"&&u.includes("error")||typeof d=="string"&&d.includes("error")?{u:"Interpolation error",v:"Interpolation error"}:{u,v:d}}static interpolatePressure(e,n,a){if(!n||!a||n.length!==a.length||n.length<2||e<a[0]||e>a[a.length-1])return"N/A";for(let r=0;r<a.length-1;r++)if(e>=a[r]&&e<=a[r+1]){const o=a[r],s=a[r+1],l=n[r],c=n[r+1];return l+(c-l)*(e-o)/(s-o)}return"N/A"}static windSpeed(e,n){return Math.sqrt(e*e+n*n)}static windDirection(e,n){return(Math.atan2(-e,-n)*180/Math.PI+360)%360}static calculateMeanWind(e,n,a,r,o){try{if(!e||!n||!a||e.length<2||r>=o)throw new Error("Invalid input data or limits for calculateMeanWind");const s=new Array(4);let l=[o],c=[Number(W.linearInterpolate(e,n,o))],u=[Number(W.linearInterpolate(e,a,o))];const d=Number(W.linearInterpolate(e,n,r)),m=Number(W.linearInterpolate(e,a,r));for(let w=0;w<e.length;w++)e[w]<o&&e[w]>r&&(l.push(e[w]),c.push(n[w]),u.push(a[w]));l.push(r),c.push(d),u.push(m);const p=l.map((w,M)=>M);p.sort((w,M)=>l[M]-l[w]),l=p.map(w=>l[w]),c=p.map(w=>c[w]),u=p.map(w=>u[w]);let h=0,v=0;for(let w=0;w<l.length-1;w++)h+=.5*(c[w]+c[w+1])*(l[w]-l[w+1]),v+=.5*(u[w]+u[w+1])*(l[w]-l[w+1]);const b=l[0]-l[l.length-1];if(b===0)return s[2]=d,s[3]=m,s[1]=W.windSpeed(d,m),s[0]=W.windDirection(d,m),s;const y=h/b,S=v/b;return s[2]=y,s[3]=S,s[1]=W.windSpeed(y,S),s[0]=W.windDirection(y,S),s}catch(s){return console.error("Error in calculateMeanWind:",s,{heights:e,xComponents:n,yComponents:a,lowerLimit:r,upperLimit:o}),W.handleError("Failed to calculate mean wind: "+s.message),null}}static translateWmoCodeToTaf(e){const n={0:"NSW",1:"NSW",2:"NSW",3:"NSW",45:"FG",48:"FZFG",51:"-DZ",53:"DZ",55:"+DZ",56:"-FZDZ",57:"FZDZ",61:"-RA",63:"RA",65:"+RA",66:"-FZRA",67:"FZRA",71:"-SN",73:"SN",75:"+SN",77:"SG",80:"-SHRA",81:"SHRA",82:"+SHRA",83:"-SHRASN",85:"-SHSN",86:"SHSN",95:"TS",96:"TSGR",99:"+TSGR"},a=parseInt(e,10);return isNaN(a)?"N/A":n[a]||"N/A"}static findCloudLayers(e){if(!e||e.length===0)return[];const n=[];let a=null;const r={FEW:1,SCT:2,BKN:3,OVC:4},o=s=>s<=5?null:s<=25?"FEW":s<=50?"SCT":s<=87?"BKN":"OVC";for(const s of e){const l=o(s.cc);if(!l||n.length>=3)continue;(!a||r[l]>r[a])&&(n.push({cover:l,base:s.displayHeight}),a=l)}return n}static getCloudLayersForMetar(e,n){const a=W.findCloudLayers(e);return a.length===0?"SKC":a.map(r=>{const o=r.base;let s,l;return n==="ft"?(s=Math.round(W.convertHeight(o,"ft")/100)*100,l="ft"):(s=Math.round(o/50)*50,l="m"),`${r.cover} ${s}${l}`}).join(", ")}static formatVisibility(e){const n=parseFloat(e);return isNaN(n)?"N/A":n>=1e4?">10000":n>=5e3?(Math.round(n/1e3)*1e3).toString():(Math.round(n/100)*100).toString()}static formatWindDirection(e){const n=parseFloat(e);if(isNaN(n))return"N/A";let a=Math.round(n/10)*10;return(a===0||a>=360)&&(a=360),a.toString().padStart(3,"0")}static calculateTAS(e,n){if(isNaN(e)||isNaN(n)||e<0||n<0)return console.warn("Invalid inputs for calculateTAS:",{ias:e,heightFt:n}),"N/A";const a=Pt.LAPSE_RATE,r=Pt.SEA_LEVEL_TEMP_KELVIN,o=Pt.GRAVITY,s=Pt.GAS_CONSTANT_AIR,l=fe.FEET_TO_METERS,c=n*l,u=r-a*c,d=u/r,m=1-a*c/r,p=o/(a*s)-1,h=Math.pow(m,p),v=e/Math.sqrt(h);return console.log("calculateTAS debug:",{ias:e,heightFt:n,heightM:c,tempAtAltitude:u,tempRatio:d,base:m,exponent:p,densityRatio:h,tas:v,tasRounded:Number(v.toFixed(2))}),Number(v.toFixed(2))}static calculateTASFromGroundSpeed(e,n,a,r,o){if(isNaN(e)||isNaN(n)||isNaN(a)||isNaN(r))return"N/A";const s=W.convertWind(e,"kt","m/s"),l=W.convertWind(n,"kt","m/s"),c=W.calculateWindAngle(r,a),{crosswind:u,headwind:d}=W.calculateWindComponents(l,c),m=s+d,p=W.calculateTAS(m,o);return Number(p.toFixed(1))}static calculateFlightParameters(e,n,a,r){const o=W.calculateWindAngle(e,n),{crosswind:s,headwind:l}=W.calculateWindComponents(a,o),c=W.calculateWCA(s,r),u=r>Math.abs(s)?Math.sqrt(Math.pow(r,2)-Math.pow(s,2))-l:-l;return{crosswind:Number(s.toFixed(2)),headwind:Number(l.toFixed(2)),wca:Number(c.toFixed(2)),groundSpeed:Number(u.toFixed(2))}}static calculateWindAngle(e,n){let a=W.normalizeAngle(n-e);return a>180&&(a-=360),a}static calculateWindComponents(e,n){const a=n*(Math.PI/180),r=e*Math.sin(a),o=e*Math.cos(a);return{crosswind:r,headwind:o}}static calculateWCA(e,n){const r=Math.abs(Math.asin(e/n))*(180/Math.PI);return isNaN(r)?0:r}static calculateCourseFromHeading(e,n,a,r){const o=W.calculateWindAngle(e,n),{crosswind:s,headwind:l}=W.calculateWindComponents(a,o),c=r*Math.sin(e*Math.PI/180),u=r*Math.cos(e*Math.PI/180),d=(n+180)%360,m=a*Math.sin(d*Math.PI/180),p=a*Math.cos(d*Math.PI/180),h=c+m,v=u+p,b=Math.atan2(h,v)*(180/Math.PI),y=W.normalizeAngle(b),S=Math.sqrt(h*h+v*v),w=W.calculateWCA(s,r)*(s<0?-1:1);return{trueCourse:Number(y.toFixed(2)),groundSpeed:Number(S.toFixed(2)),wca:Number(w.toFixed(2)),crosswind:Number(s.toFixed(2)),headwind:Number(l.toFixed(2))}}static validateLegHeights(e,n,a){const r=parseInt(e.value)||100,o=parseInt(n.value)||200,s=parseInt(a.value)||300;return o<=r?(W.handleError("Base leg must start higher than final leg."),!1):s<=o?(W.handleError("Downwind leg must start higher than base leg."),!1):!0}static convertCoords(e,n,a="Decimal"){if(e===null||n===null||e===void 0||n===void 0)return{lat:"N/A",lng:"N/A"};switch(a){case"DDM":return{lat:W.decimalToDecimalMinutes(e,!0),lng:W.decimalToDecimalMinutes(n,!1)};case"DMS":return{lat:W.decimalToDms(e,!0),lng:W.decimalToDms(n,!1)};case"MGRS":const r=W.decimalToMgrs(e,n);return{lat:r,lng:r};case"Decimal":default:return{lat:e.toFixed(6),lng:n.toFixed(6)}}}static decimalToDecimalMinutes(e,n){if(isNaN(e)||e===null||e===void 0)throw new Error("Invalid coordinate for DDM conversion");const a=Math.abs(e),r=Math.floor(a),o=(a-r)*60,s=n?e>=0?"N":"S":e>=0?"E":"W";return{deg:r,min:o,dir:s}}static decimalToDms(e,n){if(isNaN(e)||e===null||e===void 0)throw console.warn("Invalid decimal value for DMS conversion:",e),new Error("Invalid coordinate for DMS conversion");const a=Math.abs(e),r=Math.floor(a),o=Math.floor((a-r)*60),s=(a-r)*3600-o*60,l=n?e>=0?"N":"S":e>=0?"E":"W";if(isNaN(r)||isNaN(o)||isNaN(s))throw console.warn("DMS calculation resulted in invalid values:",{deg:r,min:o,sec:s}),new Error("Failed to convert to DMS");return{deg:r,min:o,sec:s,dir:l}}static dmsToDecimal(e,n,a,r){if(isNaN(e)||isNaN(n)||isNaN(a)||!r)throw console.warn("Invalid DMS inputs:",{deg:e,min:n,sec:a,dir:r}),new Error("Invalid DMS values");let o=e+n/60+a/3600;if((r==="S"||r==="W")&&(o=-o),isNaN(o))throw console.warn("DMS to decimal conversion failed:",{deg:e,min:n,sec:a,dir:r}),new Error("Failed to convert DMS to decimal");return o}static decimalToMgrs(e,n){try{return ii([n,e])}catch(a){return console.error("Error converting to MGRS:",a),"Invalid MGRS"}}static mgrsToDecimal(e){try{const[n,a]=Ga(e);return{lat:a,lng:n}}catch(n){return console.error("Error converting MGRS to decimal:",n),null}}static calculateNewCenter(e,n,a,r){const o=jl,s=e*Math.PI/180,l=n*Math.PI/180,c=r*Math.PI/180,u=a/o,d=Math.asin(Math.sin(s)*Math.cos(u)+Math.cos(s)*Math.sin(u)*Math.cos(c)),m=l+Math.atan2(Math.sin(c)*Math.sin(u)*Math.cos(s),Math.cos(u)-Math.sin(s)*Math.sin(d)),p=d*180/Math.PI,v=(m*180/Math.PI+540)%360-180;return[p,v]}static calculateBearing(e,n,a,r){const o=m=>m*Math.PI/180,s=m=>m*180/Math.PI,l=o(r-n),c=Math.sin(l)*Math.cos(o(a)),u=Math.cos(o(e))*Math.sin(o(a))-Math.sin(o(e))*Math.cos(o(a))*Math.cos(l);let d=s(Math.atan2(c,u));return d=(d+360)%360,d}static async getLocationData(e,n){const a=`${e.toFixed(4)},${n.toFixed(4)}`;if(W.locationCache.has(a))return W.locationCache.get(a);try{const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${n}&timezone=auto`);if(!r.ok)throw r.status===429&&console.warn("API rate limit hit while fetching location data."),new Error(`Open-Meteo fetch failed: ${r.status}`);const o=await r.json(),s={timezone:o.timezone||"GMT",timezone_abbreviation:o.timezone_abbreviation||"GMT",elevation:o.elevation!==void 0?o.elevation:"N/A"};return W.locationCache.set(a,s),s}catch(r){return console.error("Error fetching location data:",r.message),{timezone:"UTC",elevation:"N/A"}}}static isValidLatLng(e,n){return typeof e=="number"&&typeof n=="number"&&!isNaN(e)&&!isNaN(n)&&e>=-90&&e<=90&&n>=-180&&n<=180&&!(e===0&&n===0)}static async getAltitude(e,n){const{elevation:a}=await W.getLocationData(e,n);return a!=="N/A"?a:"N/A"}static async getMultipleAltitudes(e){if(!e||e.length===0)return[];const n=e.map(r=>r.lat.toFixed(4)).join(","),a=e.map(r=>r.lng.toFixed(4)).join(",");try{const r=await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${n}&longitude=${a}`);if(!r.ok)throw new Error(`Elevation API Error: ${r.status}`);return(await r.json()).elevation||[]}catch(r){return console.error("Error fetching multiple altitudes:",r),e.map(()=>"N/A")}}static formatTime(e){return $.fromISO(e,{zone:"UTC"}).toFormat("yyyy-MM-dd HHmm")+"Z"}static async formatLocalTime(e,n,a){const{timezone:r,timezone_abbreviation:o}=await W.getLocationData(n,a);return $.fromISO(e,{zone:"UTC"}).setZone(r).toFormat("yyyy-MM-dd HHmm")+` ${o}`}static getLastFullHourUTC(){const e=new Date,n=e.getUTCFullYear(),a=e.getUTCMonth(),r=e.getUTCDate(),o=e.getUTCHours(),s=new Date(Date.UTC(n,a,r,o,0,0));return console.log("Last full hour UTC:",s.toISOString()),s}static async getDisplayTime(e,n,a,r="Z"){return r.toLowerCase()==="loc"&&n&&a?await W.formatLocalTime(e,n,a):W.formatTime(e)}static roundToTens(e){const n=Math.round(e/10)*10;return(n===0||n===360)&&(e>=355||e<=4)?360:n}static debounce(e,n){let a;return function(...r){clearTimeout(a),a=setTimeout(()=>e.apply(this,r),n)}}static interpolateColor(e,n=0,a=3e3){const r=Math.min(Math.max((e-n)/(a-n),0),1);return e<0||isNaN(e)?"#808080":r<=.5?`rgb(255, ${Math.round(255*(r*2))}, 0)`:`rgb(${Math.round(255*(1-(r-.5)*2))}, 255, 0)`}static generateWindBarb(e,n,a=null,r="black"){const o=Math.max(0,Math.round(n)),s=40,l=40,c=s/2,u=l/2,d=20,p=(typeof a=="number"&&!isNaN(a)?a>=0:!0)?-1:1;let h=Math.floor(o/50),v=o%50,b=Math.floor(v/10),y=Math.floor(v%10/5);o<3?(y=0,b=0,h=0):o>=3&&o<8&&(y=1,b=0,h=0);let S=`<svg width="${s}" height="${l}" viewBox="0 0 ${s} ${l}" xmlns="http://www.w3.org/2000/svg">`;const w=e+180;S+=`<g transform="translate(${c}, ${u}) rotate(${w})">`;const M=-d/2,E=d/2;S+=`<line x1="0" y1="${M}" x2="0" y2="${E}" stroke="${r}" stroke-width="1.5"/>`;let k=E;const _=10,A=5,T=4;for(let C=0;C<h;C++)S+=`<polygon points="0,${k} 0,${k-T*1.5} ${_*p},${k}" fill="${r}"/>`,k-=T*2;for(let C=0;C<b;C++)S+=`<line x1="0" y1="${k}" x2="${_*p}" y2="${k}" stroke="${r}" stroke-width="1.5"/>`,k-=T;return y>0&&((h>0||b>0)&&(k-=T*.5),S+=`<line x1="0" y1="${k}" x2="${A*p}" y2="${k}" stroke="${r}" stroke-width="1.5"/>`),o<3&&(S+=`<circle cx="0" cy="0" r="3" fill="none" stroke="${r}" stroke-width="1.5"/>`),S+="</g></svg>",S}static calculateDynamicRadius(e=mt.HEATMAP_SCALING_BASE,n=mt.HEATMAP_REFERENCE_ZOOM){const a=i.map.getZoom(),r=mt.HEATMAP_SCALING_BASE,o=Math.pow(r,a-n),s=e*o,l=mt.HEATMAP_MIN_RADIUS_PX,c=mt.HEATMAP_MAX_RADIUS_PX,u=Math.max(l,Math.min(c,s));return console.log("[calculateDynamicRadius] Calculated dynamic radius:",{currentZoom:a,baseRadius:e,scaleFactor:o,dynamicRadius:s,adjustedRadius:u}),u}static getTooltipContent(e,n,a,r){if(!i.map)return console.warn("Map not initialized for getTooltipContent"),"Map not initialized";const o=g.getValue("coordFormat","Decimal"),s=g.getValue("windUnit","kt"),l=g.getValue("heightUnit","m"),c=W.convertCoords(e.lat,e.lng,o);let u;const d=y=>`${y.deg}° ${y.min.toFixed(3)}' ${y.dir}`,m=y=>`${y.deg}°${y.min}'${y.sec.toFixed(0)}" ${y.dir}`;o==="MGRS"?u=`MGRS: ${c.lat}`:o==="DMS"?u=`Lat: ${m(W.decimalToDms(e.lat,!0))}<br>Lng: ${m(W.decimalToDms(e.lng,!1))}`:o==="DDM"?u=`Lat: ${d(W.decimalToDecimalMinutes(e.lat,!0))}<br>Lng: ${d(W.decimalToDecimalMinutes(e.lng,!1))}`:u=`Lat: ${e.lat.toFixed(5)}<br>Lng: ${e.lng.toFixed(5)}`;const p=e.ele;let h=p!==null&&r!==null?p-r:null;if(h!==null){const y=l||"m";h=W.convertHeight(h,y),h=Math.round(h),u+=`<br>Altitude: ${h} ${y} AGL`}else u+="<br>Altitude: N/A";let v="N/A",b="N/A";if(n>0&&e.time&&a[n-1].time&&e.ele!==null&&a[n-1].ele!==null){const y=(e.time.toMillis()-a[n-1].time.toMillis())/1e3;if(y>0){const w=i.map.distance([a[n-1].lat,a[n-1].lng],[e.lat,e.lng])/y;v=W.convertWind(w,s,"m/s"),v=s==="bft"?Math.round(v):v.toFixed(1),b=((e.ele-a[n-1].ele)/y).toFixed(1)}}return u+=`<br>Speed: ${v} ${s}`,u+=`<br>Descent Rate: ${b} m/s`,u}static getConvexHull(e){e.sort((o,s)=>o[0]-s[0]||o[1]-s[1]);const n=(o,s,l)=>(s[0]-o[0])*(l[1]-o[1])-(s[1]-o[1])*(l[0]-o[0]),a=[];for(const o of e){for(;a.length>=2&&n(a[a.length-2],a[a.length-1],o)<=0;)a.pop();a.push(o)}const r=[];for(let o=e.length-1;o>=0;o--){const s=e[o];for(;r.length>=2&&n(r[r.length-2],r[r.length-1],s)<=0;)r.pop();r.push(s)}return a.slice(0,-1).concat(r.slice(0,-1))}};Kn(W,"locationCache",new Map),Kn(W,"debouncedGetElevationAndQFE",W.debounce(async(e,n,a)=>{`${e.toFixed(5)}${n.toFixed(5)}`;try{const r=await W.getAltitude(e,n);a&&a({elevation:r})}catch(r){console.warn("Failed to fetch elevation in debouncedGetElevationAndQFE:",r),a&&a({elevation:"N/A"})}},500));let f=W;const Xl="modulepreload",Ql=function(t){return"/upper_winds_open_meteo/"+t},zr={},Za=function(e,n,a){let r=Promise.resolve();if(n&&n.length>0){let s=function(u){return Promise.all(u.map(d=>Promise.resolve(d).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),c=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));r=s(n.map(u=>{if(u=Ql(u),u in zr)return;zr[u]=!0;const d=u.endsWith(".css"),m=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${m}`))return;const p=document.createElement("link");if(p.rel=d?"stylesheet":Xl,d||(p.as="script"),p.crossOrigin="",p.href=u,c&&p.setAttribute("nonce",c),document.head.appendChild(p),d)return new Promise((h,v)=>{p.addEventListener("load",h),p.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${u}`)))})}))}function o(s){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=s,window.dispatchEvent(l),!l.defaultPrevented)throw s}return r.then(s=>{for(const l of s||[])l.status==="rejected"&&o(l.reason);return e().catch(o)})};function di(t){var a,r;if(!t||!t.time||t.time.length===0)return[];const e=[],n=[1e3,950,925,900,850,800,700,600,500,400,300,250,200];for(let o=0;o<t.time.length;o++){const s=t.temperature_2m[o];let l={low:[],mid:[],high:[]};for(const u of n){const d=(a=t[`temperature_${u}hPa`])==null?void 0:a[o],m=(r=t[`geopotential_height_${u}hPa`])==null?void 0:r[o];d===null||m===null||d===void 0||m===void 0||(s<=0?m<=2e3?l.low.push(u):d>-30?l.mid.push(u):l.high.push(u):d>0?l.low.push(u):d>-30?l.mid.push(u):l.high.push(u))}const c=(u,d,m)=>u.length===0?95:Math.max(...u.map(h=>{var v;return((v=t[`cloud_cover_${h}hPa`])==null?void 0:v[o])||0}))>50?d:m;e.push({low:c(l.low,90,75),mid:c(l.mid,85,70),high:65})}return console.log("[WeatherManager] Cloud layer thresholds analyzed for all timesteps."),e}async function tt(t,e,n=null){console.log("[weatherManager] Starting full weather fetch for location:",{lat:t,lng:e});const a=await tc(t,e);return document.dispatchEvent(new CustomEvent("models:available",{detail:{availableModels:a}})),await ec(t,e,n)}function Se(t,e,n,a,r){if(!t||!t.time||e>=t.time.length)return console.warn("No weather data provided or index out of bounds for interpolation"),[];const o=i.cloudThresholds[e];if(!o&&(console.warn("No pre-analyzed cloud thresholds for this index. Performing on-the-fly analysis."),i.cloudThresholds=di(t),!i.cloudThresholds[e]))return console.error("Cloud threshold analysis failed. Cannot interpolate weather data."),[];const s=Jl,l=s.filter(D=>{var U,G,O;const P=(U=t[`geopotential_height_${D}hPa`])==null?void 0:U[e],F=(G=t[`wind_speed_${D}hPa`])==null?void 0:G[e],N=(O=t[`wind_direction_${D}hPa`])==null?void 0:O[e];return[P,F,N].every(V=>V!=null)}),c=s.filter(D=>{var N,U;const P=(N=t[`geopotential_height_${D}hPa`])==null?void 0:N[e],F=(U=t[`cloud_cover_${D}hPa`])==null?void 0:U[e];return P!=null&&F!=null}),u=c.map(D=>t[`geopotential_height_${D}hPa`][e]),d=c.map(D=>t[`cloud_cover_${D}hPa`][e]);if(l.length<2)return console.warn("Insufficient valid pressure level data for interpolation:",l),[];let m=l.map(D=>t[`geopotential_height_${D}hPa`][e]),p=l.map(D=>t[`temperature_${D}hPa`][e]),h=l.map(D=>t[`relative_humidity_${D}hPa`][e]);l.map(D=>{var P;return(P=t[`cloud_cover_${D}hPa`])==null?void 0:P[e]});let v=l.map(D=>t[`wind_speed_${D}hPa`][e]),b=l.map(D=>t[`wind_direction_${D}hPa`][e]);const y=t.surface_pressure[e];if(y==null)return console.warn("Surface pressure missing"),[];let S=v.map((D,P)=>-D*Math.sin(b[P]*Math.PI/180)),w=v.map((D,P)=>-D*Math.cos(b[P]*Math.PI/180));const M=Math.max(...l),E=t[`geopotential_height_${M}hPa`][e];if(y>M&&Number.isFinite(E)){const D=Math.floor((E-a)/n),P=-t.wind_speed_10m[e]*Math.sin(t.wind_direction_10m[e]*Math.PI/180),F=-t.wind_speed_10m[e]*Math.cos(t.wind_direction_10m[e]*Math.PI/180),N=S[l.indexOf(M)],U=w[l.indexOf(M)];for(let G=D-1;G>=1;G--){const O=a+G*n;if(O>=E)continue;const V=(O-a)/(E-a),z=Math.log(y),Y=Math.log(M),ee=z+V*(Y-z),Q=Math.exp(ee),q=Math.log(O-a+1),se=Math.log(1),he=Math.log(E-a),ve=f.linearInterpolate([se,he],[P,N],q),Le=f.linearInterpolate([se,he],[F,U],q),ce=f.windSpeed(ve,Le),de=f.windDirection(ve,Le);m.unshift(O),l.unshift(Q),p.unshift(f.linearInterpolate([a,E],[t.temperature_2m[e],t[`temperature_${M}hPa`][e]],O)),h.unshift(f.linearInterpolate([a,E],[t.relative_humidity_2m[e],t[`relative_humidity_${M}hPa`][e]],O)),v.unshift(ce),b.unshift(de),S.unshift(ve),w.unshift(Le)}m.unshift(a),l.unshift(y),p.unshift(t.temperature_2m[e]),h.unshift(t.relative_humidity_2m[e]),v.unshift(t.wind_speed_10m[e]),b.unshift(t.wind_direction_10m[e]),S.unshift(P),w.unshift(F)}const k=l.indexOf(Math.min(...l)),_=m[k],A=_-a;if(A<=0||isNaN(A))return console.warn("Invalid max height at lowest pressure level:",{maxHeightASL:_,baseHeight:a,minPressure:l[k]}),[];const T=r==="ft"?A*3.28084:A,C=Math.floor(T/n),I=Array.from({length:C+1},(D,P)=>P*n),R=[];return I.forEach(D=>{var G;const P=r==="ft"?D/3.28084:D,F=a+P;let N,U=0;if(u.length>0){let O=0,V=1/0;u.forEach((z,Y)=>{const ee=Math.abs(F-z);ee<V&&(V=ee,O=Y)}),U=d[O]}if(P===0){const O=Math.max(...l),V=((G=t[`cloud_cover_${O}hPa`])==null?void 0:G[e])??"N/A";N={height:F,pressure:y,temp:t.temperature_2m[e],rh:t.relative_humidity_2m[e],cc:V,spd:t.wind_speed_10m[e],dir:t.wind_direction_10m[e],dew:f.calculateDewpoint(t.temperature_2m[e],t.relative_humidity_2m[e])}}else{const O=f.interpolatePressure(F,l,m),V=f.interpolateWindAtAltitude(F,l,m,S,w),z=f.windSpeed(V.u,V.v),Y=f.windDirection(V.u,V.v),ee=f.linearInterpolate(m,p,F),Q=f.linearInterpolate(m,h,F),q=f.calculateDewpoint(ee,Q);N={height:F,pressure:Number.isFinite(O)?Number(O.toFixed(1)):"N/A",temp:Number.isFinite(ee)?Number(ee.toFixed(1)):"N/A",rh:Number.isFinite(Q)?Number(Q.toFixed(0)):"N/A",cc:Number.isFinite(U)?Number(U.toFixed(0)):"N/A",spd:Number.isFinite(z)?Number(z.toFixed(1)):"N/A",dir:Number.isFinite(Y)?Number(Y.toFixed(0)):"N/A",dew:Number.isFinite(q)?Number(q.toFixed(1)):"N/A"}}if(Number.isFinite(N.temp)&&Number.isFinite(N.rh)){const O=N.temp,V=N.rh;let z;t.temperature_2m[e]<=0?P<=2e3?z=o.low:O>-30?z=o.mid:z=o.high:O>0?z=o.low:O>-30?z=o.mid:z=o.high,V<z&&(N.cc=0)}N.displayHeight=D,R.push(N)}),console.log(`[DEBUG] interpolateWeatherData finished. baseHeight: ${a}, Returning ${R.length} data points. First point:`,R[0]),R}async function ec(t,e,n=null){var a,r;document.dispatchEvent(new CustomEvent("loading:start",{detail:{message:"Fetching Weather..."}}));try{const o=((a=document.getElementById("modelSelect"))==null?void 0:a.value)||g.defaultSettings.model;if(!o)throw new Error("No weather model selected.");const l=ui.API_MAP[o]||o;let c=!1,u,d;const m=$.utc().startOf("day");let p=null;if(n){let w=$.fromISO(n,{zone:"utc"});w.isValid&&(p=w.startOf("day"),p<m&&(c=!0))}else{const w=(r=document.getElementById("historicalDatePicker"))==null?void 0:r.value;if(w){let M=$.fromISO(w,{zone:"utc"}).startOf("day");M<m&&(c=!0,p=M)}}let h=ln.FORECAST;if(c&&p)h=ln.HISTORICAL,u=d=p.toFormat("yyyy-MM-dd"),i.lastModelRun="N/A (Historical Data)";else{let w;try{const A=`https://api.open-meteo.com/data/${l}/static/meta.json`,C=await(await fetch(A)).json();w=new Date(C.last_run_initialisation_time*1e3),i.lastModelRun=w.toISOString().replace("T"," ").substring(0,16)+"Z"}catch{w=$.utc().toJSDate(),i.lastModelRun="N/A"}let M=$.fromJSDate(w).setZone("utc").plus({hours:6});M>$.utc()&&(M=$.utc()),u=M.toFormat("yyyy-MM-dd");const E=o.includes("_d2")?2:7,k=g.getValue("maxForecastTime","Maximum");let _=E;if(k!=="Maximum"){const A=parseInt(k,10);A>E&&f.handleMessage(`The selected model '${o}' only provides a ${E}-day forecast. Displaying maximum available time.`),_=Math.min(E,A)}d=M.plus({days:_-1}).toFormat("yyyy-MM-dd")}const b=`${h}?latitude=${t}&longitude=${e}&hourly=surface_pressure,temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m,wind_gusts_10m,visibility,weather_code,cloud_cover_low,cloud_cover_mid,cloud_cover_high,temperature_1000hPa,relative_humidity_1000hPa,wind_speed_1000hPa,wind_direction_1000hPa,geopotential_height_1000hPa,cloud_cover_1000hPa,temperature_950hPa,relative_humidity_950hPa,wind_speed_950hPa,wind_direction_950hPa,geopotential_height_950hPa,cloud_cover_950hPa,temperature_925hPa,relative_humidity_925hPa,wind_speed_925hPa,wind_direction_925hPa,geopotential_height_925hPa,cloud_cover_925hPa,temperature_900hPa,relative_humidity_900hPa,wind_speed_900hPa,wind_direction_900hPa,geopotential_height_900hPa,cloud_cover_900hPa,temperature_850hPa,relative_humidity_850hPa,wind_speed_850hPa,wind_direction_850hPa,geopotential_height_850hPa,cloud_cover_850hPa,temperature_800hPa,relative_humidity_800hPa,wind_speed_800hPa,wind_direction_800hPa,geopotential_height_800hPa,cloud_cover_800hPa,temperature_700hPa,relative_humidity_700hPa,wind_speed_700hPa,wind_direction_700hPa,geopotential_height_700hPa,cloud_cover_700hPa,temperature_600hPa,relative_humidity_600hPa,wind_speed_600hPa,wind_direction_600hPa,geopotential_height_600hPa,cloud_cover_600hPa,temperature_500hPa,relative_humidity_500hPa,wind_speed_500hPa,wind_direction_500hPa,geopotential_height_500hPa,cloud_cover_500hPa,temperature_400hPa,relative_humidity_400hPa,wind_speed_400hPa,wind_direction_400hPa,geopotential_height_400hPa,cloud_cover_400hPa,temperature_300hPa,relative_humidity_300hPa,wind_speed_300hPa,wind_direction_300hPa,geopotential_height_300hPa,cloud_cover_300hPa,temperature_250hPa,relative_humidity_250hPa,wind_speed_250hPa,wind_direction_250hPa,geopotential_height_250hPa,cloud_cover_250hPa,temperature_200hPa,relative_humidity_200hPa,wind_speed_200hPa,wind_direction_200hPa,geopotential_height_200hPa,cloud_cover_200hPa&models=${o}&start_date=${u}&end_date=${d}`,y=await fetch(b);if(!y.ok)throw y.status===429?new Error("API-Limit reached. Please wait a moment and retry again."):new Error(`HTTP error! Status: ${y.status}`);const S=await y.json();if(!S.hourly||!S.hourly.time||!S.hourly.time.length)throw new Error("No hourly data in API response.");return S.hourly}catch(o){return console.error("[fetchWeather] Error:",o),f.handleError(`Failed to fetch weather: ${o.message}`),null}finally{document.dispatchEvent(new CustomEvent("loading:stop"))}}async function tc(t,e){const n=ui.LIST;let a=[];for(const r of n)try{const o=await fetch(`${ln.FORECAST}?latitude=${t}&longitude=${e}&hourly=temperature_2m&models=${r}`);if(o.ok){const s=await o.json();s.hourly&&s.hourly.temperature_2m&&s.hourly.temperature_2m.some(l=>l!==null)&&a.push(r)}else o.status===429?console.warn(`API-Limit beim Prüfen von Modell '${r}' erreicht.`):console.warn(`Modell '${r}' ist nicht verfügbar (Server-Antwort: ${o.status})`)}catch(o){console.error(`Netzwerkfehler beim Abruf von Modell '${r}':`,o)}return a}f.debounce(async(t,e)=>{try{const n=await f.getElevationAndQFE(t,e,i.apiKey);if(n){const a=document.getElementById("elevation"),r=document.getElementById("qfe");a&&(a.value=n.elevation.toFixed(1)),r&&(r.value=n.qfe.toFixed(2)),i.currentElevation=n.elevation,g.state.userSettings.qfe=n.qfe}}catch(n){console.error("Error fetching elevation and QFE:",n)}},500);function ja(t){const e=g.state.userSettings.alerts.wind,n=g.state.userSettings.alerts.gust,a=g.state.userSettings.alerts.thunderstorm,r=g.state.userSettings.alerts.clouds;if(console.log("[checkWeatherAlerts] Current Alert Settings:",{windConfig:e,gustConfig:n,thunderstormConfig:a,cloudsConfig:r}),!t||!t.time)return console.log("[checkWeatherAlerts] No weather data or time array found."),{highWinds:[],highGusts:[],thunderstorms:[],cloudAlerts:[]};const o=[],s=[],l=[],c=[],u={FEW:1,SCT:2,BKN:3,OVC:4},d=u[r.cover]||3,m=p=>p==null||isNaN(p)||p<=5?null:p<=25?"FEW":p<=50?"SCT":p<=87?"BKN":"OVC";console.log(`[checkWeatherAlerts] Checking ${t.time.length} time steps...`);for(let p=0;p<t.time.length;p++){const h=t.time[p],v=t.wind_speed_10m[p],b=t.wind_gusts_10m[p],y=t.weather_code[p];if(e.enabled&&v!==null&&!isNaN(v)){const S=f.convertWind(v,"kt","km/h");S>e.threshold&&(o.push(p),console.log(`[checkWeatherAlerts] Wind Alert triggered at index ${p} (${h}): Speed ${S.toFixed(1)} kt > Threshold ${e.threshold} kt`))}if(n.enabled&&b!==null&&!isNaN(b)){const S=f.convertWind(b,"kt","km/h");S>n.threshold&&(s.push(p),console.log(`[checkWeatherAlerts] Gust Alert triggered at index ${p} (${h}): Gust ${S.toFixed(1)} kt > Threshold ${n.threshold} kt`))}if(a.enabled&&y!==null&&!isNaN(y)&&Zl.includes(y)&&(l.push(p),console.log(`[checkWeatherAlerts] Thunderstorm Alert triggered at index ${p} (${h}): Code ${y}`)),r.enabled){const S=Se(t,p,500,Math.round(i.lastAltitude),"m");let w=!1;for(const M of S){const E=m(M.cc);if(!E)continue;const k=u[E],_=M.displayHeight;k>=d&&_<r.base&&(w||(c.push(p),console.log(`[checkWeatherAlerts] Cloud Alert triggered at index ${p} (${h}): Layer ${E} at ${_}m < Threshold ${r.base}m (Min Cover: ${r.cover})`),w=!0))}}}return console.log("[checkWeatherAlerts] Finished check. Results:",{highWinds:o,highGusts:s,thunderstorms:l,cloudAlerts:c}),{highWinds:o,highGusts:s,thunderstorms:l,cloudAlerts:c}}function mi(t){const e=g.state.userSettings.exitAltitude*fe.METERS_TO_FEET,n=f.calculateTAS(t,e);if(n==="N/A"||!Number.isFinite(n)||n<=0)return console.warn("TAS calculation failed or invalid, using default separation"),g.defaultSettings.jumperSeparation;const a=Object.keys(Wr).map(Number).sort((s,l)=>l-s);let r=a[0];for(const s of a)if(n<=s)r=s;else break;return Wr[r]||7}function Ja(t,e=null){var F,N;const n=e?e.lat:i.lastLat,a=e?e.lng:i.lastLng;if(!i.weatherData||n==null||a==null||i.lastAltitude==="N/A"||!t||!t.length)return null;const r=parseInt((F=document.getElementById("openingAltitude"))==null?void 0:F.value)||1e3,o=Math.round(i.lastAltitude),s=t.map(U=>U.height),l=t.map(U=>-f.convertWind(U.spd,"m/s","km/h")*Math.sin(U.dir*Math.PI/180)),c=t.map(U=>-f.convertWind(U.spd,"m/s","km/h")*Math.cos(U.dir*Math.PI/180)),u=f.calculateMeanWind(s,l,c,o,o+r);if(!u)return null;let d=Math.round(u[0]);const m=parseFloat(g.state.userSettings.customJumpRunDirection);Number.isFinite(m)&&m>=0&&m<=360&&(d=m);const p=parseInt((N=document.getElementById("exitAltitude"))==null?void 0:N.value)||3e3,h=o+p,v=g.state.userSettings.aircraftSpeedKt||90,b=f.calculateTAS(v,h/.3048);let y=v*fe.KNOTS_TO_MPS;if(b!=="N/A"&&Number.isFinite(b)){const U=f.linearInterpolate(s.map(se=>se-o),t.map(se=>se.dir),p),G=f.linearInterpolate(s.map(se=>se-o),t.map(se=>f.convertWind(se.spd,"m/s","km/h")),p),O=b*fe.KNOTS_TO_MPS,V=(U+180)*Math.PI/180,z=G*Math.sin(V),Y=G*Math.cos(V),ee=d*Math.PI/180,Q=O*Math.sin(ee),q=O*Math.cos(ee);y=Math.sqrt(Math.pow(Q+z,2)+Math.pow(q+Y,2))}const S=Math.max(Dt.MIN_TRACK_LENGTH_M,Math.min(Dt.MAX_TRACK_LENGTH_M,Math.round((g.state.userSettings.numberOfJumpers||10)*(g.state.userSettings.jumperSeparation||5)*y))),w=Math.max(Dt.MIN_APPROACH_LENGTH_M,Math.min(Dt.MAX_APPROACH_LENGTH_M,Math.round(y*Dt.APPROACH_TIME_SECONDS))),M=g.state.userSettings.jumpRunTrackOffset||0,E=g.state.userSettings.jumpRunTrackForwardOffset||0,k=[n,a],_=f.calculateNewCenter(k[0],k[1],S,d),A=Math.sqrt(M**2+E**2),T=Math.atan2(M,E)*180/Math.PI,C=(d+T+360)%360,I=f.calculateNewCenter(k[0],k[1],A,C),R=f.calculateNewCenter(_[0],_[1],A,C),D=f.calculateNewCenter(I[0],I[1],w,(d+180)%360),P=[I,D];return{direction:d,trackLength:S,meanWindDirection:u[0],meanWindSpeed:u[1],latlngs:[I,R],approachLatLngs:P,approachLength:w,approachTime:Dt.APPROACH_TIME_SECONDS}}function hi(t){var N,U,G,O,V;if(console.log("Debug calculateExitCircle: Start",{showExitArea:g.state.userSettings.showExitArea,calculateJump:g.state.userSettings.calculateJump,weatherData:!!i.weatherData,lastLat:i.lastLat,lastLng:i.lastLng,lastAltitude:i.lastAltitude,interpolatedData:!!t&&t.length>0}),!g.state.userSettings.showExitArea||!g.state.userSettings.calculateJump||!i.weatherData||i.lastLat==null||i.lastLng==null)return console.log("Debug calculateExitCircle: Frühe Rückgabe wegen Einstellungen"),null;if(!t||t.length===0)return console.log("Debug calculateExitCircle: Frühe Rückgabe wegen interpolatedData"),null;const e=parseInt((N=document.getElementById("exitAltitude"))==null?void 0:N.value)||3e3,n=parseInt((U=document.getElementById("openingAltitude"))==null?void 0:U.value)||1200,a=parseInt((G=document.getElementById("legHeightDownwind"))==null?void 0:G.value)||300,r=parseFloat((O=document.getElementById("descentRate"))==null?void 0:O.value)||3.5,o=parseFloat((V=document.getElementById("canopySpeed"))==null?void 0:V.value)||20,s=o*fe.KNOTS_TO_MPS,l=g.state.userSettings.safetyHeight||0;console.log("Debug calculateExitCircle: Eingabewerte",{exitAltitude:e,openingAltitude:n,legHeightDownwind:a,descentRate:r,canopySpeedKt:o,safetyHeight:l});const c=l/r*s,u=t.map(z=>z.height),d=t.map(z=>-f.convertWind(z.spd,"m/s","km/h")*Math.sin(z.dir*Math.PI/180)),m=t.map(z=>-f.convertWind(z.spd,"m/s","km/h")*Math.cos(z.dir*Math.PI/180)),p=Math.round(i.lastAltitude),h=(n-at-a)/r,v=h*s,b=(n-at)/r,y=b*s;console.log("Debug calculateExitCircle: Berechnungen",{flyTime:h,horizontalCanopyDistance:v,flyTimeFull:b,horizontalCanopyDistanceFull:y,reductionDistance:c});const S=f.calculateMeanWind(u,d,m,p+l+a,p+n-at),w=f.calculateMeanWind(u,d,m,p+l,p+n-at);console.log("Debug calculateExitCircle: meanWind",S),console.log("Debug calculateExitCircle: meanWindFull",w),console.log("Debug calculateExitCircle: Vor calculateLandingPatternCoords");const M=Zn(i.lastLat,i.lastLng,t);console.log("Debug calculateExitCircle: Nach calculateLandingPatternCoords",M);let[E,k]=M.downwindStart;Number.isFinite(E)||(console.log("Debug calculateExitCircle: Fallback zu lastLat/lastLng"),E=i.lastLat,k=i.lastLng);const _=f.calculateNewCenter(E,k,S[1]*h,S[0]),A=f.calculateNewCenter(i.lastLat,i.lastLng,w[1]*b,w[0]);console.log("Debug calculateExitCircle: newCenterBlue",_),console.log("Debug calculateExitCircle: newCenterRed",A),console.log("Debug calculateExitCircle: Vor calculateFreeFall");const T=Ja(t),C=T?T.direction:0,I=ac(i.weatherData,e,n,t,i.lastLat,i.lastLng,p,C);if(console.log("Debug calculateExitCircle: Nach calculateFreeFall",I),!I)return console.log("Debug calculateExitCircle: Rückgabe null wegen freeFall"),null;const R=(I.directionDeg+180)%360,D=f.calculateNewCenter(A[0],A[1],I.distance,R),P=f.calculateNewCenter(_[0],_[1],I.distance,R);console.log(`[calculateExitCircle] freeFallResult: distance=${I.distance.toFixed(2)} m, directionDeg=${I.directionDeg.toFixed(1)}°`),console.log(`[calculateExitCircle] meanWind: dir=${S[0].toFixed(1)}°, speed=${S[1].toFixed(2)} m/s`),console.log(`[calculateExitCircle] greenCenterFull: lat=${D[0]}, lng=${D[1]}`),console.log(`[calculateExitCircle] greenCenter: lat=${P[0]}, lng=${P[1]}`),console.log("[calculateExitCircle] expected downwindStart: lat=52.51657818951595, lng=13.413705547188442");const F={greenLatFull:D[0],greenLngFull:D[1],greenLat:P[0],greenLng:P[1],greenRadius:Math.max(0,y-c),darkGreenRadius:Math.max(0,v-c),freeFallDirection:I.directionDeg,freeFallDistance:I.distance,freeFallTime:I.time};return console.log("Debug calculateExitCircle: Ergebnis",F),F}function gi(t){var P,F,N,U,G;if(!g.state.userSettings.showCanopyArea||!g.state.userSettings.calculateJump||!i.weatherData||i.lastLat==null||i.lastLng==null||!t||t.length===0)return null;parseInt((P=document.getElementById("exitAltitude"))==null?void 0:P.value);const e=parseInt((F=document.getElementById("openingAltitude"))==null?void 0:F.value)||1200,n=parseInt((N=document.getElementById("legHeightDownwind"))==null?void 0:N.value)||300,a=parseFloat((U=document.getElementById("descentRate"))==null?void 0:U.value)||3.5,r=(parseFloat((G=document.getElementById("canopySpeed"))==null?void 0:G.value)||20)*fe.KNOTS_TO_MPS,o=g.state.userSettings.safetyHeight||0,s=o/a*r,l=t.map(O=>O.height),c=t.map(O=>-f.convertWind(O.spd,"m/s","km/h")*Math.sin(O.dir*Math.PI/180)),u=t.map(O=>-f.convertWind(O.spd,"m/s","km/h")*Math.cos(O.dir*Math.PI/180)),d=Math.round(i.lastAltitude),m=(e-at-n)/a,p=m*r,h=(e-at)/a,v=h*r,b=f.calculateMeanWind(l,c,u,d+n,d+o+e-at),y=f.calculateMeanWind(l,c,u,d+o,d+e-at),S=Zn(i.lastLat,i.lastLng,t);let[w,M]=S.downwindStart;Number.isFinite(w)||(w=i.lastLat,M=i.lastLng);const E=d+e-at,k=d+n,_=[],A=[],T=[],C=[];let I=E-k<=1e3?200:500;for(let O=E;O>=k+200;O-=I){const V=(O-k)/a,z=V*r;if(z>0){const Y=f.calculateMeanWind(l,c,u,k,O);_.push(Math.max(0,z-s)),A.push(Y[1]*V),T.push(Y[0]),C.push(O-d)}}console.log("[calculateCanopyCircles] Debug meanWind:",b),console.log("[calculateCanopyCircles] Debug flyTime:",m),console.log("[calculateCanopyCircles] Debug meanWindFull:",y),console.log("[calculateCanopyCircles] Debug flyTimeFull:",h);const R=f.calculateNewCenter(i.lastLat,i.lastLng,y[1]*h,y[0]);console.log("[calculateCanopyCircles] Tatsächlicher Mittelpunkt roter Kreis:",{lat:R[0].toFixed(3),lng:R[1].toFixed(3)});const D=f.calculateNewCenter(w,M,b[1]*m,b[0]);return console.log("[calculateCanopyCircles] Tatsächlicher Mittelpunkt blauer Kreis:",{lat:D[0].toFixed(3),lng:D[1].toFixed(3)}),{blueLat:w,blueLng:M,redLat:i.lastLat,redLng:i.lastLng,radius:Math.max(0,p-s),radiusFull:Math.max(0,v-s),additionalBlueRadii:_,additionalBlueDisplacements:A,additionalBlueDirections:T,additionalBlueUpperLimits:C,displacement:b[1]*m,direction:b[0],displacementFull:y[1]*h,directionFull:y[0],meanWindForFullCanopyDir:y[0],meanWindForFullCanopySpeedMps:y[1]}}function Zn(t,e,n){var We,qt;if(!n||n.length===0||i.lastAltitude==="N/A")return null;const a=parseInt(document.getElementById("canopySpeed").value)||20,r=parseFloat(document.getElementById("descentRate").value)||3.5,o=parseInt(document.getElementById("legHeightFinal").value)||100,s=parseInt(document.getElementById("legHeightBase").value)||200,l=parseInt(document.getElementById("legHeightDownwind").value)||300,c=Math.round(i.lastAltitude),u=n.map(Ce=>Ce.height),d=n.map(Ce=>-f.convertWind(Ce.spd,"kt","km/h")*Math.sin(Ce.dir*Math.PI/180)),m=n.map(Ce=>-f.convertWind(Ce.spd,"kt","km/h")*Math.cos(Ce.dir*Math.PI/180)),p=((We=document.querySelector('input[name="landingDirection"]:checked'))==null?void 0:We.value)||"LL",h=document.getElementById(p==="LL"?"customLandingDirectionLL":"customLandingDirectionRR"),v=h?parseInt(h.value,10):NaN;let b=Number.isFinite(v)?v:Number.isFinite(i.landingWindDir)?i.landingWindDir:(qt=n[0])==null?void 0:qt.dir;if(!Number.isFinite(b))return null;const y=(Ce,Ie,De,qn,ge)=>{const He=qn*.5144444444444445*ge;return f.calculateNewCenter(Ce,Ie,He,De)},S=f.calculateMeanWind(u,d,m,c===0?1:c,c+o),w=S[0],M=S[1],E=b,k=f.calculateWindAngle(E,w),{crosswind:_,headwind:A}=f.calculateWindComponents(M,k),T=f.calculateWCA(_,a)*(_>=0?1:-1),{groundSpeed:C}=f.calculateFlightParameters(E,w,M,a),I=o/r,R=C*(1.852/3.6)*I,D=y(t,e,(E+180)%360,C,I),P=f.calculateMeanWind(u,d,m,c+o,c+s),F=P[0],N=P[1],U=(b+(p==="LL"?90:-90)+360)%360,{trueCourse:G,groundSpeed:O}=f.calculateCourseFromHeading(U,F,N,a),V=f.calculateWindAngle(G,F),{crosswind:z,headwind:Y}=f.calculateWindComponents(N,V),ee=f.calculateWCA(z,a)*(z>=0?1:-1);let Q=(G+180)%360;O<0&&(Q=(Q+180)%360);const q=(s-o)/r,se=O*(1.852/3.6)*q,he=y(D[0],D[1],Q,O,q),ve=f.calculateMeanWind(u,d,m,c+s,c+l),Le=ve[0],ce=ve[1],de=(b+180)%360,Ae=f.calculateWindAngle(de,Le),{crosswind:st,headwind:j}=f.calculateWindComponents(ce,Ae),X=f.calculateWCA(st,a)*(st>=0?1:-1),{groundSpeed:ie}=f.calculateFlightParameters(de,Le,ce,a),B=(l-s)/r,te=ie*(1.852/3.6)*B,ne=y(he[0],he[1],(de+180)%360,ie,B);return console.log(`[Pattern] Landing Pattern Updated:
        Final Leg: Wind: ${w.toFixed(1)}° @ ${M.toFixed(1)}kt, Course: ${E.toFixed(1)}°, WCA: ${T.toFixed(1)}°, GS: ${C.toFixed(1)}kt, HW: ${A.toFixed(1)}kt, Length: ${R.toFixed(1)}m
        Base Leg: Wind: ${F.toFixed(1)}° @ ${N.toFixed(1)}kt, Course: ${G.toFixed(1)}°, WCA: ${ee.toFixed(1)}°, GS: ${O.toFixed(1)}kt, HW: ${Y.toFixed(1)}kt, Length: ${se.toFixed(1)}m
        Downwind Leg: Wind: ${Le.toFixed(1)}° @ ${ce.toFixed(1)}kt, Course: ${de.toFixed(1)}°, WCA: ${X.toFixed(1)}°, GS: ${ie.toFixed(1)}kt, HW: ${j.toFixed(1)}kt, Length: ${te.toFixed(1)}m`),console.log("[Pattern] Coordinates DIP: ",t,e,"Altitude DIP:",c),console.log("[Pattern] Coordinates final end: ",D[0],D[1],"Leg Height:",c+o),console.log("[Pattern] Coordinates base end: ",he[0],he[1],"Leg Height:",c+s),console.log("[Pattern] Coordinates downwind end: ",ne[0],ne[1],"Leg Height:",c+l),{downwindStart:ne,baseStart:he,finalStart:D,landingPoint:[t,e]}}function qa(t){if(!i.map||i.cutAwayLat===null||i.cutAwayLng===null||!i.weatherData||i.lastAltitude==="N/A"||!t||t.length===0)return null;const e=Math.round(i.lastAltitude),n=g.state.userSettings.cutAwayAltitude,a=e,r=e+n,o=t.map(E=>E.height),s=t.map(E=>-f.convertWind(E.spd,"m/s","km/h")*Math.sin(E.dir*Math.PI/180)),l=t.map(E=>-f.convertWind(E.spd,"m/s","km/h")*Math.cos(E.dir*Math.PI/180)),c=f.calculateMeanWind(o,s,l,a,r);if(!c)return null;const[u,d]=c,m={Open:sa.OPEN,Partially:sa.PARTIALLY,Collapsed:sa.COLLAPSED},p=m[g.state.userSettings.cutAwayState]||m.Partially,h=n/p,v=d*h,b=(u+180)%360,[y,S]=f.calculateNewCenter(i.cutAwayLat,i.cutAwayLng,v,b),M=`<b>Cut-Away (${g.state.userSettings.cutAwayState.replace(/([A-Z])/g," $1").trim()})</b><br>Cut-Away Altitude: ${n} m<br>Displacement: ${u.toFixed(0)}°, ${v.toFixed(0)} m<br>Descent Time/Speed: ${h.toFixed(0)} s at ${p.toFixed(1)} m/s<br>`;return{center:[y,S],radius:Vl,tooltipContent:M}}async function nc(){var k,_,A,T;const t=parseInt((k=document.getElementById("timeSlider"))==null?void 0:k.value)||0,e=g.getValue("interpStep","select",200),n=g.getValue("heightUnit","m"),a=Se(i.weatherData,t,e,Math.round(i.lastAltitude),n);parseInt((_=document.getElementById("legHeightDownwind"))==null?void 0:_.value);const r=parseFloat((A=document.getElementById("descentRate"))==null?void 0:A.value)||3.5,o=(parseFloat((T=document.getElementById("canopySpeed"))==null?void 0:T.value)||20)*fe.KNOTS_TO_MPS,s=i.lastAltitude,l=gi(a);if(!l||l.additionalBlueRadii.length===0)throw new Error("Could not calculate the smallest canopy circle for analysis.");const c=l.additionalBlueRadii.length-1,u=l.additionalBlueRadii[c],d=l.blueLat,m=l.blueLng,p=l.additionalBlueDisplacements[c],h=l.additionalBlueDirections[c],v=f.calculateNewCenter(d,m,p,h),b=l.additionalBlueUpperLimits[c],y=L.latLng(d,m);console.log(`--- TERRAIN ANALYSIS STARTED ---
    - Analyzing Circle Center: ${v[0].toFixed(4)}, ${v[1].toFixed(4)}
    - Circle Radius: ${u.toFixed(0)}m
    - Skydiver Entry Altitude: ${b.toFixed(0)}m AGL (${(s+b).toFixed(0)}m MSL)
    -----------------------------`);const S=`${v[0].toFixed(4)}_${v[1].toFixed(4)}_${u.toFixed(0)}`;let w=[];if(i.terrainAnalysisCache&&i.terrainAnalysisCache.key===S)console.log("Using cached terrain elevation data."),f.handleMessage("Using cached terrain data for instant analysis."),w=i.terrainAnalysisCache.data;else{const I=[],R=L.latLng(v);for(let P=-u;P<=u;P+=75)for(let F=-u;F<=u;F+=75)if(P*P+F*F<=u*u){const N=R.lat+P/111320,U=R.lng+F/(111320*Math.cos(R.lat*Math.PI/180));I.push(L.latLng(N,U))}if(I.length===0)return[];const D=100;for(let P=0;P<I.length;P+=D){const F=I.slice(P,P+D);f.handleMessage(`Analyzing terrain... (${P+F.length}/${I.length})`);const N=await f.getMultipleAltitudes(F);for(let U=0;U<F.length;U++){const G=F[U],O=N[U];w.push({...G,groundEle:O!=="N/A"?O:null})}}i.terrainAnalysisCache={key:S,data:w},console.log("Terrain elevation data has been cached.")}const M=[],E=g.getValue("terrainClearance",100);for(const C of w){const I=C.groundEle;if(I===null)continue;const P=i.map.distance(y,C)/o*r,F=s+b-P,N=F-I;console.log(`[Point Analysis] Lat: ${C.lat.toFixed(4)}, Lng: ${C.lng.toFixed(4)}
            - Ground MSL: ${I.toFixed(0)}m
            - Skydiver MSL (estimated): ${F.toFixed(0)}m
            - CLEARANCE: ${N.toFixed(0)}m`),N<E&&M.push(C)}return console.log(`--- TERRAIN ANALYSIS FINISHED ---
    - Points Analyzed: ${w.length}
    - Dangerous Points Found: ${M.length}
    --------------------------------`),M}function ac(t,e,n,a,r,o,s,l){if(!t||!a||a.length===0)return f.handleError("calculateFreeFall: Wetterdaten fehlen."),null;if(!f.isValidLatLng(r,o)||!Number.isFinite(s))return f.handleError("calculateFreeFall: Ungültige Startkoordinaten oder Geländehöhe."),null;if(e<=n)return f.handleError("calculateFreeFall: Exit-Höhe muss über der Öffnungshöhe liegen."),null;console.log("--- calculateFreeFall: Berechnung gestartet ---");const{TERMINAL_VELOCITY_VERTICAL_MPS:c,GRAVITY_ACCELERATION:u,HORIZONTAL_DRAG_TAU_SECONDS:d}=zl,m=g.state.userSettings.aircraftSpeedKt,p=e/fe.FEET_TO_METERS,h=f.calculateTAS(m,p);let v=m*fe.KNOTS_TO_MPS;if(Number.isFinite(h)){const q=a.map(X=>X.height-s),se=f.linearInterpolate(q,a.map(X=>X.dir),e),he=f.linearInterpolate(q,a.map(X=>f.convertWind(X.spd,"m/s","km/h")),e),ve=h*fe.KNOTS_TO_MPS,Le=(se+180)*Math.PI/180,ce=he*Math.sin(Le),de=he*Math.cos(Le),Ae=l*Math.PI/180,st=ve*Math.sin(Ae),j=ve*Math.cos(Ae);v=Math.sqrt((st+ce)**2+(j+de)**2)}console.log(`[Freifall-Input] JRT-Richtung: ${l}°, TAS: ${h} kt, Berechnete Ground Speed: ${v.toFixed(1)} m/s`);const b=e-n,y=c/u,S=.5*u*y**2,M=(b>S?b-S:0)/c,E=y+M,k=v*d,_=l,A=a.map(q=>-f.convertWind(q.spd,"m/s","km/h")*Math.sin(q.dir*Math.PI/180)),T=a.map(q=>-f.convertWind(q.spd,"m/s","km/h")*Math.cos(q.dir*Math.PI/180)),C=f.calculateMeanWind(a.map(q=>q.height),A,T,s+n,s+e);if(!C)return f.handleError("calculateFreeFall: Konnte mittleren Wind nicht berechnen."),null;const[I,R]=C;console.log(`[Freifall-Input] Mittelwind: ${I.toFixed(0)}° @ ${(R*3.6/1.852).toFixed(1)} kt`);const D=(I+180)%360,P=R*E;console.log(`[Freifall-Ergebnis] Wurf: ${_.toFixed(0)}°, Distanz: ${k.toFixed(0)} m`),console.log(`[Freifall-Ergebnis] Abdrift: ${D.toFixed(0)}°, Distanz: ${P.toFixed(0)} m`);const F=k*Math.cos(_*Math.PI/180),N=k*Math.sin(_*Math.PI/180),U=P*Math.cos(D*Math.PI/180),G=P*Math.sin(D*Math.PI/180),O=F+U,V=N+G,z=Math.sqrt(O**2+V**2),Y=(Math.atan2(V,O)*180/Math.PI+360)%360,ee=f.calculateNewCenter(r,o,z,Y),Q=[{latLng:{lat:r,lng:o},height:s+e,time:0},{latLng:{lat:ee[0],lng:ee[1]},height:s+n,time:E}];return console.log(`[Freifall-Ergebnis] Zeit: ${E.toFixed(1)} s, Distanz: ${z.toFixed(0)} m, Richtung: ${Y.toFixed(1)}°`),console.log("--- calculateFreeFall: Berechnung beendet ---"),{time:E,distance:z,directionDeg:Y,path:Q}}async function Ka(){if(i.lastLat==null||i.lastLng==null)return f.handleMessage("Please select a location first."),!1;if(!g.state.userSettings.selectedEnsembleModels||g.state.userSettings.selectedEnsembleModels.length===0)return i.ensembleModelsData=null,gn(),!0;const t=document.getElementById("loading");t&&(t.style.display="block");try{const e=i.lastLat,n=i.lastLng,a=g.state.userSettings.selectedEnsembleModels,r=a.join(","),o=["surface_pressure","temperature_2m","relative_humidity_2m","wind_speed_10m","wind_direction_10m","geopotential_height_1000hPa","temperature_1000hPa","relative_humidity_1000hPa","wind_speed_1000hPa","wind_direction_1000hPa","cloud_cover_1000hPa","geopotential_height_950hPa","temperature_950hPa","relative_humidity_950hPa","wind_speed_950hPa","wind_direction_950hPa","cloud_cover_950hPa","geopotential_height_925hPa","temperature_925hPa","relative_humidity_925hPa","wind_speed_925hPa","wind_direction_925hPa","cloud_cover_925hPa","geopotential_height_900hPa","temperature_900hPa","relative_humidity_900hPa","wind_speed_900hPa","wind_direction_900hPa","cloud_cover_900hPa","geopotential_height_850hPa","temperature_850hPa","relative_humidity_850hPa","wind_speed_850hPa","wind_direction_850hPa","cloud_cover_850hPa","geopotential_height_800hPa","temperature_800hPa","relative_humidity_800hPa","wind_speed_800hPa","wind_direction_800hPa","cloud_cover_800hPa","geopotential_height_700hPa","temperature_700hPa","relative_humidity_700hPa","wind_speed_700hPa","wind_direction_700hPa","cloud_cover_700hPa","geopotential_height_600hPa","temperature_600hPa","relative_humidity_600hPa","wind_speed_600hPa","wind_direction_600hPa","cloud_cover_600hPa","geopotential_height_500hPa","temperature_500hPa","relative_humidity_500hPa","wind_speed_500hPa","wind_direction_500hPa","cloud_cover_500hPa","geopotential_height_400hPa","temperature_400hPa","relative_humidity_400hPa","wind_speed_400hPa","wind_direction_400hPa","cloud_cover_400hPa","geopotential_height_300hPa","temperature_300hPa","relative_humidity_300hPa","wind_speed_300hPa","wind_direction_300hPa","cloud_cover_300hPa","geopotential_height_250hPa","temperature_250hPa","relative_humidity_250hPa","wind_speed_250hPa","wind_direction_250hPa","cloud_cover_250hPa","geopotential_height_200hPa","temperature_200hPa","relative_humidity_200hPa","wind_speed_200hPa","wind_direction_200hPa","cloud_cover_200hPa"],s=o.join(","),l=document.getElementById("historicalDatePicker"),c=l?l.value:null,u=c?$.fromISO(c,{zone:"utc"}):null,d=$.utc().startOf("day"),m=u&&u<d;let p,h,v=ln.FORECAST;if(m)v=ln.HISTORICAL,p=u.toFormat("yyyy-MM-dd"),h=p;else{const M=$.utc();p=M.toFormat("yyyy-MM-dd"),h=M.plus({days:7}).toFormat("yyyy-MM-dd")}const b=`${v}?latitude=${e}&longitude=${n}&hourly=${s}&models=${r}&start_date=${p}&end_date=${h}`,y=await fetch(b);if(!y.ok)throw y.status===429?new Error("API-Limit for ensemble data reached. Please wait a moment and retry again."):new Error(`API request failed: ${y.status}`);const S=await y.json();i.ensembleModelsData={};const w=S.hourly.time;return a.forEach(M=>{const E={time:[...w]};let k=!1;o.forEach(_=>{const A=`${_}_${M}`;S.hourly[A]?(E[_]=S.hourly[A],k=!0):E[_]=null}),k&&(i.ensembleModelsData[M]=E)}),!0}catch(e){return console.error("Failed to fetch ensemble weather data:",e),f.handleError(e.message),!1}finally{t&&(t.style.display="none")}}function St(t,e){if(gn(),!i.ensembleModelsData||Object.keys(i.ensembleModelsData).length===0)return;const n=g.state.userSettings.currentEnsembleScenario;switch(console.log(`Processing ensemble scenario: ${n} for slider index: ${t}`),n){case"heatmap":oc(t);break;case"all_models":for(const a in i.ensembleModelsData){const r=i.ensembleModelsData[a],o=Aa(a,t,{hourly:r});o&&Vr(o,ic(a),a)}break;case"min_wind":case"mean_wind":case"max_wind":{const a=rc(n);if(a){const r=Aa(n,t,a);r&&Vr(r,sc(n),n.replace("_"," "))}break}}}function gn(){i.ensembleLayerGroup&&i.map.removeLayer(i.ensembleLayerGroup),i.ensembleScenarioCircles={},i.ensembleLayerGroup=L.layerGroup().addTo(i.map)}function rc(t,e){var d;if(!i.ensembleModelsData||Object.keys(i.ensembleModelsData).length===0)return console.warn("No ensemble data available for profile calculation."),null;if(Object.keys(i.ensembleModelsData).length===0)return null;console.log(`Calculating full time-series ensemble profile for: ${t}`);const a={},r=Object.keys(i.ensembleModelsData)[0],o=(d=i.ensembleModelsData[r])==null?void 0:d.time;if(!o||o.length===0)return console.error("Time data missing or empty in the first ensemble model for profile calculation."),null;a.time=[...o];const s=a.time.length,l=["surface_pressure","temperature_2m","relative_humidity_2m","geopotential_height_1000hPa","temperature_1000hPa","relative_humidity_1000hPa","geopotential_height_950hPa","temperature_950hPa","relative_humidity_950hPa","geopotential_height_925hPa","temperature_925hPa","relative_humidity_925hPa","geopotential_height_900hPa","temperature_900hPa","relative_humidity_900hPa","geopotential_height_850hPa","temperature_850hPa","relative_humidity_850hPa","geopotential_height_800hPa","temperature_800hPa","relative_humidity_800hPa","geopotential_height_700hPa","temperature_700hPa","relative_humidity_700hPa","geopotential_height_600hPa","temperature_600hPa","relative_humidity_600hPa","geopotential_height_500hPa","temperature_500hPa","relative_humidity_500hPa","geopotential_height_400hPa","temperature_400hPa","relative_humidity_400hPa","geopotential_height_300hPa","temperature_300hPa","relative_humidity_300hPa","geopotential_height_250hPa","temperature_250hPa","relative_humidity_250hPa","geopotential_height_200hPa","temperature_200hPa","relative_humidity_200hPa"],c=[["wind_speed_10m","wind_direction_10m"]];[1e3,950,925,900,850,800,700,600,500,400,300,250,200].forEach(m=>{c.push([`wind_speed_${m}hPa`,`wind_direction_${m}hPa`])}),l.forEach(m=>{a[m]=new Array(s).fill(null)}),c.forEach(m=>{a[m[0]]=new Array(s).fill(null),a[m[1]]=new Array(s).fill(null)});for(let m=0;m<s;m++)l.forEach(p=>{const h=[];for(const v in i.ensembleModelsData){const b=i.ensembleModelsData[v];if(b&&b[p]){const y=b[p][m];y!=null&&!isNaN(y)&&h.push(y)}}h.length>0&&(t==="min_wind"?a[p][m]=Math.min(...h):t==="max_wind"?a[p][m]=Math.max(...h):a[p][m]=h.reduce((v,b)=>v+b,0)/h.length)}),c.forEach(p=>{const h=p[0],v=p[1];let b=[],y=[],S=[],w=[];for(const M in i.ensembleModelsData){const E=i.ensembleModelsData[M];if(E&&E[h]&&E[v]){const k=E[h][m],_=E[v][m];k!=null&&!isNaN(k)&&_!==null&&_!==void 0&&!isNaN(_)&&(S.push(k),w.push(_),b.push(-k*Math.sin(_*Math.PI/180)),y.push(-k*Math.cos(_*Math.PI/180)))}}if(S.length>0)if(t==="min_wind"){const M=Math.min(...S),E=S.indexOf(M);a[h][m]=M,a[v][m]=w[E]}else if(t==="max_wind"){const M=Math.max(...S),E=S.indexOf(M);a[h][m]=M,a[v][m]=w[E]}else{const M=b.reduce((k,_)=>k+_,0)/b.length,E=y.reduce((k,_)=>k+_,0)/y.length;a[h][m]=f.windSpeed(M,E),a[v][m]=f.windDirection(M,E)}});return{hourly:a}}function Aa(t,e,n=null){var u,d;if(console.log(`Calculating exit circle for ensemble profile/model: ${t} at index ${e}`),e==null)return console.error("sliderIndex is undefined in calculateExitCircleForEnsemble. Aborting."),null;let a;if(n)a=n;else if(i.ensembleModelsData&&i.ensembleModelsData[t])a={hourly:i.ensembleModelsData[t]};else return console.warn(`No data for profile/model ${t} in calculateExitCircleForEnsemble found.`),null;if(!a.hourly||i.lastLat==null||i.lastLng==null||i.lastAltitude==="N/A")return console.warn(`Incomplete data for calculateExitCircleForEnsemble: ${t}`),null;const r=Ke(),o=g.getValue("heightUnit","m"),s=i.weatherData;i.weatherData=a.hourly;let l=null,c={meanWindDir:"N/A",meanWindSpeedMps:"N/A"};try{const m=g.state.userSettings.calculateJump,p=g.state.userSettings.showExitArea;g.state.userSettings.calculateJump=!0,g.state.userSettings.showExitArea=!0;const h=Se(i.weatherData,e,r,Math.round(i.lastAltitude),o);if(h&&h.length>0){l=hi(h);const v=h.map(A=>A.height),b=h.map(A=>-f.convertWind(A.spd,"m/s","km/h")*Math.sin(A.dir*Math.PI/180)),y=h.map(A=>-f.convertWind(A.spd,"m/s","km/h")*Math.cos(A.dir*Math.PI/180)),S=parseInt((u=document.getElementById("openingAltitude"))==null?void 0:u.value)||1200,w=parseInt((d=document.getElementById("legHeightDownwind"))==null?void 0:d.value)||0,M=Math.round(i.lastAltitude),E=M+S-200,k=M+w,_=f.calculateMeanWind(v,b,y,k,E);_&&Number.isFinite(_[0])&&Number.isFinite(_[1])&&(c={meanWindDir:_[0],meanWindSpeedMps:_[1]})}g.state.userSettings.calculateJump=m,g.state.userSettings.showExitArea=p}catch(m){console.error(`Error in calculateExitCircle for profile ${t}:`,m),l=null}finally{i.weatherData=s}return l?{centerLat:l.greenLat,centerLng:l.greenLng,radius:l.darkGreenRadius,meanWindDir:c.meanWindDir,meanWindSpeedMps:c.meanWindSpeedMps}:(console.warn(`calculateExitCircle returned null for profile ${t}`),null)}function oc(t,e){if(gn(),!i.ensembleModelsData||Object.keys(i.ensembleModelsData).length===0)return;const n=[];for(const y in i.ensembleModelsData)if(Object.hasOwnProperty.call(i.ensembleModelsData,y)){const S=i.ensembleModelsData[y],w=Aa(y,t,{hourly:S});w&&n.push({centerLat:w.centerLat,centerLng:w.centerLng,radius:w.radius})}if(n.length===0){console.warn("Could not calculate any circles for the heatmap.");return}const a=n.length,r=Math.ceil(a/2);let o=90,s=-90,l=180,c=-180;n.forEach(y=>{const S=y.radius/111320,w=y.radius/(111320*Math.cos(y.centerLat*Math.PI/180));o=Math.min(o,y.centerLat-S),s=Math.max(s,y.centerLat+S),l=Math.min(l,y.centerLng-w),c=Math.max(c,y.centerLng+w)});const u=25,d=u/111320,m=[],p=[],h=[];for(let y=o;y<=s;y+=d){const S=u/(111320*Math.cos(y*Math.PI/180));for(let w=l;w<=c;w+=S){let M=0;const E=L.latLng(y,w);for(const k of n)i.map.distance(E,L.latLng(k.centerLat,k.centerLng))<=k.radius&&M++;M>=1&&m.push([y,w]),M>=r&&p.push([y,w]),M===a&&h.push([y,w])}}const v=y=>{y.sort((E,k)=>E[0]-k[0]||E[1]-k[1]);const S=(E,k,_)=>(k[0]-E[0])*(_[1]-E[1])-(k[1]-E[1])*(_[0]-E[0]),w=[];for(const E of y){for(;w.length>=2&&S(w[w.length-2],w[w.length-1],E)<=0;)w.pop();w.push(E)}const M=[];for(let E=y.length-1;E>=0;E--){const k=y[E];for(;M.length>=2&&S(M[M.length-2],M[M.length-1],k)<=0;)M.pop();M.push(k)}return w.slice(0,-1).concat(M.slice(0,-1))};i.heatmapContourLayers=[];const b=(y,S)=>{if(y.length>2){const w=v(y),M=L.polygon(w,S).addTo(i.ensembleLayerGroup);i.heatmapContourLayers.push(M)}};b(m,{color:"red",weight:2,fillOpacity:.1,interactive:!1}),b(p,{color:"yellow",weight:2,fillOpacity:.15,interactive:!1}),b(h,{color:"green",weight:3,fillOpacity:.2,interactive:!1})}function Vr(t,e,n){var b,y;if(!i.map||!t||!i.ensembleLayerGroup)return;const a=[t.centerLat,t.centerLng],r=L.circle(a,{radius:t.radius,color:e,fillColor:e,fillOpacity:.15,weight:2,dashArray:"5, 10",pmIgnore:!0}).addTo(i.ensembleLayerGroup),o=g.getValue("windUnit","kt");let s="N/A";if(t.meanWindSpeedMps!=="N/A"&&Number.isFinite(t.meanWindSpeedMps)){const S=f.convertWind(t.meanWindSpeedMps,o,"m/s");S!=="N/A"&&Number.isFinite(S)&&(s=o==="bft"?Math.round(S):S.toFixed(1))}const l=parseInt((b=document.getElementById("openingAltitude"))==null?void 0:b.value)||g.state.userSettings.openingAltitude||1200,c=parseInt((y=document.getElementById("legHeightDownwind"))==null?void 0:y.value)||g.state.userSettings.legHeightDownwind||0,u=l-200,d=g.getValue("heightUnit","m"),m=Math.round(f.convertHeight(c,d)),p=Math.round(f.convertHeight(u,d)),h=t.meanWindDir!=="N/A"&&Number.isFinite(t.meanWindDir)?f.roundToTens(t.meanWindDir):"N/A",v=`<strong>${n}</strong><br>Mean Wind ${m}-${p} ${d} AGL:<br>${h}° ${s} ${o}`;r.bindTooltip(v,{permanent:!1,direction:"top",className:"wind-tooltip",opacity:.9}),i.ensembleScenarioCircles[n]=r,console.log(`Drew ensemble circle for ${n} at [${a.join(", ")}], radius ${t.radius}`)}function ic(t){let e=0;for(let a=0;a<t.length;a++)e=t.charCodeAt(a)+((e<<5)-e),e=e&e;return`hsl(${e%360}, 70%, 60%)`}function sc(t){return t==="min_wind"?mt.SCENARIO_COLORS.MIN_WIND:t==="mean_wind"?mt.SCENARIO_COLORS.MEAN_WIND:t==="max_wind"?mt.SCENARIO_COLORS.MAX_WIND:"rgba(128, 128, 128, 0.7)"}function fi(){var t;return parseInt((t=document.getElementById("timeSlider"))==null?void 0:t.value)||0}function lc({title:t,message:e,onConfirm:n,onCancel:a}){const r=document.getElementById("locationDisclosureModal"),o=document.getElementById("disclosureHeader"),s=document.getElementById("disclosureMessage"),l=document.getElementById("disclosureConfirm"),c=document.getElementById("disclosureCancel");if(!r||!o||!s||!l||!c){console.error("Disclosure modal elements not found!"),n();return}o.textContent=t,s.innerHTML=e,r.style.display="flex";const u=l.cloneNode(!0);l.parentNode.replaceChild(u,l);const d=c.cloneNode(!0);c.parentNode.replaceChild(d,c),u.onclick=()=>{r.style.display="none",n()},d.onclick=()=>{r.style.display="none",a()}}const $e={dbName:"SkydivingTileCache",storeName:"tiles",db:null,async init(){return new Promise((t,e)=>{const n=indexedDB.open(this.dbName,1);n.onupgradeneeded=a=>{a.target.result.createObjectStore(this.storeName,{keyPath:"url"})},n.onsuccess=a=>{this.db=a.target.result,t()},n.onerror=a=>{console.error("IndexedDB initialization failed:",a),e(a)}})},async storeTile(t,e){return this.db||await this.init(),new Promise((n,a)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put({url:t,blob:e,timestamp:Date.now()});s.onsuccess=()=>{console.log(`Stored tile: ${t}`),n(!0)},s.onerror=l=>{console.warn(`Failed to store tile: ${t}`,l),f.handleError("Failed to store some tiles. Try clearing cache."),a(l)}})},async getTile(t){return this.db||await this.init(),new Promise((e,n)=>{const r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName),o=r.get(t);o.onsuccess=s=>{const l=s.target.result;if(l)e(l.blob);else{const c=[t.replace("https://tile.opentopomap.org","https://a.tile.opentopomap.org"),t.replace("https://tile.opentopomap.org","https://b.tile.opentopomap.org"),t.replace("https://tile.opentopomap.org","https://c.tile.opentopomap.org"),t.replace("https://tile.openstreetmap.org","https://a.tile.openstreetmap.org"),t.replace("https://tile.openstreetmap.org","https://b.tile.openstreetmap.org"),t.replace("https://tile.openstreetmap.org","https://c.tile.openstreetmap.org"),t.replace("https://basemaps.cartocdn.com","https://a.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://b.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://c.basemaps.cartocdn.com"),t.replace("https://basemaps.cartocdn.com","https://d.basemaps.cartocdn.com")];let u=null;for(const d of c){if(d===t)continue;const m=r.get(d);m.onsuccess=p=>{const h=p.target.result;h&&(u=h.blob,e(u))},m.onerror=()=>{}}setTimeout(()=>{u||e(null)},100)}},o.onerror=s=>{console.warn(`Failed to retrieve tile: ${t}`,s),n(s)}})},async clearCache(){return this.db||await this.init(),new Promise((t,e)=>{const r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();r.onsuccess=()=>{console.log("Tile cache cleared"),t()},r.onerror=o=>{console.error("Failed to clear cache:",o),e(o)}})},async clearOldTiles(t=Va.MAX_AGE_DAYS){this.db||await this.init();const e=t*24*60*60*1e3;return new Promise((n,a)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).openCursor();let l=0,c=0;s.onsuccess=u=>{const d=u.target.result;if(d)Date.now()-d.value.timestamp>e&&(c+=d.value.blob.size||0,d.delete(),l++),d.continue();else{const m=c/1048576;console.log(`Cleared ${l} old tiles, freed ${m.toFixed(2)} MB`),n({deletedCount:l,deletedSizeMB:m})}},s.onerror=u=>{console.error("Failed to clear old tiles:",u),a(u)}})},async getCacheSize(){return this.db||await this.init(),new Promise((t,e)=>{const r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).openCursor();let o=0,s=0;r.onsuccess=l=>{var u;const c=l.target.result;if(c)try{const d=((u=c.value.blob)==null?void 0:u.size)||0;typeof d!="number"||isNaN(d)?console.warn(`Invalid blob size for tile: ${c.value.url}, size: ${d}`):(o+=d,s++),c.continue()}catch(d){console.warn(`Error processing tile during size calculation: ${c.value.url}`,d),c.continue()}else{const d=o/1048576;console.log(`Cache size calculation completed: ${d.toFixed(2)} MB, ${s} tiles`),t(d)}},r.onerror=l=>{console.error("Failed to calculate cache size:",l),e(l)}})},async migrateTiles(){return this.db||await this.init(),new Promise((t,e)=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),r=a.openCursor();let o=0;r.onsuccess=s=>{const l=s.target.result;if(l){const{url:c,blob:u,timestamp:d}=l.value,m=c.replace(/^(https?:\/\/[a-c]\.tile\.openstreetmap\.org)/,"https://tile.openstreetmap.org").replace(/^(https?:\/\/[a-d]\.basemaps\.cartocdn\.com)/,"https://basemaps.cartocdn.com").replace(/^(https?:\/\/[a-c]\.tile\.opentopomap\.org)/,"https://tile.opentopomap.org");c!==m&&(l.delete(),a.put({url:m,blob:u,timestamp:d}),o++),l.continue()}else console.log(`Migrated ${o} tiles to normalized URLs`),t()},r.onerror=s=>{console.error("Failed to migrate tiles:",s),e(s)}})}};L.TileLayer.Cached=L.TileLayer.extend({createTile(t,e){const n=document.createElement("img");n.setAttribute("crossOrigin","anonymous"),L.DomEvent.on(n,"load",()=>{console.log("Tile loaded:",this.getTileUrl(t)),e(null,n)}),L.DomEvent.on(n,"error",()=>{console.warn("Tile error:",this.getTileUrl(t)),e(new Error("Failed to load tile"),n)});const a=this.getTileUrl(t);n.setAttribute("role","presentation");const r=a.replace(/^(https?:\/\/[a-c]\.tile\.openstreetmap\.org)/,"https://tile.openstreetmap.org").replace(/^(https?:\/\/[a-d]\.basemaps\.cartocdn\.com)/,"https://basemaps.cartocdn.com").replace(/^(https?:\/\/[a-c]\.tile\.opentopomap\.org)/,"https://tile.opentopomap.org");return!navigator.onLine&&(t.z<11||t.z>14)?(console.log(`Skipping tile request outside cached zoom levels (11–14): ${a}`),f.handleError("Offline: Zoom restricted to levels 11–14 for cached tiles."),e(new Error("Zoom level not cached"),n),n):(navigator.onLine?(n.src=a,fetch(a,{signal:AbortSignal.timeout(Va.FETCH_TIMEOUT_MS)}).then(o=>{if(!o.ok)throw new Error(`HTTP ${o.status}`);return o.blob()}).then(o=>{$e.storeTile(r,o).catch(s=>console.warn("Failed to cache tile during rendering:",r,s))}).catch(o=>{console.warn("Fetch error for tile during rendering:",a,o),$e.getTile(r).then(s=>{s?(n.src=URL.createObjectURL(s),console.log(`Tile loaded from cache (fallback): ${r}`)):e(o,n)}).catch(s=>{console.warn("Cache fallback error:",r,s),e(s,n)})})):$e.getTile(r).then(o=>{o?(n.src=URL.createObjectURL(o),console.log(`Tile loaded from cache: ${r}`)):(console.warn(`Tile not in cache: ${r}`),f.handleError("This area is not cached. Please cache more tiles while online."),e(new Error("Tile not in cache"),n))}).catch(o=>{console.warn("Cache error for offline tile:",r,o),f.handleError("This area is not cached. Please cache more tiles while online."),e(o,n)}),n)}});L.tileLayer.cached=function(t,e){return new L.TileLayer.Cached(t,e)};async function pi({map:t,lastLat:e,lastLng:n,baseMaps:a,onProgress:r,onComplete:o,onCancel:s,radiusKm:l=null,silent:c=!1}){if(!t||!e||!n){o&&!c&&o("Map or location not ready for caching.");return}const u=l!==null?l:g.state.userSettings.cacheRadiusKm||g.defaultSettings.cacheRadiusKm,d=g.state.userSettings.cacheZoomLevels||g.defaultSettings.cacheZoomLevels,m=cc(e,n,u,d,t),p=[],h=g.state.userSettings.baseMaps,v=a[h];if(v){if(v instanceof L.LayerGroup)v.eachLayer(M=>{if(M instanceof L.TileLayer.Cached){const E=M.options.url||M._url;p.push({url:E,subdomains:M.options.subdomains,normalizedUrl:E.replace(/{s}\./,"")})}});else if(v instanceof L.TileLayer.Cached){const M=v.options.url||v._url;p.push({url:M,subdomains:v.options.subdomains,normalizedUrl:M.replace(/{s}\./,"")})}}const b=m.length*p.length;if(b===0){o&&!c&&o("No tiles to cache for this basemap.");return}let y=0,S=0;i.isCachingCancelled=!1,r&&!c&&r(0,b,()=>{i.isCachingCancelled=!0,s&&s()});const w=M=>new Promise(E=>setTimeout(E,M));try{const M=[];for(const E of p)for(const k of m)M.push(async()=>{if(i.isCachingCancelled)return;const _=E.url.replace("{z}",k.zoom).replace("{x}",k.x).replace("{y}",k.y).replace("{s}",E.subdomains?E.subdomains[Math.floor(Math.random()*E.subdomains.length)]:""),A=E.normalizedUrl.replace("{z}",k.zoom).replace("{x}",k.x).replace("{y}",k.y);if(await $e.getTile(A).catch(()=>null))S++;else{const C=await uc(_);C.success&&await $e.storeTile(A,C.blob).catch(()=>!1)&&S++}y++});for(let E=0;E<M.length&&!i.isCachingCancelled;E+=10){const k=M.slice(E,E+10).map(_=>_());await Promise.all(k),r&&!c&&r(y,b,()=>{i.isCachingCancelled=!0}),await w(250)}}catch(M){console.error("Unexpected error in cacheTilesForDIP:",M),o&&!c&&o("An error occurred during caching.")}finally{const M=y-S;let E="";i.isCachingCancelled?E=`Caching cancelled. ${S} tiles processed.`:E=`Caching complete. ${S} tiles cached${M>0?`, ${M} failed`:"."}`,o&&!c&&o(E)}}async function Ya({map:t,baseMaps:e,onProgress:n,onComplete:a,onCancel:r}){if(!t||!navigator.onLine){console.log("Skipping visible tile caching: offline or map not initialized");return}const o=t.getBounds(),s=t.getZoom(),l=g.state.userSettings.cacheZoomLevels||g.defaultSettings.cacheZoomLevels;if(!l.includes(s)){console.log(`Skipping caching: zoom ${s} not in cacheZoomLevels`,l);return}const c=256,u=t.project(o.getSouthWest(),s),d=t.project(o.getNorthEast(),s),m=Math.floor(u.x/c),p=Math.floor(d.x/c),h=Math.floor(d.y/c),v=Math.floor(u.y/c),b=[];for(let _=m;_<=p;_++)for(let A=h;A<=v;A++){const T=2**s;_>=0&&_<T&&A>=0&&A<T&&b.push({zoom:s,x:_,y:A})}console.log(`Caching ${b.length} visible tiles at zoom ${s} for ${g.state.userSettings.baseMaps}`);const y=[],S=g.state.userSettings.baseMaps,w=e[S];if(w)if(w instanceof L.LayerGroup)w.eachLayer(_=>{const A=_.options.url||_._url;A&&y.push({name:`${S} (${_.options.attribution||"sub-layer"})`,url:A,subdomains:_.options.subdomains,normalizedUrl:A.replace(/{s}\./,"")})});else{const _=w.options.url||w._url;_&&y.push({name:S,url:_,subdomains:w.options.subdomains,normalizedUrl:_.replace(/{s}\./,"")})}else{console.warn(`Base map ${S} not found, skipping caching`),a&&a("Selected base map not available for caching.");return}let M=0,E=0;const k=b.length*y.length;i.isCachingCancelled=!1,n&&n(0,k,()=>{i.isCachingCancelled=!0,r&&r()});for(const _ of y){if(i.isCachingCancelled)break;const A=b.map(async(T,C)=>{n&&n(M+E,k,()=>{i.isCachingCancelled=!0,r&&r()})});await Promise.all(A)}a&&a("Visible tiles cached.")}function cc(t,e,n,a,r){if(!r)return console.warn("Map not initialized, cannot calculate tiles"),[];const o=new Set,s=40075016686e-3,l=n*1e3;return a.forEach(c=>{const u=r.project([t,e],c),d=256,m=u.x/d,p=u.y/d,h=t*Math.PI/180,v=s*Math.cos(h)/(d*Math.pow(2,c)),b=Math.ceil(l/(v*d))+1,y=Math.pow(2,c);for(let S=Math.floor(m-b);S<=Math.ceil(m+b);S++)for(let w=Math.floor(p-b);w<=Math.ceil(p+b);w++)S>=0&&S<y&&w>=0&&w<y&&o.add(`${c}/${S}/${w}`)}),Array.from(o).map(c=>{const[u,d,m]=c.split("/").map(Number);return{zoom:u,x:d,y:m}})}async function uc(t,e=3){let n=null;for(let a=1;a<=e;a++){try{const r=new AbortController,o=setTimeout(()=>r.abort(),Va.FETCH_TIMEOUT_MS),s=await fetch(t,{signal:r.signal});if(clearTimeout(o),s.ok)return{success:!0,blob:await s.blob()};console.warn(`Attempt ${a} failed for ${t}: HTTP ${s.status}`),n=new Error(`HTTP ${s.status}`)}catch(r){console.warn(`Attempt ${a} error for ${t}: ${r.message}`),n=r,r.name==="AbortError"&&console.warn(`Fetch timeout after 15s for ${t}`)}a<e&&await new Promise(r=>setTimeout(r,1e3))}return{success:!1,error:n}}function Et(){const t="ontouchstart"in window||navigator.maxTouchPoints>0,e=window.Capacitor&&window.Capacitor.isNativePlatform();return t||e}function dc(){Et()&&document.body.classList.add("touch-device")}function me(){var t;return parseInt((t=document.getElementById("timeSlider"))==null?void 0:t.value)||0}function mc(t){const e=document.getElementById("modelSelect");if(!e)return;const n=e.value;e.innerHTML="",t.forEach(a=>{const r=document.createElement("option");r.value=a,r.textContent=a.replace(/_/g," ").toUpperCase(),e.appendChild(r)}),t.includes(g.state.userSettings.model)?e.value=g.state.userSettings.model:t.includes(n)?e.value=n:t.length>0&&(e.value=t[0])}function hc(t){let e=g.state.userSettings.selectedEnsembleModels||[],n=e.filter(a=>t.includes(a));e.length!==n.length&&(g.state.userSettings.selectedEnsembleModels=n,g.save())}function Xa(t,e="default"){let n=document.getElementById("snackbar");n||(n=document.createElement("div"),n.id="snackbar",document.body.appendChild(n)),n.textContent=t,n.className="show",e==="success"?n.classList.add("success"):e==="error"?n.classList.add("error"):e==="warning"&&n.classList.add("warning"),window.snackbarTimeout&&clearTimeout(window.snackbarTimeout),window.snackbarTimeout=setTimeout(()=>{n.className=n.className.replace("show","")},3e3)}function ht(t){console.log("displayMessage called with:",t),Xa(t,"success")}function Fn(t){console.log("displayError called with:",t),Xa(t,"error")}function ot(t){console.log("displayWarning called with:",t),Xa(t,"warning")}function cn(t,e,n){let a=document.getElementById("progress-snackbar");if(!a){a=document.createElement("div"),a.id="progress-snackbar";const o=document.createElement("div");o.className="progress-snackbar-content";const s=document.createElement("div");s.className="progress-snackbar-text";const l=document.createElement("div");l.className="progress-bar-container";const c=document.createElement("div");c.className="progress-bar",l.appendChild(c),o.appendChild(s),o.appendChild(l);const u=document.createElement("button");u.className="cancel-button",u.textContent="Cancel",u.onclick=()=>{n&&n(),it()},a.appendChild(o),a.appendChild(u),document.body.appendChild(a)}const r=e>0?Math.round(t/e*100):0;a.querySelector(".progress-snackbar-text").textContent=`Caching (${t}/${e})... ${r}%`,a.querySelector(".progress-bar").style.width=`${r}%`,a.classList.contains("show")||a.classList.add("show")}function it(){const t=document.getElementById("progress-snackbar");t&&t.classList.remove("show")}function Ca(){console.log("updateOfflineIndicator called, navigator.onLine:",navigator.onLine);let t=document.getElementById("offline-indicator");t||(t=document.createElement("div"),t.id="offline-indicator",t.textContent="Offline Mode",document.body.appendChild(t),console.log("Offline indicator created and appended")),navigator.onLine?t.classList.remove("show"):t.classList.add("show")}function Ut(t,e="Loading..."){const n=document.getElementById("loading");if(!n)return;const a=n.querySelector("p");t?(a&&(a.textContent=e),n.style.display="flex"):n.style.display="none"}let gt=JSON.parse(localStorage.getItem("searchCache"))||{},ua=!1;async function gc(t){if(!t.trim())return[];const e=vi(t);if(e)return[{display_name:`Coordinate: ${e.lat.toFixed(5)}, ${e.lng.toFixed(5)}`,lat:e.lat,lon:e.lng,type:"coordinate"}];if(gt[t])return gt[t];try{const n=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(t)}&count=10&language=de&format=json`,a=await fetch(n);if(!a.ok)throw new Error(`Geocoding API Error: ${a.statusText}`);const r=await a.json();if(!r.results)return[];const o=r.results.map(s=>({display_name:[s.name,s.admin1,s.country].filter(Boolean).join(", "),lat:s.latitude,lon:s.longitude}));return gt[t]=o,localStorage.setItem("searchCache",JSON.stringify(gt)),o}catch(n){return console.error("Search failed:",n),f.handleError("Could not find location. Please check network."),[]}}async function fc(t,e,n,a){if(console.log("findParachutingPOIs: Searching for POIs in bbox:",{minLat:t,minLon:e,maxLat:n,maxLon:a}),isNaN(t)||isNaN(e)||isNaN(n)||isNaN(a)||t<-90||n>90||e<-180||a>180||t>n||e>a)return console.error("findParachutingPOIs: Invalid bounding box coordinates"),f.handleError("Invalid map bounds for POI search."),[];const r=`parachutingPOIs_${t}_${e}_${n}_${a}`;if(gt[r])return console.log("findParachutingPOIs: Returning cached results for bbox:",r),gt[r];try{const o=`
            [out:json][timeout:50][bbox:${t},${e},${n},${a}];
            (
                nwr["sport"="parachuting"];
                nwr[~"^(name|description|alt_name|official_name)$"~"Skydiv|Fallschirm|Dropzone|Sprungplatz|Tandemspr", i];
                nwr["aeroway"~"aerodrome|airfield"]["service"~"skydiving|parachuting", i];
            );
            out center;
        `,s=`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(o)}`;console.log("findParachutingPOIs: Sending Overpass query:",o);const l=await fetch(s);if(!l.ok)throw new Error(`Overpass API Error: ${l.statusText}`);const c=await l.json();console.log("findParachutingPOIs: Raw Overpass response:",c);const u=c.elements.map(p=>{var b,y;const h=p.tags||{};return{display_name:[h.name,h["addr:street"]||h.street,h["addr:city"]||h.city,h["addr:state"]||h.state,h["addr:country"]||h.country,h.sport?`(${h.sport})`:null,h.aeroway==="aerodrome"?"(Airfield)":null].filter(Boolean).join(", ")||"Unnamed Parachuting Location",lat:p.lat||((b=p.center)==null?void 0:b.lat),lon:p.lon||((y=p.center)==null?void 0:y.lon),type:h.sport||h.aeroway||h.leisure||"parachuting"}}),d=[],m=new Set;for(const p of u){const h=`${p.lat.toFixed(5)}_${p.lon.toFixed(5)}`;m.has(h)||(m.add(h),d.push(p))}return console.log("findParachutingPOIs: Caching results for bbox:",r),gt[r]=d,localStorage.setItem("searchCache",JSON.stringify(gt)),d.length===0?(console.log("findParachutingPOIs: No parachuting POIs found in bbox"),f.handleMessage("No parachuting locations found in this area.")):(console.log("findParachutingPOIs: Found POIs:",d),f.handleMessage(`Found ${d.length} parachuting location(s) in this area.`)),d}catch(o){return console.error("findParachutingPOIs: Search failed:",o),f.handleError("Could not find parachuting locations. Please check network."),[]}}function pc(t,e){let n=Ye(),a="Home DZ";n.forEach(o=>o.isHomeDZ=!1);const r=n.find(o=>Math.abs(o.lat-t)<1e-4&&Math.abs(o.lng-e)<1e-4);r?(r.isHomeDZ=!0,a=r.label):n.unshift({lat:t,lng:e,label:"Home DZ",isFavorite:!0,isHomeDZ:!0,timestamp:Date.now()}),jt(n),f.handleMessage(`"${a}" is now your Home DZ.`),fn()}function yc(){let t=Ye();t.forEach(e=>e.isHomeDZ=!1),jt(t),f.handleMessage("Home DZ removed."),fn()}function wc(){return Ye().find(t=>t.isHomeDZ)}function yi(t,e,n,a=!1){if(console.log("addCoordToHistory: Adding:",{lat:t,lng:e,label:n,isFavorite:a}),isNaN(t)||isNaN(e)){console.error("addCoordToHistory: Invalid coordinates");return}let r=Ye();const o=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5));r=r.filter(u=>Math.abs(u.lat-o)>.001||Math.abs(u.lng-s)>.001),r.unshift({lat:o,lng:s,label:n,isFavorite:a,timestamp:Date.now()});const l=r.filter(u=>u.isFavorite),c=r.filter(u=>!u.isFavorite).slice(0,5);jt([...l,...c])}function wi(t,e,n,a=!1){if(console.log("addOrUpdateFavorite: Processing:",{lat:t,lng:e,name:n}),isNaN(t)||isNaN(e)){console.error("addOrUpdateFavorite: Invalid coordinates");return}if(ua){console.log("addOrUpdateFavorite: Blocked due to ongoing operation");return}ua=!0;try{let r=Ye();const o=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5)),l=r.find(c=>Math.abs(c.lat-o)<.001&&Math.abs(c.lng-s)<.001);if(l)console.log("addOrUpdateFavorite: Updating existing entry:",l),l.isFavorite=!0,l.label=n;else{const c={lat:o,lng:s,label:n,isFavorite:!0,timestamp:Date.now()};console.log("addOrUpdateFavorite: Adding new entry:",c),r.unshift(c)}jt(r),a||f.handleMessage(`"${n}" saved as favorite.`),fn()}catch(r){console.error("addOrUpdateFavorite: Error:",r)}finally{ua=!1,console.log("addOrUpdateFavorite: Completed")}}function vc(t,e,n,a){let r=Ye();const o=parseFloat(t.toFixed(5)),s=parseFloat(e.toFixed(5)),l=r.find(c=>Math.abs(c.lat-o)<1e-4&&Math.abs(c.lng-s)<1e-4);l&&(l.isFavorite=a),jt(r),fn(),f.handleMessage(`"${n}" removed from favorites.`)}function Lc(t,e){if(console.log("removeLocationFromHistory: Removing:",{lat:t,lng:e}),isNaN(t)||isNaN(e)){console.error("removeLocationFromHistory: Invalid coordinates");return}const a=Ye().filter(r=>{const o=parseFloat(r.lat),s=parseFloat(r.lng||r.lon);return Math.abs(o-t)>.001||Math.abs(s-e)>.001});jt(a),f.handleMessage("Location deleted."),fn()}function Ye(){console.log("getCoordHistory: Retrieving history");try{const t=JSON.parse(localStorage.getItem("coordHistory"))||[];return console.log("getCoordHistory: History retrieved:",t),t}catch(t){return console.error("getCoordHistory: Error retrieving history:",t),[]}}function jt(t){console.log("saveCoordHistory: Saving history:",t);try{localStorage.setItem("coordHistory",JSON.stringify(t)),console.log("saveCoordHistory: History saved")}catch(e){console.error("saveCoordHistory: Error saving history:",e)}}function vi(t){console.log("parseQueryAsCoordinates: Parsing query:",t);const e=t.trim(),a=e.replace(/[,;\t]+/g," ").trim().match(/^(-?\d{1,3}(?:\.\d+)?)\s+(-?\d{1,3}(?:\.\d+)?)$/);if(a){console.log("parseQueryAsCoordinates: Regex match:",a);const s=parseFloat(a[1]),l=parseFloat(a[2]);if(console.log("parseQueryAsCoordinates: Decimal degrees detected:",{lat:s,lng:l}),!isNaN(s)&&!isNaN(l)&&s>=-90&&s<=90&&l>=-180&&l<=180)return{lat:s,lng:l};console.warn("parseQueryAsCoordinates: Invalid coordinate ranges:",{lat:s,lng:l})}const r=e.replace(/\s/g,"").toUpperCase(),o=/^[0-9]{1,2}[C-HJ-NP-X][A-HJ-NP-Z]{2}(\d{2}|\d{4}|\d{6}|\d{8}|\d{10})$/;if(typeof Wl>"u")return console.warn("parseQueryAsCoordinates: MGRS library not loaded"),null;if(o.test(r))try{const[s,l]=Ga(r);if(console.log("parseQueryAsCoordinates: MGRS detected:",{lat:l,lng:s}),!isNaN(l)&&!isNaN(s))return{lat:l,lng:s};console.warn("parseQueryAsCoordinates: Invalid MGRS coordinates:",{lat:l,lng:s})}catch(s){return console.warn("parseQueryAsCoordinates: MGRS parsing failed:",s.message),null}return console.log("parseQueryAsCoordinates: No coordinates detected"),null}function fn(){console.log("_dispatchFavoritesUpdate: Dispatching event");const e=Ye().filter(a=>a.isFavorite),n=new CustomEvent("favorites:updated",{detail:{favorites:e},bubbles:!0,cancelable:!0});document.dispatchEvent(n),console.log("_dispatchFavoritesUpdate: Event dispatched")}let En=0;async function bc(){return console.log("MapManager: Starte Karteninitialisierung..."),await Mc(),console.log("MapManager: Karteninitialisierung abgeschlossen."),i.map}async function Mc(){if(i.ismapInitialized||i.map){console.warn("Map already initialized or init in progress.");return}i.ismapInitialized=!0,console.log("initMap started...");const t=je.DEFAULT_MAP_CENTER,e=je.DEFAULT_MAP_ZOOM;Uc(t,e),i.jumpVisualizationLayerGroup=L.layerGroup().addTo(i.map),i.landingPatternLayerGroup=L.layerGroup().addTo(i.map),i.jumpRunTrackLayerGroup=L.layerGroup().addTo(i.map),i.favoritesLayerGroup=L.layerGroup().addTo(i.map),console.log("Favorite marker layer added!"),i.poiLayerGroup=L.layerGroup().addTo(i.map),console.log("POI marker layer added!"),Vc(),Hc(),Zc(),Bc(t),Jc(),Promise.all([Gc(),Xc(t,e)]).then(()=>{console.log("Initial tile caching and geolocation promise resolved.")}).catch(n=>{console.error("Error during parallel initialization of cache/geolocation:",n)}),Ca(),console.log("initMap finished.")}function Tn(t){if(_c(),i.labelZoomListener&&i.map&&(i.map.off("zoomend",i.labelZoomListener),i.labelZoomListener=null),!t||!i.jumpVisualizationLayerGroup)return;const e=[];t.exitCircles&&t.exitCircles.forEach(a=>{const r=L.circle(a.center,{radius:a.radius,className:"jump-viz-exit-area",pmIgnore:!0}).addTo(i.jumpVisualizationLayerGroup);a.tooltip&&r.bindTooltip(a.tooltip,{direction:"top",offset:[0,0],className:"wind-tooltip"})}),t.canopyCircles&&t.canopyCircles.forEach(a=>{L.circle(a.center,{...a,pmIgnore:!0}).addTo(i.jumpVisualizationLayerGroup)});function n(a,r){const o=L.latLng(a[0],a[1]),l=r/6378137*(180/Math.PI),c=L.latLng(a[0]+l,a[1]),u=i.map.latLngToLayerPoint(o),d=i.map.latLngToLayerPoint(c);return[25,u.y-d.y+10]}if(t.canopyLabels){const a=i.map.getZoom();t.canopyLabels.forEach(r=>{const o=a<=11,s=L.marker(r.center,{icon:L.divIcon({className:`isoline-label ${o?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${o?"8px":"10px"}">${r.text}</span>`,iconSize:o?[50,12]:[60,14],iconAnchor:n(r.center,r.radius),pmIgnore:!0}),zIndexOffset:2100}).addTo(i.jumpVisualizationLayerGroup);e.push({marker:s,center:r.center,radius:r.radius,text:r.text,pmIgnore:!0})})}e.length>0&&(i.labelZoomListener=function(){const r=i.map.getZoom()<=11;e.forEach(o=>{o.marker.setIcon(L.divIcon({className:`isoline-label ${r?"isoline-label-small":"isoline-label-large"}`,html:`<span style="font-size: ${r?"8px":"10px"}">${o.text}</span>`,iconSize:r?[50,12]:[60,14],iconAnchor:n(o.center,o.radius)}))})},i.map.on("zoomend",i.labelZoomListener))}function en(t){Tc(),t&&(t.legs.forEach(e=>{L.polyline(e.path,{color:"red",weight:3,opacity:.8,dashArray:"5, 10",pmIgnore:!0}).addTo(i.landingPatternLayerGroup)}),t.arrows.forEach(e=>{const n=Nc(e.position[0],e.position[1],e.bearing,e.color);L.marker(e.position,{icon:n,pmIgnore:!0}).addTo(i.landingPatternLayerGroup).bindTooltip(e.tooltipText,{offset:[10,0],direction:"right",className:"wind-tooltip",pmIgnore:!0})}))}function rn(t){var o,s,l,c;if(Ac(),!i.jumpRunTrackLayerGroup){console.error("drawJumpRunTrack called before jumpRunTrackLayerGroup was initialized.");return}if(!t)return;if(!((s=(o=t.path)==null?void 0:o.latlngs)!=null&&s.length)||!((l=t.airplane)!=null&&l.position)){console.warn("Invalid trackData structure:",t);return}const e=L.polyline(t.path.latlngs,t.path.options).bindTooltip(t.path.tooltipText).addTo(i.jumpRunTrackLayerGroup);let n=null;(c=t.approachPath)!=null&&c.latlngs&&(n=L.polyline(t.approachPath.latlngs,t.approachPath.options).bindTooltip(t.approachPath.tooltipText).addTo(i.jumpRunTrackLayerGroup));const a=L.icon({iconUrl:Vn.AIRPLANE_MARKER,iconSize:[32,32],iconAnchor:[16,16],shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[13,32]}),r=L.marker(t.airplane.position,{icon:a,rotationAngle:t.airplane.bearing,rotationOrigin:"center center",draggable:!g.state.userSettings.isInteractionLocked,zIndexOffset:2e3,pmIgnore:!0}).bindTooltip("Drag to move Jump Run Track").addTo(i.jumpRunTrackLayerGroup);r.on("mousedown",()=>{g.state.userSettings.isInteractionLocked&&ot("Interaction is locked. Please unlock to move points."),i.map.dragging.disable()}),r.on("mouseup",()=>i.map.dragging.enable()),r.on("drag",u=>{var b;const d=u.target.getLatLng(),m=t.airplane.originalPosition;if(!m||!Number.isFinite(m.lat)||!Number.isFinite(m.lng)){console.warn("Invalid originalPosition:",m);return}const p=d.lat-m.lat,h=d.lng-m.lng;if(!Number.isFinite(p)||!Number.isFinite(h)){console.warn("Invalid delta values:",{deltaLat:p,deltaLng:h});return}const v=t.path.originalLatLngs.map(y=>[Number.isFinite(y[0])?y[0]+p:y[0],Number.isFinite(y[1])?y[1]+h:y[1]]);if(e.setLatLngs(v),n&&((b=t.approachPath)!=null&&b.originalLatLngs)){const y=t.approachPath.originalLatLngs.map(S=>[Number.isFinite(S[0])?S[0]+p:S[0],Number.isFinite(S[1])?S[1]+h:S[1]]);n.setLatLngs(y)}}),r.on("dragstart",u=>{g.state.userSettings.isInteractionLocked&&(u.target.dragging.disable(),ot("Interaction is locked. Please unlock to move points."))}),r.on("dragend",u=>{const d=u.target.getLatLng();if(!Number.isFinite(d.lat)||!Number.isFinite(d.lng)){console.warn("Invalid new position in dragend:",d);return}const m=new CustomEvent("track:dragend",{detail:{newPosition:d,originalTrackData:t},bubbles:!0});i.map.getContainer().dispatchEvent(m)})}function Ia(t){i.cutAwayCircle&&(i.map.removeLayer(i.cutAwayCircle),i.cutAwayCircle=null),t&&(i.cutAwayCircle=L.circle(t.center,{radius:t.radius,color:"purple",fillColor:"purple",fillOpacity:.2,weight:2,pmIgnore:!0}).addTo(i.map),i.cutAwayCircle.bindTooltip(t.tooltipContent,{permanent:!1,direction:"center",className:"cutaway-tooltip"}))}function Sc(t,e){const n=[[t.lat,t.lng],[e.lat,e.lng]];i.jumpMasterLine?i.jumpMasterLine.setLatLngs(n):i.jumpMasterLine=L.polyline(n,{className:"jump-master-line"}).addTo(i.map)}function Ec(t){if(zc(),i.terrainWarningLayer.clearLayers(),!t||t.length<3)return;const e=f.getConvexHull(t.map(a=>[a.lat,a.lng])),n=g.getValue("terrainClearance",100);L.polygon(e,{color:"red",fillColor:"#f03",fillOpacity:.5,weight:2,pmIgnore:!0}).bindTooltip(`WARNING: Ground clearance in this area may be less than ${n}m!`,{sticky:!0,className:"cutaway-tooltip"}).addTo(i.terrainWarningLayer)}function kc(t){if(!i.map||t.length<2)return;const e={color:"#007bff",weight:3,opacity:.7,pmIgnore:!0};i.aircraftTrackLayer?i.aircraftTrackLayer.setLatLngs(t):i.aircraftTrackLayer=L.polyline(t,e).addTo(i.map)}function _c(){i.map&&i.jumpVisualizationLayerGroup&&i.map.removeLayer(i.jumpVisualizationLayerGroup),i.jumpVisualizationLayerGroup=L.layerGroup().addTo(i.map)}function Tc(){i.landingPatternLayerGroup&&i.landingPatternLayerGroup.clearLayers()}function Ac(){i.map&&i.jumpRunTrackLayerGroup&&i.map.removeLayer(i.jumpRunTrackLayerGroup),i.jumpRunTrackLayerGroup=L.layerGroup().addTo(i.map)}function Cc(){i.cutAwayMarker&&(i.map.removeLayer(i.cutAwayMarker),i.cutAwayMarker=null),Ia(null)}function Ic(){i.jumpMasterLine&&(i.map.removeLayer(i.jumpMasterLine),i.jumpMasterLine=null)}function Dc(){if(!i.map){console.warn("Map not initialized, cannot clear HARP marker"),f.handleMessage("Map not initialized, cannot clear HARP marker.");return}i.harpMarker&&(i.map.removeLayer(i.harpMarker),i.harpMarker=null,console.log("Removed HARP marker")),g.state.userSettings.harpLat=null,g.state.userSettings.harpLng=null,g.save();const t=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');if(t&&(t.disabled=!0,console.log("Disabled HARP radio button")),g.state.userSettings.jumpMasterLineTarget==="HARP"&&g.state.userSettings.showJumpMasterLine){i.jumpMasterLine&&(i.map.removeLayer(i.jumpMasterLine),i.jumpMasterLine=null,console.log("Removed Jump Master Line: HARP marker cleared")),g.state.userSettings.jumpMasterLineTarget="DIP";const e=document.querySelector('input[name="jumpMasterLineTarget"][value="DIP"]');e&&(e.checked=!0,console.log("Switched Jump Master Line to DIP")),g.save(),i.liveMarker&&i.currentMarker&&i.lastLat!==null&&i.lastLng!==null&&debouncedPositionUpdate({coords:{latitude:i.lastLatitude,longitude:i.lastLongitude,accuracy:i.lastAccuracy,altitude:i.lastDeviceAltitude,altitudeAccuracy:i.lastAltitudeAccuracy}})}f.handleMessage("HARP marker cleared")}function Pc(){i.terrainWarningLayer&&(i.terrainWarningLayer.clearLayers(),console.log("Terrain warning layer cleared."))}function Zr(){i.aircraftTrackLayer&&(i.map.removeLayer(i.aircraftTrackLayer),i.aircraftTrackLayer=null)}function Nc(t,e,n,a){const r=(n+360)%360,o=`
        <svg width="40" height="20" viewBox="0 0 40 20" xmlns="http://www.w3.org/2000/svg">
            <line x1="0" y1="10" x2="30" y2="10" stroke="${a}" stroke-width="4" />
            <polygon points="30,5 40,10 30,15" fill="${a}" />
        </svg>
    `;return L.divIcon({html:`<div style="transform-origin: center; transform: rotate(${r}deg);">${o}</div>`,className:"wind-arrow-icon",iconSize:[40,20],iconAnchor:[20,10]})}function xc(t,e){const n=L.icon({iconUrl:Vn.CUTAWAY_MARKER,iconSize:[25,25],iconAnchor:[12,12],popupAnchor:[0,-12],pmIgnore:!0});return L.marker([t,e],{icon:n,draggable:!g.state.userSettings.isInteractionLocked,pmIgnore:!0})}function Fc(t){t.on("mousedown",()=>{g.state.userSettings.isInteractionLocked&&ot("Interaction is locked. Please unlock to move points.")}),t.on("dragend",e=>{const n=t.getLatLng();i.cutAwayLat=n.lat,i.cutAwayLng=n.lng,Li(t,i.cutAwayLat,i.cutAwayLng);const a=new CustomEvent("cutaway:marker_placed",{bubbles:!0});i.map.getContainer().dispatchEvent(a)})}function Li(t,e,n,a=!1){const r=g.getValue("coordFormat","radio","Decimal");f.convertCoords(e,n,r);let o="<b>Cut-Away Start</b><br>";const s=c=>`${c.deg}° ${c.min.toFixed(3)}' ${c.dir}`,l=c=>`${c.deg}°${c.min}'${c.sec.toFixed(0)}" ${c.dir}`;r==="MGRS"?o+=`MGRS: ${f.decimalToMgrs(e,n)}`:r==="DMS"?o+=`Lat: ${l(f.decimalToDms(e,!0))}<br>Lng: ${l(f.decimalToDms(n,!1))}`:r==="DDM"?o+=`Lat: ${s(f.decimalToDecimalMinutes(e,!0))}<br>Lng: ${s(f.decimalToDecimalMinutes(n,!1))}`:o+=`Lat: ${e.toFixed(5)}<br>Lng: ${n.toFixed(5)}`,Jn(t,o,a)}async function jn(t,e){if(console.log("MapManager: Befehl erhalten, Marker zu erstellen/bewegen bei",t,e),typeof t!="number"||typeof e!="number"||t<-90||t>90||e<-180||e>180){console.error("MapManager: Ungültige Koordinaten:",{lat:t,lng:e});return}const n=await f.getAltitude(t,e);if(i.currentMarker)console.log("MapManager: Marker existiert, bewege ihn jetzt mit setLatLng."),i.currentMarker.setLatLng([t,e]);else{console.log("MapManager: Kein Marker vorhanden, erstelle einen neuen.");const r=$c(t,e);Oc(r),r.on("click",()=>{Za(()=>Promise.resolve().then(()=>nu),void 0).then(o=>{o.refreshMarkerPopup(!1,!0)})}),i.currentMarker=r,i.currentMarker.addTo(i.map)}const a=`Lat: ${t.toFixed(5)}<br>Lng: ${e.toFixed(5)}<br>Alt: ${n} m`;Jn(i.currentMarker,a),i.lastLat=t,i.lastLng=e,i.lastAltitude=n,i.map.invalidateSize()}function $c(t,e){const n=L.icon({iconUrl:Vn.DEFAULT_MARKER,iconSize:[32,32],iconAnchor:[16,20],popupAnchor:[0,-32],pmIgnore:!0});return L.marker([t,e],{icon:n,draggable:!g.state.userSettings.isInteractionLocked,pmIgnore:!0})}function Oc(t){t.on("mousedown",()=>{g.state.userSettings.isInteractionLocked&&ot("Interaction is locked. Please unlock to move points.")}),t.on("dragend",e=>{const n=t.getLatLng(),a=new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lng,source:"marker_drag"},bubbles:!0});i.map.getContainer().dispatchEvent(a)})}function Jn(t,e,n=!1){if(!t)return;const a=t.getPopup(),r=a&&a.isOpen()||n;a?a.setContent(e):t.bindPopup(e),r&&t.openPopup()}function bi(t){if(!i.map||!i.favoritesLayerGroup){console.warn("Cannot update favorite markers: map or layer group not ready.");return}if(i.favoritesLayerGroup.clearLayers(),!t||t.length===0)return;const e=L.divIcon({html:"★",className:"favorite-marker-icon",iconSize:[24,24],iconAnchor:[12,12]});t.forEach(n=>{const a=L.marker([n.lat,n.lng],{icon:e,pmIgnore:!0}).bindTooltip(n.label,{permanent:!1,direction:"top"}).on("click",()=>{document.dispatchEvent(new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lng,source:"favorite_marker"},bubbles:!0}))});i.favoritesLayerGroup.addLayer(a)})}function Da(t){if(g.state.userSettings.isInteractionLocked){ot("Interaction is locked. Please unlock to move points."),i.isPlacingHarp=!1,i.map.off("click",Da);return}if(!i.isPlacingHarp)return;const{lat:e,lng:n}=t.latlng;i.harpMarker?i.harpMarker.setLatLng([e,n]):i.harpMarker=Mi(e,n).addTo(i.map),Qa(i.harpMarker,e,n,!0),g.state.userSettings.harpLat=e,g.state.userSettings.harpLng=n,g.state.userSettings.jumpRunTrackOffset=0,g.state.userSettings.jumpRunTrackForwardOffset=0,console.log("HARP placed. JRT offsets reset to 0."),g.save(),i.isPlacingHarp=!1,i.map.off("click",Da);const a=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');a&&(a.disabled=!1),document.dispatchEvent(new CustomEvent("ui:recalculateJump")),document.dispatchEvent(new CustomEvent("harp:updated"))}function Mi(t,e){const n=L.marker([t,e],{icon:L.divIcon({className:"harp-marker",html:'<div class="harp-marker-inner"></div>',iconSize:[20,20],iconAnchor:[10,10]}),pane:"markerPane",pmIgnore:!0});return n.on("click",()=>{const a=n.getLatLng();Qa(n,a.lat,a.lng,!0)}),n}async function Qa(t,e,n,a=!1,r=!1){var p,h;const o=await f.getAltitude(e,n),s=g.getValue("heightUnit","radio","m");let l="N/A",c=s;o!=="N/A"&&(l=Math.round(f.convertHeight(o,s)));let u="N/A";if(o!=="N/A"&&i.weatherData&&i.weatherData.surface_pressure){const v=parseInt((p=document.getElementById("timeSlider"))==null?void 0:p.value)||0,b=i.weatherData.surface_pressure[v],y=((h=i.weatherData.temperature_2m)==null?void 0:h[v])||15,S=f.calculateQFE(b,o,o,y);S!=="N/A"&&(u=`${S} hPa`)}const d=`<br>Alt: ${l} ${c}<br>QFE: ${u}`;let m="<b>HARP</b><br>";if(r){const v=f.decimalToDms(e,!0),b=f.decimalToDecimalMinutes(e,!0),y=f.decimalToDms(n,!1),S=f.decimalToDecimalMinutes(n,!1);m+=`
            <div style="font-size: 11px; line-height: 1.4;">
                Decimal: ${e.toFixed(5)}, ${n.toFixed(5)}<br>
                DDM: ${b.deg}° ${b.min.toFixed(3)}' ${b.dir}, ${S.deg}° ${S.min.toFixed(3)}' ${S.dir}<br>
                DMS: ${v.deg}°${v.min}'${v.sec.toFixed(0)}" ${v.dir}, ${y.deg}°${y.min}'${y.sec.toFixed(0)}" ${y.dir}<br>
                MGRS: ${f.decimalToMgrs(e,n)}
            </div>
            ${d}<br>
            <a href="#" class="toggle-coords-format" data-marker-type="harp" data-lat="${e}" data-lng="${n}" data-expanded="true" style="font-size: 11px;">Show less</a>
        `}else{const v=g.getValue("coordFormat","radio","Decimal"),b=f.convertCoords(e,n,v),y=w=>`${w.deg}° ${w.min.toFixed(3)}' ${w.dir}`,S=w=>`${w.deg}°${w.min}'${w.sec.toFixed(0)}" ${w.dir}`;v==="MGRS"?m+=`MGRS: ${b.lat}`:v==="DMS"?m+=`Lat: ${S(b.lat)}<br>Lng: ${S(b.lng)}`:v==="DDM"?m+=`Lat: ${y(b.lat)}<br>Lng: ${y(b.lng)}`:m+=`Lat: ${b.lat}<br>Lng: ${b.lng}`,m+=`${d}<br>
            <a href="#" class="toggle-coords-format" data-marker-type="harp" data-lat="${e}" data-lng="${n}" data-expanded="false" style="font-size: 11px;">Show more</a>
        `}Jn(t,m,a)}function Rc(t){if(!i.map||!i.poiLayerGroup){console.warn("Cannot update POI markers: map or layer group not ready.");return}if(i.poiLayerGroup.clearLayers(),!t||t.length===0)return;const e=L.divIcon({html:"🪂",className:"poi-marker-icon",iconSize:[24,24],iconAnchor:[12,12]});t.forEach(n=>{const a=L.marker([n.lat,n.lon],{icon:e,pmIgnore:!0}).bindTooltip(n.display_name,{permanent:!1,direction:"top"}).on("click",()=>{document.dispatchEvent(new CustomEvent("location:selected",{detail:{lat:n.lat,lng:n.lon,source:"poi_marker"},bubbles:!0}))});i.poiLayerGroup.addLayer(a)})}function Wc(t,e,n){const a=L.icon({iconUrl:Vn.LIVEPLANE_MARKER,iconSize:[32,32],iconAnchor:[16,16]}),r=L.marker([t,e],{icon:a,rotationAngle:n,rotationOrigin:"center center",zIndexOffset:1500,pmIgnore:!0}).addTo(i.map);return i.aircraftMarker=r,r}function Uc(t,e){i.lastLat=i.lastLat||t[0],i.lastLng=i.lastLng||t[1],i.map=L.map("map",{center:t,zoom:e,zoomControl:!1,doubleClickZoom:!1,maxZoom:19,minZoom:navigator.onLine?6:11}),console.log("Map instance created.")}function Hc(){if(!i.map){console.error("Karte nicht initialisiert, bevor Controls hinzugefügt werden können.");return}L.control.layers(i.baseMaps,null,{position:"topright"}).addTo(i.map),i.map.on("baselayerchange",function(t){g&&g.state&&g.state.userSettings&&(g.state.userSettings.baseMaps=t.name,g.save()),i.hasTileErrorSwitched=!1,i.lastLat&&i.lastLng&&typeof cacheTilesForDIP=="function"&&cacheTilesForDIP({map:i.map,lastLat:i.lastLat,lastLng:i.lastLng,baseMaps:i.baseMaps})}),L.control.zoom({position:"topright"}).addTo(i.map),L.control.scale({position:"bottomleft",metric:!0,imperial:!1,maxWidth:100}).addTo(i.map),i.map.pm.addControls({position:"topright",drawMarker:!0,drawCircleMarker:!1,drawPolyline:!0,drawPolygon:!1,drawRectangle:!1,drawCircle:!0,cutPolygon:!1,editMode:!0,dragMode:!0,removalMode:!0,rotateMode:!1}),i.map.pm.setLang("en"),Et()&&(i.map.pm.setGlobalOptions({hintlineStyle:{opacity:0,color:"green"}}),console.log("Geoman global options set for mobile to hide helper lines.")),console.log("Standard map controls including Geoman have been added.")}async function Bc(t,e){console.log("MapManager: Initialisiere den Standard-Marker..."),await jn(t[0],t[1]),i.isManualPanning=!1,console.log("Default marker initialized using the new standard method.")}async function Gc(){try{if(await $e.init(),await $e.migrateTiles(),await $e.getCacheSize()>500){const e=await $e.clearOldTiles(3);f.handleMessage(`Cleared ${e.deletedCount} old tiles: ${e.deletedSizeMB.toFixed(2)} MB freed.`)}else await $e.clearOldTiles()}catch(t){console.error("Failed to initialize or manage tile cache:",t),f.handleError("Tile caching setup failed.")}console.log("Tile cache logic initialized.")}function zc(){i.terrainWarningLayer||(i.terrainWarningLayer=L.layerGroup().addTo(i.map))}function Vc(){i.baseMaps={OpenStreetMap:L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}),OpenTopoMap:L.tileLayer.cached("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,attribution:'© <a href="https://www.openstreetmap.org/copyright">OSM</a>, <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)',subdomains:["a","b","c"]}),"Esri Street":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Topo":L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),"Esri Satellite":L.layerGroup([L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19}),L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© EsriEsri, USDA, USGS © OpenStreetMap contributors, and the GIS user community",pane:"shadowPane"})]),"Esri Satellite + OSM":L.layerGroup([L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USDA, USGS",zIndex:1}),L.tileLayer.cached("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',opacity:.5,zIndex:2,updateWhenIdle:!0,keepBuffer:2,subdomains:["a","b","c"]})],{attribution:'© Esri, USDA, USGS | © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),"OpenTopoMap + Airspaces":L.layerGroup([L.tileLayer.cached("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)',subdomains:["a","b","c"]}),L.tileLayer.cached("https://nwy-tiles-api.prod.newaydata.com/tiles/{z}/{x}/{y}.png?path=latest/aero/latest",{maxZoom:19,attribution:'© <a href="https://www.openflightmaps.org">openflightmaps.org</a>',opacity:.8,transparent:!0,zIndex:2,updateWhenIdle:!0,keepBuffer:2,subdomains:["a","b","c"]})],{attribution:'© Esri, USDA, USGS | © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),"Open Flight Map":L.tileLayer.cached("https://nwy-tiles-api.prod.newaydata.com/tiles/{z}/{x}/{y}.png?path=latest/aero/latest",{maxZoom:19,attribution:'© <a href="https://www.openflightmaps.org">openflightmaps.org</a>'}),"Esri Topo + SeaMarks":L.layerGroup([L.tileLayer.cached("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri, USGS"}),L.tileLayer("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:' © <a href="http://www.openseamap.org">OpenSeaMap</a> contributors',transparent:!0,zIndex:3})]),"CARTO Dark Matter":L.tileLayer.cached("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',subdomains:"abcd",maxZoom:19})},i.map&&i.map.attributionControl&&i.map.attributionControl.addAttribution('Weather data by <a href="https://open-meteo.com">Open-Meteo</a>');const e=g.state.userSettings.baseMaps in i.baseMaps?g.state.userSettings.baseMaps:"Esri Street",n=i.baseMaps[e];n&&typeof n.on=="function"?(n.on("tileerror",()=>{if(!navigator.onLine){i.hasTileErrorSwitched||(console.warn(`${e} tiles unavailable offline. Zoom restricted.`),f.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."),i.hasTileErrorSwitched=!0);return}if(!i.hasTileErrorSwitched&&i.map.hasLayer(n)){const a="OpenStreetMap";console.warn(`${e} tiles unavailable, switching to ${a}`),i.map.removeLayer(n),i.baseMaps[a].addTo(i.map),g.state.userSettings.baseMaps=a,g.save(),f.handleMessage(`${e} tiles unavailable. Switched to ${a}.`),i.hasTileErrorSwitched=!0}else i.hasTileErrorSwitched||console.warn(`Tile error in ${e}, attempting to continue.`)}),n.addTo(i.map)):(console.error(`Default base map "${e}" could not be added.`),i.baseMaps.OpenStreetMap.addTo(i.map)),i.map&&i.map.invalidateSize(),window.addEventListener("online",()=>{i.hasTileErrorSwitched=!1,i.map&&(i.map.options.minZoom=6),Ca()}),window.addEventListener("offline",()=>{i.map&&(i.map.options.minZoom=9),Ca()}),console.log("Base layers and online/offline handlers set up.")}function Zc(){i.map.createPane("gpxTrackPane"),i.map.getPane("gpxTrackPane").style.zIndex=650,i.map.getPane("tooltipPane").style.zIndex=700,i.map.getPane("popupPane").style.zIndex=700,console.log("Custom map panes created.")}function jc(){const t=i.map;if(!t){console.log("No map available");return}console.log("Leaflet-Geoman Version:",L.PM.version);const e=document.querySelector(".leaflet-pm-toolbar");e&&["click","dblclick","mousedown","mouseup","touchstart","touchend","pointerdown","pointerup","contextmenu"].forEach(v=>{e.addEventListener(v,b=>{L.DomEvent.stopPropagation(b),console.log(`Stopped '${b.type}' event on Geoman toolbar.`)})});const n=L.DomUtil.create("div","leaflet-measure-label",t.getContainer()),a=L.layerGroup().addTo(t);let r=null,o=null,s=null,l=!1;function c(h,v){const b=h[v],y=v>0?h[v-1]:null;if(!y)return;const S=v<h.length-1?h[v+1]:null,w=f.calculateBearing(y.lat,y.lng,b.lat,b.lng),M=y.distanceTo(b),E=M<1e3?`${M.toFixed(0)} m`:`${(M/1e3).toFixed(2)} km`;let k=0;for(let I=1;I<=v;I++)k+=h[I-1].distanceTo(h[I]);const _=k<1e3?`${k.toFixed(0)} m`:`${(k/1e3).toFixed(2)} km`,A=S?`${f.calculateBearing(b.lat,b.lng,S.lat,S.lng).toFixed(0)}°`:"---",T=`
            <div class="geoman-permanent-label">
                <div>In: ${w.toFixed(0)}°</div>
                <div>Out: ${A}</div>
                <div>+: ${E}</div>
                <div>∑: ${_}</div>
            </div>
        `;L.marker(b,{icon:L.divIcon({className:"geoman-label-container",html:T,iconAnchor:[-5,-5]}),pmIgnore:!0}).addTo(a)}function u(h){const v=h.getLatLng(),b=h.getRadius(),S=`<div class="geoman-permanent-label">Radius:<br> ${b<1e3?`${b.toFixed(0)} m`:`${(b/1e3).toFixed(2)} km`}</div>`,w=L.marker(v,{icon:L.divIcon({className:"geoman-label-container",html:S,iconAnchor:[0,0]}),pmIgnore:!0});w.addTo(a),h.permanentLabel=w}function d(h){if(!h||!(h instanceof L.Polyline))return;a.clearLayers();const v=h.getLatLngs();Array.isArray(v[0])?v.forEach(b=>{b.forEach((y,S)=>c(b,S))}):v.forEach((b,y)=>c(v,y)),r=JSON.stringify(v),s=h}function m(h){!h||!(h instanceof L.Circle)||(h.permanentLabel&&a.removeLayer(h.permanentLabel),u(h))}function p(){setInterval(()=>{if(s){if(s instanceof L.Polyline)JSON.stringify(s.getLatLngs())!==r&&d(s);else if(s instanceof L.Circle){const h=JSON.stringify({center:s.getLatLng(),radius:s.getRadius()});h!==o&&(m(s),o=h)}}},500)}p(),t.on("pm:drawstart",h=>{l=!1;const v=h.workingLayer;a.clearLayers(),n.style.display="block";let b,y,S,w,M;if(h.shape==="Line")if(Et()){n.innerHTML="Tap to set first point.";let k=null,_=null;w=()=>{const A=v.getLatLngs();if(A.length>0){k=A[A.length-1];const T=t.getCenter();_&&t.removeLayer(_),_=L.polyline([k,T],{color:" #3388ff",dashArray:"5, 5",weight:3,interactive:!1}).addTo(t);const C=k.distanceTo(T),I=f.calculateBearing(k.lat,k.lng,T.lat,T.lng),R=C<1e3?`${C.toFixed(0)} m`:`${(C/1e3).toFixed(2)} km`;n.innerHTML=`In: ${I.toFixed(0)}°<br>Out: ---°<br>+: ${R}`;const D=t.getSize(),P=L.point(D.x/2+20,D.y/2-40);L.DomUtil.setPosition(n,P)}else _&&(t.removeLayer(_),_=null),n.innerHTML="Tap to set first point."},y=()=>{_&&(t.removeLayer(_),_=null),setTimeout(()=>{d(v),t.fire("move")},50)},S=()=>{setTimeout(()=>{d(v),t.fire("move")},50)},t.on("move",w),v.on("pm:vertexadded",y),v.on("pm:vertexremoved",S),M=()=>{t.off("move",w),v.off("pm:vertexadded",y),v.off("pm:vertexremoved",S),_&&(t.removeLayer(_),_=null)}}else n.innerHTML="Click to set the first point.",b=k=>{const _=v.getLatLngs();if(_.length>0){const A=_[_.length-1],T=A.distanceTo(k.latlng),C=f.calculateBearing(A.lat,A.lng,k.latlng.lat,k.latlng.lng),I=T<1e3?`${T.toFixed(0)} m`:`${(T/1e3).toFixed(2)} km`;n.innerHTML=`In: ${C.toFixed(0)}°<br>Out: ---°<br>+: ${I}`,L.DomUtil.setPosition(n,k.containerPoint.add([15,-15]))}},y=()=>{setTimeout(()=>d(v),50)},S=()=>{setTimeout(()=>{d(v)},50)},t.on("mousemove",b),v.on("pm:vertexadded",y),v.on("pm:vertexremoved",S),M=()=>{t.off("mousemove",b),v.off("pm:vertexadded",y),v.off("pm:vertexremoved",S)};else if(h.shape==="Circle")if(Et()){n.innerHTML="";const k=t.getSize(),_=L.point(k.x/2,k.y/2-40);L.DomUtil.setPosition(n,_);let A=!1;w=()=>{if(A){const T=v.getLatLng();if(T){const C=t.getCenter(),I=T.distanceTo(C);v.setRadius(I);const R=I<1e3?`${I.toFixed(0)} m`:`${(I/1e3).toFixed(2)} km`;n.innerHTML=`Radius: ${R}`;const D=t.getSize(),P=L.point(D.x/2,D.y/2-40);L.DomUtil.setPosition(n,P)}}},y=()=>{if(A)E(),m(v),s=v,o=JSON.stringify({center:v.getLatLng(),radius:v.getRadius()});else{A=!0,n.innerHTML="Move map to adjust radius. Tap again to finish.";const T=t.getSize(),C=L.point(T.x/2,T.y/2-40);L.DomUtil.setPosition(n,C),t.on("move",w)}},v.on("pm:vertexadded",y),M=()=>{t.off("move",w),v.off("pm:vertexadded",y),A=!1,n.style.display="none"}}else n.innerHTML="Click and drag to draw a circle.",b=k=>{const _=v.getLatLng();if(_){const A=_.distanceTo(k.latlng),T=A<1e3?`${A.toFixed(0)} m`:`${(A/1e3).toFixed(2)} km`;n.innerHTML=`Radius: ${T}`,L.DomUtil.setPosition(n,k.containerPoint.add([15,-15]))}},t.on("mousemove",b),M=()=>t.off("mousemove",b);const E=()=>{M&&M(),n.style.display="none"};t.once("pm:create",k=>{l=!0,E(),k.shape==="Line"&&k.layer instanceof L.Polyline?d(k.layer):k.shape==="Circle"&&k.layer instanceof L.Circle&&(m(k.layer),s=k.layer,o=JSON.stringify({center:k.layer.getLatLng(),radius:k.layer.getRadius()})),k.layer.pm&&k.layer.pm.enable()}),t.once("pm:drawend",()=>{l||(console.log("Drawing was cancelled, cleaning up visuals."),E(),a.clearLayers())})}),t.on("pm:edit",h=>{if(h.shape==="Line"&&h.layer instanceof L.Polyline)setTimeout(()=>d(h.layer),300);else if(h.shape==="Circle"&&h.layer instanceof L.Circle){if(Et()){n.style.display="block";const v=h.layer.getRadius(),b=v<1e3?`${v.toFixed(0)} m`:`${(v/1e3).toFixed(2)} km`;n.innerHTML=`Radius: ${b}`;const y=t.getSize(),S=L.point(y.x/2,y.y/2-40);L.DomUtil.setPosition(n,S)}setTimeout(()=>{m(h.layer),s=h.layer,o=JSON.stringify({center:h.layer.getLatLng(),radius:h.layer.getRadius()})},300)}}),t.on("pm:editend",()=>{Et()&&(n.style.display="none")}),t.on("pm:remove",h=>{a.clearLayers(),o=null,r=null,s=null,n.style.display="none"})}function Jc(){if(!i.map){console.error("Karte nicht initialisiert in _setupCoreMapEventHandlers");return}if(!i.coordsControl){const e={enableUserInput:!1};i.coordsControl=new L.Control.Coordinates(e),i.coordsControl.addTo(i.map)}Et()?qc(i.map):Kc(i.map),i.map.on("dblclick",da),i.map.on("zoomstart",e=>{if(!navigator.onLine){const n=e.target._zoom||i.map.getZoom();n<11?(e.target._zoom=11,i.map.setZoom(11),f.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles.")):n>14&&(e.target._zoom=14,i.map.setZoom(14),f.handleMessage("Offline: Zoom restricted to levels 11–14 for cached tiles."))}}),i.map.on("zoomend",()=>{const e=i.map.getZoom(),n=new CustomEvent("map:zoomend",{detail:{zoom:e},bubbles:!0,cancelable:!0});if(i.map.getContainer().dispatchEvent(n),i.jumpRunTrackLayer&&g.state.userSettings.showJumpRunTrack){const a=i.jumpRunTrackLayer.getLayers().find(r=>{var o;return((o=r.options.icon)==null?void 0:o.options.className)==="jrt-anchor-marker"});if(a){const r=e<=11?10:e<=12?12:e<=13?14:16;a.setIcon(L.divIcon({className:"jrt-anchor-marker",html:`<div style="background-color: orange; width: ${r}px; height: ${r}px; border-radius: 50%; border: 2px solid white; opacity: 0.8;"></div>`,iconSize:[r,r],iconAnchor:[r/2,r/2],tooltipAnchor:[0,-(r/2+5)]}))}}}),i.map.on("movestart",e=>{e.target===i.map&&(!e.originalEvent||e.originalEvent.target===i.map.getContainer())&&(i.isManualPanning=!0,console.log("Manual map panning detected."))}),i.map.on("contextmenu",e=>{if(g.state.userSettings.isInteractionLocked){ot("Interaction is locked. Please unlock to place a new DIP.");return}const{lat:n,lng:a}=e.latlng;console.log('MapManager: Rechtsklick/Langes Drücken erkannt. Sende "location:selected"-Event.');const r=new CustomEvent("location:selected",{detail:{lat:n,lng:a,source:"contextmenu"},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(r)});const t=i.map.getContainer();t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-En;if(a<300&&a>0){e.preventDefault();const o=t.getBoundingClientRect(),s=e.touches[0].clientX-o.left,l=e.touches[0].clientY-o.top,c=i.map.containerPointToLatLng([s,l]);await da({latlng:c,containerPoint:L.point(s,l),layerPoint:i.map.latLngToLayerPoint(c)})}En=n},{passive:!1}),i.map.on("click",e=>{}),i.map.on("mousedown",e=>{}),t.addEventListener("touchstart",async e=>{if(e.touches.length!==1||e.target.closest(".leaflet-marker-icon"))return;const n=new Date().getTime(),a=n-En;if(a<300&&a>0){e.preventDefault();const o=t.getBoundingClientRect(),s=e.touches[0].clientX-o.left,l=e.touches[0].clientY-o.top,c=i.map.containerPointToLatLng([s,l]);await da({latlng:c,containerPoint:L.point(s,l),layerPoint:i.map.latLngToLayerPoint(c)})}En=n},{passive:!1}),jc(),console.log("All core map event handlers have been set up.")}function qc(t){const e=()=>{const n=t.getCenter(),a=g.getValue("coordFormat","Decimal"),r=f.convertCoords(n.lat,n.lng,a);let o;const s=c=>`${c.deg}° ${c.min.toFixed(3)}' ${c.dir}`,l=c=>`${c.deg}°${c.min}'${c.sec.toFixed(0)}" ${c.dir}`;a==="MGRS"?o=`MGRS: ${r.lat}`:a==="DMS"?o=`${l(r.lat)}, ${l(r.lng)}`:a==="DDM"?o=`${s(r.lat)}, ${s(r.lng)}`:o=`${n.lat.toFixed(5)}, ${n.lng.toFixed(5)}`,i.coordsControl.update(`${o}<br>Elevation: ...<br>QFE: ...`)};t.on("move",e),setTimeout(()=>t.fire("move"),200),console.log("Crosshair coordinate handler initialized.")}function Kc(t){t.on("mousemove",eu),t.on("mouseout",function(){i.coordsControl&&i.coordsControl.getContainer()&&(i.coordsControl.getContainer().innerHTML="Move mouse over map")}),console.log("Mouse coordinate handler initialized.")}async function Yc(t,e){const{latitude:n,longitude:a}=t.coords;console.log("MapManager: Geolocation erfolgreich. Sende Event."),i.lastLat=n,i.lastLng=a,i.lastAltitude=await f.getAltitude(n,a),i.map.setView([n,a],e);const r=new CustomEvent("location:selected",{detail:{lat:n,lng:a,source:"geolocation"},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(r)}async function jr(t,e,n){console.warn(`Geolocation error: ${t.message}`);const a=wc();let r,o,s,l;a?(r=a.lat,o=a.lng,s="home_dz_fallback",l=`Using your saved Home DZ: ${a.label}`):(r=e[0],o=e[1],s="geolocation_fallback",l="Unable to retrieve your location. Using default location."),f.handleMessage(l),await jn(r,o),i.map.setView([r,o],n),$n(!0),i.isManualPanning=!1;const c=new CustomEvent("location:selected",{detail:{lat:r,lng:o,source:s},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(c),console.log(`Dispatched 'location:selected' event from ${s}.`)}async function Xc(t,e){navigator.geolocation?navigator.geolocation.getCurrentPosition(n=>Yc(n,e),n=>jr(n,t,e),{enableHighAccuracy:!0,timeout:je.GEOLOCATION_TIMEOUT_MS,maximumAge:0}):(console.warn("Geolocation not supported."),await jr({message:"Geolocation not supported by this browser."},t,e))}function Qc(t){if(!i.map||!i.map.pm)return;const e=document.querySelector(".leaflet-pm-toolbar");t?(e&&(e.style.display="none"),i.map.pm.globalDrawModeEnabled()&&i.map.pm.disableDraw(),i.map.pm.globalEditModeEnabled()&&i.map.pm.disableGlobalEditMode(),i.map.pm.globalRemovalModeEnabled()&&i.map.pm.disableGlobalRemovalMode()):e&&(e.style.display="block")}function eu(t){const{lat:e,lng:n}=t.latlng;i.lastMouseLatLng={lat:e,lng:n};const a=g.getValue("coordFormat","radio","Decimal");let r;const o=l=>`${l.deg}° ${l.min.toFixed(3)}' ${l.dir}`,s=l=>`${l.deg}°${l.min}'${l.sec.toFixed(0)}" ${l.dir}`;a==="MGRS"?r=`MGRS: ${f.decimalToMgrs(e,n)||"N/A"}`:a==="DMS"?r=`Lat: ${s(f.decimalToDms(e,!0))}, Lng: ${s(f.decimalToDms(n,!1))}`:a==="DDM"?r=`Lat: ${o(f.decimalToDecimalMinutes(e,!0))}, Lng: ${o(f.decimalToDecimalMinutes(n,!1))}`:r=`Lat: ${e.toFixed(5)}, Lng: ${n.toFixed(5)}`,i.coordsControl&&i.coordsControl.update(`${r}<br>Elevation: Fetching...<br>QFE: Fetching...`),f.debouncedGetElevationAndQFE(e,n,({elevation:l})=>{var c,u;if(i.lastMouseLatLng&&i.coordsControl&&Math.abs(i.lastMouseLatLng.lat-e)<.05&&Math.abs(i.lastMouseLatLng.lng-n)<.05){const d=g.getValue("heightUnit","radio","m");let m=l==="N/A"?"N/A":Math.round(f.convertHeight(l,d)),p="N/A";if(l!=="N/A"&&i.weatherData&&i.weatherData.surface_pressure){const h=parseInt((c=document.getElementById("timeSlider"))==null?void 0:c.value)||0,v=i.weatherData.surface_pressure[h],b=((u=i.weatherData.temperature_2m)==null?void 0:u[h])||15,y=i.lastAltitude!=="N/A"?i.lastAltitude:0,S=f.calculateQFE(v,l,y,b);p=S!=="N/A"?`${S} hPa`:"N/A"}i.coordsControl.update(`${r}<br>Elevation: ${m} ${m==="N/A"?"":d}<br>QFE: ${p}`)}})}function da(t){if(g.state.userSettings.isInteractionLocked){ot("Interaction is locked. Please unlock to move points.");return}if(!g.state.userSettings.showCutAwayFinder)return;const{lat:e,lng:n}=t.latlng;i.cutAwayMarker?i.cutAwayMarker.setLatLng([e,n]):(i.cutAwayMarker=xc(e,n).addTo(i.map),Fc(i.cutAwayMarker)),i.cutAwayLat=e,i.cutAwayLng=n,Li(i.cutAwayMarker,e,n);const a=new CustomEvent("cutaway:marker_placed",{bubbles:!0});i.map.getContainer().dispatchEvent(a)}function $n(t=!1){i.isManualPanning&&!t||i.map&&i.currentMarker&&i.map.panTo(i.currentMarker.getLatLng())}let ma=null;function tu(t,e){const n=document.getElementById("windspinne-chart");if(!n)return;const a=n.getContext("2d"),r=getComputedStyle(document.body),o=t.map(w=>w.height),s=t.map(w=>w.dir),l=t.map(w=>f.convertWind(w.spd,"m/s","km/h")),c=Math.max(...o),u=Math.min(c,e+i.lastAltitude),d=e,m=w=>w<=5?r.getPropertyValue("--wind-low").trim():w<=10?r.getPropertyValue("--wind-moderate").trim():w<=15?r.getPropertyValue("--wind-high").trim():w<=20?r.getPropertyValue("--wind-very-high").trim():r.getPropertyValue("--wind-extreme").trim(),p=[];for(let w=i.lastAltitude;w<=u;w+=50){const M=w-i.lastAltitude;M>=0&&p.push({r:M,t:f.linearInterpolateAngle(o,s,w),speed:f.linearInterpolate(o,l,w)*1.94384})}const h=[],v=d<=4e3?200:500;for(let w=i.lastAltitude;w<=u;w+=v){const M=w-i.lastAltitude;M>=0&&h.push({r:M,t:f.linearInterpolateAngle(o,s,w),speed:f.linearInterpolate(o,l,w)*1.94384})}const b=w=>w.map(M=>({x:M.r*Math.cos((90-M.t)*Math.PI/180),y:M.r*Math.sin((90-M.t)*Math.PI/180),original:M}));ma&&ma.destroy(),ma=new Chart(a,{type:"scatter",data:{datasets:[{data:b(p),showLine:!0,pointRadius:0,segment:{borderColor:w=>m((w.p0.raw.original.speed+w.p1.raw.original.speed)/2),borderWidth:2.5}},{data:b(h),showLine:!1,pointRadius:3,pointBackgroundColor:w=>m(w.raw.original.speed)}]},options:{maintainAspectRatio:!1,layout:{padding:{bottom:25,left:25,right:25}},scales:{x:{display:!1,min:-d,max:d},y:{display:!1,min:-d,max:d}},plugins:{title:{display:!0,text:"Wind chart for current location",font:{size:16},padding:{top:5,bottom:35},color:r.getPropertyValue("--text-primary").trim()},legend:{display:!1},tooltip:{filter:w=>w.datasetIndex===1,callbacks:{label:w=>`${w.raw.original.r}m: ${Math.round(w.raw.original.t)}° / ${Math.round(w.raw.original.speed)} kt`}}}},plugins:[{id:"polarGrid",beforeDraw:w=>{const{ctx:M,scales:{x:E,y:k}}=w;if(!w.chartArea)return;const _=E.getPixelForValue(0),A=k.getPixelForValue(0);M.save(),M.font="10px Roboto";const T=d<=4e3?200:500,C=1e3,I=r.getPropertyValue("--border-color").trim(),R=r.getPropertyValue("--text-secondary").trim();M.strokeStyle=I,M.lineWidth=.5;for(let F=T;F<=d;F+=T)if(F%C!==0){const N=Math.abs(E.getPixelForValue(F)-_),U=Math.abs(k.getPixelForValue(F)-A);M.beginPath(),M.ellipse(_,A,N,U,0,0,2*Math.PI),M.stroke()}M.strokeStyle=I,M.lineWidth=1.5;for(let F=C;F<=d;F+=C){const N=Math.abs(E.getPixelForValue(F)-_),U=Math.abs(k.getPixelForValue(F)-A);M.beginPath(),M.ellipse(_,A,N,U,0,0,2*Math.PI),M.stroke(),M.fillStyle=R,M.fillText(`${F}m`,_+5,A-U-5)}const D=(w.chartArea.right-w.chartArea.left)/2,P=(w.chartArea.bottom-w.chartArea.top)/2;M.strokeStyle=I,M.lineWidth=1;for(let F=0;F<360;F+=30){const N=(F-90)*(Math.PI/180);M.beginPath(),M.moveTo(_,A),M.lineTo(_+D*Math.cos(N),A+P*Math.sin(N)),M.stroke(),M.save(),M.translate(_+(D+15)*Math.cos(N),A+(P+15)*Math.sin(N)),M.rotate(N+Math.PI/2),M.textAlign="center",M.fillText(`${F}°`,0,0),M.restore()}M.restore()}}]});const y=document.getElementById("windspinne-legend");y.innerHTML="",[{speed:"0-5 kt",color:r.getPropertyValue("--wind-low").trim()},{speed:"6-10 kt",color:r.getPropertyValue("--wind-moderate").trim()},{speed:"11-15 kt",color:r.getPropertyValue("--wind-high").trim()},{speed:"16-20 kt",color:r.getPropertyValue("--wind-very-high").trim()},{speed:"> 20 kt",color:r.getPropertyValue("--wind-extreme").trim()}].forEach(w=>{const M=document.createElement("div");M.className="legend-item",M.innerHTML=`<div class="legend-color-box" style="background-color: ${w.color};"></div><span>${w.speed}</span>`,y.appendChild(M)})}async function nt(t,e,n,a=null){var I,R,D,P,F;console.log(`updateWeatherDisplay called for index: ${t} -> into ${e}`);const r=document.getElementById(e),o=document.getElementById(n);if(!r||!o){console.error("Target container(s) for weather display not found!",{tableContainerId:e,timeContainerId:n});return}if(!i.weatherData||!i.weatherData.time||t<0||t>=i.weatherData.time.length){console.error("No weather data available or index out of bounds:",t),r.innerHTML='<p style="padding: 20px; text-align: center;">No weather data available</p>',o.innerHTML="Selected Time: ";const N=document.getElementById("timeSlider");N&&(N.value=0);return}const s=(I=i.weatherData.visibility)==null?void 0:I[t],l=(R=i.weatherData.weather_code)==null?void 0:R[t],c=f.translateWmoCodeToTaf(l);console.log(`--- Bodenwetter für Index ${t} ---`),console.log(`Sichtweite (Visibility): ${s??"N/A"} m`),console.log(`Wetter-Code (WMO 4677): ${l??"N/A"} (${c})`),console.log("---------------------------------"),i.landingWindDir=i.weatherData.wind_direction_10m[t]||null,console.log("landingWindDir updated to:",i.landingWindDir);const u=document.getElementById("customLandingDirectionLL"),d=document.getElementById("customLandingDirectionRR");u&&d&&i.landingWindDir!==null&&(u.value=Math.round(i.landingWindDir),d.value=Math.round(i.landingWindDir));const m=((D=document.getElementById("refLevel"))==null?void 0:D.value)||"AGL",p=g.getValue("heightUnit","radio","m"),h=g.getValue("windUnit","radio","kt"),v=g.getValue("temperatureUnit","radio","C"),b=g.getValue("timeZone","radio","Z"),y=await f.getDisplayTime(i.weatherData.time[t],i.lastLat,i.lastLng,b),S=Ke(),w=Se(i.weatherData,t,S,Math.round(i.lastAltitude),p),M=m==="AMSL"&&i.lastAltitude!=="N/A"?Math.round(i.lastAltitude):0,k=getComputedStyle(document.body).getPropertyValue("--text-primary").trim(),_=parseInt((P=document.getElementById("upperLimit"))==null?void 0:P.value)||3e3,T=w.filter(N=>N.displayHeight<=_).map(N=>{const U=parseFloat(N.spd);let G="";if(h==="bft"){const ce=f.convertWind(U,"kt","km/h"),de=f.knotsToBeaufort(ce);de<=1?G="wind-low":de<=3?G="wind-moderate":de<=4?G="wind-high":G="wind-very-high"}else{const ce=f.convertWind(U,"kt","km/h");ce<=3?G="wind-low":ce<=10?G="wind-moderate":ce<=16?G="wind-high":G="wind-very-high"}const O=N.cc;let V="";O!=="N/A"&&Number.isFinite(O)&&(O<=10?V="cloud-cover-clear":O<=25?V="cloud-cover-few":O<=50?V="cloud-cover-scattered":O<=87?V="cloud-cover-broken":V="cloud-cover-overcast");const z=m==="AMSL"?N.displayHeight+(p==="ft"?Math.round(M*3.28084):M):N.displayHeight,Y=f.convertTemperature(N.temp,v==="C"?"°C":"°F"),ee=Y==="N/A"?"N/A":Y.toFixed(0),Q=f.convertWind(U,h,"km/h");let q,se=!1;const he=m==="AMSL"?p==="ft"?Math.round(M*3.28084):M:0;if(Math.round(N.displayHeight)===he)if(f.convertWind(U,"kt","km/h")>Ur.SURFACE_WIND_WARNING_KT&&(se=!0),i.weatherData.wind_gusts_10m[t]!==void 0&&Number.isFinite(i.weatherData.wind_gusts_10m[t])){const de=i.weatherData.wind_gusts_10m[t],Ae=f.convertWind(de,h,"km/h"),st=f.convertWind(de,"kt","km/h"),j=h==="bft"?Math.round(Q):Q.toFixed(0);let X=h==="bft"?Math.round(Ae):Ae.toFixed(0);st>Ur.GUST_WARNING_KT&&(X=`<span class="gust-exceeds-threshold">${X}</span>`),q=`${j} G ${X}`}else q=Q==="N/A"?"N/A":h==="bft"?Math.round(Q):Q.toFixed(0);else q=Q==="N/A"?"N/A":h==="bft"?Math.round(Q):Q.toFixed(0);const ve=Math.round(f.convertWind(U,"kt","km/h")/5)*5,Le=N.dir==="N/A"||isNaN(ve)?"N/A":f.generateWindBarb(N.dir,ve,null,k);return`<tr class="${G} ${V}">
                    <td>${Math.round(z)}</td>
                    <td>${f.roundToTens(N.dir)}</td>
                    <td class="${se?"wind-speed-exceeds-threshold":""}">${q}</td>
                    <td>${Le}</td>
                    <td>${ee}</td>
                    <td>${Math.round(N.rh)}</td>
                    <td>${N.cc}</td>
                </tr>`}).join(""),C=`
        <table id="weatherTable">
            <thead>
                <tr>
                    <th>Height (${p} ${m})</th>
                    <th>Dir (deg)</th>
                    <th>Spd (${h})</th>
                    <th>Wind</th>
                    <th>T (${v==="C"?"°C":"°F"})</th>
                    <th>RH (%)</th>
                    <th>CC (%)</th> <!-- NEUE SPALTE für Wolkenbedeckung -->
                </tr>
            </thead>
            <tbody>
                ${T}
            </tbody>
        </table>`;if(r.innerHTML=C,o.innerHTML=`Selected Time: ${y}`,w.length>0){const N=parseInt((F=document.getElementById("upperLimit"))==null?void 0:F.value)||3e3;tu(w,N)}}async function et(t=!1,e=!1){var m;if(!i.currentMarker||i.lastLat===null)return;const n=i.lastLat,a=i.lastLng,r=i.lastAltitude,o=g.getValue("heightUnit","radio","m");let s="N/A",l=o,c="N/A";if(r!=="N/A"&&(s=Math.round(f.convertHeight(r,o))),r!=="N/A"&&i.weatherData&&i.weatherData.surface_pressure){const p=fi(),h=i.weatherData.surface_pressure[p],v=((m=i.weatherData.temperature_2m)==null?void 0:m[p])||15,b=f.calculateQFE(h,r,r,v);b!=="N/A"&&(c=`${b} hPa`)}const u=`<br>Alt: ${s} ${l}<br>QFE: ${c}`;let d="";if(t){const p=f.decimalToDms(n,!0),h=f.decimalToDecimalMinutes(n,!0),v=f.decimalToDms(a,!1),b=f.decimalToDecimalMinutes(a,!1);d=`
            <div style="font-size: 11px; line-height: 1.4;">
                Decimal: ${n.toFixed(5)}, ${a.toFixed(5)}<br>
                DDM: ${h.deg}° ${h.min.toFixed(3)}' ${h.dir}, ${b.deg}° ${b.min.toFixed(3)}' ${b.dir}<br>
                DMS: ${p.deg}°${p.min}'${p.sec.toFixed(0)}" ${p.dir}, ${v.deg}°${v.min}'${v.sec.toFixed(0)}" ${v.dir}<br>
                MGRS: ${f.decimalToMgrs(n,a)}
            </div>
            ${u}<br>
            <a href="#" class="toggle-coords-format" data-marker-type="dip" data-expanded="true" style="font-size: 11px;">Show less</a>
        `}else{const p=g.getValue("coordFormat","radio","Decimal"),h=f.convertCoords(n,a,p),v=S=>`${S.deg}° ${S.min.toFixed(3)}' ${S.dir}`,b=S=>`${S.deg}°${S.min}'${S.sec.toFixed(0)}" ${S.dir}`;let y="";p==="MGRS"?y=`MGRS: ${h.lat}`:p==="DMS"?y=`Lat: ${b(h.lat)}<br>Lng: ${b(h.lng)}`:p==="DDM"?y=`Lat: ${v(h.lat)}<br>Lng: ${v(h.lng)}`:y=`Lat: ${h.lat}<br>Lng: ${h.lng}`,d=`
            ${y}
            ${u}<br>
            <a href="#" class="toggle-coords-format" data-marker-type="dip" data-expanded="false" style="font-size: 11px;">Show more</a>
        `}Jn(i.currentMarker,d,e)}function Si(){const t=document.getElementById("modelInfoPopup"),e=document.getElementById("modelSelect");if(!t||!e)return;const n=e.value,a=i.lastModelRun||"N/A",r=`Model: ${n.replace(/_/g," ").toUpperCase()}\\nRun: ${a}`;t.innerHTML=r.replace(/\\n/g,"<br>")}async function er(){const t=document.getElementById("timeSlider"),e=document.getElementById("slider-labels");if(!t||!e||!i.weatherData||!i.weatherData.time){e&&(e.innerHTML="");return}e.innerHTML="";const n=i.weatherData.time,a=parseInt(t.max,10);if(a<=0)return;const r=g.getValue("timeZone","radio","Z");let o="utc";r==="loc"&&Number.isFinite(i.lastLat)&&Number.isFinite(i.lastLng)&&(o=(await f.getLocationData(i.lastLat,i.lastLng)).timezone||"utc");let s=null;for(let l=0;l<n.length;l++){const c=n[l],u=$.fromISO(c,{zone:"utc"}).setZone(o),d=u.day;if(d!==s){let m=l,p=Math.abs(u.hour);for(let h=1;h<4&&l+h<n.length;h++){const v=$.fromISO(n[l+h],{zone:"utc"}).setZone(o);if(v.day===d)Math.abs(v.hour)<p&&(p=Math.abs(v.hour),m=l+h);else break}if(d!==s){const h=document.createElement("div");h.className="slider-label",h.textContent=u.toFormat("MMM dd");const v=m/a*100;m===0?(h.style.left="0",h.style.transform="translateX(0)"):v>98?(h.style.left="100%",h.style.transform="translateX(-100%)"):(h.style.left=`${v}%`,h.style.transform="translateX(0)"),e.appendChild(h),s=d}}}}function tr(t){const e=document.getElementById("slider-track-highlight"),n=document.getElementById("timeSlider");if(!e||!n)return;const a=parseInt(n.max)+1;if(a<=0||t.length===0){e.style.background="var(--background-interactive)";return}const r=[],o="var(--color-danger)",s="var(--background-interactive)";for(let l=0;l<a;l++){const c=t.includes(l)?o:s,u=l/a*100,d=(l+1)/a*100;r.push(`${c} ${u}%`),r.push(`${c} ${d}%`)}e.style.background=`linear-gradient(to right, ${r.join(", ")})`}function xe(){if(!i.currentMarker||typeof i.currentMarker.getLatLng!="function")return;const t=i.currentMarker.getLatLng();if(!t)return;if(!g.state.userSettings.showLandingPattern||!i.weatherData||i.map.getZoom()<je.LANDING_PATTERN_MIN_ZOOM){en(null);return}const e=parseInt(document.getElementById("timeSlider").value)||0,n=Ke(),a=g.getValue("heightUnit","m"),r=g.getValue("windUnit","kt"),o=Math.round(i.lastAltitude),s=Se(i.weatherData,e,n,o,a);if(!s||s.length===0){en(null);return}const l=Zn(t.lat,t.lng,s);if(!l){en(null);return}const{downwindStart:c,baseStart:u,finalStart:d,landingPoint:m}=l,p=s.map(T=>T.height),h=s.map(T=>-f.convertWind(T.spd,"kt","km/h")*Math.sin(T.dir*Math.PI/180)),v=s.map(T=>-f.convertWind(T.spd,"kt","km/h")*Math.cos(T.dir*Math.PI/180)),b=parseInt(document.getElementById("legHeightFinal").value)||100,y=parseInt(document.getElementById("legHeightBase").value)||200,S=parseInt(document.getElementById("legHeightDownwind").value)||300,w=f.calculateMeanWind(p,h,v,o,o+b),M=f.calculateMeanWind(p,h,v,o+b,o+y),E=f.calculateMeanWind(p,h,v,o+y,o+S),k=T=>T<=3?"lightblue":T<=10?"lightgreen":T<=16?"#f5f34f":"#ffcccc",_=T=>{const C=f.convertWind(T,r,"kt");return r==="bft"?Math.round(C):C.toFixed(1)},A={legs:[{path:[m,d]},{path:[d,u]},{path:[u,c]}],arrows:[{position:[(m[0]+d[0])/2,(m[1]+d[1])/2],bearing:(w[0]-90+180)%360,color:k(w[1]),tooltipText:`${Math.round(w[0])}° ${_(w[1])} ${r}`},{position:[(d[0]+u[0])/2,(d[1]+u[1])/2],bearing:(M[0]-90+180)%360,color:k(M[1]),tooltipText:`${Math.round(M[0])}° ${_(M[1])} ${r}`},{position:[(u[0]+c[0])/2,(u[1]+c[1])/2],bearing:(E[0]-90+180)%360,color:k(E[1]),tooltipText:`${Math.round(E[0])}° ${_(E[1])} ${r}`}]};en(A)}function be(){var c,u,d,m,p,h,v,b;if(console.log("updateJumpRunTrackDisplay called"),!i.map){console.warn("Map not initialized, cannot update jump run track display");return}if(!(g.state.userSettings.showJumpRunTrack&&i.weatherData&&i.lastLat&&i.lastLng&&g.state.userSettings.calculateJump)){console.log("Conditions not met to show JRT, clearing display."),rn(null),i.lastTrackData=null;const y=document.getElementById("jumpRunTrackDirection");y&&!g.state.userSettings.customJumpRunDirection&&(y.value="");return}const e=fi(),n=Ke(),a=g.getValue("heightUnit","radio","m"),r=Se(i.weatherData,e,n,Math.round(i.lastAltitude),a),o=i.harpMarker?i.harpMarker.getLatLng():null,s=Ja(r,o),l=document.getElementById("jumpRunTrackDirection");if(s&&((c=s.latlngs)==null?void 0:c.length)===2&&s.latlngs.every(y=>Number.isFinite(y[0])&&Number.isFinite(y[1]))){console.log("Drawing jump run track with data:",s),l&&!g.state.userSettings.customJumpRunDirection&&(l.value=s.direction);const y={path:{latlngs:s.latlngs,options:{color:"orange",weight:5,opacity:.8},tooltipText:`Jump Run: ${s.direction}°, ${s.trackLength} m`,originalLatLngs:((d=(u=i.lastTrackData)==null?void 0:u.latlngs)==null?void 0:d.length)===2?i.lastTrackData.latlngs:s.latlngs},approachPath:((m=s.approachLatLngs)==null?void 0:m.length)===2&&s.approachLatLngs.every(S=>Number.isFinite(S[0])&&Number.isFinite(S[1]))?{latlngs:s.approachLatLngs,options:{color:"orange",weight:5,opacity:.8,dashArray:"5, 10"},tooltipText:`Approach: ${s.direction}°, ${s.approachLength} m`,originalLatLngs:((h=(p=i.lastTrackData)==null?void 0:p.approachLatLngs)==null?void 0:h.length)===2?i.lastTrackData.approachLatLngs:s.approachLatLngs}:null,trackLength:s.trackLength,airplane:{position:L.latLng(s.latlngs[1][0],s.latlngs[1][1]),bearing:s.direction,originalPosition:(b=(v=i.lastTrackData)==null?void 0:v.latlngs)!=null&&b[1]&&Number.isFinite(i.lastTrackData.latlngs[1][0])?L.latLng(i.lastTrackData.latlngs[1][0],i.lastTrackData.latlngs[1][1]):L.latLng(s.latlngs[1][0],s.latlngs[1][1])}};rn(y),i.lastTrackData={latlngs:s.latlngs,approachLatLngs:s.approachLatLngs,direction:s.direction,trackLength:s.trackLength,approachLength:s.approachLength},console.log("Updated AppState.lastTrackData:",i.lastTrackData)}else console.warn("No valid track data to display:",s),rn(null),i.lastTrackData=null,l&&!g.state.userSettings.customJumpRunDirection&&(l.value="")}const nu=Object.freeze(Object.defineProperty({__proto__:null,refreshMarkerPopup:et,updateAlertSliderBackground:tr,updateJumpRunTrackDisplay:be,updateLandingPatternDisplay:xe,updateModelInfoPopup:Si,updateSliderLabels:er,updateWeatherDisplay:nt},Symbol.toStringTag,{value:"Module"}));let Qe=null;function nr(){const t=document.getElementById("locationSearchInput"),e=document.getElementById("locationResults"),n=document.getElementById("clearSearchInput"),a=document.getElementById("saveFavoriteBtn"),r=document.getElementById("favoriteModal"),o=document.getElementById("favoriteNameInput"),s=document.getElementById("submitFavoriteName"),l=document.getElementById("cancelFavoriteName");if(!t||!e||!a||!r){console.error("Einige UI-Elemente für die Ortssuche wurden nicht gefunden.");return}const c=f.debounce(ou,300);t.addEventListener("input",()=>{c(t.value),n.style.display=t.value.trim()?"block":"none"}),n.addEventListener("click",()=>{t.value="",n.style.display="none",ft(),t.focus()}),a.addEventListener("click",()=>{if(i.lastLat===null||i.lastLng===null){f.handleError("Please select a location on the map first.");return}Qe={lat:i.lastLat,lng:i.lastLng,defaultName:`DIP at ${i.lastLat.toFixed(4)}, ${i.lastLng.toFixed(4)}`},o.value=Qe.defaultName,r.style.display="flex"}),s.addEventListener("click",()=>{if(Qe){const u=o.value.trim()||Qe.defaultName;wi(Qe.lat,Qe.lng,u),ft()}r.style.display="none",Qe=null}),l.addEventListener("click",()=>{r.style.display="none",Qe=null}),ft(),document.addEventListener("favorites:updated",()=>{console.log("[Coordinates] Received favorites:updated event. Rerendering list."),ft()})}function ft(t=[]){const e=document.getElementById("locationResults");if(!e)return;e.innerHTML="";const n=Ye(),a=n.filter(s=>s.isFavorite),r=n.filter(s=>!s.isFavorite),o=(s,l)=>{if(l.length===0)return;const c=document.createElement("div");c.className="search-section";const u=document.createElement("h5");u.textContent=s,c.appendChild(u);const d=document.createElement("ul");l.forEach(m=>{const p=au(m);p&&d.appendChild(p)}),c.appendChild(d),e.appendChild(c)};o("Results",t),o("Favorites",a),o("Recent Searches",r)}function au(t){const e=parseFloat(t.lat),n=parseFloat(t.lng||t.lon);if(isNaN(e)||isNaN(n))return null;const a=document.createElement("li");a.className="search-item";const r=document.createElement("div");r.className="search-item-text",r.innerHTML=`<span class="name">${t.display_name||t.label}</span>`,r.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("location:selected",{detail:{lat:e,lng:n,source:"search"},bubbles:!0})),yi(e,n,t.display_name||t.label,t.isFavorite),document.querySelector('.tab-button[data-panel="map"]').click()}),a.appendChild(r);const o=document.createElement("div");if(o.className="search-item-actions",t.isFavorite){const c=document.createElement("button");c.innerHTML="🏠",c.title="Set as Home DZ",c.className=`home-toggle ${t.isHomeDZ?"is-home":""}`,c.addEventListener("click",u=>{u.stopPropagation(),t.isHomeDZ?yc():pc(e,n),ft()}),o.appendChild(c)}const s=document.createElement("button");s.className=`favorite-toggle ${t.isFavorite?"is-favorite":""}`,s.innerHTML="★",s.title="Toggle favorite",s.addEventListener("click",c=>{c.stopPropagation(),ru(e,n,t.display_name||t.label)}),o.appendChild(s);const l=document.createElement("button");return l.className="delete-btn",l.textContent="×",l.title="Delete this entry",l.addEventListener("click",c=>{c.stopPropagation(),confirm(`Delete "${t.display_name||t.label}"?`)&&(Lc(e,n),ft())}),o.appendChild(l),a.appendChild(o),a}function ru(t,e,n,a){const r=Ye().find(s=>Math.abs(s.lat-t)<1e-4&&Math.abs(s.lng-e)<1e-4);if(r&&r.isFavorite)vc(t,e,n,!1);else{Qe={lat:t,lng:e,defaultName:n};const s=document.getElementById("favoriteModal"),l=document.getElementById("favoriteNameInput");l.value=n;const c=()=>{const d=l.value.trim()||Qe.defaultName;wi(t,e,d),s.style.display="none"},u=()=>{s.style.display="none"};document.getElementById("submitFavoriteName").onclick=c,document.getElementById("cancelFavoriteName").onclick=u,s.style.display="block"}}async function ou(t){if(!t.trim()){ft();return}const e=await gc(t);ft(e)}const iu=Object.freeze(Object.defineProperty({__proto__:null,initializeLocationSearch:nr},Symbol.toStringTag,{value:"Module"})),su=null,lu=null,cu=null;/*! Capacitor: https://capacitorjs.com/ - MIT License */var Ht;(function(t){t.Unimplemented="UNIMPLEMENTED",t.Unavailable="UNAVAILABLE"})(Ht||(Ht={}));class ha extends Error{constructor(e,n,a){super(e),this.message=e,this.code=n,this.data=a}}const uu=t=>{var e,n;return t!=null&&t.androidBridge?"android":!((n=(e=t==null?void 0:t.webkit)===null||e===void 0?void 0:e.messageHandlers)===null||n===void 0)&&n.bridge?"ios":"web"},du=t=>{const e=t.CapacitorCustomPlatform||null,n=t.Capacitor||{},a=n.Plugins=n.Plugins||{},r=()=>e!==null?e.name:uu(t),o=()=>r()!=="web",s=m=>{const p=u.get(m);return!!(p!=null&&p.platforms.has(r())||l(m))},l=m=>{var p;return(p=n.PluginHeaders)===null||p===void 0?void 0:p.find(h=>h.name===m)},c=m=>t.console.error(m),u=new Map,d=(m,p={})=>{const h=u.get(m);if(h)return console.warn(`Capacitor plugin "${m}" already registered. Cannot register plugins twice.`),h.proxy;const v=r(),b=l(m);let y;const S=async()=>(!y&&v in p?y=typeof p[v]=="function"?y=await p[v]():y=p[v]:e!==null&&!y&&"web"in p&&(y=typeof p.web=="function"?y=await p.web():y=p.web),y),w=(T,C)=>{var I,R;if(b){const D=b==null?void 0:b.methods.find(P=>C===P.name);if(D)return D.rtype==="promise"?P=>n.nativePromise(m,C.toString(),P):(P,F)=>n.nativeCallback(m,C.toString(),P,F);if(T)return(I=T[C])===null||I===void 0?void 0:I.bind(T)}else{if(T)return(R=T[C])===null||R===void 0?void 0:R.bind(T);throw new ha(`"${m}" plugin is not implemented on ${v}`,Ht.Unimplemented)}},M=T=>{let C;const I=(...R)=>{const D=S().then(P=>{const F=w(P,T);if(F){const N=F(...R);return C=N==null?void 0:N.remove,N}else throw new ha(`"${m}.${T}()" is not implemented on ${v}`,Ht.Unimplemented)});return T==="addListener"&&(D.remove=async()=>C()),D};return I.toString=()=>`${T.toString()}() { [capacitor code] }`,Object.defineProperty(I,"name",{value:T,writable:!1,configurable:!1}),I},E=M("addListener"),k=M("removeListener"),_=(T,C)=>{const I=E({eventName:T},C),R=async()=>{const P=await I;k({eventName:T,callbackId:P},C)},D=new Promise(P=>I.then(()=>P({remove:R})));return D.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await R()},D},A=new Proxy({},{get(T,C){switch(C){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return b?_:E;case"removeListener":return k;default:return M(C)}}});return a[m]=A,u.set(m,{name:m,proxy:A,platforms:new Set([...Object.keys(p),...b?[v]:[]])}),A};return n.convertFileSrc||(n.convertFileSrc=m=>m),n.getPlatform=r,n.handleError=c,n.isNativePlatform=o,n.isPluginAvailable=s,n.registerPlugin=d,n.Exception=ha,n.DEBUG=!!n.DEBUG,n.isLoggingEnabled=!!n.isLoggingEnabled,n},mu=t=>t.Capacitor=du(t),On=mu(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),ar=On.registerPlugin;class Ei{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(e,n){let a=!1;this.listeners[e]||(this.listeners[e]=[],a=!0),this.listeners[e].push(n);const o=this.windowListeners[e];o&&!o.registered&&this.addWindowListener(o),a&&this.sendRetainedArgumentsForEvent(e);const s=async()=>this.removeListener(e,n);return Promise.resolve({remove:s})}async removeAllListeners(){this.listeners={};for(const e in this.windowListeners)this.removeWindowListener(this.windowListeners[e]);this.windowListeners={}}notifyListeners(e,n,a){const r=this.listeners[e];if(!r){if(a){let o=this.retainedEventArguments[e];o||(o=[]),o.push(n),this.retainedEventArguments[e]=o}return}r.forEach(o=>o(n))}hasListeners(e){var n;return!!(!((n=this.listeners[e])===null||n===void 0)&&n.length)}registerWindowListener(e,n){this.windowListeners[n]={registered:!1,windowEventName:e,pluginEventName:n,handler:a=>{this.notifyListeners(n,a)}}}unimplemented(e="not implemented"){return new On.Exception(e,Ht.Unimplemented)}unavailable(e="not available"){return new On.Exception(e,Ht.Unavailable)}async removeListener(e,n){const a=this.listeners[e];if(!a)return;const r=a.indexOf(n);this.listeners[e].splice(r,1),this.listeners[e].length||this.removeWindowListener(this.windowListeners[e])}addWindowListener(e){window.addEventListener(e.windowEventName,e.handler),e.registered=!0}removeWindowListener(e){e&&(window.removeEventListener(e.windowEventName,e.handler),e.registered=!1)}sendRetainedArgumentsForEvent(e){const n=this.retainedEventArguments[e];n&&(delete this.retainedEventArguments[e],n.forEach(a=>{this.notifyListeners(e,a)}))}}const Jr=t=>encodeURIComponent(t).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),qr=t=>t.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class hu extends Ei{async getCookies(){const e=document.cookie,n={};return e.split(";").forEach(a=>{if(a.length<=0)return;let[r,o]=a.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");r=qr(r).trim(),o=qr(o).trim(),n[r]=o}),n}async setCookie(e){try{const n=Jr(e.key),a=Jr(e.value),r=`; expires=${(e.expires||"").replace("expires=","")}`,o=(e.path||"/").replace("path=",""),s=e.url!=null&&e.url.length>0?`domain=${e.url}`:"";document.cookie=`${n}=${a||""}${r}; path=${o}; ${s};`}catch(n){return Promise.reject(n)}}async deleteCookie(e){try{document.cookie=`${e.key}=; Max-Age=0`}catch(n){return Promise.reject(n)}}async clearCookies(){try{const e=document.cookie.split(";")||[];for(const n of e)document.cookie=n.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(e){return Promise.reject(e)}}async clearAllCookies(){try{await this.clearCookies()}catch(e){return Promise.reject(e)}}}ar("CapacitorCookies",{web:()=>new hu});const gu=async t=>new Promise((e,n)=>{const a=new FileReader;a.onload=()=>{const r=a.result;e(r.indexOf(",")>=0?r.split(",")[1]:r)},a.onerror=r=>n(r),a.readAsDataURL(t)}),fu=(t={})=>{const e=Object.keys(t);return Object.keys(t).map(r=>r.toLocaleLowerCase()).reduce((r,o,s)=>(r[o]=t[e[s]],r),{})},pu=(t,e=!0)=>t?Object.entries(t).reduce((a,r)=>{const[o,s]=r;let l,c;return Array.isArray(s)?(c="",s.forEach(u=>{l=e?encodeURIComponent(u):u,c+=`${o}=${l}&`}),c.slice(0,-1)):(l=e?encodeURIComponent(s):s,c=`${o}=${l}`),`${a}&${c}`},"").substr(1):null,yu=(t,e={})=>{const n=Object.assign({method:t.method||"GET",headers:t.headers},e),r=fu(t.headers)["content-type"]||"";if(typeof t.data=="string")n.body=t.data;else if(r.includes("application/x-www-form-urlencoded")){const o=new URLSearchParams;for(const[s,l]of Object.entries(t.data||{}))o.set(s,l);n.body=o.toString()}else if(r.includes("multipart/form-data")||t.data instanceof FormData){const o=new FormData;if(t.data instanceof FormData)t.data.forEach((l,c)=>{o.append(c,l)});else for(const l of Object.keys(t.data))o.append(l,t.data[l]);n.body=o;const s=new Headers(n.headers);s.delete("content-type"),n.headers=s}else(r.includes("application/json")||typeof t.data=="object")&&(n.body=JSON.stringify(t.data));return n};class wu extends Ei{async request(e){const n=yu(e,e.webFetchExtra),a=pu(e.params,e.shouldEncodeUrlParams),r=a?`${e.url}?${a}`:e.url,o=await fetch(r,n),s=o.headers.get("content-type")||"";let{responseType:l="text"}=o.ok?e:{};s.includes("application/json")&&(l="json");let c,u;switch(l){case"arraybuffer":case"blob":u=await o.blob(),c=await gu(u);break;case"json":c=await o.json();break;case"document":case"text":default:c=await o.text()}const d={};return o.headers.forEach((m,p)=>{d[p]=m}),{data:c,headers:d,status:o.status,url:o.url}}async get(e){return this.request(Object.assign(Object.assign({},e),{method:"GET"}))}async post(e){return this.request(Object.assign(Object.assign({},e),{method:"POST"}))}async put(e){return this.request(Object.assign(Object.assign({},e),{method:"PUT"}))}async patch(e){return this.request(Object.assign(Object.assign({},e),{method:"PATCH"}))}async delete(e){return this.request(Object.assign(Object.assign({},e),{method:"DELETE"}))}}ar("CapacitorHttp",{web:()=>new wu});const vu=ar("Browser",{web:()=>Za(()=>import("./web-DLch8wc8.js"),[]).then(t=>new t.BrowserWeb)});let ga=null,fa=null,Lu=!1;function bu(){return fa||(fa=new Promise(t=>{if(!window.Capacitor||!window.Capacitor.isNativePlatform()){console.log("Web environment detected, resolving deviceReady immediately."),t();return}document.addEventListener("deviceready",()=>{console.log("Native device is ready"),t()},{once:!0}),setTimeout(()=>{console.log("Fallback: Assuming native device is ready after 2s."),t()},2e3)})),fa}async function Mu(){var t;try{if(await bu(),(t=window.Capacitor)!=null&&t.isNativePlatform()){console.log("Loading native Capacitor modules");const e={Geolocation:su,Filesystem:lu,Directory:cu,Browser:vu,Capacitor:On,isNative:!0,isInitialized:!0};return Lu=!0,e}}catch(e){console.error("Error loading Capacitor modules:",e)}return{Geolocation:null,Filesystem:null,Directory:null,Browser:null,Capacitor:null,isNative:!1,isInitialized:!1}}async function Jt(){return ga||(ga=Mu().catch(t=>(console.error("Critical: Failed to load Capacitor:",t),{Geolocation:null,Filesystem:null,Directory:null,Browser:null,Capacitor:null,isNative:!1,isInitialized:!1}))),ga}async function Su(t){if(!i.map)return f.handleError("Map not initialized."),null;i.isLoadingGpx=!0;try{const e=await rr(t),a=new DOMParser().parseFromString(e,"text/xml"),r=toGeoJSON.kml(a);i.gpxLayer&&i.map.hasLayer(i.gpxLayer)&&i.map.removeLayer(i.gpxLayer);const o=L.geoJSON(r,{style:function(s){const l={};return s.properties.stroke&&(l.color=s.properties.stroke),s.properties["stroke-width"]&&(l.weight=s.properties["stroke-width"]),s.properties["stroke-opacity"]&&(l.opacity=s.properties["stroke-opacity"]),s.properties.fill&&(l.fillColor=s.properties.fill),s.properties["fill-opacity"]&&(l.fillOpacity=s.properties["fill-opacity"]),l},onEachFeature:function(s,l){s.properties&&s.properties.name&&l.bindTooltip(s.properties.name)}});if(o.getLayers().length===0)throw new Error("KML file contains no valid geometries to display.");return i.gpxLayer=o,i.gpxLayer.addTo(i.map),i.map.fitBounds(o.getBounds()),{success:!0,finalPointData:null}}catch(e){return console.error("[trackManager] Error in loadKmlTrack:",e),f.handleError("Error parsing KML file: "+e.message),null}finally{i.isLoadingGpx=!1}}async function Eu(t){var e,n,a;if(!i.map)return f.handleError("Map not initialized."),null;i.isLoadingGpx=!0;try{const r=await rr(t),s=new DOMParser().parseFromString(r,"text/xml"),l=s.getElementsByTagName("wpt");let c=null;for(let p=0;p<l.length;p++){const h=(e=l[p].getElementsByTagName("name")[0])==null?void 0:e.textContent;if(h&&h.toUpperCase()==="DIP"){const v=parseFloat(l[p].getAttribute("lat")),b=parseFloat(l[p].getAttribute("lon"));if(!isNaN(v)&&!isNaN(b)){c={lat:v,lng:b},console.log(`[trackManager] DIP waypoint found in GPX file at: ${v}, ${b}`);break}}}const u=s.getElementsByTagName("trkpt"),d=[];for(let p=0;p<u.length;p++){const h=parseFloat(u[p].getAttribute("lat")),v=parseFloat(u[p].getAttribute("lon"));if(isNaN(h)||isNaN(v))continue;const b=(n=u[p].getElementsByTagName("ele")[0])==null?void 0:n.textContent,y=(a=u[p].getElementsByTagName("time")[0])==null?void 0:a.textContent;let S=null;y&&(y.includes(".")?S=y.split(".")[0]+"Z":S=y),d.push({lat:h,lng:v,ele:b?parseFloat(b):null,time:S?$.fromISO(S,{zone:"utc"}):null})}if(d.length<2)throw new Error("GPX track has insufficient points.");return await ki(d,t.name,c)}catch(r){return console.error("[trackManager] Error in loadGpxTrack:",r),f.handleError("Error parsing GPX file: "+r.message),null}finally{i.isLoadingGpx=!1}}async function ku(t){if(!i.map)return f.handleError("Map not initialized."),null;i.isLoadingGpx=!0;try{const e=await rr(t);return new Promise(async(n,a)=>{const r=[];Papa.parse(e,{skipEmptyLines:!0,step:function(o){const s=o.data;if(s[0]&&s[0].toUpperCase()==="$GNSS"&&s.length>=5){let l=s[1];const c=parseFloat(s[2]),u=parseFloat(s[3]),d=parseFloat(s[4]);if(isNaN(c)||isNaN(u)||isNaN(d))return;let m=null;l&&(l.includes(".")?m=l.split(".")[0]+"Z":m=l);let p=null;try{p=$.fromISO(m,{setZone:!0}).toUTC(),p.isValid||(p=null)}catch{p=null}r.push({lat:c,lng:u,ele:d,time:p})}},complete:async function(){if(r.length<2){a(new Error("CSV track has insufficient points."));return}const o=await ki(r,t.name,null);n(o)},error:function(o){a(new Error("Error parsing CSV: "+o.message))}})})}catch(e){return console.error("[trackManager] Error in loadCsvTrackUTC:",e),f.handleError("Error reading or parsing CSV file: "+e.message),null}finally{i.isLoadingGpx=!1}}async function _u(t,e,n){if(console.log("--- GPX EXPORT DEBUG START ---"),!g.getValue("showJumpRunTrack",!1)){f.handleError("Activate 'Show Jump Run Track' to export the track.");return}if(!i.weatherData||i.lastLat==null||i.lastLng==null||i.lastAltitude==="N/A"){f.handleError("Wetterdaten oder DIP-Position nicht verfügbar. GPX-Export nicht möglich.");return}const a=i.lastLat,r=i.lastLng,o=Math.round(i.lastAltitude),s=i.harpMarker?i.harpMarker.getLatLng():null;let l=null;s&&(l=await f.getAltitude(s.lat,s.lng),l=l!=="N/A"?Math.round(l):null);const c=Se(i.weatherData,t,e,o,n);if(!c||c.length===0){f.handleError("Keine Wetterdaten für die GPX-Erstellung verfügbar.");return}const u=Ja(c,s);if(!u||!u.latlngs||!u.approachLatLngs){f.handleError("Jump Run Track konnte nicht berechnet werden.");return}const[d,m]=u.approachLatLngs[1],[p,h]=u.latlngs[0],[v,b]=u.latlngs[1],y=g.getValue("exitAltitude",3e3),S=o+y;let w=`<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<gpx version="1.1" creator="DZMaster" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
  <metadata>
    <name>Jump Run - ${new Date().toLocaleString()}</name>
    <desc>Generated by DZMaster. Jump Run Direction: ${u.direction}°</desc>
  </metadata>
`;w+=`  <wpt lat="${a}" lon="${r}">
    <name>DIP</name>
    <ele>${o}</ele>
    <sym>Flag, Blue</sym>
  </wpt>
`,s&&l!==null&&(w+=`  <wpt lat="${s.lat}" lon="${s.lng}">
    <name>HARP</name>
    <ele>${l}</ele>
    <sym>Flag, Green</sym>
  </wpt>
`),w+=`  <wpt lat="${d}" lon="${m}">
    <name>x-2, ${u.direction}°</name>
    <ele>${S}</ele>
    <sym>Airplane</sym>
  </wpt>
`,w+=`  <wpt lat="${p}" lon="${h}">
    <name>First Out ${y} m AGL</name>
    <ele>${S}</ele>
    <sym>Airplane</sym>
  </wpt>
`,w+=`  <wpt lat="${v}" lon="${b}">
    <name>Last Out</name>
    <ele>${S}</ele>
    <sym>Airplane</sym>
  </wpt>
`,w+=`  <trk>
    <name>Jump Run and Approach</name>
    <trkseg>
`,w+=`      <trkpt lat="${d}" lon="${m}"><ele>${S}</ele></trkpt>
`,w+=`      <trkpt lat="${p}" lon="${h}"><ele>${S}</ele></trkpt>
`,w+=`      <trkpt lat="${v}" lon="${b}"><ele>${S}</ele></trkpt>
`,w+=`    </trkseg>
  </trk>
</gpx>`;const E=`${f.formatTime(i.weatherData.time[t]).replace(/ /g,"_").replace(/:/g,"")}_JumpRun_Track.gpx`;try{const{Filesystem:k,Directory:_,isNative:A}=await Jt();if(A&&k)await k.writeFile({path:`DZMaster/${E}`,data:w,directory:_.Documents,encoding:"utf8",recursive:!0}),f.handleMessage("GPX saved in Documents/DZMaster");else{const T=new Blob([w],{type:"application/gpx+xml;charset=utf-8"}),C=window.URL.createObjectURL(T),I=document.createElement("a");I.href=C,I.download=E,document.body.appendChild(I),I.click(),document.body.removeChild(I),window.URL.revokeObjectURL(C)}}catch(k){console.error("Error saving GPX file:",k),f.handleError("Could not save GPX file.")}}async function Tu(){var M;console.log("--- GPX Landing Pattern Export gestartet ---");const t=parseInt((M=document.getElementById("timeSlider"))==null?void 0:M.value)||0,e=g.getValue("interpStep","select",200),n=g.getValue("heightUnit","m");if(!g.getValue("showLandingPattern",!1)){f.handleError("Activate 'Landing Pattern' before export.");return}if(!i.weatherData||i.lastLat==null||i.lastLng==null||i.lastAltitude==="N/A"){f.handleError("Wetterdaten oder DIP-Position für GPX-Export nicht verfügbar.");return}console.log("Schritt 1: Vorbedingungen erfüllt. Wetterdaten und Position vorhanden.");const a=Se(i.weatherData,t,e,Math.round(i.lastAltitude),n);if(!a||a.length===0){f.handleError("Fehler in Schritt 2: Keine interpolierten Wetterdaten für GPX-Erstellung verfügbar.");return}console.log("Schritt 2: Wetterdaten erfolgreich interpoliert.");const r=Zn(i.lastLat,i.lastLng,a);if(console.log("Schritt 3: Ergebnis von calculateLandingPatternCoords:",r),!r){f.handleError("Fehler in Schritt 3: calculateLandingPatternCoords hat keine Daten zurückgegeben. Export abgebrochen.");return}console.log("Schritt 3: Koordinaten des Landemusters erfolgreich berechnet.");const{downwindStart:o,baseStart:s,finalStart:l,landingPoint:c}=r,u=Math.round(i.lastAltitude),d=g.getValue("legHeightDownwind",300),m=g.getValue("legHeightBase",200),p=g.getValue("legHeightFinal",100),h=u+d,v=u+m,b=u+p;let y=`<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<gpx version="1.1" creator="DZMaster" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
  <metadata>
    <name>Landing Pattern - ${new Date().toLocaleString()}</name>
    <desc>Generated by DZMaster Application.</desc>
  </metadata>
`;y+=`  <wpt lat="${o[0]}" lon="${o[1]}"><name>Downwind ${d} m AGL</name><ele>${h}</ele></wpt>
`,y+=`  <wpt lat="${s[0]}" lon="${s[1]}"><name>Base ${m} m AGL</name><ele>${v}</ele></wpt>
`,y+=`  <wpt lat="${l[0]}" lon="${l[1]}"><name>Final ${p} m AGL</name><ele>${b}</ele></wpt>
`,y+=`  <wpt lat="${c[0]}" lon="${c[1]}"><name>DIP</name><ele>${u}</ele></wpt>
`,y+=`  <trk>
    <name>Landing Pattern</name>
    <trkseg>
      <trkpt lat="${o[0]}" lon="${o[1]}"><ele>${h}</ele></trkpt>
      <trkpt lat="${s[0]}" lon="${s[1]}"><ele>${v}</ele></trkpt>
      <trkpt lat="${l[0]}" lon="${l[1]}"><ele>${b}</ele></trkpt>
      <trkpt lat="${c[0]}" lon="${c[1]}"><ele>${u}</ele></trkpt>
    </trkseg>
  </trk>
</gpx>`,console.log("Schritt 4: GPX-String wurde erfolgreich erstellt."),console.log(y);const w=`${f.formatTime(i.weatherData.time[t]).replace(/ /g,"_").replace(/:/g,"")}_Landing_Pattern.gpx`;try{const{Filesystem:E,Directory:k,isNative:_}=await Jt();if(_&&E)await E.writeFile({path:`DZMaster/${w}`,data:y,directory:k.Documents,encoding:"utf8",recursive:!0}),f.handleMessage("Landing Pattern GPX saved in Documents/DZMaster");else{const A=new Blob([y],{type:"application/gpx+xml;charset=utf-8"}),T=window.URL.createObjectURL(A),C=document.createElement("a");C.href=T,C.download=w,document.body.appendChild(C),C.click(),document.body.removeChild(C),window.URL.revokeObjectURL(T)}}catch(E){console.error("Error saving Landing Pattern GPX file:",E),f.handleError("Could not save Landing Pattern GPX file.")}console.log("--- GPX Landing Pattern Export beendet ---")}async function ki(t,e,n=null){try{if(console.log(`[trackManager] renderTrack called for ${e} with ${t.length} points.`),!i.map)return console.warn("[trackManager] Map object in AppState is not available in renderTrack."),f.handleError("Map not initialized. Cannot render track."),null;i.gpxLayer&&i.map.hasLayer(i.gpxLayer)&&i.map.removeLayer(i.gpxLayer),i.gpxLayer=null,i.gpxPoints=t,i.isTrackLoaded=!1;const a={finalPointData:null,timestampToUseForWeather:null,historicalDateString:null,summaryForInfoElement:"",success:!1};if(t.length>0){if(n)console.log("[trackManager] DIP waypoint found in GPX. Setting DIP to waypoint position."),i.lastLat=n.lat,i.lastLng=n.lng,i.lastAltitude=await f.getAltitude(i.lastLat,i.lastLng);else{console.log("[trackManager] No DIP waypoint in file. Setting DIP to the last point of the track.");const d=t[t.length-1];i.lastLat=d.lat,i.lastLng=d.lng,i.lastAltitude=await f.getAltitude(i.lastLat,i.lastLng)}if(a.finalPointData={lat:i.lastLat,lng:i.lastLng,altitude:i.lastAltitude},t[0].time&&t[0].time.isValid){const d=t[0].time,m=$.utc().startOf("day"),p=d.startOf("day");p<m&&(a.historicalDateString=p.toFormat("yyyy-MM-dd"));let h=d.startOf("hour");d.minute>=30&&(h=h.plus({hours:1})),a.timestampToUseForWeather=h.toISO()}const o=(t.reduce((d,m,p)=>{if(p===0||!i.map)return 0;const h=t[p-1];return d+i.map.distance([h.lat,h.lng],[m.lat,m.lng])},0)/1e3).toFixed(2),s=t.map(d=>d.ele).filter(d=>d!==null),l=s.length?Math.min(...s).toFixed(0):"N/A",c=s.length?Math.max(...s).toFixed(0):"N/A",u=new CustomEvent("track:loaded",{detail:{lat:i.lastLat,lng:i.lastLng,altitude:i.lastAltitude,timestamp:a.timestampToUseForWeather,historicalDate:a.historicalDateString,summary:`<br><strong>Track:</strong> Distance: ${o} km, Min Elevation: ${l} m, Max Elevation: ${c} m (Source: ${e})`},bubbles:!0,cancelable:!0});i.map.getContainer().dispatchEvent(u)}i.gpxLayer=L.layerGroup([],{pane:"gpxTrackPane"});const r=i.lastAltitude!=="N/A"&&!isNaN(i.lastAltitude)?parseFloat(i.lastAltitude):null;for(let o=0;o<t.length-1;o++){const s=t[o],l=t[o+1],c=s.ele,u=l.ele;let d="#808080";if(r!==null&&c!==null&&u!==null){const p=c-r,h=u-r,v=(p+h)/2;d=f.interpolateColor(v)}const m=L.polyline([[s.lat,s.lng],[l.lat,l.lng]],{color:d,weight:4,opacity:.75,pane:"gpxTrackPane"}).bindTooltip("",{sticky:!0});m.on("mousemove",function(p){const h=p.latlng;let v=t[0],b=1/0,y=0;t.forEach((S,w)=>{const M=Math.sqrt(Math.pow(S.lat-h.lat,2)+Math.pow(S.lng-h.lng,2));M<b&&(b=M,v=S,y=w)}),m.setTooltipContent(f.getTooltipContent(v,y,t,r)).openTooltip(h)}),i.gpxLayer.addLayer(m)}if(i.map&&i.gpxLayer.addTo(i.map),i.isTrackLoaded=!0,t.length>0&&i.map){const o=L.latLngBounds(t.map(s=>[s.lat,s.lng]));o.isValid()?i.map.fitBounds(o,{padding:[50,50],maxZoom:i.map.getMaxZoom()||18}):f.handleError("Unable to display track: invalid coordinates.")}return a.success=!0,console.log("[trackManager] renderTrack finished successfully."),a}catch(a){return console.error("[trackManager] Error in renderTrack:",a),f.handleError("Error rendering track: "+a.message),i.gpxPoints=[],i.gpxLayer&&i.map&&i.map.hasLayer(i.gpxLayer)&&i.map.removeLayer(i.gpxLayer),i.gpxLayer=null,i.isTrackLoaded=!1,{success:!1,error:a.message}}}async function rr(t){const{Filesystem:e,isNative:n,Directory:a}=await Jt();if(n&&t.path&&e){console.log(`[trackManager] Reading file via Capacitor Filesystem API: ${t.path}`);try{return(await e.readFile({path:t.path,encoding:"utf8"})).data}catch(r){if(console.error("[trackManager] Error reading file with Capacitor:",r),t.webPath)return await(await fetch(t.webPath)).text();throw new Error("Could not read file using native API.")}}else return console.log(`[trackManager] Reading file via Web FileReader: ${t.name}`),new Promise((r,o)=>{const s=new FileReader;s.onload=l=>r(l.target.result),s.onerror=l=>o(new Error("Error reading file.")),s.readAsText(t)})}var Au=15e3,Pa=1e3,Na=60*Pa,An=60*Na,pa=24*An,Cu="http://www.topografix.com/GPX/gpx_style/0/2",kn=new L.Icon.Default,Iu={startIcon:kn,endIcon:kn,wptIcons:{"":kn},wptTypeIcons:{"":kn},pointMatchers:[]},Du={iconSize:[33,45],iconAnchor:[16,45],clickable:!1},Pu={color:"blue"},Nu={parseElements:["track","route","waypoint"],joinTrackSegments:!0};L.GPX=L.FeatureGroup.extend({initialize:function(t,e){e.max_point_interval=e.max_point_interval||Au,e.markers=this._merge_objs(Iu,e.markers||{}),e.marker_options=this._merge_objs(Du,e.marker_options||{}),e.polyline_options=e.polyline_options||[],e.gpx_options=this._merge_objs(Nu,e.gpx_options||{}),L.Util.setOptions(this,e),L.GPXTrackIcon=L.Icon.extend({options:e.marker_options}),this._gpx=t,this._layers={},this._prepare_markers(e.markers),this._init_info(),t&&this._parse(t,e,this.options.async)},get_duration_string:function(t,e){var n="";t>=pa&&(n+=Math.floor(t/pa)+"d ",t=t%pa),t>=An&&(n+=Math.floor(t/An)+":",t=t%An);var a=Math.floor(t/Na);t=t%Na,a<10&&(n+="0"),n+=a+"'";var r=Math.floor(t/Pa);return t=t%Pa,r<10&&(n+="0"),n+=r,!e&&t>0?n+="."+Math.round(Math.floor(t)*1e3)/1e3:n+='"',n},get_duration_string_iso:function(t,e){var n=this.get_duration_string(t,e);return n.replace("'",":").replace('"',"")},_toFixed_helper:function(t,e=0){return typeof t=="number"?t.toFixed(e):"?"},to_miles:function(t){return t/1.60934},to_ft:function(t){return t*3.28084},m_to_km:function(t){return t/1e3},m_to_mi:function(t){return t/1609.34},ms_to_kmh:function(t){return t*3.6},ms_to_mih:function(t){return t/1609.34*3600},get_name:function(){return this._info.name},get_desc:function(){return this._info.desc},get_author:function(){return this._info.author},get_copyright:function(){return this._info.copyright},get_distance:function(){return this._info.length},get_distance_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))},get_start_time:function(){return this._info.duration.start},get_end_time:function(){return this._info.duration.end},get_moving_time:function(){return this._info.duration.moving},get_total_time:function(){return this._info.duration.total},get_moving_pace:function(){return this.get_moving_time()/this.m_to_km(this.get_distance())},get_moving_pace_imp:function(){return this.get_moving_time()/this.get_distance_imp()},get_moving_speed:function(){return this.m_to_km(this.get_distance())/(this.get_moving_time()/(3600*1e3))},get_moving_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_moving_time()/(3600*1e3))},get_total_speed:function(){return this.m_to_km(this.get_distance())/(this.get_total_time()/(3600*1e3))},get_total_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_total_time()/(3600*1e3))},get_elevation_gain:function(){return this._info.elevation.gain},get_elevation_loss:function(){return this._info.elevation.loss},get_elevation_gain_imp:function(){return this.to_ft(this.get_elevation_gain())},get_elevation_loss_imp:function(){return this.to_ft(this.get_elevation_loss())},get_elevation_data:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" m"})})},get_elevation_data_imp:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.to_ft,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" ft"})})},get_elevation_max:function(){return this._info.elevation.max},get_elevation_min:function(){return this._info.elevation.min},get_elevation_max_imp:function(){return this.to_ft(this.get_elevation_max())},get_elevation_min_imp:function(){return this.to_ft(this.get_elevation_min())},get_speed_data:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,t.ms_to_kmh,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,2)+" km/h"})})},get_speed_data_imp:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.ms_to_mih,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,2)+" mi/h"})})},get_speed_max:function(){return this.m_to_km(this._info.speed.max)*3600},get_speed_max_imp:function(){return this.to_miles(this.get_speed_max())},get_average_hr:function(){return this._info.hr.avg},get_average_temp:function(){return this._info.atemp.avg},get_average_cadence:function(){return this._info.cad.avg},get_heartrate_data:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" bpm"})})},get_heartrate_data_imp:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" bpm"})})},get_cadence_data:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" rpm"})})},get_temp_data:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,a){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(a,0)+" degrees"})})},get_cadence_data_imp:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" rpm"})})},get_temp_data_imp:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,a){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(a,0)+" degrees"})})},reload:function(){this._init_info(),this.clearLayers(),this._parse(this._gpx,this.options,this.options.async)},_merge_objs:function(t,e){var n={};for(var a in t)n[a]=t[a];for(var a in e)n[a]=e[a];return n},_prepare_data_point:function(t,e,n,a){var r=[e&&e(t[0])||t[0],n&&n(t[1])||t[1]];return r.push(a&&a(r[0],r[1])||r[0]+": "+r[1]),r},_prepare_markers:function(t){function e(n){return new L.GPXTrackIcon({iconUrl:n})}return Object.entries(t).forEach(([n,a])=>{n==="wptIcons"||n==="wptTypeIcons"?t[n]=this._prepare_markers(a):n==="pointMatchers"?t[n]=a.map(r=>(typeof r.icon=="string"&&(r.icon=e(r.icon)),r)):typeof a=="string"?t[n]=e(a):typeof a=="object"&&a!==null&&(t[n]=a)}),t},_init_info:function(){this._info={name:null,length:0,elevation:{gain:0,loss:0,max:0,min:1/0,_points:[]},speed:{max:0,_points:[]},hr:{avg:0,_total:0,_points:[]},duration:{start:null,end:null,moving:0,total:0},atemp:{avg:0,_total:0,_points:[]},cad:{avg:0,_total:0,_points:[]}}},_load_xml:function(t,e,n,a){a==null&&(a=this.options.async),n==null&&(n=this.options);var r=this,o=new window.XMLHttpRequest;o.open("GET",t,a);try{o.overrideMimeType("text/xml")}catch{}o.onloadend=function(){o.status==200?e(o.responseXML,n):r.fire("error",{err:"Error fetching resource: "+t})},o.send(null)},_parse:function(t,e,n){var a=this,r=function(s,l){var c=a._parse_gpx_data(s,l);if(!c){a.fire("error",{err:"No parseable layers of type(s) "+JSON.stringify(l.gpx_options.parseElements)});return}a.addLayer(c),a.fire("loaded",{layers:c,element:s})};if(t.substr(0,1)==="<"){var o=new DOMParser;n?setTimeout(function(){r(o.parseFromString(t,"text/xml"),e)}):r(o.parseFromString(t,"text/xml"),e)}else this._load_xml(t,r,e,n)},_parse_gpx_data:function(t,e){var n,a,r=[],o=t.getElementsByTagName("name");o.length>0&&(this._info.name=o[0].textContent);var s=t.getElementsByTagName("desc");s.length>0&&(this._info.desc=s[0].textContent);var l=t.getElementsByTagName("author");l.length>0&&(this._info.author=l[0].textContent);var c=t.getElementsByTagName("copyright");c.length>0&&(this._info.copyright=c[0].textContent);var u=e.gpx_options.parseElements;if(u.indexOf("route")>-1){var d=t.getElementsByTagName("rte");for(n=0;n<d.length;n++){var m=d[n],p=this._extract_styling(m),h=this._get_polyline_options(e.polyline_options,n);r=r.concat(this._parse_segment(d[n],e,p,h,"rtept"))}}if(u.indexOf("track")>-1){var v=t.getElementsByTagName("trk");for(n=0;n<v.length;n++){var b=v[n],p=this._extract_styling(b),h=this._get_polyline_options(e.polyline_options,n);if(e.gpx_options.joinTrackSegments)r=r.concat(this._parse_segment(b,e,p,h,"trkpt"));else{var y=b.getElementsByTagName("trkseg");for(D=0;D<y.length;D++)r=r.concat(this._parse_segment(y[D],e,p,h,"trkpt"))}}}if(this._info.hr.avg=Math.round(this._info.hr._total/this._info.hr._points.length),this._info.cad.avg=Math.round(this._info.cad._total/this._info.cad._points.length),this._info.atemp.avg=Math.round(this._info.atemp._total/this._info.atemp._points.length),u.indexOf("waypoint")>-1)for(a=t.getElementsByTagName("wpt"),n=0;n<a.length;n++){var S=new L.LatLng(a[n].getAttribute("lat"),a[n].getAttribute("lon")),w=a[n].getElementsByTagName("name"),o=w.length>0?w[0].textContent:"",M=a[n].getElementsByTagName("desc"),s=M.length>0?M[0].textContent:"",E=a[n].getElementsByTagName("sym"),k=E.length>0?E[0].textContent:null,_=a[n].getElementsByTagName("type"),A=_.length>0?_[0].textContent:null,T=e.markers.wptIcons,C=e.markers.wptTypeIcons,I=e.markers.pointMatchers||[],R;if(T&&k&&T[k])R=T[k];else if(C&&A&&C[A])R=C[A];else if(I.length>0){for(var D=0;D<I.length;D++)if(I[D].regex.test(o)){R=I[D].icon;break}}else T&&T[""]&&(R=T[""]);if(!R){console.log("No waypoint icon could be matched for symKey=%s,typeKey=%s,name=%s on waypoint %o",k,A,o,a[n]);continue}var P=new L.Marker(S,{clickable:e.marker_options.clickable,title:o,icon:R,type:"waypoint"});P.bindPopup("<b>"+o+"</b>"+(s.length>0?"<br>"+s:"")).openPopup(),this.fire("addpoint",{point:P,point_type:"waypoint",element:a[n]}),r.push(P)}if(r.length>1)return new L.FeatureGroup(r);if(r.length==1)return r[0]},_parse_segment:function(t,e,n,a,r){var o=t.getElementsByTagName(r);if(!o.length)return[];for(var s=[],l=[],c=[],u=null,d=0;d<o.length;d++){var m,p=new L.LatLng(o[d].getAttribute("lat"),o[d].getAttribute("lon"));p.meta={time:null,ele:null,hr:null,cad:null,atemp:null,speed:null},m=o[d].getElementsByTagName("time"),m.length>0?p.meta.time=new Date(Date.parse(m[0].textContent)):p.meta.time=new Date("1970-01-01T00:00:00");var h=u!=null?Math.abs(p.meta.time-u.meta.time):0;m=o[d].getElementsByTagName("ele"),m.length>0?p.meta.ele=parseFloat(m[0].textContent):p.meta.ele=u!=null?u.meta.ele:null;var v=u!=null?p.meta.ele-u.meta.ele:0,b=u!=null?this._dist3d(u,p):0;if(m=o[d].getElementsByTagName("speed"),m.length>0?p.meta.speed=parseFloat(m[0].textContent):p.meta.speed=h>0?1e3*b/h:0,m=o[d].getElementsByTagName("name"),m.length>0){for(var y=m[0].textContent,S=e.markers.pointMatchers||[],w=0;w<S.length;w++)if(S[w].regex.test(y)){l.push({label:y,coords:p,icon:S[w].icon,element:o[d]});break}}this._info.length+=b,m=o[d].getElementsByTagNameNS("*","hr"),m.length>0&&(p.meta.hr=parseInt(m[0].textContent),this._info.hr._points.push([this._info.length,p.meta.hr]),this._info.hr._total+=p.meta.hr),m=o[d].getElementsByTagNameNS("*","cad"),m.length>0&&(p.meta.cad=parseInt(m[0].textContent),this._info.cad._points.push([this._info.length,p.meta.cad]),this._info.cad._total+=p.meta.cad),m=o[d].getElementsByTagNameNS("*","atemp"),m.length>0&&(p.meta.atemp=parseInt(m[0].textContent),this._info.atemp._points.push([this._info.length,p.meta.atemp]),this._info.atemp._total+=p.meta.atemp),p.meta.ele>this._info.elevation.max&&(this._info.elevation.max=p.meta.ele),p.meta.ele<this._info.elevation.min&&(this._info.elevation.min=p.meta.ele),this._info.elevation._points.push([this._info.length,p.meta.ele]),p.meta.speed>this._info.speed.max&&(this._info.speed.max=p.meta.speed),this._info.speed._points.push([this._info.length,p.meta.speed]),u==null&&this._info.duration.start==null&&(this._info.duration.start=p.meta.time),this._info.duration.end=p.meta.time,this._info.duration.total+=h,h<e.max_point_interval&&(this._info.duration.moving+=h),v>0?this._info.elevation.gain+=v:this._info.elevation.loss+=Math.abs(v),u=p,s.push(p)}var M=new L.Polyline(s,this._extract_styling(t,n,a));if(this.fire("addline",{line:M,element:t}),c.push(M),e.markers.startIcon){var E=new L.Marker(s[0],{clickable:e.marker_options.clickable,icon:e.markers.startIcon});this.fire("addpoint",{point:E,point_type:"start",element:o[0],line:t}),c.push(E)}if(e.markers.endIcon){var E=new L.Marker(s[s.length-1],{clickable:e.marker_options.clickable,icon:e.markers.endIcon});this.fire("addpoint",{point:E,point_type:"end",element:o[o.length-1],line:t}),c.push(E)}for(var d=0;d<l.length;d++){var E=new L.Marker(l[d].coords,{clickable:e.marker_options.clickable,title:l[d].label,icon:l[d].icon});this.fire("addpoint",{point:E,point_type:"label",element:l[d].element}),c.push(E)}return c},_get_polyline_options:function(t,e){return Array.isArray(t)?t[e]||{}:t},_extract_styling:function(t,e,n){var a=this._merge_objs(Pu,e),r=t.getElementsByTagNameNS(Cu,"line");if(r.length>0){var o=r[0].getElementsByTagName("color");o.length>0&&(a.color="#"+o[0].textContent);var o=r[0].getElementsByTagName("opacity");o.length>0&&(a.opacity=o[0].textContent);var o=r[0].getElementsByTagName("weight");o.length>0&&(a.weight=o[0].textContent);var o=r[0].getElementsByTagName("linecap");o.length>0&&(a.lineCap=o[0].textContent);var o=r[0].getElementsByTagName("linejoin");o.length>0&&(a.lineJoin=o[0].textContent);var o=r[0].getElementsByTagName("dasharray");o.length>0&&(a.dashArray=o[0].textContent);var o=r[0].getElementsByTagName("dashoffset");o.length>0&&(a.dashOffset=o[0].textContent)}return this._merge_objs(a,n)},_dist2d:function(t,e){var n=6371e3,a=this._deg2rad(e.lat-t.lat),r=this._deg2rad(e.lng-t.lng),o=Math.sin(a/2)*Math.sin(a/2)+Math.cos(this._deg2rad(t.lat))*Math.cos(this._deg2rad(e.lat))*Math.sin(r/2)*Math.sin(r/2),s=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)),l=n*s;return l},_dist3d:function(t,e){var n=this._dist2d(t,e),a=Math.abs(e.meta.ele-t.meta.ele);return Math.sqrt(Math.pow(n,2)+Math.pow(a,2))},_deg2rad:function(t){return t*Math.PI/180}});let on=null;const _i="https://corsproxy.io/?",Ti='ADS-B Data provided by <a href="https://www.adsbexchange.com/" target="_blank">ADSBexchange.com</a>',or=new Headers;or.append("Accept","application/json");function Rn(t,e={}){document.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:!0}))}async function Ai(){if(on){Ci(),f.handleMessage("ADSB-Tracking gestoppt.");return}if(i.lastLat==null||i.lastLng==null){f.handleError("Bitte zuerst einen Punkt (DIP) auf der Karte auswählen.");return}f.handleMessage("Suche nach Flugzeugen in der Nähe...");try{const t={lat:i.lastLat,lng:i.lastLng},e=`https://api.adsb.lol/v2/lat/${t.lat}/lon/${t.lng}/dist/15`,n=await fetch(_i+encodeURIComponent(e),{headers:or});if(!n.ok){const o=await n.json().catch(()=>({msg:"Unbekannter API-Fehler"}));throw new Error(`API Error ${n.status}: ${o.msg}`)}const a=await n.json();if(!a.ac||a.ac.length===0){f.handleMessage("Keine Flugzeuge in der Nähe gefunden.");return}const r=a.ac.filter(o=>o.lat&&o.lon&&o.alt_baro).map(o=>({icao24:o.hex,callsign:o.flight?o.flight.trim():"N/A",altitude:o.alt_baro,lat:o.lat,lon:o.lon,track:o.track,velocity:o.gs,vertical_rate:o.baro_rate}));Rn("adsb:showSelection",{aircraftList:r})}catch(t){console.error("Fehler bei der ADSB-Abfrage:",t),f.handleError(`Konnte Flugzeugdaten nicht abrufen: ${t.message}`)}}function xu(t){f.handleMessage(`Tracking ${t.callsign}...`);const e=document.getElementById("findJumpShipBtn");e&&(e.textContent="Stop ADSB Tracking",e.classList.remove("btn-secondary"),e.classList.add("btn-danger")),i.adsbTrackPoints=[[t.lat,t.lon]],Rn("adsb:aircraftSelected",{aircraft:t,attribution:Ti});const n=async()=>{try{const a=`https://api.adsb.lol/v2/hex/${t.icao24}`,r=await fetch(_i+encodeURIComponent(a),{headers:or});if(r.status===404){Ci(),f.handleMessage(`${t.callsign} ist nicht mehr sichtbar. Tracking gestoppt.`);return}if(!r.ok)throw new Error(`API Error ${r.status}`);const o=await r.json();if(o.ac&&o.ac.length>0){const s=o.ac[0],l={icao24:s.hex,callsign:s.flight?s.flight.trim():"N/A",lat:s.lat,lon:s.lon,track:s.track,altitude:s.alt_baro,velocity:s.gs,vertical_rate:s.baro_rate};l.lat&&l.lon&&(i.adsbTrackPoints.push([l.lat,l.lon]),Rn("adsb:aircraftUpdated",{aircraft:l}))}}catch(a){console.error("Fehler beim ADSB-Tracking:",a)}};n(),on=setInterval(n,1e4)}function Ci(){on&&(clearInterval(on),on=null),i.adsbTrackPoints=[],Rn("adsb:trackingStopped",{attribution:Ti});const t=document.getElementById("findJumpShipBtn");t&&(t.textContent="Find Aircraft",t.classList.remove("btn-danger"),t.classList.add("btn-secondary"))}let Kr=!1;function Fe(t,e,n){console.log(`setupCheckbox called for id: ${t}`);const a=document.getElementById(t);a?(a._changeHandler&&(a.removeEventListener("change",a._changeHandler),console.log(`Removed previous change listener for ${t}`)),a._changeHandler=r=>{console.log(`Change event fired for ${t}, checked: ${a.checked}, event:`,r),r.stopPropagation(),n(a)},a.addEventListener("change",a._changeHandler),a.addEventListener("click",r=>{console.log(`Click event on ${t}, checked: ${a.checked}, target:`,r.target)}),console.log(`Attached change and click listeners to ${t}`)):console.warn(`Checkbox ${t} not found`)}function xa(t,e){document.querySelectorAll(`input[name="${t}"]`).forEach(a=>{a.addEventListener("change",()=>{const r=document.querySelector(`input[name="${t}"]:checked`);if(!r)return;const o=r.value;if(g.state.userSettings[t]=o,g.save(),console.log(`${t} changed to: ${o} and saved to localStorage`),t==="landingDirection"){const s=document.getElementById("customLandingDirectionLL"),l=document.getElementById("customLandingDirectionRR");s&&(s.disabled=o!=="LL"),l&&(l.disabled=o!=="RR"),o==="LL"&&s&&!s.value&&g.state.userSettings.customLandingDirectionLL===""&&(s.value=Math.round(i.landingWindDir||0),g.state.userSettings.customLandingDirectionLL=parseInt(s.value),g.save(),console.log(`Set customLandingDirectionLL to ${s.value}`)),o==="RR"&&l&&!l.value&&g.state.userSettings.customLandingDirectionRR===""&&(l.value=Math.round(i.landingWindDir||0),g.state.userSettings.customLandingDirectionRR=parseInt(l.value),g.save(),console.log(`Set customLandingDirectionRR to ${l.value}`))}document.dispatchEvent(new CustomEvent("ui:radioGroupChanged",{detail:{name:t,value:o}})),e&&e()})})}function ue(t,e,n,a){const r=document.getElementById(t);r&&r.addEventListener(e,f.debounce(()=>{const o=r.type==="number"?parseFloat(r.value):r.value;a&&a(o)===!1||(g.state.userSettings[t]=o,g.save(),console.log(`${t} changed to: ${o} and saved to localStorage`),document.dispatchEvent(new CustomEvent("ui:inputChanged",{detail:{name:t,value:o}})))},n))}function Fu(){const t=document.querySelector(".main-layout"),e=document.querySelectorAll(".sidebar-icon"),n=document.querySelectorAll(".panel");let a=null;if(!t){console.error("Layout-Elemente für Sidebar-Logik nicht gefunden.");return}e.forEach(r=>{r.addEventListener("click",()=>{const o=r.dataset.panelId,s=o.replace("panel-","");if((s==="planner"||s==="data")&&!g.isFeatureUnlocked(s)){g.showPasswordModal(s,()=>{r.click()},()=>{});return}const l=t.classList.contains("sidebar-expanded")&&a===o;t.classList.remove("sidebar-expanded","data-panel-visible"),e.forEach(c=>c.classList.remove("active")),l?a=null:(t.classList.add("sidebar-expanded"),r.classList.add("active"),a=o,n.forEach(c=>c.classList.toggle("hidden",c.id!==o)),o==="panel-data"&&t.classList.add("data-panel-visible")),setTimeout(()=>{i.map&&i.map.invalidateSize({animate:!0})},300)})})}function $u(){document.querySelectorAll(".accordion-header").forEach(e=>{e.addEventListener("click",()=>{e.parentElement.classList.toggle("active")})})}function Ou(){const t=document.getElementById("timeSlider");t&&(t.addEventListener("input",()=>{document.dispatchEvent(new CustomEvent("ui:sliderChanged",{detail:{sliderValue:t.value},bubbles:!0,cancelable:!0}))}),t.addEventListener("change",async()=>{document.dispatchEvent(new CustomEvent("ui:sliderChangeFinished",{detail:{sliderValue:t.value},bubbles:!0,cancelable:!0}))}))}function Ru(){const t=document.getElementById("modelSelect");t&&(t.addEventListener("change",()=>{const e=t.value;console.log("Model select changed to:",e),g.state.userSettings.model=e,g.save(),document.dispatchEvent(new CustomEvent("ui:modelChanged",{detail:{model:e}}))}),document.addEventListener("models:available",e=>{const{availableModels:n}=e.detail;mc(n),dd(n),hc(n)}))}function Wu(){nr(),console.log("Coordinate events setup complete.")}function Uu(){if(console.log("App: Richte Event-Listener für Karten-Events ein."),!i.map){console.error("Karte nicht initialisiert, Event-Listener können nicht gesetzt werden.");return}const t=()=>{document.dispatchEvent(new CustomEvent("map:moved"))},e=f.debounce(()=>{Ya({map:i.map,baseMaps:i.baseMaps,onProgress:cn,onComplete:n=>{it(),n&&f.handleMessage(n)},onCancel:()=>{it(),f.handleMessage("Caching cancelled.")}})},1e3);i.map.on("zoomend",t),i.map.on("moveend",t),i.map.on("moveend",e)}function Hu(){const t=document.getElementById("modelInfoButton"),e=document.getElementById("modelInfoPopup");!t||!e||(t.addEventListener("click",n=>{n.stopPropagation();const a=e.style.display==="block";e.style.display=a?"none":"block"}),document.addEventListener("click",n=>{e.style.display==="block"&&!t.contains(n.target)&&(e.style.display="none")}))}function Bu(){document.querySelectorAll(".info-icon").forEach(e=>{const n=e.nextElementSibling;if(n&&n.classList.contains("info-popup")){const a=e.dataset.info;a&&(n.textContent=a),e.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),document.querySelectorAll(".info-popup").forEach(s=>{s!==n&&(s.style.display="none")});const o=n.style.display==="block";n.style.display=o?"none":"block"})}}),document.addEventListener("click",e=>{e.target.closest(".info-icon")||document.querySelectorAll(".info-popup").forEach(n=>{n.style.display="none"})})}function Gu(){if(!i.map){console.warn("Map not initialized, skipping setup for popup format toggle.");return}i.map.getContainer().addEventListener("click",t=>{if(t.target.classList.contains("toggle-coords-format")){t.preventDefault();const e=t.target,n=e.dataset.markerType,a=e.dataset.expanded==="true";if(n==="dip")et(!a,!0);else if(n==="harp"&&i.harpMarker){const r=parseFloat(e.dataset.lat),o=parseFloat(e.dataset.lng);Qa(i.harpMarker,r,o,!0,!a)}}})}function zu(){console.log("App: Richte Event-Listener für Track-Einstellungen ein.");const t=(a,r)=>{const o=document.getElementById(a);o&&(o.value=g.state.userSettings[r]||0,console.log(`Set ${a} to initial value:`,o.value),o.addEventListener("input",()=>{const s=parseFloat(o.value);isNaN(s)||(g.state.userSettings[r]=s,g.save(),be())}))};t("numberOfJumpers","numberOfJumpers"),t("jumperSeparation","jumperSeparation"),t("jumpRunTrackOffset","jumpRunTrackOffset"),t("jumpRunTrackForwardOffset","jumpRunTrackForwardOffset");const e=document.getElementById("jumpRunTrackDirection");e&&(e.value=g.state.userSettings.customJumpRunDirection||"",e.addEventListener("change",()=>{const a=parseFloat(e.value);g.state.userSettings.jumpRunTrackOffset=0,g.state.userSettings.jumpRunTrackForwardOffset=0;const r=document.getElementById("jumpRunTrackOffset"),o=document.getElementById("jumpRunTrackForwardOffset");r&&(r.value=0),o&&(o.value=0),console.log("Manuelle JRT-Richtungsänderung: Offsets auf 0 zurückgesetzt."),Number.isFinite(a)&&a>=0&&a<=360?(g.state.userSettings.customJumpRunDirection=a,console.log("Set 'customJumpRunDirection' on change to:",a)):(g.state.userSettings.customJumpRunDirection=null,e.value="",console.log("Invalid direction, resetting to calculated.")),g.save(),be(),document.dispatchEvent(new CustomEvent("ui:recalculateJump"))}));const n=document.getElementById("showJumpRunTrack");n&&n.addEventListener("change",a=>{g.state.userSettings.showJumpRunTrack=a.target.checked,g.save(),be()})}function Vu(){const t=document.querySelectorAll('input[name="cutAwayState"]');if(t.length===0)return;const e=g.state.userSettings.cutAwayState||"Partially",n=document.querySelector(`input[name="cutAwayState"][value="${e}"]`);n&&(n.checked=!0),t.forEach(a=>{a.addEventListener("change",()=>{a.checked&&(console.log(`Cut Away State changed to: ${a.value}`),g.state.userSettings.cutAwayState=a.value,g.save(),document.dispatchEvent(new CustomEvent("ui:recalculateJump")))})})}function Zu(){const t=document.getElementById("resetCutAwayMarker");t&&t.addEventListener("click",()=>{if(!i.map){console.warn("Map not initialized, cannot reset cut-away marker");return}i.cutAwayMarker&&(i.map.removeLayer(i.cutAwayMarker),i.cutAwayMarker=null,i.cutAwayLat=null,i.cutAwayLng=null,console.log("Cut-away marker reset"),i.cutAwayCircle&&(i.map.removeLayer(i.cutAwayCircle),i.cutAwayCircle=null,console.log("Cleared cut-away circle")),document.getElementById("info").innerHTML="Right-click map to place cut-away marker")})}function ju(){const t=document.getElementById("deselectAllEnsembleButton");t&&t.addEventListener("click",()=>{document.querySelectorAll('#ensembleModelsSubmenu input[type="checkbox"]').forEach(n=>{n.checked=!1}),g.state.userSettings.selectedEnsembleModels=[],g.save(),i.ensembleModelsData=null,gn(),f.handleMessage("All ensemble models deselected.")})}function Ju(){const t=document.getElementById("analyzeTerrainButton");t&&t.addEventListener("click",async()=>{if(!i.weatherData||i.lastLat==null||i.lastLng==null){f.handleError("Please select a location and fetch weather data first.");return}if(!g.state.userSettings.showCanopyArea){f.handleError("Please activate 'Show Canopy Flight Area' to analyze terrain.");return}Ut(!0,"Analyzing terrain, this may take a moment...");try{const e=await nc();Ec(e),e.length>0?ot("Warning: Low clearance areas detected and marked in red."):f.handleMessage("Terrain analysis complete. No low clearance areas found.")}catch(e){console.error("Terrain analysis failed:",e),f.handleError("An error occurred during terrain analysis.")}finally{Ut(!1)}})}function qu(){const t=document.getElementById("uploadTrackButton"),e=document.getElementById("trackFileInput"),n=document.getElementById("fileNameDisplay"),a=document.getElementById("clearTrack");if(!t||!e||!n||!a){console.error("One or more track upload elements are missing from the DOM.");return}t.addEventListener("click",()=>{e.click()}),e.addEventListener("change",async r=>{const o=document.getElementById("loading");if(r.target.files&&r.target.files.length>0){const s=r.target.files[0];n.textContent=s.name,n.style.fontStyle="normal",o&&(o.style.display="block");const l=s.name.split(".").pop().toLowerCase();try{l==="gpx"?await Eu(s):l==="csv"?await ku(s):l==="kml"?await Su(s):f.handleError("Unsupported file type. Please upload a .gpx or .csv file.")}catch(c){console.error("Error during track file processing:",c),f.handleError("Failed to process track file.")}finally{o&&(o.style.display="none")}}}),a.addEventListener("click",r=>{if(r.stopPropagation(),!i.map){f.handleError("Cannot clear track: map not initialized.");return}if(i.gpxLayer)try{i.map.hasLayer(i.gpxLayer)&&i.map.removeLayer(i.gpxLayer),i.gpxLayer=null,i.gpxPoints=[],i.isTrackLoaded=!1,e.value="",n.textContent="No file chosen",n.style.fontStyle="italic"}catch(o){f.handleError("Failed to clear track: "+o.message)}else f.handleMessage("No track to clear.")})}function Ku(){me(),Ke(),g.getValue("heightUnit","m");const t=document.getElementById("exportGpxButton");t&&t.addEventListener("click",async()=>{const n=me(),a=Ke(),r=g.getValue("heightUnit","m");await _u(n,a,r)});const e=document.getElementById("exportLandingPatternGpxButton");e&&e.addEventListener("click",()=>{console.log("DEBUG: Klick auf 'exportLandingPatternGpxButton' registriert."),Tu()})}function Yu(){if(!i.map){console.warn("Map not initialized, skipping setupCheckboxEvents");return}Fe("showExitAreaCheckbox","showExitArea",a=>{g.state.userSettings.showExitArea=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:jumpFeatureChanged"))}),Fe("showCanopyAreaCheckbox","showCanopyArea",a=>{g.state.userSettings.showCanopyArea=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:jumpFeatureChanged"))}),Fe("showJumpRunTrack","showJumpRunTrack",a=>{g.state.userSettings.showJumpRunTrack=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:showJumpRunTrackChanged",{detail:{checked:a.checked}}))}),Fe("showCutAwayFinder","showCutAwayFinder",a=>{g.state.userSettings.showCutAwayFinder=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:showCutAwayFinderChanged",{detail:{checked:a.checked}}))}),Fe("showLandingPattern","showLandingPattern",a=>{g.state.userSettings.showLandingPattern=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:landingPatternEnabled"))}),Fe("trackPositionCheckbox","trackPosition",a=>{g.state.userSettings.trackPosition=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:trackPositionToggled",{detail:{checked:a.checked}}))}),Fe("showJumpMasterLine","showJumpMasterLine",a=>{var o;if(a.checked&&!g.state.userSettings.trackPosition){a.checked=!1,f.handleError("Please start Live Tracking first.");return}g.state.userSettings.showJumpMasterLine=a.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:showJumpMasterLineChanged"));const r=(o=a.closest("li"))==null?void 0:o.querySelector("ul.submenu");r&&r.classList.toggle("hidden",!a.checked)}),xa("jumpMasterLineTarget",()=>{const a=g.getValue("jumpMasterLineTarget","radio","DIP");g.state.userSettings.jumpMasterLineTarget=a,g.save(),console.log("jumpMasterLineTarget changed:",a),document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged"))}),Fe("lockInteractionCheckbox","isInteractionLocked",a=>{const r=a.checked;g.state.userSettings.isInteractionLocked=r,g.save(),Qc(r),i.jumpRunTrackLayerGroup&&i.jumpRunTrackLayerGroup.eachLayer(o=>{o instanceof L.Marker&&o.options.icon&&o.options.icon.options.iconUrl.includes("airplane")&&(r?o.dragging.disable():o.dragging.enable())}),i.currentMarker&&(r?i.currentMarker.dragging.disable():i.currentMarker.dragging.enable()),i.harpMarker&&(r?i.harpMarker.dragging&&i.harpMarker.dragging.disable():i.harpMarker.dragging&&i.harpMarker.dragging.enable()),i.cutAwayMarker&&(r?i.cutAwayMarker.dragging.disable():i.cutAwayMarker.dragging.enable()),r?f.handleMessage("Map interactions are now locked."):f.handleMessage("Map interactions are now unlocked.")});const t=document.getElementById("placeHarpButton");t&&t.addEventListener("click",()=>{i.isPlacingHarp=!0,console.log("HARP placement mode activated"),i.map.on("click",Da),f.handleMessage("Click the map to place the HARP marker");const a=document.querySelector(".main-layout");a&&a.classList.remove("sidebar-expanded","data-panel-visible"),document.querySelectorAll(".sidebar-icon.active").forEach(r=>r.classList.remove("active")),setTimeout(()=>{i.map&&i.map.invalidateSize({animate:!0})},300)});const e=document.getElementById("clearHarpButton");e&&e.addEventListener("click",Dc);const n=document.querySelector(".hamburger-menu");n&&n.addEventListener("click",a=>{console.log("Menu click:",a.target,"class:",a.target.className,"id:",a.target.id)})}function Xu(){xa("landingDirection",()=>{}),xa("jumpMasterLineTarget",()=>{document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged"))}),document.querySelectorAll('input[name="ensembleScenario"]').forEach(a=>{a.addEventListener("change",async()=>{if(a.checked){if(g.state.userSettings.currentEnsembleScenario=a.value,i.currentEnsembleScenario=a.value,g.save(),console.log("Ensemble scenario changed to:",a.value),!g.state.userSettings.selectedEnsembleModels.every(s=>i.ensembleModelsData&&i.ensembleModelsData[s])&&a.value!=="all_models"&&!await Ka()){f.handleError("Failed to fetch data for scenario.");return}const o=me();St(o)}})});const e=g.state.userSettings.currentEnsembleScenario||"all_models",n=document.querySelector(`input[name="ensembleScenario"][value="${e}"]`);n&&(n.checked=!0,i.currentEnsembleScenario=e),i.map&&!i.ensembleLayerGroup&&(i.ensembleLayerGroup=L.layerGroup().addTo(i.map))}function Qu(){["refLevel","heightUnit","temperatureUnit","windUnit","timeZone","coordFormat","downloadFormat","maxForecastTime"].forEach(e=>{const n=document.getElementById(e);n?n.addEventListener("change",()=>{const a=n.value;g.state.userSettings[e]=a,g.save(),console.log(`Setting '${e}' changed to: ${a} and saved.`),document.dispatchEvent(new CustomEvent("ui:settingChanged",{detail:{name:e,value:a}}))}):console.warn(`Select element with id '${e}' not found.`)})}function ed(){const t=(e,n)=>{const a=document.getElementById(e);a&&a.addEventListener("blur",()=>{let r=parseInt(a.value)||n;const o=document.getElementById("legHeightFinal"),s=document.getElementById("legHeightBase"),l=document.getElementById("legHeightDownwind");if(!(!isNaN(r)&&r>=50&&r<=1e3&&f.validateLegHeights(o,s,l))){let u=n;const d=parseInt(o.value)||100,m=parseInt(s.value)||200,p=parseInt(l.value)||300;e==="legHeightFinal"&&(u=Math.min(m-1,100)),e==="legHeightBase"&&(u=Math.max(d+1,Math.min(p-1,200))),e==="legHeightDownwind"&&(u=Math.max(m+1,300)),a.value=u,r=u,f.handleError(`Adjusted ${e} to ${u} to maintain valid leg order.`)}g.state.userSettings[e]=r,g.save(),document.dispatchEvent(new CustomEvent("ui:inputChanged",{detail:{name:e,value:r}}))})};t("legHeightFinal",100),t("legHeightBase",200),t("legHeightDownwind",300),ue("lowerLimit","change",300),ue("upperLimit","change",300),ue("openingAltitude","change",300,e=>isNaN(e)||e<500||e>15e3?(f.handleError("Opening altitude must be between 500 and 15000 meters."),document.dispatchEvent(new CustomEvent("ui:invalidInput",{detail:{id:"openingAltitude",defaultValue:1200}})),!1):!0),ue("exitAltitude","change",300,e=>isNaN(e)||e<500||e>15e3?(f.handleError("Exit altitude must be between 500 and 15000 meters."),document.dispatchEvent(new CustomEvent("ui:invalidInput",{detail:{id:"exitAltitude",defaultValue:3e3}})),!1):!0),ue("safetyHeight","change",300),ue("canopySpeed","change",300),ue("descentRate","change",300),ue("interpStep","change",300,null),ue("customLandingDirectionLL","input",100),ue("customLandingDirectionRR","input",100),ue("jumpRunTrackDirection","change",0),ue("jumpRunTrackOffset","change",0),ue("jumpRunTrackForwardOffset","change",0),ue("aircraftSpeedKt","change",300),ue("numberOfJumpers","change",300),ue("jumperSeparation","change",300),ue("cutAwayAltitude","change",300),ue("terrainClearance","change",300),ue("historicalDatePicker","change",300)}function td(){const t=document.getElementById("downloadButton");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("ui:downloadClicked"))})}function nd(){const t=document.getElementById("clearHistoricalDate");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("ui:clearDateClicked"))})}function ad(){const t=document.getElementById("theme-toggle"),e=document.body,n=localStorage.getItem("theme");n&&(e.setAttribute("data-theme",n),t&&(t.textContent=n==="dark"?"Switch to Light Mode":"Switch to Dark Mode")),t&&t.addEventListener("click",()=>{const a=e.getAttribute("data-theme")==="dark";let r,o;if(a?(e.removeAttribute("data-theme"),localStorage.removeItem("theme"),t.textContent="Switch to Dark Mode",r="light",o="Esri Street"):(e.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark"),t.textContent="Switch to Light Mode",r="dark",o="CARTO Dark Matter"),i.map&&i.baseMaps[o]){for(const s in i.baseMaps)i.map.hasLayer(i.baseMaps[s])&&i.map.removeLayer(i.baseMaps[s]);i.map.addLayer(i.baseMaps[o]),g.state.userSettings.baseMaps=o,g.save(),console.log(`Theme switched to ${r}, basemap set to ${o}.`)}})}function rd(){const t=document.getElementById("alertCloudCover");t&&t.addEventListener("change",()=>{g.state.userSettings.alerts.clouds.cover=t.value,g.save(),document.dispatchEvent(new CustomEvent("ui:recalculateAlerts"))})}async function od(){const t=document.getElementById("map-alert-icon");t&&t.addEventListener("click",async()=>{const{highWinds:e,highGusts:n,thunderstorms:a,cloudAlerts:r}=ja(i.weatherData),o=document.getElementById("info-popup-container"),s=document.getElementById("info-popup-title"),l=document.getElementById("info-popup-list"),c=document.getElementById("info-popup-close");if(!o||!s||!l||!c)return;s.textContent="Active Weather Alert",l.innerHTML="";const u=m=>{const p=document.createElement("li");return p.textContent=m,p},d=g.getValue("timeZone","Z");if(e.length>0){const m=g.state.userSettings.alerts.wind.threshold,p=await f.getDisplayTime(i.weatherData.time[e[0]],i.lastLat,i.lastLng,d);l.appendChild(u(`High Winds (> ${m} kt) detected at ${p} and other times.`))}if(n.length>0){const m=g.state.userSettings.alerts.gust.threshold,p=await f.getDisplayTime(i.weatherData.time[n[0]],i.lastLat,i.lastLng,d);l.appendChild(u(`High Gusts (> ${m} kt) detected at ${p} and other times.`))}if(a.length>0){const m=await f.getDisplayTime(i.weatherData.time[a[0]],i.lastLat,i.lastLng,d);l.appendChild(u(`Thunderstorm forecast at ${m} and other times.`))}if(r.length>0){const m=g.state.userSettings.alerts.clouds,p=await f.getDisplayTime(i.weatherData.time[r[0]],i.lastLat,i.lastLng,d);l.appendChild(u(`Cloud base below ${m.base}m with at least ${m.cover} cover detected at ${p} and other times.`))}o.classList.remove("hidden"),c.onclick=()=>{o.classList.add("hidden")}})}function id(){Fe("alertWindEnabled","alerts.wind.enabled",n=>{g.state.userSettings.alerts.wind.enabled=n.checked,g.save(),console.log("[EventManager] Alert setting changed:","alertWindEnabled",n.checked,"- Dispatching ui:recalculateAlerts"),document.dispatchEvent(new CustomEvent("ui:recalculateAlerts"))}),Fe("alertGustEnabled","alerts.gust.enabled",n=>{g.state.userSettings.alerts.gust.enabled=n.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:recalculateAlerts"))}),Fe("alertThunderstormEnabled","alerts.thunderstorm.enabled",n=>{g.state.userSettings.alerts.thunderstorm.enabled=n.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:recalculateAlerts"))}),Fe("alertCloudsEnabled","alerts.clouds.enabled",n=>{g.state.userSettings.alerts.clouds.enabled=n.checked,g.save(),document.dispatchEvent(new CustomEvent("ui:recalculateAlerts"))});const t=document.getElementById("alertCloudCover");t&&t.addEventListener("change",()=>{g.state.userSettings.alerts.clouds.cover=t.value,g.save(),console.log("[EventManager] Alert setting changed:","alertCloudCover",t.value,"- Dispatching ui:recalculateAlerts"),document.dispatchEvent(new CustomEvent("ui:recalculateAlerts"))});const e=(n,a)=>{const r=document.getElementById(n);r&&r.addEventListener("change",f.debounce(()=>{const o=parseFloat(r.value);if(!isNaN(o)){const s=a.split(".");let l=g.state.userSettings;for(let c=0;c<s.length-1;c++)l=l[s[c]];l[s[s.length-1]]=o,g.save(),console.log("[EventManager] Alert setting changed:",n,o,"- Dispatching ui:recalculateAlerts"),document.dispatchEvent(new CustomEvent("ui:recalculateAlerts"))}},300))};e("alertWindThreshold","alerts.wind.threshold"),e("alertGustThreshold","alerts.gust.threshold"),e("alertCloudBase","alerts.clouds.base")}function sd(){const t=document.getElementById("app-management-settings");if(!t){console.error("Ziel-Container für App-Management-Buttons nicht gefunden.");return}const e=document.createElement("div");e.id="settings-cache-buttons",e.className="settings-grid";const n=document.createElement("button");n.id="resetButton",n.textContent="Reset Settings",n.title="Resets all settings to their default values and locks all features",n.className="btn btn-danger",n.addEventListener("click",()=>{confirm("Are you sure you want to reset all settings and lock all features?")&&(localStorage.removeItem("unlockedFeatures"),localStorage.removeItem("upperWindsSettings"),window.location.reload())}),e.appendChild(document.createElement("label")),e.appendChild(n);const a=document.createElement("button");a.id="clearCacheButton",a.textContent="Clear Tile Cache",a.title="Clears cached map tiles. Pan/zoom to cache more tiles for offline use.",a.className="btn btn-danger",a.addEventListener("click",async()=>{try{const r=await $e.getCacheSize();await $e.clearCache(),f.handleMessage(`Tile cache cleared successfully (freed ${r.toFixed(2)} MB).`)}catch(r){f.handleError("Failed to clear tile cache: "+r.message)}}),e.appendChild(document.createElement("label")),e.appendChild(a),t.appendChild(e)}function ld(){const t=document.getElementById("cacheRadiusSelect");t?(t.value=g.state.userSettings.cacheRadiusKm||10,t.addEventListener("change",()=>{if(!g.state||!g.state.userSettings){console.error("Settings not properly initialized");return}let r=parseInt(t.value,10);isNaN(r)||r<1?(r=1,f.handleMessage("Cache radius must be at least 1 km.")):r>50&&(r=50,f.handleMessage("Cache radius cannot exceed 50 km.")),t.value=r,g.state.userSettings.cacheRadiusKm=r,g.save(),console.log("Updated cacheRadiusKm:",g.state.userSettings.cacheRadiusKm)}),console.log("cacheRadiusSelect listener attached, initial value:",t.value)):console.warn("cacheRadiusSelect not found in DOM");const e=document.getElementById("cacheZoomMin"),n=document.getElementById("cacheZoomMax");if(e&&n){const r=()=>{let s=parseInt(e.value,10),l=parseInt(n.value,10);(isNaN(s)||s<6)&&(s=6),(isNaN(l)||l>15)&&(l=15),s>l&&(l=s,n.value=l,f.handleMessage("Max zoom cannot be less than min zoom.")),e.value=s,n.value=l;const c=Array.from({length:l-s+1},(u,d)=>s+d);g.state.userSettings.cacheZoomLevels=c,g.save(),console.log("Updated cacheZoomLevels:",g.state.userSettings.cacheZoomLevels)},o=g.state.userSettings.cacheZoomLevels||[11,12,13,14];e.value=Math.min(...o),n.value=Math.max(...o),e.addEventListener("change",r),n.addEventListener("change",r)}else console.warn("Zoom level input fields not found in DOM");const a=document.getElementById("recacheNowButton");a?(a.addEventListener("click",()=>{pi({map:i.map,lastLat:i.lastLat,lastLng:i.lastLng,baseMaps:i.baseMaps,onProgress:cn,onComplete:r=>{it(),r&&ht(r)},onCancel:()=>{it(),ht("Caching cancelled.")}})}),console.log("recacheNowButton listener attached")):console.warn("recacheNowButton not found in DOM")}function cd(){const t=document.getElementById("harpCoordInput"),e=document.getElementById("placeHarpCoordButton"),n=document.querySelector('input[name="jumpMasterLineTarget"][value="HARP"]');if(!t||!e||!n){console.warn("HARP coordinate input elements not found. Skipping setup.");return}e.addEventListener("click",async()=>{const a=t.value.trim();if(!a){f.handleError("Please enter coordinates.");return}const r=vi(a);if(r){i.harpMarker&&i.map.removeLayer(i.harpMarker),i.harpMarker=Mi(r.lat,r.lng).addTo(i.map),i.map.panTo([r.lat,r.lng]),g.state.userSettings.harpLat=r.lat,g.state.userSettings.harpLng=r.lng,g.state.userSettings.jumpRunTrackOffset=0,g.state.userSettings.jumpRunTrackForwardOffset=0,console.log("HARP placed via coords. JRT offsets reset to 0."),g.save(),f.handleMessage("HARP marker placed successfully."),n.disabled=!1,n.checked=!0,document.dispatchEvent(new CustomEvent("ui:jumpMasterLineTargetChanged")),document.dispatchEvent(new CustomEvent("ui:recalculateJump")),document.dispatchEvent(new CustomEvent("harp:updated"));const o=document.querySelector(".main-layout");o&&o.classList.remove("sidebar-expanded","data-panel-visible"),document.querySelectorAll(".sidebar-icon.active").forEach(s=>s.classList.remove("active")),setTimeout(()=>{i.map&&i.map.invalidateSize({animate:!0})},300)}else f.handleError("Invalid coordinates. Please enter a valid MGRS or Decimal Degree format.")})}function ud(){const t=document.getElementById("findJumpShipBtn");t&&t.addEventListener("click",()=>{Ai()}),document.addEventListener("adsb:showSelection",n=>{const{aircraftList:a}=n.detail,r=document.getElementById("adsbSelectionModal"),o=document.getElementById("aircraftList"),s=document.getElementById("adsbCancel");!r||!o||!s||(o.innerHTML="",a.sort((l,c)=>c.altitude-l.altitude),a.forEach(l=>{const c=document.createElement("li");c.textContent=`${l.callsign} / ${l.altitude} ft`,c.onclick=()=>{r.style.display="none",xu(l)},o.appendChild(c)}),s.onclick=()=>{r.style.display="none"},r.style.display="flex")}),document.addEventListener("adsb:aircraftSelected",n=>{const{aircraft:a,attribution:r}=n.detail;i.aircraftMarker&&i.map.removeLayer(i.aircraftMarker),Zr(),Wc(a.lat,a.lon,a.track).bindTooltip("",{permanent:!0,direction:"top",offset:[0,-15],className:"adsb-tooltip"}),i.map&&i.map.attributionControl&&i.map.attributionControl.addAttribution(r),document.dispatchEvent(new CustomEvent("adsb:aircraftUpdated",{detail:{aircraft:a}}))}),document.addEventListener("adsb:aircraftUpdated",n=>{const{aircraft:a}=n.detail;i.aircraftMarker&&a.lat&&a.lon&&(i.aircraftMarker.setLatLng([a.lat,a.lon]),a.track&&i.aircraftMarker.setRotationAngle(a.track),e(a),kc(i.adsbTrackPoints))}),document.addEventListener("adsb:trackingStopped",n=>{const{attribution:a}=n.detail;i.aircraftMarker&&(i.map.removeLayer(i.aircraftMarker),i.aircraftMarker=null),Zr(),i.map&&i.map.attributionControl&&i.map.attributionControl.removeAttribution(a)});function e(n){if(!i.aircraftMarker)return;const a=g.getValue("heightUnit","m"),r=g.getValue("windUnit","kt"),o=n.altitude,s=a==="m"?`${Math.round(o*.3048)} m`:`${o} ft`,l=n.velocity,c=f.convertWind(l,r,"kt"),d=Number.isFinite(c)?`${r==="bft"?Math.round(c):c.toFixed(0)} ${r}`:"N/A";let m="Level";if(n.vertical_rate){const h=n.vertical_rate;h>100?m=`+${h} ft/min`:h<-100&&(m=`${h} ft/min`)}const p=`
            <strong>${n.callsign||"N/A"}</strong><br>
            Altitude: ${s}<br>
            Speed: ${d}<br>
            V/S: ${m}
        `;i.aircraftMarker.setTooltipContent(p)}}function dd(t){const e=document.getElementById("ensembleModelsSubmenu");e&&(e.innerHTML="",t.forEach(n=>{const a=document.createElement("li"),r=document.createElement("label");r.className="radio-label";const o=document.createElement("input");o.type="checkbox",o.name="ensembleModel",o.value=n,o.checked=g.state.userSettings.selectedEnsembleModels.includes(n),o.addEventListener("change",async()=>{const s=Array.from(e.querySelectorAll("input:checked")).map(c=>c.value);if(g.state.userSettings.selectedEnsembleModels=s,g.save(),await Ka()){const c=me();St(c)}}),r.append(o,` ${n.replace(/_/g," ").toUpperCase()}`),a.appendChild(r),e.appendChild(a)}))}function md(){const t=document.getElementById("findPoisInViewBtn");if(!t){console.warn("POI search button not found.");return}t.addEventListener("click",async()=>{if(!i.map){f.handleError("Map is not available.");return}const e=i.map.getZoom(),n=10;if(e<n){ot(`Please zoom in to Level ${n}+ to search for dropzones.`);return}try{Ut(!0,"Searching for Dropzones...");const a=i.map.getBounds(),r=a.getSouthWest(),o=a.getNorthEast(),s=await fc(r.lat,r.lng,o.lat,o.lng);Rc(s);const l=await Za(()=>Promise.resolve().then(()=>iu),void 0);l&&typeof l.renderResultsList=="function"&&l.renderResultsList(s)}catch(a){console.error("Error during POI search:",a),f.handleError("An error occurred during the search.")}finally{Ut(!1)}})}function hd(){Kr||(console.log("Initializing all UI event listeners..."),Fu(),$u(),Ou(),Ru(),Wu(),Hu(),Bu(),Gu(),Yu(),Xu(),Qu(),ed(),td(),nd(),ad(),rd(),od(),id(),zu(),Vu(),Zu(),ju(),Ju(),qu(),Ku(),sd(),ld(),cd(),ud(),md(),Uu(),document.addEventListener("loading:start",t=>Ut(!0,t.detail.message)),document.addEventListener("loading:stop",()=>Ut(!1)),Kr=!0,console.log("Event listeners initialized successfully (first and only time)."))}function Yr(){if(i.autoupdateInterval){console.log("[AutoupdateManager] Autoupdate is already running.");return}if(!navigator.onLine){f.handleError("Cannot enable autoupdate while offline.");const t=document.getElementById("autoupdateCheckbox");t&&(t.checked=!1),g.state.userSettings.autoupdate=!1,g.save();return}console.log("[AutoupdateManager] Starting autoupdate interval."),document.dispatchEvent(new CustomEvent("autoupdate:tick",{detail:{isInitialTick:!0}})),i.autoupdateInterval=setInterval(()=>{console.log("[AutoupdateManager] Tick..."),document.dispatchEvent(new CustomEvent("autoupdate:tick",{detail:{isInitialTick:!1}}))},60*1e3),f.handleMessage("Autoupdate enabled")}function Ii(){i.autoupdateInterval&&(clearInterval(i.autoupdateInterval),i.autoupdateInterval=null,console.log("[AutoupdateManager] Stopped autoupdate interval."),f.handleMessage("Autoupdate disabled"))}function gd(){var e;const t=document.getElementById("autoupdateCheckbox");if(!t){console.warn("[AutoupdateManager] Autoupdate checkbox not found.");return}t.checked=g.state.userSettings.autoupdate,t.addEventListener("change",()=>{g.state.userSettings.autoupdate=t.checked,g.save();const n=document.getElementById("historicalDatePicker");if(t.checked&&(n!=null&&n.value)){t.checked=!1,g.state.userSettings.autoupdate=!1,g.save(),f.handleError("Autoupdate cannot be enabled with a historical date set.");return}t.checked?Yr():Ii()}),g.state.userSettings.autoupdate&&!((e=document.getElementById("historicalDatePicker"))!=null&&e.value)&&Yr()}let Cn=!1,tn=null;async function fd(){i.watchId!==null||Cn||(Cn=!0,tn||(tn=(async()=>{console.log("[LiveTrackingManager] Attempting to start position tracking...");const t=localStorage.getItem("hasAcknowledgedLocationDisclosure"),e=async()=>{const{Geolocation:n,isNative:a}=await Jt();if(console.log("[LiveTrackingManager] Platform:",a?window.Capacitor.getPlatform():"Web","IsNative:",a),a&&n)try{const r=await yd();if(console.log("[LiveTrackingManager] Permissions result:",r),!r){console.warn("[LiveTrackingManager] Permissions not granted, stopping tracking.");return}const o=await n.watchPosition({enableHighAccuracy:!0,timeout:1e4,maximumAge:0},(s,l)=>{if(l){console.error("[LiveTrackingManager] Geolocation error:",l),f.handleError(`Geolocation error: ${l.message||"Unknown error"}`),In();return}s&&(console.log("[LiveTrackingManager] Received position:",s.coords),Xr(s))});i.watchId=o,console.log("[LiveTrackingManager] Native Geolocation watcher started:",o),document.dispatchEvent(new CustomEvent("tracking:started"))}catch(r){console.error("[LiveTrackingManager] Failed to start native tracking:",r),f.handleError(`Failed to start tracking: ${r.message||"Unknown error"}`),In()}else{if(console.log("[LiveTrackingManager] Using navigator.geolocation for tracking (Web)."),!navigator.geolocation){f.handleError("Geolocation is not supported by your browser."),document.dispatchEvent(new CustomEvent("tracking:stopped"));return}i.watchId=navigator.geolocation.watchPosition(r=>{console.log("[LiveTrackingManager] Web position:",r.coords),Xr(r)},r=>{console.error("[LiveTrackingManager] Web Geolocation error:",r),f.handleError(`Geolocation error: ${r.message||"Unknown error"}`),In()},{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}),console.log("[LiveTrackingManager] Web Geolocation watcher started:",i.watchId),document.dispatchEvent(new CustomEvent("tracking:started"))}};t?e():lc({title:"Notice on Location Use",message:"DZMaster collects location data to enable the functions <strong>'Live Tracking'</strong> and <strong>'Automatic Jump Recording'</strong>. This also happens when the app is running in the background or the screen is off in order to record your complete jump. This data is only stored locally on your device and is not shared.",onConfirm:()=>{localStorage.setItem("hasAcknowledgedLocationDisclosure","true"),e()},onCancel:()=>{const n=document.getElementById("trackPositionCheckbox");n&&(n.checked=!1),g.state.userSettings.trackPosition=!1,g.save(),f.handleMessage("Location access canceled.")}}),Cn=!1,tn=null})()),await tn)}async function In(){if(i.watchId!==null){const{Geolocation:t,isNative:e}=await Jt();if(e&&t)try{await t.clearWatch({id:i.watchId}),console.log("[LiveTrackingManager] Stopped native Geolocation watcher:",i.watchId)}catch(n){console.error("[LiveTrackingManager] Error stopping native watcher:",n)}else navigator.geolocation&&(navigator.geolocation.clearWatch(i.watchId),console.log("[LiveTrackingManager] Stopped navigator.geolocation watcher:",i.watchId));i.watchId=null}i.liveMarker&&i.map.removeLayer(i.liveMarker),i.accuracyCircle&&i.map.removeLayer(i.accuracyCircle),i.liveMarker=null,i.accuracyCircle=null,i.prevLat=null,i.prevLng=null,i.altitudeCorrectionOffset=0,i.prevTime=null,i.prevAltitude=null,i.lastSmoothedSpeedMs=0,i.lastSmoothedRateOfClimbMps=0,i.lastDirection="N/A",i.lastDeviceAltitude=null,i.lastAltitudeAccuracy=null,i.lastAccuracy=null,i.altitudeCorrectionPerformed=!1,Cn=!1,tn=null,document.dispatchEvent(new CustomEvent("tracking:stopped"))}const Xr=f.debounce(async t=>{if(console.log("[LiveTrackingManager] Received position data:",t),!i.map){console.warn("[LiveTrackingManager] Map not initialized, skipping position update.");return}const{latitude:e,longitude:n,accuracy:a,altitude:r,altitudeAccuracy:o}=t.coords;if(!i.altitudeCorrectionPerformed&&r!==null&&i.lastAltitude!=="N/A"){i.altitudeCorrectionPerformed=!0;const y=Math.abs(r-i.lastAltitude);y<150?(i.altitudeCorrectionOffset=r-i.lastAltitude,console.log(`Bodenstart erkannt. Korrektur-Offset berechnet: ${i.altitudeCorrectionOffset.toFixed(2)}m`)):(i.altitudeCorrectionOffset=0,console.warn(`Start in der Luft erkannt (Höhendifferenz: ${y.toFixed(0)}m). Es wird keine Höhenkorrektur angewendet.`),f.handleMessage("Airborne start: Altitudes are uncorrected (Ellipsoid)."))}const s=r!==null&&i.altitudeCorrectionOffset!==0?r-i.altitudeCorrectionOffset:r,c=!i.liveMarker?500:je.GEOLOCATION_ACCURACY_THRESHOLD_M;if(a>c){console.log(`[LiveTrackingManager] Skipping position update. Accuracy (${a}m) is lower than threshold (${c}m).`);return}const u=Date.now();let d=0,m="N/A",p=0;if(i.prevLat!==null&&i.prevLng!==null&&i.prevTime!==null&&i.prevAltitude!==null){const y=(u-i.prevTime)/1e3;y>Sn.MIN_TIME_DIFF_FOR_SPEED_CALC_S&&(d=i.map.distance([i.prevLat,i.prevLng],[e,n])/y,m=f.calculateBearing(i.prevLat,i.prevLng,e,n),p=(r-i.prevAltitude)/y)}const h=d<Sn.SPEED_SMOOTHING_TRESHOLD?Sn.SPEED_SMOOTHING_LOW:Sn.SPEED_SMOOTHING_HIGH;i.lastSmoothedSpeedMs=h*d+(1-h)*i.lastSmoothedSpeedMs;const v=.5;i.lastSmoothedRateOfClimbMps=v*p+(1-v)*(i.lastSmoothedRateOfClimbMps||0),i.liveMarker?(i.liveMarker.setLatLng([e,n]),i.liveMarker.setIcon(Qr(m))):i.liveMarker=L.marker([e,n],{icon:Qr(m),zIndexOffset:1e3,pmIgnore:!0}).addTo(i.map),a&&pd(e,n,a),i.prevLat=e,i.prevLng=n,i.prevTime=u,i.prevAltitude=r;const b=new CustomEvent("tracking:positionUpdated",{detail:{latitude:e,longitude:n,deviceAltitude:s,altitudeAccuracy:o,accuracy:a,speedMs:i.lastSmoothedSpeedMs,rateOfClimbMps:i.lastSmoothedRateOfClimbMps,direction:typeof m=="number"?m.toFixed(0):"N/A"},bubbles:!0,cancelable:!0});console.log("[LiveTrackingManager] Dispatching tracking:positionUpdated with data:",b.detail),document.dispatchEvent(b)},300);function Qr(t){const n=`
        <div class="live-marker-wrapper" style="transform: rotate(${typeof t=="number"&&isFinite(t)?t:0}deg);">
            <div class="live-marker-dot"></div>
            <div class="live-marker-arrow"></div>
        </div>
    `;return L.divIcon({className:"live-marker-container",html:n,iconSize:[24,24],iconAnchor:[12,12],pmIgnore:!0})}function pd(t,e,n){i.accuracyCircle&&i.map.removeLayer(i.accuracyCircle),i.accuracyCircle=L.circle([t,e],{radius:n,color:"blue",fillOpacity:.1,weight:1,dashArray:"5, 5",pmIgnore:!0}).addTo(i.map)}async function yd(){try{const{Geolocation:t,isInitialized:e}=await Jt();if(!e)return console.error("Capacitor not fully initialized"),!1;await new Promise(a=>setTimeout(a,100));const n=await t.checkPermissions();if(console.log("Initial geolocation permissions state:",n),n.location==="denied")return f.handleError('GPS permission was denied. Please enable "Always" in the app settings.'),!1;if(n.location!=="granted")try{const a=await t.requestPermissions({permissions:["location","coarseLocation"]});if(console.log("New geolocation permissions state:",a),a.location!=="granted")return f.handleError("GPS permission is required for live tracking."),!1}catch(a){return console.error("[LiveTrackingManager] Permission request error:",a),f.handleError(`Failed to request permissions: ${a.message}`),!1}return!0}catch(t){return console.error("Error in checkAndRequestPermissions:",t),f.handleError("Could not check location permissions."),!1}}let kt=null,_t=null;function eo(t,e){return t<=5?e.getPropertyValue("--cc-clear").trim():t<=25?e.getPropertyValue("--cc-few").trim():t<=50?e.getPropertyValue("--cc-sct").trim():t<=87?e.getPropertyValue("--cc-bkn").trim():e.getPropertyValue("--cc-ovc").trim()}async function $t(t){console.log(`[Meteogram] Starting generateMeteogram for slider index: ${t}...`);const e=g.getValue("temperatureUnit","C");console.log(`[Meteogram] Current tempUnit setting: ${e}`);const n=document.getElementById("meteogramUpperChart"),a=document.getElementById("meteogramSurfaceChart"),r=n==null?void 0:n.previousElementSibling,o=a==null?void 0:a.previousElementSibling;if(wd(),!n||!a||!r||!o){console.warn("[Meteogram] Canvas oder Titel Elemente nicht gefunden.");return}if(!i.weatherData||!i.weatherData.time||i.weatherData.time.length===0||t<0||t>=i.weatherData.time.length){console.warn("[Meteogram] Keine Wetterdaten verfügbar."),r.textContent="Upper Air (Wind & Clouds)",o.textContent="Surface Conditions",Nt(n,"No weather data loaded."),Nt(a,"No weather data loaded.");return}console.log("[Meteogram] Canvas and weather data found. Proceeding...");const s=n.getContext("2d"),l=a.getContext("2d"),c=i.weatherData,u=g.getValue("heightUnit","m"),d=g.getValue("windUnit","kt"),m=g.getValue("timeZone","Z"),p=Math.round(i.lastAltitude)||0,h=getComputedStyle(document.body),v=h.getPropertyValue("--border-color").trim(),b=h.getPropertyValue("--text-primary").trim(),y=b,S=h.getPropertyValue("--color-success").trim(),w=4500,M=15e3,E=500,k=1e3,_=100,A=300,T=u==="ft"?M:w,C=u==="ft"?k:E,I=u==="ft"?A:_,P=u==="ft"?[1500,3e3,5e3,7e3,9e3,11e3,13e3,15e3]:[500,1e3,1500,2e3,2500,3e3,3500,4e3,4500],F=h.getPropertyValue("--wind-exceeding").trim(),N=h.getPropertyValue("--cc-few").trim(),U="rgb(200, 200, 200)",G="rgb(200, 0, 0)";let O="utc";m.toLowerCase()==="loc"&&i.lastLat!=null&&i.lastLng!=null&&(O=(await f.getLocationData(i.lastLat,i.lastLng)).timezone||"utc");const z=$.fromISO(c.time[t],{zone:"utc"}).setZone(O).startOf("day"),Y=z.toFormat("yyyy-MM-dd"),ee=[],Q=[];for(let j=0;j<c.time.length;j++){const X=$.fromISO(c.time[j],{zone:"utc"}).setZone(O);X.hasSame(z,"day")&&(ee.push(j),Q.push(X.toFormat(m.toLowerCase()==="loc"?"HH":"HH'Z'")))}if(ee.length===0){console.warn(`[Meteogram] No data found for the selected date: ${Y}`),r.textContent=`Upper Air - ${Y}`,o.textContent=`Surface - ${Y}`,Nt(n,"No data for selected day."),Nt(a,"No data for selected day.");return}console.log(`[Meteogram] Processing data for date: ${Y}. Indices: ${ee[0]} to ${ee[ee.length-1]}. Found ${ee.length} data points.`);const q=[],se=[],he=[],ve=[],Le=[],ce=[],de=[];console.log("[Meteogram] Starting data processing loop for selected day...");let Ae=0;for(const j of ee){const X=Q[Ae];Ae++;const ie=c.temperature_2m[j],B=c.relative_humidity_2m[j];let te=null;ie!==null&&!isNaN(ie)&&(te=e==="F"?f.convertTemperature(ie,"°F"):ie,(typeof te!="number"||isNaN(te))&&(te=null)),ve.push(te);let ne=null;const We=f.calculateDewpoint(ie,B);We!==null&&!isNaN(We)&&(ne=e==="F"?f.convertTemperature(We,"°F"):We,(typeof ne!="number"||isNaN(ne))&&(ne=null)),Le.push(ne),Ae<=5&&console.log(`[Meteogram DayLoop i=${j}] TempC: ${ie}, PushedTemp(${e==="F"?"°F":"°C"}): ${te}`);const qt=c.wind_gusts_10m[j],Ce=c.wind_speed_10m[j];ce.push(Ce!==null?parseFloat(f.convertWind(Ce,d,"km/h").toFixed(1)):null),de.push(qt!==null?parseFloat(f.convertWind(qt,d,"km/h").toFixed(1)):null);const Ie=Se(c,j,100,p,"m");if(!Ie||Ie.length===0){console.warn(`[Meteogram] Interpolation failed for index ${j}. Skipping upper air data for this hour.`),he.push(null);continue}let De=null;for(let ge=0;ge<Ie.length-1;ge++){const Ue=Ie[ge],He=Ie[ge+1];if(Ue.temp!=="N/A"&&He.temp!=="N/A"&&(Ue.temp>=0&&He.temp<0||Ue.temp<0&&He.temp>=0)){const ke=parseFloat(Ue.temp),yt=parseFloat(He.temp),Xe=Ue.height-p,Be=He.height-p;if(Math.abs(ke-yt)>.01){const pn=(0-ke)/(yt-ke);De=Xe+pn*(Be-Xe)}else De=(Xe+Be)/2;De>w?De=null:De<0&&(De=0);break}}De===null&&Ie.length>0&&Ie[0].temp!=="N/A"&&parseFloat(Ie[0].temp)<=0&&(De=0),he.push(De!==null?Math.round(f.convertHeight(De,u)):null);const qn=ee.length>24?4:2;Ae%qn===1&&P.forEach(ge=>{const Ue=u==="ft"?f.convertFeetToMeters(ge):ge;if(Ue>w)return;const He=p+Ue;let ke=null,yt=1/0;if(Ie.forEach(Xe=>{const Be=Math.abs(Xe.height-He);Be<yt&&(yt=Be,ke=Xe)}),ke&&ke.spd!=="N/A"&&ke.dir!=="N/A"){const Xe=parseFloat(f.convertWind(ke.spd,"kt","km/h").toFixed(1));q.push({x:X,y:ge,speedKt:Xe,direction:Math.round(ke.dir)})}});for(let ge=0;ge<T;ge+=I){const Ue=ge,He=ge+I,ke=ge+I/2,yt=u==="ft"?f.convertFeetToMeters(ke):ke,Xe=p+yt;let Be=null,pn=1/0;Ie.forEach(sr=>{const lr=Math.abs(sr.height-Xe);lr<pn&&(pn=lr,Be=sr)});let ir=0;Be&&Be.cc!=="N/A"&&!isNaN(Be.cc)&&(ir=Number(Be.cc)),se.push({x:X,y:[Ue,He],cover:ir})}}console.log(`[Meteogram] Data processing loop finished. ${Q.length} time labels generated for date: ${Y}`),r&&o&&(r.textContent=`Upper Air - ${Y}`,o.textContent=`Surface - ${Y}`),console.log(`[Meteogram] Creating ${q.length} wind barb images...`);const st=q.map(j=>new Promise(X=>{const ie=new Image(40,40);try{const B=f.generateWindBarb(j.direction,j.speedKt,null,y);if(!B||!B.startsWith("<svg")||!B.endsWith("</svg>"))throw new Error("Invalid SVG");ie.src=`data:image/svg+xml;base64,${btoa(B)}`,ie.rawData=j,ie.onload=()=>X(ie),ie.onerror=()=>X(null)}catch{X(null)}}));try{const j=await Promise.all(st);console.log(`[Meteogram] ${j.filter(B=>B).length} wind barb images loaded.`);const X=j.filter(B=>B).map(B=>({x:B.rawData.x,y:B.rawData.y,image:B})),ie=[{label:"Cloud Cover",data:se,backgroundColor:B=>eo(B.raw.cover,h),borderColor:B=>eo(B.raw.cover,h),borderWidth:1,barPercentage:1,categoryPercentage:1,order:2},{label:`Wind (${d})`,data:X,type:"scatter",pointStyle:X.map(B=>B.image),pointRadius:15,order:1},{label:"Freezing Level (0°C)",data:he,type:"line",borderColor:S,borderWidth:1.5,borderDash:[5,5],pointRadius:0,tension:.1,yAxisID:"y",order:0}];kt&&(console.log("[Meteogram] Destroying existing Upper Chart instance before recreation."),kt.destroy(),kt=null,n.getContext("2d").clearRect(0,0,n.width,n.height)),kt=new Chart(s,{type:"bar",data:{labels:Q,datasets:ie},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"x",interaction:{mode:"nearest",axis:"xy",intersect:!1},scales:{x:{stacked:!0,ticks:{display:!0,color:b,maxRotation:0,autoSkipPadding:20},grid:{color:v}},y:{title:{display:!0,text:`Altitude AGL (${u})`,color:b},min:0,max:T,ticks:{color:b,stepSize:C},grid:{color:v},stacked:!0}},plugins:{legend:{display:!0,labels:{color:b,filter:B=>B.text==="Freezing Level (0°C)"}},tooltip:{enabled:!0,mode:"nearest",intersect:!1,callbacks:{title:function(B){const te=B[0];if(!te||!te.raw)return te.label||"";const ne=te.raw.image?te.raw.image.rawData:te.raw;return ne?te.dataset.label.startsWith("Wind")?`Alt: ${ne.y} ${u} AGL at ${ne.x}`:te.dataset.label==="Freezing Level"?`Time: ${te.label}`:te.dataset.label==="Cloud Cover"?`Alt: ${ne.y[0]}-${ne.y[1]} ${u} AGL at ${ne.x}`:te.label||ne.x:te.label||""},label:function(B){if(!B||!B.raw)return"";const te=B.raw.image?B.raw.image.rawData:B.raw;if(!te)return"";if(B.dataset.label.startsWith("Wind")){const ne=f.convertWind(te.speedKt,d,"kt"),We=d==="bft"?Math.round(ne):ne.toFixed(1);return` Wind: ${te.direction}° / ${We} ${d}`}else{if(B.dataset.label==="Cloud Cover")return` Cover: ${te.cover.toFixed(0)}%`;if(B.dataset.label==="Freezing Level"){const ne=typeof B.raw=="number"?B.raw:null,We=ne!==null?ne:"Above Max";return` ${B.dataset.label}: ${We}${ne!==null?" "+u+" AGL":""}`}}return""}}}}}}),console.log("[Meteogram] Upper Chart instance created successfully.")}catch(j){console.error("[Meteogram] Error creating Upper Chart after image loading:",j),Nt(n,"Error displaying chart.")}console.log("[Meteogram] Surface Chart Data:",{});try{const j=[{label:`Temp (${e==="F"?"°F":"°C"})`,data:ve,borderColor:F,backgroundColor:"transparent",borderWidth:1.25,tension:.1,yAxisID:"yTempSurface",order:1},{label:`Dew Point (${e==="F"?"°F":"°C"})`,data:Le,borderColor:N,backgroundColor:"transparent",borderWidth:1.25,tension:.1,yAxisID:"yTempSurface",order:1},{label:`Wind (${d})`,data:ce,borderColor:U,borderWidth:3,borderDash:[],tension:.1,yAxisID:"yWindSurface",order:0},{label:`Gusts (${d})`,data:de.map((X,ie)=>X!==null&&ce[ie]!==null&&X>ce[ie]?X:null),type:"scatter",pointStyle:"triangle",pointRadius:5,pointBackgroundColor:G,showLine:!1,yAxisID:"yWindSurface",order:-1}];_t&&(console.log("[Meteogram] Destroying existing Surface Chart instance before recreation."),_t.destroy(),_t=null,a.getContext("2d").clearRect(0,0,a.width,a.height)),_t=new Chart(l,{type:"line",data:{labels:Q,datasets:j},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},scales:{x:{title:{display:!0,text:`Time (${m})`,color:b},ticks:{color:b,maxRotation:0,autoSkipPadding:20},grid:{color:v}},yTempSurface:{type:"linear",position:"right",title:{display:!0,text:`Temperature (${e==="F"?"°F":"°C"})`,color:b},ticks:{color:b},grid:{color:v}},yWindSurface:{type:"linear",position:"left",title:{display:!0,text:`Wind Speed (${d})`,color:b},ticks:{color:b},grid:{drawOnChartArea:!1},min:0}},plugins:{legend:{labels:{color:b}},tooltip:{mode:"index",intersect:!1}}}}),console.log("[Meteogram] Surface Chart instance created successfully.")}catch(j){console.error("[Meteogram] Error creating Surface Chart:",j),Nt(a,"Error displaying chart.")}console.log("[Meteogram] Finished generateMeteogram.")}function wd(){if(kt){console.log("[Meteogram] Destroying existing Upper Chart instance."),kt.destroy(),kt=null;const t=document.getElementById("meteogramUpperChart");t&&(t.getContext("2d").clearRect(0,0,t.width,t.height),console.log("[Meteogram] Cleared Upper Chart canvas."))}else console.log("[Meteogram] No existing Upper Chart instance to destroy.");if(_t){console.log("[Meteogram] Destroying existing Surface Chart instance."),_t.destroy(),_t=null;const t=document.getElementById("meteogramSurfaceChart");t&&(t.getContext("2d").clearRect(0,0,t.width,t.height),console.log("[Meteogram] Cleared Surface Chart canvas."))}else console.log("[Meteogram] No existing Surface Chart instance to destroy.")}function Nt(t,e){if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const a=getComputedStyle(document.body);n.fillStyle=a.getPropertyValue("--text-secondary").trim(),n.textAlign="center",n.font="14px Roboto",n.fillText(e,t.width/2,t.height/2),console.log(`[Meteogram] Displayed placeholder on canvas: "${e}"`)}const vd=f.debounce($t,250),Di=f.debounce(pe,300);L.Control.Coordinates=L.Control.extend({options:{position:"bottomleft"},onAdd:function(t){var e=L.DomUtil.create("div","leaflet-control-coordinates");return e.style.background="rgba(255, 255, 255, 0.8)",e.style.padding="5px",e.style.borderRadius="4px",e.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",e.innerHTML="Move mouse over map",this._container=e,e},update:function(t){this._container.innerHTML=t}});f.setErrorHandler(Fn);f.setMessageHandler(ht);f.handleMessage=ht;const Pi=()=>g.getValue("temperatureUnit","radio","C"),Bt=()=>g.getValue("heightUnit","radio","m"),Wn=()=>g.getValue("windUnit","radio","kt"),Ni=()=>g.getValue("coordFormat","radio","Decimal"),Ld=()=>g.getValue("downloadFormat","radio","csv");function bd(){Yl(!0),g.initialize(),g.state.isPlannerUnlocked=g.state.unlockedFeatures.planner,console.log("Initial unlock status for planner:",g.state.isPlannerUnlocked),!i.isInitialized&&(i.isInitialized=!0,console.log("Initializing app"))}function Md(){Ze("modelSelect",g.state.userSettings.model),Ze("refLevel",g.state.userSettings.refLevel),Ze("heightUnit",g.state.userSettings.heightUnit),Ze("temperatureUnit",g.state.userSettings.temperatureUnit),Ze("windUnit",g.state.userSettings.windUnit),Ze("timeZone",g.state.userSettings.timeZone),Ze("coordFormat",g.state.userSettings.coordFormat),Ze("downloadFormat",g.state.userSettings.downloadFormat),Ze("maxForecastTime",g.state.userSettings.maxForecastTime),Cd("landingDirection",g.state.userSettings.landingDirection),ae("canopySpeed",g.state.userSettings.canopySpeed),ae("descentRate",g.state.userSettings.descentRate),ae("legHeightDownwind",g.state.userSettings.legHeightDownwind),ae("legHeightBase",g.state.userSettings.legHeightBase),ae("legHeightFinal",g.state.userSettings.legHeightFinal),ae("customLandingDirectionLL",g.state.userSettings.customLandingDirectionLL),ae("customLandingDirectionRR",g.state.userSettings.customLandingDirectionRR),ae("lowerLimit",g.state.userSettings.lowerLimit),ae("upperLimit",g.state.userSettings.upperLimit),ae("openingAltitude",g.state.userSettings.openingAltitude),ae("exitAltitude",g.state.userSettings.exitAltitude),ae("safetyHeight",g.state.userSettings.safetyHeight),Ze("interpStep",g.state.userSettings.interpStep),ae("aircraftSpeedKt",g.state.userSettings.aircraftSpeedKt),ae("jumpRunTrackOffset",g.state.userSettings.jumpRunTrackOffset),ae("numberOfJumpers",g.state.userSettings.numberOfJumpers),Ve("showTableCheckbox",g.state.userSettings.showTable),Ve("calculateJumpCheckbox",g.state.userSettings.calculateJump),Ve("showLandingPattern",g.state.userSettings.showLandingPattern),Ve("showJumpRunTrack",g.state.userSettings.showJumpRunTrack),Ve("showCanopyAreaCheckbox",g.state.userSettings.showCanopyArea),Ve("showExitAreaCheckbox",g.state.userSettings.showExitArea),Ve("showCutAwayFinder",g.state.userSettings.showCutAwayFinder),ae("terrainClearance",g.state.userSettings.terrainClearance),g.state.userSettings.alerts&&(Ve("alertWindEnabled",g.state.userSettings.alerts.wind.enabled),ae("alertWindThreshold",g.state.userSettings.alerts.wind.threshold),Ve("alertGustEnabled",g.state.userSettings.alerts.gust.enabled),ae("alertGustThreshold",g.state.userSettings.alerts.gust.threshold),Ve("alertThunderstormEnabled",g.state.userSettings.alerts.thunderstorm.enabled),Ve("alertCloudsEnabled",g.state.userSettings.alerts.clouds.enabled),Ze("alertCloudCover",g.state.userSettings.alerts.clouds.cover),ae("alertCloudBase",g.state.userSettings.alerts.clouds.base)),g.state.userSettings.isCustomJumpRunDirection=g.state.userSettings.isCustomJumpRunDirection||!1;const t=document.getElementById("customLandingDirectionLL"),e=document.getElementById("customLandingDirectionRR");t&&g.state.userSettings.customLandingDirectionLL!==""&&!isNaN(g.state.userSettings.customLandingDirectionLL)&&(t.value=g.state.userSettings.customLandingDirectionLL),e&&g.state.userSettings.customLandingDirectionRR!==""&&!isNaN(g.state.userSettings.customLandingDirectionRR)&&(e.value=g.state.userSettings.customLandingDirectionRR);const n=mi(g.state.userSettings.aircraftSpeedKt);ae("jumperSeparation",n),g.state.userSettings.jumperSeparation=n,g.save();const a=document.getElementById("showJumpMasterLine");a&&(a.disabled=!g.state.userSettings.trackPosition,a.style.opacity=a.disabled?"0.5":"1",a.title=a.disabled?"Enable Live Tracking to use Jump Master Line":"");const r=document.getElementById("jumpRunTrackDirection");r&&(r.textContent="-"),xi()}function pe(){const t=me(),e=Ke(),n=Bt();let a=g.state.userSettings.openingAltitude,r=g.state.userSettings.exitAltitude;if(n==="ft"&&(a=f.convertFeetToMeters(a),r=f.convertFeetToMeters(r)),!g.state.userSettings.calculateJump){Tn(null),Ia(null);return}if(!i.weatherData||i.lastLat==null||i.lastLng==null){Tn(null);return}const o=Se(i.weatherData,t,e,Math.round(i.lastAltitude),n),s={exitCircles:[],canopyCircles:[],canopyLabels:[]};if(g.state.userSettings.showExitArea){const c=hi(o);if(c){s.exitCircles.push({center:[c.greenLatFull,c.greenLngFull],radius:c.greenRadius,color:"green",fillColor:"green",fillOpacity:.2,weight:2});const u=`
                Exit areas calculated with:<br>
                Throw/Drift: ${Number.isFinite(c.freeFallDirection)?Math.round(c.freeFallDirection):"N/A"}° ${Number.isFinite(c.freeFallDistance)?Math.round(c.freeFallDistance):"N/A"} m<br>
                Free Fall Time: ${c.freeFallTime!=null&&!isNaN(c.freeFallTime)?Math.round(c.freeFallTime):"N/A"} sec
            `;s.exitCircles.push({center:[c.greenLat,c.greenLng],radius:c.darkGreenRadius,color:"darkgreen",fillColor:"darkgreen",fillOpacity:.2,weight:2,tooltip:u})}}if(g.state.userSettings.showCanopyArea){const c=gi(o);if(c){const u=f.calculateNewCenter(c.redLat,c.redLng,c.displacementFull,c.directionFull);s.canopyCircles.push({center:u,radius:c.radiusFull,color:"red",weight:2,opacity:.8,fillOpacity:0}),c.additionalBlueRadii.forEach((d,m)=>{const p=f.calculateNewCenter(c.blueLat,c.blueLng,c.additionalBlueDisplacements[m],c.additionalBlueDirections[m]);s.canopyCircles.push({center:p,radius:d,color:"blue",weight:1,fillColor:"blue",fillOpacity:.1,opacity:1}),s.canopyLabels.push({center:p,radius:d,text:`${Math.round(c.additionalBlueUpperLimits[m])}m`})})}}Tn(s);let l=null;if(g.state.userSettings.showCutAwayFinder&&i.cutAwayLat!==null){const c=qa(o);c&&(l={center:c.center,radius:c.radius,tooltipContent:c.tooltipContent})}Ia(l)}function Lt(){var A;console.log("Calculating mean wind with model:",document.getElementById("modelSelect").value,"weatherData:",i.weatherData);const t=((A=document.getElementById("refLevel"))==null?void 0:A.value)||"AGL",e=g.getValue("heightUnit","radio","m"),n=g.getValue("windUnit","radio","kt"),a=document.getElementById("timeSlider").value||0,r=Se(i.weatherData,a,Ke(),Math.round(i.lastAltitude),e);let o=parseFloat(document.getElementById("lowerLimit").value)||0,s=parseFloat(document.getElementById("upperLimit").value);const l=Math.round(i.lastAltitude);if(!i.weatherData||i.lastAltitude==="N/A"){f.handleError("Cannot calculate mean wind: missing data or altitude");return}o=e==="ft"?o/3.28084:o,s=e==="ft"?s/3.28084:s;let c=t==="AGL"?o+l:o,u=t==="AGL"?s+l:s;if(isNaN(o)||isNaN(s)||o>=s){f.handleError("Invalid layer limits. Ensure Lower < Upper and both are numbers.");return}if(t==="AMSL"&&u<l){f.handleError(`The entire selected layer (${Math.round(f.convertHeight(c,e))}-${Math.round(f.convertHeight(u,e))} ${e}) is below the terrain altitude of ${Math.round(f.convertHeight(l,e))} ${e}.`),document.getElementById("meanWindResult").innerHTML="Mean wind: N/A (Layer is below ground)";return}if(t==="AMSL"&&c<l){f.handleMessage(`Note: Lower limit adjusted to terrain altitude (${Math.round(f.convertHeight(l,e))} ${e}) as it cannot be below ground level.`);const T=Math.round(f.convertHeight(l,e));ae("lowerLimit",T),g.state.userSettings.lowerLimit=T,g.save(),c=l}if(!r||r.length===0){f.handleError("No valid weather data available to calculate mean wind.");return}const d=r.map(T=>T.height),m=r.map(T=>parseFloat(T.dir)||0),p=r.map(T=>f.convertWind(parseFloat(T.spd)||0,n,"km/h")),h=p.map((T,C)=>-T*Math.sin(m[C]*Math.PI/180)),v=p.map((T,C)=>-T*Math.cos(m[C]*Math.PI/180)),b=f.calculateMeanWind(d,h,v,c,u),[y,S]=b,w=f.roundToTens(y)===0&&y>=0&&y<5?360:f.roundToTens(y),M=Math.round(f.convertHeight(o,e)),E=Math.round(f.convertHeight(s,e));f.convertWind(S,n,"kt");const k=Number.isFinite(S)?n==="bft"?Math.round(S):S.toFixed(1):"N/A",_=`Mean wind (${M}-${E} ${e} ${t}): ${w}° ${k} ${n}`;document.getElementById("meanWindResult").innerHTML=_,console.log("Calculated Mean Wind:",_,"u:",b[2],"v:",b[3])}async function Sd(){if(i.lastLat==null||i.lastLng==null){console.warn("No location selected, cannot update weather data"),f.handleError("Please select a location to enable autoupdate."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,g.state.userSettings.autoupdate=!1,g.save();return}if(!navigator.onLine){console.warn("Cannot update weather data: offline"),f.handleError("Cannot update weather data while offline."),stopAutoupdate(),document.getElementById("autoupdateCheckbox").checked=!1,g.state.userSettings.autoupdate=!1,g.save();return}const t=document.getElementById("timeSlider");if(!t){console.warn("Time slider not found, cannot update to current hour");return}const n=new Date().getUTCHours();t.value=n,console.log(`Set slider to current hour: ${n}`);try{await tt(i.lastLat,i.lastLng,null,!1),console.log("Weather data fetched for current hour"),await nt(n,"weather-table-container","selectedTime"),i.lastAltitude!=="N/A"&&Lt(),g.state.userSettings.calculateJump&&g.state.isCalculateJumpUnlocked&&(Di(),qa(),g.state.userSettings.showJumpRunTrack&&be()),console.log("Updated all displays for current hour")}catch(a){console.error("Error updating to current hour:",a),f.handleError("Failed to update weather data: "+a.message)}}function Ed(t){var v;if(!i.weatherData||!i.weatherData.time){f.handleError("No weather data available to download.");return}const e=document.getElementById("timeSlider").value||0,n=document.getElementById("modelSelect").value.toUpperCase(),a=f.formatTime(i.weatherData.time[e]).replace(" ","_"),r=`${a}_${n}_${t}.txt`,s={ATAK:{interpStep:1e3,heightUnit:"ft",refLevel:"AGL",windUnit:"kt"},Windwatch:{interpStep:100,heightUnit:"ft",refLevel:"AGL",windUnit:"km/h"},HEIDIS:{interpStep:100,heightUnit:"m",refLevel:"AGL",temperatureUnit:"C",windUnit:"m/s"},Customized:{}}[t]||{},l={interpStep:s.interpStep||Ke(),heightUnit:s.heightUnit||g.getValue("heightUnit","radio","m"),refLevel:s.refLevel||((v=document.querySelector('input[name="refLevel"]:checked'))==null?void 0:v.value)||"AGL",windUnit:s.windUnit||g.getValue("windUnit","radio","kt"),temperatureUnit:s.temperatureUnit||g.getValue("temperatureUnit","radio","C")},c=Se(i.weatherData,e,l.interpStep,Math.round(i.lastAltitude),l.heightUnit);if(!c||c.length===0){f.handleError("No interpolated data available to download.");return}let u="",d="";switch(t){case"ATAK":d=`Alt	Dir	Spd
${l.heightUnit}${l.refLevel}	deg	kts
`;break;case"Windwatch":const b=Math.round(f.convertHeight(i.lastAltitude,"ft"));d=`Version 1.0, ID = 9999999999
${a}, Ground Level: ${b} ft
Windsond ${n}
AGL[ft] Wind[°] Speed[km/h]
`;break;case"HEIDIS":case"Customized":default:d=`h(${l.heightUnit}${l.refLevel}) p(hPa) T(${l.temperatureUnit}) Dew(${l.temperatureUnit}) Dir(°) Spd(${l.windUnit}) RH(%)
`;break}u+=d,c.forEach(b=>{const y=Math.round(b.displayHeight),S=Math.round(b.dir),w=f.convertWind(b.spd,l.windUnit,"km/h"),M=Number.isFinite(w)?l.windUnit==="bft"?Math.round(w):w.toFixed(1):"N/A";if(t==="ATAK"||t==="Windwatch")u+=`${y}	${S}	${Math.round(w)}
`;else{const E=b.pressure==="N/A"?"N/A":b.pressure.toFixed(1),k=f.convertTemperature(b.temp,l.temperatureUnit),_=k==="N/A"?"N/A":k.toFixed(1),A=f.convertTemperature(b.dew,l.temperatureUnit),T=A==="N/A"?"N/A":A.toFixed(1),C=b.rh==="N/A"?"N/A":Math.round(b.rh);u+=`${y} ${E} ${_} ${T} ${S} ${M} ${C}
`}});const m=new Blob([u],{type:"text/plain"}),p=window.URL.createObjectURL(m),h=document.createElement("a");h.href=p,h.download=r,document.body.appendChild(h),h.click(),document.body.removeChild(h),window.URL.revokeObjectURL(p)}async function kd(){if(!i.weatherData||!i.weatherData.time){f.handleError("No weather data available to download.");return}const{time:t,wind_direction_10m:e,wind_speed_10m:n,wind_gusts_10m:a,visibility:r,weather_code:o,temperature_2m:s}=i.weatherData,l=Wn(),c=Pi(),u=Bt(),d=g.getValue("timeZone","radio","Z"),m=document.getElementById("modelSelect").value.toUpperCase(),h=`${f.formatTime(t[0]).replace(" ","_")}_${m}_Surface.txt`;let b=`Date	${`Time (${d})`}	Wind Dir (°)	Wind Spd/Gust (${l})	Visibility (m)	Weather	Clouds	Temp (${c})
`;for(let M=0;M<t.length;M++){const E=await f.getDisplayTime(t[M],i.lastLat,i.lastLng,d),[k,_]=E.split(" "),A=f.convertWind(n[M],l,"km/h"),T=f.convertWind(a[M],l,"km/h"),C=typeof A=="number"?A.toFixed(0):"N/A",I=typeof T=="number"?T.toFixed(0):"N/A",R=`${C} G ${I}`,D=f.convertTemperature(s[M],c),P=typeof D=="number"?D.toFixed(1):"N/A",F=f.formatVisibility(r==null?void 0:r[M]),N=f.translateWmoCodeToTaf(o==null?void 0:o[M]),U=Se(i.weatherData,M,100,Math.round(i.lastAltitude),u),G=f.getCloudLayersForMetar(U,u);b+=`${k}	${_}	${e[M]}	${R}	${F}	${N}	${G}	${P}
`}const y=new Blob([b],{type:"text/plain"}),S=window.URL.createObjectURL(y),w=document.createElement("a");w.href=S,w.download=h,document.body.appendChild(w),w.click(),document.body.removeChild(w),window.URL.revokeObjectURL(S)}async function _d(){if(!i.weatherData||i.lastLat==null||i.lastLng==null){f.handleError("No weather data available for the report.");return}const t=i.lastLat,e=i.lastLng,n=document.getElementById("modelSelect").value.toUpperCase(),a=i.lastModelRun||"N/A",r=$.utc().toFormat("yyyy-MM-dd"),o=Wn(),s=Pi(),l=Bt(),c=g.getValue("timeZone","radio","Z"),u=g.getValue("upperLimit","number",3e3);let d=`Lat ${t.toFixed(4)}, Lon ${e.toFixed(4)}`;try{d=(await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t}&lon=${e}`)).json()).display_name||d}catch{console.warn("Reverse geocoding failed, using coordinates.")}let m=`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DZMaster Weather Briefing</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 1000px; margin: 20px auto; padding: 20px; }
        h1, h2, h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { padding: 8px 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .header-info { background-color: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .header-info p { margin: 5px 0; }
        .section { margin-top: 40px; }
        @media print {
            body { font-size: 10pt; }
            .container { margin: 0; padding: 0; max-width: 100%; }
            h1, h2, h3 { page-break-after: avoid; }
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>DZMaster - Weather Briefing</h1>
    <div class="header-info">
        <p><strong>Location:</strong> ${d}</p>
        <p><strong>Model:</strong> ${n}</p>
        <p><strong>Model Run:</strong> ${a}</p>
        <p><strong>Forecast Day:</strong> ${r}</p>
    </div>

    <div class="section">
        <h2>Surface Data (Today)</h2>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time (${c})</th>
                    <th>Wind Dir (°)</th>
                    <th>Wind (${o})</th>
                    <th>Visibility (m)</th>
                    <th>Weather</th>
                    <th>Clouds</th>
                    <th>Temp (${s})</th>
                </tr>
            </thead>
            <tbody>`;const{time:p,wind_direction_10m:h,wind_speed_10m:v,wind_gusts_10m:b,visibility:y,weather_code:S,temperature_2m:w}=i.weatherData,M=p.map((k,_)=>$.fromISO(k).toFormat("yyyy-MM-dd")===r?_:-1).filter(k=>k!==-1);for(const k of M){const _=await f.getDisplayTime(p[k],t,e,c),[A,T]=_.split(" "),C=f.convertWind(v[k],o,"km/h"),I=f.convertWind(b[k],o,"km/h"),R=`${typeof C=="number"?C.toFixed(0):"N/A"} G ${typeof I=="number"?I.toFixed(0):"N/A"}`,D=f.convertTemperature(w[k],s),P=Se(i.weatherData,k,100,Math.round(i.lastAltitude),l),F=f.getCloudLayersForMetar(P,l),N=f.formatWindDirection(h[k]),U=f.formatVisibility(y==null?void 0:y[k]);m+=`<tr>
            <td>${A}</td>
            <td>${T}</td>
            <td>${N}</td>
            <td>${R}</td>
            <td>${U}</td>
            <td>${f.translateWmoCodeToTaf(S==null?void 0:S[k])}</td>
            <td>${F}</td>
            <td>${typeof D=="number"?D.toFixed(0):"N/A"}</td>
        </tr>`}m+="</tbody></table></div>",m+=`<div class="section">
                <h2>Upper Air Data (Today, hourly, up to ${u}${l} AGL)</h2>`;for(const k of M){const _=await f.getDisplayTime(p[k],t,e,"Z");m+=`<h3>${_}</h3>
                 <table>
                    <thead>
                        <tr>
                            <th>h(${l} AGL)</th>
                            <th>p(hPa)</th>
                            <th>T(${s})</th>
                            <th>Dew(${s})</th>
                            <th>Dir(°)</th>
                            <th>Spd(${o})</th>
                            <th>RH(%)</th>
                            <th>Clouds(%)</th>
                        </tr>
                    </thead>
                    <tbody>`,Se(i.weatherData,k,100,Math.round(i.lastAltitude),l).filter(T=>T.displayHeight<=u).forEach(T=>{const C=f.convertTemperature(T.temp,s),I=f.convertTemperature(T.dew,s),R=f.convertWind(T.spd,o,"km/h"),D=f.formatWindDirection(T.dir);m+=`<tr>
                    <td>${T.displayHeight}</td>
                    <td>${typeof T.pressure=="number"?T.pressure.toFixed(1):"N/A"}</td>
                    <td>${typeof C=="number"?C.toFixed(1):"N/A"}</td>
                    <td>${typeof I=="number"?I.toFixed(1):"N/A"}</td>
                    <td>${D}</td>
                    <td>${typeof R=="number"?R.toFixed(1):"N/A"}</td>
                    <td>${typeof T.rh=="number"?Math.round(T.rh):"N/A"}</td>
                    <td>${typeof T.cc=="number"?Math.round(T.cc):"N/A"}</td>
                </tr>`}),m+="</tbody></table>"}m+="</div></div></body></html>";const E=window.open();E.document.open(),E.document.write(m),E.document.close()}function to(t=!0){g.state.userSettings.customJumpRunDirection=null,g.save(),console.log("Persisted custom JRT direction has been reset.");const e=document.getElementById("jumpRunTrackDirection");e&&(e.value=""),t&&g.state.userSettings.showJumpRunTrack&&i.weatherData&&be()}async function bt(t,e=null){i.weatherData=t,i.cloudThresholds=di(t);const n=document.getElementById("timeSlider");if(!n)return;const r=(v=>{const b=v==null?void 0:v.temperature_2m;if(!b||b.length===0)return 0;for(let y=b.length-1;y>=0;y--)if(b[y]!==null&&b[y]!==void 0)return y;return 0})(t),o=g.getValue("maxForecastTime","Maximum");let s=r;if(o!=="Maximum"){const b=parseInt(o,10)*24-1;r>b&&(s=b)}n.max=s,n.disabled=n.max<=0;let l;if(e!==null&&e<=s)n.value=e,l=e,console.log(`Slider restored to preserved index: ${l}`);else{const v=new Date().getUTCHours();v<=s?(n.value=v,l=v):(n.value=s,l=s),console.log(`Slider set to default (current hour or max): ${l}`)}const{highWinds:c,highGusts:u,thunderstorms:d,cloudAlerts:m}=ja(t),p=[...new Set([...c,...u,...d,...m])],h=document.getElementById("map-alert-icon");h&&h.classList.toggle("hidden",p.length===0),tr(p),await er(),await nt(l,"weather-table-container","selectedTime"),$t(l),await et(),i.lastAltitude!=="N/A"&&Lt(),Si(),console.log("Model changed. Triggering recalculation of jump parameters."),xe(),g.state.userSettings.calculateJump&&pe(),g.state.userSettings.showJumpRunTrack&&be()}function xi(){const t=document.getElementById("info");t&&(t.style.display=g.state.userSettings.showTable?"block":"none");const e=document.getElementById("customLandingDirectionLL"),n=document.getElementById("customLandingDirectionRR"),a=document.getElementById("showJumpRunTrack"),r=document.getElementById("showExitAreaCheckbox");e&&(e.disabled=g.state.userSettings.landingDirection!=="LL"),n&&(n.disabled=g.state.userSettings.landingDirection!=="RR"),a&&(a.disabled=!g.state.userSettings.calculateJump),r&&(r.disabled=!g.state.userSettings.calculateJump)}function no(){const t=document.querySelector('.sidebar-icon[data-panel-id="panel-planner"]');t&&(g.isFeatureUnlocked("planner")?(t.style.opacity="1",t.title="Planner"):(t.style.opacity="0.5",t.title="Feature locked. Click to enter password."));const e=document.querySelector('.sidebar-icon[data-panel-id="panel-data"]');e&&(g.isFeatureUnlocked("data")?(e.style.opacity="1",e.title="Data"):(e.style.opacity="0.5",e.title="Feature locked. Click to enter password."))}function _e(t=null){const e=g.state.userSettings.showJumpMasterLine;let n=null,a=null;if(i.watchId!==null&&(a=i.liveMarker?i.liveMarker.getLatLng():null,n=t||{latitude:a?a.lat:i.lastLatitude,longitude:a?a.lng:i.lastLongitude,speedMs:i.lastSmoothedSpeedMs,direction:i.lastDirection,deviceAltitude:i.lastDeviceAltitude,altitudeAccuracy:i.lastAltitudeAccuracy,accuracy:i.lastAccuracy},n.showJumpMasterLine=e),e&&a){let r=null,o="";if(g.state.userSettings.jumpMasterLineTarget==="HARP"&&i.harpMarker?(r=i.harpMarker.getLatLng(),o="HARP"):i.currentMarker&&(r=i.currentMarker.getLatLng(),o="DIP"),r){const s=i.map.distance(a,r),l=Math.round(f.calculateBearing(a.lat,a.lng,r.lat,r.lng)),c=n.speedMs>1?n.speedMs:1,u=Math.round(s/c);n.jumpMasterLineData={distance:s,bearing:l,tot:u,target:o},Sc(a,r)}}else Ic();Td(n)}function Td(t){const e=document.getElementById("jumpmaster-dashboard");if(!e)return;if(!t){e.classList.add("hidden");return}e.classList.remove("hidden");const n=document.getElementById("dashboard-jm-coords"),a=document.getElementById("dashboard-jm-altitude"),r=document.getElementById("dashboard-jm-direction"),o=document.getElementById("dashboard-jm-speed"),s=document.getElementById("dashboard-jm-accuracy"),l=document.getElementById("dashboard-jm-vario"),c={heightUnit:Bt(),effectiveWindUnit:Wn()==="bft"?"kt":Wn(),coordFormat:Ni(),refLevel:g.getValue("refLevel","radio","AGL")},u=f.convertCoords(t.latitude,t.longitude,c.coordFormat);let d;const m=w=>`${w.deg}° ${w.min.toFixed(3)}' ${w.dir}`,p=w=>`${w.deg}°${w.min}'${w.sec.toFixed(0)}" ${w.dir}`;c.coordFormat==="MGRS"?d=u.lat:c.coordFormat==="DMS"?d=`${p(u.lat)}, ${p(u.lng)}`:c.coordFormat==="DDM"?d=`${m(u.lat)}, ${m(u.lng)}`:d=`${t.latitude.toFixed(5)}, ${t.longitude.toFixed(5)}`,n.textContent=d;let h="N/A";if(t.deviceAltitude!==null){let w=c.refLevel==="AGL"&&i.lastAltitude?t.deviceAltitude-parseFloat(i.lastAltitude):t.deviceAltitude;h=`${Math.round(f.convertHeight(w,c.heightUnit))} ${c.heightUnit}`}a.textContent=h,r.textContent=`${t.direction}°`;const v=f.convertWind(t.speedMs,c.effectiveWindUnit,"m/s"),b=c.effectiveWindUnit==="bft"?Math.round(v):v.toFixed(1);if(o.textContent=`${b} ${c.effectiveWindUnit}`,s.textContent=`± ${Math.round(f.convertHeight(t.accuracy,c.heightUnit))} ${c.heightUnit}`,l){const{rateOfClimbMps:w}=t,M=c.heightUnit==="ft"?"ft/min":"m/s";let E="N/A";l.classList.remove("vario-climb","vario-descent"),w!==null&&Number.isFinite(w)&&(M==="ft/min"?E=(w*196.85).toFixed(0):E=w.toFixed(1),w>.5?l.classList.add("vario-climb"):w<-.5&&l.classList.add("vario-descent")),l.textContent=`${E} ${M}`}const y=document.getElementById("jumpmaster-line-details"),S=t.showJumpMasterLine;if(y.classList.toggle("hidden",!S),S){const w=document.getElementById("dashboard-jm-target-label"),M=document.getElementById("dashboard-jm-bearing"),E=document.getElementById("dashboard-jm-distance"),k=document.getElementById("dashboard-jm-tot");if(t.jumpMasterLineData){const _={heightUnit:Bt()};w.textContent=`JML to ${t.jumpMasterLineData.target}`,M.textContent=`${t.jumpMasterLineData.bearing}°`,E.textContent=`${Math.round(f.convertHeight(t.jumpMasterLineData.distance,_.heightUnit))} ${_.heightUnit}`,k.textContent=t.jumpMasterLineData.tot<1200?`X - ${t.jumpMasterLineData.tot} s`:"N/A"}else w.textContent="JML to --",M.textContent="--",E.textContent="--",k.textContent="--"}}function Ad(){console.log("[App] Setting up application event listeners..."),document.addEventListener("map:moved",()=>{console.log("[main-web] Map has moved or zoomed. Updating visualizations based on new view.");const t=i.map.getZoom();g.state.userSettings.calculateJump&&i.weatherData&&i.lastLat&&(t<je.MIN_ZOOM||t>je.MAX_ZOOM?Tn(null):pe()),g.state.userSettings.showJumpRunTrack&&(t<je.MIN_ZOOM||t>je.MAX_ZOOM?rn(null):be()),g.state.userSettings.showLandingPattern&&xe(),g.state.userSettings.selectedEnsembleModels.length>0&&(t<je.MIN_ZOOM||t>je.MAX_ZOOM?gn():St(me(),Ke())),Ya({map:i.map,baseMaps:i.baseMaps,onProgress:cn,onComplete:e=>{it(),e&&f.handleMessage(e)},onCancel:()=>{it(),f.handleMessage("Caching cancelled.")}})}),document.addEventListener("map:mousemove",t=>{const{lat:e,lng:n}=t.detail;i.lastMouseLatLng={lat:e,lng:n};const a=Ni();let r;if(a==="MGRS")r=`MGRS: ${f.decimalToMgrs(e,n)||"N/A"}`;else if(a==="DMS"){const o=s=>`${s.deg}°${s.min}'${s.sec.toFixed(0)}" ${s.dir}`;r=`Lat: ${o(f.decimalToDms(e,!0))}, Lng: ${o(f.decimalToDms(n,!1))}`}else r=`Lat: ${e.toFixed(5)}, Lng: ${n.toFixed(5)}`;i.coordsControl&&i.coordsControl.update(`${r}<br>Elevation: Fetching...<br>QFE: Fetching...`),f.debouncedGetElevationAndQFE(e,n,({elevation:o})=>{var s,l;if(i.lastMouseLatLng&&i.coordsControl){const c=Math.abs(i.lastMouseLatLng.lat-e),u=Math.abs(i.lastMouseLatLng.lng-n),d=.05;if(c<d&&u<d){const m=Bt();let p=o==="N/A"?"N/A":o;p!=="N/A"&&(p=f.convertHeight(p,m),p=Math.round(p));let h="N/A";if(o!=="N/A"&&i.weatherData&&i.weatherData.surface_pressure){const v=parseInt((s=document.getElementById("timeSlider"))==null?void 0:s.value)||0,b=i.weatherData.surface_pressure[v],y=((l=i.weatherData.temperature_2m)==null?void 0:l[v])||15,S=i.lastAltitude!=="N/A"?i.lastAltitude:0,w=f.calculateQFE(b,o,S,y);h=w!=="N/A"?`${w} hPa`:"N/A"}i.coordsControl.update(`${r}<br>Elevation: ${p} ${p==="N/A"?"":m}<br>QFE: ${h}`)}}})}),document.addEventListener("map:location_selected",async t=>{const{lat:e,lng:n,source:a}=t.detail;console.log(`App: Event 'map:location_selected' von '${a}' empfangen.`),i.lastLat=e,i.lastLng=n,i.lastAltitude=await f.getAltitude(e,n),yi(e,n),to(!0),await tt(e,n),g.state.userSettings.calculateJump&&(pe(),qa()),$n(!0),i.isManualPanning=!1,be(),xe()}),document.addEventListener("favorites:updated",t=>{const{favorites:e}=t.detail;console.log("[App] Favorites updated, redrawing markers on map."),bi(e)}),document.addEventListener("tracking:started",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.disabled=!1,t.style.opacity="1",t.title="")}),document.addEventListener("tracking:stopped",()=>{const t=document.getElementById("showJumpMasterLine");t&&(t.checked=!1,t.disabled=!0,t.style.opacity="0.5",t.title="Enable Live Tracking to use Jump Master Line"),g.state.userSettings.showJumpMasterLine&&(g.state.userSettings.showJumpMasterLine=!1,g.save()),_e()}),document.addEventListener("track:loaded",async t=>{const e=document.getElementById("loading");try{if(!t||!t.detail){console.error('[main-web] "track:loaded" event fired without detail object.',t),f.handleError("Received invalid track data. Please try again.");return}const{lat:n,lng:a,timestamp:r,historicalDate:o,summary:s}=t.detail;if(console.log('[main-web] Event "track:loaded" empfangen, starte korrigierte Aktionen.'),o){const u=document.getElementById("autoupdateCheckbox");u&&(u.checked=!1),Ii(),g.state.userSettings.autoupdate=!1,g.save(),f.handleMessage("Autoupdate disabled for historical track viewing.")}await jn(n,a);const l=await tt(n,a,r);if(l){i.weatherData=l;const u=document.getElementById("timeSlider");if(u&&i.weatherData.time&&(u.max=i.weatherData.time.length-1,u.disabled=u.max<=0,r)){const d=new Date(r).getTime();let m=0,p=1/0;i.weatherData.time.forEach((h,v)=>{const b=Math.abs(new Date(h).getTime()-d);b<p&&(p=b,m=v)}),u.value=m}}await nt(me(),"weather-table-container","selectedTime"),await et(),i.lastAltitude!=="N/A"&&Lt(),g.state.userSettings.calculateJump&&pe(),xe();const c=document.getElementById("info");if(c&&s){const u=/(<br><strong>Available Models:<\/strong><ul>.*?<\/ul>|<br><strong>Available Models:<\/strong> None)/s,d=c.innerHTML.match(u);c.innerHTML=s+(d?d[0]:"")}if(o){const u=document.getElementById("historicalDatePicker");u&&(u.value=o)}}catch(n){console.error("Erroro processing track:loaded:",n),f.handleError("Could not load track data completely.")}finally{e&&(e.style.display="none")}}),document.addEventListener("tracking:positionUpdated",t=>{_e(t.detail)}),document.addEventListener("jml:targetChanged",()=>{_e()}),document.addEventListener("ui:sliderChanged",async t=>{console.log("[main-web] Event 'ui:sliderChanged' empfangen, spezifische Updates werden ausgeführt.");try{const e=me();i.weatherData&&i.lastLat&&i.lastLng&&(await nt(e,"weather-table-container","selectedTime"),vd(e),await et(),i.lastAltitude!=="N/A"&&Lt(),xe(),g.state.userSettings.calculateJump&&pe(),g.state.userSettings.showJumpRunTrack&&be(),St(e,Ke()))}catch(e){console.error("Error during slider update:",e),Fn(e.message)}}),document.addEventListener("ui:settingChanged",async t=>{var a,r;const{name:e,value:n}=t.detail;if(console.log(`[main-web] Setting '${e}' changed to '${n}'. Performing updates.`),e==="timeZone"&&await er(),e==="heightUnit"){const o=document.querySelector('label[for="lowerLimit"]'),s=document.querySelector('label[for="upperLimit"]');o&&(o.textContent=`Lower Limit (${n}):`),s&&(s.textContent=`Upper Limit (${n}):`)}if(["refLevel","heightUnit","temperatureUnit","windUnit","timeZone"].includes(e)&&(await nt(me(),"weather-table-container","selectedTime"),$t(sliderIndex)),e==="maxForecastTime"&&i.lastLat&&i.lastLng){const o=me(),s=((r=(a=i.weatherData)==null?void 0:a.time)==null?void 0:r[o])||null,l=await tt(i.lastLat,i.lastLng,s);l&&await bt(l,o)}switch(e){case"heightUnit":case"windUnit":case"temperatureUnit":case"refLevel":Lt(),g.getValue("calculateJump","checkbox",!1)&&pe(),xe(),_e(),await et(),$t(sliderIndex);break;case"coordFormat":if(await et(),_e(),i.map&&i.lastMouseLatLng){const o=new MouseEvent("mousemove",{bubbles:!0,cancelable:!0,clientX:i.lastMouseLatLng.x,clientY:i.lastMouseLatLng.y});i.map.getContainer().dispatchEvent(o)}break}}),document.addEventListener("ui:radioGroupChanged",async t=>{const{name:e,value:n}=t.detail;if(console.log(`[main-web] Radio group '${e}' changed to '${n}'. Performing updates.`),e==="heightUnit"){const a=document.getElementById("lowerLimit"),r=document.getElementById("upperLimit");if(a&&r){let o=parseFloat(a.value),s=parseFloat(r.value);!isNaN(o)&&!isNaN(s)&&(n==="ft"?(a.value=Math.round(o*3.28084),r.value=Math.round(s*3.28084)):(a.value=Math.round(o/3.28084),r.value=Math.round(s/3.28084)),g.state.userSettings.lowerLimit=a.value,g.state.userSettings.upperLimit=r.value,g.save())}}switch(["refLevel","heightUnit","temperatureUnit","windUnit","timeZone"].includes(e)&&await nt(me(),"weather-table-container","selectedTime"),e){case"heightUnit":case"windUnit":case"refLevel":Lt(),g.getValue("calculateJump","checkbox",!1)&&pe(),xe(),_e(),$t(sliderIndex),await et();break;case"temperatureUnit":$t(sliderIndex);case"coordFormat":await et(),_e();break;case"landingDirection":xi(),xe(),pe();break}}),document.addEventListener("ui:inputChanged",async t=>{const{name:e,value:n}=t.detail;switch(console.log(`[main-web] Input for '${e}' changed to '${n}'.`),e){case"aircraftSpeedKt":const a=mi(n);nn("jumperSeparation",a),g.state.userSettings.jumperSeparation=a,g.save(),i.weatherData&&(Di(),St(me())),be();break;case"cutAwayAltitude":i.weatherData&&i.cutAwayLat!==null&&pe();break;case"openingAltitude":case"exitAltitude":case"safetyHeight":case"numberOfJumpers":case"jumperSeparation":case"canopySpeed":case"descentRate":case"legHeightFinal":case"legHeightBase":case"legHeightDownwind":i.weatherData&&(pe(),xe(),St(me()));break;case"jumpRunTrackDirection":case"jumpRunTrackOffset":case"jumpRunTrackForwardOffset":i.weatherData&&be();break;case"lowerLimit":case"upperLimit":case"interpStep":i.weatherData&&(await nt(me(),"weather-table-container","selectedTime"),Lt());break;case"customLandingDirectionLL":case"customLandingDirectionRR":i.weatherData&&(xe(),pe());break;case"historicalDatePicker":if(i.lastLat&&i.lastLng){const r=n?`${n}T00:00:00Z`:null,o=await tt(i.lastLat,i.lastLng,r);o&&await bt(o)}break}}),document.addEventListener("ui:findJumpShip",()=>{Ai()}),document.addEventListener("ui:showJumpMasterLineChanged",()=>{_e()}),document.addEventListener("ui:modelChanged",async t=>{var e,n;if(console.log(`[main-web] Model changed to ${t.detail.model}. Fetching new data.`),i.lastLat&&i.lastLng){const a=me(),r=((n=(e=i.weatherData)==null?void 0:e.time)==null?void 0:n[a])||null,o=await tt(i.lastLat,i.lastLng,r);o&&await bt(o,a)}else f.handleError("Please select a position on the map first.")}),document.addEventListener("ui:jumpFeatureChanged",()=>{console.log("[main-web] Jump feature changed, recalculating jump."),i.weatherData&&i.lastLat&&i.lastLng&&g.state.userSettings.calculateJump&&pe()}),document.addEventListener("ui:showJumpRunTrackChanged",t=>{t.detail.checked?be():(rn(null),to(!1))}),document.addEventListener("ui:showCutAwayFinderChanged",t=>{var a;const e=t.detail.checked;console.log(`[main-web] Cut Away Finder toggled: ${e}`);const n=(a=document.getElementById("showCutAwayFinder").closest("li"))==null?void 0:a.querySelector("ul.submenu");n&&n.classList.toggle("hidden",!e),e||(Cc(),i.cutAwayLat=null,i.cutAwayLng=null),i.weatherData&&i.lastLat&&i.lastLng&&g.state.userSettings.calculateJump&&pe()}),document.addEventListener("ui:trackPositionToggled",t=>{const e=t.detail.checked;console.log(`[main-web] Live Tracking toggled: ${e}`),e?fd():In()}),document.addEventListener("ui:landingPatternEnabled",()=>{console.log("[main-web] Landing pattern enabled, updating display."),xe()}),document.addEventListener("ui:landingPatternDisabled",()=>{console.log("[main-web] Landing pattern disabled, clearing display."),en(null)}),document.addEventListener("ui:showTableChanged",t=>{const e=t.detail.checked;console.log(`[main-web] Show Table toggled: ${e}`);const n=document.getElementById("info");n&&(n.style.display=e?"block":"none"),e&&i.weatherData&&i.lastLat&&i.lastLng&&nt(me(),"weather-table-container","selectedTime"),$n()}),document.addEventListener("ui:showJumpMasterLineChanged",()=>{console.log("[main-web] Jump Master Line checkbox changed, forcing dashboard update."),_e()}),document.addEventListener("ui:jumpMasterLineTargetChanged",()=>{console.log("[main-web] Jump Master Line target changed, updating panel and line."),_e()}),document.addEventListener("ui:downloadClicked",()=>{console.log("[main-web] Download button clicked.");const t=Ld();t==="SurfaceData"?kd():t==="ComprehensiveReport"?_d():Ed(t)}),document.addEventListener("ui:clearDateClicked",async()=>{console.log("[main-web] Clear date button clicked.");const t=document.getElementById("historicalDatePicker");if(t&&(t.value="",i.lastLat&&i.lastLng))try{const e=await tt(i.lastLat,i.lastLng,null);e&&await bt(e)}catch(e){Fn(e.message)}}),document.addEventListener("ui:recalculateJump",()=>{console.log("[main-web] Recalculate jump triggered."),i.weatherData&&i.lastLat&&i.lastLng&&g.state.userSettings.calculateJump&&pe()}),document.addEventListener("ui:invalidInput",t=>{const{id:e,defaultValue:n}=t.detail;console.log(`[main-web] Received invalid input for ${e}. Resetting UI to ${n}.`),ae(e,n)}),document.addEventListener("ui:recalculateAlerts",()=>{if(console.log("[Main] Received ui:recalculateAlerts event."),i.weatherData){const t=ja(i.weatherData);console.log("[Main] checkWeatherAlerts result:",t);const{highWinds:e,highGusts:n,thunderstorms:a,cloudAlerts:r}=t,o=[...new Set([...e,...n,...a,...r])];console.log("[Main] Combined alert indices:",o),tr(o);const s=document.getElementById("map-alert-icon");s&&(s.classList.toggle("hidden",o.length===0),console.log("[Main] Alert icon visibility updated:",o.length===0?"hidden":"visible"))}else console.log("[Main] No weather data available to recalculate alerts.")}),document.addEventListener("visibilitychange",async()=>{if(document.visibilityState==="visible")if(console.log("[App Visibility] Tab/App became visible."),i.weatherData&&i.weatherData.time&&i.weatherData.time.length>0){const t=$.fromISO(i.weatherData.time[0],{zone:"utc"}).startOf("day"),e=$.utc().startOf("day"),n=document.getElementById("historicalDatePicker"),a=n&&n.value!=="";if(console.log(`[App Visibility] First data date: ${t.toISO()}, Current UTC date: ${e.toISO()}, Historical selected: ${a}`),t<e&&!a)if(console.log("[App Visibility] Weather data is outdated and no historical date is selected. Refreshing to current forecast..."),f.handleMessage("Refreshing forecast to the current day..."),n&&(n.value=""),g.state.userSettings.historicalDatePicker="",g.save(),i.lastLat!=null&&i.lastLng!=null)try{const r=await tt(i.lastLat,i.lastLng,null);r?(await bt(r),f.handleMessage("Forecast updated to the current day.")):f.handleError("Failed to refresh forecast.")}catch(r){console.error("[App Visibility] Error refreshing weather data:",r),f.handleError("Failed to refresh forecast.")}else console.warn("[App Visibility] Cannot refresh weather, no location selected.");else console.log("[App Visibility] Weather data is current or historical date selected. No automatic refresh needed.")}else console.log("[App Visibility] No weather data available to check for outdatedness.")})}document.addEventListener("DOMContentLoaded",async()=>{bd(),Md(),no(),dc(),await bc(),Ad(),gd(),hd(),nr();const t=Ye().filter(e=>e.isFavorite);t.length>0&&(console.log(`[App] Found ${t.length} favorite(s) on startup, plotting on map.`),bi(t)),document.addEventListener("cutaway:marker_placed",()=>{console.log("App: Event 'cutaway:marker_placed' empfangen. Neuberechnung wird ausgelöst."),i.weatherData&&i.lastLat&&i.lastLng&&pe()}),document.addEventListener("track:dragend",e=>{console.log("App: Event 'track:dragend' empfangen. Neuberechnung der Offsets relativ zum Ankerpunkt (DIP oder HARP).");const{newPosition:n,originalTrackData:a}=e.detail;let r;const o=i.harpMarker?i.harpMarker.getLatLng():null;o?(r=o,console.log("JRT-Ankerpunkt ist HARP.")):(r=L.latLng(i.lastLat,i.lastLng),console.log("JRT-Ankerpunkt ist DIP."));const s=a.trackLength,l=a.airplane.bearing,c=n,[u,d]=f.calculateNewCenter(c.lat,c.lng,s,(l+180)%360),m=L.latLng(u,d),p=i.map.distance(r,m);let v=f.calculateBearing(r.lat,r.lng,m.lat,m.lng)-l;v=(v+180)%360-180;const b=v*(Math.PI/180),y=Math.round(p*Math.cos(b)),S=Math.round(p*Math.sin(b));g.state.userSettings.jumpRunTrackOffset=S,g.state.userSettings.jumpRunTrackForwardOffset=y,g.save(),nn("jumpRunTrackOffset",S),nn("jumpRunTrackForwardOffset",y),be()}),document.addEventListener("harp:updated",()=>{console.log("[App] HARP has been updated, resetting offsets and triggering JRT recalculation."),nn("jumpRunTrackOffset",0),nn("jumpRunTrackForwardOffset",0),be(),typeof _e=="function"&&_e()}),document.addEventListener("location:selected",async e=>{var s,l;const{lat:n,lng:a,source:r}=e.detail;console.log(`App: Event 'location:selected' empfangen. Quelle: ${r}`),Pc(),i.terrainAnalysisCache=null;const o=document.getElementById("loading");o&&(o.style.display="block");try{const c=me(),u=((l=(s=i.weatherData)==null?void 0:s.time)==null?void 0:l[c])||null,d=await tt(n,a,u);if(d?r==="geolocation"||r==="geolocation_fallback"?await bt(d,null):await bt(d,c):i.weatherData=null,await jn(n,a),await et(),$n(!0),i.isManualPanning=!1,(r==="geolocation"||r==="geolocation_fallback")&&(console.log("Starte initiales Caching nach Geolocation..."),Ya({map:i.map,baseMaps:i.baseMaps,onProgress:cn,onComplete:m=>{it(),m&&ht(m)},onCancel:()=>{it(),ht("Caching cancelled.")}})),g.state.userSettings.showJumpMasterLine&&_e(),(r==="marker_drag"||r==="dblclick"||r==="search")&&(console.log(`Starte Caching für neue Position via ${r}...`),pi({map:i.map,lastLat:n,lastLng:a,baseMaps:i.baseMaps,onProgress:cn,onComplete:ht,onCancel:()=>ht("Caching cancelled."),radiusKm:5,silent:!0})),g.state.userSettings.selectedEnsembleModels.length>0&&(console.log("DIP moved, triggering ensemble recalculation..."),await Ka())){const p=me();St(p)}}catch(c){console.error('Fehler beim Verarbeiten von "location:selected":',c),Fn(c.message)}finally{o&&(o.style.display="none")}}),document.addEventListener("autoupdate:tick",async e=>{if(!g.state.userSettings.autoupdate)return;const n=new Date,a=document.getElementById("timeSlider");if(!a)return;const r=n.getUTCHours(),o=parseInt(a.value,10);(r!==o||e.detail.isInitialTick)&&(console.log(`[App] Autoupdate triggered. Current Hour: ${r}, Slider Hour: ${o}`),await Sd())}),document.addEventListener("ui:lockStateChanged",no)});function Ve(t,e){const n=document.getElementById(t);n&&(n.checked=e)}function Ze(t,e){const n=document.getElementById(t);n?n.value=e:console.warn(`Element ${t} not found`)}function ae(t,e){const n=document.getElementById(t);n&&(n.value=e)}function nn(t,e){const n=document.getElementById(t);if(n){const a=n.value;n.value=e,console.log(`Set ${t} silently:`,{old:a,new:e})}}function Cd(t,e){const n=document.querySelector(`input[name="${t}"][value="${e}"]`);n?n.checked=!0:console.warn(`Radio ${t} with value ${e} not found`)}export{Ei as W};
